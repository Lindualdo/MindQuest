{
  "descricao": "Estrutura sugerida para conquistas_historico.detalhes (tipo = 'quest')",
  "estrutura": {
    "recorrencia": "diaria | semanal | unica",
    "data_conclusao": "2025-11-20",
    "total_concluidas": 3,
    "ocorrencias": [
      {
        "data": "2025-11-19",
        "xp_base": 30,
        "xp_bonus": 6
      },
      {
        "data": "2025-11-20",
        "xp_base": 30,
        "xp_bonus": 6
      }
    ]
  },
  "exemplo_completo": {
    "recorrencia": "diaria",
    "data_conclusao": "2025-11-20",
    "total_concluidas": 3,
    "ocorrencias": [
      {
        "data_planejada": "2025-11-18",
        "data_concluida": "2025-11-18",
        "data_registrada": "2025-11-18T14:30:00.000Z",
        "xp_base": 30,
        "xp_bonus": 6
      },
      {
        "data_planejada": "2025-11-19",
        "data_concluida": "2025-11-19",
        "data_registrada": "2025-11-19T15:45:00.000Z",
        "xp_base": 30,
        "xp_bonus": 6
      },
      {
        "data_planejada": "2025-11-20",
        "data_concluida": "2025-11-20",
        "data_registrada": "2025-11-20T16:00:00.000Z",
        "xp_base": 30,
        "xp_bonus": 6
      }
    ]
  },
  "campos": {
    "recorrencia": {
      "tipo": "string",
      "valores": ["diaria", "semanal", "unica"],
      "descricao": "Tipo de recorrência da quest (vem de usuarios_quest.config->>'recorrencia')"
    },
    "data_conclusao": {
      "tipo": "string (date)",
      "formato": "YYYY-MM-DD",
      "descricao": "Data da última conclusão (usado para consultas de progresso semanal)"
    },
    "total_concluidas": {
      "tipo": "integer",
      "descricao": "Total de vezes que a quest foi concluída (contador incremental)"
    },
    "ocorrencias": {
      "tipo": "array",
      "descricao": "Array com todas as conclusões da quest",
      "itens": {
        "data_planejada": {
          "tipo": "string (date)",
          "formato": "YYYY-MM-DD",
          "descricao": "Data que estava prevista em usuarios_quest.recorrencias->dias[].data (apenas para auditoria)"
        },
        "data_concluida": {
          "tipo": "string (date)",
          "formato": "YYYY-MM-DD",
          "descricao": "Data da barra clicada (data_referencia) - usada para cálculos de progresso"
        },
        "data_registrada": {
          "tipo": "string (timestamp)",
          "formato": "ISO 8601 com timezone (ex: 2025-11-20T14:30:00.000Z)",
          "descricao": "Timestamp de quando foi registrado no sistema (NOW()) - para auditoria"
        },
        "xp_base": {
          "tipo": "integer",
          "descricao": "XP base concedido nesta conclusão (sem bônus)"
        },
        "xp_bonus": {
          "tipo": "integer",
          "descricao": "XP bônus concedido nesta conclusão (recorrência, streak, etc)"
        }
      }
    }
  },
  "observacoes": [
    "NÃO incluir 'quest_id' no detalhes (relacionamento é via meta_codigo)",
    "data_conclusao sempre representa a última conclusão (data_concluida da última ocorrência)",
    "ocorrencias deve estar ordenado por data_concluida (mais antigas primeiro)",
    "data_planejada vs data_concluida: devem ser iguais se tudo estiver correto (auditoria)",
    "data_registrada: timestamp de quando foi registrado (pode ser diferente de data_concluida se foi conclusão retroativa)",
    "Para cálculos de progresso semanal: usar data_concluida",
    "Formato de data: YYYY-MM-DD para data_planejada e data_concluida, ISO 8601 para data_registrada",
    "xp_base e xp_bonus separados para permitir cálculos distintos"
  ],
  "queries_exemplo": {
    "buscar_por_semana": "SELECT (occ->>'data_concluida')::date AS data, SUM((occ->>'xp_base')::int) AS xp_base FROM conquistas_historico ch CROSS JOIN LATERAL jsonb_array_elements(ch.detalhes->'ocorrencias') AS occ WHERE ch.meta_codigo = 'quest_id' AND (occ->>'data_concluida')::date BETWEEN semana_inicio AND semana_fim",
    "ultima_conclusao": "SELECT detalhes->>'data_conclusao' FROM conquistas_historico WHERE meta_codigo = 'quest_id'",
    "total_concluidas": "SELECT (detalhes->>'total_concluidas')::int FROM conquistas_historico WHERE meta_codigo = 'quest_id'",
    "auditoria_planejado_vs_concluido": "SELECT occ->>'data_planejada' AS planejada, occ->>'data_concluida' AS concluida, CASE WHEN occ->>'data_planejada' = occ->>'data_concluida' THEN 'OK' ELSE 'DIFERENTE' END AS status FROM conquistas_historico ch CROSS JOIN LATERAL jsonb_array_elements(ch.detalhes->'ocorrencias') AS occ WHERE ch.meta_codigo = 'quest_id'"
  }
}

