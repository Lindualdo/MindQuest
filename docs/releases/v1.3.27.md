# Release v1.3.27 - Sistema de AnÃ¡lise Inteligente Aprimorado

**Data:** 2025-12-21

---

## ðŸŽ¯ Melhorias para o UsuÃ¡rio

### AnÃ¡lise Mais ConfiÃ¡vel
- **Processamento garantido:** Sistema agora garante que todas as anÃ¡lises sejam concluÃ­das, mesmo em caso de instabilidades temporÃ¡rias
- **Retry automÃ¡tico:** Se algum expert falhar, o sistema tenta novamente automaticamente (atÃ© 5 vezes) sem impactar os outros
- **Dados sempre atualizados:** Cada nova conversa Ã© processada por todos os experts, garantindo anÃ¡lises completas

### Processamento Inteligente
- **Sem retrabalho:** Em caso de retry, apenas os experts que falharam sÃ£o reprocessados, economizando recursos
- **Limite de tentativas:** Sistema para apÃ³s 5 falhas consecutivas, evitando loops infinitos e garantindo estabilidade

### ExperiÃªncia do UsuÃ¡rio
- **TransparÃªncia:** Todas as anÃ¡lises (Big Five, sabotadores, emoÃ§Ãµes, insights, humor, quests) sÃ£o processadas de forma independente
- **Confiabilidade:** Dados do dashboard sempre refletem o processamento mais recente e completo

---

## ðŸ”§ Melhorias TÃ©cnicas

### Arquitetura de Experts
- **Workflow consolidado:** CriaÃ§Ã£o do `sw_expert_v6` unificando lÃ³gica de processamento
- **Loop dinÃ¢mico:** ExecuÃ§Ã£o de experts via loop com chamadas dinÃ¢micas de sub-workflows
- **Processamento resiliente:** `continueOnFail: true` garante que falha em um expert nÃ£o afeta os demais

### Sistema de Retry Inteligente
- **Filtro no job:** `job_experts` filtra chats com `falhas_consecutivas >= 5` diretamente na query
- **Retry granular:** Apenas experts com erro sÃ£o reprocessados em retry
- **Novo ciclo completo:** Todo novo processamento (chat atualizado) roda todos os 7 experts

### Contadores e Logs
- **`ciclo`:** Total de processamentos realizados (sempre incrementa)
- **`falhas_consecutivas`:** Rodadas seguidas com erro (reseta para 0 quando todos experts tÃªm sucesso)
- **Log por expert:** Cada expert registra `status`, `tentativas`, `data` e `erro` individualmente em `usr_chat.experts_processados`

### Status de Chat
- **`em_andamento`:** Chat novo ou atualizado aguardando processamento
- **`processando`:** Experts em execuÃ§Ã£o ou retry pendente
- **`finalizado`:** Todos experts processados com sucesso

### Fluxo Simplificado
```
job_experts (a cada 30min)
  â†“
Busca chats (falhas < 5)
  â†“
Marca status='processando'
  â†“
Chama sw_expert_v6
  â†“ (loop dinÃ¢mico)
7 experts â†’ log individual
  â†“
Consolida resultado
  â†“
Atualiza status final
```

### DocumentaÃ§Ã£o
- **`docs/espec/xperts/experts.md`:** VisÃ£o gerencial/executiva das regras
- **`docs/espec/xperts/experts_tech.md`:** DocumentaÃ§Ã£o tÃ©cnica detalhada
- **`docs/ref/n8n.md`:** Regras crÃ­ticas sobre conexÃµes IF e boas prÃ¡ticas

### Backups
- Workflow principal: `backups/n8n/sw_expert_v6.json`
- Sub-workflows individuais: `sw_expert_*.json`
- Job scheduler: `backups/n8n/job_experts.json`

---

## ðŸ“Š Testes Realizados

**7 cenÃ¡rios validados:**
1. âœ… Processamento normal - todos experts
2. âœ… Novo chat - processamento completo
3. âœ… Erro plantado - expert falha corretamente
4. âœ… Retry 1 - apenas expert com erro reprocessado
5. âœ… Retry 2 - mantÃ©m lÃ³gica de retry
6. âœ… Retry 3 - erro corrigido marca finalizado
7. âœ… Novo ciclo - processa todos novamente

**Resultado:** Logs na base correspondem perfeitamente aos cenÃ¡rios testados.

---

## ðŸš€ Impacto

- **Confiabilidade:** Sistema robusto contra falhas temporÃ¡rias
- **EficiÃªncia:** Reprocessamento apenas do necessÃ¡rio
- **TransparÃªncia:** Rastreabilidade completa de cada expert
- **Escalabilidade:** Arquitetura preparada para novos experts

