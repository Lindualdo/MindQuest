# Release v1.3.23

**Data:** 2025-12-14  
**Tipo:** RefatoraÃ§Ã£o Major - Sistema de Experts

---

## ğŸ¯ Resumo

RefatoraÃ§Ã£o completa do sistema de experts para simplificaÃ§Ã£o, autonomia e economia de recursos. ConsolidaÃ§Ã£o de mÃºltiplos workflows em um Ãºnico hub (`sw_experts_v2`), correÃ§Ã£o de dependÃªncias circulares e implementaÃ§Ã£o de regras de consistÃªncia para mÃºltiplas execuÃ§Ãµes diÃ¡rias.

---

## âœ¨ Principais MudanÃ§as

### 1. ConsolidaÃ§Ã£o de Experts (`sw_experts_v2`)

**Antes:** 7 workflows separados  
**Depois:** 1 workflow consolidado

| Expert | Status |
|--------|--------|
| Resumo Conversa | âœ… Integrado (validador de contexto) |
| Sabotadores | âœ… Integrado |
| PANAS/EmoÃ§Ãµes | âœ… Integrado |
| Humor/Energia | âœ… Integrado |
| Big Five | âœ… Integrado |
| Insights | âœ… Integrado |
| XP Conversas | âœ… Chamado como sub-workflow |
| Criar Quests | âœ… Chamado como sub-workflow |

**BenefÃ­cios:**
- Contexto compartilhado entre experts
- Economia de tokens (resumo Ãºnico)
- ManutenÃ§Ã£o centralizada
- Menos overhead de chamadas

---

### 2. CorreÃ§Ã£o do `job_experts`

#### 2.1 DependÃªncia Circular Resolvida

**Problema:** `total_palavras_usuario >= 30` era calculado pelo expert de resumo, mas o resumo sÃ³ era chamado se `total_palavras_usuario >= 30`.

**SoluÃ§Ã£o:** CÃ¡lculo de palavras direto na query SQL do job:

```sql
COALESCE((
  SELECT SUM(array_length(regexp_split_to_array(trim(msg->>'texto'), '\s+'), 1))
  FROM jsonb_array_elements(c.mensagens) AS msg
  WHERE msg->>'autor' = 'usuario'
), 0) AS palavras_usuario
```

#### 2.2 FinalizaÃ§Ã£o Condicional

**Problema:** Job marcava chat como `finalizado` mesmo quando `tem_contexto = false`.

**SoluÃ§Ã£o:** Node `IF` apÃ³s chamar `sw_experts_v2`:
- Se `processado = true` â†’ marca `finalizado`
- Se `processado = false` â†’ loop sem finalizar

---

### 3. Regras de ConsistÃªncia (UPSERT)

ImplementaÃ§Ã£o de lÃ³gica UPSERT para garantir consistÃªncia em mÃºltiplas execuÃ§Ãµes por dia.

#### 3.1 Sabotadores
| Campo | Comportamento |
|-------|---------------|
| Chave Ãºnica | `(usuario_id, sabotador_id, chat_id)` |
| `total_deteccoes_dia` | Incrementa (+1) |
| `intensidade_media` | Recalcula mÃ©dia |
| `contexto/insight/contramedida` | MantÃ©m se intensidade maior |

#### 3.2 EmoÃ§Ãµes (PANAS)
| Campo | Comportamento |
|-------|---------------|
| Chave Ãºnica | `(chat_id, emocao_id)` |
| `ocorrencias_dia` | Incrementa (+1) |
| `intensidade` | Recalcula mÃ©dia |
| `evidencias` | Concatena array |

#### 3.3 Humor/Energia
| Campo | Comportamento |
|-------|---------------|
| Chave Ãºnica | `(chat_id)` |
| `ocorrencias_dia` | Incrementa (+1) |
| `humor_dia` / `energia_nivel` | Recalcula mÃ©dia |
| `evidencias_textuais` | Concatena array |

#### 3.4 Big Five
| Campo | Comportamento |
|-------|---------------|
| Chave Ãºnica | `(chat_id)` |
| Todos os scores | **Sobrescreve** (mais contexto = mais preciso) |

#### 3.5 Insights
| Campo | Comportamento |
|-------|---------------|
| Chave Ãºnica | `(chat_id)` |
| Todos os campos | **Sobrescreve** (Ãºltimo insight prevalece) |

---

### 4. SimplificaÃ§Ã£o do `criar_quest`

**Removido:**
- Campo `usr_chat.palavras_ultimo_processamento`
- ValidaÃ§Ã£o de `delta_palavras` (50 primeira vez / 30 reprocessamento)
- Node `Atualizar Palavras Processadas`

**Mantido:**
- Limite de 15 quests ativas por usuÃ¡rio

**Justificativa:** Double-check jÃ¡ garante contexto:
1. `job_experts` â†’ filtra â‰¥ 30 palavras
2. `resumo_conversa` â†’ valida `tem_contexto`

---

### 5. Workflows Removidos

| Workflow | Motivo |
|----------|--------|
| `sw_calcula_jornada` | NÃ£o estava sendo chamado, nÃ­veis desatualizados |
| `sw_expert_sabotadores` | Integrado ao `sw_experts_v2` |
| `sw_expert_humor_energia` | Integrado ao `sw_experts_v2` |
| `sw_expert_bigfive_ocean` | Integrado ao `sw_experts_v2` |
| `sw_expert_insights_acionaveis` | Integrado ao `sw_experts_v2` |
| `sw_experts_panas` | Integrado ao `sw_experts_v2` |
| `sw_resumo_conversa` | Integrado ao `sw_experts_v2` |
| `sw_experts` | SubstituÃ­do por `sw_experts_v2` |

---

## ğŸ—„ï¸ AlteraÃ§Ãµes no Banco de Dados

### Constraints Criadas

| Tabela | Constraint | Campos |
|--------|------------|--------|
| `usuarios_sabotadores` | `usuarios_sabotadores_unique_por_chat` | `(usuario_id, sabotador_id, chat_id)` |
| `usuarios_emocoes` | `usuarios_emocoes_chat_emocao_unique` | `(chat_id, emocao_id)` |
| `usuarios_humor_energia` | `usuarios_humor_energia_chat_id_unique` | `(chat_id)` |
| `insights` | `insights_chat_id_unique` | `(chat_id)` |

### Colunas Adicionadas

| Tabela | Coluna | Tipo |
|--------|--------|------|
| `usuarios_emocoes` | `ocorrencias_dia` | integer |
| `usuarios_emocoes` | `intensidade_acumulada` | integer |
| `usuarios_humor_energia` | `ocorrencias_dia` | integer |
| `usuarios_humor_energia` | `humor_acumulado` | integer |
| `usuarios_humor_energia` | `energia_acumulada` | integer |
| `log_experts` | `expert_name` | varchar(50) |
| `log_experts` | `usuario_id` | uuid |

### Colunas Removidas

| Tabela | Coluna |
|--------|--------|
| `usr_chat` | `palavras_ultimo_processamento` |

### Limpeza de Dados

| Tabela | Registros Removidos | Motivo |
|--------|---------------------|--------|
| `usuarios_sabotadores` | 882 | Duplicatas |
| `insights` | 133 | Duplicatas |

---

## ğŸ“„ DocumentaÃ§Ã£o

### Criada
- `docs/espec/xperts/experts.md` - Regras de negÃ³cio dos experts

---

## ğŸ”„ Fluxo de ExecuÃ§Ã£o (Novo)

```
job_experts (30 min)
    â”‚
    â”œâ”€ busca_validas (â‰¥30 palavras, nÃ£o finalizado)
    â”‚
    â””â”€ Para cada chat:
        â”‚
        â”œâ”€ sw_experts_v2
        â”‚   â”‚
        â”‚   â”œâ”€ 1. Resumo Conversa â†’ tem_contexto?
        â”‚   â”‚
        â”‚   â”œâ”€ Se TRUE:
        â”‚   â”‚   â”œâ”€ Sabotadores (UPSERT mÃ©dia)
        â”‚   â”‚   â”œâ”€ EmoÃ§Ãµes (UPSERT mÃ©dia)
        â”‚   â”‚   â”œâ”€ Humor/Energia (UPSERT mÃ©dia)
        â”‚   â”‚   â”œâ”€ Big Five (UPSERT sobrescreve)
        â”‚   â”‚   â”œâ”€ Insights (UPSERT sobrescreve)
        â”‚   â”‚   â”œâ”€ XP Conversas
        â”‚   â”‚   â””â”€ Criar Quests
        â”‚   â”‚
        â”‚   â””â”€ Se FALSE:
        â”‚       â””â”€ Apenas atualiza resumo
        â”‚
        â””â”€ Se processado = true:
            â””â”€ Marca chat como 'finalizado'
```

---

## âš ï¸ Breaking Changes

1. **Workflows removidos** - Se algum processo externo chamava os workflows individuais, deve ser atualizado para usar `sw_experts_v2`

2. **Campo removido** - `usr_chat.palavras_ultimo_processamento` nÃ£o existe mais

3. **Constraints novas** - Podem causar erro em INSERT duplicado se cÃ³digo antigo nÃ£o usar UPSERT

---

## ğŸ§ª ValidaÃ§Ã£o

- [x] ExecuÃ§Ã£o do job_experts testada
- [x] Dados persistidos corretamente nas tabelas
- [x] Constraints funcionando (sem duplicatas)
- [x] FinalizaÃ§Ã£o condicional funcionando

---

## ğŸ“ Commits Relacionados

- `[docs] Atualizar regras de criar_quest e constraint de insights`
- `[refactor] Remover validaÃ§Ã£o de delta_palavras no criar_quest`

---

*Release Notes geradas em 2025-12-14*
