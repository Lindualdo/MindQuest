{
  "createdAt": "2025-11-29T18:03:28.412Z",
  "id": "nOb9qxPUob3pPgfQ",
  "name": "webhook_jornada_niveis",
  "description": null,
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "id": "webhook-get",
      "name": "Webhook GET",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        250,
        300
      ],
      "webhookId": "j0rn4d4-n1v31s-w3bh00k-1d",
      "parameters": {
        "path": "jornada-niveis",
        "httpMethod": "GET",
        "responseMode": "responseNode"
      }
    },
    {
      "id": "buscar-niveis",
      "name": "Buscar Níveis",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        500,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      },
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH usuario AS (\n  SELECT xp_total \n  FROM usuarios_conquistas \n  WHERE usuario_id = $1\n)\nSELECT \n  jn.nivel, jn.nome, jn.descricao, jn.estagio, jn.estagio_nome, \n  jn.xp_minimo, jn.xp_proximo_nivel,\n  COALESCE(u.xp_total, 0) as user_xp_total\nFROM jornada_niveis jn\nCROSS JOIN usuario u\nORDER BY jn.nivel",
        "options": {
          "queryReplacement": "={{ [$json.query.user_id] }}"
        }
      }
    },
    {
      "id": "montar-resposta",
      "name": "Montar Resposta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        750,
        300
      ],
      "parameters": {
        "jsCode": "const niveisData = $input.all();\n\nconst xpTotal = niveisData[0]?.json?.user_xp_total ?? 0;\n\nconst niveis = niveisData.map(item => ({\n  nivel: item.json.nivel,\n  nome: item.json.nome,\n  descricao: item.json.descricao,\n  estagio: item.json.estagio,\n  estagio_nome: item.json.estagio_nome,\n  xp_minimo: item.json.xp_minimo,\n  xp_proximo_nivel: item.json.xp_proximo_nivel\n}));\n\n// Calcular nível atual baseado nos pontos\nconst nivelAtual = niveis.find(n => \n  xpTotal >= n.xp_minimo && (n.xp_proximo_nivel === null || xpTotal < n.xp_proximo_nivel)\n);\n\n// Agrupar por estágio\nconst estagios = {};\nniveis.forEach(n => {\n  if (!estagios[n.estagio]) {\n    estagios[n.estagio] = {\n      numero: n.estagio,\n      nome: n.estagio_nome,\n      niveis: []\n    };\n  }\n  estagios[n.estagio].niveis.push(n);\n});\n\nreturn [{\n  json: {\n    success: true,\n    usuario: {\n      xp_total: xpTotal,\n      nivel_atual: nivelAtual?.nivel ?? 1,\n      titulo_nivel: nivelAtual?.nome ?? 'Despertar',\n      estagio_atual: nivelAtual?.estagio ?? 1\n    },\n    niveis,\n    estagios: Object.values(estagios)\n  }\n}];"
      }
    },
    {
      "id": "responder",
      "name": "Responder",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1000,
        300
      ],
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      }
    }
  ],
  "connections": {
    "Webhook GET": {
      "main": [
        [
          {
            "node": "Buscar Níveis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Níveis": {
      "main": [
        [
          {
            "node": "Montar Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Montar Resposta": {
      "main": [
        [
          {
            "node": "Responder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "saveManualExecutions": true,
    "saveExecutionProgress": true,
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": null,
  "shared": [
    {
      "createdAt": "2025-11-29T18:03:28.412Z",
      "role": "workflow:owner",
      "workflowId": "nOb9qxPUob3pPgfQ",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}
