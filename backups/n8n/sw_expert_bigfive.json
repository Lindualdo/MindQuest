{
  "createdAt": "2025-12-21T12:27:03.203Z",
  "id": "JOqIaAhynreLzGPs",
  "name": "sw_expert_bigfive",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "HDTrSrJiBIv2FFks",
          "mode": "list",
          "cachedResultUrl": "/workflow/HDTrSrJiBIv2FFks",
          "cachedResultName": "sw_get_history"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usr_id": "={{ $('start').first().json.usuario_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "usr_id",
              "displayName": "usr_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "60fe45df-e384-4dfc-8629-27f37f535e93",
      "name": "Buscar Historico BigFive",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -1984,
        112
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "functionCode": "const s = $items('start')[0]?.json ?? {};\nconst h = $items('Buscar Historico BigFive').map(i => i.json).filter(Boolean);\nconst fmt = v => { if (!v) return null; const d = new Date(v); return isNaN(d) ? v : d.toISOString().slice(0,10); };\nconst hist = h.map(e => ({data: fmt(e.data_conversa), resumo: e.resumo_conversa || ''})).filter(e => e.data || e.resumo).sort((a,b) => a.data < b.data ? 1 : -1);\nconst resumo = hist.length ? hist.slice(0,3).map(e => `- ${e.data}: ${e.resumo}`).join('\\n') : 'Sem hist\\u00f3rico.';\nreturn [{json: {...s, historico_resumo: resumo}}];"
      },
      "id": "bd8066c6-bab7-478d-9e06-8aff380515f9",
      "name": "Preparar Contexto BigFive",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -1792,
        112
      ]
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 1500,
          "temperature": 0.2
        }
      },
      "id": "2951fad6-9145-47a0-9d8b-68439b284dc4",
      "name": "LLM BigFive",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -1648,
        304
      ],
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=<input>\n<historico>{{ $json.historico_resumo }}</historico>\n<messages>{{ JSON.stringify($('Buscar Dados Chat').first().json.mensagens) }}</messages>\n<user_name>{{ $json.usr_nome_preferencia }}</user_name>\n</input>\n\nEstime perfil Big Five (OCEAN) do usuário.\n\n<output_format>\n{\"big_five\":{\"openness\":{\"score\":n,\"confiabilidade\":n,\"evidencias\":[]},\"conscientiousness\":{\"score\":n,\"confiabilidade\":n,\"evidencias\":[]},\"extraversion\":{\"score\":n,\"confiabilidade\":n,\"evidencias\":[]},\"agreeableness\":{\"score\":n,\"confiabilidade\":n,\"evidencias\":[]},\"neuroticism\":{\"score\":n,\"confiabilidade\":n,\"evidencias\":[]}},\"perfil_primario\":\"openness|conscientiousness|extraversion|agreeableness|neuroticism|misto\",\"resumo_perfil\":\"max 400 chars\",\"insuficiente\":boolean}\n</output_format>",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=<role>Especialista em Big Five (OCEAN)</role>\n\n<objective>Inferir tendências de personalidade com evidências textuais</objective>\n\n<traits>\nO=Openness (curiosidade, ideias novas)\nC=Conscientiousness (organização, disciplina)\nE=Extraversion (energia social)\nA=Agreeableness (empatia, cooperação)\nN=Neuroticism (sensibilidade a estresse)\n</traits>\n\n<rules>\n- Use APENAS mensagens com autor=\"usuario\"\n- Histórico: apenas contexto, não use como evidência\n- Score e confiabilidade: 0-100 (50=neutro)\n- Evidências: 2-4 trechos curtos (max 15 palavras)\n- Se insuficiente: score=50, confiabilidade<=40\n- NÃO faça diagnósticos clínicos\n</rules>\n\n<perfil_primario_rule>\nSe diferença entre 1º e 2º < 5 pontos: \"misto\"\nSenão: traço com maior score\n</perfil_primario_rule>\n\n<output_format>\n{\"big_five\":{\"openness\":{\"score\":n,\"confiabilidade\":n,\"evidencias\":[]},\"conscientiousness\":{\"score\":n,\"confiabilidade\":n,\"evidencias\":[]},\"extraversion\":{\"score\":n,\"confiabilidade\":n,\"evidencias\":[]},\"agreeableness\":{\"score\":n,\"confiabilidade\":n,\"evidencias\":[]},\"neuroticism\":{\"score\":n,\"confiabilidade\":n,\"evidencias\":[]}},\"perfil_primario\":\"openness|conscientiousness|extraversion|agreeableness|neuroticism|misto\",\"resumo_perfil\":\"max 400 chars\",\"insuficiente\":boolean}\n</output_format>\n",
          "maxIterations": 3
        }
      },
      "id": "764feb55-2bd2-4539-b14e-eef541b49137",
      "name": "Big Five",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -1632,
        112
      ]
    },
    {
      "parameters": {
        "functionCode": "const s = $items('start')[0]?.json ?? {};\nconst p = $json.output ?? {};\nconst traits = ['openness','conscientiousness','extraversion','agreeableness','neuroticism'];\nconst norm = v => { const n = Number(v); return Number.isFinite(n) ? Math.min(100, Math.max(0, Math.round(n >= 0 && n <= 1 ? n * 100 : n))) : null; };\nconst scores = traits.map(t => ({id: t, score: norm(p.big_five?.[t]?.score), conf: norm(p.big_five?.[t]?.confiabilidade)}));\nconst sorted = [...scores].sort((a,b) => (b.score||0) - (a.score||0));\nlet primary = p.perfil_primario;\nif (!primary || primary === 'misto' || !traits.includes(primary)) primary = sorted[0]?.id;\nconst secondary = sorted.find(e => e.id !== primary)?.id || sorted[1]?.id;\nconst avgConf = scores.length ? Math.round(scores.reduce((a,e) => a + (e.conf||0), 0) / scores.length) : null;\nlet dt = s.data_conversa ? new Date(s.data_conversa).toISOString().slice(0,10) : new Date().toISOString().slice(0,10);\nconst r = {usuario_id: s.usuario_id, chat_id: s.chat_id, data_conversa: dt, perfil_original: p.perfil_primario, perfil_primario: primary, perfil_secundario: secondary, resumo_perfil: p.resumo_perfil, insuficiente: Boolean(p.insuficiente), confianca_media: avgConf, raw_resposta: p};\ntraits.forEach(t => { r[`score_${t}`] = norm(p.big_five?.[t]?.score); r[`confianca_${t}`] = norm(p.big_five?.[t]?.confiabilidade); });\nreturn [{json: r}];"
      },
      "id": "402ac896-53f0-4188-8afe-6c27b1fc4b26",
      "name": "Preparar Registro BigFive",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -1328,
        112
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM usuarios_perfis WHERE chat_id = $2::uuid;\n\nINSERT INTO usuarios_perfis (usuario_id, chat_id, data_conversa, perfil_original, perfil_primario, perfil_secundario, resumo_perfil, insuficiente, score_openness, score_conscientiousness, score_extraversion, score_agreeableness, score_neuroticism, confianca_openness, confianca_conscientiousness, confianca_extraversion, confianca_agreeableness, confianca_neuroticism, confianca_media, raw_resposta, criado_em, atualizado_em)\nVALUES ($1::uuid, $2::uuid, $3::date, $4, $5, $6, $7, $8::boolean, $9::int, $10::int, $11::int, $12::int, $13::int, $14::int, $15::int, $16::int, $17::int, $18::int, $19::int, $20::jsonb, NOW(), NOW())\nON CONFLICT (chat_id) DO UPDATE SET perfil_primario = EXCLUDED.perfil_primario, perfil_secundario = EXCLUDED.perfil_secundario, resumo_perfil = EXCLUDED.resumo_perfil, insuficiente = EXCLUDED.insuficiente, score_openness = EXCLUDED.score_openness, score_conscientiousness = EXCLUDED.score_conscientiousness, score_extraversion = EXCLUDED.score_extraversion, score_agreeableness = EXCLUDED.score_agreeableness, score_neuroticism = EXCLUDED.score_neuroticism, confianca_media = EXCLUDED.confianca_media, raw_resposta = EXCLUDED.raw_resposta, atualizado_em = NOW()\nRETURNING id, perfil_primario;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id, $json.chat_id, $json.data_conversa, $json.perfil_original, $json.perfil_primario, $json.perfil_secundario, $json.resumo_perfil, $json.insuficiente === true, $json.score_openness, $json.score_conscientiousness, $json.score_extraversion, $json.score_agreeableness, $json.score_neuroticism, $json.confianca_openness, $json.confianca_conscientiousness, $json.confianca_extraversion, $json.confianca_agreeableness, $json.confianca_neuroticism, $json.confianca_media, $json.raw_resposta || {}] }}"
        }
      },
      "id": "09701788-11ee-43e8-8651-e57cf8b85024",
      "name": "Gravar BigFive",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1152,
        112
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Big Five - Perfil de personalidade",
        "height": 544,
        "width": 1504
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2448,
        -48
      ],
      "id": "431ad6f7-1a8d-4be2-b746-b6270c2e63da",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"big_five\": {\n    \"openness\": {\"score\": 62, \"confiabilidade\": 78, \"evidencias\": [\"gosto de explorar ideias novas\", \"procuro alternativas criativas\"]},\n    \"conscientiousness\": {\"score\": 54, \"confiabilidade\": 65, \"evidencias\": [\"monitorei meu plano\", \"organizei meus passos\"]},\n    \"extraversion\": {\"score\": 41, \"confiabilidade\": 60, \"evidencias\": [\"prefiro ficar na minha\", \"evitei encontros\"]},\n    \"agreeableness\": {\"score\": 70, \"confiabilidade\": 72, \"evidencias\": [\"procurei conciliar\", \"quero evitar conflito\"]},\n    \"neuroticism\": {\"score\": 58, \"confiabilidade\": 68, \"evidencias\": [\"fiquei ansioso com perdas\", \"preocupação constante\"]}\n  },\n  \"perfil_primario\": \"agreeableness\",\n  \"resumo_perfil\": \"Pessoa colaborativa, aberta a diálogos e soluções conjuntas, mantendo equilíbrio em disciplina e energia social.\",\n  \"insuficiente\": false\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1472,
        304
      ],
      "id": "73d9e64a-0ac0-42cb-8bd5-df5528937e84",
      "name": "Parser Bigfive"
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usuario_id"
            },
            {
              "name": "chat_id"
            },
            {
              "name": "data_conversa"
            },
            {
              "name": "usr_nome_preferencia"
            }
          ]
        }
      },
      "id": "fc40aa74-bc3e-4317-b4f8-20dad36293bc",
      "name": "start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -2384,
        112
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT c.id, c.resumo_conversa, c.tem_reflexao, c.mensagens, c.total_palavras_usuario, u.nome_preferencia\nFROM usr_chat c JOIN usuarios u ON u.id = c.usuario_id WHERE c.id = $1::uuid;",
        "options": {
          "queryReplacement": "={{ [$json.chat_id] }}"
        }
      },
      "id": "53c317fb-5af6-4579-937b-b35cb296781d",
      "name": "Buscar Dados Chat",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2192,
        112
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    }
  ],
  "connections": {
    "Buscar Historico BigFive": {
      "main": [
        [
          {
            "node": "Preparar Contexto BigFive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Contexto BigFive": {
      "main": [
        [
          {
            "node": "Big Five",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM BigFive": {
      "main": [
        []
      ],
      "ai_languageModel": [
        [
          {
            "node": "Big Five",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Big Five": {
      "main": [
        [
          {
            "node": "Preparar Registro BigFive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Registro BigFive": {
      "main": [
        [
          {
            "node": "Gravar BigFive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser Bigfive": {
      "ai_outputParser": [
        [
          {
            "node": "Big Five",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "start": {
      "main": [
        [
          {
            "node": "Buscar Dados Chat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Dados Chat": {
      "main": [
        [
          {
            "node": "Buscar Historico BigFive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": {
    "start": [
      {
        "json": {
          "usuario_id": "95376ed3-92b7-4d28-b069-f22b2b2300d8",
          "chat_id": "6cdc1cd9-4e1c-4969-ac3c-2da742697b24",
          "data_conversa": "2025-12-20T00:00:00.000Z",
          "usr_nome_preferencia": "Nice"
        }
      }
    ]
  },
  "activeVersionId": null,
  "shared": [
    {
      "createdAt": "2025-12-21T12:27:03.203Z",
      "role": "workflow:owner",
      "workflowId": "JOqIaAhynreLzGPs",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [],
  "activeVersion": null
}
