{
  "createdAt": "2025-12-16T12:23:46.864Z",
  "id": "vO3MP2nV0jI6692g",
  "name": "job_notificacoes",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  n.usuario_id,\n  u.nome_preferencia,\n  u.tom_conversa,\n  u.whatsapp_numero,\n  n.lembretes_canais,\n  ARRAY_AGG(DISTINCT dp.token) FILTER (WHERE dp.token IS NOT NULL) AS push_tokens,\n  CASE \n    WHEN NOT EXISTS (SELECT 1 FROM usr_chat WHERE usuario_id = n.usuario_id) \n    THEN true \n    ELSE false \n  END AS is_primeira_conversa,\n  (SELECT json_agg(json_build_object(\n    'data_conversa', c.data_conversa,\n    'resumo', c.resumo_conversa\n  ) ORDER BY c.data_conversa DESC)\n   FROM (\n     SELECT data_conversa, resumo_conversa\n     FROM usr_chat\n     WHERE usuario_id = n.usuario_id\n       AND resumo_conversa IS NOT NULL\n     ORDER BY data_conversa DESC\n     LIMIT 5\n   ) c\n  ) AS ultimas_conversas\nFROM notificacoes n\nINNER JOIN usuarios u ON u.id = n.usuario_id\nLEFT JOIN dispositivos_push dp ON dp.usuario_id = n.usuario_id\nWHERE n.lembretes_ativo = true\n  AND n.lembretes_conversas_diarias = true\n  AND 'whatsapp' = ANY(n.lembretes_canais)\n  AND NOT EXISTS (\n    SELECT 1 \n    FROM usr_chat c \n    WHERE c.usuario_id = n.usuario_id \n      AND DATE(c.data_conversa) = CURRENT_DATE\n  )\n  AND NOT EXISTS (\n    SELECT 1 \n    FROM notificacoes_log nl \n    WHERE nl.usuario_id = n.usuario_id \n      AND DATE(nl.criado_em) = CURRENT_DATE \n      AND nl.tipo LIKE 'conversa%'\n  )\nGROUP BY n.usuario_id, u.nome_preferencia, u.tom_conversa, u.whatsapp_numero, n.lembretes_canais;",
        "options": {}
      },
      "id": "e50aa4b1-c5b2-4321-a73b-71f593af6d76",
      "name": "usuarios_conversas",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        400,
        128
      ],
      "retryOnFail": false,
      "maxTries": 3,
      "waitBetweenTries": 1000,
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        672,
        128
      ],
      "id": "2c136e72-01a5-42bf-9b7a-46ce97d9da6c",
      "name": "Loop Conversas"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "i5VG5rHZ39ytueyu",
          "mode": "list",
          "cachedResultUrl": "/workflow/i5VG5rHZ39ytueyu",
          "cachedResultName": "sw_mentor_notificacoes"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $('usuarios_conversas').item.json.usuario_id }}",
            "nome_preferencia": "={{ $('usuarios_conversas').item.json.nome_preferencia }}",
            "tom_conversa": "={{ $('usuarios_conversas').item.json.tom_conversa || 'empatico' }}",
            "whats_number": "={{ $('usuarios_conversas').item.json.whatsapp_numero }}",
            "lembretes_canais": "={{ $('usuarios_conversas').item.json.lembretes_canais }}",
            "push_tokens": "={{ $('usuarios_conversas').item.json.push_tokens }}",
            "tipo_notificacao": "={{ $('usuarios_conversas').item.json.is_primeira_conversa ? 'primeira_conversa' : 'conversa' }}",
            "contexto": "={{ { ultimas_conversas: $('usuarios_conversas').item.json.ultimas_conversas, is_primeira_conversa: $('usuarios_conversas').item.json.is_primeira_conversa } }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "nome_preferencia",
              "displayName": "nome_preferencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "tom_conversa",
              "displayName": "tom_conversa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "whats_number",
              "displayName": "whats_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "lembretes_canais",
              "displayName": "lembretes_canais",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "array",
              "removed": false
            },
            {
              "id": "push_tokens",
              "displayName": "push_tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "array",
              "removed": false
            },
            {
              "id": "tipo_notificacao",
              "displayName": "tipo_notificacao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "contexto",
              "displayName": "contexto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        960,
        144
      ],
      "id": "7aafc8ff-2924-43f4-857a-91da7f370119",
      "name": "Call sw_mentor_notificacoes (conversas)"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * *"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        192,
        128
      ],
      "id": "c409881a-2485-47cb-986a-96f913e6175c",
      "name": "Trigger Conversas 09h"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 15 * * *"
            }
          ]
        }
      },
      "id": "trigger_quests",
      "name": "Trigger Quests 15h",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        192,
        400
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH quests_atrasadas AS (\n  SELECT \n    uq.usuario_id,\n    uq.config->>'titulo' AS titulo,\n    uq.config->>'descricao' AS descricao,\n    uo.titulo AS objetivo_relacionado,\n    CURRENT_DATE - DATE(uq.ativado_em) AS dias_sem_progresso\n  FROM usuarios_quest uq\n  LEFT JOIN usuarios_objetivos uo ON uq.objetivo_id = uo.id\n  WHERE uq.status = 'ativa'\n    AND uq.ativado_em < CURRENT_DATE - INTERVAL '2 days'\n  ORDER BY dias_sem_progresso DESC\n  LIMIT 3\n)\nSELECT \n  n.usuario_id,\n  u.nome_preferencia,\n  u.tom_conversa,\n  u.whatsapp_numero,\n  n.lembretes_canais,\n  ARRAY_AGG(DISTINCT dp.token) FILTER (WHERE dp.token IS NOT NULL) AS push_tokens,\n  json_agg(json_build_object(\n    'titulo', qa.titulo,\n    'descricao', qa.descricao,\n    'objetivo_relacionado', qa.objetivo_relacionado,\n    'dias_sem_progresso', qa.dias_sem_progresso\n  )) AS quests_atrasadas,\n  (SELECT json_agg(json_build_object('id', o.id, 'titulo', o.titulo))\n   FROM usuarios_objetivos o WHERE o.usuario_id = n.usuario_id AND o.status = 'ativo' AND o.is_padrao = false\n  ) AS objetivos_configurados\nFROM notificacoes n\nINNER JOIN usuarios u ON u.id = n.usuario_id\nLEFT JOIN dispositivos_push dp ON dp.usuario_id = n.usuario_id\nINNER JOIN quests_atrasadas qa ON qa.usuario_id = n.usuario_id\nWHERE n.lembretes_ativo = true\n  AND n.lembretes_quests_acoes = true\n  AND 'whatsapp' = ANY(n.lembretes_canais)\n  AND NOT EXISTS (\n    SELECT 1 FROM notificacoes_log nl \n    WHERE nl.usuario_id = n.usuario_id \n      AND DATE(nl.criado_em) = CURRENT_DATE \n      AND nl.tipo LIKE 'quest%'\n  )\nGROUP BY n.usuario_id, u.nome_preferencia, u.tom_conversa, u.whatsapp_numero, n.lembretes_canais;",
        "options": {}
      },
      "id": "query_quests",
      "name": "usuarios_quests_atrasadas",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        400,
        400
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "loop_quests",
      "name": "Loop Quests",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        672,
        400
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "i5VG5rHZ39ytueyu",
          "mode": "list",
          "cachedResultName": "sw_mentor_notificacoes"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $('usuarios_quests_atrasadas').item.json.usuario_id }}",
            "nome_preferencia": "={{ $('usuarios_quests_atrasadas').item.json.nome_preferencia }}",
            "tom_conversa": "={{ $('usuarios_quests_atrasadas').item.json.tom_conversa || 'empatico' }}",
            "whats_number": "={{ $('usuarios_quests_atrasadas').item.json.whatsapp_numero }}",
            "lembretes_canais": "={{ $('usuarios_quests_atrasadas').item.json.lembretes_canais }}",
            "push_tokens": "={{ $('usuarios_quests_atrasadas').item.json.push_tokens }}",
            "tipo_notificacao": "quest",
            "contexto": "={{ { quests_atrasadas: $('usuarios_quests_atrasadas').item.json.quests_atrasadas, objetivos_configurados: $('usuarios_quests_atrasadas').item.json.objetivos_configurados } }}"
          },
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "id": "call_quests",
      "name": "Call sw_mentor_notificacoes (quests)",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        960,
        416
      ]
    }
  ],
  "connections": {
    "usuarios_conversas": {
      "main": [
        [
          {
            "node": "Loop Conversas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Conversas": {
      "main": [
        [],
        [
          {
            "node": "Call sw_mentor_notificacoes (conversas)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call sw_mentor_notificacoes (conversas)": {
      "main": [
        [
          {
            "node": "Loop Conversas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Conversas 09h": {
      "main": [
        [
          {
            "node": "usuarios_conversas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Quests 15h": {
      "main": [
        [
          {
            "node": "usuarios_quests_atrasadas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "usuarios_quests_atrasadas": {
      "main": [
        [
          {
            "node": "Loop Quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Quests": {
      "main": [
        [],
        [
          {
            "node": "Call sw_mentor_notificacoes (quests)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call sw_mentor_notificacoes (quests)": {
      "main": [
        [
          {
            "node": "Loop Quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": {
    "node:Schedule Trigger": {
      "recurrenceRules": []
    }
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "activeVersionId": null,
  "shared": [
    {
      "createdAt": "2025-12-16T12:23:46.864Z",
      "role": "workflow:owner",
      "workflowId": "vO3MP2nV0jI6692g",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [],
  "activeVersion": null
}
