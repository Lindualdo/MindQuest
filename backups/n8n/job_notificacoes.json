{
  "createdAt": "2025-12-16T12:23:46.864Z",
  "id": "vO3MP2nV0jI6692g",
  "name": "job_notificacoes",
  "description": null,
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  n.usuario_id,\n  u.nome_preferencia,\n  u.tom_conversa,\n  u.whatsapp_numero,\n  n.lembretes_canais,\n  ARRAY_AGG(DISTINCT dp.token) FILTER (WHERE dp.token IS NOT NULL) AS push_tokens,\n  CASE \n    WHEN NOT EXISTS (SELECT 1 FROM usr_chat WHERE usuario_id = n.usuario_id) \n    THEN true \n    ELSE false \n  END AS is_primeira_conversa,\n  (SELECT json_agg(json_build_object(\n    'data_conversa', c.data_conversa,\n    'resumo', c.resumo_conversa\n  ) ORDER BY c.data_conversa DESC)\n   FROM (\n     SELECT data_conversa, resumo_conversa\n     FROM usr_chat\n     WHERE usuario_id = n.usuario_id\n       AND resumo_conversa IS NOT NULL\n     ORDER BY data_conversa DESC\n     LIMIT 5\n   ) c\n  ) AS ultimas_conversas\nFROM notificacoes n\nINNER JOIN usuarios u ON u.id = n.usuario_id\nLEFT JOIN dispositivos_push dp ON dp.usuario_id = n.usuario_id\nWHERE n.lembretes_ativo = true\n  AND n.lembretes_conversas_diarias = true\n  AND 'whatsapp' = ANY(n.lembretes_canais)\n  AND NOT EXISTS (\n    SELECT 1 \n    FROM usr_chat c \n    WHERE c.usuario_id = n.usuario_id \n      AND DATE(c.data_conversa) = CURRENT_DATE\n  )\n  AND NOT EXISTS (\n    SELECT 1 \n    FROM notificacoes_log nl \n    WHERE nl.usuario_id = n.usuario_id \n      AND DATE(nl.criado_em) = CURRENT_DATE \n      AND nl.tipo LIKE 'conversa%'\n  )\nGROUP BY n.usuario_id, u.nome_preferencia, u.tom_conversa, u.whatsapp_numero, n.lembretes_canais;",
        "options": {}
      },
      "id": "e50aa4b1-c5b2-4321-a73b-71f593af6d76",
      "name": "usuarios_conversas",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        400,
        128
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        672,
        128
      ],
      "id": "2c136e72-01a5-42bf-9b7a-46ce97d9da6c",
      "name": "Loop Conversas"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "i5VG5rHZ39ytueyu",
          "mode": "list",
          "cachedResultName": "sw_mentor_notificacoes"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $('usuarios_conversas').item.json.usuario_id }}",
            "nome_preferencia": "={{ $('usuarios_conversas').item.json.nome_preferencia }}",
            "tom_conversa": "={{ $('usuarios_conversas').item.json.tom_conversa || 'empatico' }}",
            "whats_number": "={{ $('usuarios_conversas').item.json.whatsapp_numero }}",
            "lembretes_canais": "={{ $('usuarios_conversas').item.json.lembretes_canais }}",
            "push_tokens": "={{ $('usuarios_conversas').item.json.push_tokens }}",
            "tipo_notificacao": "={{ $('usuarios_conversas').item.json.is_primeira_conversa ? 'primeira_conversa' : 'conversa' }}",
            "contexto": "={{ { ultimas_conversas: $('usuarios_conversas').item.json.ultimas_conversas, is_primeira_conversa: $('usuarios_conversas').item.json.is_primeira_conversa } }}"
          },
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        960,
        144
      ],
      "id": "7aafc8ff-2924-43f4-857a-91da7f370119",
      "name": "Call sw_mentor_notificacoes (conversas)"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 9
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        192,
        128
      ],
      "id": "c409881a-2485-47cb-986a-96f913e6175c",
      "name": "Trigger Conversas 09h"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 15
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        176,
        400
      ],
      "id": "79084208-9153-4934-8c80-1c864893ac1f",
      "name": "Trigger Quests 15h"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH ultimo_humor AS (\n  SELECT DISTINCT ON (c.usuario_id)\n    c.usuario_id,\n    uhe.humor_dia as humor_nivel\n  FROM usuarios_humor_energia uhe\n  INNER JOIN usr_chat c ON c.id = uhe.chat_id\n  ORDER BY c.usuario_id, c.data_conversa DESC\n),\nenergia_panas AS (\n  SELECT \n    ue.usuario_id,\n    CASE WHEN COUNT(*) > 0\n      THEN ROUND((COUNT(*) FILTER (WHERE LOWER(ue.emocao_id) IN ('joy','trust','anticipation'))::numeric / COUNT(*)::numeric) * 100, 1)\n      ELSE 60 END AS percentual_positiva\n  FROM usuarios_emocoes ue\n  WHERE ue.intensidade >= 45\n  GROUP BY ue.usuario_id\n),\nsabotadores_top3 AS (\n  SELECT \n    us.usuario_id,\n    (SELECT json_agg(sub ORDER BY sub.score DESC)\n     FROM (\n       SELECT \n         us2.sabotador_id,\n         sc.nome,\n         sc.emoji,\n         (us2.total_deteccoes * COALESCE(us2.intensidade_media, 50)) as score\n       FROM usuarios_sabotadores us2\n       INNER JOIN sabotadores_catalogo sc ON sc.id = us2.sabotador_id\n       WHERE us2.usuario_id = us.usuario_id\n       ORDER BY (us2.total_deteccoes * COALESCE(us2.intensidade_media, 50)) DESC\n       LIMIT 3\n     ) sub\n    ) as sabotadores\n  FROM (SELECT DISTINCT usuario_id FROM usuarios_sabotadores) us\n),\nobjetivos_especificos AS (\n  SELECT \n    uo.usuario_id,\n    json_agg(json_build_object(\n      'id', uo.id,\n      'titulo', uo.titulo,\n      'area', avc.nome\n    )) AS objetivos\n  FROM usuarios_objetivos uo\n  LEFT JOIN areas_vida_catalogo avc ON avc.id = uo.area_vida_id\n  WHERE uo.status = 'ativo' AND uo.is_padrao = false\n  GROUP BY uo.usuario_id\n),\nquests_disponiveis AS (\n  SELECT \n    uq.usuario_id,\n    json_agg(json_build_object(\n      'quest_id', uq.id,\n      'titulo', uq.config->>'titulo',\n      'descricao', uq.config->>'descricao',\n      'categoria', qc.categoria,\n      'status', uq.status,\n      'sabotador_id', uq.sabotador_id,\n      'objetivo_id', uq.objetivo_id\n    ) ORDER BY \n      CASE uq.status WHEN 'ativa' THEN 1 ELSE 2 END,\n      uq.ativado_em DESC\n    ) AS quests\n  FROM usuarios_quest uq\n  LEFT JOIN quests_catalogo qc ON qc.id = uq.catalogo_id\n  WHERE uq.status IN ('disponivel', 'ativa')\n    AND COALESCE(qc.categoria, '') != 'essencial'\n  GROUP BY uq.usuario_id\n)\nSELECT \n  n.usuario_id,\n  u.nome_preferencia,\n  u.tom_conversa,\n  u.whatsapp_numero,\n  n.lembretes_canais,\n  (SELECT ARRAY_AGG(DISTINCT dp.token) FROM dispositivos_push dp WHERE dp.usuario_id = n.usuario_id AND dp.token IS NOT NULL) AS push_tokens,\n  COALESCE(uh.humor_nivel, 6) as humor_nivel,\n  COALESCE(ROUND(ep.percentual_positiva / 10, 0), 6) as energia_nivel,\n  COALESCE(st.sabotadores, '[]'::json) as sabotadores_top3,\n  COALESCE(oe.objetivos, '[]'::json) as objetivos_especificos,\n  COALESCE(qd.quests, '[]'::json) as quests_disponiveis,\n  (SELECT json_agg(json_build_object(\n    'data_conversa', c.data_conversa,\n    'resumo', c.resumo_conversa\n  ) ORDER BY c.data_conversa DESC)\n   FROM (\n     SELECT data_conversa, resumo_conversa\n     FROM usr_chat\n     WHERE usuario_id = n.usuario_id\n       AND resumo_conversa IS NOT NULL\n     ORDER BY data_conversa DESC\n     LIMIT 5\n   ) c\n  ) AS ultimas_conversas\nFROM notificacoes n\nINNER JOIN usuarios u ON u.id = n.usuario_id\nLEFT JOIN ultimo_humor uh ON uh.usuario_id = n.usuario_id\nLEFT JOIN energia_panas ep ON ep.usuario_id = n.usuario_id\nLEFT JOIN sabotadores_top3 st ON st.usuario_id = n.usuario_id\nLEFT JOIN objetivos_especificos oe ON oe.usuario_id = n.usuario_id\nLEFT JOIN quests_disponiveis qd ON qd.usuario_id = n.usuario_id\nWHERE n.lembretes_ativo = true\n  AND n.lembretes_quests = true\n  AND 'whatsapp' = ANY(n.lembretes_canais)\n  AND NOT EXISTS (\n    SELECT 1 FROM notificacoes_log nl \n    WHERE nl.usuario_id = n.usuario_id \n      AND DATE(nl.criado_em) = CURRENT_DATE \n      AND nl.tipo LIKE 'quest%'\n  );",
        "options": {}
      },
      "id": "query_usuarios_elegiveis",
      "name": "usuarios_elegiveis_quests",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        400,
        400
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "loop_quests",
      "name": "Loop Quests",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        672,
        400
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "i5VG5rHZ39ytueyu",
          "mode": "list",
          "cachedResultName": "sw_mentor_notificacoes"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $('usuarios_elegiveis_quests').item.json.usuario_id }}",
            "nome_preferencia": "={{ $('usuarios_elegiveis_quests').item.json.nome_preferencia }}",
            "tom_conversa": "={{ $('usuarios_elegiveis_quests').item.json.tom_conversa || 'empatico' }}",
            "whats_number": "={{ $('usuarios_elegiveis_quests').item.json.whatsapp_numero }}",
            "lembretes_canais": "={{ $('usuarios_elegiveis_quests').item.json.lembretes_canais }}",
            "push_tokens": "={{ $('usuarios_elegiveis_quests').item.json.push_tokens }}",
            "tipo_notificacao": "quest",
            "contexto": "={{ { humor_nivel: $('usuarios_elegiveis_quests').item.json.humor_nivel, energia_nivel: $('usuarios_elegiveis_quests').item.json.energia_nivel, sabotadores_top3: $('usuarios_elegiveis_quests').item.json.sabotadores_top3, objetivos_especificos: $('usuarios_elegiveis_quests').item.json.objetivos_especificos, quests_disponiveis: $('usuarios_elegiveis_quests').item.json.quests_disponiveis, ultimas_conversas: $('usuarios_elegiveis_quests').item.json.ultimas_conversas } }}"
          },
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "id": "call_mentor_quests",
      "name": "Call sw_mentor_notificacoes (quests)",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        960,
        400
      ]
    },
    {
      "parameters": {
        "width": 400,
        "height": 400,
        "content": "## Notificação Quests 15h\n\n### Input para o Mentor\n\n```json\n{\n  \"humor_nivel\": 1-10,\n  \"energia_nivel\": 1-10,\n  \"sabotadores_top3\": [{nome, emoji, score}],\n  \"objetivos_especificos\": [{titulo, area}],\n  \"quests_disponiveis\": [{quest_id, titulo, categoria, status, sabotador_id, objetivo_id}],\n  \"ultimas_conversas\": [{data, resumo}]\n}\n```\n\n### Categorias de Quests\n\n- `tcc` / `estoicismo` → bem-estar\n- `contramedida_sabotador` → sabotador\n- `personalizada` / `neurociencia` / `boa_pratica_geral` → objetivo\n\n### Decisão do Mentor\n\n1. humor/energia <= 5 → prioriza tcc/estoicismo\n2. sabotador no contexto → prioriza contramedida\n3. default → personalizada/objetivo\n\n---\n\n**Ref:** `docs/espec/emocoes/`"
      },
      "id": "sticky-regras-quests",
      "name": "Regras Notificação Quests",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        176,
        560
      ]
    }
  ],
  "connections": {
    "usuarios_conversas": {
      "main": [
        [
          {
            "node": "Loop Conversas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Conversas": {
      "main": [
        [],
        [
          {
            "node": "Call sw_mentor_notificacoes (conversas)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call sw_mentor_notificacoes (conversas)": {
      "main": [
        [
          {
            "node": "Loop Conversas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Conversas 09h": {
      "main": [
        [
          {
            "node": "usuarios_conversas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Quests 15h": {
      "main": [
        [
          {
            "node": "usuarios_elegiveis_quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "usuarios_elegiveis_quests": {
      "main": [
        [
          {
            "node": "Loop Quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Quests": {
      "main": [
        [],
        [
          {
            "node": "Call sw_mentor_notificacoes (quests)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call sw_mentor_notificacoes (quests)": {
      "main": [
        [
          {
            "node": "Loop Quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "timezone": "America/Sao_Paulo"
  },
  "staticData": {
    "node:Trigger Conversas 09h": {
      "recurrenceRules": []
    },
    "node:Trigger Quests 15h": {
      "recurrenceRules": []
    }
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "tags": []
}
