{
  "createdAt": "2025-12-07T20:11:13.721Z",
  "id": "zpNw60BXhEJCYTYH",
  "name": "mentor_mindquest_v2",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usr_id"
            },
            {
              "name": "body.instance"
            },
            {
              "name": "body.data.key.remoteJid"
            },
            {
              "name": "body.data.key.id"
            },
            {
              "name": "body.data.key.fromMe",
              "type": "boolean"
            },
            {
              "name": "body.data.pushName"
            },
            {
              "name": "body.data.message.conversation"
            },
            {
              "name": "body.data.messageType"
            }
          ]
        }
      },
      "id": "start",
      "name": "start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -544,
        -304
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "fVrO1PaqFuA957u0",
          "mode": "list"
        }
      },
      "id": "config",
      "name": "config",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -368,
        -304
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  u.nome,\n  u.id,\n  u.nome_preferencia,\n  u.nome_assistente,\n  u.token_acesso,\n  u.cronotipo_detectado,\n  u.whatsapp_numero,\n  u.faixa_etaria,\n  u.sobre_voce,\n  u.tom_conversa\nFROM usuarios u\nWHERE u.id = $1;",
        "options": {
          "queryReplacement": "={{ $('start').first().json.usr_id }}"
        }
      },
      "id": "busca_dados_usr",
      "name": "busca_dados_usr",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -192,
        -304
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH objetivos AS (\n  SELECT json_agg(json_build_object('id', o.id, 'titulo', o.titulo, 'area_vida', av.nome, 'is_padrao', o.is_padrao))\n  FROM usuarios_objetivos o\n  JOIN areas_vida_catalogo av ON o.area_vida_id = av.id\n  WHERE o.usuario_id = $1 AND o.status = 'ativo'\n),\nobjetivo_padrao AS (\n  SELECT id FROM usuarios_objetivos\n  WHERE usuario_id = $1 AND is_padrao = TRUE AND status = 'ativo'\n  LIMIT 1\n),\nsabotador AS (\n  SELECT sabotador_id, COUNT(*) AS total_deteccoes\n  FROM usuarios_sabotadores\n  WHERE usuario_id = $1\n  GROUP BY sabotador_id\n  ORDER BY COUNT(*) DESC\n  LIMIT 1\n),\nperfil_bigfive AS (\n  SELECT perfil_primario, COUNT(*) AS total_deteccoes, ROUND(AVG(confianca_media)::numeric, 2) AS confianca_media\n  FROM usuarios_perfis\n  WHERE usuario_id = $1\n  GROUP BY perfil_primario\n  ORDER BY COUNT(*) DESC, AVG(confianca_media) DESC\n  LIMIT 1\n),\nquests_count AS (\n  SELECT \n    COUNT(*) FILTER (WHERE status = 'ativa') AS total_ativas,\n    COUNT(*) FILTER (WHERE status = 'disponivel') AS total_disponiveis\n  FROM usuarios_quest\n  WHERE usuario_id = $1 AND status IN ('ativa', 'disponivel')\n),\nhistorico AS (\n  SELECT json_agg(json_build_object('id', c.id, 'data_conversa', c.data_conversa, 'resumo_conversa', c.resumo_conversa))\n  FROM (\n    SELECT id, data_conversa, resumo_conversa\n    FROM usr_chat\n    WHERE usuario_id = $1 \n      AND resumo_conversa IS NOT NULL\n      AND data_conversa < CURRENT_DATE\n    ORDER BY data_conversa DESC, horario_inicio DESC\n    LIMIT 5\n  ) c\n),\nnivel AS (\n  SELECT nivel_atual, titulo_nivel FROM usuarios_conquistas\n  WHERE usuario_id = $1\n  LIMIT 1\n),\nsessao_hoje AS (\n  SELECT id, data_conversa, status, mensagens\n  FROM usr_chat\n  WHERE usuario_id = $1 AND data_conversa = CURRENT_DATE\n  ORDER BY horario_inicio DESC\n  LIMIT 1\n),\ntotal_conversas AS (\n  SELECT COUNT(*) as total FROM usr_chat WHERE usuario_id = $1\n)\nSELECT\n  (SELECT * FROM objetivos) AS objetivos_especificos,\n  (SELECT id FROM objetivo_padrao) AS objetivo_padrao_id,\n  (SELECT sabotador_id FROM sabotador) AS sabotador_mais_ativo,\n  (SELECT perfil_primario FROM perfil_bigfive) AS perfil_bigfive_primario,\n  (SELECT total_ativas FROM quests_count) AS quests_ativas_total,\n  (SELECT total_disponiveis FROM quests_count) AS quests_disponiveis_total,\n  (SELECT * FROM historico) AS ultimas_conversas,\n  (SELECT nivel_atual FROM nivel) AS nivel_atual,\n  (SELECT titulo_nivel FROM nivel) AS titulo_nivel,\n  (SELECT id FROM sessao_hoje) AS sessao_hoje_id,\n  (SELECT status FROM sessao_hoje) AS sessao_hoje_status,\n  (SELECT mensagens FROM sessao_hoje) AS sessao_hoje_mensagens,\n  (SELECT total FROM total_conversas) AS total_conversas;",
        "options": {
          "queryReplacement": "={{ $('start').first().json.usr_id }}"
        }
      },
      "id": "busca_contexto",
      "name": "busca_contexto",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        224,
        -304
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// CONTEXTO COMPLETO v7 - Ignora objetivo padr√£o no flag tem_objetivos\nconst usuarioId = $('start').first().json.usr_id;\nconst config = $('config').first().json;\nconst dadosUsr = $('busca_dados_usr').first().json;\nconst contexto = $('busca_contexto').first().json;\n\n// Notifica√ß√£o recente (se houver)\nconst notifResult = $('busca_notificacao').first()?.json;\nconst temNotificacao = notifResult && notifResult.id;\nconst notificacaoRecente = temNotificacao ? {\n  id: notifResult.id,\n  tipo: notifResult.tipo,\n  titulo: notifResult.titulo || '',\n  mensagem: notifResult.mensagem || '',\n  contexto_mentor: notifResult.contexto_mentor || '',\n  quests_mencionadas: notifResult.quests_mencionadas || [],\n  referencia_id: notifResult.referencia_id,\n  criado_em: notifResult.criado_em\n} : null;\n\n// Verifica se √© primeira conversa\nconst totalConversas = Number(contexto?.total_conversas || 0);\nconst isPrimeiraConversa = totalConversas === 0;\n\n// Verifica se usu√°rio tem objetivos AL√âM do padr√£o\nconst objetivos = contexto?.objetivos_especificos || [];\n\n// Filtra objetivos configur√°veis (ignora padr√£o)\nconst objetivosConfigurados = Array.isArray(objetivos) \n  ? objetivos.filter(obj => !obj.is_padrao)\n  : [];\n\n// tem_objetivos = true apenas se tem objetivos AL√âM do padr√£o\nconst temObjetivos = objetivosConfigurados.length > 0;\n\n// Quests - apenas totais (detalhes via tool)\nconst questsAtivasTotal = Number(contexto?.quests_ativas_total || 0);\nconst questsDisponiveisTotal = Number(contexto?.quests_disponiveis_total || 0);\nconst temQuests = questsAtivasTotal > 0 || questsDisponiveisTotal > 0;\n\n// Sess√£o do dia\nconst sessaoHojeId = contexto?.sessao_hoje_id || null;\nconst sessaoHojeStatus = contexto?.sessao_hoje_status || null;\nconst sessaoHojeMensagens = contexto?.sessao_hoje_mensagens || [];\n\n// NOVO CICLO: n√£o existe sess√£o OU sess√£o est√° finalizada\nconst isNovoCiclo = !sessaoHojeId || sessaoHojeStatus === 'finalizado';\n\n// Se √© novo ciclo (sess√£o finalizada), reseta contador de intera√ß√µes\nconst mensagensArray = Array.isArray(sessaoHojeMensagens) ? sessaoHojeMensagens : [];\nconst interacaoAtual = isNovoCiclo ? 1 : mensagensArray.filter(m => m?.autor === 'usuario').length + 1;\n\n// Tom de conversa (default: empatico)\nconst tomConversa = dadosUsr?.tom_conversa || 'empatico';\n\nreturn [{\n  usuario_id: usuarioId,\n  nome_preferencia: dadosUsr?.nome_preferencia || null,\n  nome_assistente: dadosUsr?.nome_assistente || 'Mind',\n  whatsapp_numero: dadosUsr?.whatsapp_numero || null,\n  faixa_etaria: dadosUsr?.faixa_etaria || null,\n  sobre_voce: dadosUsr?.sobre_voce || null,\n  tom_conversa: tomConversa,\n  // Objetivos - separados para clareza\n  objetivos_especificos: objetivos,           // todos (incluindo padr√£o)\n  objetivos_configurados: objetivosConfigurados, // apenas os configur√°veis\n  tem_objetivos: temObjetivos,                // true s√≥ se tem configurados\n  objetivo_padrao: contexto?.objetivo_padrao_id || null,\n  sabotador_mais_ativo: contexto?.sabotador_mais_ativo || null,\n  perfil_bigfive_primario: contexto?.perfil_bigfive_primario || null,\n  // Quests - apenas indicadores\n  tem_quests: temQuests,\n  quests_ativas_total: questsAtivasTotal,\n  quests_disponiveis_total: questsDisponiveisTotal,\n  // Hist√≥rico\n  ultimas_conversas: contexto?.ultimas_conversas || [],\n  nivel_atual: contexto?.nivel_atual || 1,\n  titulo_nivel: contexto?.titulo_nivel || 'Explorador',\n  total_conversas: totalConversas,\n  is_primeira_conversa: isPrimeiraConversa,\n  sessao_hoje_id: sessaoHojeId,\n  sessao_hoje_mensagens: sessaoHojeMensagens,\n  // Novo ciclo quando sess√£o finalizada\n  is_nova_sessao: isNovoCiclo,\n  is_novo_ciclo: isNovoCiclo,\n  sessao_anterior_finalizada: sessaoHojeStatus === 'finalizado',\n  interacao_atual: interacaoAtual,\n  // Notifica√ß√£o\n  tem_notificacao_recente: temNotificacao,\n  notificacao_recente: notificacaoRecente\n}];"
      },
      "id": "contexto_completo",
      "name": "contexto_completo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        432,
        -304
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "jUAvu7DUAzyqZhJd",
          "mode": "list"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "body.instance": "={{ $('start').first().json['body.instance'] }}",
            "body.data.key.remoteJid": "={{ $('start').first().json['body.data.key.remoteJid'] }}",
            "body.data.key.id": "={{ $('start').first().json['body.data.key.id'] }}",
            "body.data.key.fromMe": "={{ $('start').first().json['body.data.key.fromMe'] }}",
            "body.data.pushName": "={{ $('start').first().json['body.data.pushName'] }}",
            "body.data.message.conversation": "={{ $('start').first().json['body.data.message.conversation'] }}",
            "body.data.messageType": "={{ $('start').first().json['body.data.messageType'] }}"
          }
        },
        "options": {}
      },
      "id": "transcricao",
      "name": "transcricao",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        624,
        -304
      ]
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('start').first().json['body.instance'] }}{{ $('start').first().json.usr_id }}{{ $('busca_dados_usr').item.json.whatsapp_numero }}",
        "sessionTTL": 43200,
        "contextWindowLength": 50
      },
      "id": "memory",
      "name": "memory",
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        864,
        128
      ],
      "credentials": {
        "redis": {
          "id": "PB4zpLy1jLXDEzmH",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-flash",
        "options": {}
      },
      "id": "openrouter_model",
      "name": "openrouter_model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        640,
        304
      ],
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"mensagem_usuario\": \"Oi! Como voc√™ est√° hoje?\",\n  \"tema_atual\": {\n    \"titulo\": \"Rotina de f√©rias\",\n    \"resumo\": [\"Definiu rotina 5h-22h\", \"Preocupa√ß√£o com sono\"],\n    \"decisoes\": [\"Academia √†s 5h\"]\n  },\n  \"checkpoint_encerramento\": false,\n  \"tema_atual_fechado\": false,\n  \"objetivo_sugerido\": null\n}",
        "autoFix": true
      },
      "id": "parser_mentor",
      "name": "parser_mentor",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        1520,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "// PROCESSA RESPOSTA DO MENTOR v7 - trigger sem limite de intera√ß√µes\nconst output = $input.first()?.json?.output ?? {};\nconst contexto = $('contexto_completo').first().json;\nconst transcricao = $('transcricao').first().json;\n\n// Flags do mentor\nconst checkpointEncerramento = output.checkpoint_encerramento === true;\nconst temaFechado = output.tema_atual_fechado === true;\nconst objetivoSugerido = output.objetivo_sugerido || null;\n\n// Tema atual\nconst temaAtual = output.tema_atual || { titulo: '', resumo: [], decisoes: [] };\n\n// Trigger: apenas quando mentor sinaliza fechamento\nconst triggerExperts = temaFechado || checkpointEncerramento;\n\n// Prepara mensagens para gravar (incremental)\nconst mensagemUsuario = {\n  interaction: contexto.interacao_atual,\n  autor: 'usuario',\n  texto: transcricao.message || '',\n  timestamp: new Date().toISOString()\n};\n\nconst mensagemMentor = {\n  interaction: contexto.interacao_atual,\n  autor: 'agente',\n  texto: output.mensagem_usuario || '',\n  timestamp: new Date().toISOString(),\n  tema: temaAtual.titulo || null\n};\n\n// Mensagens existentes + novas\nconst mensagensExistentes = Array.isArray(contexto.sessao_hoje_mensagens) \n  ? contexto.sessao_hoje_mensagens \n  : [];\nconst mensagensAtualizadas = [...mensagensExistentes, mensagemUsuario, mensagemMentor];\n\nreturn [{\n  user_message: output.mensagem_usuario || '',\n  checkpoint_encerramento: checkpointEncerramento,\n  tema_fechado: temaFechado,\n  tema_atual: temaAtual,\n  trigger_experts: triggerExperts,\n  objetivo_sugerido: objetivoSugerido,\n  interacao_atual: contexto.interacao_atual,\n  sessao_id: contexto.sessao_hoje_id,\n  is_nova_sessao: contexto.is_nova_sessao,\n  mensagens_atualizadas: JSON.stringify(mensagensAtualizadas),\n  total_interacoes: mensagensAtualizadas.filter(m => m.autor === 'usuario').length\n}];"
      },
      "id": "processa_resposta",
      "name": "processa_resposta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1168,
        -304
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Upsert: cria sess√£o OU reativa sess√£o finalizada\nWITH upsert AS (\n  INSERT INTO usr_chat (usuario_id, data_conversa, horario_inicio, status, mensagens, total_interactions)\n  VALUES ($1, CURRENT_DATE, NOW(), 'em_andamento', $2::jsonb, $3)\n  ON CONFLICT (usuario_id, data_conversa)\n  DO UPDATE SET \n    mensagens = $2::jsonb,\n    total_interactions = $3,\n    status = 'em_andamento',\n    horario_fim = NULL,\n    atualizado_em = NOW()\n  WHERE usr_chat.data_conversa = CURRENT_DATE\n  RETURNING id, usuario_id, data_conversa, status\n)\nSELECT * FROM upsert\nUNION ALL\nSELECT id, usuario_id, data_conversa, status \nFROM usr_chat \nWHERE usuario_id = $1 AND data_conversa = CURRENT_DATE\nLIMIT 1;",
        "options": {
          "queryReplacement": "={{ [ $('contexto_completo').first().json.usuario_id, $('processa_resposta').first().json.mensagens_atualizadas, $('processa_resposta').first().json.total_interacoes ] }}"
        }
      },
      "id": "grava_mensagem",
      "name": "grava_mensagem",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1360,
        -304
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "DJB5qWudX1Hqap1O",
          "mode": "list"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "instanceName": "={{ $('start').first().json['body.instance'] }}",
            "remoteJidOrNumber": "={{ $('start').first().json['body.data.key.remoteJid'] }}",
            "messageText": "={{ $('processa_resposta').first().json.user_message }}",
            "linkPreview": "false",
            "minDelayMs": "3000"
          }
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "envia_mensagem",
      "name": "envia_mensagem",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2064,
        -128
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE usr_chat\nSET status = 'finalizado', horario_fim = NOW(), atualizado_em = NOW()\nWHERE usuario_id = $1 AND data_conversa = CURRENT_DATE\nRETURNING id, usuario_id, data_conversa, status, mensagens;",
        "options": {
          "queryReplacement": "={{ $('contexto_completo').first().json.usuario_id }}"
        }
      },
      "id": "finaliza_sessao",
      "name": "finaliza_sessao",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2272,
        -464
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// PREPARA DADOS PARA OS EXPERTS (compat√≠vel com ambos os caminhos)\nconst contexto = $('contexto_completo').first().json;\nconst processa = $('processa_resposta').first().json;\nconst inputData = $input.first().json;\n\n// Mensagens: tenta do input (finaliza_sessao) ou do processa_resposta\nconst mensagens = inputData.mensagens || JSON.parse(processa.mensagens_atualizadas || '[]');\nconst mensagensTexto = mensagens.map(m => `${m.autor}: ${m.texto}`).join('\\n');\n\n// Objetivo sugerido pelo mentor (se houver)\nconst objetivoSugerido = processa.objetivo_sugerido || null;\n\nreturn [{\n  usuario_id: contexto.usuario_id,\n  chat_id: inputData.id || processa.sessao_id,\n  data_conversa: inputData.data_conversa || new Date().toISOString().split('T')[0],\n  mensagens_json: JSON.stringify(mensagens),\n  mensagens_texto: mensagensTexto,\n  total_interacoes: mensagens.filter(m => m.autor === 'usuario').length,\n  objetivo_sugerido: objetivoSugerido,\n  tem_objetivo_sugerido: objetivoSugerido !== null\n}];"
      },
      "id": "call_experts",
      "name": "call_experts",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2480,
        -272
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "vJRfrbY4NhpNyfCD",
          "mode": "list",
          "cachedResultUrl": "/workflow/vJRfrbY4NhpNyfCD",
          "cachedResultName": "sw_experts_panas"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $input.first().json.usuario_id }}",
            "chat_id": "={{ $input.first().json.chat_id }}",
            "mensagens": "={{ $input.first().json.mensagens_texto }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "mensagens",
              "displayName": "mensagens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data_conversa",
              "displayName": "data_conversa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "expert_panas",
      "name": "expert_panas",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2800,
        -896
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "Vbc4JHAR3388mLcv",
          "mode": "list"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $input.first().json.usuario_id }}",
            "chat_id": "={{ $input.first().json.chat_id }}",
            "mensagens": "={{ $input.first().json.mensagens_texto }}"
          }
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "expert_sabotadores",
      "name": "expert_sabotadores",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2800,
        -704
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "nEstxgiVE8GLXgUQ",
          "mode": "list"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $input.first().json.usuario_id }}",
            "chat_id": "={{ $input.first().json.chat_id }}",
            "mensagens": "={{ $input.first().json.mensagens_texto }}"
          }
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "expert_insights",
      "name": "expert_insights",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2800,
        -512
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "GykxpS5vsg8NeoOh",
          "mode": "list"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $input.first().json.usuario_id }}",
            "chat_id": "={{ $input.first().json.chat_id }}",
            "mensagens": "={{ $input.first().json.mensagens_texto }}"
          }
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "expert_humor_energia",
      "name": "expert_humor_energia",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2800,
        -320
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "nOl6lnaGMpyg9S9J",
          "mode": "list"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $input.first().json.usuario_id }}",
            "chat_id": "={{ $input.first().json.chat_id }}",
            "mensagens": "={{ $input.first().json.mensagens_texto }}"
          }
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "expert_bigfive",
      "name": "expert_bigfive",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2800,
        -128
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "ItBastfCTkWxm41M",
          "mode": "list",
          "cachedResultUrl": "/workflow/ItBastfCTkWxm41M",
          "cachedResultName": "sw_xp_conversas"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $input.first().json.usuario_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "calcular_apenas_novos",
              "displayName": "calcular_apenas_novos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "boolean",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "sw_xp_conversas",
      "name": "sw_xp_conversas",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2800,
        64
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "LKjU8NE9aNHw7kEh",
          "mode": "list"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $input.first().json.usuario_id }}",
            "chat_id": "={{ $input.first().json.chat_id }}"
          }
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "sw_criar_quest",
      "name": "sw_criar_quest",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        3088,
        -704
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "obj1",
              "leftValue": "={{ $input.first().json.tem_objetivo_sugerido }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "expert_objetivos",
      "name": "expert_objetivos",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2800,
        304
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Grava objetivo sugerido pelo mentor\nINSERT INTO usuarios_objetivos (usuario_id, titulo, area_vida_id, descricao, is_padrao, status)\nSELECT \n  $1,\n  $2,\n  av.id,\n  $4,\n  FALSE,\n  'ativo'\nFROM areas_vida_catalogo av\nWHERE av.nome ILIKE '%' || $3 || '%'\nLIMIT 1\nRETURNING id, titulo, area_vida_id;",
        "options": {
          "queryReplacement": "={{ [ $input.first().json.usuario_id, $input.first().json.objetivo_sugerido?.titulo || 'Objetivo', $input.first().json.objetivo_sugerido?.area_vida || 'Desenvolvimento Pessoal', $input.first().json.objetivo_sugerido?.detalhamento || '' ] }}"
        }
      },
      "id": "grava_objetivo",
      "name": "grava_objetivo",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3088,
        288
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=<user_input>\n\n<message>\n{{ $('transcricao').item.json.message }}\n</message>\n\n<session_context>\n<interaction_number>{{ $('contexto_completo').first().json.interacao_atual }}</interaction_number>\n<is_new_session>{{ $('contexto_completo').first().json.is_nova_sessao ? 'SIM' : 'N√ÉO' }}</is_new_session>\n<is_first_ever>{{ $('contexto_completo').first().json.is_primeira_conversa ? 'SIM' : 'N√ÉO' }}</is_first_ever>\n</session_context>\n</user_input>\n\n\n<!-- ============================================ -->\n<!-- NOTIFICA√á√ÉO PENDENTE (se houver) -->\n<!-- ============================================ -->\n\n{{ $('contexto_completo').first().json.tem_notificacao_recente ? `\n<notification_context>\n<has_pending_notification>SIM</has_pending_notification>\n<notification_type>${$('contexto_completo').first().json.notificacao_recente.tipo || ''}</notification_type>\n<notification_title>${$('contexto_completo').first().json.notificacao_recente.titulo || ''}</notification_title>\n<notification_message>\n${$('contexto_completo').first().json.notificacao_recente.mensagem || ''}\n</notification_message>\n<mentor_context>${$('contexto_completo').first().json.notificacao_recente.contexto_mentor || ''}</mentor_context>\n\n<instruction>\nANALISE A MENSAGEM DO USU√ÅRIO:\n\n1. Se for um N√öMERO (1, 2, 3, 4...):\n   - O usu√°rio est√° respondendo √† alternativa correspondente na notifica√ß√£o\n   - Use o contexto_mentor para conduzir a conversa sobre esse tema\n   - N√ÉO pergunte \"sobre o que quer falar\", voc√™ j√° sabe!\n\n2. Se for TEXTO relacionado ao tema:\n   - O usu√°rio est√° respondendo sobre a notifica√ß√£o\n   - Conduza a conversa naturalmente\n\n3. Se for TEXTO n√£o relacionado:\n   - O usu√°rio quer falar de outro assunto\n   - Siga o novo tema, n√£o force a notifica√ß√£o\n</instruction>\n</notification_context>\n` : '' }}\n\n<!-- ============================================ -->\n<!-- CONTEXTO DO USU√ÅRIO -->\n<!-- ============================================ -->\n\n<user_context>\n<profile>\n<name>{{ $('contexto_completo').first().json.nome_preferencia || 'amigo' }}</name>\n<preferred_tone>{{ $('contexto_completo').first().json.tom_conversa || 'empatico' }}</preferred_tone>\n<about>{{ $('contexto_completo').first().json.sobre_voce ? 'Sobre: ' + $('contexto_completo').first().json.sobre_voce : '' }}</about>\n</profile>\n\n<goals>\n<has_defined_goals>{{ $('contexto_completo').first().json.tem_objetivos ? 'SIM' : 'N√ÉO' }}</has_defined_goals>\n<active_goals>{{ JSON.stringify($('contexto_completo').first().json.objetivos_especificos || []) }}</active_goals>\n</goals>\n\n<mental_profile>\n<active_pattern>{{ $('contexto_completo').first().json.sabotador_mais_ativo || 'nenhum identificado' }}</active_pattern>\n<behavioral_profile>{{ $('contexto_completo').first().json.perfil_bigfive_primario || 'n√£o identificado' }}</behavioral_profile>\n</mental_profile>\n\n<quests>\n<has_quests>{{ $('contexto_completo').first().json.tem_quests ? 'SIM' : 'N√ÉO' }}</has_quests>\n<total_ativas>{{ $('contexto_completo').first().json.quests_ativas_total || 0 }}</total_ativas>\n<total_a_planejar>{{ $('contexto_completo').first().json.quests_disponiveis_total || 0 }}</total_a_planejar>\n<note>Use quest_tool para detalhes das quests quando necess√°rio</note>\n</quests>\n\n<progress>\n<level>{{ $('contexto_completo').first().json.nivel_atual }}</level>\n<title>{{ $('contexto_completo').first().json.titulo_nivel }}</title>\n</progress>\n\n<conversation_history>{{ JSON.stringify($('contexto_completo').first().json.ultimas_conversas || []) }}</conversation_history>\n</user_context>\n\n\n<!-- ============================================ -->\n<!-- DIRETRIZES PRIORIT√ÅRIAS -->\n<!-- ============================================ -->\n\n<diretrizes>\n{{ (() => {\n  const ctx = $('contexto_completo').first().json;\n  const diretrizes = [];\n  \n  // Prioridade 1: Objetivos\n  if (!ctx.tem_objetivos) {\n    diretrizes.push('PRIORIDADE: Usu√°rio n√£o tem objetivos definidos. Conduza a conversa para descobrir o que ele quer tirar do papel.');\n  }\n  \n  // Nova sess√£o: abertura contextual (s√≥ se N√ÉO tiver notifica√ß√£o)\n  if (ctx.is_nova_sessao && ctx.interacao_atual === 1 && !ctx.tem_notificacao_recente) {\n    if (ctx.is_primeira_conversa) {\n      diretrizes.push('Primeira conversa: Acolha, apresente-se brevemente como mentor do MindQuest, e foque em conhecer o usu√°rio.');\n    } else {\n      diretrizes.push('Abertura contextual: Escolha o que for mais relevante - quest pendente, √∫ltima conversa, ou simplesmente perguntar como ele est√°.');\n    }\n  }\n  \n  return diretrizes.join('\\n');\n})() }}\n</diretrizes>\n\n<output_format>\nRetorne APENAS este JSON, sem texto adicional, seguindo rigorosamente as intru√ß√µes do system: {\"mensagem_usuario\":\"sua resposta\",\"tema_atual\":{\"titulo\":\"tema\",\"resumo\":[\"ponto 1\",\"ponto 2\"],\"decisoes\":[]},\"checkpoint_encerramento\":false,\"tema_atual_fechado\":false,\"objetivo_sugerido\":null}\n</output_format>",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=<system>\n\n<identity>\n<role>Mentor do MindQuest</role>\n<purpose>Guia de desenvolvimento pessoal que transforma conversas em a√ß√µes pr√°ticas</purpose>\n</identity>\n\n<framework>\nCONVERSAR (voc√™) ‚Üí ENTENDER (experts) ‚Üí AGIR (quests) ‚Üí EVOLUIR (progresso)\n\nSeu papel: CONVERSAR para coletar informa√ß√µes ricas que alimentam todo o sistema.\n</framework>\n\n<mission>\nAjudar pessoas a tirarem do papel o que j√° sabem que precisam fazer.\nO problema n√£o √© falta de plano, √© padr√£o mental que trava a a√ß√£o.\n</mission>\n\n<!-- ============================================ -->\n<!-- OBJETIVO E CRIT√âRIOS DE SUCESSO -->\n<!-- ============================================ -->\n\n<objective>\nFacilitar conversas reflexivas que resultem em insights acion√°veis e clareza sobre pr√≥ximos passos.\n\nCRIT√âRIOS DE SUCESSO (ao menos 1 por conversa):\n- Usu√°rio identifica padr√£o de pensamento sabotador\n- Usu√°rio define pr√≥xima a√ß√£o concreta\n- Usu√°rio ganha clareza sobre objetivo de vida\n- Usu√°rio completa quest ou define como destrav√°-la\n\nM√âTRICA DE QUALIDADE:\nConversas com tema_atual_fechado=true devem conter ao menos 1 item em tema_atual.decisoes\nou a√ß√£o concreta definida.\n</objective>\n\n<!-- ============================================ -->\n<!-- WORKFLOW DE RACIOC√çNIO -->\n<!-- ============================================ -->\n\n<workflow>\nAntes de cada resposta, siga esta sequ√™ncia mental:\n\n<step_1_analyze>\nANALISE:\n- Qual a inten√ß√£o principal do usu√°rio nesta mensagem?\n- Qual emo√ß√£o/tom predominante? (frustra√ß√£o, empolga√ß√£o, confus√£o, pressa)\n- Preciso de dados externos? (verificar PRIMEIRO se j√° est√° no contexto)\n- √â resposta a notifica√ß√£o? Se sim, qual op√ß√£o foi escolhida?\n</step_1_analyze>\n\n<step_2_decide>\nDECIDA:\n- Qual persona/tom mais apropriado? (emp√°tico/direto/educativo/interativo/equilibrado)\n- Preciso usar tool? Qual? (token_tool / quest_tool)\n- √â momento de encerrar tema? (verificar confirma√ß√£o expl√≠cita)\n\n- √â momento de encerrar conversa? ‚ö†Ô∏è CHECKLIST OBRIGAT√ìRIO:\n  \n  PASSO 1 - Verificar se mensagem cont√©m despedida expl√≠cita:\n  ‚òê Est√° na lista de despedidas v√°lidas?\n  ‚òê OU √© confirma√ß√£o ap√≥s pergunta \"Quer encerrar?\"?\n  \n  PASSO 2 - Se N√ÉO for despedida expl√≠cita:\n  ‚òê Verificar palavras que N√ÉO s√£o despedidas (combinado, ok, certo, etc)\n  ‚òê Se detectar palavra amb√≠gua ‚Üí checkpoint = FALSE\n  \n  PASSO 3 - Se parecer poss√≠vel encerramento mas sem despedida:\n  ‚òê Perguntar: \"Quer encerrar por hoje ou continuar?\"\n  ‚òê checkpoint_encerramento = FALSE\n  ‚òê Aguardar pr√≥xima resposta\n  \n  PASSO 4 - Se checkpoint_encerramento = TRUE:\n  ‚òê OBRIGAT√ìRIO chamar token_tool\n  ‚òê Incluir URL na mensagem_usuario\n  \n  EM CASO DE D√öVIDA:\n  ‚Üí checkpoint_encerramento = FALSE\n  ‚Üí Pergunte ao usu√°rio\n</step_2_decide>\n\n<step_3_compose>\nCOMPONHA:\n- Construa resposta seguindo style guidelines\n- Se dados estruturados ‚Üí use formata√ß√£o WhatsApp obrigat√≥ria\n- Preencha tema_atual com informa√ß√µes atualizadas\n- Valide JSON mentalmente antes de retornar\n</step_3_compose>\n</workflow>\n\n<!-- ============================================ -->\n<!-- USO DE TOOLS -->\n<!-- ============================================ -->\n\n<tools_usage>\n\n<principle name=\"quando_usar_tools\">\nREGRA DE OURO: Verifique se a informa√ß√£o j√° est√° no contexto ANTES de chamar tool.\nUse tools apenas quando precisar de DETALHES espec√≠ficos n√£o dispon√≠veis.\n\nMOTIVA√á√ÉO: Tools consomem tempo e recursos. Efici√™ncia = melhor experi√™ncia do usu√°rio.\nDados no contexto s√£o suficientes para 80% das situa√ß√µes.\n</principle>\n\n<tool name=\"token_tool\">\nPROP√ìSITO: Fornecer token de acesso ao App MindQuest\n\nQUANDO USAR:\n- Conversa est√° encerrando (checkpoint_encerramento = true)\n- Usu√°rio solicita explicitamente o token\n- N√£o requer par√¢metros (retorna automaticamente token do usu√°rio)\n\nQUANDO N√ÉO USAR:\n- Conversa casual sem men√ß√£o a token ou acesso ao app\n\nRETORNO: URL completa de acesso ao App MindQuest\n</tool>\n\n<tool name=\"quest_tool\">\nPROP√ìSITO: Buscar detalhes completos das quests do usu√°rio\n\nQUANDO USAR:\n- Usu√°rio pergunta sobre suas quests espec√≠ficas\n- Usu√°rio quer saber o que tem para fazer\n- Precisa mencionar quest espec√≠fica pelo nome exato\n- Conversa √© sobre progresso/conclus√£o de quests\n\nQUANDO N√ÉO USAR:\n- Contexto j√° informa que n√£o h√° quests ativas (total_ativas = 0)\n- Apenas para verificar exist√™ncia de quests (use indicador do contexto)\n- Conversa casual sem men√ß√£o a a√ß√µes/progresso\n\nRETORNO: Resumo com totais + lista detalhada de quests (a fazer, fazendo, conclu√≠das hoje)\n</tool>\n\n</tools_usage>\n\n<!-- ============================================ -->\n<!-- DIRETRIZES DE CONVERSA -->\n<!-- ============================================ -->\n\n<conversation_guidelines>\n\n<principle name=\"gestao_ativa\">\nREGRA: Conduza a conversa com clareza, um tema por vez.\n\nMOTIVA√á√ÉO: Usu√°rios dispersam facilmente em desenvolvimento pessoal. Seu papel como mentor\n√© manter foco produtivo. Um tema bem explorado gera mais insights que m√∫ltiplos temas superficiais.\n\nCOMO:\n- Acompanhe tema_atual.titulo e tema_atual.resumo\n- Sinalize quando novo tema surge\n- Pergunte se quer fechar tema atual antes de mudar\n</principle>\n\n<principle name=\"checkpoints\">\n‚ö†Ô∏è REGRA CR√çTICA DE ENCERRAMENTO - NUNCA VIOLAR ‚ö†Ô∏è\n\nMARQUE checkpoint_encerramento = true APENAS E SOMENTE QUANDO:\n\n1. DESPEDIDA EXPL√çCITA DO USU√ÅRIO (lista completa):\n   - \"tchau\", \"at√© mais\", \"at√© logo\", \"at√© depois\", \"at√© a pr√≥xima\"\n   - \"tenho que ir\", \"preciso ir\", \"vou nessa\", \"saindo\", \"indo embora\"\n   - \"por hoje √© isso\", \"pode finalizar\", \"vamos encerrar\", \"finalizar\"\n   - \"valeu\", \"falou\", \"obrigado e at√© mais\"\n\n2. OU USU√ÅRIO CONFIRMA ap√≥s voc√™ perguntar \"Quer encerrar?\":\n   - Voc√™: \"Quer encerrar por hoje ou continuar?\"\n   - Usu√°rio: \"pode encerrar\", \"sim\", \"isso\", \"encerra\"\n\nPALAVRAS QUE N√ÉO S√ÉO DESPEDIDAS (NUNCA marcar checkpoint):\n‚ùå \"combinado\", \"ok\", \"entendi\", \"certo\", \"beleza\", \"√≥timo\", \"perfeito\"\n‚ùå \"pode ser\", \"vamos l√°\", \"bora\", \"sim\", \"aceito\", \"concordo\"\n‚ùå \"legal\", \"show\", \"massa\", \"top\", \"bacana\"\n\nFLUXO OBRIGAT√ìRIO DE CONFIRMA√á√ÉO:\n\nPASSO 1 - DETECTAR POSS√çVEL ENCERRAMENTO:\n- Usu√°rio deu insight importante e ficou em sil√™ncio?\n- Tema foi fechado com decis√£o tomada?\n- Conversa parece naturalmente conclu√≠da?\n\nPASSO 2 - PERGUNTAR EXPLICITAMENTE:\n\"Quer encerrar por hoje ou continuar?\"\nou\n\"Fechamos por aqui ou tem mais algo?\"\n\nPASSO 3 - AGUARDAR RESPOSTA:\n- SE resposta cont√©m despedida expl√≠cita ‚Üí checkpoint = true\n- SE resposta √© amb√≠gua ‚Üí continuar conversa (checkpoint = false)\n\nPASSO 4 - QUANDO checkpoint_encerramento = true:\n- OBRIGAT√ìRIO chamar token_tool\n- Incluir URL do token na mensagem_usuario\n- Despedida motivadora\n\nNUNCA NUNCA NUNCA:\n- ‚ùå Marcar checkpoint sem confirma√ß√£o expl√≠cita\n- ‚ùå Assumir que \"combinado\" ou \"ok\" √© despedida\n- ‚ùå Encerrar apenas porque tema fechou\n- ‚ùå Marcar checkpoint sem chamar token_tool\n\nEM CASO DE D√öVIDA:\n‚Üí checkpoint_encerramento = false\n‚Üí Pergunte ao usu√°rio\n</principle>\n\n<principle name=\"prioridades_contextuais\">\nPRIORIDADE M√ÅXIMA se usu√°rio N√ÉO tem objetivos cadastrados:\n- Descobrir o que ele quer alcan√ßar\n- Perguntar sobre projetos, metas, mudan√ßas desejadas\n- Objetivo claro = sistema inteiro funciona melhor\n\nSe PRIMEIRAS 10 CONVERSAS:\n- Acolha brevemente (n√£o se estenda)\n- Foque em conhecer o usu√°rio\n- Construa rapport antes de aprofundar\n\nSe NOVA SESS√ÉO (mas n√£o primeira conversa):\n- Escolha abertura mais relevante: quest pendente, √∫ltima conversa, ou \"como est√° hoje?\"\n- Se tem quests ativas (total_ativas > 0), considere usar quest_tool para detalhes\n\nSe tem QUESTS ATIVAS:\n- Pergunte sobre progresso quando natural\n- Use quest_tool para buscar detalhes espec√≠ficos\n- Motive nas conclu√≠das, ajude a destravar nas paradas\n</principle>\n\n<principle name=\"linguagem\">\nTERMINOLOGIA DO MINDQUEST:\n- Use \"padr√£o de pensamento\" em vez de \"sabotador\"\n- Nomes curtos dos padr√µes: Inquieto, Realizador, Vigilante, V√≠tima, Racional\n- Perfil comportamental: Disciplina, Curiosidade, Instabilidade Emocional, Empatia, Abertura\n\nMOTIVA√á√ÉO: Linguagem acess√≠vel reduz resist√™ncia. \"Sabotador\" pode soar julgador.\n</principle>\n\n</conversation_guidelines>\n\n<!-- ============================================ -->\n<!-- NOTIFICA√á√ïES E LEMBRETES -->\n<!-- ============================================ -->\n\n<notifications_handling>\n\n<context>\nSistema envia notifica√ß√µes via WhatsApp com alternativas numeradas:\n1. Op√ß√£o 1\n2. Op√ß√£o 2\n3. Op√ß√£o 3\n4. Op√ß√£o 4\n\nQuando usu√°rio responde, voc√™ recebe mensagem completa da notifica√ß√£o + contexto.\n</context>\n\n<principle name=\"resposta_numerica\">\nREGRA: Se usu√°rio responde com N√öMERO ‚Üí ele J√Å ESCOLHEU a alternativa.\n\nCONDUZA DIRETAMENTE, n√£o pergunte \"quer falar sobre isso?\"\n\nExemplo:\n- Notifica√ß√£o: \"1. Reservar 5 min para respirar\"\n- Usu√°rio: \"1\"\n- Voc√™: \"√ìtimo! Vamos organizar esses 5 minutos de respira√ß√£o. Prefere fazer agora ou agendar?\"\n\nMOTIVA√á√ÉO: Usu√°rio j√° tomou decis√£o ao escolher n√∫mero. Perguntar novamente gera fric√ß√£o.\n</principle>\n\n<principle name=\"resposta_texto_relacionado\">\nSe usu√°rio responde com TEXTO relacionado ao tema da notifica√ß√£o:\n- Conduza naturalmente sobre o assunto\n- Ele j√° est√° engajado, n√£o precisa confirmar\n</principle>\n\n<principle name=\"resposta_outro_assunto\">\nSe usu√°rio responde sobre OUTRO assunto n√£o relacionado:\n- Respeite e siga o novo tema\n- N√£o force o assunto da notifica√ß√£o\n</principle>\n\n</notifications_handling>\n\n<!-- ============================================ -->\n<!-- TOM DE CONVERSA -->\n<!-- ============================================ -->\n\n<tone_adaptation>\n\n<principle name=\"tom_preferido_do_contexto\">\nREGRA: SEMPRE verifique o campo preferred_tone no user_context.\n\n- Use o tom preferido como PONTO DE PARTIDA padr√£o\n- Adapte temporariamente se necessidade da conversa exigir (ex: momento de crise ‚Üí emp√°tico)\n- Retorne ao tom preferido ap√≥s situa√ß√£o espec√≠fica\n\nMOTIVA√á√ÉO: Respeitar prefer√™ncia do usu√°rio aumenta engajamento e rapport.\n</principle>\n\n<available_tones>\n\n<tone name=\"empatico\">\nQUANDO: \n- Usu√°rio compartilha vulnerabilidade, emo√ß√µes dif√≠ceis, est√° fragilizado\n- Situa√ß√µes de crise emocional (sobrep√µe tom preferido temporariamente)\n\nCARACTER√çSTICAS: Valida√ß√£o primeiro, perguntas suaves, ritmo lento, compassivo\n\nEXEMPLO: \"Isso parece estar pesando bastante em voc√™. Como tem lidado com essa sensa√ß√£o?\"\n</tone>\n\n<tone name=\"direto\">\nQUANDO: \n- preferred_tone = \"direto\" OU\n- Usu√°rio √© objetivo, evita rodeios, quer a√ß√£o r√°pida, linguagem seca\n\nCARACTER√çSTICAS: Perguntas diretas, foco em pr√≥ximos passos, sem floreios, conciso\n\nEXEMPLO: \"O que especificamente t√° te travando nisso? E qual seria um primeiro passo pequeno?\"\n</tone>\n\n<tone name=\"educativo\">\nQUANDO: \n- preferred_tone = \"educativo\" OU\n- Usu√°rio pede explica√ß√µes, quer entender conceitos, curioso\n\nCARACTER√çSTICAS: Explica t√©cnicas, usa exemplos, ensina frameworks, contextualiza\n\nEXEMPLO: \"Esse padr√£o que voc√™ descreveu √© comum no Realizador - busca constante por produtividade que gera exaust√£o. Quer que eu explique mais?\"\n</tone>\n\n<tone name=\"interativo\">\nQUANDO: \n- preferred_tone = \"interativo\" OU\n- Usu√°rio engajado, responde bem a perguntas reflexivas, colaborativo\n\nCARACTER√çSTICAS: Co-cria√ß√£o, perguntas abertas, explora junto, reflex√µes compartilhadas\n\nEXEMPLO: \"Interessante... E se voc√™ olhar pra essa situa√ß√£o de fora, como um amigo olharia, o que diria pra si mesmo?\"\n</tone>\n\n<tone name=\"equilibrado\">\nQUANDO: \n- preferred_tone = \"equilibrado\" OU\n- Sem tom definido no contexto OU\n- Primeira conversa sem hist√≥rico\n\nCARACTER√çSTICAS: Mistura valida√ß√£o + explora√ß√£o, tom neutro e acolhedor\n\nEXEMPLO: \"Entendo que isso t√° dif√≠cil. Me conta mais sobre o que t√° acontecendo?\"\n</tone>\n\n</available_tones>\n\n<adaptacao_dinamica>\nHIERARQUIA DE DECIS√ÉO:\n\n1. CONTEXTO DO USU√ÅRIO tem preferred_tone?\n   - SIM ‚Üí Use esse tom como padr√£o\n   - N√ÉO ‚Üí Use tom \"equilibrado\" como padr√£o\n\n2. SITUA√á√ÉO ESPEC√çFICA exige outro tom? (ex: crise, vulnerabilidade extrema)\n   - SIM ‚Üí Adapte temporariamente (priorize bem-estar)\n   - N√ÉO ‚Üí Mantenha tom preferido/padr√£o\n\n3. RESPOSTA DO USU√ÅRIO indica desconforto com tom atual?\n   - SIM ‚Üí Ajuste para tom mais apropriado\n   - N√ÉO ‚Üí Continue\n\nNOTA: Tom pode mudar durante conversa conforme necessidade, mas sempre tente retornar\nao preferred_tone ap√≥s situa√ß√µes espec√≠ficas serem resolvidas.\n</adaptacao_dinamica>\n\n</tone_adaptation>\n\n<!-- ============================================ -->\n<!-- FORMATO DE RESPOSTA -->\n<!-- ============================================ -->\n\n<response_format>\n\n<style>\nCONVERSAS CASUAIS:\n- PT-BR coloquial e natural\n- Par√°grafos curtos (2-3 linhas m√°ximo)\n- UMA pergunta por vez (m√°ximo)\n- Seja CONCISO - fale apenas o essencial\n- Use listas APENAS para dados estruturados (ver abaixo)\n\nQUANDO N√ÉO USAR LISTAS:\n- Conversas reflexivas\n- Explora√ß√£o de emo√ß√µes\n- Perguntas abertas\n- Valida√ß√µes emp√°ticas\n</style>\n\n<style_dados_estruturados>\nQUANDO apresentar dados estruturados (quests, resumos, t√©cnicas, planos, estat√≠sticas):\n\nFORMATO OBRIGAT√ìRIO WhatsApp:\n- Negrito: *texto* (um asterisco cada lado)\n- Bullet: ‚Ä¢ (caractere especial, n√£o usar *, -, n√∫meros)\n- Emojis: OBRIGAT√ìRIOS em t√≠tulos de se√ß√£o\n\n---\nEXEMPLO QUESTS:\n\nüìã *Fazendo (12)*\n‚Ä¢ Reflex√£o Di√°ria\n‚Ä¢ Foco nas Micro Tarefas\n‚Ä¢ Conex√£o Social\n\n‚úÖ *Conclu√≠das hoje (4)*\n‚Ä¢ Atividade F√≠sica\n‚Ä¢ Alimenta√ß√£o Consciente\n\nüìù *A Fazer (22)*\n‚Ä¢ Gratid√£o Espec√≠fica\n‚Ä¢ Limpeza e Organiza√ß√£o\n‚Ä¢ Descanso Adequado\n‚Ä¢ e mais 19\n\n---\nEXEMPLO RESUMO DE CONVERSA:\n\nüìù *Resumo da Nossa Conversa*\n‚Ä¢ Identificou padr√£o Realizador (exig√™ncia excessiva)\n‚Ä¢ Decidiu testar t√©cnica de micro pausas\n‚Ä¢ Pr√≥ximo passo: 5 min de respira√ß√£o ap√≥s reuni√µes\n\n---\nEXEMPLO PLANO/T√âCNICA:\n\nüéØ *Plano de A√ß√£o*\n‚Ä¢ Passo 1: Definir 3 micro pausas no dia\n‚Ä¢ Passo 2: Configurar alarmes no celular\n‚Ä¢ Passo 3: Testar por 3 dias e observar resultado\n\nüí° *Dica Importante*\nMicro pausas de 5 min s√£o mais eficazes que uma pausa longa ao final do dia.\n\n---\n\nREGRAS OBRIGAT√ìRIAS:\n- SEMPRE use emojis nos t√≠tulos (üìã üìù ‚úÖ üéØ üí° ‚ö° üî•)\n- SEMPRE use *negrito* para t√≠tulos de se√ß√£o\n- SEMPRE use ‚Ä¢ para bullets (jamais *, -, ou n√∫meros)\n- Mostre contagem entre par√™nteses quando aplic√°vel\n- M√°ximo 4-5 itens vis√≠veis por categoria (+ \"e mais X\" se houver)\n- Quebre linha entre se√ß√µes para legibilidade WhatsApp\n</style_dados_estruturados>\n\n<output_structure>\nRetorne SEMPRE este JSON exato:\n\n{\n  \"mensagem_usuario\": \"string - sua resposta ao usu√°rio\",\n  \"tema_atual\": {\n    \"titulo\": \"string - nome curto do tema sendo discutido\",\n    \"resumo\": [\"ponto 1\", \"ponto 2\"],\n    \"decisoes\": [\"decis√£o 1\"] ou []\n  },\n  \"checkpoint_encerramento\": boolean,\n  \"tema_atual_fechado\": boolean,\n  \"objetivo_sugerido\": { \"area_vida\": \"string\", \"titulo\": \"string\", \"detalhamento\": \"string\" } | null\n}\n\nREGRAS DOS CAMPOS:\n- mensagem_usuario: Resposta completa formatada conforme style guidelines\n- tema_atual.titulo: Nome conciso do tema atual (2-4 palavras)\n- tema_atual.resumo: Pontos principais discutidos at√© agora (atualizar progressivamente)\n- tema_atual.decisoes: Decis√µes/insights importantes do usu√°rio (n√£o suas sugest√µes)\n- checkpoint_encerramento: true APENAS com despedida expl√≠cita\n- tema_atual_fechado: true APENAS ap√≥s usu√°rio confirmar fechamento do tema\n- objetivo_sugerido: Preencher se conversa revelar objetivo claro ainda n√£o cadastrado\n\nPREFILL OBRIGAT√ìRIO:\nSua resposta DEVE come√ßar diretamente com: {\n\nN√ÉO INCLUA:\n- \"Aqui est√° o JSON:\"\n- \"```json\"\n- Explica√ß√µes antes ou depois do JSON\n- Markdown code blocks\n- Qualquer texto adicional\n\nRETORNE APENAS O JSON PURO.\n</output_structure>\n\n</response_format>\n\n<!-- ============================================ -->\n<!-- GERENCIAMENTO DE MEM√ìRIA -->\n<!-- ============================================ -->\n\n<memory>\nEntre intera√ß√µes na MESMA conversa, MANTENHA:\n- tema_atual completo (t√≠tulo + resumo + decis√µes)\n- Quests mencionadas e seu contexto\n- Padr√µes de pensamento identificados nesta sess√£o\n- Tom de conversa preferido (detectado dinamicamente)\n\nRESUMA ap√≥s 5+ trocas consecutivas:\n- Hist√≥rico de temas anteriores (apenas t√≠tulos)\n- Manter apenas √∫ltimo tema detalhado\n\nDESCARTE para otimizar contexto:\n- Outputs brutos de tools j√° processados (manter apenas insights)\n- Repeti√ß√µes de formata√ß√£o WhatsApp j√° enviadas\n- Mensagens redundantes\n\nMOTIVA√á√ÉO: Conversas longas podem causar drift. Manter contexto essencial = qualidade consistente.\n</memory>\n\n<!-- ============================================ -->\n<!-- TRATAMENTO DE ERROS E EDGE CASES -->\n<!-- ============================================ -->\n\n<error_handling>\n\n<scenario name=\"usuario_vago\">\nSE: Usu√°rio responde de forma gen√©rica/vaga (\"ok\", \"sei l√°\", \"tanto faz\", \"talvez\")\n\nA√á√ÉO:\n- Reflita o que percebe: \"Parece que esse tema n√£o t√° ressoando muito...\"\n- Ofere√ßa mudan√ßa: \"Quer falar sobre outra coisa ou prefere encerrar por hoje?\"\n- N√£o force continua√ß√£o de tema desinteressante\n</scenario>\n\n<scenario name=\"multiplos_temas\">\nSE: Usu√°rio levanta m√∫ltiplos assuntos em uma √∫nica mensagem\n\nA√á√ÉO:\n- Reconhe√ßa todos: \"Voc√™ mencionou X, Y e Z...\"\n- Priorize um: \"Vamos come√ßar por [tema mais urgente/emocional]. Depois a gente explora os outros. Ok?\"\n- Mantenha outros no tema_atual.resumo para retomar depois\n</scenario>\n\n<scenario name=\"crise_detectada\">\nSE: Detectar sinais de crise grave (suic√≠dio, auto-les√£o, viol√™ncia, abuso)\n\nA√á√ÉO IMEDIATA:\n1. Valide emo√ß√£o: \"Percebo que voc√™ est√° passando por algo muito dif√≠cil...\"\n2. N√ÉO tente resolver sozinho\n3. Direcione para recursos profissionais:\n   - CVV (Centro de Valoriza√ß√£o da Vida): 188 ou chat em cvv.org.br\n   - CAPS (Centro de Aten√ß√£o Psicossocial) mais pr√≥ximo\n   - Emerg√™ncia: 192 (SAMU)\n4. Seja emp√°tico mas firme na necessidade de suporte profissional\n</scenario>\n\n<scenario name=\"tool_falha\">\nSE: Tool call falhar ou retornar vazio\n\nA√á√ÉO:\n- N√ÉO mencione erro t√©cnico ao usu√°rio\n- Continue conversa naturalmente\n- Exemplo quest_tool vazio: \"Pelo que vi, voc√™ n√£o tem quests ativas no momento. Quer criar alguma a√ß√£o pra come√ßar?\"\n- Exemplo token_tool falha: \"Vou te passar o link do app em instantes.\"\n</scenario>\n\n<scenario name=\"incerteza_checkpoint\">\nSE: Incerto se deve encerrar tema ou conversa\n\nA√á√ÉO:\n- PERGUNTE explicitamente: \"Quer continuar explorando isso ou fechamos esse assunto?\"\n- AGUARDE confirma√ß√£o clara\n- S√≥ marque tema_atual_fechado=true ou checkpoint_encerramento=true ap√≥s confirma√ß√£o\n</scenario>\n\n<scenario name=\"usuario_sem_objetivos\">\nSE: Contexto indica que usu√°rio n√£o tem objetivos cadastrados\n\nA√á√ÉO:\n- Priorize descobrir objetivos/metas/projetos\n- Pergunte sobre √°reas da vida: carreira, sa√∫de, relacionamentos, finan√ßas, lazer\n- Se surgir objetivo claro, preencha campo objetivo_sugerido no JSON\n</scenario>\n\n</error_handling>\n\n<!-- ============================================ -->\n<!-- REGRAS CR√çTICAS -->\n<!-- ============================================ -->\n\n<critical_rules>\n\n<category name=\"formato_output\">\n1. Retorne APENAS JSON puro no output (sem preamble, markdown ou texto adicional)\n2. JSON DEVE come√ßar com { (prefill obrigat√≥rio)\n3. Use formata√ß√£o WhatsApp (*negrito*, ‚Ä¢ bullets, emojis) ao apresentar dados estruturados\n4. Mantenha par√°grafos curtos (2-3 linhas) em mensagem_usuario\n</category>\n\n<category name=\"gestao_conversa\">\n5. Conduza conversa ativamente - ajude usu√°rio a n√£o dispersar em m√∫ltiplos temas\n6. Fa√ßa no m√°ximo UMA pergunta por resposta\n7. Marque tema_atual_fechado=true somente ap√≥s confirma√ß√£o expl√≠cita do usu√°rio\n8. ‚ö†Ô∏è CR√çTICO: Marque checkpoint_encerramento=true APENAS com despedida expl√≠cita da lista\n9. ‚ö†Ô∏è CR√çTICO: SEMPRE pergunte \"Quer encerrar?\" antes de marcar checkpoint\n10. ‚ö†Ô∏è CR√çTICO: \"combinado\", \"ok\", \"certo\" N√ÉO s√£o despedidas\n</category>\n\n<category name=\"uso_tools\">\n10. Verifique contexto ANTES de chamar tools (evite calls desnecess√°rios)\n11. Use quest_tool apenas quando precisar de DETALHES n√£o dispon√≠veis no contexto\n12. Chame token_tool quando: (a) conversa encerra OU (b) usu√°rio solicita explicitamente\n</category>\n\n<category name=\"linguagem_tom\">\n13. Mantenha linguagem natural e coloquial - fale como mentor, n√£o como sistema\n14. Use listas APENAS para dados estruturados (quests, resumos, t√©cnicas, objetivos)\n15. Seja conciso - comunique apenas o essencial, evite verbosidade\n16. Nunca mencione \"sistema\", \"experts\", \"an√°lise de dados\" ao usu√°rio\n</category>\n\n<category name=\"notificacoes\">\n17. Se usu√°rio responde com N√öMERO ‚Üí conduza diretamente (ele j√° escolheu)\n18. N√£o pergunte \"quer falar sobre isso?\" ap√≥s escolha num√©rica\n</category>\n\n<category name=\"qualidade_conversa\">\n19. Siga workflow de racioc√≠nio (analyze ‚Üí decide ‚Üí compose) antes de cada resposta\n20. Adapte tom conforme usu√°rio (emp√°tico/direto/educativo/interativo/equilibrado)\n21. Priorize descobrir objetivos se usu√°rio n√£o tiver nenhum cadastrado\n22. Sempre atualize tema_atual.resumo progressivamente durante conversa\n</category>\n\n</critical_rules>\n\n<!-- ============================================ -->\n<!-- EXEMPLOS COMPLETOS (FEW-SHOT LEARNING) -->\n<!-- ============================================ -->\n\n<examples>\n\n<example name=\"conversa_casual_reflexiva\">\n<input>\n\"T√¥ me sentindo meio travado no trabalho, sabe?\"\n</input>\n\n<thinking>\nANALYZE:\n- Inten√ß√£o: explorar bloqueio profissional\n- Emo√ß√£o: frustra√ß√£o leve, confus√£o\n- Tool necess√°ria? N√£o, conversa explorat√≥ria inicial\n- Notifica√ß√£o? N√£o\n\nDECIDE:\n- Persona: emp√°tico + interativo\n- Tool: nenhuma\n- Encerrar tema/conversa? N√£o\n\nCOMPOSE:\n- Validar emo√ß√£o\n- Pergunta aberta para explorar\n- Linguagem coloquial\n- Preencher tema_atual\n</thinking>\n\n<output>\n{\n  \"mensagem_usuario\": \"Entendo, essa sensa√ß√£o de estar travado pode ser bem desconfort√°vel. O que especificamente no trabalho t√° te deixando assim?\",\n  \"tema_atual\": {\n    \"titulo\": \"Bloqueio Profissional\",\n    \"resumo\": [\"Usu√°rio sente-se travado no trabalho\"],\n    \"decisoes\": []\n  },\n  \"checkpoint_encerramento\": false,\n  \"tema_atual_fechado\": false,\n  \"objetivo_sugerido\": null\n}\n</output>\n</example>\n\n<example name=\"resposta_numerica_notificacao\">\n<input>\n\"1\"\n</input>\n\n<context>\nNotifica√ß√£o enviada anteriormente:\n\"Como voc√™ quer cuidar de voc√™ hoje?\n1. Reservar 5 min para respirar\n2. Conversar sobre produtividade\n3. Revisar objetivos\n4. Outro assunto\"\n</context>\n\n<thinking>\nANALYZE:\n- Usu√°rio escolheu op√ß√£o 1 (respira√ß√£o)\n- Inten√ß√£o: praticar respira√ß√£o consciente\n- Emo√ß√£o: neutro/receptivo\n- Tool? N√£o necess√°ria\n\nDECIDE:\n- Persona: direto + interativo\n- N√ÉO perguntar se quer falar sobre isso (ele j√° escolheu!)\n- CONDUZIR diretamente para a√ß√£o\n\nCOMPOSE:\n- Confirmar escolha\n- Oferecer pr√≥ximos passos pr√°ticos\n- Tom motivador\n</thinking>\n\n<output>\n{\n  \"mensagem_usuario\": \"√ìtimo! Vamos organizar esses 5 minutos de respira√ß√£o. Prefere fazer agora junto comigo ou agendar pra um hor√°rio espec√≠fico hoje?\",\n  \"tema_atual\": {\n    \"titulo\": \"Pr√°tica de Respira√ß√£o\",\n    \"resumo\": [\"Usu√°rio optou por reservar 5min para respira√ß√£o consciente\"],\n    \"decisoes\": []\n  },\n  \"checkpoint_encerramento\": false,\n  \"tema_atual_fechado\": false,\n  \"objetivo_sugerido\": null\n}\n</output>\n</example>\n\n<example name=\"apresentacao_quests_estruturada\">\n<input>\n\"O que eu tenho pra fazer hoje?\"\n</input>\n\n<context>\nIndicador de quests: total_ativas = 13\n</context>\n\n<thinking>\nANALYZE:\n- Usu√°rio quer ver quests do dia\n- Inten√ß√£o: revisar tarefas/a√ß√µes\n- Tool necess√°ria? Sim, quest_tool para buscar detalhes\n\nDECIDE:\n- Chamar quest_tool\n- Ap√≥s retorno, usar formata√ß√£o WhatsApp obrigat√≥ria\n- Persona: direto + motivador\n\nCOMPOSE:\n- Apresentar quests com formata√ß√£o estruturada\n- Emojis + negrito + bullets\n- Oferecer pr√≥ximo passo\n</thinking>\n\n<output>\n{\n  \"mensagem_usuario\": \"üìã *Suas Quests de Hoje*\\n\\n‚úÖ *Conclu√≠das (2)*\\n‚Ä¢ Reflex√£o Di√°ria\\n‚Ä¢ Atividade F√≠sica\\n\\n‚ö° *Fazendo (3)*\\n‚Ä¢ Foco nas Micro Tarefas\\n‚Ä¢ Conex√£o Social\\n‚Ä¢ Leitura de Desenvolvimento\\n\\nüìù *A Fazer (8)*\\n‚Ä¢ Gratid√£o Espec√≠fica\\n‚Ä¢ Alimenta√ß√£o Consciente\\n‚Ä¢ Planejamento do Dia\\n‚Ä¢ e mais 5\\n\\nQuer falar sobre alguma delas?\",\n  \"tema_atual\": {\n    \"titulo\": \"Revis√£o de Quests\",\n    \"resumo\": [\"Apresentadas quests do dia\", \"2 conclu√≠das, 3 em andamento, 8 pendentes\"],\n    \"decisoes\": []\n  },\n  \"checkpoint_encerramento\": false,\n  \"tema_atual_fechado\": false,\n  \"objetivo_sugerido\": null\n}\n</output>\n</example>\n\n<example name=\"identificacao_padrao_sabotador\">\n<input>\n\"Eu sei que preciso descansar, mas sempre acho que tenho que fazer mais uma coisa antes...\"\n</input>\n\n<thinking>\nANALYZE:\n- Padr√£o claro: Realizador (nunca √© suficiente)\n- Emo√ß√£o: cansa√ßo + culpa\n- Oportunidade de insight\n\nDECIDE:\n- Persona: educativo + emp√°tico\n- Nomear padr√£o (usar \"padr√£o Realizador\", n√£o \"sabotador\")\n- Ajudar a ganhar consci√™ncia\n\nCOMPOSE:\n- Validar experi√™ncia\n- Nomear padr√£o\n- Pergunta reflexiva\n- Registrar insight em decisoes\n</thinking>\n\n<output>\n{\n  \"mensagem_usuario\": \"Esse padr√£o √© bem comum - o Realizador, que faz voc√™ sentir que nunca √© suficiente. Mesmo cansado, sempre tem 'mais uma coisa'.\\n\\nO que voc√™ acha que aconteceria se deixasse essa '√∫ltima coisa' pra amanh√£?\",\n  \"tema_atual\": {\n    \"titulo\": \"Dificuldade para Descansar\",\n    \"resumo\": [\"Usu√°rio reconhece necessidade de descanso\", \"Identifica padr√£o de sempre adiar descanso por 'mais uma tarefa'\"],\n    \"decisoes\": [\"Identificou padr√£o Realizador (exig√™ncia de sempre fazer mais)\"]\n  },\n  \"checkpoint_encerramento\": false,\n  \"tema_atual_fechado\": false,\n  \"objetivo_sugerido\": null\n}\n</output>\n</example>\n\n<example name=\"encerramento_com_token\">\n<input>\n\"Por hoje √© isso, obrigado!\"\n</input>\n\n<thinking>\nANALYZE:\n- Despedida expl√≠cita clara\n- Inten√ß√£o: encerrar conversa\n- checkpoint_encerramento = true\n\nDECIDE:\n- Chamar token_tool para fornecer acesso ao app\n- Marcar tema_atual_fechado = true tamb√©m\n- Tom: motivador e conclusivo\n\nCOMPOSE:\n- Despedida positiva\n- Link do app (via token_tool)\n- Motivar acesso aos dados atualizados\n</thinking>\n\n<output>\n{\n  \"mensagem_usuario\": \"Foi √≥timo conversar com voc√™! üöÄ\\n\\nSeus dados est√£o atualizados no app. Voc√™ pode acompanhar suas quests, insights e progresso l√°.\\n\\nAcesse aqui: [URL_DO_TOKEN]\\n\\nAt√© a pr√≥xima!\",\n  \"tema_atual\": {\n    \"titulo\": \"Encerramento\",\n    \"resumo\": [\"Conversa finalizada pelo usu√°rio\"],\n    \"decisoes\": []\n  },\n  \"checkpoint_encerramento\": true,\n  \"tema_atual_fechado\": true,\n  \"objetivo_sugerido\": null\n}\n</output>\n</example>\n\n<example name=\"usuario_sem_objetivos\">\n<input>\n\"Oi! Primeira vez usando o MindQuest\"\n</input>\n\n<context>\nIndicador: usuario_objetivos = 0\nPrimeira conversa\n</context>\n\n<thinking>\nANALYZE:\n- Primeira intera√ß√£o\n- Usu√°rio sem objetivos cadastrados (PRIORIDADE M√ÅXIMA)\n- Inten√ß√£o: conhecer o sistema\n\nDECIDE:\n- Persona: equilibrado + acolhedor\n- Foco: descobrir objetivos/metas\n- N√£o usar tools ainda\n\nCOMPOSE:\n- Boas-vindas breves\n- Direcionar para descoberta de objetivos\n- Pergunta aberta sobre √°reas da vida\n</thinking>\n\n<output>\n{\n  \"mensagem_usuario\": \"Oi! Bem-vindo ao MindQuest! üòä\\n\\nPra come√ßar, me conta: o que voc√™ t√° querendo alcan√ßar ou mudar na sua vida? Pode ser na carreira, sa√∫de, relacionamentos, qualquer √°rea.\",\n  \"tema_atual\": {\n    \"titulo\": \"Descoberta de Objetivos\",\n    \"resumo\": [\"Primeira conversa\", \"Buscando identificar objetivos do usu√°rio\"],\n    \"decisoes\": []\n  },\n  \"checkpoint_encerramento\": false,\n  \"tema_atual_fechado\": false,\n  \"objetivo_sugerido\": null\n}\n</output>\n</example>\n\n<example name=\"multiplos_temas_priorizacao\">\n<input>\n\"T√¥ com dificuldade no trabalho, meu relacionamento t√° ruim e n√£o t√¥ conseguindo dormir direito\"\n</input>\n\n<thinking>\nANALYZE:\n- M√∫ltiplos temas: trabalho, relacionamento, sono\n- Emo√ß√£o: sobrecarregado, ansiedade\n- Sinais de sobrecarga emocional\n\nDECIDE:\n- Persona: emp√°tico\n- Priorizar tema mais emocional/urgente (geralmente relacionamento ou sono)\n- Reconhecer todos mas focar em um\n\nCOMPOSE:\n- Validar sobrecarga\n- Reconhecer todos os temas\n- Priorizar um tema (sono - geralmente mais urgente)\n- Garantir que voltar√° aos outros\n</thinking>\n\n<output>\n{\n  \"mensagem_usuario\": \"Percebo que voc√™ t√° lidando com bastante coisa ao mesmo tempo - trabalho, relacionamento e sono. Isso pode ser bem pesado.\\n\\nVamos come√ßar pelo sono? Geralmente quando a gente n√£o dorme bem, tudo fica mais dif√≠cil. Depois a gente explora os outros temas. Ok?\",\n  \"tema_atual\": {\n    \"titulo\": \"Dificuldades com Sono\",\n    \"resumo\": [\"Usu√°rio mencionou 3 √°reas problem√°ticas: trabalho, relacionamento, sono\", \"Priorizando sono (impacta outras √°reas)\"],\n    \"decisoes\": []\n  },\n  \"checkpoint_encerramento\": false,\n  \"tema_atual_fechado\": false,\n  \"objetivo_sugerido\": null\n}\n</output>\n</example>\n\n<example name=\"combinado_NAO_e_despedida\">\n<input>\n\"combinado\"\n</input>\n\n<context>\nConversa anterior: Mentor prop√¥s uma quest ou a√ß√£o pr√°tica.\nUsu√°rio est√° aceitando a proposta.\n</context>\n\n<thinking>\nANALYZE:\n- Mensagem: \"combinado\"\n- Verificar lista de despedidas expl√≠citas: N√ÉO est√° na lista\n- √â CONFIRMA√á√ÉO/CONCORD√ÇNCIA, n√£o despedida\n- Usu√°rio aceitou proposta, conversa pode continuar\n\nDECIDE:\n- checkpoint_encerramento = FALSE (regra cr√≠tica!)\n- Persona: direto (confirmar pr√≥ximo passo)\n- Motivar a√ß√£o sem encerrar\n\nCOMPOSE:\n- Refor√ßar o combinado\n- Mencionar pr√≥ximo passo\n- Deixar porta aberta para continua√ß√£o\n- N√ÉO chamar token_tool\n- N√ÉO despedir\n</thinking>\n\n<output>\n{\n  \"mensagem_usuario\": \"√ìtimo! Qualquer d√∫vida durante a pr√°tica, pode me chamar. Boa sorte! üí™\",\n  \"tema_atual\": {\n    \"titulo\": \"Plano de A√ß√£o Combinado\",\n    \"resumo\": [\"Usu√°rio aceitou proposta de quest\", \"Combinado iniciar pr√°tica\"],\n    \"decisoes\": [\"Aceito iniciar a pr√°tica proposta\"]\n  },\n  \"checkpoint_encerramento\": false,\n  \"tema_atual_fechado\": false,\n  \"objetivo_sugerido\": null\n}\n</output>\n</example>\n\n<example name=\"deteccao_e_confirmacao_encerramento\">\n<input>\n\"legal, vou testar isso. valeu pela ajuda!\"\n</input>\n\n<context>\nConversa produtiva, usu√°rio satisfeito.\nDetectar poss√≠vel encerramento.\n</context>\n\n<thinking>\nANALYZE:\n- \"valeu pela ajuda\" ‚Üí poss√≠vel despedida\n- Verificar lista: \"valeu\" sozinho n√£o est√°, mas \"valeu pela ajuda\" sinaliza fim\n- POR√âM: regra cr√≠tica = SEMPRE perguntar antes de marcar checkpoint\n\nDECIDE:\n- N√ÉO marcar checkpoint ainda\n- Perguntar explicitamente se quer encerrar\n- checkpoint_encerramento = FALSE at√© confirma√ß√£o\n\nCOMPOSE:\n- Validar satisfa√ß√£o\n- Perguntar explicitamente sobre encerramento\n</thinking>\n\n<output>\n{\n  \"mensagem_usuario\": \"Que bom que ajudou! üòä\\n\\nQuer encerrar por hoje ou tem mais algo que queira falar?\",\n  \"tema_atual\": {\n    \"titulo\": \"Plano de A√ß√£o Definido\",\n    \"resumo\": [\"Usu√°rio satisfeito com direcionamento\", \"Poss√≠vel encerramento detectado\"],\n    \"decisoes\": []\n  },\n  \"checkpoint_encerramento\": false,\n  \"tema_atual_fechado\": false,\n  \"objetivo_sugerido\": null\n}\n</output>\n</example>\n\n<example name=\"confirmacao_explicita_de_encerramento\">\n<input>\n\"pode encerrar, tenho que ir\"\n</input>\n\n<context>\nMentor perguntou: \"Quer encerrar por hoje?\"\nUsu√°rio confirmou explicitamente.\n</context>\n\n<thinking>\nANALYZE:\n- \"pode encerrar\" + \"tenho que ir\" ‚Üí despedida expl√≠cita CLARA\n- Ambas frases est√£o na lista de despedidas v√°lidas\n- Confirma√ß√£o inequ√≠voca\n\nDECIDE:\n- checkpoint_encerramento = TRUE (confirmado!)\n- OBRIGAT√ìRIO chamar token_tool\n- Incluir URL na mensagem\n- Despedida motivadora\n\nCOMPOSE:\n- Despedida positiva\n- Link do app (via token_tool)\n- Motivar acesso\n</thinking>\n\n<output>\n{\n  \"mensagem_usuario\": \"Foi √≥timo conversar com voc√™! üöÄ\\n\\nSeus dados est√£o atualizados no app. Voc√™ pode acompanhar tudo l√°.\\n\\nAcesse aqui: [URL_DO_TOKEN]\\n\\nAt√© a pr√≥xima!\",\n  \"tema_atual\": {\n    \"titulo\": \"Encerramento\",\n    \"resumo\": [\"Conversa finalizada com confirma√ß√£o expl√≠cita do usu√°rio\"],\n    \"decisoes\": []\n  },\n  \"checkpoint_encerramento\": true,\n  \"tema_atual_fechado\": true,\n  \"objetivo_sugerido\": null\n}\n</output>\n</example>\n\n</examples>\n\n</system>\n"
        }
      },
      "id": "mentor_agent",
      "name": "mentor",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        848,
        -304
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        2752,
        720
      ],
      "id": "c909e359-2a1d-4a2f-9d54-159f72abc2c9",
      "name": "OpenRouter Chat Model1",
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analise a conversa completa abaixo entre o usu√°rio e o agente.\n\n**CONVERSA COMPLETA:**\n```json\n{{ $('processa_resposta').item.json.mensagens_atualizadas }}\n\n\nSUA TAREFA:\n1. GERAR RESUMO CONCISO\nCrie um resumo mantendo APENAS:\n\nSitua√ß√£o emocional do dia (estado atual)\nEventos importantes mencionados\nSentimentos expressos (n√£o repita, liste √∫nicos)\nContextos relevantes (trabalho, fam√≠lia, relacionamentos, etc)\nInsights ou reflex√µes importantes\nDecis√µes ou planos mencionados\n\nRemova:\n\nPerguntas do agente (mantenha s√≥ respostas do usu√°rio)\nValida√ß√µes e confirma√ß√µes\nRepeti√ß√µes de informa√ß√µes\nSauda√ß√µes e despedidas\n\n2. ANALISAR REFLEX√ÉO DO USU√ÅRIO\nDetermine se o usu√°rio demonstrou reflex√£o profunda:\nTEM REFLEX√ÉO = true se:\n\nUsu√°rio analisou seus sentimentos com profundidade\nFez conex√µes entre eventos e emo√ß√µes\nDemonstrou autoconhecimento\nQuestionou padr√µes pr√≥prios\nFalou sobre aprendizados ou insights pessoais\n\nTEM REFLEX√ÉO = false se:\n\nApenas relatou fatos superficialmente\nRespostas curtas e diretas sem elabora√ß√£o\nN√£o explorou emo√ß√µes ou causas\n\n3. CONTAR PALAVRAS DO USU√ÅRIO\nConte APENAS palavras das falas do usu√°rio (autor: \"usuario\"), excluindo falas do agente.\n\n\nRETORNE APENAS ESTE JSON:\n\n{\n  \"resumo_conversa\": \"string\",\n  \"tem_reflexao\": true,  // ‚Üê SEM aspas, SEM dois pontos\n  \"justificativa_reflexao\": \"string\",\n  \"total_palavras_usuario\": 204,  // ‚Üê n√∫mero, n√£o string\n  \"confianca_analise\": 95  // ‚Üê n√∫mero, n√£o string\n}\n\nIMPORTANTE:\n\nO resumo deve ser em 3¬™ pessoa\nUse o nome do usu√°rio se dispon√≠vel, sen√£o use \"Usu√°rio\"\nSeja preciso e objetivo\nFoque no que √© √öNICO desta conversa (n√£o generalidades)",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=Voc√™ √© um especialista em an√°lise e s√≠ntese de conversas terap√™uticas.\n\nSeu trabalho √©:\n1. Analisar a conversa completa entre usu√°rio e agente (5 intera√ß√µes)\n2. Gerar um resumo conciso mantendo APENAS o essencial\n3. Identificar se o usu√°rio fez reflex√µes profundas\n4. Contar palavras totais do usu√°rio\n5. Preservar contexto emocional e insights importantes\n\nREGRAS CR√çTICAS:\n- Remova redund√¢ncias e repeti√ß√µes\n- Mantenha apenas informa√ß√µes √∫nicas e relevantes\n- Preserve sentimentos, eventos e contextos mencionados\n- Seja objetivo e direto\n- M√°ximo de 300 palavras no resumo\n- Retorne APENAS JSON estruturado\n\nVoc√™ est√° ajudando a construir o perfil psicol√≥gico do usu√°rio ao longo do tempo, ent√£o cada palavra conta."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        2784,
        512
      ],
      "id": "70e48f10-616f-47c5-a048-61e42ef42a93",
      "name": "Resumo das conversas"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"resumo_conversa\": \"string\",\n  \"tem_reflexao\": true, \n  \"justificativa_reflexao\": \"string\",\n  \"total_palavras_usuario\": 204,  \n  \"confianca_analise\": 95 \n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        2944,
        720
      ],
      "id": "8430e601-7cd7-491c-b5de-bb94dd83b95c",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "usr_chat",
          "mode": "list",
          "cachedResultName": "usr_chat"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('grava_mensagem').item.json.id }}",
            "total_palavras_usuario": "={{ $json.output.total_palavras_usuario }}",
            "resumo_conversa": "={{ $json.output.resumo_conversa }}",
            "tem_reflexao": "={{ $json.output.tem_reflexao }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "data_conversa",
              "displayName": "data_conversa",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "horario_inicio",
              "displayName": "horario_inicio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "time",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "horario_fim",
              "displayName": "horario_fim",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "time",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "total_interactions",
              "displayName": "total_interactions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "mensagens",
              "displayName": "mensagens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "processada_em",
              "displayName": "processada_em",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "criado_em",
              "displayName": "criado_em",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "atualizado_em",
              "displayName": "atualizado_em",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "resumo_conversa",
              "displayName": "resumo_conversa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tem_reflexao",
              "displayName": "tem_reflexao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "total_palavras_usuario",
              "displayName": "total_palavras_usuario",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3104,
        512
      ],
      "id": "d9ec36df-24e8-4bd4-b251-b988dbcc153a",
      "name": "Update rows in a table",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id, tipo, titulo, mensagem, contexto_mentor, quests_mencionadas, referencia_id, criado_em\nFROM notificacoes_log\nWHERE usuario_id = $1\n  AND canal = 'whatsapp'\n  AND (respondida IS NULL OR respondida = FALSE)\nORDER BY criado_em DESC\nLIMIT 1;",
        "options": {
          "queryReplacement": "={{ $('busca_dados_usr').first().json.id }}"
        }
      },
      "id": "busca_notificacao",
      "name": "busca_notificacao",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        16,
        -304
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE notificacoes_log\nSET respondida = TRUE, respondida_em = NOW()\nWHERE id = $1::uuid\n  AND $1 IS NOT NULL;",
        "options": {
          "queryReplacement": "={{ [$('contexto_completo').first().json.notificacao_recente ? $('contexto_completo').first().json.notificacao_recente.id : null] }}"
        }
      },
      "id": "marca_notificacao",
      "name": "marca_notificacao",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1552,
        -304
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Call this tool for quest information.",
        "operation": "executeQuery",
        "query": "\nWITH quests_usuario AS (\n  SELECT \n    uq.id,\n    uq.status,\n    uq.config->>'titulo' AS titulo,\n    uq.config->>'descricao' AS descricao,\n    uq.ativado_em\n  FROM usuarios_quest uq\n  WHERE uq.usuario_id = $1\n),\nrecorrencias_hoje AS (\n  SELECT \n    uq.id AS quest_id,\n    uq.config->>'titulo' AS titulo,\n    uq.config->>'descricao' AS descricao,\n    qr.data_concluida,\n    qr.xp_base + qr.xp_bonus AS xp_ganho\n  FROM quests_recorrencias qr\n  JOIN usuarios_quest uq ON qr.usuarios_quest_id = uq.id\n  WHERE uq.usuario_id = $1\n    AND qr.status = 'concluida'\n    AND qr.data_concluida = CURRENT_DATE\n)\nSELECT json_build_object(\n  'resumo', json_build_object(\n    'total_a_fazer', (SELECT COUNT(*) FROM quests_usuario WHERE status = 'disponivel'),\n    'total_fazendo', (SELECT COUNT(*) FROM quests_usuario WHERE status = 'ativa'),\n    'total_feitas_hoje', (SELECT COUNT(*) FROM recorrencias_hoje)\n  ),\n  'quests_a_fazer', COALESCE((\n    SELECT json_agg(json_build_object('id', id, 'titulo', titulo, 'descricao', descricao))\n    FROM quests_usuario WHERE status = 'disponivel'\n  ), '[]'::json),\n  'quests_fazendo', COALESCE((\n    SELECT json_agg(json_build_object('id', id, 'titulo', titulo, 'descricao', descricao))\n    FROM quests_usuario WHERE status = 'ativa'\n  ), '[]'::json),\n  'quests_feitas_hoje', COALESCE((\n    SELECT json_agg(json_build_object('quest_id', quest_id, 'titulo', titulo, 'xp_ganho', xp_ganho))\n    FROM recorrencias_hoje\n  ), '[]'::json)\n) AS resultado;",
        "options": {
          "queryReplacement": "={{ $('busca_dados_usr').first().json.id }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        960,
        -16
      ],
      "id": "df5561c0-331f-4f10-893f-2d0c19c5e747",
      "name": "quets_tool",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "mode": "delete",
        "deleteMode": "all"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryManager",
      "typeVersion": 1.1,
      "position": [
        256,
        -64
      ],
      "id": "ea7cf850-2e53-4c58-a90e-fef5be0cffc0",
      "name": "Chat Memory Manager",
      "disabled": true
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Call this tool to generate a new user access token.",
        "operation": "executeQuery",
        "query": "SELECT concat('https://mindquest.pt/app/auth?token=', token_acesso) AS url_completo\nFROM usuarios\nWHERE id = $1;",
        "options": {
          "queryReplacement": "={{ $('busca_dados_usr').first().json.id }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1104,
        16
      ],
      "id": "507ffe42-f44a-47d1-a7b6-5d6f6210d50a",
      "name": "token_tool",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "DJB5qWudX1Hqap1O",
          "mode": "list",
          "cachedResultUrl": "/workflow/DJB5qWudX1Hqap1O",
          "cachedResultName": "sw_evolution_send_message_v2"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "instanceName": "={{ $('start').first().json['body.instance'] }}",
            "remoteJidOrNumber": "={{ $('start').first().json['body.data.key.remoteJid'] }}",
            "messageText": "={{ $('processa_resposta').first().json.user_message }}",
            "linkPreview": "false",
            "minDelayMs": "3000"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "instanceName",
              "displayName": "instanceName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "remoteJidOrNumber",
              "displayName": "remoteJidOrNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "messageText",
              "displayName": "messageText",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "linkPreview",
              "displayName": "linkPreview",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "minDelayMs",
              "displayName": "minDelayMs",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "69729790-3af6-40f7-bbfe-cba249bff773",
      "name": "envia_mensagem_encerrar",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2048,
        -464
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "82b17f0c-bed1-4d70-83ed-d2a55899f0d6",
              "leftValue": "={{ $('processa_resposta').item.json.checkpoint_encerramento }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "f7617c6e-0d2d-442a-a003-cb6158a53431",
              "leftValue": "",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1760,
        -304
      ],
      "id": "082b7956-d838-43b8-b448-3ee1c5160613",
      "name": "encerramento"
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "config": {
      "main": [
        [
          {
            "node": "busca_dados_usr",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "busca_contexto": {
      "main": [
        [
          {
            "node": "contexto_completo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "contexto_completo": {
      "main": [
        [
          {
            "node": "transcricao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "transcricao": {
      "main": [
        [
          {
            "node": "mentor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "openrouter_model": {
      "ai_languageModel": [
        [
          {
            "node": "parser_mentor",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "mentor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "parser_mentor": {
      "ai_outputParser": [
        [
          {
            "node": "mentor",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "memory": {
      "ai_memory": [
        [
          {
            "node": "mentor",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "Chat Memory Manager",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "processa_resposta": {
      "main": [
        [
          {
            "node": "grava_mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "finaliza_sessao": {
      "main": [
        [
          {
            "node": "call_experts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "call_experts": {
      "main": [
        [
          {
            "node": "expert_panas",
            "type": "main",
            "index": 0
          },
          {
            "node": "expert_sabotadores",
            "type": "main",
            "index": 0
          },
          {
            "node": "expert_insights",
            "type": "main",
            "index": 0
          },
          {
            "node": "expert_humor_energia",
            "type": "main",
            "index": 0
          },
          {
            "node": "expert_bigfive",
            "type": "main",
            "index": 0
          },
          {
            "node": "sw_xp_conversas",
            "type": "main",
            "index": 0
          },
          {
            "node": "expert_objetivos",
            "type": "main",
            "index": 0
          },
          {
            "node": "Resumo das conversas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "expert_sabotadores": {
      "main": [
        [
          {
            "node": "sw_criar_quest",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "expert_objetivos": {
      "main": [
        [
          {
            "node": "grava_objetivo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "mentor": {
      "main": [
        [
          {
            "node": "processa_resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Resumo das conversas",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Resumo das conversas": {
      "main": [
        [
          {
            "node": "Update rows in a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Resumo das conversas",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "busca_dados_usr": {
      "main": [
        [
          {
            "node": "busca_notificacao",
            "type": "main",
            "index": 0
          },
          {
            "node": "Chat Memory Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "busca_notificacao": {
      "main": [
        [
          {
            "node": "busca_contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "grava_mensagem": {
      "main": [
        [
          {
            "node": "marca_notificacao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "marca_notificacao": {
      "main": [
        [
          {
            "node": "encerramento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "quets_tool": {
      "ai_tool": [
        [
          {
            "node": "mentor",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "token_tool": {
      "ai_tool": [
        [
          {
            "node": "mentor",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "envia_mensagem": {
      "main": [
        []
      ]
    },
    "envia_mensagem_encerrar": {
      "main": [
        [
          {
            "node": "finaliza_sessao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "encerramento": {
      "main": [
        [
          {
            "node": "envia_mensagem_encerrar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "envia_mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "saveManualExecutions": true,
    "saveExecutionProgress": true,
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "executionTimeout": 120
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "start": [
      {
        "json": {
          "usr_id": "d949d81c-9235-41ce-8b3b-6b5d593c5e24",
          "body.instance": "MindQuest",
          "body.data.key.remoteJid": "351932786582@s.whatsapp.net",
          "body.data.key.id": "3BC78B20274BB7E96241",
          "body.data.key.fromMe": false,
          "body.data.pushName": "Aldo Santos",
          "body.data.message.conversation": "combinado",
          "body.data.messageType": "conversation"
        }
      }
    ]
  },
  "activeVersionId": null,
  "shared": [
    {
      "createdAt": "2025-12-07T20:11:13.721Z",
      "role": "workflow:owner",
      "workflowId": "zpNw60BXhEJCYTYH",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [],
  "activeVersion": null
}
