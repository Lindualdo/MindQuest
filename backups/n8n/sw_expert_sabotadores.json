{
  "updatedAt": "2025-12-06T21:31:54.787Z",
  "createdAt": "2025-10-03T14:54:43.940Z",
  "id": "Vbc4JHAR3388mLcv",
  "name": "sw_expert_sabotadores",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            { "name": "usuario_id" },
            { "name": "mensagens" },
            { "name": "data_conversa" },
            { "name": "chat_id" },
            { "name": "usr_name" }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [160, 80],
      "id": "ab9114d5-694e-4e63-8257-b8f4744fbb3f",
      "name": "start"
    },
    {
      "id": "busca_catalogo",
      "name": "busca_catalogo",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [280, 80],
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id, nome, descricao FROM sabotadores_catalogo ORDER BY nome;",
        "options": {}
      },
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analise a conversa e identifique sabotadores internos segundo Shirzad Chamine.\n\n**CONVERSA:**\n```json\n{{ $('start').first().json.mensagens }}\n```\nNome do usuário: {{ $('start').first().json.usr_name }}\n\n**SABOTADORES VÁLIDOS (use APENAS estes IDs):**\n{{ $('busca_catalogo').all().map(s => `- **${s.json.nome}** (${s.json.id}): ${s.json.descricao || ''}`).join('\\n') }}\n\n**CRÍTICO: sabotador_id DEVE ser EXATAMENTE um dos IDs acima**\n\n**SUA TAREFA:**\n1. Leia APENAS mensagens do usuário (autor: \"usuario\")\n2. Identifique sabotadores ativos (mínimo intensidade 30)\n3. Para cada sabotador:\n   - sabotador_id: EXATAMENTE um dos IDs da lista acima\n   - Intensidade: 0-100\n   - Contexto: vida_pessoal|profissional|financeiro|relacionamentos|saude|familia\n   - Frases gatilho: 2-4 frases CURTAS (máx 15 palavras)\n   - Insights: como impacta (use nome do usuário na 3ª pessoa)\n   - Confiabilidade: 0-100\n   - Apelido: curto e humanizado (ex: \"Sr. Ansioso\")\n   - Contramedida: UMA ação prática\n\n**REGRAS:**\n- Intensidade 0-100 (NÃO 0-10)\n- Apenas sabotadores com intensidade ≥ 30\n- Se não houver sabotadores, retorne array vazio\n- Retorne APENAS JSON estruturado",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "Você é especialista em detectar sabotadores internos segundo Shirzad Chamine.\n\nSeu trabalho:\n1. Identificar padrões de pensamento autodestrutivos\n2. Avaliar intensidades na escala 0-100 (IMPORTANTE: NÃO use 0-10)\n3. Extrair TRECHOS CURTOS E ESPECÍFICOS como frases gatilho (não textos longos)\n4. Classificar contextos corretamente\n5. Criar apelidos humanizados e contramedidas práticas\n\nEscala de intensidade 0-100:\n- 0-20: muito fraca\n- 21-40: fraca  \n- 41-60: moderada\n- 61-80: forte\n- 81-100: muito forte\n\nFRASES GATILHO:\n- Devem ser trechos CURTOS (máximo 15 palavras)\n- Extraia 2-4 frases específicas que evidenciam o sabotador\n- NÃO copie o texto inteiro\n- Exemplo bom: \"me senti desprezado\", \"ela não gostava mais de mim\"\n- Exemplo ruim: texto completo de 50+ palavras\n\nSeja criterioso: apenas inclua sabotadores com evidências claras e intensidade ≥ 30.\n\nRetorne SEMPRE JSON válido.",
          "maxIterations": 3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [520, 80],
      "id": "5078885e-3d2c-41ce-9f1e-f66da411a6b5",
      "name": "Analisador Sabotadores"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"sabotadores_detectados\": [\n    {\n      \"sabotador_id\": \"critico\",\n      \"nome_pt\": \"Crítico\",\n      \"intensidade\": 75,\n      \"contexto\": \"relacionamentos\",\n      \"frases_gatilho\": [\n        \"me senti desprezado\",\n        \"ela não gostava mais de mim\",\n        \"não encontrei alguém que vale a pena\"\n      ],\n      \"insights\": \"Autocrítica intensa sobre valor pessoal e capacidade de ser amado.\",\n      \"confiabilidade\": 90,\n      \"apelido\": \"Sr. Exigente\",\n      \"contramedida\": \"Praticar autocompaixão: falar consigo como falaria com um amigo querido por 3 minutos\"\n    }\n  ]\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [632, 304],
      "id": "a66b52c1-d5af-4f1c-8902-227ba7f4307a",
      "name": "Parser JSON Sabotadores"
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 2000,
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [488, 432],
      "id": "d3455d77-915f-4b1c-b568-a1cc9e1d3fc7",
      "name": "OpenRouter Claude",
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Inserir sabotadores detectados\nWITH sabotadores_input AS (\n  SELECT \n    $1::uuid as usuario_id,\n    $2::uuid as chat_id,\n    $3::jsonb as sabotadores_array\n)\nINSERT INTO usuarios_sabotadores (\n  usuario_id,\n  chat_id,\n  sabotador_id,\n  intensidade_media,\n  contexto_principal,\n  insight_atual,\n  total_deteccoes,\n  apelido_personalizado,\n  contramedida_ativa,\n  sabotador_predominante,\n  data_ultima_atividade\n)\nSELECT \n  si.usuario_id,\n  si.chat_id,\n  (sabotador->>'sabotador_id')::varchar(30),\n  (sabotador->>'intensidade')::integer,\n  (sabotador->>'contexto')::varchar(100),\n  (sabotador->>'insights')::text,\n  1,\n  (sabotador->>'apelido')::varchar(50),\n  (sabotador->>'contramedida')::text,\n  true,\n  CURRENT_DATE\nFROM sabotadores_input si,\n     jsonb_array_elements(si.sabotadores_array) as sabotador\nWHERE (sabotador->>'intensidade')::integer >= 30\nRETURNING \n  id,\n  usuario_id,\n  chat_id,\n  sabotador_id,\n  intensidade_media,\n  criado_em;",
        "options": {
          "queryReplacement": "=[\n  {{ $('start').first().json.usuario_id }},\n  {{ $('start').first().json.chat_id }},\n  {{ JSON.stringify($json.output.sabotadores_detectados) }}\n]"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [840, 80],
      "id": "70e4bcd8-4fd5-4a16-9f73-d29644d9b656",
      "name": "Gravar Sabotadores",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    }
  ],
  "connections": {
    "start": {
      "main": [[{ "node": "busca_catalogo", "type": "main", "index": 0 }]]
    },
    "busca_catalogo": {
      "main": [[{ "node": "Analisador Sabotadores", "type": "main", "index": 0 }]]
    },
    "Analisador Sabotadores": {
      "main": [[{ "node": "Gravar Sabotadores", "type": "main", "index": 0 }]]
    },
    "Parser JSON Sabotadores": {
      "ai_outputParser": [[{ "node": "Analisador Sabotadores", "type": "ai_outputParser", "index": 0 }]]
    },
    "OpenRouter Claude": {
      "ai_languageModel": [
        [
          { "node": "Analisador Sabotadores", "type": "ai_languageModel", "index": 0 },
          { "node": "Parser JSON Sabotadores", "type": "ai_languageModel", "index": 0 }
        ]
      ]
    }
  },
  "settings": { "executionOrder": "v1" }
}
