{
  "name": "job_experts_v5",
  "active": false,
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 30
            }
          ]
        }
      },
      "id": "trigger-v5",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [400, 304]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- v5: Busca chats pendentes + experts com erro\n-- Regra 1: atualizado_em > processado_em (nova conversa)\n-- Regra 2: existe expert com status='erro' e tentativas < 5\nWITH chats_novos AS (\n  SELECT \n    c.id AS chat_id,\n    c.usuario_id,\n    c.data_conversa,\n    c.total_interactions,\n    c.atualizado_em,\n    c.processado_em,\n    c.experts_processados,\n    u.nome_preferencia AS usr_nome_preferencia,\n    'nova_conversa' AS motivo,\n    '[]'::jsonb AS experts_retry\n  FROM usr_chat c\n  JOIN usuarios u ON u.id = c.usuario_id\n  WHERE c.atualizado_em > COALESCE(c.processado_em, '1970-01-01'::timestamp)\n),\nchats_com_erro AS (\n  SELECT \n    c.id AS chat_id,\n    c.usuario_id,\n    c.data_conversa,\n    c.total_interactions,\n    c.atualizado_em,\n    c.processado_em,\n    c.experts_processados,\n    u.nome_preferencia AS usr_nome_preferencia,\n    'expert_com_erro' AS motivo,\n    jsonb_agg(\n      jsonb_build_object(\n        'expert', expert_key,\n        'tentativas', (expert_value->>'tentativas')::int,\n        'ultimo_erro', expert_value->>'ultimo_erro_msg'\n      )\n    ) AS experts_retry\n  FROM usr_chat c\n  JOIN usuarios u ON u.id = c.usuario_id,\n  LATERAL jsonb_each(c.experts_processados) AS expert(expert_key, expert_value)\n  WHERE c.atualizado_em <= COALESCE(c.processado_em, NOW())\n    AND expert_value->>'status' = 'erro'\n    AND COALESCE((expert_value->>'tentativas')::int, 0) < 5\n  GROUP BY c.id, c.usuario_id, c.data_conversa, c.total_interactions, \n           c.atualizado_em, c.processado_em, c.experts_processados, u.nome_preferencia\n)\nSELECT * FROM chats_novos\nUNION\nSELECT * FROM chats_com_erro\nORDER BY atualizado_em DESC\nLIMIT 50;",
        "options": {}
      },
      "id": "busca-chats-v5",
      "name": "Buscar Chats Pendentes",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [624, 304],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "loop-v5",
      "name": "Loop Over Items",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [848, 304]
    },
    {
      "parameters": {
        "jsCode": "// v5: Prepara dados + identifica experts a processar\nconst item = $input.first().json;\n\nconst motivo = item.motivo || 'nova_conversa';\nconst expertsRetry = Array.isArray(item.experts_retry) ? item.experts_retry.map(e => e.expert) : [];\n\nconst todosExperts = ['sabotadores', 'emocoes', 'humor', 'bigfive', 'insights'];\nconst expertsParaProcessar = motivo === 'nova_conversa' ? todosExperts : expertsRetry;\n\nreturn [{\n  json: {\n    chat_id: item.chat_id,\n    usuario_id: item.usuario_id,\n    data_conversa: item.data_conversa,\n    usr_nome_preferencia: item.usr_nome_preferencia || 'Usuário',\n    motivo: motivo,\n    experts_para_processar: expertsParaProcessar,\n    experts_processados_atual: item.experts_processados || {}\n  }\n}];"
      },
      "id": "prepara-v5",
      "name": "Preparar Dados",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1072, 304]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- v5: Marca chat como em processamento\nUPDATE usr_chat \nSET processado_em = NOW()\nWHERE id = $1::uuid\nRETURNING id, processado_em;",
        "options": {
          "queryReplacement": "={{ [$json.chat_id] }}"
        }
      },
      "id": "marca-processamento-v5",
      "name": "Marcar Processamento",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1296, 304],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PLACEHOLDER_SW_EXPERT_V5_ID",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $json.usuario_id }}",
            "chat_id": "={{ $json.chat_id }}",
            "data_conversa": "={{ $json.data_conversa }}",
            "usr_nome_preferencia": "={{ $json.usr_nome_preferencia }}",
            "motivo": "={{ $json.motivo }}",
            "experts_para_processar": "={{ JSON.stringify($json.experts_para_processar) }}",
            "experts_processados_atual": "={{ JSON.stringify($json.experts_processados_atual) }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "type": "string"
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "type": "string"
            },
            {
              "id": "data_conversa",
              "displayName": "data_conversa",
              "type": "string"
            },
            {
              "id": "usr_nome_preferencia",
              "displayName": "usr_nome_preferencia",
              "type": "string"
            },
            {
              "id": "motivo",
              "displayName": "motivo",
              "type": "string"
            },
            {
              "id": "experts_para_processar",
              "displayName": "experts_para_processar",
              "type": "string"
            },
            {
              "id": "experts_processados_atual",
              "displayName": "experts_processados_atual",
              "type": "string"
            }
          ]
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "chama-experts-v5",
      "name": "Chamar sw_expert_v5",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [1520, 304]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "id": "merge-resultado-v5",
      "name": "Merge Resultado",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [1744, 304]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2
          },
          "conditions": [
            {
              "id": "cond-sucesso",
              "leftValue": "={{ $json.processado }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "if-sucesso-v5",
      "name": "Processou com Sucesso?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [1968, 304]
    },
    {
      "parameters": {
        "jsCode": "// v5: Sucesso - continua loop\nreturn [$input.first()];"
      },
      "id": "sucesso-v5",
      "name": "Sucesso",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2192, 176]
    },
    {
      "parameters": {
        "jsCode": "// v5: Erro - registra falha no experts_processados\nconst item = $input.first().json;\nconst chatId = item.chat_id;\nconst expertsParaProcessar = item.experts_para_processar || [];\nconst erro = item.motivo || 'erro desconhecido';\n\n// Monta objeto com todos experts marcados como erro\nconst expertsErro = {};\nfor (const expert of expertsParaProcessar) {\n  expertsErro[expert] = {\n    processado_em: new Date().toISOString(),\n    status: 'erro',\n    tentativas: (item.experts_processados_atual?.[expert]?.tentativas || 0) + 1,\n    ultimo_erro_em: new Date().toISOString(),\n    ultimo_erro_msg: erro\n  };\n}\n\nreturn [{\n  json: {\n    chat_id: chatId,\n    experts_erro: expertsErro\n  }\n}];"
      },
      "id": "erro-v5",
      "name": "Registrar Erro",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2192, 432]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- v5: Atualiza experts_processados com erros\nUPDATE usr_chat\nSET experts_processados = experts_processados || $2::jsonb\nWHERE id = $1::uuid\nRETURNING id, experts_processados;",
        "options": {
          "queryReplacement": "={{ [$json.chat_id, JSON.stringify($json.experts_erro)] }}"
        }
      },
      "id": "atualiza-erro-v5",
      "name": "Atualizar Erro",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [2416, 432],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "content": "## job_experts v5 - Controle Individual por Expert\n\n### Mudanças da v4\n- ✅ Controle via experts_processados (jsonb) em usr_chat\n- ✅ Retry com limite (max 5 tentativas)\n- ✅ Processa apenas experts com erro (não todo chat)\n- ✅ Marca processado_em ANTES de chamar sw_expert\n\n### Fluxo\n1. Busca chats:\n   - Regra 1: atualizado_em > processado_em (nova conversa)\n   - Regra 2: expert com status='erro' e tentativas < 5\n2. Marca processado_em = NOW()\n3. Chama sw_expert_v5 (passa lista de experts)\n4. Se sucesso: continua\n5. Se erro: atualiza experts_processados com status='erro'\n\n### Cenários\n**Nova conversa:**\n- Processa TODOS experts\n- Se falhar, marca expert com erro\n\n**Expert com erro (sem nova conversa):**\n- Processa APENAS expert com erro\n- Incrementa tentativas\n- Se tentativas >= 5: status='bloqueado'\n\n### Frequência\n- A cada 30 minutos",
        "height": 900,
        "width": 360
      },
      "id": "regras-v5",
      "name": "Regras job_experts_v5",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [0, -96]
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Buscar Chats Pendentes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Chats Pendentes": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Sucesso",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Dados": {
      "main": [
        [
          {
            "node": "Marcar Processamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Marcar Processamento": {
      "main": [
        [
          {
            "node": "Chamar sw_expert_v5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chamar sw_expert_v5": {
      "main": [
        [
          {
            "node": "Merge Resultado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Resultado": {
      "main": [
        [
          {
            "node": "Processou com Sucesso?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processou com Sucesso?": {
      "main": [
        [
          {
            "node": "Sucesso",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Registrar Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sucesso": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Erro": {
      "main": [
        [
          {
            "node": "Atualizar Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Erro": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}

