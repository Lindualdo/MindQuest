{
  "createdAt": "2025-12-15T23:15:20.309Z",
  "id": "DztMpxVJw7Mvfke8",
  "name": "sw_experts_v3",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usuario_id"
            },
            {
              "name": "chat_id"
            },
            {
              "name": "data_conversa"
            },
            {
              "name": "usr_nome_preferencia"
            }
          ]
        }
      },
      "id": "62eba3df-04a1-4823-bfec-c1aa63911895",
      "name": "start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -4240,
        1120
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Buscar dados do chat e resumo existente\nSELECT\n  c.id,\n  c.resumo_conversa,\n  c.tem_reflexao,\n  c.mensagens,\n  c.total_palavras_usuario,\n  u.nome_preferencia\nFROM usr_chat c\nJOIN usuarios u ON u.id = c.usuario_id\nWHERE c.id = $1::uuid;",
        "options": {
          "queryReplacement": "={{ [$json.chat_id] }}"
        }
      },
      "id": "68b05a6c-4719-40ac-a357-628631f8f890",
      "name": "Buscar Dados Chat",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -4048,
        1120
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 1500,
          "temperature": 0.2
        }
      },
      "id": "cbf8612d-2a4a-4475-9938-5a0a5f41ae38",
      "name": "LLM Resumo",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -3872,
        1344
      ],
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"tem_contexto\": true,\n  \"tem_reflexao\": true,\n  \"justificativa\": \"string\",\n  \"total_palavras\": 150,\n  \"resumo_atualizado\": \"string\"\n}"
      },
      "id": "cf4b4c98-a54f-41cc-b421-906a3a7918ce",
      "name": "Parser Resumo",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -3712,
        1344
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-contexto",
              "leftValue": "={{ $json.output.tem_contexto }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "64a90476-397f-43a7-9b5a-6f6372680561",
      "name": "Tem Contexto?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3536,
        1120
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT jsonb_agg(\n  jsonb_build_object('codigo', codigo, 'nome', nome)\n  ORDER BY codigo\n) AS catalogo_sabotadores\nFROM sabotadores_catalogo;",
        "options": {}
      },
      "id": "40928a4a-eee1-4af1-9524-e40c652a6540",
      "name": "Buscar CatÃ¡logo Sabotadores",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2128,
        640
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 2000,
          "temperature": 0.2
        }
      },
      "id": "4f667e64-477d-488a-b938-ee9890bfb838",
      "name": "LLM Sabotadores",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -1872,
        832
      ],
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"sabotadores_detectados\": [\n    {\n      \"codigo\": 1,\n      \"intensidade\": 75,\n      \"contexto\": \"relacionamentos\",\n      \"frases_gatilho\": [\n        \"me senti desprezado\",\n        \"ela nÃ£o gostava mais de mim\"\n      ],\n      \"insights\": \"AutocrÃ­tica intensa sobre valor pessoal.\",\n      \"confiabilidade\": 90,\n      \"apelido\": \"Sr. Exigente\",\n      \"contramedida\": \"Praticar autocompaixÃ£o por 3 minutos\"\n    }\n  ]\n}",
        "autoFix": true
      },
      "id": "8eca443a-83b5-41fb-93a9-b11f9d061d34",
      "name": "Parser Sabotadores",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1616,
        800
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- v3: INSERT simples (DELETE jÃ¡ foi executado)\nWITH sabotadores_input AS (\n  SELECT \n    $1::uuid as usuario_id,\n    $2::uuid as chat_id,\n    $3::jsonb as sabotadores_array\n),\nsabotadores_com_id AS (\n  SELECT \n    si.usuario_id,\n    si.chat_id,\n    sc.id AS sabotador_id,\n    (sabotador->>'intensidade')::integer AS intensidade,\n    (sabotador->>'contexto')::varchar(100) AS contexto,\n    (sabotador->>'insights')::text AS insights,\n    (sabotador->>'apelido')::varchar(50) AS apelido,\n    (sabotador->>'contramedida')::text AS contramedida\n  FROM sabotadores_input si,\n       jsonb_array_elements(si.sabotadores_array) AS sabotador\n  JOIN sabotadores_catalogo sc ON sc.codigo = (sabotador->>'codigo')::integer\n  WHERE (sabotador->>'intensidade')::integer >= 30\n)\nINSERT INTO usuarios_sabotadores (\n  usuario_id,\n  chat_id,\n  sabotador_id,\n  intensidade_media,\n  intensidade_acumulada_dia,\n  total_deteccoes_dia,\n  total_deteccoes,\n  contexto_principal,\n  insight_atual,\n  apelido_personalizado,\n  contramedida_ativa,\n  sabotador_predominante,\n  data_ultima_atividade\n)\nSELECT \n  usuario_id,\n  chat_id,\n  sabotador_id,\n  intensidade,\n  intensidade,\n  1,\n  1,\n  contexto,\n  insights,\n  apelido,\n  contramedida,\n  true,\n  CURRENT_DATE\nFROM sabotadores_com_id\nRETURNING id, sabotador_id, intensidade_media;",
        "options": {
          "queryReplacement": "={{ [\n  $('start').first().json.usuario_id,\n  $('start').first().json.chat_id,\n  JSON.stringify($json.output.sabotadores_detectados || [])\n] }}"
        }
      },
      "id": "a7a087c9-28b0-471a-9bf7-7d05724fab9b",
      "name": "Gravar Sabotadores",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1456,
        576
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 1500,
          "temperature": 0.2
        }
      },
      "id": "1bdbb905-ae5d-4dd5-808b-67c3eab50f16",
      "name": "LLM PANAS",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -2080,
        1968
      ],
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"emocoes_detectadas\": [\n    {\n      \"emocao_id\": \"sadness\",\n      \"nome_pt\": \"tristeza\",\n      \"intensidade\": 85,\n      \"contexto\": \"NEGATIVA\",\n      \"evidencias\": [\"saudade\", \"solidÃ£o\", \"angÃºstia\", \"me senti desprezado\"]\n    },\n    {\n      \"emocao_id\": \"anticipation\",\n      \"nome_pt\": \"expectativa\",\n      \"intensidade\": 40,\n      \"contexto\": \"POSITIVA\",\n      \"evidencias\": [\"projetos pessoais\", \"acompanhamento terapÃªutico\"]\n    },\n    {\n      \"emocao_id\": \"fear\",\n      \"nome_pt\": \"medo\",\n      \"intensidade\": 50,\n      \"contexto\": \"NEGATIVA\",\n      \"evidencias\": [\"preocupaÃ§Ã£o\", \"inseguranÃ§a\"]\n    }\n  ],\n  \"classificacao_panas\": \"negativa\",\n  \"justificativa_panas\": \"PredominÃ¢ncia de tristeza (85) relacionada a perda, solidÃ£o e rejeiÃ§Ã£o. Expectativa presente mas em menor intensidade.\",\n  \"confianca_analise\": 90\n}",
        "autoFix": true
      },
      "id": "d092317c-c39d-44fd-ba14-fda2442d3dc6",
      "name": "Parser PANAS",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1904,
        1904
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- UPSERT emoÃ§Ãµes: 1 registro por (chat_id, emocao_id) com mÃ©dia de intensidade\nWITH emocoes_json AS (\n  SELECT \n    $1::uuid AS usuario_id,\n    $2::uuid AS chat_id,\n    $3::date AS data_conversa,\n    jsonb_array_elements($4::jsonb) AS emocao\n)\nINSERT INTO usuarios_emocoes (\n  usuario_id, chat_id, emocao_id, intensidade, intensidade_acumulada,\n  ocorrencias_dia, detectado_em, contexto, evidencias, emocao_pt\n)\nSELECT \n  ej.usuario_id, ej.chat_id,\n  (ej.emocao->>'emocao_id')::varchar(20),\n  (ej.emocao->>'intensidade')::integer,\n  (ej.emocao->>'intensidade')::integer,\n  1,\n  ej.data_conversa,\n  (ej.emocao->>'contexto')::varchar(100),\n  (ej.emocao->>'evidencias')::jsonb,\n  (ej.emocao->>'nome_pt')::varchar(20)\nFROM emocoes_json ej\nWHERE (ej.emocao->>'intensidade')::integer >= 45\nON CONFLICT (chat_id, emocao_id) DO UPDATE SET\n  ocorrencias_dia = usuarios_emocoes.ocorrencias_dia + 1,\n  intensidade_acumulada = usuarios_emocoes.intensidade_acumulada + EXCLUDED.intensidade,\n  intensidade = (usuarios_emocoes.intensidade_acumulada + EXCLUDED.intensidade) / \n                (usuarios_emocoes.ocorrencias_dia + 1),\n  evidencias = usuarios_emocoes.evidencias || EXCLUDED.evidencias,\n  contexto = EXCLUDED.contexto,\n  criado_em = NOW()\nRETURNING id, emocao_id, intensidade, ocorrencias_dia;",
        "options": {
          "queryReplacement": "={{ [\n  $('start').first().json.usuario_id,\n  $('start').first().json.chat_id,\n  ((v) => v ? new Date(v).toISOString().slice(0,10) : null)($('start').first().json.data_conversa),\n  JSON.stringify($json.output.emocoes_detectadas || [])\n] }}"
        }
      },
      "id": "7458ebde-2cd2-463b-a8eb-c169f0463235",
      "name": "Gravar EmoÃ§Ãµes",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1744,
        1712
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 1000,
          "temperature": 0.2
        }
      },
      "id": "6ad5f215-46b8-4d4c-a78f-94be231a8476",
      "name": "LLM Humor",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -2096,
        2528
      ],
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"humor_dia\": 4,\n  \"energia_nivel\": 6,\n  \"variacao_humor\": \"descendente\",\n  \"variacao_energia\": \"estavel\",\n  \"periodo_dia\": \"tarde\",\n  \"justificativa_humor\": \"UsuÃ¡rio comeÃ§ou o dia produtivo e animado, mas ao final relata tristeza profunda, angÃºstia e desmotivaÃ§Ã£o apÃ³s ver fotos da ex-mulher\",\n  \"justificativa_energia\": \"Menciona que caminhou bastante, fez almoÃ§o, trabalhou no app - energia moderada/boa, mas manteve disposiÃ§Ã£o fÃ­sica apesar da queda emocional\",\n  \"evidencias_textuais\": [\n    \"dia estava muito bom hoje, muito produtivo\",\n    \"estava disposto, animado\",\n    \"bateu uma coisa muito ruim\",\n    \"angÃºstia, uma tristeza muito grande\",\n    \"muito desmotivado e desanimado\"\n  ],\n  \"confianca_analise\": 95\n}",
        "autoFix": true
      },
      "id": "f60dcfb2-7934-41fc-a055-7bb2cb35959f",
      "name": "Parser Humor",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1888,
        2448
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- UPSERT humor/energia: 1 registro por chat com mÃ©dia\nINSERT INTO usuarios_humor_energia (\n  usuario_id, chat_id, data_registro, hora_registro,\n  periodo_dia, humor_dia, humor_acumulado, energia_nivel, energia_acumulada,\n  ocorrencias_dia, variacao_humor, variacao_energia,\n  justificativa_humor, justificativa_energia,\n  evidencias_textuais, confianca_analise\n)\nVALUES (\n  $1::uuid, $2::uuid, $3::date, CURRENT_TIME,\n  $4, $5::integer, $5::integer, $6::integer, $6::integer,\n  1, $7, $8, $9, $10, $11::jsonb, $12::integer\n)\nON CONFLICT (chat_id) DO UPDATE SET\n  ocorrencias_dia = usuarios_humor_energia.ocorrencias_dia + 1,\n  humor_acumulado = usuarios_humor_energia.humor_acumulado + EXCLUDED.humor_dia,\n  energia_acumulada = usuarios_humor_energia.energia_acumulada + EXCLUDED.energia_nivel,\n  humor_dia = (usuarios_humor_energia.humor_acumulado + EXCLUDED.humor_dia) / \n              (usuarios_humor_energia.ocorrencias_dia + 1),\n  energia_nivel = (usuarios_humor_energia.energia_acumulada + EXCLUDED.energia_nivel) / \n                  (usuarios_humor_energia.ocorrencias_dia + 1),\n  hora_registro = CURRENT_TIME,\n  periodo_dia = EXCLUDED.periodo_dia,\n  variacao_humor = EXCLUDED.variacao_humor,\n  variacao_energia = EXCLUDED.variacao_energia,\n  justificativa_humor = EXCLUDED.justificativa_humor,\n  justificativa_energia = EXCLUDED.justificativa_energia,\n  evidencias_textuais = usuarios_humor_energia.evidencias_textuais || EXCLUDED.evidencias_textuais,\n  confianca_analise = EXCLUDED.confianca_analise,\n  detectado_em = NOW()\nRETURNING id, humor_dia, energia_nivel, ocorrencias_dia;",
        "options": {
          "queryReplacement": "={{ [\n  $('start').first().json.usuario_id,\n  $('start').first().json.chat_id,\n  ((v) => v ? new Date(v).toISOString().slice(0,10) : null)($('start').first().json.data_conversa),\n  $json.output.periodo_dia,\n  $json.output.humor_dia,\n  $json.output.energia_nivel,\n  $json.output.variacao_humor,\n  $json.output.variacao_energia,\n  JSON.stringify($json.output.justificativa_humor),\n  JSON.stringify($json.output.justificativa_energia),\n  JSON.stringify($json.output.evidencias_textuais || []),\n  $json.output.confianca_analise\n] }}"
        }
      },
      "id": "32998058-e3ed-4e6a-87e1-e51bed74e77f",
      "name": "Gravar Humor",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1680,
        2256
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "HDTrSrJiBIv2FFks",
          "mode": "list",
          "cachedResultUrl": "/workflow/HDTrSrJiBIv2FFks",
          "cachedResultName": "sw_get_history"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usr_id": "={{ $('start').first().json.usuario_id }}"
          }
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "1891593a-9e8e-43b7-b549-58a8d63bfefb",
      "name": "Buscar HistÃ³rico BigFive",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -2096,
        112
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "functionCode": "const startData = $items('start')[0]?.json ?? {};\nconst historyItems = $items('Buscar HistÃ³rico BigFive').map((item) => item.json).filter(Boolean);\nconst formatDate = (value) => {\n  if (!value) return null;\n  const parsed = new Date(value);\n  if (Number.isNaN(parsed.getTime())) return value;\n  return parsed.toISOString().slice(0, 10);\n};\nconst historicoOrdenado = historyItems\n  .map((entry) => ({\n    data: formatDate(entry.data_conversa),\n    resumo: entry.resumo_conversa ?? ''\n  }))\n  .filter((entry) => entry.data || entry.resumo)\n  .sort((a, b) => {\n    if (!a.data || !b.data) return 0;\n    return a.data < b.data ? 1 : -1;\n  });\nconst historicoResumo = historicoOrdenado.length\n  ? historicoOrdenado\n      .map((entry) => `- ${entry.data ?? 'data indeterminada'}: ${entry.resumo || 'sem resumo disponÃ­vel'}`)\n      .join('\\n')\n  : 'Sem histÃ³rico relevante nos Ãºltimos 5 dias.';\nreturn [\n  {\n    json: {\n      ...startData,\n      historico_resumo: historicoResumo,\n      historico_itens: historicoOrdenado\n    }\n  }\n];"
      },
      "id": "1045f919-c402-4621-afec-894ae8fa1421",
      "name": "Preparar Contexto BigFive",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -1888,
        112
      ]
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 2000,
          "temperature": 0.2
        }
      },
      "id": "6582d1ea-f869-427c-ba3c-2e9dcf6928b2",
      "name": "LLM BigFive",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -1744,
        320
      ],
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"big_five\": {\n    \"openness\": {\"score\": 62, \"confiabilidade\": 78, \"evidencias\": [\"gosto de explorar ideias novas\", \"procuro alternativas criativas\"]},\n    \"conscientiousness\": {\"score\": 54, \"confiabilidade\": 65, \"evidencias\": [\"monitorei meu plano\", \"organizei meus passos\"]},\n    \"extraversion\": {\"score\": 41, \"confiabilidade\": 60, \"evidencias\": [\"prefiro ficar na minha\", \"evitei encontros\"]},\n    \"agreeableness\": {\"score\": 70, \"confiabilidade\": 72, \"evidencias\": [\"procurei conciliar\", \"quero evitar conflito\"]},\n    \"neuroticism\": {\"score\": 58, \"confiabilidade\": 68, \"evidencias\": [\"fiquei ansioso com perdas\", \"preocupaÃ§Ã£o constante\"]}\n  },\n  \"perfil_primario\": \"agreeableness\",\n  \"resumo_perfil\": \"Pessoa colaborativa, aberta a diÃ¡logos e soluÃ§Ãµes conjuntas, mantendo equilÃ­brio em disciplina e energia social.\",\n  \"insuficiente\": false\n}",
        "autoFix": true
      },
      "id": "905698bb-94ed-4f4d-84e1-20b77735e4fc",
      "name": "Parser BigFive",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1584,
        320
      ]
    },
    {
      "parameters": {
        "functionCode": "const startItem = $items(\"start\")[0]?.json ?? {};\nconst preparado = $items(\"Preparar Contexto BigFive\")[0]?.json ?? {};\nconst payload = $json.output ?? {};\nconst traits = ['openness','conscientiousness','extraversion','agreeableness','neuroticism'];\nconst scores = traits.map((key) => {\n  const data = payload.big_five?.[key] ?? {};\n  const score = Number(data.score);\n  const confianca = Number(data.confiabilidade);\n  return {\n    id: key,\n    score: Number.isFinite(score) ? score : null,\n    confiabilidade: Number.isFinite(confianca) ? confianca : null\n  };\n});\nconst sorted = [...scores].sort((a, b) => (b.score ?? 0) - (a.score ?? 0));\nconst validTraits = new Set(traits);\nconst originalPrimary = payload.perfil_primario ?? null;\nlet primary = originalPrimary;\nif (!primary || primary === 'misto' || !validTraits.has(primary)) {\n  primary = sorted[0]?.id ?? null;\n}\nlet secondary = sorted.find((entry) => entry.id !== primary)?.id ?? null;\nif (!secondary && sorted[1]) {\n  secondary = sorted[1].id;\n}\nconst sumConfianca = scores.reduce((acc, entry) => acc + (entry.confiabilidade ?? 0), 0);\nconst confiancaMedia = scores.length ? Math.round(sumConfianca / scores.length) : null;\nconst rawDate = startItem.data_conversa || preparado.data_conversa;\nlet dataConversa = null;\nif (rawDate) {\n  const parsed = new Date(rawDate);\n  if (!isNaN(parsed)) {\n    dataConversa = parsed.toISOString().slice(0, 10);\n  }\n}\nif (!dataConversa) {\n  const now = new Date();\n  dataConversa = now.toISOString().slice(0, 10);\n}\nconst result = {\n  usuario_id: startItem.usuario_id ?? null,\n  chat_id: startItem.chat_id ?? null,\n  data_conversa: dataConversa,\n  perfil_original: originalPrimary,\n  perfil_primario: primary,\n  perfil_secundario: secondary,\n  resumo_perfil: payload.resumo_perfil ?? null,\n  insuficiente: Boolean(payload.insuficiente),\n  confianca_media: confiancaMedia,\n  raw_resposta: payload\n};\nfor (const trait of traits) {\n  const data = payload.big_five?.[trait] ?? {};\n  const score = Number(data.score);\n  const confianca = Number(data.confiabilidade);\n  result[`score_${trait}`] = Number.isFinite(score) ? score : null;\n  result[`confianca_${trait}`] = Number.isFinite(confianca) ? confianca : null;\n}\nreturn [{ json: result }];"
      },
      "id": "f7e681e7-9beb-4df9-998c-178cd2b9e5c9",
      "name": "Preparar Registro BigFive",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -1360,
        112
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO usuarios_perfis (\n  usuario_id,\n  chat_id,\n  data_conversa,\n  perfil_original,\n  perfil_primario,\n  perfil_secundario,\n  resumo_perfil,\n  insuficiente,\n  score_openness,\n  score_conscientiousness,\n  score_extraversion,\n  score_agreeableness,\n  score_neuroticism,\n  confianca_openness,\n  confianca_conscientiousness,\n  confianca_extraversion,\n  confianca_agreeableness,\n  confianca_neuroticism,\n  confianca_media,\n  raw_resposta,\n  criado_em,\n  atualizado_em\n)\nVALUES (\n  $1::uuid,\n  $2::uuid,\n  $3::date,\n  $4::varchar,\n  $5::varchar,\n  $6::varchar,\n  $7::text,\n  $8::boolean,\n  $9::integer,\n  $10::integer,\n  $11::integer,\n  $12::integer,\n  $13::integer,\n  $14::integer,\n  $15::integer,\n  $16::integer,\n  $17::integer,\n  $18::integer,\n  $19::integer,\n  $20::jsonb,\n  NOW(),\n  NOW()\n)\nON CONFLICT (chat_id) DO UPDATE SET\n  perfil_original = EXCLUDED.perfil_original,\n  perfil_primario = EXCLUDED.perfil_primario,\n  perfil_secundario = EXCLUDED.perfil_secundario,\n  resumo_perfil = EXCLUDED.resumo_perfil,\n  insuficiente = EXCLUDED.insuficiente,\n  score_openness = EXCLUDED.score_openness,\n  score_conscientiousness = EXCLUDED.score_conscientiousness,\n  score_extraversion = EXCLUDED.score_extraversion,\n  score_agreeableness = EXCLUDED.score_agreeableness,\n  score_neuroticism = EXCLUDED.score_neuroticism,\n  confianca_openness = EXCLUDED.confianca_openness,\n  confianca_conscientiousness = EXCLUDED.confianca_conscientiousness,\n  confianca_extraversion = EXCLUDED.confianca_extraversion,\n  confianca_agreeableness = EXCLUDED.confianca_agreeableness,\n  confianca_neuroticism = EXCLUDED.confianca_neuroticism,\n  confianca_media = EXCLUDED.confianca_media,\n  raw_resposta = EXCLUDED.raw_resposta,\n  atualizado_em = NOW()\nRETURNING id, perfil_primario;",
        "options": {
          "queryReplacement": "={{ [\n  $json.usuario_id ?? null,\n  $json.chat_id ?? null,\n  $json.data_conversa ?? null,\n  $json.perfil_original ?? null,\n  $json.perfil_primario ?? null,\n  $json.perfil_secundario ?? null,\n  $json.resumo_perfil ?? null,\n  $json.insuficiente === true,\n  $json.score_openness ?? null,\n  $json.score_conscientiousness ?? null,\n  $json.score_extraversion ?? null,\n  $json.score_agreeableness ?? null,\n  $json.score_neuroticism ?? null,\n  $json.confianca_openness ?? null,\n  $json.confianca_conscientiousness ?? null,\n  $json.confianca_extraversion ?? null,\n  $json.confianca_agreeableness ?? null,\n  $json.confianca_neuroticism ?? null,\n  $json.confianca_media ?? null,\n  $json.raw_resposta ?? {}\n] }}"
        }
      },
      "id": "62348899-004d-4c90-a921-c24b148165e5",
      "name": "Gravar BigFive",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1168,
        112
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 2000,
          "temperature": 0.3
        }
      },
      "id": "0106a61e-176e-4ee6-893b-808d9958b175",
      "name": "LLM Insights",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -2096,
        1456
      ],
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "[{\"tipo\":\"padrao\",\"categoria\":\"emocional\",\"titulo\":\"Ciclo Produtividade\",\"icone\":\"ğŸ”„\",\"prioridade\":\"media\",\"resumo_situacao\":\"Resumo\",\"feedback_positivo\":\"Positivo\",\"feedback_desenvolvimento\":\"Desenvolvimento\",\"feedback_motivacional\":\"Motivacional\",\"recursos_sugeridos\":[{\"tipo\":\"tecnica\",\"nome\":\"Nome\",\"descricao\":\"Desc\",\"aplicacao_pratica\":\"AplicaÃ§Ã£o\"}],\"baseado_em\":[\"ev1\"]}]",
        "autoFix": true
      },
      "id": "c959368a-244d-41e4-a810-f3a2258860e2",
      "name": "Parser Insights",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1760,
        1360
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "select tipo, categoria, titulo, descricao, prioridade from insights where usuario_id = $1 limit 15 ",
        "options": {
          "queryReplacement": "={{ $('start').first().json.usuario_id }}"
        }
      },
      "id": "62aae7f8-9da4-400e-91bd-313ecdf3f271",
      "name": "get_user_insight",
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        -1904,
        1344
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- UPSERT insight: 1 registro por chat (sobrescreve)\nWITH insight_data AS (\n  SELECT \n    $1::uuid as usuario_id,\n    $2::uuid as chat_id,\n    elem->>'tipo' as tipo,\n    elem->>'categoria' as categoria,\n    elem->>'titulo' as titulo,\n    elem->>'resumo_situacao' as resumo_situacao,\n    elem->>'icone' as icone,\n    elem->>'prioridade' as prioridade,\n    elem->>'feedback_positivo' as feedback_positivo,\n    elem->>'feedback_desenvolvimento' as feedback_desenvolvimento,\n    elem->>'feedback_motivacional' as feedback_motivacional,\n    elem->'recursos_sugeridos' as recursos_sugeridos,\n    elem->'baseado_em' as baseado_em\n  FROM jsonb_array_elements($3::jsonb) AS elem\n  LIMIT 1\n)\nINSERT INTO insights (\n  usuario_id, chat_id, tipo, categoria, titulo, descricao, icone, prioridade, ativo,\n  resumo_situacao, feedback_positivo, feedback_desenvolvimento, feedback_motivacional,\n  recursos_sugeridos, baseado_em\n)\nSELECT \n  usuario_id, chat_id, tipo, categoria, titulo, resumo_situacao, icone, prioridade, true,\n  resumo_situacao, feedback_positivo, feedback_desenvolvimento, feedback_motivacional,\n  recursos_sugeridos, ARRAY(SELECT jsonb_array_elements_text(baseado_em))\nFROM insight_data\nON CONFLICT (chat_id) DO UPDATE SET\n  tipo = EXCLUDED.tipo,\n  categoria = EXCLUDED.categoria,\n  titulo = EXCLUDED.titulo,\n  descricao = EXCLUDED.descricao,\n  icone = EXCLUDED.icone,\n  prioridade = EXCLUDED.prioridade,\n  resumo_situacao = EXCLUDED.resumo_situacao,\n  feedback_positivo = EXCLUDED.feedback_positivo,\n  feedback_desenvolvimento = EXCLUDED.feedback_desenvolvimento,\n  feedback_motivacional = EXCLUDED.feedback_motivacional,\n  recursos_sugeridos = EXCLUDED.recursos_sugeridos,\n  baseado_em = EXCLUDED.baseado_em,\n  criado_em = NOW()\nRETURNING id, tipo, categoria, titulo, prioridade;",
        "options": {
          "queryReplacement": "={{ [\n  $('start').first().json.usuario_id,\n  $('start').first().json.chat_id,\n  JSON.stringify($json.output || [])\n] }}"
        }
      },
      "id": "3718fa86-03a8-4c03-b6c5-1f710b5a780a",
      "name": "Gravar Insights",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1744,
        1152
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Expert - sabotadores",
        "height": 464,
        "width": 1120,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2384,
        544
      ],
      "id": "1cc76a21-7284-4b7f-99f9-526875686f33",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Expert - Insights",
        "height": 512,
        "width": 768,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2192,
        1072
      ],
      "id": "a6bd7b4c-e2da-4d86-a3e0-f3f92cd659c2",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## Expert - Resumo",
        "height": 672,
        "width": 1552,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4304,
        944
      ],
      "id": "7ea81d72-6b66-495d-9914-81149c3f7194",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analise a conversa e identifique sabotadores internos segundo Shirzad Chamine.\n\n**CONVERSA:**\n```json\n{{ $('start').first().json.mensagens }}\n```\nNome do usuÃ¡rio: {{ $('start').first().json.usr_nome_preferencia }}\n\n**SABOTADORES VÃLIDOS (use APENAS estes cÃ³digos):**\n{{ JSON.stringify($json.catalogo_sabotadores) }}\n\n\n**CRÃTICO: o campo \"codigo\" DEVE ser um nÃºmero de 1 a 10 da lista acima**\n\n**SUA TAREFA:**\n1. Leia APENAS mensagens do usuÃ¡rio (autor: \"usuario\")\n2. Identifique sabotadores ativos (mÃ­nimo intensidade 30)\n3. Para cada sabotador:\n   - sabotador_id: EXATAMENTE um dos IDs da lista acima\n   - Intensidade: 0-100\n   - Contexto: vida_pessoal|profissional|financeiro|relacionamentos|saude|familia\n   - Frases gatilho: 2-4 frases CURTAS (mÃ¡x 15 palavras)\n   - Insights: como impacta (use nome do usuÃ¡rio na 3Âª pessoa)\n   - Confiabilidade: 0-100\n   - Apelido: curto e humanizado (ex: \"Sr. Ansioso\")\n   - Contramedida: UMA aÃ§Ã£o prÃ¡tica\n\n**REGRAS:**\n- Intensidade 0-100 (NÃƒO 0-10)\n- Apenas sabotadores com intensidade â‰¥ 30\n- Se nÃ£o houver sabotadores, retorne array vazio\n- Retorne APENAS JSON estruturado",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=VocÃª Ã© especialista em detectar sabotadores internos segundo Shirzad Chamine.\n\nSeu trabalho:\n1. Identificar padrÃµes de pensamento autodestrutivos\n2. Avaliar intensidades na escala 0-100 (IMPORTANTE: NÃƒO use 0-10)\n3. Extrair TRECHOS CURTOS E ESPECÃFICOS como frases gatilho (nÃ£o textos longos)\n4. Classificar contextos corretamente\n5. Criar apelidos humanizados e contramedidas prÃ¡ticas\n\nREGRA CRÃTICA: Use APENAS os cÃ³digos numÃ©ricos (1-10) da lista abaixo.\nSABOTADORES VÃLIDOS: {{ JSON.stringify($json.catalogo_sabotadores) }}\n\nEscala de intensidade 0-100:\n- 0-20: muito fraca\n- 21-40: fraca\n- 41-60: moderada\n- 61-80: forte\n- 81-100: muito forte\n\nFRASES GATILHO:\n- Devem ser trechos CURTOS (mÃ¡ximo 15 palavras)\n- Extraia 2-4 frases especÃ­ficas que evidenciam o sabotador\n- NÃƒO copie o texto inteiro\n- Exemplo bom: \"me senti desprezado\", \"ela nÃ£o gostava mais de mim\"\n- Exemplo ruim: texto completo de 50+ palavras\n\nSeja criterioso: apenas inclua sabotadores com evidÃªncias claras e intensidade â‰¥ 30.\n\nRetorne SEMPRE JSON vÃ¡lido.",
          "maxIterations": 3
        }
      },
      "id": "228ca688-b746-4853-8e27-79254e6034f5",
      "name": "sabotadores",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -1824,
        640
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=VocÃª Ã© psicÃ³logo especialista em desenvolvimento pessoal. Analise a conversa e contexto validado abaixo.\n\nCONVERSA:\n{{ $('start').first().json.mensagens }}\n\nUsuÃ¡rio: {{ $('start').first().json.usr_nome_preferencia }} | Data: {{ $('start').first().json.data_conversa }}\n\nChame a ferramenta: Â´get_user_insight`\nConsidere tambÃ©m esses ultimos Insights na sua analise\n\nTAREFA: Gere 1 insights acionÃ¡veis com Feedback SanduÃ­che + Recursos PrÃ¡ticos.\nPriorize os pontos mais relevantes identificados na conversa\n\nAnalise os ultimos Insighs anteriores para evitar repetiÃ§Ã£o\n\nESTRUTURA DE CADA INSIGHT:\n1. RESUMO (30-50 palavras): Sintetize estado emocional objetivamente\n2. FEEDBACK SANDUÃCHE:\n   - Positivo (20-30 pal): ReconheÃ§a forÃ§as\n   - Desenvolvimento (30-40 pal): PadrÃ£o que merece atenÃ§Ã£o\n   - Motivacional (20-30 pal): EsperanÃ§a + prÃ³ximos passos\n3. RECURSOS (2-4 itens): tipo, nome, descricao, aplicacao_pratica\n4. TITULO: Gere titulo curto 3 a 4 palavras relevante com contexto principal\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâš ï¸ VALORES PERMITIDOS - USE EXATAMENTE COMO LISTADO âš ï¸\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nCATEGORIA (use APENAS estes valores):\nâœ“ comportamental\nâœ“ emocional\nâœ“ social\nâœ“ cognitivo\nâœ— NUNCA: financeiro, profissional, financeiro-emocional, ou qualquer outro\n\nTIPO INSIGHT (use APENAS estes valores):\nâœ“ padrao\nâœ“ melhoria\nâœ“ positivo\nâœ“ alerta\n\nPRIORIDADE (use APENAS estes valores):\nâœ“ alta\nâœ“ media (SEM acento)\nâœ“ baixa\n\nTIPO RECURSO (use APENAS estes valores):\nâœ“ tecnica\nâœ“ conceito\nâœ“ leitura\nâœ“ pratica\nâœ“ reflexao\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nREGRAS CRÃTICAS:\n- Base TUDO no relatado (sem suposiÃ§Ãµes)\n- Use APENAS os valores listados acima (sem variaÃ§Ãµes, adaptaÃ§Ãµes ou combinaÃ§Ãµes)\n- Seja ESPECÃFICO nas evidÃªncias\n- Recursos PRÃTICOS e aplicÃ¡veis\n- Tom EMPÃTICO mas DIRETO\n- VALIDE cada campo antes de gerar o JSON\n\nANTES DE RETORNAR: Verifique se TODOS os valores de categoria, tipo, prioridade e tipo_recurso estÃ£o EXATAMENTE como listado acima.\n\nRETORNE JSON ARRAY com 1 insights no formato:\n[{\"tipo\":\"padrao\",\"categoria\":\"emocional\",\"titulo\":\"TÃ­tulo\",\"icone\":\"ğŸ”„\",\"prioridade\":\"alta\",\"resumo_situacao\":\"...\",\"feedback_positivo\":\"...\",\"feedback_desenvolvimento\":\"...\",\"feedback_motivacional\":\"...\",\"recursos_sugeridos\":[{\"tipo\":\"tecnica\",\"nome\":\"...\",\"descricao\":\"...\",\"aplicacao_pratica\":\"...\"}],\"baseado_em\":[\"evidÃªncia1\",\"evidÃªncia2\"]}]",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=PsicÃ³logo especialista. Gera insights acionÃ¡veis com feedback sanduÃ­che e recursos prÃ¡ticos. Retorna array JSON com 2-4 insights.",
          "maxIterations": 3
        }
      },
      "id": "c1f2e74a-9efc-4f26-a474-4e1b6f61a6a5",
      "name": "insights",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -2080,
        1168
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=VocÃª Ã© um especialista em anÃ¡lise e sÃ­ntese de conversas.\n\n**NOME DO USUÃRIO:** {{ $('start').item.json.usr_nome_preferencia }}\n\n\n**NOVAS MENSAGENS:**\n{{ JSON.stringify($json.mensagens) }}\n---\n\n**SUA TAREFA:**\n\n1. **ORGANIZAR POR TEMAS**\n   Agrupe as informaÃ§Ãµes nos temas abaixo (use apenas os que tiverem conteÃºdo):\n   - **Emocional**: sentimentos, humor, estado mental\n   - **Trabalho**: carreira, projetos, produtividade\n   - **Relacionamentos**: famÃ­lia, amigos, social\n   - **SaÃºde**: bem-estar fÃ­sico, sono, energia\n   - **FinanÃ§as**: dinheiro, investimentos, trading\n   - **Objetivos**: metas, planos, decisÃµes\n   - **ReflexÃµes**: insights, aprendizados, autoconhecimento\n\n2. **AVALIAR REFLEXÃƒO**\n   - tem_reflexao = true SE o usuÃ¡rio demonstrou autoconhecimento, fez conexÃµes entre eventos e emoÃ§Ãµes, ou analisou seus padrÃµes\n   - tem_reflexao = false SE apenas relatou fatos superficialmente\n\n3. **AVALIAR CONTEXTO**\n   - tem_contexto = true SE hÃ¡ conteÃºdo suficiente para anÃ¡lises de emoÃ§Ãµes, sabotadores, humor\n   - tem_contexto = false SE conversa foi muito superficial ou casual\n\n4. **USUARIO**: Use o nome do usÃ¡rio ao se referir a ele: {{ $('start').item.json.usr_nome_preferencia }}\n\n---\n\n**RETORNE APENAS ESTE JSON:**\n```json\n{\n  \"tem_contexto\": true,\n  \"tem_reflexao\": true,\n  \"total_palavras\": 150,\n  \"justificativa\": \"breve explicaÃ§Ã£o\",\n  \"resumo_atualizado\": \"## Emocional\\n- item 1\\n- item 2\\n\\n## Trabalho\\n- item 1\\n\\n## ReflexÃµes\\n- insight importante\"\n}\n```",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=VocÃª Ã© um especialista em anÃ¡lise e sÃ­ntese de conversas terapÃªuticas e de desenvolvimento pessoal.\n\nREGRAS CRÃTICAS:\n1. NUNCA substitua o resumo anterior - sempre INCORPORE\n2. Elimine redundÃ¢ncias - nÃ£o repita informaÃ§Ãµes jÃ¡ presentes\n3. Organize SEMPRE por temas usando markdown (## Tema)\n4. Seja objetivo e direto\n5. MÃ¡ximo de 800 palavras no resumo total\n6. Preserve contexto emocional e insights importantes\n7. Retorne APENAS JSON estruturado\n8. nÃ£o use o termo usuÃ¡rio, use sempre o nome do contexto\n9. nÃ£o use o termo agente, use sempre Mentor"
        }
      },
      "id": "5907bd75-9a96-4504-8489-77f7635835c8",
      "name": "resumo conversa",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -3872,
        1120
      ]
    },
    {
      "parameters": {
        "content": "## Expert - PANAS + emoÃ§Ãµes",
        "height": 480,
        "width": 768,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2208,
        1648
      ],
      "id": "e73118df-fc7c-4633-bb7c-e26d0f250abb",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "## Expert - Big Five",
        "height": 464,
        "width": 1248
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2192,
        16
      ],
      "id": "1ad42a75-666f-40a1-9d83-f09226335794",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Use a conversa ATUAL como fonte principal e estime o perfil Big Five (OCEAN), tratando o histÃ³rico recente apenas como contexto complementar.\n\n**HISTÃ“RICO (resumos Ãºltimos 5 dias):**\n{{ $json.historico_resumo }}\n\n**CONVERSA ATUAL (JSON):**\n```json\n{{ $json.mensagens }}\n```\n**Nome do usuÃ¡rio:** {{ $json.usr_nome_preferencia }}\n\n**SEU OBJETIVO**\n1) Identificar sinais claros e textuais na conversa atual para cada traÃ§o: Openness, Conscientiousness, Extraversion, Agreeableness, Neuroticism.\n2) Atribuir **score 0-100** por traÃ§o (escala contÃ­nua; 50 = neutro/mediano).\n3) Extrair **EVIDÃŠNCIAS** em 2-4 trechos curtos (mÃ¡x. 15 palavras cada) da conversa atual para cada traÃ§o.\n4) Estimar **confiabilidade (0-100)** por traÃ§o, baseada na quantidade/clareza das evidÃªncias.\n5) Determinar **perfil_primario** = traÃ§o com maior score (se diferenÃ§a <5 pontos entre o 1Âº e 2Âº, retorne \"misto\").\n6) Produzir um **resumo_perfil** (mÃ¡x. 400 caracteres) em linguagem acessÃ­vel e nÃ£o-clÃ­nica, coerente com o MindQuest.\n7) Se as evidÃªncias forem insuficientes para qualquer traÃ§o, retorne score=50 e confiabilidade â‰¤ 40 para aquele traÃ§o.\n\n**REGRAS CRÃTICAS**\n- Leia APENAS mensagens com `autor = \"usuario\"` da conversa atual.\n- Utilize o histÃ³rico somente para reconhecer padrÃµes, mas NÃƒO use trechos do histÃ³rico como evidÃªncia literal.\n- **ProÃ­ba suposiÃ§Ãµes**: nÃ£o invente fatos nÃ£o ditos; use somente trechos literais da conversa atual.\n- **Escala obrigatÃ³ria 0-100** para scores e confiabilidade.\n- Mantenha saÃ­das em **portuguÃªs**.\n- **NÃƒO** faÃ§a diagnÃ³sticos clÃ­nicos. Foco descritivo, orientado a autoconhecimento.\n- Retorne **APENAS JSON vÃ¡lido**, no formato definido em \"FORMATO DE SAÃDA\".\n\n**CRITÃ‰RIOS DE INTERPRETAÃ‡ÃƒO (guia resumido)**\n- **Openness (Abertura):** curiosidade, ideias novas, explorar possibilidades; baixo: preferÃªncia por rotina.\n- **Conscientiousness (Conscienciosidade):** organizaÃ§Ã£o, disciplina, plano/execuÃ§Ã£o; baixo: impulsividade, procrastinaÃ§Ã£o.\n- **Extraversion (ExtroversÃ£o):** energia social, busca de estÃ­mulos/contato; baixo: reserva, foco interno.\n- **Agreeableness (Amabilidade):** empatia, cooperaÃ§Ã£o; baixo: assertividade dura, conflito, ceticismo.\n- **Neuroticism (Neuroticismo):** sensibilidade a estresse, ansiedade/ruminaÃ§Ã£o; baixo: estabilidade emocional.\n\n**FORMATO DE SAÃDA (JSON):**\n{\n  \"big_five\": {\n    \"openness\": {\n      \"score\": 0,\n      \"confiabilidade\": 0,\n      \"evidencias\": [\"...\", \"...\"]\n    },\n    \"conscientiousness\": {\n      \"score\": 0,\n      \"confiabilidade\": 0,\n      \"evidencias\": [\"...\", \"...\"]\n    },\n    \"extraversion\": {\n      \"score\": 0,\n      \"confiabilidade\": 0,\n      \"evidencias\": [\"...\", \"...\"]\n    },\n    \"agreeableness\": {\n      \"score\": 0,\n      \"confiabilidade\": 0,\n      \"evidencias\": [\"...\", \"...\"]\n    },\n    \"neuroticism\": {\n      \"score\": 0,\n      \"confiabilidade\": 0,\n      \"evidencias\": [\"...\", \"...\"]\n    }\n  },\n  \"perfil_primario\": \"openness|conscientiousness|extraversion|agreeableness|neuroticism|misto\",\n  \"resumo_perfil\": \"texto curto e nÃ£o clÃ­nico\",\n  \"insuficiente\": false\n}\n\n**NOTAS DE QUALIDADE**\n- Se a conversa for pobre em pistas, defina `insuficiente = true` e mantenha scores prÃ³ximos de 50 com baixa confiabilidade.\n- \"EvidÃªncias\" DEVEM ser trechos literais e curtos da conversa atual (nÃ£o use o histÃ³rico).",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=VocÃª Ã© um assistente especialista em Big Five (OCEAN) e Ã©tica em IA. Sua funÃ§Ã£o Ã© inferir tendÃªncias de personalidade com base EXCLUSIVAMENTE em trechos literais do usuÃ¡rio. Siga estes princÃ­pios:\n1) PrecisÃ£o e parcimÃ´nia: sem extrapolaÃ§Ãµes. Use apenas o que estÃ¡ escrito.\n2) TransparÃªncia: inclua evidÃªncias curtas (2-4) por traÃ§o.\n3) Escalas contÃ­nuas 0-100 para score e confiabilidade (50 = neutro; 0-20 muito baixo; 80-100 muito alto).\n4) ComunicaÃ§Ã£o responsÃ¡vel: linguagem acessÃ­vel, nÃ£o clÃ­nica, acolhedora.\n5) Se faltarem sinais para um traÃ§o, use score=50, confiabilidade â‰¤ 40 e marque `insuficiente=true` se a conversa inteira nÃ£o sustentar inferÃªncia.\nRetorne SEMPRE JSON vÃ¡lido no formato solicitado.",
          "maxIterations": 3
        }
      },
      "id": "8e512726-9734-4f31-bd24-f6d783225fdb",
      "name": "Big Five",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -1696,
        112
      ]
    },
    {
      "parameters": {
        "content": "## Expert - Humor e energia",
        "height": 480,
        "width": 768,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2208,
        2176
      ],
      "id": "e7374f35-9119-40d2-a928-044d8fc60077",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analise a conversa completa abaixo e detecte o HUMOR e ENERGIA do usuÃ¡rio com base APENAS no que foi dito.\n\n**CONVERSA COMPLETA:**\n```json\n{{ $('start').first().json.mensagens }}\n```\n\nUser name: {{ $('start').first().json.usr_nome_preferencia }}\n\n**SUA TAREFA:**\n1. Leia TODA a conversa (autor: \"usuario\" apenas)\n2. Detecte o HUMOR GERAL do dia (1-10):\n   - 1-3: muito negativo (tristeza profunda, desesperanÃ§a)\n   - 4-5: negativo (desÃ¢nimo, frustraÃ§Ã£o)\n   - 6-7: neutro/misto (altos e baixos)\n   - 8-9: positivo (animado, esperanÃ§oso)\n   - 10: muito positivo (eufÃ³rico, excelente)\n\n3. Detecte o NÃVEL DE ENERGIA (1-10):\n   - 1-3: exausto, sem forÃ§as\n   - 4-5: cansado, baixa energia\n   - 6-7: energia moderada\n   - 8-9: disposto, energizado\n   - 10: muito energizado, hiperativo\n\n4. Identifique VARIAÃ‡ÃƒO durante a conversa:\n   - estavel: humor/energia constante\n   - ascendente: melhora ao longo da conversa\n   - descendente: piora ao longo da conversa\n   - oscilatoria: alterna muito\n\n5. Detecte PERÃODO DO DIA (se mencionado):\n   - manha, tarde, noite, madrugada\n   - Se nÃ£o mencionado: \"nao_identificado\"\n\n**REGRAS:**\n- Base a anÃ¡lise APENAS nas palavras do usuÃ¡rio\n- Considere: tom emocional, vocabulÃ¡rio, descriÃ§Ãµes de atividades\n- Seja preciso e realista\n- Justifique brevemente cada score\n- Ao gerar a justificativa e resumo das conversas relacionados com o humor, use sempre o nome do usuÃ¡rio: {{ $('start').first().json.usr_nome_preferencia }}\n- Caso o nome do usuÃ¡rio nÃ£o seja informado, use o termo UsuÃ¡rio\n**RETORNE APENAS O JSON ESTRUTURADO**",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=VocÃª Ã© um especialista em anÃ¡lise de humor e energia em conversas.\n\nSeu trabalho Ã©:\n1. Detectar o humor geral do dia (escala 1-10)\n2. Avaliar o nÃ­vel de energia (escala 1-10)\n3. confianca_analise de 0 a 100\n4. Identificar variaÃ§Ãµes durante a conversa\n5. Capturar perÃ­odo do dia se mencionado\n\nSeja objetivo, baseie-se apenas no texto real, e justifique suas avaliaÃ§Ãµes de forma breve.\n\nRetorne SEMPRE um JSON vÃ¡lido com a estrutura exata solicitada.",
          "maxIterations": 3
        }
      },
      "id": "c0bbaacc-d4a3-4d0b-bef9-36e7ca9408ff",
      "name": "humor e energia",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -2080,
        2256
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### User Prompt  \nDADOS DA CONVERSA:  \nMensagens: {{ $('start').first().json.mensagens }}\n\nExecute a anÃ¡lise emocional conforme descrito no System Prompt identifique todas as emoÃ§Ãµes de Plutchik presentes, atribua intensidade, contexto e evidÃªncia, e entÃ£o classifique o sentimento global da conversa como POSITIVA, NEGATIVA ou NEUTRA. Retorne **somente** o JSON estruturado conforme as regras.\n\n",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=### System Prompt â€” Classificador Emocional (Plutchik + PANAS)\n\nVocÃª Ã© um especialista em anÃ¡lise emocional com base nas **oito emoÃ§Ãµes primÃ¡rias de Robert Plutchik** e em agregaÃ§Ã£o de afeto inspirada no **PANAS**.\n\n---\n\n#### ğŸ¯ Objetivo\nLer **todas as mensagens da conversa** e identificar **as emoÃ§Ãµes primÃ¡rias presentes**, classificando-as conforme o modelo Plutchik e agregando o resultado segundo a escala PANAS.\n\n---\n\n#### ğŸ§  Tarefa passo a passo\n1. Analise **todas as mensagens** fornecidas.\n2. Detecte quais emoÃ§Ãµes primÃ¡rias estÃ£o presentes (apenas as listadas abaixo).\n3. Para cada emoÃ§Ã£o detectada, retorne os campos:\n   - `emocao_id`: slug obrigatÃ³rio (ver **VocabulÃ¡rio permitido**).\n   - `intensidade`: nÃºmero inteiro de **0 a 100**.\n   - `contexto`: valor fixo (**POSITIVA**, **NEGATIVA** ou **NEUTRA**) conforme tabela de polaridade.\n   - `evidencias`: lista de **trechos literais da conversa** (1â€“5 itens) que justifiquem a detecÃ§Ã£o.\n\n4. ApÃ³s listar todas as emoÃ§Ãµes, gere um objeto `classificacao_geral` conforme as regras PANAS descritas abaixo.\n\n---\n\n#### ğŸ”¤ VocabulÃ¡rio permitido\n| emocao_id | Nome (PT)      | Polaridade |\n|------------|----------------|-------------|\n| joy        | Alegria        | POSITIVA    |\n| trust      | ConfianÃ§a      | POSITIVA    |\n| anticipation| Expectativa   | POSITIVA    |\n| sadness    | Tristeza       | NEGATIVA    |\n| fear       | Medo           | NEGATIVA    |\n| anger      | Raiva          | NEGATIVA    |\n| disgust    | Nojo           | NEGATIVA    |\n| surprise   | Surpresa       | NEUTRA      |\n\n> **ProibiÃ§Ã£o:** Nenhum outro valor alÃ©m dos 8 acima pode aparecer em `emocao_id`.\n\n---\n\n#### âš–ï¸ Mapeamento de polaridade\nUse **apenas** os seguintes contextos fixos:\n- POSITIVA â†’ joy, trust, anticipation  \n- NEGATIVA â†’ sadness, fear, anger, disgust  \n- NEUTRA â†’ surprise  \n\n> O `contexto` nÃ£o Ã© inferido do tom, e sim **determinado diretamente** pela emoÃ§Ã£o.\n\n---\n\n#### ğŸ“Š Regras de agregaÃ§Ã£o e classificaÃ§Ã£o global\n- Somente emoÃ§Ãµes com `intensidade â‰¥ 45` participam do cÃ¡lculo PANAS.  \n- Contagens:\n  - `positivas`: nÂº de emoÃ§Ãµes POSITIVAS\n  - `negativas`: nÂº de emoÃ§Ãµes NEGATIVAS\n  - `neutras`: nÂº de emoÃ§Ãµes NEUTRAS  \n  - `total`: soma de todas\n- Percentuais (0â€“100, uma casa decimal):  \n  - `percentual_positivas = positivas / total * 100`  \n  - `percentual_negativas = negativas / total * 100`  \n  - `percentual_neutras = neutras / total * 100`\n- Se `total = 0`, todos os valores devem ser 0 e `classificacao_global = \"NEUTRA\"`.\n- Regras PANAS:\n  - Se a diferenÃ§a entre `percentual_positivas` e `percentual_negativas` for **menor que 20%**, classifique como **NEUTRA**.  \n  - Caso contrÃ¡rio, prevalece o maior percentual: **POSITIVA** ou **NEGATIVA**.\n\n---\n\n#### ğŸ§© Regras adicionais\n- Sempre use o campo `emocao_id` com **um dos slugs permitidos**.  \n- Se detectar nuances como **culpa**, **vergonha**, **orgulho**, **ansiedade** ou **gratidÃ£o**, mapeie para a emoÃ§Ã£o primÃ¡ria **mais prÃ³xima** (ex.: culpa â†’ tristeza, orgulho â†’ alegria).  \n- Antes de responder, **revise toda a lista `emocoes_detectadas`**:\n  - Se algum item estiver fora do vocabulÃ¡rio permitido, **corrija ou remova**.  \n  - Garanta que `intensidade` esteja entre 0 e 100.  \n  - Garanta que `contexto` corresponda Ã  polaridade da emoÃ§Ã£o.  \n  - Garanta que `evidencias` seja um **array literal de frases reais**.  \n\n---\n\n#### ğŸ§¾ Boas prÃ¡ticas\n- Detecte cada emoÃ§Ã£o **no mÃ¡ximo uma vez**. Consolide mÃºltiplas ocorrÃªncias em um Ãºnico item, somando intensidade e reunindo as evidÃªncias mais fortes.  \n- Ordene `emocoes_detectadas` por `intensidade` **decrescente**.  \n- Evite interpretaÃ§Ãµes ou narrativas; apenas relacione evidÃªncias textuais.\n\n---\n\n#### ğŸ§® Estrutura de saÃ­da esperada\nRetorne **somente um JSON vÃ¡lido**, sem texto livre, Markdown ou comentÃ¡rios.",
          "maxIterations": 5
        }
      },
      "id": "f03a73bc-5a1f-40b9-992a-52eddf5bdeb1",
      "name": "panas e emocoes",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -2080,
        1712
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "W0i3ufnDIIcx75ez",
          "mode": "list",
          "cachedResultUrl": "/workflow/W0i3ufnDIIcx75ez",
          "cachedResultName": "sw_xp_conversas_v2"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "total_interactions": "={{ $('start').item.json.total_interactions }}",
            "usuario_id": "={{ $('start').first().json.usuario_id }}",
            "chat_id": "={{ $('start').first().json.chat_id }}",
            "data_conversa": "={{ $('start').first().json.data_conversa }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data_conversa",
              "displayName": "data_conversa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "total_interactions",
              "displayName": "total_interactions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number"
            }
          ],
          "attemptToConvertTypes": true,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "3f51ad19-d79d-4cf5-a26c-f51f642248b1",
      "name": "Executar XP Conversas",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -2528,
        112
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "LKjU8NE9aNHw7kEh",
          "mode": "list",
          "cachedResultUrl": "/workflow/LKjU8NE9aNHw7kEh",
          "cachedResultName": "sw_criar_quest"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $('start').first().json.usuario_id }}",
            "chat_id": "={{ $('start').first().json.chat_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": true,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -912,
        704
      ],
      "id": "94c4e015-9790-4605-9c67-5029f5b960f3",
      "name": "Executar Expert Quests"
    },
    {
      "parameters": {
        "content": "## Expert - Criar quest",
        "height": 464,
        "width": 816,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1216,
        544
      ],
      "id": "6e52ad91-b3d4-453a-a8b0-37c8d57b0550",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "jsCode": "// Retorna status indicando que NÃƒO processou\nconst input = $input.first().json;\nreturn [{\n  processado: false,\n  motivo: input.validacao?.motivo || 'Contexto insuficiente',\n  chat_id: input.chat_id,\n  total_interactions: input.total_interactions\n}];"
      },
      "id": "cf09090a-be4c-4d63-b71a-fb1482be1e24",
      "name": "contexto_insuficiente",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3296,
        1328
      ]
    },
    {
      "parameters": {
        "content": "## Expert - Sabotadores\n\n### Regras de PersistÃªncia\n- **Chave Ãºnica:** `(usuario_id, sabotador_id, chat_id)`\n- **Constraint:** `usuarios_sabotadores_unique_por_chat`\n\n### Comportamento UPSERT\n| Campo | INSERT | UPDATE |\n|-------|--------|--------|\n| `total_deteccoes_dia` | 1 | +1 |\n| `total_deteccoes` | 1 | +1 |\n| `intensidade_acumulada_dia` | valor | soma |\n| `intensidade_media` | valor | recalcula mÃ©dia |\n| `contexto/insight/contramedida` | valor | mantÃ©m se intensidade maior |\n\n### Filtros\n- Intensidade mÃ­nima: **30**\n- Apenas sabotadores do catÃ¡logo vÃ¡lido\n*/\n",
        "height": 672,
        "width": 656
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1216,
        1072
      ],
      "id": "7e454871-024e-4807-8cab-bf2a9b2e5ca4",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- v3: DELETE dados anteriores do chat antes de reprocessar\nDELETE FROM usuarios_sabotadores WHERE id = $1::uuid;\nDELETE FROM usuarios_emocoes WHERE id = $1::uuid;\nDELETE FROM usuarios_humor_energia WHERE id = $1::uuid;\nDELETE FROM usuarios_perfis WHERE id = $1::uuid;\nDELETE FROM insights WHERE id = $1::uuid;\n-- DELETE quests do usuÃ¡rio criadas hoje que nÃ£o tÃªm recorrÃªncias\nDELETE FROM usuarios_quest uq\nWHERE uq.usuario_id = $2::uuid \n  AND uq.status = 'disponivel'\n  AND DATE(uq.ativado_em) = CURRENT_DATE\n  AND NOT EXISTS (\n    SELECT 1 FROM quests_recorrencias qr \n    WHERE qr.usuarios_quest_id = uq.id\n  );",
        "options": {
          "queryReplacement": "={{ $('start').first().json.chat_id }},{{ $('start').first().json.usuario_id }}"
        }
      },
      "id": "4dcd69f2-0c4d-4b6f-bbf1-fcf507e1643b",
      "name": "DELETE Dados Anteriores",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2832,
        576
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// v3: Retorna sucesso\nconst trigger = $('start').first().json;\nreturn [{\n  json: {\n    processado: true,\n    motivo: 'OK',\n    chat_id: trigger.chat_id\n  }\n}];"
      },
      "id": "61a53a57-bcc5-4071-bc74-3f6b057b4c01",
      "name": "Retorno Sucesso",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2960,
        1088
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Atualizar usr_chat com resumo e status\nUPDATE usr_chat SET\n  resumo_conversa = $2,\n  tem_reflexao = $3,\n  total_palavras_usuario = COALESCE(total_palavras_usuario, 0) + $4,\n  status = 'finalizado',\n  horario_fim = NOW(),\n  atualizado_em = NOW()\nWHERE id = $1::uuid\nRETURNING id, status;",
        "options": {
          "queryReplacement": "={{ [\n  $('start').first().json.chat_id,\n  $('resumo conversa').first().json.output.resumo_atualizado,\n  $('resumo conversa').first().json.output.tem_reflexao,\n  $('resumo conversa').first().json.output.total_palavras_delta || 0\n] }}"
        }
      },
      "id": "3fa57a00-926d-4c45-8288-b20608205df2",
      "name": "Atualizar usr_chat",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3200,
        1088
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "content": "## sw_experts_v3 - Simplificado\n\n### Mudancas da v2\n- DELETE antes de INSERT (sem UPSERT)\n- Sem log_experts\n- Sem delta de mensagens\n- Processa conversa COMPLETA\n\n### Fluxo\n1. Recebe conversa completa\n2. Gera resumo (valida contexto)\n3. SE tem_contexto:\n   - DELETE dados anteriores do chat\n   - Executa experts em paralelo\n   - Atualiza usr_chat\n4. Retorna processado true/false\n\n### Experts\n- Sabotadores\n- PANAS/Emocoes\n- Humor/Energia\n- Big Five\n- Insights\n- Criar Quest (apos sabotadores)",
        "height": 932,
        "width": 300
      },
      "id": "5421d17b-b3ed-489c-ae54-bdbe39ee646c",
      "name": "Regras sw_experts_v3",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4896,
        784
      ]
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Buscar Dados Chat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Dados Chat": {
      "main": [
        [
          {
            "node": "resumo conversa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Resumo": {
      "ai_languageModel": [
        [
          {
            "node": "resumo conversa",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parser Resumo": {
      "ai_outputParser": [
        [
          {
            "node": "resumo conversa",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Tem Contexto?": {
      "main": [
        [
          {
            "node": "DELETE Dados Anteriores",
            "type": "main",
            "index": 0
          },
          {
            "node": "Atualizar usr_chat",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "contexto_insuficiente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar CatÃ¡logo Sabotadores": {
      "main": [
        [
          {
            "node": "sabotadores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Sabotadores": {
      "ai_languageModel": [
        [
          {
            "node": "sabotadores",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Parser Sabotadores",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parser Sabotadores": {
      "ai_outputParser": [
        [
          {
            "node": "sabotadores",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Gravar Sabotadores": {
      "main": [
        [
          {
            "node": "Executar Expert Quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM PANAS": {
      "ai_languageModel": [
        [
          {
            "node": "panas e emocoes",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Parser PANAS",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parser PANAS": {
      "ai_outputParser": [
        [
          {
            "node": "panas e emocoes",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "LLM Humor": {
      "ai_languageModel": [
        [
          {
            "node": "humor e energia",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Parser Humor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parser Humor": {
      "ai_outputParser": [
        [
          {
            "node": "humor e energia",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Buscar HistÃ³rico BigFive": {
      "main": [
        [
          {
            "node": "Preparar Contexto BigFive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Contexto BigFive": {
      "main": [
        [
          {
            "node": "Big Five",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM BigFive": {
      "ai_languageModel": [
        [
          {
            "node": "Big Five",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Parser BigFive",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parser BigFive": {
      "ai_outputParser": [
        [
          {
            "node": "Big Five",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Registro BigFive": {
      "main": [
        [
          {
            "node": "Gravar BigFive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Insights": {
      "ai_languageModel": [
        [
          {
            "node": "insights",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Parser Insights",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parser Insights": {
      "ai_outputParser": [
        [
          {
            "node": "insights",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "get_user_insight": {
      "ai_tool": [
        [
          {
            "node": "insights",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "sabotadores": {
      "main": [
        [
          {
            "node": "Gravar Sabotadores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "insights": {
      "main": [
        [
          {
            "node": "Gravar Insights",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "resumo conversa": {
      "main": [
        [
          {
            "node": "Tem Contexto?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Big Five": {
      "main": [
        [
          {
            "node": "Preparar Registro BigFive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "humor e energia": {
      "main": [
        [
          {
            "node": "Gravar Humor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "panas e emocoes": {
      "main": [
        [
          {
            "node": "Gravar EmoÃ§Ãµes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DELETE Dados Anteriores": {
      "main": [
        [
          {
            "node": "Executar XP Conversas",
            "type": "main",
            "index": 0
          },
          {
            "node": "Buscar HistÃ³rico BigFive",
            "type": "main",
            "index": 0
          },
          {
            "node": "Buscar CatÃ¡logo Sabotadores",
            "type": "main",
            "index": 0
          },
          {
            "node": "insights",
            "type": "main",
            "index": 0
          },
          {
            "node": "panas e emocoes",
            "type": "main",
            "index": 0
          },
          {
            "node": "humor e energia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar usr_chat": {
      "main": [
        [
          {
            "node": "Retorno Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": {
    "start": [
      {
        "json": {
          "usuario_id": "21187ef1-9728-4a92-b6fc-35b3dac100cb",
          "chat_id": "8e5d0f7b-0d86-4349-b5f7-56fae461ecb7",
          "data_conversa": "2025-12-16T00:00:00.000Z",
          "usr_nome_preferencia": "Marcello"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "activeVersionId": null,
  "shared": [
    {
      "createdAt": "2025-12-15T23:15:20.309Z",
      "role": "workflow:owner",
      "workflowId": "DztMpxVJw7Mvfke8",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [],
  "activeVersion": null
}
