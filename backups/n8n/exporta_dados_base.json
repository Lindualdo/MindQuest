{
  "createdAt": "2025-11-03T09:13:55.708Z",
  "id": "04S47KA7EIbiJZBA",
  "name": "exporta dados base",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -272,
        -48
      ],
      "id": "d8049be7-7253-4013-bc97-b3c53ba40dbe",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "quest_catalogo",
          "mode": "list",
          "cachedResultName": "quest_catalogo"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -64,
        -48
      ],
      "id": "04b12cf0-77d0-4fc6-ba50-4e5b82781a86",
      "name": "Quest catalogo",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "quest_estado_usuario",
          "mode": "list",
          "cachedResultName": "quest_estado_usuario"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "usuario_id",
              "value": "1d74e1c4-a42c-4641-8db9-da3b80b8dbff"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        160,
        -48
      ],
      "id": "714ca14a-503d-4de2-bfe2-0c42715d4252",
      "name": "estado usuario",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "quest_instancias",
          "mode": "list",
          "cachedResultName": "quest_instancias"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "usuario_id",
              "value": "d949d81c-9235-41ce-8b3b-6b5d593c5e24"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        384,
        -48
      ],
      "id": "97405d4f-453e-43a8-8a25-741a500c621c",
      "name": "quest instancias",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "usuarios_sabotadores",
          "mode": "list",
          "cachedResultName": "usuarios_sabotadores"
        },
        "limit": 10,
        "where": {
          "values": [
            {
              "column": "usuario_id",
              "value": "d949d81c-9235-41ce-8b3b-6b5d593c5e24"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "data_ultima_atividade",
              "direction": "DESC"
            },
            {
              "column": "atualizado_em",
              "direction": "DESC"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        608,
        -48
      ],
      "id": "eec3a8a1-9801-4fd2-af32-d025c1fc7e7f",
      "name": "sabotadores",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH params AS (\n  SELECT '1d74e1c4-a42c-4641-8db9-da3b80b8dbff'::uuid AS usuario_id\n),\nestado AS (\n  SELECT\n    q.usuario_id,\n    q.xp_total,\n    q.total_xp_hoje,\n    q.sequencia_atual,\n    q.sequencia_recorde,\n    q.meta_sequencia_codigo,\n    q.proxima_meta_codigo,\n    q.ultima_conversa_em,\n    q.sequencia_status,\n    q.atualizado_em\n  FROM public.quest_estado_usuario q\n  JOIN params p ON p.usuario_id = q.usuario_id\n)\nSELECT jsonb_build_object(\n  'estado', to_jsonb(e),\n  'conversas', COALESCE(conv.conversas, '[]'::jsonb)\n) AS diagnostico\nFROM estado e\nCROSS JOIN LATERAL (\n  SELECT jsonb_agg(\n           jsonb_build_object(\n             'id', uc.id,\n             'data_conversa', uc.data_conversa,\n             'atualizado_em', uc.atualizado_em,\n             'tem_reflexao', uc.tem_reflexao,\n             'total_palavras_usuario', COALESCE(uc.total_palavras_usuario, 0)\n           )\n           ORDER BY uc.data_conversa, uc.atualizado_em\n         ) AS conversas\n  FROM public.usr_chat uc\n  JOIN params p ON p.usuario_id = uc.usuario_id\n  WHERE uc.data_conversa >= NOW() - INTERVAL '30 days'\n) conv;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        832,
        -48
      ],
      "id": "adcf625e-909d-4429-ac34-7e4218c98621",
      "name": "Insights",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "quest_estado_usuario",
          "mode": "list",
          "cachedResultName": "quest_estado_usuario"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "usuario_id",
              "value": "d949d81c-9235-41ce-8b3b-6b5d593c5e24"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -64,
        160
      ],
      "id": "e5c41c26-0c46-40db-8fa8-909174656334",
      "name": "Gamificacao",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "quest_modelos",
          "mode": "list",
          "cachedResultName": "quest_modelos"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        240,
        160
      ],
      "id": "b05e0157-1580-4923-9f8c-55e381bbb5f7",
      "name": "quest modelo",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH estado AS (\n  SELECT\n    usuario_id,\n    xp_total,\n    total_xp_hoje,\n    sequencia_atual,\n    sequencia_recorde,\n    meta_sequencia_codigo,\n    proxima_meta_codigo,\n    ultima_conversa_em,\n    sequencia_status\n  FROM public.quest_estado_usuario\n  WHERE usuario_id = $1::uuid\n),\nconversas AS (\n  SELECT\n    uc.id,\n    uc.usuario_id,\n    uc.data_conversa::date AS dia,\n    uc.atualizado_em,\n    COALESCE(uc.total_palavras_usuario, 0) AS palavras,\n    COALESCE(uc.tem_reflexao, false) AS tem_reflexao,\n    CASE\n      WHEN COALESCE(uc.total_palavras_usuario, 0) >= 500 THEN 50\n      WHEN COALESCE(uc.tem_reflexao, false)           THEN 35\n      ELSE 20\n    END AS xp_base\n  FROM public.usr_chat uc\n  WHERE uc.usuario_id = $1::uuid\n    AND uc.data_conversa >= now() - INTERVAL '45 days'\n),\nnovas AS (\n  SELECT\n    c.*,\n    CASE\n      WHEN e.ultima_conversa_em IS NULL THEN true\n      WHEN c.dia > date(e.ultima_conversa_em) THEN true\n      WHEN c.dia = date(e.ultima_conversa_em)\n           AND c.atualizado_em > e.ultima_conversa_em THEN true\n      ELSE false\n    END AS conversa_nova\n  FROM conversas c\n  CROSS JOIN estado e\n),\ndias AS (\n  SELECT DISTINCT dia\n  FROM novas\n  WHERE conversa_nova\n),\nstreaks AS (\n  SELECT\n    dia,\n    ROW_NUMBER() OVER (PARTITION BY bloco ORDER BY dia) AS streak_len\n  FROM (\n    SELECT\n      dia,\n      SUM(nova_serie) OVER (ORDER BY dia\n        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS bloco\n    FROM (\n      SELECT\n        dia,\n        CASE\n          WHEN lag(dia) OVER (ORDER BY dia) = dia - INTERVAL '1 day' THEN 0\n          ELSE 1\n        END AS nova_serie\n      FROM dias\n    ) s\n  ) x\n),\nmetas AS (\n  SELECT *\n  FROM (VALUES\n    ('streak_003',3,40),\n    ('streak_007',7,90),\n    ('streak_010',10,130),\n    ('streak_015',15,180),\n    ('streak_020',20,250),\n    ('streak_025',25,340),\n    ('streak_030',30,450)\n  ) AS m(codigo,dias,bonus)\n),\nmetas_atingidas AS (\n  SELECT\n    s.dia,\n    m.codigo,\n    m.dias,\n    m.bonus\n  FROM streaks s\n  JOIN metas m ON s.streak_len = m.dias\n  JOIN novas n ON n.dia = s.dia\n  WHERE EXISTS (\n    SELECT 1\n    FROM novas nn\n    WHERE nn.dia = s.dia\n      AND nn.conversa_nova\n  )\n),\nagregado AS (\n  SELECT json_build_object(\n    'estado', (SELECT row_to_json(estado) FROM estado),\n    'xp_por_conversa', COALESCE(json_agg(\n      json_build_object(\n        'chat_id', n.id,\n        'dia', n.dia,\n        'palavras', n.palavras,\n        'tem_reflexao', n.tem_reflexao,\n        'xp_base', n.xp_base,\n        'conversa_nova', n.conversa_nova\n      )\n      ORDER BY n.dia, n.atualizado_em\n    ), '[]'::json),\n    'xp_total_conversas_novas', COALESCE(SUM(n.xp_base) FILTER (WHERE n.conversa_nova), 0),\n    'streaks', COALESCE(json_agg(\n      json_build_object(\n        'dia', s.dia,\n        'tamanho', s.streak_len\n      )\n      ORDER BY s.dia\n    ) FILTER (WHERE s.dia IS NOT NULL), '[]'::json),\n    'metas_atingidas', COALESCE(json_agg(\n      json_build_object(\n        'dia', ma.dia,\n        'codigo', ma.codigo,\n        'bonus', ma.bonus\n      )\n      ORDER BY ma.dia\n    ) FILTER (WHERE ma.dia IS NOT NULL), '[]'::json),\n    'janela_analisada', json_build_object(\n      'inicio', (SELECT MIN(dia) FROM conversas),\n      'fim',    (SELECT MAX(dia) FROM conversas)\n    )\n  ) AS auditoria\n  FROM novas n\n  LEFT JOIN streaks s ON s.dia = n.dia\n  LEFT JOIN metas_atingidas ma ON ma.dia = n.dia\n)\nSELECT auditoria FROM agregado;\n",
        "options": {
          "queryReplacement": "=0847d8a7-4fba-45f2-9470-a7eeacaa4bd4"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        512,
        160
      ],
      "id": "90004298-d72a-4f42-8c41-acad0fed9bda",
      "name": "valida pontuação",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    }
  ],
  "connections": {
    "When clicking ‘Execute workflow’": {
      "main": [
        []
      ]
    },
    "Quest catalogo": {
      "main": [
        []
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "d41391fc-1ac9-4817-abb7-c8af84bcdf7c",
  "triggerCount": 0,
  "shared": [
    {
      "createdAt": "2025-11-03T09:13:55.708Z",
      "role": "workflow:owner",
      "workflowId": "04S47KA7EIbiJZBA",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}
