{
  "createdAt": "2025-11-03T09:13:55.708Z",
  "id": "04S47KA7EIbiJZBA",
  "name": "exporta dados base",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        160,
        -64
      ],
      "id": "d8049be7-7253-4013-bc97-b3c53ba40dbe",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "quest_catalogo",
          "mode": "list",
          "cachedResultName": "quest_catalogo"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        368,
        -64
      ],
      "id": "04b12cf0-77d0-4fc6-ba50-4e5b82781a86",
      "name": "Quest catalogo",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "usuarios_conquistas",
          "mode": "list",
          "cachedResultName": "usuarios_conquistas"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        592,
        -64
      ],
      "id": "714ca14a-503d-4de2-bfe2-0c42715d4252",
      "name": "estado usuario",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "quest_instancias",
          "mode": "list",
          "cachedResultName": "quest_instancias"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "usuario_id",
              "value": "d949d81c-9235-41ce-8b3b-6b5d593c5e24"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        816,
        -64
      ],
      "id": "97405d4f-453e-43a8-8a25-741a500c621c",
      "name": "quest instancias",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "usuarios_sabotadores",
          "mode": "list",
          "cachedResultName": "usuarios_sabotadores"
        },
        "limit": 10,
        "where": {
          "values": [
            {
              "column": "usuario_id",
              "value": "d949d81c-9235-41ce-8b3b-6b5d593c5e24"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "data_ultima_atividade",
              "direction": "DESC"
            },
            {
              "column": "atualizado_em",
              "direction": "DESC"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1040,
        -64
      ],
      "id": "eec3a8a1-9801-4fd2-af32-d025c1fc7e7f",
      "name": "sabotadores",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH params AS (\n  SELECT '1d74e1c4-a42c-4641-8db9-da3b80b8dbff'::uuid AS usuario_id\n),\nestado AS (\n  SELECT\n    q.usuario_id,\n    q.xp_total,\n    q.total_xp_hoje,\n    q.sequencia_atual,\n    q.sequencia_recorde,\n    q.meta_sequencia_codigo,\n    q.proxima_meta_codigo,\n    q.ultima_conversa_em,\n    q.sequencia_status,\n    q.atualizado_em\n  FROM public.quest_estado_usuario q\n  JOIN params p ON p.usuario_id = q.usuario_id\n)\nSELECT jsonb_build_object(\n  'estado', to_jsonb(e),\n  'conversas', COALESCE(conv.conversas, '[]'::jsonb)\n) AS diagnostico\nFROM estado e\nCROSS JOIN LATERAL (\n  SELECT jsonb_agg(\n           jsonb_build_object(\n             'id', uc.id,\n             'data_conversa', uc.data_conversa,\n             'atualizado_em', uc.atualizado_em,\n             'tem_reflexao', uc.tem_reflexao,\n             'total_palavras_usuario', COALESCE(uc.total_palavras_usuario, 0)\n           )\n           ORDER BY uc.data_conversa, uc.atualizado_em\n         ) AS conversas\n  FROM public.usr_chat uc\n  JOIN params p ON p.usuario_id = uc.usuario_id\n  WHERE uc.data_conversa >= NOW() - INTERVAL '30 days'\n) conv;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1264,
        -64
      ],
      "id": "adcf625e-909d-4429-ac34-7e4218c98621",
      "name": "Insights",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  data_conversa,\n  DATE(data_conversa) AS dia,\n  usuario_id\nFROM public.usr_chat\nWHERE usuario_id = 'd949d81c-9235-41ce-8b3b-6b5d593c5e24'\nORDER BY data_conversa ASC;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        736,
        160
      ],
      "id": "e5c41c26-0c46-40db-8fa8-909174656334",
      "name": "Gamificacao",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "conquistas_historico",
          "mode": "list",
          "cachedResultName": "conquistas_historico"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        240,
        160
      ],
      "id": "b05e0157-1580-4923-9f8c-55e381bbb5f7",
      "name": "quest modelo",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH params AS (\n  SELECT 'd949d81c-9235-41ce-8b3b-6b5d593c5e24'::uuid AS usuario_id\n)\nSELECT\n  p.usuario_id,\n  COUNT(DISTINCT date(uc.data_conversa)) AS dias_distintos,\n  75 * COUNT(DISTINCT date(uc.data_conversa)) AS xp_base_estimado,\n  SUM(\n    CASE\n      WHEN date(uc.data_conversa) > q.ultima_conversa_em::date THEN 75\n      ELSE 0\n    END\n  ) AS xp_real_incremento,\n  q.xp_total,\n  q.total_xp_hoje,\n  q.sequencia_atual,\n  q.sequencia_recorde,\n  q.meta_sequencia_codigo,\n  q.proxima_meta_codigo,\n  q.ultima_conversa_em\nFROM params p\nLEFT JOIN public.usr_chat uc ON uc.usuario_id = p.usuario_id\nLEFT JOIN public.quest_estado_usuario q ON q.usuario_id = p.usuario_id\nWHERE uc.data_conversa >= now() - interval '45 days'\nGROUP BY p.usuario_id, q.xp_total, q.total_xp_hoje, q.sequencia_atual,\n         q.sequencia_recorde, q.meta_sequencia_codigo, q.proxima_meta_codigo,\n         q.ultima_conversa_em;\n",
        "options": {
          "queryReplacement": "=d949d81c-9235-41ce-8b3b-6b5d593c5e24"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        512,
        160
      ],
      "id": "90004298-d72a-4f42-8c41-acad0fed9bda",
      "name": "valida pontuação",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "select * from usuarios",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -192,
        -64
      ],
      "id": "7667c0c0-228e-418e-97d5-80e7053ab167",
      "name": "codex_agente",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    }
  ],
  "connections": {
    "When clicking ‘Execute workflow’": {
      "main": [
        []
      ]
    },
    "Quest catalogo": {
      "main": [
        []
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "shared": [
    {
      "createdAt": "2025-11-03T09:13:55.708Z",
      "role": "workflow:owner",
      "workflowId": "04S47KA7EIbiJZBA",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}
