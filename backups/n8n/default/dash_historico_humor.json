{
  "createdAt": "2025-10-07T10:10:22.720Z",
  "updatedAt": "2025-10-22T01:17:38.039Z",
  "id": "K6wCa8HaaUwdp6bP",
  "name": "dash_historico_humor",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "path": "humor-historico",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        0,
        0
      ],
      "id": "c6bf4419-61be-4560-a67a-9475d6ee5af8",
      "name": "Webhook",
      "webhookId": "b9cfce67-b271-4b34-a00a-9d699318d8dd"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH periodo AS (\n  SELECT\n    (CURRENT_DATE - INTERVAL '6 day') AS inicio,\n    CURRENT_DATE                    AS fim\n),\nregistros AS (\n  SELECT\n    uhe.usuario_id,\n    uhe.data_registro,\n    uhe.hora_registro,\n    uhe.detectado_em,\n    uhe.humor_dia,\n    uhe.energia_nivel,\n    uhe.periodo_dia,\n    uhe.variacao_humor,\n    uhe.variacao_energia,\n    uhe.justificativa_humor,\n    uhe.confianca_analise,\n    uhe.chat_id\n  FROM public.usuarios_humor_energia uhe\n  JOIN periodo p\n    ON uhe.data_registro BETWEEN p.inicio AND p.fim\n  WHERE uhe.usuario_id = $1\n),\nultimos_por_dia AS (\n  SELECT DISTINCT ON (data_registro)\n    data_registro,\n    hora_registro,\n    detectado_em,\n    humor_dia,\n    energia_nivel,\n    periodo_dia,\n    variacao_humor,\n    variacao_energia,\n    justificativa_humor,\n    confianca_analise,\n    chat_id\n  FROM registros\n  ORDER BY data_registro, detectado_em DESC, hora_registro DESC\n),\nlinha_base AS (\n  SELECT\n    data_registro,\n    AVG(humor_dia)::numeric(4,2)     AS humor_medio_dia,\n    AVG(energia_nivel)::numeric(4,2) AS energia_media_dia\n  FROM registros\n  GROUP BY data_registro\n),\nemocoes_conversa AS (\n  SELECT\n    ue.chat_id,\n    ue.emocao_id,\n    ep.nome       AS emocao_nome,\n    ep.emoji,\n    ue.intensidade,\n    ue.detectado_em,\n    ue.criado_em,\n    ROW_NUMBER() OVER (\n      PARTITION BY ue.chat_id\n      ORDER BY ue.intensidade DESC NULLS LAST,\n               ue.detectado_em DESC NULLS LAST,\n               ue.criado_em DESC NULLS LAST\n    ) AS rn\n  FROM public.usuarios_emocoes ue\n  JOIN periodo p\n    ON COALESCE(ue.detectado_em, p.fim) BETWEEN p.inicio AND p.fim\n  LEFT JOIN public.emocoes_plutchik ep\n    ON ep.id = ue.emocao_id\n  WHERE ue.usuario_id = $1\n),\nconversas AS (\n  SELECT\n    uc.id              AS chat_id,\n    uc.data_conversa,\n    uc.horario_inicio,\n    uc.horario_fim,\n    ec.emocao_nome,\n    ec.emoji,\n    ec.intensidade AS intensidade_emocao\n  FROM public.usr_chat uc\n  JOIN periodo p\n    ON uc.data_conversa BETWEEN p.inicio AND p.fim\n  LEFT JOIN emocoes_conversa ec\n    ON ec.chat_id = uc.id AND ec.rn = 1\n  WHERE uc.usuario_id = $1\n)\nSELECT jsonb_build_object(\n  'periodo', jsonb_build_object(\n      'inicio', (SELECT inicio FROM periodo),\n      'fim',    (SELECT fim    FROM periodo)\n  ),\n  'serie', (\n    SELECT jsonb_agg(\n      jsonb_build_object(\n        'data',          lb.data_registro,\n        'humor_medio',   lb.humor_medio_dia,\n        'energia_media', lb.energia_media_dia,\n        'pico_dia',      up.humor_dia,\n        'emoji',         conv.emoji,\n        'emocao',        conv.emocao_nome\n      )\n      ORDER BY lb.data_registro\n    )\n    FROM linha_base lb\n    LEFT JOIN ultimos_por_dia up\n      ON up.data_registro = lb.data_registro\n    LEFT JOIN conversas conv\n      ON conv.data_conversa = lb.data_registro\n  ),\n  'detalhes', (\n    SELECT jsonb_agg(\n      jsonb_build_object(\n        'data',       up.data_registro,\n        'hora',       up.hora_registro,\n        'humor',      up.humor_dia,\n        'energia',    up.energia_nivel,\n        'variacao_humor',   up.variacao_humor,\n        'variacao_energia', up.variacao_energia,\n        'periodo_dia',      up.periodo_dia,\n        'justificativa',    up.justificativa_humor,\n        'confianca',        up.confianca_analise,\n        'conversa', (\n          SELECT jsonb_build_object(\n            'id',                  conv.chat_id,\n            'horario_inicio',      conv.horario_inicio,\n            'horario_fim',         conv.horario_fim,\n            'emocao',              conv.emocao_nome,\n            'intensidade_emocao',  conv.intensidade_emocao,\n            'emoji',               conv.emoji\n          )\n          FROM conversas conv\n          WHERE conv.chat_id = up.chat_id\n        )\n      )\n      ORDER BY up.data_registro DESC, up.hora_registro DESC\n    )\n    FROM ultimos_por_dia up\n  )\n) AS historico_humor;\n",
        "options": {
          "queryReplacement": "=# Param 1 – usuário\n{{ $json.query.user_id }}\n\n# Param 2 – início do período (default 7 dias)\n{{ $json.query.data_inicio ?? $now.minus({ days: 6 }).startOf('day').toFormat('yyyy-LL-dd') }}\n\n# Param 3 – fim do período (default hoje)\n{{ $json.query.data_fim ?? $now.startOf('day').toFormat('yyyy-LL-dd') }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        208,
        0
      ],
      "id": "9808b7d2-5d36-4931-acbd-0a50a8bf99f1",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        416,
        0
      ],
      "id": "9cfb101f-cf9e-4325-bd15-bad04b224665",
      "name": "Respond to Webhook"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "mindquest-n8n.cloudfy.live",
            "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36 OPR/120.0.0.0",
            "accept": "*/*",
            "accept-encoding": "gzip, br",
            "accept-language": "en-GB,en-US;q=0.9,en;q=0.8,pt-PT;q=0.7,pt;q=0.6,es;q=0.5,de;q=0.4,zh-CN;q=0.3,zh;q=0.2,it;q=0.1,pt-BR;q=0.1",
            "cdn-loop": "cloudflare; loops=1",
            "cf-connecting-ip": "2001:818:e374:a600:40e1:c88b:e568:fece",
            "cf-ipcountry": "PT",
            "cf-ray": "992522347994c640-LIS",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "if-none-match": "W/\"12d3-kAyTal1Qz2gaMsMUcqUPmTbZIpg\"",
            "origin": "http://localhost:5174",
            "priority": "u=1, i",
            "referer": "http://localhost:5174/",
            "sec-ch-ua": "\"Opera\";v=\"120\", \"Not-A.Brand\";v=\"8\", \"Chromium\";v=\"135\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"macOS\"",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "cross-site",
            "x-forwarded-for": "172.68.103.67",
            "x-forwarded-host": "mindquest-n8n.cloudfy.live",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "d49265bfcab0",
            "x-real-ip": "172.68.103.67"
          },
          "params": {},
          "query": {
            "user_id": "d949d81c-9235-41ce-8b3b-6b5d593c5e24"
          },
          "body": {},
          "webhookUrl": "https://mindquest-n8n.cloudfy.live/webhook/humor-historico",
          "executionMode": "production"
        }
      }
    ]
  },
  "versionId": "6bd1ac62-cd7a-4d1e-8fe8-142d7922b42a",
  "triggerCount": 1,
  "shared": [
    {
      "createdAt": "2025-10-07T10:10:22.720Z",
      "updatedAt": "2025-10-07T10:10:22.720Z",
      "role": "workflow:owner",
      "workflowId": "K6wCa8HaaUwdp6bP",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "updatedAt": "2025-09-25T16:38:18.729Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "updatedAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "updatedAt": "2025-10-27T08:00:06.115Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "lastActiveAt": "2025-10-27",
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}