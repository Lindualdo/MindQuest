{
  "updatedAt": "2025-11-01T20:48:09.414Z",
  "createdAt": "2025-09-30T11:31:35.749Z",
  "id": "2LwxT1Pnnaheh10M",
  "name": "chat_onboarding",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "remoteJid"
            },
            {
              "name": "pushName"
            },
            {
              "name": "id"
            },
            {
              "name": "whatsapp_number"
            },
            {
              "name": "evolution_instancia"
            },
            {
              "name": "menssagem"
            }
          ]
        }
      },
      "id": "8f1b2143-b0f3-472e-a5ec-debeb8de4148",
      "name": "start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -1776,
        48
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "sessionData",
        "key": "=onboarding:{{ $('start').first().json.whatsapp_number }}",
        "options": {}
      },
      "id": "250f07b9-7fb6-4eea-9946-b90f720e9223",
      "name": "Redis Get",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -1424,
        -112
      ],
      "credentials": {
        "redis": {
          "id": "PB4zpLy1jLXDEzmH",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const raw = $input.item.json.sessionData;\nlet session = {};\ntry {\n  if (raw) session = JSON.parse(raw);\n} catch (error) {\n  session = {};\n}\n\nconst normalizeEstado = (value) => {\n  if (!value) return 'inicio';\n  if (value === 'nome_coletado') return 'esperando_nome';\n  if (value === 'assistente_pendente') return 'esperando_email';\n  if (value === 'faixa_pendente') return 'esperando_faixa';\n  return value;\n};\n\nconst estado = normalizeEstado(session.estado);\nconst nome_preferido = session.nome_preferido || null;\nconst email_usuario = session.email_usuario || null;\nconst faixa_etaria = session.faixa_etaria || null;\n\nconst stateOrder = {\n  inicio: 1,\n  esperando_nome: 2,\n  esperando_email: 3,\n  esperando_faixa: 4,\n  confirmacao_pendente: 5,\n  completo: 6,\n};\n\nconst interaction_count = stateOrder[estado] || 2;\n\nlet next_focus = '';\nif (estado === 'inicio') {\n  next_focus = 'ONBOARDING#1: Sauda√ß√£o curta + perguntar COMO QUER SER CHAMADO(A). Uma √∫nica pergunta.';\n} else if (estado === 'esperando_nome') {\n  next_focus = 'ONBOARDING#2: Agrade√ßa e solicite o E-MAIL do usu√°rio. Destaque que precisa ser um endere√ßo v√°lido.';\n} else if (estado === 'esperando_email') {\n  next_focus = 'ONBOARDING#3: Agrade√ßa e pe√ßa a FAIXA ET√ÅRIA. Liste as op√ß√µes 1 a 7 e pe√ßa s√≥ o n√∫mero.';\n} else if (estado === 'esperando_faixa') {\n  next_focus = 'ONBOARDING#4: Informe que vai consolidar as informa√ß√µes e aguarde a confirma√ß√£o final do usu√°rio.';\n} else {\n  next_focus = 'ONBOARDING#5: Aguarde apenas a confirma√ß√£o do usu√°rio, sem abrir novos t√≥picos.';\n}\n\nconst is_last_interaction = estado === 'confirmacao_pendente' || estado === 'completo';\n\nreturn {\n  json: {\n    estado,\n    nome_preferido,\n    email_usuario,\n    faixa_etaria,\n    interaction_count,\n    next_focus,\n    is_last_interaction,\n  },\n};"
      },
      "id": "d3a3784b-5898-48a4-91f4-c2401a7c24d2",
      "name": "Code - Controller (interations-style)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1200,
        -112
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# USER PROMPT - ONBOARDING MINDQUEST (interations-style)\n\n<contexto>\nMensagem do Usu√°rio: {{ $('start').item.json.menssagem }}\nEstado Atual: {{ $('Code - Controller (interations-style)').item.json.estado }}\nNome Preferido: {{ $('Code - Controller (interations-style)').item.json.nome_preferido }}\nE-mail informado: {{ $('Code - Controller (interations-style)').item.json.email_usuario }}\n</contexto>\n\n<controle>\nInteraction: {{ $('Code - Controller (interations-style)').item.json.interaction_count }}\nnext_focus: {{ $('Code - Controller (interations-style)').item.json.next_focus }}\n√â √∫ltima intera√ß√£o: {{ $('Code - Controller (interations-style)').item.json.is_last_interaction }}\nREGRAS: Siga EXACTAMENTE o next_focus. N√£o adicione perguntas extras nem promessas que o sistema n√£o confirma.\n</controle>\n\n<templates>\n1: \"Oi! üëã Que bom ter voc√™ aqui no MindQuest!\n\nVamos come√ßar criando o seu espa√ßo pessoal. √â rapidinho, prometo ‚Äî s√£o s√≥ 3 perguntinhas pra eu te conhecer melhor e ajustar tudo √† sua forma de pensar.\n\nComo voc√™ prefere ser chamado(a)?\"\n2: \"Perfeito, [NOME]! Agora, informe um e-mail para recuperar seus dados caso perca esse numero do WhatsApp.\"\n3: \"√ìtimo! Pra personalizar ainda mais, me conta sua faixa et√°ria. Responda apenas com o n√∫mero correspondente:\n\n1Ô∏è‚É£ 13 a 17 anos\n2Ô∏è‚É£ 18 a 24 anos\n3Ô∏è‚É£ 25 a 34 anos\n4Ô∏è‚É£ 35 a 44 anos\n5Ô∏è‚É£ 45 a 54 anos\n6Ô∏è‚É£ 55 a 64 anos\n7Ô∏è‚É£ 65 anos ou mais\"\n4: \"Perfeito! Vou juntar as informa√ß√µes e te enviar um resumo pra voc√™ confirmar, tudo bem?\"\n5: \"Obrigado pela resposta! Assim que voc√™ confirmar, finalizo seu acesso imediatamente. üôå\"\n</templates>",
        "options": {
          "systemMessage": "=# SYSTEM\n- Fale PT-BR.\n- Obede√ßa ao next_focus.\n- Se for a √∫ltima intera√ß√£o, n√£o pergunte.\n- Direto e cordial."
        }
      },
      "id": "ee087705-66a6-49ac-8bbc-e8f7b697fe80",
      "name": "Agent AI (interations-style)",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -960,
        -112
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "13473f2a-8442-4ba3-835c-7b98d2693382",
      "name": "OpenRouter Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -960,
        80
      ],
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const raw = $input.first().json.output || '';\nconst controllerState = $('Code - Controller (interations-style)').first().json.estado || 'inicio';\nconst incomingMessage = String($('start').first().json.menssagem || '').trim();\n\nlet out_text = String(raw || '').trim();\nlet proximo_estado = null;\nlet tipo = 'mensagem';\n\nlet nome_usuario = null;\nlet email_usuario = null;\nlet faixa_etaria = null;\nlet faixa_etaria_codigo = null;\n\nlet prev = {};\ntry {\n  prev = JSON.parse($('Redis Get').first().json.sessionData || '{}');\n} catch (error) {\n  prev = {};\n}\n\nconst prevNome = typeof prev.nome_preferido === 'string' ? prev.nome_preferido.trim() : null;\nconst prevEmail = typeof prev.email_usuario === 'string' ? prev.email_usuario.trim() : null;\nconst prevFaixa = typeof prev.faixa_etaria === 'string' ? prev.faixa_etaria : null;\nconst prevFaixaCodigo = typeof prev.faixa_etaria_codigo === 'string' ? prev.faixa_etaria_codigo : null;\n\nnome_usuario = prevNome;\nemail_usuario = prevEmail;\nfaixa_etaria = prevFaixa;\nfaixa_etaria_codigo = prevFaixaCodigo;\n\nconst normalizeEstado = (value) => {\n  if (!value) return 'inicio';\n  if (value === 'nome_coletado') return 'esperando_nome';\n  if (value === 'assistente_pendente') return 'esperando_email';\n  if (value === 'faixa_pendente') return 'esperando_faixa';\n  return value;\n};\n\nconst isValidEmail = (value) => {\n  if (!value) return false;\n  const email = value.trim();\n  const regex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]{2,}$/i;\n  return regex.test(email);\n};\n\nconst stripAccents = (value) =>\n  value.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\n\nconst ageOptions = {\n  '1': '13-17',\n  '2': '18-24',\n  '3': '25-34',\n  '4': '35-44',\n  '5': '45-54',\n  '6': '55-64',\n  '7': '65+',\n};\n\nconst ageLabels = {\n  '1': '13 a 17 anos',\n  '2': '18 a 24 anos',\n  '3': '25 a 34 anos',\n  '4': '35 a 44 anos',\n  '5': '45 a 54 anos',\n  '6': '55 a 64 anos',\n  '7': '65 anos ou mais',\n};\n\nconst buildSummary = (nome, email, faixaLabel) => {\n  const exibNome = nome && nome.trim() ? nome.trim() : 'n√£o informado';\n  const exibEmail = email && email.trim() ? email.trim() : 'n√£o informado';\n  const exibFaixa = faixaLabel || 'n√£o informada';\n  return `Confere se est√° tudo certo? üëá\n‚Ä¢ Nome preferido: ${exibNome}\n‚Ä¢ E-mail: ${exibEmail}\n‚Ä¢ Faixa et√°ria: ${exibFaixa}\n\nSe quiser alterar, envie o dado correto (ex.: \"email novo@dominio.com\" ou \"faixa 3\").\n\nEst√° correto?\nResponda: Sim ou altere\n`;\n};\n\nconst estado = normalizeEstado(controllerState);\nconst mensagem = incomingMessage;\nconst mensagemLimpa = mensagem.trim();\n\nif (estado === 'inicio') {\n  proximo_estado = 'esperando_nome';\n  if (!out_text) {\n    out_text = 'Oi! üëã Bem-vindo ao MindQuest!\\n\\nVamos fazer seu cadastro r√°pido. S√£o s√≥ 3 perguntinhas e j√° liberamos tudo pra voc√™.\\n\\nComo voc√™ prefere ser chamado(a)?';\n  }\n} else if (estado === 'esperando_nome') {\n  if (mensagemLimpa.length >= 2) {\n    nome_usuario = mensagemLimpa;\n    proximo_estado = 'esperando_email';\n    if (!out_text) {\n      out_text = `Perfeito, ${nome_usuario}! Agora, informe um e-mail para recuperar seus dados caso perca esse numero do WhatsApp.`;\n    }\n  } else {\n    proximo_estado = 'esperando_nome';\n    if (!out_text) {\n      out_text = 'Preciso de um nome com pelo menos 2 caracteres. Como voc√™ prefere ser chamado(a)?';\n    }\n  }\n} else if (estado === 'esperando_email') {\n  if (isValidEmail(mensagemLimpa)) {\n    email_usuario = mensagemLimpa.trim().toLowerCase();\n    proximo_estado = 'esperando_faixa';\n    if (!out_text) {\n      out_text = 'Anotado! Agora me conta sua faixa et√°ria. Responda apenas com o n√∫mero correspondente (1 a 7).';\n    }\n  } else {\n    proximo_estado = 'esperando_email';\n    if (!out_text) {\n      out_text = 'Esse formato n√£o parece um e-mail v√°lido. Pode mandar no formato nome@dominio.com?';\n    }\n  }\n} else if (estado === 'esperando_faixa') {\n  const match = mensagemLimpa.match(/^([1-7])$/);\n  if (match) {\n    faixa_etaria_codigo = match[1];\n    faixa_etaria = ageOptions[faixa_etaria_codigo];\n    proximo_estado = 'confirmacao_pendente';\n    out_text = buildSummary(nome_usuario || prevNome, email_usuario || prevEmail, ageLabels[faixa_etaria_codigo] || faixa_etaria);\n  } else {\n    proximo_estado = 'esperando_faixa';\n    if (!out_text) {\n      out_text = 'Para concluir, preciso que responda apenas com o n√∫mero de 1 a 7 correspondente √† sua faixa et√°ria.';\n    }\n  }\n} else if (estado === 'confirmacao_pendente') {\n  const normalized = stripAccents(mensagemLimpa).toLowerCase().replace(/[.!?]+$/g, '').trim();\n  const isConfirm = () => {\n    if (!normalized) return false;\n    if (/^confirm(o|ar|ado|ada)$/.test(normalized)) return true;\n    const confirmations = new Set(['sim', 'confirmo', 'confirmar', 'confirmado', 'confirmada', 'tudo certo', 'isso mesmo', 'ok', 'okay', 'pode seguir', 'pode continuar', 'perfeito', 'certo']);\n    return confirmations.has(normalized);\n  };\n\n  if (isConfirm()) {\n    proximo_estado = 'completo';\n    tipo = 'finalizado';\n    if (!out_text) {\n      out_text = 'Perfeito! Vou finalizar seu acesso agora.';\n    }\n  } else {\n    let handled = false;\n    const extractAfterKeyword = (keyword) => {\n      const pattern = new RegExp(`^\\\\s*${keyword}\\\\s*[:\\\\-]?\\\\s*(.+)$`, 'i');\n      const match = mensagem.match(pattern);\n      return match ? match[1].trim() : null;\n    };\n\n    const emailByPrefix = extractAfterKeyword('email');\n    if (!handled && emailByPrefix && isValidEmail(emailByPrefix)) {\n      email_usuario = emailByPrefix.trim().toLowerCase();\n      handled = true;\n    }\n\n    const faixaByPrefix = extractAfterKeyword('faixa');\n    if (!handled && faixaByPrefix) {\n      const faixaMatch = faixaByPrefix.match(/([1-7])/);\n      if (faixaMatch) {\n        faixa_etaria_codigo = faixaMatch[1];\n        faixa_etaria = ageOptions[faixa_etaria_codigo];\n        handled = true;\n      }\n    }\n\n    const nomeByPrefix = extractAfterKeyword('nome');\n    if (!handled && nomeByPrefix && nomeByPrefix.length >= 2) {\n      nome_usuario = nomeByPrefix;\n      handled = true;\n    }\n\n    if (!handled && isValidEmail(mensagemLimpa)) {\n      email_usuario = mensagemLimpa.trim().toLowerCase();\n      handled = true;\n    }\n\n    if (!handled) {\n      const changeKeywords = new Set(['altere', 'alterar', 'quero alterar']);\n      if (changeKeywords.has(normalized)) {\n        handled = true;\n      }\n    }\n\n    if (!handled) {\n      const faixaMatch = mensagemLimpa.match(/^([1-7])$/);\n      if (faixaMatch) {\n        faixa_etaria_codigo = faixaMatch[1];\n        faixa_etaria = ageOptions[faixa_etaria_codigo];\n        handled = true;\n      }\n    }\n\n    if (!handled && mensagemLimpa.length >= 2 && !/(corrig|ajust|editar)/.test(normalized)) {\n      nome_usuario = mensagemLimpa;\n      handled = true;\n    }\n\n    proximo_estado = 'confirmacao_pendente';\n    out_text = buildSummary(nome_usuario || prevNome, email_usuario || prevEmail, ageLabels[faixa_etaria_codigo] || faixa_etaria);\n    if (!handled) {\n      out_text += '\\nSe quiser alterar, envie o dado completo (ex.: \"email novo@dominio.com\" ou \"faixa 3\").';\n    }\n  }\n} else {\n  proximo_estado = 'esperando_nome';\n  if (!out_text) {\n    out_text = 'Vamos l√°! Como voc√™ prefere ser chamado(a)?';\n  }\n}\n\nif (!nome_usuario && prevNome) {\n  nome_usuario = prevNome;\n}\nif (!email_usuario && prevEmail) {\n  email_usuario = prevEmail;\n}\nif (!faixa_etaria && prevFaixa) {\n  faixa_etaria = prevFaixa;\n}\nif (!faixa_etaria_codigo && prevFaixaCodigo) {\n  faixa_etaria_codigo = prevFaixaCodigo;\n}\n\nreturn {\n  json: {\n    tipo,\n    texto: out_text,\n    proximo_estado,\n    nome_usuario,\n    email_usuario,\n    faixa_etaria,\n    faixa_etaria_codigo,\n    nome_assistente: 'assistente',\n  },\n};\n"
      },
      "id": "907fd40d-b3c5-4336-ace4-aeb6b485695f",
      "name": "Code - Parse Determin√≠stico",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -592,
        -112
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.tipo }}",
              "rightValue": "finalizado",
              "operator": {
                "type": "string",
                "operation": "equals"
              },
              "id": "0531552e-c58e-4386-a7c8-0fe2f618b330"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "b380754b-4f60-44a6-b1e2-50e32802599a",
      "name": "IF Finalizado",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -400,
        -112
      ]
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=onboarding:{{ $('start').first().json.whatsapp_number }}",
        "value": "={{ (() => {\n  let prev = {};\n  try {\n    const raw = $('Redis Get').first().json.sessionData;\n    prev = raw ? JSON.parse(raw) : {};\n  } catch (error) {\n    prev = {};\n  }\n  const ai = $('Code - Parse Determin√≠stico').first().json || {};\n  const mapEstado = (value) => {\n    if (!value) return null;\n    if (['inicio', 'esperando_nome', 'esperando_email', 'esperando_faixa', 'confirmacao_pendente', 'completo'].includes(value)) {\n      return value;\n    }\n    if (value === 'nome_coletado') return 'esperando_nome';\n    if (value === 'assistente_pendente') return 'esperando_email';\n    if (value === 'faixa_pendente') return 'esperando_faixa';\n    return null;\n  };\n\n  const nextEstado = mapEstado(ai.proximo_estado) || mapEstado(prev.estado) || 'inicio';\n  const nome = ai.nome_usuario || prev.nome_preferido || null;\n  const email = ai.email_usuario || prev.email_usuario || null;\n  const faixa = ai.faixa_etaria || prev.faixa_etaria || null;\n  const faixaCodigo = ai.faixa_etaria_codigo || prev.faixa_etaria_codigo || null;\n\n  return JSON.stringify({\n    nome_preferido: nome,\n    email_usuario: email,\n    nome_assistente: 'assistente',\n    faixa_etaria: faixa,\n    faixa_etaria_codigo: faixaCodigo,\n    estado: nextEstado\n  });\n})() }}",
        "expire": true,
        "ttl": 86400
      },
      "id": "b84ad144-d741-4e84-b17b-2f4ce650faa4",
      "name": "Redis Update",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        64,
        -16
      ],
      "credentials": {
        "redis": {
          "id": "PB4zpLy1jLXDEzmH",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO usuarios (\n  whatsapp_numero,\n  nome,\n  nome_preferencia,\n  email,\n  nome_assistente,\n  token_acesso,\n  token_expira_em,\n  status_onboarding,\n  faixa_etaria\n)\nVALUES (\n  $1,\n  $2,\n  $3,\n  $4,\n  'assistente',\n  gen_random_uuid() || $5 || EXTRACT(EPOCH FROM CURRENT_TIMESTAMP)::bigint,\n  CURRENT_TIMESTAMP + INTERVAL '15 days',\n  'completo',\n  $6\n)\nRETURNING id, token_acesso, whatsapp_numero, nome_preferencia, nome_assistente, email;",
        "options": {
          "queryReplacement": "={{ [\n  $('start').first().json.whatsapp_number,\n  $('start').item.json.pushName,\n  $('Code - Parse Determin√≠stico').item.json.nome_usuario,\n  $('Code - Parse Determin√≠stico').item.json.email_usuario,\n  $('start').item.json.id,\n  $('Code - Parse Determin√≠stico').item.json.faixa_etaria\n] }}"
        }
      },
      "id": "390a765f-bc53-4176-9a4c-abab28a1a820",
      "name": "Insert User",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -160,
        -272
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO gamificacao (usuario_id, xp_total, nivel_atual, xp_proximo_nivel, titulo_nivel, streak_conversas_dias, streak_protecao_usada, quest_diaria_status, quest_diaria_progresso, quest_diaria_descricao, quest_diaria_data, conquistas_desbloqueadas, total_conversas, total_reflexoes, melhor_streak)\nVALUES ($1::uuid, 0, 1, 200, 'Explorador', 0, false, 'pendente', 0, 'D√™ o primeiro passo: inicie sua primeira conversa comigo!', CURRENT_DATE, '[]'::jsonb, 0, 0, 0);",
        "options": {
          "queryReplacement": "={{ [$json.id] }}"
        }
      },
      "id": "28018c18-d374-4d3f-a5d9-0dedc6eb41c2",
      "name": "Insert Gamif",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        48,
        -272
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const dados = $('Code - Parse Determin√≠stico').first().json || {};\nconst historico = (() => {\n  try {\n    return JSON.parse($('Redis Get').first().json.sessionData || '{}');\n  } catch (error) {\n    return {};\n  }\n})();\n\nconst preferido = (dados.nome_usuario && dados.nome_usuario.trim())\n  || (historico.nome_preferido && historico.nome_preferido.trim())\n  || ($('start').item.json.pushName || '').trim()\n  || 'voc√™';\nconst nomeUsuario = preferido;\nconst token = $('Insert User').first().json.token_acesso;\nconst url = `https://mindquest.pt/app/auth?token=${token}`;\n\nconst mensagem = `Perfeito, ${nomeUsuario}! üòä\n\nSeu acesso est√° liberado: ${url}\n\nüîí Esse link j√° vem com seu token pessoal, sem precisar criar senha.\n\nSe quiser um guia r√°pido pra aproveitar melhor, visite https://mindquest.pt/suporte/conversation-guide.\n\nQuando quiser, √© s√≥ me contar o que est√° acontecendo por a√≠.`;\n\nreturn { json: { mensagem } };"
      },
      "id": "ed32235c-07d8-4b4f-a61a-d5baa73b2c30",
      "name": "monta link para usuario",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        -272
      ]
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('start').item.json.evolution_instancia }}{{ $('start').item.json.whatsapp_number }}",
        "sessionTTL": 86400,
        "contextWindowLength": 20
      },
      "id": "c91abce1-ca26-432d-b4b3-a3bfd61aab1e",
      "name": "Redis Chat Memory1",
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        -224,
        752
      ],
      "credentials": {
        "redis": {
          "id": "PB4zpLy1jLXDEzmH",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "U44ZfEwFU77EUthb",
          "mode": "list",
          "cachedResultUrl": "/workflow/U44ZfEwFU77EUthb",
          "cachedResultName": "sw_send_message_with_retry"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "messageText": "={{ $json.mensagem }}",
            "remoteJid": "={{ $('start').item.json.remoteJid }}",
            "instanceName": "={{ $('start').item.json.evolution_instancia }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "instanceName",
              "displayName": "instanceName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "remoteJid",
              "displayName": "remoteJid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "messageText",
              "displayName": "messageText",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        448,
        -272
      ],
      "id": "2403ac18-f31a-4e54-90f2-fabb4ab0bc43",
      "name": "Call 'sw_send_message_with_retry'"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "U44ZfEwFU77EUthb",
          "mode": "list",
          "cachedResultUrl": "/workflow/U44ZfEwFU77EUthb",
          "cachedResultName": "sw_send_message_with_retry"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "messageText": "={{ $('Code - Parse Determin√≠stico').item.json.texto }}",
            "remoteJid": "={{ $('start').item.json.remoteJid }}",
            "instanceName": "={{ $('start').item.json.evolution_instancia }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "instanceName",
              "displayName": "instanceName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "remoteJid",
              "displayName": "remoteJid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "messageText",
              "displayName": "messageText",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -160,
        -16
      ],
      "id": "feaf7cd8-2fbc-4a0b-b27f-9d1f0771fe69",
      "name": "Call 'sw_send_message_with_retry'1"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "=onboarding:{{ $('start').first().json.whatsapp_number }}"
      },
      "id": "770e639e-c9a6-457c-95c8-a166edcba64d",
      "name": "Redis Delete",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        656,
        -272
      ],
      "credentials": {
        "redis": {
          "id": "PB4zpLy1jLXDEzmH",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "=onboarding:{{ $('start').first().json.whatsapp_number }}"
      },
      "id": "d8136c29-fe72-4508-a90b-e0bd5edc6851",
      "name": "Redis Delete1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -1424,
        80
      ],
      "credentials": {
        "redis": {
          "id": "PB4zpLy1jLXDEzmH",
          "name": "Redis account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "mode": "delete",
        "deleteMode": "all"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryManager",
      "typeVersion": 1.1,
      "position": [
        -1472,
        288
      ],
      "id": "4e4a604e-29bf-472e-a7ed-0a1e099c6eb7",
      "name": "Chat Memory Manager",
      "disabled": true
    },
    {
      "parameters": {
        "mode": "delete",
        "deleteMode": "all"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryManager",
      "typeVersion": 1.1,
      "position": [
        832,
        64
      ],
      "id": "c38ca66c-594c-4b64-a9e7-635ab8cbf6b3",
      "name": "Chat Memory Manager1"
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Redis Get",
            "type": "main",
            "index": 0
          },
          {
            "node": "Redis Delete1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Chat Memory Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis Get": {
      "main": [
        [
          {
            "node": "Code - Controller (interations-style)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Controller (interations-style)": {
      "main": [
        [
          {
            "node": "Agent AI (interations-style)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agent AI (interations-style)": {
      "main": [
        [
          {
            "node": "Code - Parse Determin√≠stico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Agent AI (interations-style)",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code - Parse Determin√≠stico": {
      "main": [
        [
          {
            "node": "IF Finalizado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Finalizado": {
      "main": [
        [
          {
            "node": "Insert User",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Call 'sw_send_message_with_retry'1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert User": {
      "main": [
        [
          {
            "node": "Insert Gamif",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Gamif": {
      "main": [
        [
          {
            "node": "monta link para usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "monta link para usuario": {
      "main": [
        [
          {
            "node": "Call 'sw_send_message_with_retry'",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory1": {
      "ai_memory": [
        [
          {
            "node": "Agent AI (interations-style)",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "Chat Memory Manager",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "Chat Memory Manager1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Call 'sw_send_message_with_retry'": {
      "main": [
        [
          {
            "node": "Redis Delete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call 'sw_send_message_with_retry'1": {
      "main": [
        [
          {
            "node": "Redis Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis Delete": {
      "main": [
        [
          {
            "node": "Chat Memory Manager1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "start": [
      {
        "json": {
          "remoteJid": "5512982389360@s.whatsapp.net",
          "pushName": "Aldo",
          "id": "3AA47BD6BCB2AF945639",
          "whatsapp_number": "5512982389360",
          "evolution_instancia": "MindQuest",
          "menssagem": "Oi"
        }
      }
    ]
  },
  "versionId": "b1ac8062-8729-4579-b7d3-282ec5e9efa1",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-09-30T11:31:35.749Z",
      "createdAt": "2025-09-30T11:31:35.749Z",
      "role": "workflow:owner",
      "workflowId": "2LwxT1Pnnaheh10M",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "updatedAt": "2025-09-25T16:38:18.729Z",
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "updatedAt": "2025-09-16T16:13:20.606Z",
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "updatedAt": "2025-11-02T07:12:45.501Z",
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "lastActiveAt": "2025-11-02",
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}