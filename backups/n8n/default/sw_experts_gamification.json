{
  "name": "sw_experts_gamification",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usuario_id"
            },
            {
              "name": "chat_id"
            },
            {
              "name": "data_conversa"
            },
            {
              "name": "tem_reflexao",
              "type": "boolean"
            },
            {
              "name": "justificativa_reflexao"
            },
            {
              "name": "total_palavras_usuario",
              "type": "number"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -640,
        320
      ],
      "id": "2c8cb608-ad0b-4b40-b689-da3aab1472d2",
      "name": "start"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH ultimos_7_dias AS (\n  -- Gera os ﾃｺltimos 7 dias (hoje atﾃｩ 6 dias atrﾃ｡s)\n  SELECT \n    CURRENT_DATE - INTERVAL '1 day' * s.dia as data\n  FROM generate_series(0, 6) as s(dia)\n),\nconversas_por_dia AS (\n  -- Verifica quais desses 7 dias tiveram conversa\n  SELECT \n    d.data,\n    CASE \n      WHEN EXISTS (\n        SELECT 1 FROM usr_chat \n        WHERE usuario_id = $1::uuid \n        AND DATE(data_conversa) = d.data\n      ) THEN 1 \n      ELSE 0 \n    END as teve_conversa\n  FROM ultimos_7_dias d\n  ORDER BY d.data DESC\n),\nstreak_consecutivo AS (\n  -- Conta consecutivos de hoje para trﾃ｡s atﾃｩ encontrar 0\n  SELECT \n    data,\n    teve_conversa,\n    -- Soma cumulativa de dias SEM conversa (0 = teve, 1+ = nﾃ｣o teve)\n    SUM(CASE WHEN teve_conversa = 0 THEN 1 ELSE 0 END) \n      OVER (ORDER BY data DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as quebras\n  FROM conversas_por_dia\n)\nSELECT \n  g.*,\n  COALESCE((\n    SELECT COUNT(*) \n    FROM streak_consecutivo \n    WHERE teve_conversa = 1 \n      AND quebras = 0  -- Sﾃｳ conta antes da primeira quebra\n  ), 0) as dias_consecutivos,\n  (SELECT COUNT(*) FROM usr_chat WHERE usuario_id = g.usuario_id AND DATE(data_conversa) = CURRENT_DATE) as conversas_hoje\nFROM gamificacao g\nWHERE g.usuario_id = $1::uuid;",
        "options": {
          "queryReplacement": "={{ $('start').first().json.usuario_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -384,
        320
      ],
      "id": "f26b296e-df1b-4e56-a5db-70199d2b7c55",
      "name": "Buscar Estado Atual",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH inserted_base AS (\n  INSERT INTO usuarios_quest (\n    usuario_id,\n    quest_id,\n    status,\n    progresso_meta,\n    referencia_data\n  )\n  SELECT\n    $1::uuid,\n    qc.id,\n    'pendente',\n    COALESCE(qc.gatilho_valor, CASE WHEN qc.tipo = 'diaria' THEN 1 ELSE NULL END),\n    NULL\n  FROM quest_catalog qc\n  WHERE qc.ativo = TRUE\n    AND qc.tipo <> 'diaria'\n    AND NOT EXISTS (\n      SELECT 1\n      FROM usuarios_quest uq\n      WHERE uq.usuario_id = $1::uuid\n        AND uq.quest_id = qc.id\n    )\n  RETURNING id\n),\ninserted_daily AS (\n  INSERT INTO usuarios_quest (\n    usuario_id,\n    quest_id,\n    status,\n    progresso_meta,\n    referencia_data\n  )\n  SELECT\n    $1::uuid,\n    qc.id,\n    'pendente',\n    COALESCE(qc.gatilho_valor, 1),\n    CURRENT_DATE\n  FROM quest_catalog qc\n  WHERE qc.ativo = TRUE\n    AND qc.tipo = 'diaria'\n    AND NOT EXISTS (\n      SELECT 1\n      FROM usuarios_quest uq\n      WHERE uq.usuario_id = $1::uuid\n        AND uq.quest_id = qc.id\n        AND uq.referencia_data = CURRENT_DATE\n    )\n  RETURNING id\n)\nSELECT\n  COALESCE((SELECT COUNT(*) FROM inserted_base), 0) AS inseridos_padrao,\n  COALESCE((SELECT COUNT(*) FROM inserted_daily), 0) AS inseridos_diarios;",
        "options": {
          "queryReplacement": "={{ $('start').first().json.usuario_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -176,
        320
      ],
      "id": "b6c7776e-ec16-459e-a67d-16bcd9dfe28a",
      "name": "Garantir Quests",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ==========================================\n// Cﾃ´CULO DE XP E ATUALIZAﾃﾃグ DE GAMIFICAﾃﾃグ\n// ==========================================\n\nconst getNumber = (value, fallback = 0) => {\n  const num = Number(value);\n  return Number.isFinite(num) ? num : fallback;\n};\n\nconst toNumberOrNull = (value) => {\n  if (value === null || value === undefined || value === '') {\n    return null;\n  }\n  const num = Number(value);\n  return Number.isFinite(num) ? num : null;\n};\n\nconst parseJson = (value) => {\n  if (!value) {\n    return null;\n  }\n  if (typeof value === 'object') {\n    return value;\n  }\n  try {\n    return JSON.parse(String(value));\n  } catch (error) {\n    return null;\n  }\n};\n\nconst estado = ($('Buscar Estado Atual').first()?.json) ?? {};\nconst questsRaw = $('Buscar Quests').all().map((item) => item.json ?? {});\nconst resumo = ($('start').first()?.json) ?? {};\n\nconst temReflexao = resumo.tem_reflexao === true || resumo.tem_reflexao === 'true' || resumo.tem_reflexao === ':true';\nconst totalPalavras = getNumber(resumo.total_palavras_usuario, 0);\n\nconst dataConversaRaw = resumo.data_conversa ?? estado.ultima_conversa_data ?? new Date().toISOString();\nconst dataHoje = new Date(dataConversaRaw).toISOString().split('T')[0];\n\nconst diasConsecutivos = getNumber(estado.dias_consecutivos, 0);\n\n// === 1. Cﾃ´CULO DE XP BASE ===\nlet xpBase = 20;\nif (temReflexao && totalPalavras > 50) {\n  xpBase = 40;\n} else if (temReflexao) {\n  xpBase = 30;\n}\n\n// === 2. Bﾃ年US DE STREAK ===\nlet bonusStreak = 0;\nif (diasConsecutivos >= 30) {\n  bonusStreak = 20;\n} else if (diasConsecutivos >= 7) {\n  bonusStreak = 10;\n}\n\n// === 3. PREPARAR DADOS DOS QUESTS ===\nconst nowIso = new Date().toISOString();\nconst questStates = questsRaw.map((quest) => {\n  const dadosExtras = parseJson(quest.dados_extras) ?? null;\n  const metaRaw = quest.progresso_meta ?? quest.gatilho_valor ?? (quest.tipo === 'diaria' ? 1 : null);\n  const meta = metaRaw !== null ? toNumberOrNull(metaRaw) : null;\n  const referenciaData = quest.referencia_data ? String(quest.referencia_data).split('T')[0] : null;\n\n  return {\n    id: quest.id,\n    quest_id: quest.quest_id,\n    codigo: quest.codigo,\n    titulo: quest.titulo,\n    descricao: quest.descricao,\n    categoria: quest.categoria,\n    tipo: quest.tipo,\n    gatilho_tipo: quest.gatilho_tipo,\n    gatilho_valor: quest.gatilho_valor,\n    xp_recompensa: getNumber(quest.xp_recompensa, 0),\n    repeticao: quest.repeticao,\n    sequencia: getNumber(quest.sequencia, 0),\n    referencia_data: referenciaData,\n    dados_extras: dadosExtras,\n    meta: meta,\n    original: {\n      status: quest.status,\n      progresso_atual: getNumber(quest.progresso_atual, 0),\n      progresso_percentual: getNumber(quest.progresso_percentual, 0),\n      xp_concedido: getNumber(quest.xp_concedido, 0),\n      concluido_em: quest.concluido_em ?? null\n    },\n    final: {\n      status: quest.status,\n      progresso_atual: getNumber(quest.progresso_atual, 0),\n      progresso_percentual: getNumber(quest.progresso_percentual, 0),\n      xp_concedido: getNumber(quest.xp_concedido, 0),\n      concluido_em: quest.concluido_em ?? null,\n      dados_extras: dadosExtras\n    }\n  };\n});\n\nconst totalConversasAntes = getNumber(estado.total_conversas, 0);\nconst totalReflexoesAntes = getNumber(estado.total_reflexoes, 0);\n\nconst progressValues = {\n  total_conversas: totalConversasAntes + 1,\n  dias_consecutivos: diasConsecutivos,\n  total_reflexoes: totalReflexoesAntes + (temReflexao ? 1 : 0),\n  diario: temReflexao ? 1 : 0\n};\n\nlet xpBonusQuests = 0;\nconst novasConquistas = [];\n\nfor (const quest of questStates) {\n  const meta = quest.meta;\n\n  if (quest.gatilho_tipo && Object.prototype.hasOwnProperty.call(progressValues, quest.gatilho_tipo)) {\n    const candidate = progressValues[quest.gatilho_tipo];\n    if (quest.gatilho_tipo === 'diario') {\n      const dailyMeta = meta && meta > 0 ? meta : 1;\n      quest.final.progresso_atual = temReflexao ? dailyMeta : 0;\n    } else if (candidate > quest.final.progresso_atual) {\n      quest.final.progresso_atual = candidate;\n    }\n  }\n\n  if (quest.gatilho_tipo === 'diario') {\n    quest.final.progresso_percentual = temReflexao ? 100 : 0;\n  } else if (meta && meta > 0) {\n    const percentual = (quest.final.progresso_atual / meta) * 100;\n    quest.final.progresso_percentual = Math.min(100, Math.round(percentual));\n  } else {\n    quest.final.progresso_percentual = Math.min(100, quest.final.progresso_percentual);\n  }\n\n  let shouldComplete = false;\n  if (quest.original.status !== 'completa') {\n    if (quest.gatilho_tipo === 'diario') {\n      shouldComplete = temReflexao;\n    } else if (meta && meta > 0 && quest.final.progresso_atual >= meta) {\n      shouldComplete = true;\n    }\n  }\n\n  if (shouldComplete) {\n    quest.final.status = 'completa';\n    quest.final.progresso_atual = meta ?? quest.final.progresso_atual;\n    quest.final.progresso_percentual = 100;\n    quest.final.concluido_em = nowIso;\n    if (quest.final.xp_concedido < quest.xp_recompensa) {\n      const xpToAdd = quest.xp_recompensa - quest.final.xp_concedido;\n      xpBonusQuests += xpToAdd;\n      quest.final.xp_concedido = quest.xp_recompensa;\n      novasConquistas.push({\n        usuario_quest_id: quest.id,\n        codigo: quest.codigo,\n        titulo: quest.titulo,\n        categoria: quest.categoria,\n        xp_bonus: quest.xp_recompensa,\n        concluido_em: nowIso\n      });\n    }\n  } else if (quest.final.status === 'pendente' && (quest.final.progresso_atual > 0 || quest.final.progresso_percentual > 0)) {\n    quest.final.status = 'ativa';\n  }\n}\n\nconst systemQuests = questStates\n  .filter((quest) => quest.tipo === 'sistema')\n  .sort((a, b) => a.sequencia - b.sequencia);\n\nfor (const quest of systemQuests) {\n  if (quest.final.status !== 'completa') {\n    const allPreviousComplete = systemQuests\n      .filter((other) => other.sequencia < quest.sequencia)\n      .every((other) => other.final.status === 'completa');\n    if (allPreviousComplete && quest.final.status === 'pendente') {\n      quest.final.status = 'ativa';\n    }\n    break;\n  }\n}\n\nconst questUpdatesPayload = questStates\n  .filter((quest) =>\n    quest.final.status !== quest.original.status ||\n    quest.final.progresso_atual !== quest.original.progresso_atual ||\n    quest.final.progresso_percentual !== quest.original.progresso_percentual ||\n    quest.final.xp_concedido !== quest.original.xp_concedido ||\n    (quest.final.concluido_em ?? null) !== (quest.original.concluido_em ?? null)\n  )\n  .map((quest) => ({\n    quest_record_id: quest.id,\n    status: quest.final.status,\n    progresso_atual: quest.final.progresso_atual,\n    progresso_percentual: quest.final.progresso_percentual,\n    xp_concedido: quest.final.xp_concedido,\n    concluido_em: quest.final.concluido_em,\n    dados_extras: quest.final.dados_extras\n  }));\n\nconst totalConversasQuest = questStates\n  .filter((quest) => quest.codigo === 'primeira_conversa' || quest.gatilho_tipo === 'total_conversas')\n  .reduce((max, quest) => Math.max(max, quest.final.progresso_atual), 0);\nconst totalReflexoesQuest = questStates\n  .filter((quest) => quest.codigo === 'primeira_reflexao' || quest.gatilho_tipo === 'total_reflexoes')\n  .reduce((max, quest) => Math.max(max, quest.final.progresso_atual), 0);\nconst totalConversas = Math.max(progressValues.total_conversas, totalConversasQuest);\nconst totalReflexoes = Math.max(progressValues.total_reflexoes, totalReflexoesQuest);\n\nconst dailyQuestHoje = questStates.find((quest) => quest.tipo === 'diaria' && quest.referencia_data === dataHoje);\nlet questDiariaStatus = 'pendente';\nlet questDiariaProgresso = 0;\nlet questDiariaDescricao = null;\nlet questDiariaId = null;\nif (dailyQuestHoje) {\n  questDiariaDescricao = dailyQuestHoje.descricao || dailyQuestHoje.titulo || null;\n  questDiariaProgresso = dailyQuestHoje.final.progresso_percentual;\n  questDiariaId = dailyQuestHoje.id;\n  if (dailyQuestHoje.final.progresso_percentual >= 100 || dailyQuestHoje.final.status === 'completa') {\n    questDiariaStatus = 'completa';\n  } else if (dailyQuestHoje.final.progresso_percentual > 0) {\n    questDiariaStatus = 'parcial';\n  }\n}\n\nconst totalXpQuestsAntes = questStates.reduce((sum, quest) => sum + getNumber(quest.original.xp_concedido, 0), 0);\nconst totalXpQuestsDepois = questStates.reduce((sum, quest) => sum + getNumber(quest.final.xp_concedido, 0), 0);\nconst xpTotalAnterior = getNumber(estado.xp_total, 0);\nconst xpBaseHistorico = Math.max(0, xpTotalAnterior - totalXpQuestsAntes);\nconst xpQuestsGanho = totalXpQuestsDepois - totalXpQuestsAntes;\nconst totalXpGanhoHoje = xpBase + bonusStreak + Math.max(0, xpQuestsGanho);\nconst xpTotalFinal = xpTotalAnterior + totalXpGanhoHoje;\n\nlet nivelAtual = getNumber(estado.nivel_atual, 1);\nlet xpProximoNivel = getNumber(estado.xp_proximo_nivel, 200);\nlet tituloNivel = estado.titulo_nivel || 'Explorador';\n\nconst niveis = {\n  1: { titulo: 'Explorador', xp: 200 },\n  2: { titulo: 'Aprendiz', xp: 550 },\n  3: { titulo: 'Observador', xp: 1050 },\n  4: { titulo: 'Focado', xp: 1700 },\n  5: { titulo: 'Praticante', xp: 2500 },\n  6: { titulo: 'Consciente', xp: 3450 },\n  7: { titulo: 'Iluminado', xp: 4550 },\n  8: { titulo: 'Sﾃ｡bio', xp: 5800 },\n  9: { titulo: 'Ascendente', xp: 7200 },\n  10: { titulo: 'Mestre', xp: 9000 },\n  15: { titulo: 'Transcendente', xp: 15000 }\n};\n\nlet nivelTemp = nivelAtual;\nlet xpThreshold = xpProximoNivel;\nwhile (xpTotalFinal >= xpThreshold && nivelTemp < 15) {\n  nivelTemp += 1;\n  if (niveis[nivelTemp]) {\n    xpThreshold = niveis[nivelTemp].xp;\n    tituloNivel = niveis[nivelTemp].titulo;\n  } else {\n    xpThreshold = (nivelTemp * 150) + 50;\n    tituloNivel = `Nﾃｭvel ${nivelTemp}`;\n  }\n}\nif (nivelTemp !== nivelAtual) {\n  nivelAtual = nivelTemp;\n  xpProximoNivel = xpThreshold;\n}\n\nconst melhorStreak = Math.max(getNumber(estado.melhor_streak, 0), diasConsecutivos);\nconst ultimaConquistaId = novasConquistas.length > 0 ? novasConquistas[novasConquistas.length - 1].usuario_quest_id : (estado.ultima_conquista_id ?? null);\nconst ultimaConquistaData = novasConquistas.length > 0 ? novasConquistas[novasConquistas.length - 1].concluido_em : (estado.ultima_conquista_data ?? null);\n\nconst questsSnapshot = questStates.map((quest) => ({\n  usuario_quest_id: quest.id,\n  quest_id: quest.quest_id,\n  codigo: quest.codigo,\n  titulo: quest.titulo,\n  descricao: quest.descricao,\n  categoria: quest.categoria,\n  tipo: quest.tipo,\n  status: quest.final.status,\n  progresso_atual: quest.final.progresso_atual,\n  progresso_meta: quest.meta,\n  progresso_percentual: quest.final.progresso_percentual,\n  xp_concedido: quest.final.xp_concedido,\n  xp_recompensa: quest.xp_recompensa,\n  referencia_data: quest.referencia_data,\n  concluido_em: quest.final.concluido_em\n}));\n\nconst questsPorCategoria = questsSnapshot.reduce((acc, quest) => {\n  if (!acc[quest.categoria]) {\n    acc[quest.categoria] = [];\n  }\n  acc[quest.categoria].push(quest);\n  return acc;\n}, {});\n\nreturn [{\n  json: {\n    usuario_id: estado.usuario_id ?? $('start').first().json.usuario_id,\n    xp_total: xpTotalFinal,\n    nivel_atual: nivelAtual,\n    xp_proximo_nivel: xpProximoNivel,\n    titulo_nivel: tituloNivel,\n    streak_conversas_dias: diasConsecutivos,\n    melhor_streak: melhorStreak,\n    ultima_conversa_data: dataHoje,\n    quest_diaria_status: questDiariaStatus,\n    quest_diaria_progresso: questDiariaProgresso,\n    quest_diaria_descricao: questDiariaDescricao,\n    quest_diaria_data: dataHoje,\n    quest_diaria_id: questDiariaId,\n    total_conversas: totalConversas,\n    total_reflexoes: totalReflexoes,\n    total_xp_ganho_hoje: totalXpGanhoHoje,\n    ultima_conquista_id: ultimaConquistaId,\n    ultima_conquista_data: ultimaConquistaData,\n    dias_consecutivos: diasConsecutivos,\n    xp_base: xpBase,\n    bonus_streak: bonusStreak,\n    xp_bonus_quests: xpBonusQuests,\n    quest_updates: JSON.stringify(questUpdatesPayload),\n    quests_snapshot: questsSnapshot,\n    quests_por_categoria: questsPorCategoria,\n    novas_conquistas: novasConquistas,\n    tem_reflexao: temReflexao,\n    total_palavras: totalPalavras,\n    _debug: {\n      totalConversasAntes,\n      totalConversas,\n      totalReflexoesAntes,\n      totalReflexoes,\n      diasConsecutivos,\n      xpBase,\n      bonusStreak,\n      xpBonusQuests,\n      totalXpQuestsAntes,\n      totalXpQuestsDepois,\n      xpBaseHistorico,\n      xpQuestsGanho,\n      totalXpGanhoHoje,\n      quests_processadas: questStates.length,\n      novasConquistas,\n      questsSnapshot\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        320
      ],
      "id": "2eda95ee-231d-4b62-ad3a-7816c49d94b3",
      "name": "Calcular Gamificaﾃｧﾃ｣o"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE gamificacao SET\n  xp_total = {{ Number($json.xp_total ?? 0) }}::integer,\n  nivel_atual = {{ Number($json.nivel_atual ?? 1) }}::integer,\n  xp_proximo_nivel = {{ Number($json.xp_proximo_nivel ?? 200) }}::integer,\n  titulo_nivel = '{{ ($json.titulo_nivel ?? \"Explorador\").replace(/'/g, \"''\") }}'::varchar(50),\n  streak_conversas_dias = {{ Number($json.streak_conversas_dias ?? 0) }}::integer,\n  melhor_streak = {{ Number($json.melhor_streak ?? 0) }}::integer,\n  ultima_conversa_data = '{{ $json.ultima_conversa_data ?? (new Date().toISOString().split('T')[0]) }}'::date,\n  quest_diaria_status = '{{ ($json.quest_diaria_status ?? \"pendente\").replace(/'/g, \"''\") }}'::varchar(20),\n  quest_diaria_progresso = {{ Number($json.quest_diaria_progresso ?? 0) }}::integer,\n  quest_diaria_descricao = NULLIF('{{ ($json.quest_diaria_descricao ?? \"\").replace(/'/g, \"''\") }}', '')::text,\n  quest_diaria_data = '{{ $json.quest_diaria_data ?? (new Date().toISOString().split('T')[0]) }}'::date,\n  total_conversas = {{ Number($json.total_conversas ?? 0) }}::integer,\n  total_reflexoes = {{ Number($json.total_reflexoes ?? 0) }}::integer,\n  total_xp_ganho_hoje = {{ Number($json.total_xp_ganho_hoje ?? 0) }}::integer,\n  ultima_conquista_id = NULLIF('{{ ($json.ultima_conquista_id ?? \"\").replace(/'/g, \"''\") }}', '')::varchar(50),\n  ultima_conquista_data = NULLIF('{{ ($json.ultima_conquista_data ?? \"\").replace(/'/g, \"''\") }}', '')::timestamp,\n  atualizado_em = NOW()\nWHERE usuario_id = $1::uuid\nRETURNING *;",
        "options": {
          "queryReplacement": "={{ $('start').first().json.usuario_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1008,
        320
      ],
      "id": "59cfed24-efe9-4a56-bfe3-ad799bf49eda",
      "name": "Atualizar Gamificaﾃｧﾃ｣o",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1216,
        320
      ],
      "id": "14a5197c-37cc-4cad-a166-f07547d5a734",
      "name": "Preparar Resultado"
    },
    {
      "parameters": {
        "content": "## 式 WORKFLOW: ATUALIZAﾃﾃグ DE GAMIFICAﾃﾃグ\n\n**Recebe:**\n- usuario_id\n- chat_id  \n- data_conversa\n- tem_reflexao (boolean)\n- total_palavras (number)\n\n**Processa:**\n1. Busca estado atual\n2. Calcula XP (base + bﾃｴnus)\n3. Atualiza streak\n4. Verifica conquistas\n5. Atualiza quest diﾃ｡ria\n6. Calcula novo nﾃｭvel\n7. Salva tudo no DB\n\n**Retorna:**\n- Estado atualizado completo\n- Debug info (XP ganho, conquistas, etc)",
        "height": 460,
        "width": 360,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1328,
        80
      ],
      "id": "a6b040ee-cb39-475d-a2b0-c6c8fc46ae16",
      "name": "Sticky Note - Info"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "\nSELECT\n  uq.id,\n  uq.quest_id,\n  uq.status,\n  uq.progresso_atual,\n  uq.progresso_meta,\n  uq.progresso_percentual,\n  uq.xp_concedido,\n  uq.referencia_data,\n  uq.dados_extras,\n  uq.concluido_em,\n  qc.codigo,\n  qc.titulo,\n  qc.descricao,\n  qc.categoria,\n  qc.tipo,\n  qc.gatilho_tipo,\n  qc.gatilho_valor,\n  qc.xp_recompensa,\n  qc.repeticao,\n  qc.sequencia\nFROM usuarios_quest uq\nJOIN quest_catalog qc ON qc.id = uq.quest_id\nWHERE uq.usuario_id = $1::uuid;\n",
        "options": {
          "queryReplacement": "={{ $('start').first().json.usuario_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        32,
        320
      ],
      "id": "37a9ac1d-966b-4fad-bdab-3db4f05c87f9",
      "name": "Buscar Quests",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "\nWITH updates AS (\n  SELECT\n    (item->>'quest_record_id')::uuid AS quest_record_id,\n    COALESCE(NULLIF(item->>'status', ''), 'pendente') AS status,\n    COALESCE((item->>'progresso_atual')::integer, 0) AS progresso_atual,\n    COALESCE((item->>'progresso_percentual')::integer, 0) AS progresso_percentual,\n    COALESCE((item->>'xp_concedido')::integer, 0) AS xp_concedido,\n    NULLIF(item->>'concluido_em', '')::timestamp AS concluido_em,\n    NULLIF(item->>'dados_extras', '') AS dados_extras_raw\n  FROM jsonb_array_elements('{{ ($json.quest_updates ?? '[]').replace(/'/g, \"''\") }}'::jsonb) AS item\n)\nUPDATE usuarios_quest uq\nSET\n  status = updates.status,\n  progresso_atual = updates.progresso_atual,\n  progresso_percentual = updates.progresso_percentual,\n  xp_concedido = updates.xp_concedido,\n  concluido_em = updates.concluido_em,\n  dados_extras = CASE\n    WHEN updates.dados_extras_raw IS NULL THEN uq.dados_extras\n    ELSE updates.dados_extras_raw::jsonb\n  END,\n  atualizado_em = NOW()\nFROM updates\nWHERE uq.id = updates.quest_record_id;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        400,
        320
      ],
      "id": "04a4be39-c9ae-4d32-b20c-1fc03def4679",
      "name": "Atualizar Quests",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH base AS (\n  SELECT\n    '{{ ($('Calcular Gamificaﾃｧﾃ｣o').first().json.usuario_id ?? $('start').first().json.usuario_id).replace(\"'\", \"''\") }}'::uuid AS usuario_id,\n    '{{ $('Calcular Gamificaﾃｧﾃ｣o').first().json.ultima_conversa_data ?? (new Date().toISOString().split('T')[0]) }}'::date AS referencia_data\n),\nstats AS (\n  SELECT\n    uq.usuario_id,\n    COALESCE(SUM(uq.xp_concedido), 0) AS xp_total,\n    COALESCE(SUM(uq.xp_concedido) FILTER (\n      WHERE uq.concluido_em IS NOT NULL\n        AND uq.concluido_em::date = base.referencia_data\n    ), 0) AS xp_total_hoje,\n    COALESCE(MAX(uq.progresso_atual) FILTER (WHERE qc.gatilho_tipo = 'total_conversas'), 0) AS total_conversas,\n    COALESCE(MAX(uq.progresso_atual) FILTER (WHERE qc.gatilho_tipo = 'total_reflexoes'), 0) AS total_reflexoes\n  FROM usuarios_quest uq\n  JOIN quest_catalog qc ON qc.id = uq.quest_id\n  JOIN base ON base.usuario_id = uq.usuario_id\n  GROUP BY uq.usuario_id\n),\ndaily AS (\n  SELECT\n    uq.id AS usuario_quest_id,\n    uq.status,\n    uq.progresso_percentual,\n    COALESCE(NULLIF(qc.descricao, ''), qc.titulo) AS descricao\n  FROM usuarios_quest uq\n  JOIN quest_catalog qc ON qc.id = uq.quest_id\n  JOIN base ON base.usuario_id = uq.usuario_id\n  WHERE qc.tipo = 'diaria'\n    AND uq.referencia_data = base.referencia_data\n  ORDER BY uq.atualizado_em DESC\n  LIMIT 1\n),\nultima AS (\n  SELECT\n    uq.quest_id,\n    uq.concluido_em\n  FROM usuarios_quest uq\n  JOIN base ON base.usuario_id = uq.usuario_id\n  WHERE uq.status = 'completa'\n    AND uq.concluido_em IS NOT NULL\n  ORDER BY uq.concluido_em DESC\n  LIMIT 1\n)\nSELECT\n  base.usuario_id,\n  base.referencia_data,\n  COALESCE(stats.xp_total, 0) AS xp_total,\n  COALESCE(stats.xp_total_hoje, 0) AS xp_total_hoje,\n  COALESCE(stats.total_conversas, 0) AS total_conversas,\n  COALESCE(stats.total_reflexoes, 0) AS total_reflexoes,\n  COALESCE(daily.status, 'pendente') AS quest_diaria_status,\n  COALESCE(daily.progresso_percentual, 0) AS quest_diaria_progresso,\n  daily.descricao AS quest_diaria_descricao,\n  daily.usuario_quest_id AS quest_diaria_usuario_quest_id,\n  ultima.quest_id AS ultima_conquista_id,\n  ultima.concluido_em AS ultima_conquista_data\nFROM base\nLEFT JOIN stats ON stats.usuario_id = base.usuario_id\nLEFT JOIN daily ON TRUE\nLEFT JOIN ultima ON TRUE;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        608,
        320
      ],
      "id": "bb1758b6-bb84-4491-897b-8405dd032986",
      "name": "Consolidar Estatﾃｭsticas",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const getNumber = (value, fallback = 0) => {\n  const num = Number(value);\n  return Number.isFinite(num) ? num : fallback;\n};\n\nconst estado = ($('Buscar Estado Atual').first()?.json) ?? {};\nconst processamento = ($('Calcular Gamificaﾃｧﾃ｣o').first()?.json) ?? {};\nconst agregados = $input.first()?.json ?? {};\n\nconst xpTotal = getNumber(agregados.xp_total, 0);\nconst xpTotalHoje = getNumber(agregados.xp_total_hoje, 0);\nconst totalConversas = getNumber(agregados.total_conversas, 0);\nconst totalReflexoes = getNumber(agregados.total_reflexoes, 0);\nconst diasConsecutivos = getNumber(estado.dias_consecutivos, 0);\n\nconst niveis = [\n  { nivel: 1, xp: 200, titulo: 'Explorador' },\n  { nivel: 2, xp: 550, titulo: 'Aprendiz' },\n  { nivel: 3, xp: 1050, titulo: 'Observador' },\n  { nivel: 4, xp: 1700, titulo: 'Focado' },\n  { nivel: 5, xp: 2500, titulo: 'Praticante' },\n  { nivel: 6, xp: 3450, titulo: 'Consciente' },\n  { nivel: 7, xp: 4550, titulo: 'Iluminado' },\n  { nivel: 8, xp: 5800, titulo: 'Sﾃ｡bio' },\n  { nivel: 9, xp: 7200, titulo: 'Ascendente' },\n  { nivel: 10, xp: 9000, titulo: 'Mestre' },\n  { nivel: 15, xp: 15000, titulo: 'Transcendente' },\n];\n\nlet nivelAtual = 1;\nlet xpProximoNivel = niveis[0].xp;\nlet tituloNivel = niveis[0].titulo;\n\nfor (const entry of niveis) {\n  if (xpTotal < entry.xp) {\n    nivelAtual = entry.nivel;\n    xpProximoNivel = entry.xp;\n    tituloNivel = entry.titulo;\n    break;\n  }\n  nivelAtual = entry.nivel;\n  xpProximoNivel = entry.xp;\n  tituloNivel = entry.titulo;\n}\n\nif (xpTotal >= niveis[niveis.length - 1].xp) {\n  nivelAtual = niveis[niveis.length - 1].nivel;\n  xpProximoNivel = niveis[niveis.length - 1].xp;\n  tituloNivel = niveis[niveis.length - 1].titulo;\n}\n\nconst melhor_streak = Math.max(getNumber(estado.melhor_streak, 0), diasConsecutivos);\nconst referenciaData =\n  agregados.referencia_data ??\n  processamento.ultima_conversa_data ??\n  new Date().toISOString().split('T')[0];\n\nconst questDiariaStatus = agregados.quest_diaria_status ?? 'pendente';\nconst questDiariaProgresso = getNumber(agregados.quest_diaria_progresso, 0);\nconst questDiariaDescricao = agregados.quest_diaria_descricao ?? null;\nconst questDiariaId = agregados.quest_diaria_usuario_quest_id ?? null;\n\nreturn [\n  {\n    json: {\n      ...processamento,\n      xp_total: xpTotal,\n      total_xp_ganho_hoje: xpTotalHoje,\n      nivel_atual: nivelAtual,\n      xp_proximo_nivel: xpProximoNivel,\n      titulo_nivel: tituloNivel,\n      streak_conversas_dias: diasConsecutivos,\n      melhor_streak: melhor_streak,\n      ultima_conversa_data: referenciaData,\n      quest_diaria_status: questDiariaStatus,\n      quest_diaria_progresso: questDiariaProgresso,\n      quest_diaria_descricao: questDiariaDescricao,\n      quest_diaria_data: referenciaData,\n      quest_diaria_id: questDiariaId,\n      total_conversas: totalConversas,\n      total_reflexoes: totalReflexoes,\n      ultima_conquista_id:\n        agregados.ultima_conquista_id ?? processamento.ultima_conquista_id ?? null,\n      ultima_conquista_data:\n        agregados.ultima_conquista_data ?? processamento.ultima_conquista_data ?? null,\n    },\n  },\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        320
      ],
      "id": "ce6c1ee1-199b-4c7f-a72e-8f237f1f3460",
      "name": "Montar Resumo"
    }
  ],
  "pinData": {
    "start": [
      {
        "json": {
          "usuario_id": "8c6046bf-cf23-4da4-9689-a46b9e154b90",
          "chat_id": "eab0eba6-d26b-4356-ba14-3c3dcf59798b",
          "data_conversa": "Sun Nov 02 2025 00:00:00 GMT+0000 (Coordinated Universal Time)",
          "tem_reflexao": true,
          "justificativa_reflexao": "Aldo demonstrou reflexﾃ｣o profunda ao analisar suas emoﾃｧﾃｵes complexas e oscilantes, compreendendo como o hiperfoco e a calmaria influenciam seu estado emocional. Ele fez conexﾃｵes claras entre os eventos da separaﾃｧﾃ｣o, seus sentimentos atuais e as estratﾃｩgias que usa para lidar com o vazio. Revelou autoconhecimento ao reconhecer tanto o alﾃｭvio quanto a angﾃｺstia, e questionou seus prﾃｳprios padrﾃｵes de enfrentamento, mostrando aprendizado e compreensﾃ｣o de sua situaﾃｧﾃ｣o interna.",
          "total_palavras_usuario": 195
        }
      }
    ]
  },
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Buscar Estado Atual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Estado Atual": {
      "main": [
        [
          {
            "node": "Garantir Quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular Gamificaﾃｧﾃ｣o": {
      "main": [
        [
          {
            "node": "Atualizar Quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Gamificaﾃｧﾃ｣o": {
      "main": [
        [
          {
            "node": "Preparar Resultado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Quests": {
      "main": [
        [
          {
            "node": "Calcular Gamificaﾃｧﾃ｣o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Quests": {
      "main": [
        [
          {
            "node": "Consolidar Estatﾃｭsticas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Garantir Quests": {
      "main": [
        [
          {
            "node": "Buscar Quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consolidar Estatﾃｭsticas": {
      "main": [
        [
          {
            "node": "Montar Resumo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Montar Resumo": {
      "main": [
        [
          {
            "node": "Atualizar Gamificaﾃｧﾃ｣o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "746cc9b0-7129-429f-839a-dc53a8f348eb",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "8b04959d79052d9a4fde27fe8830b1f9748281331c826275aabfed3697b200b7"
  },
  "id": "agXJK8Dd49If1eFx",
  "tags": []
}