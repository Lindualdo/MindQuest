{
  "createdAt": "2025-10-10T11:10:56.623Z",
  "id": "agXJK8Dd49If1eFx",
  "name": "sw_experts_gamification",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usuario_id"
            },
            {
              "name": "quests_personalizadas",
              "type": "json"
            },
            {
              "name": "atualizacoes_status",
              "type": "json"
            }
          ]
        }
      },
      "id": "47408d45-3ae1-4ec5-8f4c-daf908a24a84",
      "name": "start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -1400,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "const item = $input.item.json || {};\n\nconst parseList = (value) => {\n  if (!value) return [];\n  if (Array.isArray(value)) return value;\n  if (typeof value === 'string') {\n    try {\n      const parsed = JSON.parse(value);\n      if (Array.isArray(parsed)) return parsed;\n    } catch (error) {}\n  }\n  return [];\n};\n\nconst usuarioId = item.usuario_id;\nif (!usuarioId) {\n  throw new Error('usuario_id obrigatÃ³rio');\n}\n\nconst quests = parseList(item.quests_personalizadas);\nconst updates = parseList(item.atualizacoes_status);\n\nreturn [{\n  json: {\n    usuario_id: usuarioId,\n    novas_quests: quests,\n    atualizacoes: updates\n  }\n}];"
      },
      "id": "3c5a0ce1-2c60-4f90-96ef-6d22dddf200c",
      "name": "Normalizar Entrada",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1180,
        200
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH existentes AS (\n  SELECT\n    qi.id,\n    qi.meta_codigo,\n    qi.status,\n    qi.contexto_origem,\n    qi.progresso_meta,\n    qi.progresso_atual,\n    qm.titulo,\n    qm.descricao,\n    qm.config\n  FROM public.quest_instancias qi\n  JOIN public.quest_modelos qm ON qm.id = qi.modelo_id\n  WHERE qi.usuario_id = $1::uuid\n    AND qm.tipo = 'personalizada'\n    AND qi.status IN ('pendente','ativa')\n)\nSELECT\n  eu.usuario_id,\n  eu.nivel_atual,\n  eu.titulo_nivel,\n  eu.xp_total,\n  eu.meta_sequencia_codigo,\n  eu.proxima_meta_codigo,\n  eu.sequencia_status,\n  COALESCE(\n    jsonb_agg(\n      jsonb_build_object(\n        'instancia_id', existentes.id,\n        'meta_codigo', existentes.meta_codigo,\n        'status', existentes.status,\n        'contexto_origem', existentes.contexto_origem,\n        'progresso_meta', existentes.progresso_meta,\n        'progresso_atual', existentes.progresso_atual,\n        'titulo', existentes.titulo,\n        'descricao', existentes.descricao,\n        'config', existentes.config\n      )\n    ) FILTER (WHERE existentes.id IS NOT NULL),\n    '[]'::jsonb\n  ) AS quests_ativas\nFROM public.quest_estado_usuario eu\nLEFT JOIN existentes ON TRUE\nWHERE eu.usuario_id = $1::uuid\nGROUP BY\n  eu.usuario_id,\n  eu.nivel_atual,\n  eu.titulo_nivel,\n  eu.xp_total,\n  eu.meta_sequencia_codigo,\n  eu.proxima_meta_codigo,\n  eu.sequencia_status;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id] }}"
        }
      },
      "id": "6c0c0553-6e31-4c25-8a11-594321f5b2b4",
      "name": "Buscar Estado e Quests",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -960,
        200
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const entrada = $items(\"Normalizar Entrada\", 0, 0).json || {};\nconst estado = $input.item.json || {};\nconst existentes = Array.isArray(estado.quests_ativas) ? estado.quests_ativas : [];\n\nconst limite = 4;\nconst disponivel = Math.max(limite - existentes.length, 0);\n\nconst dedupe = new Set();\nfor (const existente of existentes) {\n  const contexto = (existente.contexto_origem || '').toLowerCase();\n  const titulo = (existente.titulo || '').toLowerCase();\n  dedupe.add(`${contexto}|${titulo}`);\n}\n\nconst novos = [];\nfor (const quest of entrada.novas_quests || []) {\n  if (!quest || typeof quest !== 'object') continue;\n  const contexto = (quest.contexto_origem || '').toLowerCase();\n  const titulo = (quest.titulo || '').toLowerCase();\n  const key = `${contexto}|${titulo}`;\n  if (dedupe.has(key)) continue;\n  if (novos.length >= disponivel) break;\n  const codigo = quest.codigo && String(quest.codigo).trim()\n    ? String(quest.codigo).trim()\n    : `qp_${Date.now()}_${Math.random().toString(16).slice(2, 8)}`;\n  dedupe.add(key || codigo);\n  novos.push({\n    ...quest,\n    codigo,\n    prioridade: quest.prioridade || 'media',\n    recorrencia: quest.recorrencia || 'unica',\n    status_inicial: quest.status_inicial || 'pendente',\n    progresso_meta: quest.progresso_meta ?? 1,\n    xp_recompensa: quest.xp_recompensa ?? 0\n  });\n}\n\nreturn [{\n  json: {\n    usuario_id: entrada.usuario_id,\n    novas_quests: novos,\n    atualizacoes: entrada.atualizacoes || [],\n    estado_inicial: estado\n  }\n}];"
      },
      "id": "3bd3f8c0-ff7e-4db8-9c8e-bfbacdd2b048",
      "name": "Preparar Operacoes",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -740,
        200
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH payload AS (\n  SELECT\n    $1::uuid AS usuario_id,\n    $2::jsonb AS novas_quests,\n    $3::jsonb AS atualizacoes,\n    $4::jsonb AS estado_inicial\n),\nrows AS (\n  SELECT\n    (rec->>'codigo')::text AS codigo,\n    rec->>'titulo' AS titulo,\n    rec->>'descricao' AS descricao,\n    rec->>'contexto_origem' AS contexto_origem,\n    rec->>'prioridade' AS prioridade,\n    rec->>'recorrencia' AS recorrencia,\n    (rec->>'prazo_inicio')::date AS prazo_inicio,\n    (rec->>'prazo_fim')::date AS prazo_fim,\n    COALESCE((rec->>'progresso_meta')::int, 1) AS progresso_meta,\n    rec->>'status_inicial' AS status_inicial,\n    COALESCE((rec->>'xp_recompensa')::int, 0) AS xp_recompensa,\n    COALESCE(rec->'payload_extra', '{}'::jsonb) AS payload_extra\n  FROM payload,\n       jsonb_array_elements(payload.novas_quests) rec\n),\nupsert AS (\n  INSERT INTO public.quest_modelos (\n    id,\n    codigo,\n    titulo,\n    descricao,\n    tipo,\n    gatilho_codigo,\n    gatilho_valor,\n    xp_recompensa,\n    repeticao,\n    ordem_inicial,\n    ativo,\n    config,\n    criado_em,\n    atualizado_em\n  )\n  SELECT\n    gen_random_uuid(),\n    COALESCE(NULLIF(rows.codigo, ''), 'quest_' || encode(gen_random_bytes(6), 'hex')),\n    COALESCE(rows.titulo, 'Quest Personalizada'),\n    rows.descricao,\n    'personalizada',\n    'manual',\n    rows.progresso_meta,\n    rows.xp_recompensa,\n    CASE rows.recorrencia WHEN 'diaria' THEN 'recorrente' WHEN 'semanal' THEN 'recorrente' ELSE 'unica' END,\n    NULL,\n    TRUE,\n    jsonb_build_object(\n      'prioridade', rows.prioridade,\n      'recorrencia', rows.recorrencia,\n      'payload_extra', rows.payload_extra\n    ),\n    NOW(),\n    NOW()\n  FROM rows\n  ON CONFLICT (codigo) DO UPDATE\n  SET\n    titulo = EXCLUDED.titulo,\n    descricao = EXCLUDED.descricao,\n    gatilho_valor = EXCLUDED.gatilho_valor,\n    xp_recompensa = EXCLUDED.xp_recompensa,\n    repeticao = EXCLUDED.repeticao,\n    ativo = TRUE,\n    config = EXCLUDED.config,\n    atualizado_em = NOW()\n  RETURNING id, codigo\n)\nSELECT\n  payload.usuario_id,\n  payload.novas_quests,\n  payload.atualizacoes,\n  payload.estado_inicial,\n  COALESCE(jsonb_agg(jsonb_build_object('codigo', upsert.codigo, 'modelo_id', upsert.id)), '[]'::jsonb) AS modelos_upsertidos\nFROM payload\nLEFT JOIN upsert ON TRUE\nGROUP BY payload.usuario_id, payload.novas_quests, payload.atualizacoes, payload.estado_inicial;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id, JSON.stringify($json.novas_quests ?? []), JSON.stringify($json.atualizacoes ?? []), JSON.stringify($json.estado_inicial ?? {})] }}"
        }
      },
      "id": "7e28c9a1-8761-4af4-8390-2070e5b14b86",
      "name": "Inserir Modelos",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -520,
        200
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH payload AS (\n  SELECT\n    $1::uuid AS usuario_id,\n    $2::jsonb AS novas_quests,\n    $3::jsonb AS atualizacoes,\n    $4::jsonb AS estado_inicial\n),\nrows AS (\n  SELECT\n    payload.usuario_id,\n    COALESCE(rec->>'codigo', '') AS codigo,\n    rec->>'status_inicial' AS status_inicial,\n    COALESCE((rec->>'progresso_meta')::int, 1) AS progresso_meta,\n    COALESCE((rec->>'xp_recompensa')::int, 0) AS xp_recompensa,\n    rec->>'contexto_origem' AS contexto_origem,\n    (rec->>'prazo_inicio')::date AS prazo_inicio,\n    (rec->>'prazo_fim')::date AS prazo_fim\n  FROM payload,\n       jsonb_array_elements(payload.novas_quests) rec\n),\ninserted AS (\n  INSERT INTO public.quest_instancias (\n    id,\n    usuario_id,\n    modelo_id,\n    meta_codigo,\n    status,\n    progresso_atual,\n    progresso_meta,\n    progresso_percentual,\n    xp_concedido,\n    tentativas,\n    janela_inicio,\n    janela_fim,\n    contexto_origem,\n    referencia_data,\n    reiniciada_em,\n    ativado_em,\n    atualizado_em,\n    concluido_em,\n    cancelado_em\n  )\n  SELECT\n    gen_random_uuid(),\n    rows.usuario_id,\n    qm.id,\n    rows.codigo,\n    COALESCE(NULLIF(rows.status_inicial, ''), 'pendente'),\n    0,\n    rows.progresso_meta,\n    0,\n    rows.xp_recompensa,\n    1,\n    rows.prazo_inicio,\n    rows.prazo_fim,\n    rows.contexto_origem,\n    rows.prazo_inicio,\n    NULL,\n    NOW(),\n    NOW(),\n    NULL,\n    NULL\n  FROM rows\n  JOIN public.quest_modelos qm ON qm.codigo = rows.codigo\n  WHERE rows.codigo <> ''\n    AND NOT EXISTS (\n      SELECT 1\n      FROM public.quest_instancias qi\n      WHERE qi.usuario_id = rows.usuario_id\n        AND qi.meta_codigo = rows.codigo\n        AND qi.status IN ('pendente','ativa')\n    )\n  RETURNING meta_codigo\n),\natualiza_estado AS (\n  UPDATE public.quest_estado_usuario\n  SET\n    total_quests_personalizadas = total_quests_personalizadas + (SELECT COUNT(*) FROM inserted),\n    atualizado_em = NOW()\n  WHERE usuario_id = (SELECT usuario_id FROM payload)\n  RETURNING total_quests_personalizadas\n)\nSELECT\n  payload.usuario_id,\n  payload.novas_quests,\n  payload.atualizacoes,\n  payload.estado_inicial,\n  COALESCE((SELECT COUNT(*) FROM inserted), 0) AS novas_inseridas,\n  COALESCE(jsonb_agg(inserted.meta_codigo), '[]'::jsonb) AS codigos_inseridos\nFROM payload\nLEFT JOIN inserted ON TRUE\nGROUP BY payload.usuario_id, payload.novas_quests, payload.atualizacoes, payload.estado_inicial;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id, JSON.stringify($json.novas_quests ?? []), JSON.stringify($json.atualizacoes ?? []), JSON.stringify($json.estado_inicial ?? {})] }}"
        }
      },
      "id": "83e6055b-ef17-45aa-9621-94fd93361958",
      "name": "Inserir Instancias",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -300,
        200
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH payload AS (\n  SELECT\n    $1::uuid AS usuario_id,\n    $2::jsonb AS atualizacoes,\n    $3::jsonb AS estado_inicial,\n    $4::jsonb AS novas_quests\n),\nupdates AS (\n  SELECT\n    payload.usuario_id,\n    (rec->>'meta_codigo')::text AS meta_codigo,\n    (rec->>'instancia_id')::uuid AS instancia_id,\n    COALESCE(rec->>'novo_status', 'pendente') AS novo_status,\n    COALESCE((rec->>'progresso_atual')::int, 0) AS progresso_atual,\n    COALESCE((rec->>'xp_extra')::int, 0) AS xp_extra\n  FROM payload,\n       jsonb_array_elements(payload.atualizacoes) rec\n),\nalvos AS (\n  SELECT\n    qi.id,\n    qi.usuario_id,\n    qi.meta_codigo,\n    qi.progresso_meta,\n    qi.xp_concedido,\n    updates.novo_status,\n    updates.progresso_atual,\n    updates.xp_extra\n  FROM updates\n  JOIN public.quest_instancias qi\n    ON (\n      updates.instancia_id IS NOT NULL AND qi.id = updates.instancia_id\n    ) OR (\n      updates.instancia_id IS NULL\n      AND updates.meta_codigo IS NOT NULL\n      AND qi.meta_codigo = updates.meta_codigo\n      AND qi.usuario_id = updates.usuario_id\n      AND qi.status IN ('pendente','ativa')\n    )\n  WHERE qi.usuario_id = updates.usuario_id\n),\natualizados AS (\n  UPDATE public.quest_instancias qi\n  SET\n    status = COALESCE(alvos.novo_status, qi.status),\n    progresso_atual = alvos.progresso_atual,\n    progresso_percentual = CASE\n      WHEN qi.progresso_meta > 0 THEN LEAST(100, GREATEST(0, ROUND(alvos.progresso_atual::numeric / qi.progresso_meta::numeric * 100)))\n      ELSE qi.progresso_percentual\n    END,\n    atualizado_em = NOW(),\n    concluido_em = CASE WHEN alvos.novo_status = 'concluida' THEN NOW() ELSE qi.concluido_em END,\n    cancelado_em = CASE WHEN alvos.novo_status = 'cancelada' THEN NOW() ELSE qi.cancelado_em END,\n    reiniciada_em = CASE WHEN alvos.novo_status = 'reiniciada' THEN NOW() ELSE qi.reiniciada_em END\n  FROM alvos\n  WHERE qi.id = alvos.id\n  RETURNING\n    qi.id,\n    alvos.novo_status,\n    alvos.xp_extra,\n    qi.xp_concedido\n),\nxp_total AS (\n  SELECT\n    COALESCE(SUM(CASE WHEN novo_status = 'concluida' THEN COALESCE(xp_concedido, 0) + COALESCE(xp_extra, 0) ELSE 0 END), 0) AS xp_ganho,\n    COALESCE(SUM(CASE WHEN novo_status = 'concluida' THEN 1 ELSE 0 END), 0) AS concluidas,\n    COALESCE(SUM(CASE WHEN novo_status = 'reiniciada' THEN 1 ELSE 0 END), 0) AS reinicios\n  FROM atualizados\n),\natualiza_estado AS (\n  UPDATE public.quest_estado_usuario\n  SET\n    xp_total = quest_estado_usuario.xp_total + (SELECT xp_ganho FROM xp_total),\n    total_quests_concluidas = quest_estado_usuario.total_quests_concluidas + (SELECT concluidas FROM xp_total),\n    total_xp_hoje = quest_estado_usuario.total_xp_hoje + (SELECT xp_ganho FROM xp_total),\n    sequencia_status = jsonb_set(\n      COALESCE(quest_estado_usuario.sequencia_status, '{}'::jsonb),\n      '{reinicios}',\n      to_jsonb(\n        COALESCE((quest_estado_usuario.sequencia_status ->> 'reinicios')::int, 0) + (SELECT reinicios FROM xp_total)\n      ),\n      true\n    ),\n    atualizado_em = NOW()\n  WHERE quest_estado_usuario.usuario_id = (SELECT usuario_id FROM payload LIMIT 1)\n  RETURNING quest_estado_usuario.usuario_id\n)\nSELECT\n  payload.usuario_id,\n  payload.novas_quests,\n  payload.atualizacoes,\n  payload.estado_inicial,\n  (SELECT xp_ganho FROM xp_total) AS xp_ganho,\n  (SELECT concluidas FROM xp_total) AS quests_concluidas,\n  (SELECT reinicios FROM xp_total) AS reinicios\nFROM payload;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id, JSON.stringify($json.atualizacoes ?? []), JSON.stringify($json.estado_inicial ?? {}), JSON.stringify($json.novas_quests ?? [])] }}"
        }
      },
      "id": "6cbb6b18-ec9a-4d91-9d89-99c5c7eab3ac",
      "name": "Aplicar Atualizacoes",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -80,
        200
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH estado AS (\n  SELECT\n    eu.usuario_id,\n    eu.xp_total,\n    (\n      SELECT n.nivel\n      FROM public.quest_niveis n\n      WHERE eu.xp_total >= n.xp_minimo\n      ORDER BY n.nivel DESC\n      LIMIT 1\n    ) AS nivel_atual,\n    (\n      SELECT n.nome\n      FROM public.quest_niveis n\n      WHERE eu.xp_total >= n.xp_minimo\n      ORDER BY n.nivel DESC\n      LIMIT 1\n    ) AS titulo_nivel,\n    (\n      SELECT n.xp_proximo_nivel\n      FROM public.quest_niveis n\n      WHERE eu.xp_total >= n.xp_minimo\n      ORDER BY n.nivel DESC\n      LIMIT 1\n    ) AS xp_proximo_nivel\n  FROM public.quest_estado_usuario eu\n  WHERE eu.usuario_id = $1::uuid\n),\natualizado AS (\n  UPDATE public.quest_estado_usuario eu\n  SET\n    nivel_atual = estado.nivel_atual,\n    titulo_nivel = estado.titulo_nivel,\n    xp_proximo_nivel = estado.xp_proximo_nivel,\n    atualizado_em = NOW()\n  FROM estado\n  WHERE eu.usuario_id = estado.usuario_id\n  RETURNING\n    eu.usuario_id,\n    eu.xp_total,\n    eu.nivel_atual,\n    eu.titulo_nivel,\n    eu.xp_proximo_nivel\n)\nSELECT\n  atualizado.usuario_id,\n  atualizado.xp_total,\n  atualizado.nivel_atual,\n  atualizado.titulo_nivel,\n  atualizado.xp_proximo_nivel,\n  $2::numeric AS xp_ganho,\n  $3::integer AS quests_concluidas,\n  $4::integer AS reinicios,\n  $5::jsonb AS novas_quests,\n  $6::jsonb AS atualizacoes,\n  $7::jsonb AS estado_inicial\nFROM atualizado;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id, $json.xp_ganho ?? 0, $json.quests_concluidas ?? 0, $json.reinicios ?? 0, JSON.stringify($json.novas_quests ?? []), JSON.stringify($json.atualizacoes ?? []), JSON.stringify($json.estado_inicial ?? {})] }}"
        }
      },
      "id": "a3e35df2-9c1d-4e28-9b0d-fd508ddc7ac3",
      "name": "Atualizar Estado",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        140,
        200
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH personalizadas AS (\n  SELECT\n    qi.id,\n    qi.meta_codigo,\n    qi.status,\n    qi.contexto_origem,\n    qi.progresso_meta,\n    qi.progresso_atual,\n    qi.concluido_em,\n    qm.titulo,\n    qm.descricao,\n    qm.config\n  FROM public.quest_instancias qi\n  JOIN public.quest_modelos qm ON qm.id = qi.modelo_id\n  WHERE qi.usuario_id = $1::uuid\n    AND qm.tipo = 'personalizada'\n)\nSELECT\n  eu.usuario_id,\n  eu.xp_total,\n  eu.nivel_atual,\n  eu.titulo_nivel,\n  eu.xp_proximo_nivel,\n  eu.sequencia_atual,\n  eu.sequencia_recorde,\n  eu.meta_sequencia_codigo,\n  eu.proxima_meta_codigo,\n  eu.sequencia_status,\n  COALESCE(\n    jsonb_agg(\n      jsonb_build_object(\n        'instancia_id', personalizadas.id,\n        'meta_codigo', personalizadas.meta_codigo,\n        'status', personalizadas.status,\n        'contexto_origem', personalizadas.contexto_origem,\n        'progresso_meta', personalizadas.progresso_meta,\n        'progresso_atual', personalizadas.progresso_atual,\n        'concluido_em', personalizadas.concluido_em,\n        'titulo', personalizadas.titulo,\n        'descricao', personalizadas.descricao,\n        'config', personalizadas.config\n      )\n    ) FILTER (WHERE personalizadas.id IS NOT NULL),\n    '[]'::jsonb\n  ) AS quests_personalizadas\nFROM public.quest_estado_usuario eu\nLEFT JOIN personalizadas ON TRUE\nWHERE eu.usuario_id = $1::uuid\nGROUP BY\n  eu.usuario_id,\n  eu.xp_total,\n  eu.nivel_atual,\n  eu.titulo_nivel,\n  eu.xp_proximo_nivel,\n  eu.sequencia_atual,\n  eu.sequencia_recorde,\n  eu.meta_sequencia_codigo,\n  eu.proxima_meta_codigo,\n  eu.sequencia_status;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id] }}"
        }
      },
      "id": "e0c940c1-5d2e-47d3-8fdf-4d6e4c2ef049",
      "name": "Buscar Snapshot Final",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        360,
        200
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const estadoAtualizado = $items(\"Atualizar Estado\", 0, 0).json || {};\nconst snapshotFinal = $input.item.json || {};\n\nreturn [{\n  json: {\n    usuario_id: estadoAtualizado.usuario_id,\n    xp_total: estadoAtualizado.xp_total,\n    nivel_atual: estadoAtualizado.nivel_atual,\n    titulo_nivel: estadoAtualizado.titulo_nivel,\n    xp_proximo_nivel: estadoAtualizado.xp_proximo_nivel,\n    xp_ganho: estadoAtualizado.xp_ganho,\n    quests_concluidas_no_evento: estadoAtualizado.quests_concluidas,\n    reinicios_registrados: estadoAtualizado.reinicios,\n    novas_quests_registradas: estadoAtualizado.novas_quests || [],\n    atualizacoes_processadas: estadoAtualizado.atualizacoes || [],\n    snapshot_final: snapshotFinal\n  }\n}];"
      },
      "id": "9b54d53a-8aa7-43c9-a0e8-0ea96a9b43b0",
      "name": "Montar Resposta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        580,
        200
      ]
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Normalizar Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Entrada": {
      "main": [
        [
          {
            "node": "Buscar Estado e Quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Estado e Quests": {
      "main": [
        [
          {
            "node": "Preparar Operacoes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Operacoes": {
      "main": [
        [
          {
            "node": "Inserir Modelos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inserir Modelos": {
      "main": [
        [
          {
            "node": "Inserir Instancias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inserir Instancias": {
      "main": [
        [
          {
            "node": "Aplicar Atualizacoes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aplicar Atualizacoes": {
      "main": [
        [
          {
            "node": "Atualizar Estado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Estado": {
      "main": [
        [
          {
            "node": "Buscar Snapshot Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Snapshot Final": {
      "main": [
        [
          {
            "node": "Montar Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "f7f9bf9e-d6e7-4cdd-9d2a-4e924dd6c112",
  "shared": [
    {
      "createdAt": "2025-10-10T11:10:56.623Z",
      "role": "workflow:owner",
      "workflowId": "agXJK8Dd49If1eFx",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}