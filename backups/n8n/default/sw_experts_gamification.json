{
  "updatedAt": "2025-11-01T16:32:26.311Z",
  "createdAt": "2025-10-10T11:10:56.623Z",
  "id": "agXJK8Dd49If1eFx",
  "name": "sw_experts_gamification",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usuario_id"
            },
            {
              "name": "chat_id"
            },
            {
              "name": "data_conversa"
            },
            {
              "name": "tem_reflexao",
              "type": "boolean"
            },
            {
              "name": "justificativa_reflexao"
            },
            {
              "name": "total_palavras_usuario",
              "type": "number"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -304,
        256
      ],
      "id": "44a0cf36-d8c2-4e6b-ab98-fd55756766e9",
      "name": "start"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH ultimos_7_dias AS (\n  -- Gera os ﾃｺltimos 7 dias (hoje atﾃｩ 6 dias atrﾃ｡s)\n  SELECT \n    CURRENT_DATE - INTERVAL '1 day' * s.dia as data\n  FROM generate_series(0, 6) as s(dia)\n),\nconversas_por_dia AS (\n  -- Verifica quais desses 7 dias tiveram conversa\n  SELECT \n    d.data,\n    CASE \n      WHEN EXISTS (\n        SELECT 1 FROM usr_chat \n        WHERE usuario_id = $1::uuid \n        AND DATE(data_conversa) = d.data\n      ) THEN 1 \n      ELSE 0 \n    END as teve_conversa\n  FROM ultimos_7_dias d\n  ORDER BY d.data DESC\n),\nstreak_consecutivo AS (\n  -- Conta consecutivos de hoje para trﾃ｡s atﾃｩ encontrar 0\n  SELECT \n    data,\n    teve_conversa,\n    -- Soma cumulativa de dias SEM conversa (0 = teve, 1+ = nﾃ｣o teve)\n    SUM(CASE WHEN teve_conversa = 0 THEN 1 ELSE 0 END) \n      OVER (ORDER BY data DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as quebras\n  FROM conversas_por_dia\n)\nSELECT \n  g.*,\n  COALESCE((\n    SELECT COUNT(*) \n    FROM streak_consecutivo \n    WHERE teve_conversa = 1 \n      AND quebras = 0  -- Sﾃｳ conta antes da primeira quebra\n  ), 0) as dias_consecutivos,\n  (SELECT COUNT(*) FROM usr_chat WHERE usuario_id = g.usuario_id AND DATE(data_conversa) = CURRENT_DATE) as conversas_hoje\nFROM gamificacao g\nWHERE g.usuario_id = $1::uuid;",
        "options": {
          "queryReplacement": "={{ $('start').first().json.usuario_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -48,
        256
      ],
      "id": "580df701-2a45-4f31-928a-a1356484e2b9",
      "name": "Buscar Estado Atual",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH inserted_base AS (\n  INSERT INTO usuarios_quest (\n    usuario_id,\n    quest_id,\n    status,\n    progresso_meta,\n    referencia_data\n  )\n  SELECT\n    $1::uuid,\n    qc.id,\n    'pendente',\n    COALESCE(qc.gatilho_valor, CASE WHEN qc.tipo = 'diaria' THEN 1 ELSE NULL END),\n    NULL\n  FROM quest_catalog qc\n  WHERE qc.ativo = TRUE\n    AND qc.tipo <> 'diaria'\n    AND NOT EXISTS (\n      SELECT 1\n      FROM usuarios_quest uq\n      WHERE uq.usuario_id = $1::uuid\n        AND uq.quest_id = qc.id\n    )\n  RETURNING id\n),\ninserted_daily AS (\n  INSERT INTO usuarios_quest (\n    usuario_id,\n    quest_id,\n    status,\n    progresso_meta,\n    referencia_data\n  )\n  SELECT\n    $1::uuid,\n    qc.id,\n    'pendente',\n    COALESCE(qc.gatilho_valor, 1),\n    CURRENT_DATE\n  FROM quest_catalog qc\n  WHERE qc.ativo = TRUE\n    AND qc.tipo = 'diaria'\n    AND NOT EXISTS (\n      SELECT 1\n      FROM usuarios_quest uq\n      WHERE uq.usuario_id = $1::uuid\n        AND uq.quest_id = qc.id\n        AND uq.referencia_data = CURRENT_DATE\n    )\n  RETURNING id\n)\nSELECT\n  COALESCE((SELECT COUNT(*) FROM inserted_base), 0) AS inseridos_padrao,\n  COALESCE((SELECT COUNT(*) FROM inserted_daily), 0) AS inseridos_diarios;",
        "options": {
          "queryReplacement": "={{ $('start').first().json.usuario_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        160,
        80
      ],
      "id": "d8f1f224-5dba-4d91-a7bb-3f8b40ad7c98",
      "name": "Garantir Quests",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ==========================================\n// Cﾃ´CULO DE XP E ATUALIZAﾃﾃグ DE GAMIFICAﾃﾃグ\n// ==========================================\n\nconst getNumber = (value, fallback = 0) => {\n  const num = Number(value);\n  return Number.isFinite(num) ? num : fallback;\n};\n\nconst toNumberOrNull = (value) => {\n  if (value === null || value === undefined || value === '') {\n    return null;\n  }\n  const num = Number(value);\n  return Number.isFinite(num) ? num : null;\n};\n\nconst parseJson = (value) => {\n  if (!value) {\n    return null;\n  }\n  if (typeof value === 'object') {\n    return value;\n  }\n  try {\n    return JSON.parse(String(value));\n  } catch (error) {\n    return null;\n  }\n};\n\nconst estado = ($('Buscar Estado Atual').first()?.json) ?? {};\nconst questsRaw = $('Buscar Quests').all().map((item) => item.json ?? {});\nconst resumo = ($('start').first()?.json) ?? {};\n\nconst temReflexao = resumo.tem_reflexao === true || resumo.tem_reflexao === 'true' || resumo.tem_reflexao === ':true';\nconst totalPalavras = getNumber(resumo.total_palavras_usuario, 0);\n\nconst dataConversaRaw = resumo.data_conversa ?? estado.ultima_conversa_data ?? new Date().toISOString();\nconst dataHoje = new Date(dataConversaRaw).toISOString().split('T')[0];\n\nconst totalConversasAntes = getNumber(estado.total_conversas, 0);\nconst totalConversas = totalConversasAntes + 1;\nconst totalReflexoesAntes = getNumber(estado.total_reflexoes, 0);\nconst totalReflexoes = totalReflexoesAntes + (temReflexao ? 1 : 0);\nconst diasConsecutivos = getNumber(estado.dias_consecutivos, 0);\n\n// === 1. Cﾃ´CULO DE XP BASE ===\nlet xpBase = 20;\nif (temReflexao && totalPalavras > 50) {\n  xpBase = 40;\n} else if (temReflexao) {\n  xpBase = 30;\n}\n\n// === 2. Bﾃ年US DE STREAK ===\nlet bonusStreak = 0;\nif (diasConsecutivos >= 30) {\n  bonusStreak = 20;\n} else if (diasConsecutivos >= 7) {\n  bonusStreak = 10;\n}\n\n// === 3. PREPARAR DADOS DOS QUESTS ===\nconst nowIso = new Date().toISOString();\nconst questStates = questsRaw.map((quest) => {\n  const dadosExtras = parseJson(quest.dados_extras) ?? null;\n  const metaRaw = quest.progresso_meta ?? quest.gatilho_valor ?? (quest.tipo === 'diaria' ? 1 : null);\n  const meta = metaRaw !== null ? toNumberOrNull(metaRaw) : null;\n  const referenciaData = quest.referencia_data ? String(quest.referencia_data).split('T')[0] : null;\n\n  return {\n    id: quest.id,\n    quest_id: quest.quest_id,\n    codigo: quest.codigo,\n    titulo: quest.titulo,\n    descricao: quest.descricao,\n    categoria: quest.categoria,\n    tipo: quest.tipo,\n    gatilho_tipo: quest.gatilho_tipo,\n    gatilho_valor: quest.gatilho_valor,\n    xp_recompensa: getNumber(quest.xp_recompensa, 0),\n    repeticao: quest.repeticao,\n    sequencia: getNumber(quest.sequencia, 0),\n    referencia_data: referenciaData,\n    dados_extras: dadosExtras,\n    meta: meta,\n    original: {\n      status: quest.status,\n      progresso_atual: getNumber(quest.progresso_atual, 0),\n      progresso_percentual: getNumber(quest.progresso_percentual, 0),\n      xp_concedido: getNumber(quest.xp_concedido, 0),\n      concluido_em: quest.concluido_em ?? null\n    },\n    final: {\n      status: quest.status,\n      progresso_atual: getNumber(quest.progresso_atual, 0),\n      progresso_percentual: getNumber(quest.progresso_percentual, 0),\n      xp_concedido: getNumber(quest.xp_concedido, 0),\n      concluido_em: quest.concluido_em ?? null,\n      dados_extras: dadosExtras\n    }\n  };\n});\n\nconst progressValues = {\n  total_conversas: totalConversas,\n  dias_consecutivos: diasConsecutivos,\n  total_reflexoes: totalReflexoes,\n  diario: temReflexao ? 1 : 0\n};\n\nlet xpBonusQuests = 0;\nconst novasConquistas = [];\n\nfor (const quest of questStates) {\n  const meta = quest.meta;\n\n  if (quest.gatilho_tipo && Object.prototype.hasOwnProperty.call(progressValues, quest.gatilho_tipo)) {\n    const candidate = progressValues[quest.gatilho_tipo];\n    if (quest.gatilho_tipo === 'diario') {\n      const dailyMeta = meta && meta > 0 ? meta : 1;\n      quest.final.progresso_atual = temReflexao ? dailyMeta : 0;\n    } else if (candidate > quest.final.progresso_atual) {\n      quest.final.progresso_atual = candidate;\n    }\n  }\n\n  if (quest.gatilho_tipo === 'diario') {\n    quest.final.progresso_percentual = temReflexao ? 100 : 0;\n  } else if (meta && meta > 0) {\n    const percentual = (quest.final.progresso_atual / meta) * 100;\n    quest.final.progresso_percentual = Math.min(100, Math.round(percentual));\n  } else {\n    quest.final.progresso_percentual = Math.min(100, quest.final.progresso_percentual);\n  }\n\n  let shouldComplete = false;\n  if (quest.original.status !== 'completa') {\n    if (quest.gatilho_tipo === 'diario') {\n      shouldComplete = temReflexao;\n    } else if (meta && meta > 0 && quest.final.progresso_atual >= meta) {\n      shouldComplete = true;\n    }\n  }\n\n  if (shouldComplete) {\n    quest.final.status = 'completa';\n    quest.final.progresso_atual = meta ?? quest.final.progresso_atual;\n    quest.final.progresso_percentual = 100;\n    quest.final.concluido_em = nowIso;\n    if (quest.final.xp_concedido < quest.xp_recompensa) {\n      const xpToAdd = quest.xp_recompensa - quest.final.xp_concedido;\n      xpBonusQuests += xpToAdd;\n      quest.final.xp_concedido = quest.xp_recompensa;\n      novasConquistas.push({\n        usuario_quest_id: quest.id,\n        codigo: quest.codigo,\n        titulo: quest.titulo,\n        categoria: quest.categoria,\n        xp_bonus: quest.xp_recompensa,\n        concluido_em: nowIso\n      });\n    }\n  } else if (quest.final.status === 'pendente' && (quest.final.progresso_atual > 0 || quest.final.progresso_percentual > 0)) {\n    quest.final.status = 'ativa';\n  }\n}\n\nconst systemQuests = questStates\n  .filter((quest) => quest.tipo === 'sistema')\n  .sort((a, b) => a.sequencia - b.sequencia);\n\nfor (const quest of systemQuests) {\n  if (quest.final.status !== 'completa') {\n    const allPreviousComplete = systemQuests\n      .filter((other) => other.sequencia < quest.sequencia)\n      .every((other) => other.final.status === 'completa');\n    if (allPreviousComplete && quest.final.status === 'pendente') {\n      quest.final.status = 'ativa';\n    }\n    break;\n  }\n}\n\nconst questUpdatesPayload = questStates\n  .filter((quest) =>\n    quest.final.status !== quest.original.status ||\n    quest.final.progresso_atual !== quest.original.progresso_atual ||\n    quest.final.progresso_percentual !== quest.original.progresso_percentual ||\n    quest.final.xp_concedido !== quest.original.xp_concedido ||\n    (quest.final.concluido_em ?? null) !== (quest.original.concluido_em ?? null)\n  )\n  .map((quest) => ({\n    quest_record_id: quest.id,\n    status: quest.final.status,\n    progresso_atual: quest.final.progresso_atual,\n    progresso_percentual: quest.final.progresso_percentual,\n    xp_concedido: quest.final.xp_concedido,\n    concluido_em: quest.final.concluido_em,\n    dados_extras: quest.final.dados_extras\n  }));\n\nconst dailyQuestHoje = questStates.find((quest) => quest.tipo === 'diaria' && quest.referencia_data === dataHoje);\nlet questDiariaStatus = estado.quest_diaria_status ?? 'pendente';\nlet questDiariaProgresso = getNumber(estado.quest_diaria_progresso, 0);\nlet questDiariaDescricao = estado.quest_diaria_descricao ?? null;\nlet questDiariaId = estado.quest_diaria_id ?? null;\n\nif (dailyQuestHoje) {\n  questDiariaDescricao = dailyQuestHoje.descricao || dailyQuestHoje.titulo || questDiariaDescricao;\n  questDiariaProgresso = dailyQuestHoje.final.progresso_percentual;\n  questDiariaId = dailyQuestHoje.id;\n  if (dailyQuestHoje.final.progresso_percentual >= 100 || dailyQuestHoje.final.status === 'completa') {\n    questDiariaStatus = 'completa';\n  } else if (dailyQuestHoje.final.progresso_percentual > 0) {\n    questDiariaStatus = 'parcial';\n  } else {\n    questDiariaStatus = 'pendente';\n  }\n}\n\nconst xpGanho = xpBase + bonusStreak + xpBonusQuests;\nconst xpTotalAnterior = getNumber(estado.xp_total, 0);\nlet xpTotalFinal = xpTotalAnterior + xpGanho;\n\nlet nivelAtual = getNumber(estado.nivel_atual, 1);\nlet xpProximoNivel = getNumber(estado.xp_proximo_nivel, 200);\nlet tituloNivel = estado.titulo_nivel || 'Explorador';\n\nconst niveis = {\n  1: { titulo: 'Explorador', xp: 200 },\n  2: { titulo: 'Aprendiz', xp: 550 },\n  3: { titulo: 'Observador', xp: 1050 },\n  4: { titulo: 'Focado', xp: 1700 },\n  5: { titulo: 'Praticante', xp: 2500 },\n  6: { titulo: 'Consciente', xp: 3450 },\n  7: { titulo: 'Iluminado', xp: 4550 },\n  8: { titulo: 'Sﾃ｡bio', xp: 5800 },\n  9: { titulo: 'Ascendente', xp: 7200 },\n  10: { titulo: 'Mestre', xp: 9000 },\n  15: { titulo: 'Transcendente', xp: 15000 }\n};\n\nwhile (xpTotalFinal >= xpProximoNivel && nivelAtual < 15) {\n  nivelAtual += 1;\n  if (niveis[nivelAtual]) {\n    xpProximoNivel = niveis[nivelAtual].xp;\n    tituloNivel = niveis[nivelAtual].titulo;\n  } else {\n    xpProximoNivel = (nivelAtual * 150) + 50;\n    tituloNivel = `Nﾃｭvel ${nivelAtual}`;\n  }\n}\n\nconst melhorStreak = Math.max(getNumber(estado.melhor_streak, 0), diasConsecutivos);\nconst ultimaConquistaId = novasConquistas.length > 0 ? novasConquistas[novasConquistas.length - 1].usuario_quest_id : (estado.ultima_conquista_id ?? null);\nconst ultimaConquistaData = novasConquistas.length > 0 ? novasConquistas[novasConquistas.length - 1].concluido_em : (estado.ultima_conquista_data ?? null);\n\nconst questsSnapshot = questStates.map((quest) => ({\n  usuario_quest_id: quest.id,\n  quest_id: quest.quest_id,\n  codigo: quest.codigo,\n  titulo: quest.titulo,\n  descricao: quest.descricao,\n  categoria: quest.categoria,\n  tipo: quest.tipo,\n  status: quest.final.status,\n  progresso_atual: quest.final.progresso_atual,\n  progresso_meta: quest.meta,\n  progresso_percentual: quest.final.progresso_percentual,\n  xp_concedido: quest.final.xp_concedido,\n  xp_recompensa: quest.xp_recompensa,\n  referencia_data: quest.referencia_data,\n  concluido_em: quest.final.concluido_em\n}));\n\nconst questsPorCategoria = questsSnapshot.reduce((acc, quest) => {\n  if (!acc[quest.categoria]) {\n    acc[quest.categoria] = [];\n  }\n  acc[quest.categoria].push(quest);\n  return acc;\n}, {});\n\nreturn [{\n  json: {\n    usuario_id: estado.usuario_id ?? $('start').first().json.usuario_id,\n    xp_total: xpTotalFinal,\n    nivel_atual: nivelAtual,\n    xp_proximo_nivel: xpProximoNivel,\n    titulo_nivel: tituloNivel,\n    streak_conversas_dias: diasConsecutivos,\n    melhor_streak: melhorStreak,\n    ultima_conversa_data: dataHoje,\n    quest_diaria_status: questDiariaStatus,\n    quest_diaria_progresso: questDiariaProgresso,\n    quest_diaria_descricao: questDiariaDescricao,\n    quest_diaria_data: dataHoje,\n    quest_diaria_id: questDiariaId,\n    total_conversas: totalConversas,\n    total_reflexoes: totalReflexoes,\n    total_xp_ganho_hoje: xpGanho,\n    ultima_conquista_id: ultimaConquistaId,\n    ultima_conquista_data: ultimaConquistaData,\n    dias_consecutivos: diasConsecutivos,\n    xp_base: xpBase,\n    bonus_streak: bonusStreak,\n    xp_bonus_quests: xpBonusQuests,\n    quest_updates: JSON.stringify(questUpdatesPayload),\n    quests_snapshot: questsSnapshot,\n    quests_por_categoria: questsPorCategoria,\n    novas_conquistas: novasConquistas,\n    tem_reflexao: temReflexao,\n    total_palavras: totalPalavras,\n    _debug: {\n      totalConversasAntes,\n      totalConversas,\n      totalReflexoesAntes,\n      totalReflexoes,\n      diasConsecutivos,\n      xpBase,\n      bonusStreak,\n      xpBonusQuests,\n      quests_processadas: questStates.length,\n      novasConquistas,\n      questsSnapshot\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        352,
        256
      ],
      "id": "4a291762-7a90-4c94-936b-cd960f9a4559",
      "name": "Calcular Gamificaﾃｧﾃ｣o"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE gamificacao SET\n  xp_total = {{ Number($json.xp_total ?? 0) }}::integer,\n  nivel_atual = {{ Number($json.nivel_atual ?? 1) }}::integer,\n  xp_proximo_nivel = {{ Number($json.xp_proximo_nivel ?? 200) }}::integer,\n  titulo_nivel = '{{ ($json.titulo_nivel ?? \"Explorador\").replace(/'/g, \"''\") }}'::varchar(50),\n  streak_conversas_dias = {{ Number($json.streak_conversas_dias ?? 0) }}::integer,\n  melhor_streak = {{ Number($json.melhor_streak ?? 0) }}::integer,\n  ultima_conversa_data = '{{ $json.ultima_conversa_data ?? (new Date().toISOString().split('T')[0]) }}'::date,\n  quest_diaria_status = '{{ ($json.quest_diaria_status ?? \"pendente\").replace(/'/g, \"''\") }}'::varchar(20),\n  quest_diaria_progresso = {{ Number($json.quest_diaria_progresso ?? 0) }}::integer,\n  quest_diaria_descricao = NULLIF('{{ ($json.quest_diaria_descricao ?? \"\").replace(/'/g, \"''\") }}', '')::text,\n  quest_diaria_data = '{{ $json.quest_diaria_data ?? (new Date().toISOString().split('T')[0]) }}'::date,\n  total_conversas = {{ Number($json.total_conversas ?? 0) }}::integer,\n  total_reflexoes = {{ Number($json.total_reflexoes ?? 0) }}::integer,\n  total_xp_ganho_hoje = {{ Number($json.total_xp_ganho_hoje ?? 0) }}::integer,\n  ultima_conquista_id = NULLIF('{{ ($json.ultima_conquista_id ?? \"\").replace(/'/g, \"''\") }}', '')::varchar(50),\n  ultima_conquista_data = NULLIF('{{ ($json.ultima_conquista_data ?? \"\").replace(/'/g, \"''\") }}', '')::timestamp,\n  atualizado_em = NOW()\nWHERE usuario_id = '{{ $json.usuario_id }}'::uuid\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        736,
        256
      ],
      "id": "49577de0-10d4-4818-8649-9f6d08123480",
      "name": "Atualizar Gamificaﾃｧﾃ｣o",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        960,
        256
      ],
      "id": "e9e7d2a8-8392-4301-83b4-6a927fb1f2c5",
      "name": "Preparar Resultado"
    },
    {
      "parameters": {
        "content": "## 式 WORKFLOW: ATUALIZAﾃﾃグ DE GAMIFICAﾃﾃグ\n\n**Recebe:**\n- usuario_id\n- chat_id  \n- data_conversa\n- tem_reflexao (boolean)\n- total_palavras (number)\n\n**Processa:**\n1. Busca estado atual\n2. Calcula XP (base + bﾃｴnus)\n3. Atualiza streak\n4. Verifica conquistas\n5. Atualiza quest diﾃ｡ria\n6. Calcula novo nﾃｭvel\n7. Salva tudo no DB\n\n**Retorna:**\n- Estado atualizado completo\n- Debug info (XP ganho, conquistas, etc)",
        "height": 460,
        "width": 360,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1200,
        16
      ],
      "id": "d78db502-2fa2-4daa-a21f-0c8fcaae6bde",
      "name": "Sticky Note - Info"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "\nSELECT\n  uq.id,\n  uq.quest_id,\n  uq.status,\n  uq.progresso_atual,\n  uq.progresso_meta,\n  uq.progresso_percentual,\n  uq.xp_concedido,\n  uq.referencia_data,\n  uq.dados_extras,\n  uq.concluido_em,\n  qc.codigo,\n  qc.titulo,\n  qc.descricao,\n  qc.categoria,\n  qc.tipo,\n  qc.gatilho_tipo,\n  qc.gatilho_valor,\n  qc.xp_recompensa,\n  qc.repeticao,\n  qc.sequencia\nFROM usuarios_quest uq\nJOIN quest_catalog qc ON qc.id = uq.quest_id\nWHERE uq.usuario_id = $1::uuid;\n",
        "options": {
          "queryReplacement": "={{ $('start').first().json.usuario_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        160,
        256
      ],
      "id": "af6ff8d4-e367-4830-a215-e6b16ca6dcee",
      "name": "Buscar Quests",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "\nWITH updates AS (\n  SELECT\n    (item->>'quest_record_id')::uuid AS quest_record_id,\n    COALESCE(NULLIF(item->>'status', ''), 'pendente') AS status,\n    COALESCE((item->>'progresso_atual')::integer, 0) AS progresso_atual,\n    COALESCE((item->>'progresso_percentual')::integer, 0) AS progresso_percentual,\n    COALESCE((item->>'xp_concedido')::integer, 0) AS xp_concedido,\n    NULLIF(item->>'concluido_em', '')::timestamp AS concluido_em,\n    NULLIF(item->>'dados_extras', '') AS dados_extras_raw\n  FROM jsonb_array_elements('{{ ($json.quest_updates ?? '[]').replace(/'/g, \"''\") }}'::jsonb) AS item\n)\nUPDATE usuarios_quest uq\nSET\n  status = updates.status,\n  progresso_atual = updates.progresso_atual,\n  progresso_percentual = updates.progresso_percentual,\n  xp_concedido = updates.xp_concedido,\n  concluido_em = updates.concluido_em,\n  dados_extras = CASE\n    WHEN updates.dados_extras_raw IS NULL THEN uq.dados_extras\n    ELSE updates.dados_extras_raw::jsonb\n  END,\n  atualizado_em = NOW()\nFROM updates\nWHERE uq.id = updates.quest_record_id;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        528,
        256
      ],
      "id": "b2548aa2-d161-429c-9a3d-e15a292e3110",
      "name": "Atualizar Quests",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Buscar Estado Atual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Estado Atual": {
      "main": [
        [
          {
            "node": "Garantir Quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular Gamificaﾃｧﾃ｣o": {
      "main": [
        [
          {
            "node": "Atualizar Quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Gamificaﾃｧﾃ｣o": {
      "main": [
        [
          {
            "node": "Preparar Resultado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Quests": {
      "main": [
        [
          {
            "node": "Calcular Gamificaﾃｧﾃ｣o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Quests": {
      "main": [
        [
          {
            "node": "Atualizar Gamificaﾃｧﾃ｣o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Garantir Quests": {
      "main": [
        [
          {
            "node": "Buscar Quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "start": [
      {
        "json": {
          "usuario_id": "d949d81c-9235-41ce-8b3b-6b5d593c5e24",
          "chat_id": "dd66a9b3-d455-4730-a683-b58ca8bb4a31",
          "data_conversa": "Fri Oct 31 2025 00:00:00 GMT+0000 (Coordinated Universal Time)",
          "tem_reflexao": true,
          "justificativa_reflexao": "Aldo demonstra reflexﾃ｣o profunda ao analisar como a ansiedade interfere em suas decisﾃｵes, diferenciando os momentos em que consegue ou nﾃ｣o fazer pausas. Ele conecta seus sentimentos com estratﾃｩgias prﾃ｡ticas para controlar o medo e inseguranﾃｧa no mercado, reconhecendo sucessos pessoais e buscando adaptar ferramentas para seu processo emocional.",
          "total_palavras_usuario": 216
        }
      }
    ]
  },
  "versionId": "54a9100f-a5e2-4d84-a19e-842d4d3ff53c",
  "triggerCount": 0,
  "shared": [
    {
      "updatedAt": "2025-10-10T11:10:56.623Z",
      "createdAt": "2025-10-10T11:10:56.623Z",
      "role": "workflow:owner",
      "workflowId": "agXJK8Dd49If1eFx",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "updatedAt": "2025-09-25T16:38:18.729Z",
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "updatedAt": "2025-09-16T16:13:20.606Z",
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "updatedAt": "2025-11-02T07:12:45.501Z",
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "lastActiveAt": "2025-11-02",
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}
