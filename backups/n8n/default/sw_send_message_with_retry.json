{
  "name": "sw_send_message_with_retry",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "instanceName"
            },
            {
              "name": "remoteJid"
            },
            {
              "name": "messageText"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -2656,
        464
      ],
      "id": "4d89a479-acb2-4829-97c6-0812e6ad1b51",
      "name": "start"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "={{ $('start').item.json.instanceName }}",
        "remoteJid": "={{ $('start').item.json.remoteJid }}",
        "messageText": "={{ $('start').item.json.messageText }}",
        "options_message": {
          "delay": "={{ 2000 }}"
        }
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        -2432,
        464
      ],
      "id": "d75f2f40-7abe-48e5-ad10-e9fd31a0eac1",
      "name": "Send Message",
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 3000,
      "credentials": {
        "evolutionApi": {
          "id": "H4gurJcNVV0yrS90",
          "name": "Evolution account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first()?.json ?? {};\nconst data = response.data ?? {};\nconst statusRaw = String(data.status ?? response.status ?? 'UNKNOWN').toUpperCase();\nconst messageId = data.key?.id ?? null;\n\nconst successStatuses = new Set(['SUCCESS', 'SENT', 'DELIVERED']);\nconst transientStatuses = new Set(['PENDING', 'QUEUED', 'ACCEPTED']);\nconst successRaw = String(response.success ?? '').trim().toLowerCase();\n\nconst isSuccess = successStatuses.has(statusRaw) || (!data.status && (response.success === true || successRaw === 'true'));\nconst isTransient = transientStatuses.has(statusRaw);\nconst shouldRetry = isTransient || !isSuccess;\nconst errorMessage = data.error ?? response.error ?? null;\n\nreturn [{\n  json: {\n    success: isSuccess,\n    status: statusRaw,\n    shouldRetry,\n    isTransient,\n    messageId,\n    firstResponse: response,\n    lastResponse: response,\n    errorMessage\n  },\n  pairedItem: 0\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2240,
        464
      ],
      "id": "6891de20-ae7a-4d58-8508-3c29fe588083",
      "name": "Check Initial"
    },
    {
      "parameters": {
        "amount": "={{ 2.5 }}"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -1728,
        336
      ],
      "id": "492e5aad-c37f-4479-ae1e-0a4d66234fbe",
      "name": "Retry Delay",
      "webhookId": "c70f06a7-7b09-46dc-9217-d26a00515d2d"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "={{ $('start').item.json.instanceName }}",
        "remoteJid": "={{ $('start').item.json.remoteJid }}",
        "messageText": "={{ $('start').item.json.messageText }}",
        "options_message": {
          "delay": "={{ 2000 }}"
        }
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        -1488,
        336
      ],
      "id": "6aad54fd-5a09-4fd5-a96e-07b1fd0753ab",
      "name": "Send Message (retry)",
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 3000,
      "credentials": {
        "evolutionApi": {
          "id": "H4gurJcNVV0yrS90",
          "name": "Evolution account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first()?.json ?? {};\nconst data = response.data ?? {};\nconst statusRaw = String(data.status ?? response.status ?? 'UNKNOWN').toUpperCase();\nconst messageId = data.key?.id ?? null;\n\nconst successStatuses = new Set(['SUCCESS', 'SENT', 'DELIVERED']);\nconst transientStatuses = new Set(['PENDING', 'QUEUED', 'ACCEPTED']);\nconst successRaw = String(response.success ?? '').trim().toLowerCase();\n\nconst isSuccess = successStatuses.has(statusRaw) || (!data.status && (response.success === true || successRaw === 'true'));\nconst isTransient = transientStatuses.has(statusRaw);\nconst shouldRetry = isTransient || !isSuccess;\nconst errorMessage = data.error ?? response.error ?? null;\nconst firstContext = $('Check Initial').first()?.json ?? {};\n\nreturn [{\n  json: {\n    success: isSuccess,\n    status: statusRaw,\n    shouldRetry,\n    isTransient,\n    messageId,\n    firstResponse: firstContext.firstResponse ?? firstContext,\n    lastResponse: response,\n    errorMessage\n  },\n  pairedItem: 0\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1280,
        336
      ],
      "id": "905db196-6086-4826-87e6-3e5861af60dd",
      "name": "Check Retry"
    },
    {
      "parameters": {
        "jsCode": "const startData = $('start').first()?.json ?? {};\nconst initial = $('Check Initial').first()?.json ?? {};\nconst retry = $('Check Retry').first()?.json ?? {};\n\nreturn [{\n  json: {\n    message: 'Falha ao enviar mensagem após tentativas via Evolution API.',\n    remoteJid: startData.remoteJid ?? null,\n    instanceName: startData.instanceName ?? null,\n    messageText: startData.messageText ?? null,\n    initial,\n    retry,\n    timestamp: new Date().toISOString()\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -752,
        208
      ],
      "id": "b3c5efae-5338-4547-8bd5-625dea1dcbf9",
      "name": "Build Failure Report"
    },
    {
      "parameters": {
        "jsCode": "const payload = $input.first()?.json ?? {};\nthrow new Error(JSON.stringify(payload, null, 2));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -528,
        208
      ],
      "id": "776f85b5-a13e-4185-b208-96d6af3fa220",
      "name": "Raise Failure"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -352,
        576
      ],
      "id": "c1367bf5-baf1-43bd-9a5f-59490aa297a3",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a6584398-e020-47f1-ae63-788c2bb25414",
              "leftValue": "={{ $json.shouldRetry }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2016,
        464
      ],
      "id": "d07e550c-4fdf-4093-8cfe-5952c22997e8",
      "name": "shouldRetry"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "deb99412-312c-46d9-b4af-27e22ec72243",
              "leftValue": "={{ $json.shouldRetry }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1072,
        336
      ],
      "id": "6dfb4d9a-c18e-4386-8c5c-8fbd41ec424e",
      "name": "Retry failed?"
    },
    {
      "parameters": {
        "amount": "={{ 4 }}"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -1728,
        592
      ],
      "id": "97262a21-748d-4002-aad6-929997780459",
      "name": "Wait",
      "webhookId": "656c33df-2b6b-42f2-b1ad-9cac02bd9b77"
    }
  ],
  "pinData": {
    "start": [
      {
        "json": {
          "instanceName": "MindQuest",
          "remoteJid": "5512982389360@s.whatsapp.net",
          "messageText": "Perfeito, Aldo! Agora, informe um e-mail para recuperar seus dados caso perca esse número do WhatsApp. Por favor, use um endereço válido."
        }
      }
    ]
  },
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Send Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Message": {
      "main": [
        [
          {
            "node": "Check Initial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Initial": {
      "main": [
        [
          {
            "node": "shouldRetry",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Retry Delay": {
      "main": [
        [
          {
            "node": "Send Message (retry)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Message (retry)": {
      "main": [
        [
          {
            "node": "Check Retry",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Retry": {
      "main": [
        [
          {
            "node": "Retry failed?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Failure Report": {
      "main": [
        [
          {
            "node": "Raise Failure",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Raise Failure": {
      "main": [
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "shouldRetry": {
      "main": [
        [
          {
            "node": "Retry Delay",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Retry failed?": {
      "main": [
        [
          {
            "node": "Build Failure Report",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "executionTimeout": 120
  },
  "versionId": "4db753db-be2e-4771-a55c-f3dfdbde1e05",
  "meta": {
    "instanceId": "8b04959d79052d9a4fde27fe8830b1f9748281331c826275aabfed3697b200b7"
  },
  "id": "U44ZfEwFU77EUthb",
  "tags": []
}