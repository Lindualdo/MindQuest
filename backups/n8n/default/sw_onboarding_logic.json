{
  "updatedAt": "2025-11-01T18:51:15.495Z",
  "createdAt": "2025-11-01T18:51:15.495Z",
  "id": "mUGtccn1y8ZX5YtM",
  "name": "sw_onboarding_logic",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "incomingMessage"
            },
            {
              "name": "sessionData"
            },
            {
              "name": "fallbackName"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        0,
        0
      ],
      "id": "316ffd57-3846-400f-9854-f81f4fc0e126",
      "name": "start"
    },
    {
      "parameters": {
        "jsCode": "const incomingMessage = String($input.item.json.incomingMessage ?? '').trim();\nconst sessionRaw = $input.item.json.sessionData ?? null;\nconst fallbackName = String($input.item.json.fallbackName ?? '').trim() || null;\n\nlet session = {};\nif (sessionRaw) {\n  if (typeof sessionRaw === 'string') {\n    try {\n      session = sessionRaw ? JSON.parse(sessionRaw) : {};\n    } catch (error) {\n      session = {};\n    }\n  } else if (typeof sessionRaw === 'object' && !Array.isArray(sessionRaw)) {\n    session = sessionRaw;\n  }\n}\n\nconst normalizeEstado = (value) => {\n  if (!value) return 'inicio';\n  const normalized = String(value).toLowerCase();\n  if (['esperando_email', 'confirmacao_pendente', 'faixa_pendente'].includes(normalized)) return 'esperando_faixa';\n  if (normalized === 'nome_coletado') return 'esperando_nome';\n  if (['inicio', 'esperando_nome', 'esperando_faixa', 'completo'].includes(normalized)) return normalized;\n  return 'inicio';\n};\n\nconst cleanName = (value) => {\n  if (!value) return null;\n  let text = String(value).trim();\n  text = text.replace(/^meu nome (√©|eh)\\s*/i, '');\n  text = text.replace(/^me chamo\\s*/i, '');\n  text = text.replace(/^chamo-me\\s*/i, '');\n  text = text.replace(/^sou\\s+/i, '');\n  text = text.replace(/^nome[:\\-\\s]+/i, '');\n  text = text.replace(/^eu\\s+/i, '');\n  text = text.trim();\n  if (text.length < 2) return null;\n  if (text.length > 60) text = text.slice(0, 60).trim();\n  return text;\n};\n\nconst extractFaixaCodigo = (value) => {\n  if (!value) return null;\n  const match = String(value).match(/\\b([1-7])\\b/);\n  return match ? match[1] : null;\n};\n\nconst ageLabels = {\n  '1': '13 a 17 anos',\n  '2': '18 a 24 anos',\n  '3': '25 a 34 anos',\n  '4': '35 a 44 anos',\n  '5': '45 a 54 anos',\n  '6': '55 a 64 anos',\n  '7': '65 anos ou mais',\n};\n\nconst ageOptions = {\n  '1': '13-17',\n  '2': '18-24',\n  '3': '25-34',\n  '4': '35-44',\n  '5': '45-54',\n  '6': '55-64',\n  '7': '65+',\n};\n\nconst prevEstado = normalizeEstado(session.estado);\nlet estado = prevEstado;\nlet proximo_estado = prevEstado;\nlet tipo = 'mensagem';\nlet reply = '';\n\nlet nome_usuario = typeof session.nome_preferido === 'string' ? session.nome_preferido.trim() : null;\nlet faixa_etaria = typeof session.faixa_etaria === 'string' ? session.faixa_etaria : null;\nlet faixa_etaria_codigo = typeof session.faixa_etaria_codigo === 'string' ? session.faixa_etaria_codigo : null;\n\nif (!nome_usuario && fallbackName && fallbackName.length >= 2) {\n  nome_usuario = fallbackName;\n}\n\nif (estado === 'inicio') {\n  proximo_estado = 'esperando_nome';\n  reply = 'Oi! üëã Que bom ter voc√™ aqui no MindQuest! Vamos come√ßar rapidinho.\\n\\nComo voc√™ prefere ser chamado(a)?';\n} else if (estado === 'esperando_nome') {\n  const candidato = cleanName(incomingMessage);\n  if (candidato) {\n    nome_usuario = candidato;\n    proximo_estado = 'esperando_faixa';\n    reply = `Perfeito, ${nome_usuario}! Agora, me conta sua faixa et√°ria respondendo apenas com o n√∫mero:\\n\\n1Ô∏è‚É£ 13 a 17 anos\\n2Ô∏è‚É£ 18 a 24 anos\\n3Ô∏è‚É£ 25 a 34 anos\\n4Ô∏è‚É£ 35 a 44 anos\\n5Ô∏è‚É£ 45 a 54 anos\\n6Ô∏è‚É£ 55 a 64 anos\\n7Ô∏è‚É£ 65 anos ou mais`;\n  } else {\n    proximo_estado = 'esperando_nome';\n    reply = 'Pode me dizer como voc√™ prefere ser chamado(a)? Use pelo menos 2 letras.';\n  }\n} else if (estado === 'esperando_faixa') {\n  const codigo = extractFaixaCodigo(incomingMessage);\n  if (codigo && ageOptions[codigo]) {\n    faixa_etaria_codigo = codigo;\n    faixa_etaria = ageOptions[codigo];\n    proximo_estado = 'completo';\n    tipo = 'finalizado';\n    const nomeTratamento = nome_usuario || 'por aqui';\n    reply = `Perfeito, ${nomeTratamento}! J√° anotei tudo que precisava. Vou liberar o seu acesso agora. üôå`;\n  } else {\n    proximo_estado = 'esperando_faixa';\n    reply = 'Responda apenas com o n√∫mero de 1 a 7 que representa sua faixa et√°ria.';\n  }\n} else {\n  proximo_estado = 'completo';\n  tipo = 'finalizado';\n  reply = 'Seu cadastro j√° est√° completo. Quando quiser conversar, √© s√≥ me chamar!';\n}\n\nif (!nome_usuario && typeof session.nome_preferido === 'string') {\n  nome_usuario = session.nome_preferido.trim();\n}\nif (!faixa_etaria && typeof session.faixa_etaria === 'string') {\n  faixa_etaria = session.faixa_etaria;\n}\nif (!faixa_etaria_codigo && typeof session.faixa_etaria_codigo === 'string') {\n  faixa_etaria_codigo = session.faixa_etaria_codigo;\n}\n\nreturn {\n  json: {\n    reply,\n    proximo_estado,\n    tipo,\n    nome_usuario,\n    faixa_etaria,\n    faixa_etaria_codigo,\n    faixa_etaria_label: faixa_etaria_codigo ? ageLabels[faixa_etaria_codigo] : null\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        272,
        0
      ],
      "id": "a3276e25-f8bb-4f96-8b2d-63ba7a875591",
      "name": "Processa Regras"
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Processa Regras",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "d5fd18fd-f353-401f-a5bc-96a35ebed053",
  "triggerCount": 0,
  "shared": [
    {
      "updatedAt": "2025-11-01T18:51:15.495Z",
      "createdAt": "2025-11-01T18:51:15.495Z",
      "role": "workflow:owner",
      "workflowId": "mUGtccn1y8ZX5YtM",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "updatedAt": "2025-09-25T16:38:18.729Z",
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "updatedAt": "2025-09-16T16:13:20.606Z",
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "updatedAt": "2025-11-02T07:12:45.501Z",
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "lastActiveAt": "2025-11-02",
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}