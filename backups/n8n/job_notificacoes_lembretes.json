{
  "createdAt": "2025-12-05T14:22:05.076Z",
  "id": "i5VG5rHZ39ytueyu",
  "name": "job_notificacoes_lembretes",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "=0 7,8,10,11,13,14,16,17,19,21 * * *"
            }
          ]
        }
      },
      "id": "schedule",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -144,
        64
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH config_usuario AS (\n  SELECT \n    n.usuario_id,\n    u.nome_preferencia,\n    u.whatsapp_numero,\n    n.lembretes_ativo,\n    n.lembretes_periodo,\n    n.lembretes_conversas_diarias,\n    n.lembretes_quests,\n    n.lembretes_canais,\n    ARRAY_AGG(DISTINCT dp.token) FILTER (WHERE dp.token IS NOT NULL) AS push_tokens\n  FROM notificacoes n\n  JOIN usuarios u ON u.id = n.usuario_id\n  LEFT JOIN dispositivos_push dp ON dp.usuario_id = n.usuario_id\n  WHERE n.lembretes_ativo = true\n  GROUP BY n.usuario_id, u.nome_preferencia, u.whatsapp_numero, n.lembretes_ativo,\n           n.lembretes_periodo, n.lembretes_conversas_diarias, \n           n.lembretes_quests, n.lembretes_canais\n),\nxp_usuario AS (\n  SELECT \n    uc.usuario_id,\n    COALESCE(uc.xp_total, 0) AS xp_total,\n    COALESCE(uc.nivel_atual, 1) AS nivel_atual,\n    COALESCE(uc.sequencia_atual, 0) AS streak_dias,\n    COALESCE(uc.total_quests_concluidas, 0) AS total_conquistas\n  FROM usuarios_conquistas uc\n),\nconversas_recentes AS (\n  SELECT DISTINCT ON (c.usuario_id)\n    c.usuario_id,\n    c.criado_em AS ultima_conversa_data,\n    c.resumo_conversa AS ultima_conversa_resumo\n  FROM usr_chat c\n  WHERE c.criado_em >= CURRENT_DATE - INTERVAL '7 days'\n  ORDER BY c.usuario_id, c.criado_em DESC\n),\nconversa_hoje AS (\n  SELECT usuario_id, true AS teve_conversa_hoje\n  FROM usr_chat\n  WHERE DATE(criado_em) = CURRENT_DATE\n  GROUP BY usuario_id\n),\nquests_contexto AS (\n  SELECT \n    uq.usuario_id,\n    uq.id AS quest_id,\n    COALESCE(uq.config->>'titulo', 'Quest') AS titulo,\n    COALESCE(uq.config->>'descricao', '') AS descricao,\n    uq.sabotador_id,\n    uq.objetivo_id,\n    qr.data_planejada,\n    CASE \n      WHEN qr.data_planejada < CURRENT_DATE AND qr.status = 'pendente' THEN 'atrasada'\n      WHEN qr.data_planejada = CURRENT_DATE AND qr.status = 'pendente' THEN 'hoje'\n      WHEN qr.id IS NULL AND uq.status = 'ativa' THEN 'nao_planejada'\n      ELSE 'ok'\n    END AS urgencia\n  FROM usuarios_quest uq\n  LEFT JOIN quests_recorrencias qr ON qr.usuarios_quest_id = uq.id \n    AND qr.data_planejada <= CURRENT_DATE AND qr.status = 'pendente'\n  WHERE uq.status = 'ativa'\n),\nquests_agregadas AS (\n  SELECT \n    qc.usuario_id,\n    COUNT(*) FILTER (WHERE qc.urgencia = 'atrasada') AS quests_atrasadas,\n    COUNT(*) FILTER (WHERE qc.urgencia = 'hoje') AS quests_hoje,\n    COUNT(*) FILTER (WHERE qc.urgencia = 'nao_planejada') AS quests_nao_planejadas,\n    JSONB_AGG(\n      JSONB_BUILD_OBJECT(\n        'quest_id', qc.quest_id,\n        'titulo', qc.titulo,\n        'descricao', qc.descricao,\n        'sabotador_id', qc.sabotador_id,\n        'objetivo_id', qc.objetivo_id,\n        'urgencia', qc.urgencia,\n        'data_planejada', qc.data_planejada\n      ) ORDER BY \n        CASE qc.urgencia WHEN 'atrasada' THEN 1 WHEN 'hoje' THEN 2 WHEN 'nao_planejada' THEN 3 END,\n        qc.data_planejada NULLS LAST\n    ) AS quests_detalhes\n  FROM quests_contexto qc\n  WHERE qc.urgencia IN ('atrasada', 'hoje', 'nao_planejada')\n  GROUP BY qc.usuario_id\n),\nnotificacoes_hoje AS (\n  SELECT \n    nl.usuario_id,\n    ARRAY_AGG(DISTINCT nl.tipo) AS tipos_notificados,\n    MAX(nl.criado_em) FILTER (WHERE nl.tipo LIKE 'conversa%') AS ultima_notif_conversa,\n    MAX(nl.criado_em) FILTER (WHERE nl.tipo LIKE 'acao%') AS ultima_notif_acao\n  FROM notificacoes_log nl\n  WHERE DATE(nl.criado_em) = CURRENT_DATE\n  GROUP BY nl.usuario_id\n)\nSELECT \n  cu.usuario_id,\n  cu.nome_preferencia as nome,\n  cu.whatsapp_numero,\n  cu.lembretes_periodo,\n  cu.lembretes_conversas_diarias,\n  cu.lembretes_quests,\n  cu.lembretes_canais,\n  cu.push_tokens,\n  0 AS xp_semana,\n  0 AS conquistas_semana,\n  COALESCE(xu.nivel_atual, 1) AS nivel_atual,\n  COALESCE(xu.xp_total, 0) AS xp_total,\n  COALESCE(xu.streak_dias, 0) AS streak_dias,\n  COALESCE(ch.teve_conversa_hoje, false) AS teve_conversa_hoje,\n  conv.ultima_conversa_resumo,\n  conv.ultima_conversa_data,\n  COALESCE(qa.quests_atrasadas, 0) AS quests_atrasadas,\n  COALESCE(qa.quests_hoje, 0) AS quests_hoje,\n  COALESCE(qa.quests_nao_planejadas, 0) AS quests_nao_planejadas,\n  qa.quests_detalhes,\n  COALESCE(nh.tipos_notificados, ARRAY[]::text[]) AS tipos_notificados_hoje,\n  nh.ultima_notif_conversa,\n  nh.ultima_notif_acao\nFROM config_usuario cu\nLEFT JOIN xp_usuario xu ON xu.usuario_id = cu.usuario_id\nLEFT JOIN conversas_recentes conv ON conv.usuario_id = cu.usuario_id\nLEFT JOIN conversa_hoje ch ON ch.usuario_id = cu.usuario_id\nLEFT JOIN quests_agregadas qa ON qa.usuario_id = cu.usuario_id\nLEFT JOIN notificacoes_hoje nh ON nh.usuario_id = cu.usuario_id;",
        "options": {}
      },
      "id": "query_contexto",
      "name": "Query Contexto Completo",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        96,
        64
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1000,
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const JANELAS = {\n  manha: { conversa: [7, 8], acao: [10, 11] },\n  tarde: { conversa: [13, 14], acao: [16, 17] },\n  noite: { conversa: [19, 20, 21, 22], acao: [21, 22] }\n};\n\nconst horaAtual = new Date().getHours();\nconst resultados = [];\n\nfor (const item of $input.all()) {\n  const u = item.json;\n  const periodo = u.lembretes_periodo || 'manha';\n  const janelas = JANELAS[periodo];\n  \n  if (!janelas) continue;\n  \n  let tipo = null;\n  if (janelas.conversa.includes(horaAtual)) tipo = 'conversa';\n  else if (janelas.acao.includes(horaAtual)) tipo = 'acao';\n  \n  // Fallback: se fora da janela, escolher tipo baseado nos dados\n  if (!tipo) {\n    const totalQuests = (parseInt(u.quests_atrasadas) || 0) + (parseInt(u.quests_hoje) || 0) + (parseInt(u.quests_nao_planejadas) || 0);\n    if (totalQuests > 0 && u.lembretes_quests) {\n      tipo = 'acao';\n    } else if (!u.teve_conversa_hoje && u.lembretes_conversas_diarias) {\n      tipo = 'conversa';\n    }\n  }\n  \n  if (!tipo) continue;\n  \n  const tipos_hoje = u.tipos_notificados_hoje || [];\n  const jaNotificouConversa = tipos_hoje.some(t => t.startsWith('conversa'));\n  const jaNotificouAcao = tipos_hoje.some(t => t.startsWith('acao'));\n  \n  if (tipo === 'conversa') {\n    if (!u.lembretes_conversas_diarias) continue;\n    if (jaNotificouConversa) continue;\n    if (u.teve_conversa_hoje) continue;\n  }\n  \n  if (tipo === 'acao') {\n    if (!u.lembretes_quests) continue;\n    if (jaNotificouAcao) continue;\n    const totalQuests = (parseInt(u.quests_atrasadas) || 0) + (parseInt(u.quests_hoje) || 0) + (parseInt(u.quests_nao_planejadas) || 0);\n    if (totalQuests === 0) continue;\n  }\n  \n  const canais = u.lembretes_canais || [];\n  const temPush = canais.includes('push') && u.push_tokens?.length > 0;\n  const temWhatsapp = canais.includes('whatsapp') && u.whatsapp_numero;\n  \n  if (!temPush && !temWhatsapp) continue;\n  \n  resultados.push({\n    json: {\n      ...u,\n      tipo_notificacao: tipo,\n      canais_disponiveis: { push: temPush, whatsapp: temWhatsapp },\n      hora_atual: horaAtual\n    }\n  });\n}\n\nreturn resultados;"
      },
      "id": "determinar_tipo",
      "name": "Determinar Tipo Notificacao",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        336,
        64
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo_notificacao }}",
                    "rightValue": "conversa",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "singleValue": true
                    },
                    "id": "0bce476a-0439-44a8-9d2d-467d0d73b798"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "conversa"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo_notificacao }}",
                    "rightValue": "acao",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "singleValue": true
                    },
                    "id": "836bfdcd-d8a0-4197-b457-4e13ad1b9d6d"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "acao"
            }
          ]
        },
        "options": {}
      },
      "id": "switch_tipo",
      "name": "Switch Tipo",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        576,
        64
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "model_conversa",
      "name": "OpenRouter Conversa",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        1040,
        -16
      ],
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"titulo\": {\"type\": \"string\"},\n    \"corpo_push\": {\"type\": \"string\"},\n    \"corpo_whatsapp\": {\"type\": \"string\"},\n    \"sugestoes_resposta\": {\"type\": \"array\", \"items\": {\"type\": \"string\"}},\n    \"contexto_mentor\": {\"type\": \"string\"},\n    \"subtipo\": {\"type\": \"string\"}\n  },\n  \"required\": [\"titulo\", \"corpo_push\", \"corpo_whatsapp\", \"sugestoes_resposta\", \"contexto_mentor\", \"subtipo\"]\n}",
        "autoFix": true
      },
      "id": "parser_conversa",
      "name": "Parser Conversa",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        1248,
        -80
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=## Dados do Usuario\n- Nome: {{ $json.nome }}\n- Periodo preferido: {{ $json.lembretes_periodo }}\n\n## Contexto de Evolucao\n- Nivel atual: {{ $json.nivel_atual }}\n- XP total: {{ $json.xp_total }}\n- XP esta semana: {{ $json.xp_semana }}\n- Streak atual: {{ $json.streak_dias }} dias\n- Conquistas na semana: {{ $json.conquistas_semana }}\n\n## Ultima Conversa\n- Data: {{ $json.ultima_conversa_data }}\n- Resumo: {{ $json.ultima_conversa_resumo }}\n\n## Status Hoje\n- Ja conversou hoje: {{ $json.teve_conversa_hoje }}\n\nGere a notificacao de CONVERSA seguindo as regras do system prompt.",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=Voce eh o assistente de notificacoes do MindQuest, um app de desenvolvimento pessoal.\n\nSua tarefa eh criar UMA mensagem de notificacao para convidar o usuario a conversar com seu mentor.\n\n## Filosofia MindQuest\n- Conversar -> Entender -> Agir -> Evoluir\n- Tom: Acolhedor, humano, empatico\n- Objetivo: Engajar sem pressionar\n\n## Regras da Mensagem\n1. SEMPRE use o nome do usuario\n2. Reconheca conquistas recentes (se houver)\n3. Faca referencia a ultima conversa (se relevante)\n4. Termine com convite aberto, nunca imperativo\n5. Maximo 3 frases no corpo\n\n## Prioridade do Conteudo\n1. Se streak > 3: Celebrar consistencia (subtipo: celebracao)\n2. Se XP alto na semana: Reconhecer esforco (subtipo: celebracao)\n3. Se tem resumo de conversa: Dar continuidade (subtipo: continuidade)\n4. Caso geral: Convite acolhedor (subtipo: geral)"
        }
      },
      "id": "agente_conversa",
      "name": "Agente Conversa",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        1104,
        -288
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "model_acao",
      "name": "OpenRouter Acao",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        944,
        672
      ],
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"titulo\": {\"type\": \"string\"},\n    \"corpo_push\": {\"type\": \"string\"},\n    \"corpo_whatsapp\": {\"type\": \"string\"},\n    \"quests_mencionadas\": {\"type\": \"array\", \"items\": {\"type\": \"string\"}},\n    \"sugestoes_resposta\": {\"type\": \"array\", \"items\": {\"type\": \"string\"}},\n    \"contexto_mentor\": {\"type\": \"string\"},\n    \"subtipo\": {\"type\": \"string\"}\n  },\n  \"required\": [\"titulo\", \"corpo_push\", \"corpo_whatsapp\", \"sugestoes_resposta\", \"contexto_mentor\", \"subtipo\"]\n}",
        "autoFix": true
      },
      "id": "parser_acao",
      "name": "Parser Acao",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        1264,
        592
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=## Dados do Usuario\n- Nome: {{ $json.nome }}\n- Nivel: {{ $json.nivel_atual }}\n- Streak: {{ $json.streak_dias }} dias\n\n## Quests Pendentes\n- Total atrasadas: {{ $json.quests_atrasadas }}\n- Total hoje: {{ $json.quests_hoje }}\n- Total nao planejadas: {{ $json.quests_nao_planejadas }}\n\n## Detalhes das Quests (ordenadas por prioridade)\n{{ JSON.stringify($json.quests_detalhes) }}\n\n## Instrucoes\n1. Analise as quests e selecione no maximo 2\n2. Priorize diversidade (1 sabotador + 1 objetivo)\n3. Se quests semelhantes, escolha apenas 1\n4. Gere mensagem seguindo as regras do system prompt",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=Voce eh o assistente de notificacoes do MindQuest, um app de desenvolvimento pessoal.\n\nSua tarefa eh criar UMA mensagem de notificacao sobre quests/acoes pendentes.\n\n## Filosofia MindQuest\n- Conversar -> Entender -> Agir -> Evoluir\n- Tom: Motivador, mas sem pressao\n- Foco: Micro-acoes, pequenos passos\n\n## Regras de Selecao de Quests\n1. Priorizar quests ATRASADAS sobre pendentes\n2. Diversificar: 1 de sabotador + 1 de objetivo (se possivel)\n3. Se quests muito semelhantes: mencionar apenas 1\n4. Maximo 2 quests por notificacao\n\n## Regras da Mensagem\n1. SEMPRE use o nome do usuario\n2. Conecte a quest ao contexto (sabotador/objetivo)\n3. Destaque o beneficio da acao, nao a obrigacao\n4. Sugira micro-compromisso (5 min, 1 passo)\n5. Maximo 4 frases no corpo\n\n## Exemplos de Ganchos por Sabotador\n- Hiper-Realizador: Hora de celebrar pequenas vitorias\n- Controlador: Um passo de cada vez esta ok\n- Ansioso: 5 minutos de calma podem mudar seu dia\n- Critico: Voce merece esse cuidado\n\n## Subtipos\n- atrasada: quando tem quests atrasadas\n- hoje: quando tem quests do dia\n- planejamento: quando tem quests nao planejadas"
        }
      },
      "id": "agente_acao",
      "name": "Agente Acao",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        1120,
        288
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const input = $('Switch Tipo').item.json;\nconst iaOutput = $json.output || {};\n\nconst notificacoes = [];\nconst canais = input.canais_disponiveis;\n\nconst titulo = iaOutput.titulo || `${input.nome}, vamos conversar?`;\nconst corpo_push = iaOutput.corpo_push || 'Como esta seu dia? Seu mentor esta aqui.';\nconst corpo_whatsapp = iaOutput.corpo_whatsapp || `Oi ${input.nome}! Como esta seu dia?`;\nconst sugestoes = iaOutput.sugestoes_resposta || ['Sim, vamos!', 'Agora nao'];\nconst contexto_mentor = iaOutput.contexto_mentor || 'Notificacao de conversa';\nconst subtipo = iaOutput.subtipo || 'geral';\n\nif (canais.push) {\n  for (const token of input.push_tokens || []) {\n    notificacoes.push({\n      json: {\n        usuario_id: input.usuario_id,\n        nome: input.nome,\n        canal: 'push',\n        tipo: `conversa_${subtipo}`,\n        token,\n        titulo,\n        corpo: corpo_push,\n        contexto_mentor\n      }\n    });\n  }\n}\n\nif (canais.whatsapp) {\n  const msgWhats = corpo_whatsapp + '\\n\\n' + sugestoes.map((s, i) => `${i+1}. ${s}`).join('\\n');\n  notificacoes.push({\n    json: {\n      usuario_id: input.usuario_id,\n      nome: input.nome,\n      canal: 'whatsapp',\n      tipo: `conversa_${subtipo}`,\n      whatsapp_numero: input.whatsapp_numero,\n      titulo,\n      corpo: msgWhats,\n      contexto_mentor\n    }\n  });\n}\n\nreturn notificacoes;"
      },
      "id": "processar_conversa",
      "name": "Processar Conversa",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1584,
        -208
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $('Switch Tipo').item.json;\nconst iaOutput = $json.output || {};\n\nconst notificacoes = [];\nconst canais = input.canais_disponiveis;\n\nconst total = (input.quests_atrasadas || 0) + (input.quests_hoje || 0);\nconst titulo = iaOutput.titulo || `${input.nome}, voce tem quests pendentes`;\nconst corpo_push = iaOutput.corpo_push || `Voce tem ${total} quests esperando.`;\nconst corpo_whatsapp = iaOutput.corpo_whatsapp || `Oi ${input.nome}! Voce tem ${total} quests pendentes.`;\nconst sugestoes = iaOutput.sugestoes_resposta || ['Ver quests', 'Depois'];\nconst contexto_mentor = iaOutput.contexto_mentor || 'Notificacao de acao';\nconst subtipo = iaOutput.subtipo || 'hoje';\nconst quests_mencionadas = iaOutput.quests_mencionadas || [];\n\nif (canais.push) {\n  for (const token of input.push_tokens || []) {\n    notificacoes.push({\n      json: {\n        usuario_id: input.usuario_id,\n        nome: input.nome,\n        canal: 'push',\n        tipo: `acao_${subtipo}`,\n        token,\n        titulo,\n        corpo: corpo_push,\n        contexto_mentor,\n        quests_mencionadas\n      }\n    });\n  }\n}\n\nif (canais.whatsapp) {\n  const msgWhats = corpo_whatsapp + '\\n\\n' + sugestoes.map((s, i) => `${i+1}. ${s}`).join('\\n');\n  notificacoes.push({\n    json: {\n      usuario_id: input.usuario_id,\n      nome: input.nome,\n      canal: 'whatsapp',\n      tipo: `acao_${subtipo}`,\n      whatsapp_numero: input.whatsapp_numero,\n      titulo,\n      corpo: msgWhats,\n      contexto_mentor,\n      quests_mencionadas\n    }\n  });\n}\n\nreturn notificacoes;"
      },
      "id": "processar_acao",
      "name": "Processar Acao",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1584,
        288
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.canal }}",
                    "rightValue": "push",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "a9711ed9-a128-4dd9-882c-a12f41ac88a1"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.canal }}",
                    "rightValue": "whatsapp",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ab34d262-7796-4cec-bde5-8d85a7d6fe6f"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.canal }}",
                    "rightValue": "email",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "50020884-c59e-4fdc-a486-31bae4662e07"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "switch_canal",
      "name": "Switch Canal",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2144,
        112
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mindquest.pt/api/send-push",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "token",
              "value": "={{ $json.token }}"
            },
            {
              "name": "titulo",
              "value": "={{ $json.titulo }}"
            },
            {
              "name": "corpo",
              "value": "={{ $json.corpo }}"
            },
            {
              "name": "usuario_id",
              "value": "={{ $json.usuario_id }}"
            },
            {
              "name": "tipo",
              "value": "={{ $json.tipo }}"
            }
          ]
        },
        "options": {}
      },
      "id": "enviar_push",
      "name": "Enviar Push",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2480,
        -80
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO notificacoes_log (usuario_id, canal, tipo, titulo, mensagem, contexto_mentor, status)\nSELECT $1::uuid, 'push', $2, $3, $4, $5, 'enviado'\nWHERE NOT EXISTS (\n  SELECT 1 FROM notificacoes_log nl\n  WHERE nl.usuario_id = $1::uuid AND nl.tipo = $2 AND DATE(nl.criado_em) = CURRENT_DATE AND canal = 'push'\n)",
        "options": {
          "queryReplacement": "={{ [$('Switch Canal').item.json.usuario_id, $('Switch Canal').item.json.tipo, $('Switch Canal').item.json.titulo, $('Switch Canal').item.json.corpo, $('Switch Canal').item.json.contexto_mentor] }}"
        }
      },
      "id": "log_push",
      "name": "Log Push",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2720,
        -80
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "fVrO1PaqFuA957u0",
          "mode": "list",
          "cachedResultName": "MindQuest"
        }
      },
      "id": "config",
      "name": "Config",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        2480,
        128
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "DJB5qWudX1Hqap1O",
          "mode": "list",
          "cachedResultName": "sw_evolution_send_message_v2"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "instanceName": "={{ $json.Instancia_evolution }}",
            "remoteJidOrNumber": "={{ $('Switch Canal').item.json.whatsapp_numero }}",
            "messageText": "={{ $('Switch Canal').item.json.corpo }}",
            "minDelayMs": "2000"
          },
          "schema": [
            {
              "id": "instanceName",
              "displayName": "instanceName",
              "type": "string"
            },
            {
              "id": "remoteJidOrNumber",
              "displayName": "remoteJidOrNumber",
              "type": "string"
            },
            {
              "id": "messageText",
              "displayName": "messageText",
              "type": "string"
            },
            {
              "id": "minDelayMs",
              "displayName": "minDelayMs",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "enviar_whatsapp",
      "name": "Enviar WhatsApp",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2720,
        128
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO notificacoes_log (usuario_id, canal, tipo, titulo, mensagem, contexto_mentor, status)\nSELECT $1::uuid, 'whatsapp', $2, $3, $4, $5, 'enviado'\nWHERE NOT EXISTS (\n  SELECT 1 FROM notificacoes_log nl\n  WHERE nl.usuario_id = $1::uuid AND nl.tipo = $2 AND DATE(nl.criado_em) = CURRENT_DATE AND canal = 'whatsapp'\n)",
        "options": {
          "queryReplacement": "={{ [$('Switch Canal').item.json.usuario_id, $('Switch Canal').item.json.tipo, $('Switch Canal').item.json.titulo, $('Switch Canal').item.json.corpo, $('Switch Canal').item.json.contexto_mentor] }}"
        }
      },
      "id": "log_whatsapp",
      "name": "Log WhatsApp",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2960,
        128
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {},
      "id": "email_todo",
      "name": "Email (TODO)",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2480,
        320
      ]
    },
    {
      "parameters": {},
      "id": "end",
      "name": "End",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3200,
        128
      ]
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Query Contexto Completo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Contexto Completo": {
      "main": [
        [
          {
            "node": "Determinar Tipo Notificacao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Determinar Tipo Notificacao": {
      "main": [
        [
          {
            "node": "Switch Tipo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Tipo": {
      "main": [
        [
          {
            "node": "Agente Conversa",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Agente Acao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Conversa": {
      "ai_languageModel": [
        [
          {
            "node": "Agente Conversa",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Parser Conversa",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parser Conversa": {
      "ai_outputParser": [
        [
          {
            "node": "Agente Conversa",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Agente Conversa": {
      "main": [
        [
          {
            "node": "Processar Conversa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Acao": {
      "ai_languageModel": [
        [
          {
            "node": "Agente Acao",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Parser Acao",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parser Acao": {
      "ai_outputParser": [
        [
          {
            "node": "Agente Acao",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Agente Acao": {
      "main": [
        [
          {
            "node": "Processar Acao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Conversa": {
      "main": [
        [
          {
            "node": "Switch Canal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Acao": {
      "main": [
        [
          {
            "node": "Switch Canal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Canal": {
      "main": [
        [
          {
            "node": "Enviar Push",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Config",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Email (TODO)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Push": {
      "main": [
        [
          {
            "node": "Log Push",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Push": {
      "main": [
        [
          {
            "node": "End",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Config": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar WhatsApp": {
      "main": [
        [
          {
            "node": "Log WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log WhatsApp": {
      "main": [
        [
          {
            "node": "End",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email (TODO)": {
      "main": [
        [
          {
            "node": "End",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": {
    "node:Schedule Trigger": {
      "recurrenceRules": []
    }
  },
  "meta": null,
  "pinData": {},
  "activeVersionId": null,
  "shared": [
    {
      "createdAt": "2025-12-05T14:22:05.076Z",
      "role": "workflow:owner",
      "workflowId": "i5VG5rHZ39ytueyu",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [],
  "activeVersion": null
}
