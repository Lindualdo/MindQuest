{
  "createdAt": "2025-12-17T20:18:16.166Z",
  "id": "vGLluHVYupmxKJWT",
  "name": "job_notificacoes_v2",
  "description": null,
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 9
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        -368,
        -208
      ],
      "id": "79c3a7a5-ac81-4d64-b1db-d580e71e10a4",
      "name": "Trigger Conversas 09h"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  n.usuario_id,\n  u.nome_preferencia,\n  u.tom_conversa,\n  u.whatsapp_numero,\n  n.lembretes_canais,\n  ARRAY_AGG(DISTINCT dp.token) FILTER (WHERE dp.token IS NOT NULL) AS push_tokens,\n  CASE \n    WHEN NOT EXISTS (SELECT 1 FROM usr_chat WHERE usuario_id = n.usuario_id) \n    THEN true \n    ELSE false \n  END AS is_primeira_conversa,\n  (SELECT json_agg(json_build_object(\n    'data_conversa', c.data_conversa,\n    'resumo', c.resumo_conversa\n  ) ORDER BY c.data_conversa DESC)\n   FROM (\n     SELECT data_conversa, resumo_conversa\n     FROM usr_chat\n     WHERE usuario_id = n.usuario_id\n       AND resumo_conversa IS NOT NULL\n     ORDER BY data_conversa DESC\n   ) c\n  ) AS ultimas_conversas\nFROM notificacoes n\nINNER JOIN usuarios u ON u.id = n.usuario_id\nLEFT JOIN dispositivos_push dp ON dp.usuario_id = n.usuario_id\nWHERE n.lembretes_ativo = true\n  AND n.lembretes_conversas_diarias = true\n  AND 'whatsapp' = ANY(n.lembretes_canais)\n  AND NOT EXISTS (\n    SELECT 1 \n    FROM usr_chat c \n    WHERE c.usuario_id = n.usuario_id \n      AND DATE(c.data_conversa) = CURRENT_DATE\n  )\n  AND NOT EXISTS (\n    SELECT 1 \n    FROM notificacoes_log nl \n    WHERE nl.usuario_id = n.usuario_id \n      AND DATE(nl.criado_em) = CURRENT_DATE \n      AND nl.tipo LIKE '%conversa%'\n  )\nGROUP BY n.usuario_id, u.nome_preferencia, u.tom_conversa, u.whatsapp_numero, n.lembretes_canais;",
        "options": {}
      },
      "id": "073dab68-d3a7-4497-b0a8-b059b6e2e1df",
      "name": "usuarios_conversas",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -160,
        -208
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        112,
        -208
      ],
      "id": "0a8823ff-73c9-4a03-9cb8-49094f430bd0",
      "name": "Loop Conversas"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "kMqjjX3TeEGBkR74",
          "mode": "list",
          "cachedResultUrl": "/workflow/kMqjjX3TeEGBkR74",
          "cachedResultName": "sw_mentor_notificacoes_v2"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $('usuarios_conversas').item.json.usuario_id }}",
            "nome_preferencia": "={{ $('usuarios_conversas').item.json.nome_preferencia }}",
            "tom_conversa": "={{ $('usuarios_conversas').item.json.tom_conversa || 'empatico' }}",
            "whats_number": "={{ $('usuarios_conversas').item.json.whatsapp_numero }}",
            "lembretes_canais": "={{ $('usuarios_conversas').item.json.lembretes_canais }}",
            "push_tokens": "={{ $('usuarios_conversas').item.json.push_tokens }}",
            "tipo_notificacao": "={{ $('usuarios_conversas').item.json.is_primeira_conversa ? 'primeira_conversa' : 'conversa' }}",
            "contexto": "={{ { ultimas_conversas: $('usuarios_conversas').item.json.ultimas_conversas, is_primeira_conversa: $('usuarios_conversas').item.json.is_primeira_conversa } }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "nome_preferencia",
              "displayName": "nome_preferencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "tom_conversa",
              "displayName": "tom_conversa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "whats_number",
              "displayName": "whats_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "lembretes_canais",
              "displayName": "lembretes_canais",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "array"
            },
            {
              "id": "push_tokens",
              "displayName": "push_tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "array"
            },
            {
              "id": "tipo_notificacao",
              "displayName": "tipo_notificacao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "contexto",
              "displayName": "contexto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        400,
        -192
      ],
      "id": "774acf5e-e5c3-4e32-867d-5598d5e67b91",
      "name": "Call sw_mentor_notificacoes (conversas)"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 15
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        -528,
        160
      ],
      "id": "52bc0768-9e43-4191-bb54-5cd14a8ff2d1",
      "name": "Trigger Quests 15h"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- v2.0.0: Buscar usuários elegíveis para notificação de quest\n-- Inclui: humor, energia, quests por categoria, última categoria notificada\n\nWITH ultimo_humor AS (\n  SELECT DISTINCT ON (c.usuario_id)\n    c.usuario_id,\n    uhe.humor_dia as humor_nivel\n  FROM usuarios_humor_energia uhe\n  INNER JOIN usr_chat c ON c.id = uhe.chat_id\n  ORDER BY c.usuario_id, c.data_conversa DESC\n),\nenergia_panas AS (\n  SELECT \n    ue.usuario_id,\n    CASE WHEN COUNT(*) > 0\n      THEN ROUND((COUNT(*) FILTER (WHERE LOWER(ue.emocao_id) IN ('joy','trust','anticipation'))::numeric / COUNT(*)::numeric) * 100, 1)\n      ELSE 60 END AS percentual_positiva\n  FROM usuarios_emocoes ue\n  WHERE ue.intensidade >= 45\n  GROUP BY ue.usuario_id\n),\n-- v2.0.0: Última categoria notificada\nultima_categoria_notificada AS (\n  SELECT DISTINCT ON (nl.usuario_id)\n    nl.usuario_id,\n    CASE \n      WHEN nl.tipo LIKE '%tcc%' THEN 'tcc'\n      WHEN nl.tipo LIKE '%estoicismo%' THEN 'estoicismo'\n      WHEN nl.tipo LIKE '%sabotador%' THEN 'sabotador'\n      WHEN nl.tipo LIKE '%personalizada%' THEN 'personalizada'\n      WHEN nl.tipo LIKE '%objetivo%' THEN 'objetivo'\n      ELSE NULL\n    END AS ultima_categoria\n  FROM notificacoes_log nl\n  WHERE nl.tipo LIKE 'quest%'\n  ORDER BY nl.usuario_id, nl.criado_em DESC\n),\n-- v2.1.0: Resumo de quests do usuário por status (apenas títulos)\nquests_status_resumo AS (\n  SELECT\n    uq.usuario_id,\n    COALESCE(\n      json_agg(DISTINCT COALESCE(uq.config->>'titulo', qc.titulo)) FILTER (WHERE uq.status = 'disponivel'),\n      '[]'::json\n    ) AS quests_a_fazer,\n    COALESCE(\n      json_agg(DISTINCT COALESCE(uq.config->>'titulo', qc.titulo)) FILTER (WHERE uq.status = 'ativa'),\n      '[]'::json\n    ) AS quests_fazendo\n  FROM usuarios_quest uq\n  LEFT JOIN quests_catalogo qc ON qc.id = uq.catalogo_id\n  WHERE uq.status IN ('disponivel', 'ativa')\n  GROUP BY uq.usuario_id\n),\n-- v2.0.0: Quests agrupadas por categoria\nquests_por_categoria AS (\n  SELECT \n    uq.usuario_id,\n    json_build_object(\n      'tcc', COALESCE((SELECT json_agg(json_build_object(\n        'quest_id', uq2.id, 'titulo', uq2.config->>'titulo', 'descricao', uq2.config->>'descricao',\n        'base_cientifica', uq2.config->'base_cientifica', 'categoria', 'tcc'\n      )) FROM usuarios_quest uq2 \n      LEFT JOIN quests_catalogo qc ON qc.id = uq2.catalogo_id\n      WHERE uq2.usuario_id = uq.usuario_id AND uq2.status IN ('disponivel', 'ativa') \n        AND qc.categoria = 'tcc'), '[]'::json),\n      \n      'estoicismo', COALESCE((SELECT json_agg(json_build_object(\n        'quest_id', uq2.id, 'titulo', uq2.config->>'titulo', 'descricao', uq2.config->>'descricao',\n        'base_cientifica', uq2.config->'base_cientifica', 'categoria', 'estoicismo'\n      )) FROM usuarios_quest uq2 \n      LEFT JOIN quests_catalogo qc ON qc.id = uq2.catalogo_id\n      WHERE uq2.usuario_id = uq.usuario_id AND uq2.status IN ('disponivel', 'ativa') \n        AND qc.categoria = 'estoicismo'), '[]'::json),\n      \n      'sabotador', COALESCE((SELECT json_agg(json_build_object(\n        'quest_id', uq2.id, 'titulo', uq2.config->>'titulo', 'descricao', uq2.config->>'descricao',\n        'base_cientifica', uq2.config->'base_cientifica', 'sabotador_id', uq2.sabotador_id, 'categoria', 'sabotador'\n      )) FROM usuarios_quest uq2 \n      WHERE uq2.usuario_id = uq.usuario_id AND uq2.status IN ('disponivel', 'ativa') \n        AND uq2.sabotador_id IS NOT NULL), '[]'::json),\n      \n      'personalizada', COALESCE((SELECT json_agg(json_build_object(\n        'quest_id', uq2.id, 'titulo', uq2.config->>'titulo', 'descricao', uq2.config->>'descricao',\n        'base_cientifica', uq2.config->'base_cientifica', 'categoria', 'personalizada'\n      )) FROM usuarios_quest uq2 \n      WHERE uq2.usuario_id = uq.usuario_id AND uq2.status IN ('disponivel', 'ativa') \n        AND uq2.catalogo_id = '00000000-0000-0000-0000-000000000001'\n        AND uq2.sabotador_id IS NULL), '[]'::json),\n      \n      'objetivo', COALESCE((SELECT json_agg(json_build_object(\n        'quest_id', uq2.id, 'titulo', uq2.config->>'titulo', 'descricao', uq2.config->>'descricao',\n        'base_cientifica', uq2.config->'base_cientifica', 'objetivo_id', uq2.objetivo_id, 'categoria', 'objetivo'\n      )) FROM usuarios_quest uq2 \n      WHERE uq2.usuario_id = uq.usuario_id AND uq2.status IN ('disponivel', 'ativa') \n        AND uq2.objetivo_id IS NOT NULL\n        AND uq2.sabotador_id IS NULL\n        AND uq2.catalogo_id != '00000000-0000-0000-0000-000000000001'), '[]'::json)\n    ) AS quests_por_categoria\n  FROM (SELECT DISTINCT usuario_id FROM usuarios_quest WHERE status IN ('disponivel', 'ativa')) uq\n),\nultimas_conversas AS (\n  SELECT \n    uc.usuario_id,\n    (SELECT json_agg(json_build_object(\n      'data_conversa', c.data_conversa,\n      'resumo', c.resumo_conversa\n    ) ORDER BY c.data_conversa DESC)\n     FROM (\n       SELECT data_conversa, resumo_conversa\n       FROM usr_chat\n       WHERE usuario_id = uc.usuario_id\n         AND resumo_conversa IS NOT NULL\n       ORDER BY data_conversa DESC\n       LIMIT 5\n     ) c\n    ) AS ultimas_conversas\n  FROM (SELECT DISTINCT usuario_id FROM usr_chat) uc\n)\nSELECT \n  n.usuario_id,\n  u.nome_preferencia,\n  u.tom_conversa,\n  u.whatsapp_numero,\n  n.lembretes_canais,\n  (SELECT ARRAY_AGG(DISTINCT dp.token) FROM dispositivos_push dp WHERE dp.usuario_id = n.usuario_id AND dp.token IS NOT NULL) AS push_tokens,\n  COALESCE(uh.humor_nivel, 6) as humor_nivel,\n  COALESCE(ROUND(ep.percentual_positiva / 10, 0), 6) as energia_nivel,\n  COALESCE(ucn.ultima_categoria, NULL) as ultima_categoria_notificada,\n  COALESCE(qsr.quests_a_fazer, '[]'::json) as quests_a_fazer,\n  COALESCE(qsr.quests_fazendo, '[]'::json) as quests_fazendo,\n  COALESCE(qpc.quests_por_categoria, '{}'::json) as quests_por_categoria,\n  COALESCE(ulc.ultimas_conversas, '[]'::json) as ultimas_conversas\nFROM notificacoes n\nINNER JOIN usuarios u ON u.id = n.usuario_id\nLEFT JOIN ultimo_humor uh ON uh.usuario_id = n.usuario_id\nLEFT JOIN energia_panas ep ON ep.usuario_id = n.usuario_id\nLEFT JOIN ultima_categoria_notificada ucn ON ucn.usuario_id = n.usuario_id\nLEFT JOIN quests_status_resumo qsr ON qsr.usuario_id = n.usuario_id\nLEFT JOIN quests_por_categoria qpc ON qpc.usuario_id = n.usuario_id\nLEFT JOIN ultimas_conversas ulc ON ulc.usuario_id = n.usuario_id\nWHERE n.lembretes_ativo = true\n  AND n.lembretes_quests = true\n  AND 'whatsapp' = ANY(n.lembretes_canais)\n  AND NOT EXISTS (\n    SELECT 1 FROM notificacoes_log nl \n    WHERE nl.usuario_id = n.usuario_id \n      AND DATE(nl.criado_em) = CURRENT_DATE \n      AND nl.tipo LIKE 'quest%'\n  );",
        "options": {}
      },
      "id": "016bcda9-543b-498c-adfc-5e98220b6d4d",
      "name": "usuarios_elegiveis_quests",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -304,
        160
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// v2.0.0: Selecionar Quest por Rotação de Categorias\n// REGRAS:\n// 1. Rotação: TCC → Estoicismo → Sabotador → Personalizada → Objetivo\n// 2. Se não tem da categoria, pula para próxima\n// 3. Se humor OU energia < 5, manda TCC/Estoicismo e pula a rotação\n\nconst CATEGORIAS_ROTACAO = ['tcc', 'estoicismo', 'sabotador', 'personalizada', 'objetivo'];\nconst CATEGORIAS_BEM_ESTAR = ['tcc', 'estoicismo'];\n\nconst items = $input.all();\nconst resultados = [];\n\nfor (const item of items) {\n  const data = item.json;\n  const humorNivel = data.humor_nivel || 6;\n  const energiaNivel = data.energia_nivel || 6;\n  const ultimaCategoria = data.ultima_categoria_notificada || null;\n  const questsPorCategoria = data.quests_por_categoria || {};\n  \n  let questSelecionada = null;\n  let categoriaSelecionada = null;\n  let motivoSelecao = '';\n  \n  // REGRA 3: Se humor OU energia < 5, priorizar bem-estar\n  const precisaBemEstar = humorNivel < 5 || energiaNivel < 5;\n  \n  if (precisaBemEstar) {\n    // Buscar quest de TCC ou Estoicismo\n    for (const cat of CATEGORIAS_BEM_ESTAR) {\n      const questsDaCategoria = questsPorCategoria[cat] || [];\n      if (Array.isArray(questsDaCategoria) && questsDaCategoria.length > 0) {\n        questSelecionada = questsDaCategoria[0];\n        categoriaSelecionada = cat;\n        motivoSelecao = 'bem_estar_prioritario';\n        break;\n      }\n    }\n  }\n  \n  // Se não precisou de bem-estar OU não encontrou quest de bem-estar\n  if (!questSelecionada) {\n    // REGRA 1 e 2: Rotação de categorias\n    let indiceInicio = 0;\n    \n    if (ultimaCategoria) {\n      const indiceUltima = CATEGORIAS_ROTACAO.indexOf(ultimaCategoria);\n      if (indiceUltima !== -1) {\n        indiceInicio = (indiceUltima + 1) % CATEGORIAS_ROTACAO.length;\n      }\n    }\n    \n    // Tentar cada categoria a partir do índice de início\n    for (let i = 0; i < CATEGORIAS_ROTACAO.length; i++) {\n      const indice = (indiceInicio + i) % CATEGORIAS_ROTACAO.length;\n      const cat = CATEGORIAS_ROTACAO[indice];\n      const questsDaCategoria = questsPorCategoria[cat] || [];\n      \n      if (Array.isArray(questsDaCategoria) && questsDaCategoria.length > 0) {\n        questSelecionada = questsDaCategoria[0];\n        categoriaSelecionada = cat;\n        motivoSelecao = 'rotacao_categoria';\n        break;\n      }\n    }\n  }\n  \n  // Se ainda não encontrou nenhuma quest\n  if (!questSelecionada) {\n    motivoSelecao = 'sem_quest_disponivel';\n  }\n  \n  resultados.push({\n    json: {\n      ...data,\n      quest_selecionada: questSelecionada,\n      categoria_selecionada: categoriaSelecionada,\n      motivo_selecao: motivoSelecao,\n      precisa_bem_estar: precisaBemEstar\n    }\n  });\n}\n\nreturn resultados;"
      },
      "id": "a1d3845e-5bd3-42e8-9068-0ead33efa427",
      "name": "Selecionar Quest (Rotação)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -64,
        160
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "tem_quest",
              "leftValue": "={{ $json.quest_selecionada }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        176,
        160
      ],
      "id": "de91ea7d-2a61-4aa9-92ef-4d56b484b84c",
      "name": "Tem Quest?"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "16a65394-200e-49a3-ba3f-edb308f994c5",
      "name": "Loop Quests",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        448,
        80
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "kMqjjX3TeEGBkR74",
          "mode": "list",
          "cachedResultUrl": "/workflow/kMqjjX3TeEGBkR74",
          "cachedResultName": "sw_mentor_notificacoes_v2"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $('Selecionar Quest (Rotação)').item.json.usuario_id }}",
            "nome_preferencia": "={{ $('Selecionar Quest (Rotação)').item.json.nome_preferencia }}",
            "tom_conversa": "={{ $('Selecionar Quest (Rotação)').item.json.tom_conversa || 'empatico' }}",
            "whats_number": "={{ $('Selecionar Quest (Rotação)').item.json.whatsapp_numero }}",
            "lembretes_canais": "={{ $('Selecionar Quest (Rotação)').item.json.lembretes_canais }}",
            "push_tokens": "={{ $('Selecionar Quest (Rotação)').item.json.push_tokens }}",
            "tipo_notificacao": "quest",
            "contexto": "={{ { quest_selecionada: $('Selecionar Quest (Rotação)').item.json.quest_selecionada, categoria_selecionada: $('Selecionar Quest (Rotação)').item.json.categoria_selecionada, motivo_selecao: $('Selecionar Quest (Rotação)').item.json.motivo_selecao, precisa_bem_estar: $('Selecionar Quest (Rotação)').item.json.precisa_bem_estar, humor_nivel: $('Selecionar Quest (Rotação)').item.json.humor_nivel, energia_nivel: $('Selecionar Quest (Rotação)').item.json.energia_nivel, ultimas_conversas: $('Selecionar Quest (Rotação)').item.json.ultimas_conversas, a_fazer: $('Selecionar Quest (Rotação)').item.json.quests_a_fazer, fazendo: $('Selecionar Quest (Rotação)').item.json.quests_fazendo } }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "nome_preferencia",
              "displayName": "nome_preferencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "tom_conversa",
              "displayName": "tom_conversa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "whats_number",
              "displayName": "whats_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "lembretes_canais",
              "displayName": "lembretes_canais",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "array"
            },
            {
              "id": "push_tokens",
              "displayName": "push_tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "array"
            },
            {
              "id": "tipo_notificacao",
              "displayName": "tipo_notificacao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "contexto",
              "displayName": "contexto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "id": "1e44efc4-a0c5-45f7-84b8-9c9eb66dbc0c",
      "name": "Call sw_mentor_notificacoes (quests)",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        752,
        80
      ]
    },
    {
      "parameters": {},
      "id": "3e1827fe-41ba-49cb-b284-f6b480dddcfe",
      "name": "Sem Quest (skip)",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        432,
        368
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 18
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        -528,
        520
      ],
      "id": "1b487a81-7983-40cc-b861-81088e13ec6e",
      "name": "Trigger Conquistas 18h"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- v1.0.0: Buscar usuários elegíveis para notificação de conquistas (18h)\n-- Eventos reconhecidos:\n-- - Novo nível atingido (XP cruzou faixa -> nível atual)\n-- - Marcos de sequência de conversas: 3/5/10/15 (terminando hoje)\n-- - Quests recorrentes concluídas hoje\n-- - Marcos de sequência de quests concluídas: 3/5/10/15 (terminando hoje)\n-- Anti-spam:\n-- - Não enviar mais de 1 notificação de conquistas por dia (base tipo = 'conquista')\n\nWITH usuarios_base AS (\n  SELECT\n    n.usuario_id,\n    u.nome_preferencia,\n    u.tom_conversa,\n    u.whatsapp_numero,\n    n.lembretes_canais,\n    ARRAY_AGG(DISTINCT dp.token) FILTER (WHERE dp.token IS NOT NULL) AS push_tokens\n  FROM notificacoes n\n  INNER JOIN usuarios u ON u.id = n.usuario_id\n  LEFT JOIN dispositivos_push dp ON dp.usuario_id = n.usuario_id\n  WHERE n.lembretes_ativo = true\n    AND 'whatsapp' = ANY(n.lembretes_canais)\n  GROUP BY n.usuario_id, u.nome_preferencia, u.tom_conversa, u.whatsapp_numero, n.lembretes_canais\n),\n\nxp AS (\n  SELECT usuario_id, COALESCE(xp_total, 0) AS xp_total, COALESCE(total_xp_hoje, 0) AS xp_ganho_hoje\n  FROM usuarios_conquistas\n),\n\nnivel_calc AS (\n  SELECT\n    ub.usuario_id,\n    jn.nivel AS nivel_atual,\n    jn.nome AS nivel_nome,\n    jn.estagio AS estagio,\n    jn.estagio_nome AS estagio_nome,\n    jn.xp_minimo AS xp_minimo,\n    jn.xp_proximo_nivel AS xp_proximo_nivel\n  FROM usuarios_base ub\n  LEFT JOIN xp x ON x.usuario_id = ub.usuario_id\n  LEFT JOIN LATERAL (\n    SELECT *\n    FROM jornada_niveis\n    WHERE COALESCE(x.xp_total, 0) >= xp_minimo\n      AND (xp_proximo_nivel IS NULL OR COALESCE(x.xp_total, 0) < xp_proximo_nivel)\n    ORDER BY nivel DESC\n    LIMIT 1\n  ) jn ON true\n),\n\nstreak_conversa AS (\n  WITH days AS (\n    SELECT DISTINCT usuario_id, data_conversa::date AS d\n    FROM usr_chat\n    WHERE data_conversa >= CURRENT_DATE - INTERVAL '40 days'\n  ),\n  groups AS (\n    SELECT\n      usuario_id,\n      d,\n      (d - (ROW_NUMBER() OVER (PARTITION BY usuario_id ORDER BY d)) * INTERVAL '1 day') AS grp\n    FROM days\n  ),\n  streaks AS (\n    SELECT usuario_id, COUNT(*)::int AS streak_dias, MAX(d) AS max_d\n    FROM groups\n    GROUP BY usuario_id, grp\n  )\n  SELECT usuario_id, streak_dias\n  FROM streaks\n  WHERE max_d = CURRENT_DATE\n),\n\nstreak_quest AS (\n  WITH days AS (\n    SELECT DISTINCT uq.usuario_id, qr.data_concluida::date AS d\n    FROM quests_recorrencias qr\n    INNER JOIN usuarios_quest uq ON uq.id = qr.usuarios_quest_id\n    WHERE qr.status = 'concluida'\n      AND qr.data_concluida IS NOT NULL\n      AND qr.data_concluida >= CURRENT_DATE - INTERVAL '40 days'\n  ),\n  groups AS (\n    SELECT\n      usuario_id,\n      d,\n      (d - (ROW_NUMBER() OVER (PARTITION BY usuario_id ORDER BY d)) * INTERVAL '1 day') AS grp\n    FROM days\n  ),\n  streaks AS (\n    SELECT usuario_id, COUNT(*)::int AS streak_dias, MAX(d) AS max_d\n    FROM groups\n    GROUP BY usuario_id, grp\n  )\n  SELECT usuario_id, streak_dias\n  FROM streaks\n  WHERE max_d = CURRENT_DATE\n),\n\nquests_concluidas_hoje AS (\n  SELECT\n    uq.usuario_id,\n    COUNT(*)::int AS total,\n    COALESCE(\n      json_agg(DISTINCT COALESCE(uq.config->>'titulo', 'Quest')),\n      '[]'::json\n    ) AS titulos\n  FROM quests_recorrencias qr\n  INNER JOIN usuarios_quest uq ON uq.id = qr.usuarios_quest_id\n  WHERE qr.status = 'concluida'\n    AND qr.data_concluida = CURRENT_DATE\n  GROUP BY uq.usuario_id\n),\n\neventos AS (\n  SELECT\n    ub.usuario_id,\n    ub.nome_preferencia,\n    ub.tom_conversa,\n    ub.whatsapp_numero,\n    ub.lembretes_canais,\n    ub.push_tokens,\n\n    x.xp_total,\n    x.xp_ganho_hoje,\n\n    nc.nivel_atual,\n    nc.nivel_nome,\n    nc.estagio,\n    nc.estagio_nome,\n    nc.xp_minimo,\n    nc.xp_proximo_nivel,\n\n    -- Novo nível: só se ainda não celebrou este nível em nenhuma data\n    CASE\n      WHEN nc.nivel_atual IS NOT NULL\n        AND NOT EXISTS (\n          SELECT 1 FROM notificacoes_log nl\n          WHERE nl.usuario_id = ub.usuario_id\n            AND nl.tipo = ('conquista_nivel_' || nc.nivel_atual::text)\n        )\n      THEN nc.nivel_atual\n      ELSE NULL\n    END AS nivel_novo,\n\n    COALESCE(sc.streak_dias, 0) AS streak_conversa_dias,\n    CASE\n      WHEN sc.streak_dias IN (3,5,10,15)\n        AND NOT EXISTS (\n          SELECT 1 FROM notificacoes_log nl\n          WHERE nl.usuario_id = ub.usuario_id\n            AND nl.tipo = ('conquista_streak_conversa_' || sc.streak_dias::text)\n        )\n      THEN sc.streak_dias\n      ELSE NULL\n    END AS streak_conversa_marco,\n\n    COALESCE(sq.streak_dias, 0) AS streak_quest_dias,\n    CASE\n      WHEN sq.streak_dias IN (3,5,10,15)\n        AND NOT EXISTS (\n          SELECT 1 FROM notificacoes_log nl\n          WHERE nl.usuario_id = ub.usuario_id\n            AND nl.tipo = ('conquista_streak_quest_' || sq.streak_dias::text)\n        )\n      THEN sq.streak_dias\n      ELSE NULL\n    END AS streak_quest_marco,\n\n    COALESCE(qh.total, 0) AS quests_concluidas_total,\n    COALESCE(qh.titulos, '[]'::json) AS quests_concluidas_titulos\n\n  FROM usuarios_base ub\n  LEFT JOIN xp x ON x.usuario_id = ub.usuario_id\n  LEFT JOIN nivel_calc nc ON nc.usuario_id = ub.usuario_id\n  LEFT JOIN streak_conversa sc ON sc.usuario_id = ub.usuario_id\n  LEFT JOIN streak_quest sq ON sq.usuario_id = ub.usuario_id\n  LEFT JOIN quests_concluidas_hoje qh ON qh.usuario_id = ub.usuario_id\n)\n\nSELECT\n  e.usuario_id,\n  e.nome_preferencia,\n  e.tom_conversa,\n  e.whatsapp_numero,\n  e.lembretes_canais,\n  e.push_tokens,\n\n  -- Subtipo principal (define o tipo gravado no log)\n  CASE\n    WHEN e.nivel_novo IS NOT NULL THEN 'nivel_' || e.nivel_atual::text\n    WHEN e.streak_conversa_marco IS NOT NULL THEN 'streak_conversa_' || e.streak_conversa_marco::text\n    WHEN e.streak_quest_marco IS NOT NULL THEN 'streak_quest_' || e.streak_quest_marco::text\n    WHEN e.quests_concluidas_total > 0 THEN 'quest_concluida'\n    ELSE NULL\n  END AS subtipo,\n\n  json_build_object(\n    'subtipo', CASE\n      WHEN e.nivel_novo IS NOT NULL THEN 'nivel_' || e.nivel_atual::text\n      WHEN e.streak_conversa_marco IS NOT NULL THEN 'streak_conversa_' || e.streak_conversa_marco::text\n      WHEN e.streak_quest_marco IS NOT NULL THEN 'streak_quest_' || e.streak_quest_marco::text\n      WHEN e.quests_concluidas_total > 0 THEN 'quest_concluida'\n      ELSE NULL\n    END,\n    'xp_total', e.xp_total,\n    'xp_ganho_hoje', e.xp_ganho_hoje,\n    'nivel_atual', e.nivel_atual,\n    'nivel_nome', e.nivel_nome,\n    'estagio', e.estagio,\n    'estagio_nome', e.estagio_nome,\n    'nivel_novo', e.nivel_novo,\n    'streak_conversa_dias', e.streak_conversa_dias,\n    'streak_conversa_marco', e.streak_conversa_marco,\n    'streak_quest_dias', e.streak_quest_dias,\n    'streak_quest_marco', e.streak_quest_marco,\n    'quests_concluidas_total', e.quests_concluidas_total,\n    'quests_concluidas_titulos', e.quests_concluidas_titulos\n  ) AS contexto\n\nFROM eventos e\nWHERE (\n    e.nivel_novo IS NOT NULL\n OR e.streak_conversa_marco IS NOT NULL\n OR e.streak_quest_marco IS NOT NULL\n OR e.quests_concluidas_total > 0\n)\nAND NOT EXISTS (\n  SELECT 1\n  FROM notificacoes_log nl\n  WHERE nl.usuario_id = e.usuario_id\n    AND DATE(nl.criado_em) = CURRENT_DATE\n    AND SPLIT_PART(nl.tipo, '_', 1) = 'conquista'\n);\n",
        "options": {}
      },
      "id": "97ad04db-362a-4d71-8fe3-436bca3d2347",
      "name": "usuarios_elegiveis_conquistas",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -304,
        520
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        112,
        520
      ],
      "id": "116470dc-7bf9-4182-91ee-2572ca4673c0",
      "name": "Loop Conquistas"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "cQz4nq1h3Kp9Lm2N",
          "mode": "list",
          "cachedResultUrl": "/workflow/cQz4nq1h3Kp9Lm2N",
          "cachedResultName": "sw_mentor_notificacoes_conquistas_v1"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $('usuarios_elegiveis_conquistas').item.json.usuario_id }}",
            "nome_preferencia": "={{ $('usuarios_elegiveis_conquistas').item.json.nome_preferencia }}",
            "tom_conversa": "={{ $('usuarios_elegiveis_conquistas').item.json.tom_conversa || 'empatico' }}",
            "whats_number": "={{ $('usuarios_elegiveis_conquistas').item.json.whatsapp_numero }}",
            "lembretes_canais": "={{ $('usuarios_elegiveis_conquistas').item.json.lembretes_canais }}",
            "push_tokens": "={{ $('usuarios_elegiveis_conquistas').item.json.push_tokens }}",
            "contexto": "={{ $('usuarios_elegiveis_conquistas').item.json.contexto }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "nome_preferencia",
              "displayName": "nome_preferencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "tom_conversa",
              "displayName": "tom_conversa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "whats_number",
              "displayName": "whats_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "lembretes_canais",
              "displayName": "lembretes_canais",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "array"
            },
            {
              "id": "push_tokens",
              "displayName": "push_tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "array"
            },
            {
              "id": "contexto",
              "displayName": "contexto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        400,
        536
      ],
      "id": "cce83639-122c-4c02-899e-664c6ece12ac",
      "name": "Call sw_mentor_notificacoes (conquistas)"
    }
  ],
  "connections": {
    "Trigger Conversas 09h": {
      "main": [
        [
          {
            "node": "usuarios_conversas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "usuarios_conversas": {
      "main": [
        [
          {
            "node": "Loop Conversas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Conversas": {
      "main": [
        [],
        [
          {
            "node": "Call sw_mentor_notificacoes (conversas)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call sw_mentor_notificacoes (conversas)": {
      "main": [
        [
          {
            "node": "Loop Conversas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Quests 15h": {
      "main": [
        [
          {
            "node": "usuarios_elegiveis_quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "usuarios_elegiveis_quests": {
      "main": [
        [
          {
            "node": "Selecionar Quest (Rotação)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Selecionar Quest (Rotação)": {
      "main": [
        [
          {
            "node": "Tem Quest?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tem Quest?": {
      "main": [
        [
          {
            "node": "Loop Quests",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Sem Quest (skip)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Quests": {
      "main": [
        [],
        [
          {
            "node": "Call sw_mentor_notificacoes (quests)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call sw_mentor_notificacoes (quests)": {
      "main": [
        [
          {
            "node": "Loop Quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Conquistas 18h": {
      "main": [
        [
          {
            "node": "usuarios_elegiveis_conquistas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "usuarios_elegiveis_conquistas": {
      "main": [
        [
          {
            "node": "Loop Conquistas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Conquistas": {
      "main": [
        [],
        [
          {
            "node": "Call sw_mentor_notificacoes (conquistas)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call sw_mentor_notificacoes (conquistas)": {
      "main": [
        [
          {
            "node": "Loop Conquistas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "timeSavedMode": "fixed",
    "timezone": "America/Sao_Paulo",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": {
    "node:Trigger Conversas 09h": {
      "recurrenceRules": []
    },
    "node:Trigger Quests 15h": {
      "recurrenceRules": []
    }
  },
  "meta": null,
  "pinData": {},
  "activeVersionId": "57371035-548f-417a-a4ce-4f85210399fe",
  "shared": [
    {
      "createdAt": "2025-12-17T20:18:16.166Z",
      "role": "workflow:owner",
      "workflowId": "vGLluHVYupmxKJWT",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [],
  "activeVersion": {
    "createdAt": "2025-12-18T12:25:10.463Z",
    "workflowId": "vGLluHVYupmxKJWT",
    "nodes": [
      {
        "parameters": {
          "rule": {
            "interval": [
              {
                "triggerAtHour": 9
              }
            ]
          }
        },
        "type": "n8n-nodes-base.scheduleTrigger",
        "typeVersion": 1.3,
        "position": [
          -368,
          -208
        ],
        "id": "79c3a7a5-ac81-4d64-b1db-d580e71e10a4",
        "name": "Trigger Conversas 09h"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "SELECT \n  n.usuario_id,\n  u.nome_preferencia,\n  u.tom_conversa,\n  u.whatsapp_numero,\n  n.lembretes_canais,\n  ARRAY_AGG(DISTINCT dp.token) FILTER (WHERE dp.token IS NOT NULL) AS push_tokens,\n  CASE \n    WHEN NOT EXISTS (SELECT 1 FROM usr_chat WHERE usuario_id = n.usuario_id) \n    THEN true \n    ELSE false \n  END AS is_primeira_conversa,\n  (SELECT json_agg(json_build_object(\n    'data_conversa', c.data_conversa,\n    'resumo', c.resumo_conversa\n  ) ORDER BY c.data_conversa DESC)\n   FROM (\n     SELECT data_conversa, resumo_conversa\n     FROM usr_chat\n     WHERE usuario_id = n.usuario_id\n       AND resumo_conversa IS NOT NULL\n     ORDER BY data_conversa DESC\n   ) c\n  ) AS ultimas_conversas\nFROM notificacoes n\nINNER JOIN usuarios u ON u.id = n.usuario_id\nLEFT JOIN dispositivos_push dp ON dp.usuario_id = n.usuario_id\nWHERE n.lembretes_ativo = true\n  AND n.lembretes_conversas_diarias = true\n  AND 'whatsapp' = ANY(n.lembretes_canais)\n  AND NOT EXISTS (\n    SELECT 1 \n    FROM usr_chat c \n    WHERE c.usuario_id = n.usuario_id \n      AND DATE(c.data_conversa) = CURRENT_DATE\n  )\n  AND NOT EXISTS (\n    SELECT 1 \n    FROM notificacoes_log nl \n    WHERE nl.usuario_id = n.usuario_id \n      AND DATE(nl.criado_em) = CURRENT_DATE \n      AND nl.tipo LIKE '%conversa%'\n  )\nGROUP BY n.usuario_id, u.nome_preferencia, u.tom_conversa, u.whatsapp_numero, n.lembretes_canais;",
          "options": {}
        },
        "id": "073dab68-d3a7-4497-b0a8-b059b6e2e1df",
        "name": "usuarios_conversas",
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          -160,
          -208
        ],
        "credentials": {
          "postgres": {
            "id": "8ySWxtSO7gYK5uue",
            "name": "Postgres account"
          }
        }
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          112,
          -208
        ],
        "id": "0a8823ff-73c9-4a03-9cb8-49094f430bd0",
        "name": "Loop Conversas"
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "kMqjjX3TeEGBkR74",
            "mode": "list",
            "cachedResultUrl": "/workflow/kMqjjX3TeEGBkR74",
            "cachedResultName": "sw_mentor_notificacoes_v2"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {
              "usuario_id": "={{ $('usuarios_conversas').item.json.usuario_id }}",
              "nome_preferencia": "={{ $('usuarios_conversas').item.json.nome_preferencia }}",
              "tom_conversa": "={{ $('usuarios_conversas').item.json.tom_conversa || 'empatico' }}",
              "whats_number": "={{ $('usuarios_conversas').item.json.whatsapp_numero }}",
              "lembretes_canais": "={{ $('usuarios_conversas').item.json.lembretes_canais }}",
              "push_tokens": "={{ $('usuarios_conversas').item.json.push_tokens }}",
              "tipo_notificacao": "={{ $('usuarios_conversas').item.json.is_primeira_conversa ? 'primeira_conversa' : 'conversa' }}",
              "contexto": "={{ { ultimas_conversas: $('usuarios_conversas').item.json.ultimas_conversas, is_primeira_conversa: $('usuarios_conversas').item.json.is_primeira_conversa } }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "usuario_id",
                "displayName": "usuario_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string"
              },
              {
                "id": "nome_preferencia",
                "displayName": "nome_preferencia",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string"
              },
              {
                "id": "tom_conversa",
                "displayName": "tom_conversa",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string"
              },
              {
                "id": "whats_number",
                "displayName": "whats_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string"
              },
              {
                "id": "lembretes_canais",
                "displayName": "lembretes_canais",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "array"
              },
              {
                "id": "push_tokens",
                "displayName": "push_tokens",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "array"
              },
              {
                "id": "tipo_notificacao",
                "displayName": "tipo_notificacao",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string"
              },
              {
                "id": "contexto",
                "displayName": "contexto",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "object"
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": true
          },
          "options": {}
        },
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.3,
        "position": [
          400,
          -192
        ],
        "id": "774acf5e-e5c3-4e32-867d-5598d5e67b91",
        "name": "Call sw_mentor_notificacoes (conversas)"
      },
      {
        "parameters": {
          "rule": {
            "interval": [
              {
                "triggerAtHour": 15
              }
            ]
          }
        },
        "type": "n8n-nodes-base.scheduleTrigger",
        "typeVersion": 1.3,
        "position": [
          -528,
          160
        ],
        "id": "52bc0768-9e43-4191-bb54-5cd14a8ff2d1",
        "name": "Trigger Quests 15h"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "-- v2.0.0: Buscar usuários elegíveis para notificação de quest\n-- Inclui: humor, energia, quests por categoria, última categoria notificada\n\nWITH ultimo_humor AS (\n  SELECT DISTINCT ON (c.usuario_id)\n    c.usuario_id,\n    uhe.humor_dia as humor_nivel\n  FROM usuarios_humor_energia uhe\n  INNER JOIN usr_chat c ON c.id = uhe.chat_id\n  ORDER BY c.usuario_id, c.data_conversa DESC\n),\nenergia_panas AS (\n  SELECT \n    ue.usuario_id,\n    CASE WHEN COUNT(*) > 0\n      THEN ROUND((COUNT(*) FILTER (WHERE LOWER(ue.emocao_id) IN ('joy','trust','anticipation'))::numeric / COUNT(*)::numeric) * 100, 1)\n      ELSE 60 END AS percentual_positiva\n  FROM usuarios_emocoes ue\n  WHERE ue.intensidade >= 45\n  GROUP BY ue.usuario_id\n),\n-- v2.0.0: Última categoria notificada\nultima_categoria_notificada AS (\n  SELECT DISTINCT ON (nl.usuario_id)\n    nl.usuario_id,\n    CASE \n      WHEN nl.tipo LIKE '%tcc%' THEN 'tcc'\n      WHEN nl.tipo LIKE '%estoicismo%' THEN 'estoicismo'\n      WHEN nl.tipo LIKE '%sabotador%' THEN 'sabotador'\n      WHEN nl.tipo LIKE '%personalizada%' THEN 'personalizada'\n      WHEN nl.tipo LIKE '%objetivo%' THEN 'objetivo'\n      ELSE NULL\n    END AS ultima_categoria\n  FROM notificacoes_log nl\n  WHERE nl.tipo LIKE 'quest%'\n  ORDER BY nl.usuario_id, nl.criado_em DESC\n),\n-- v2.1.0: Resumo de quests do usuário por status (apenas títulos)\nquests_status_resumo AS (\n  SELECT\n    uq.usuario_id,\n    COALESCE(\n      json_agg(DISTINCT COALESCE(uq.config->>'titulo', qc.titulo)) FILTER (WHERE uq.status = 'disponivel'),\n      '[]'::json\n    ) AS quests_a_fazer,\n    COALESCE(\n      json_agg(DISTINCT COALESCE(uq.config->>'titulo', qc.titulo)) FILTER (WHERE uq.status = 'ativa'),\n      '[]'::json\n    ) AS quests_fazendo\n  FROM usuarios_quest uq\n  LEFT JOIN quests_catalogo qc ON qc.id = uq.catalogo_id\n  WHERE uq.status IN ('disponivel', 'ativa')\n  GROUP BY uq.usuario_id\n),\n-- v2.0.0: Quests agrupadas por categoria\nquests_por_categoria AS (\n  SELECT \n    uq.usuario_id,\n    json_build_object(\n      'tcc', COALESCE((SELECT json_agg(json_build_object(\n        'quest_id', uq2.id, 'titulo', uq2.config->>'titulo', 'descricao', uq2.config->>'descricao',\n        'base_cientifica', uq2.config->'base_cientifica', 'categoria', 'tcc'\n      )) FROM usuarios_quest uq2 \n      LEFT JOIN quests_catalogo qc ON qc.id = uq2.catalogo_id\n      WHERE uq2.usuario_id = uq.usuario_id AND uq2.status IN ('disponivel', 'ativa') \n        AND qc.categoria = 'tcc'), '[]'::json),\n      \n      'estoicismo', COALESCE((SELECT json_agg(json_build_object(\n        'quest_id', uq2.id, 'titulo', uq2.config->>'titulo', 'descricao', uq2.config->>'descricao',\n        'base_cientifica', uq2.config->'base_cientifica', 'categoria', 'estoicismo'\n      )) FROM usuarios_quest uq2 \n      LEFT JOIN quests_catalogo qc ON qc.id = uq2.catalogo_id\n      WHERE uq2.usuario_id = uq.usuario_id AND uq2.status IN ('disponivel', 'ativa') \n        AND qc.categoria = 'estoicismo'), '[]'::json),\n      \n      'sabotador', COALESCE((SELECT json_agg(json_build_object(\n        'quest_id', uq2.id, 'titulo', uq2.config->>'titulo', 'descricao', uq2.config->>'descricao',\n        'base_cientifica', uq2.config->'base_cientifica', 'sabotador_id', uq2.sabotador_id, 'categoria', 'sabotador'\n      )) FROM usuarios_quest uq2 \n      WHERE uq2.usuario_id = uq.usuario_id AND uq2.status IN ('disponivel', 'ativa') \n        AND uq2.sabotador_id IS NOT NULL), '[]'::json),\n      \n      'personalizada', COALESCE((SELECT json_agg(json_build_object(\n        'quest_id', uq2.id, 'titulo', uq2.config->>'titulo', 'descricao', uq2.config->>'descricao',\n        'base_cientifica', uq2.config->'base_cientifica', 'categoria', 'personalizada'\n      )) FROM usuarios_quest uq2 \n      WHERE uq2.usuario_id = uq.usuario_id AND uq2.status IN ('disponivel', 'ativa') \n        AND uq2.catalogo_id = '00000000-0000-0000-0000-000000000001'\n        AND uq2.sabotador_id IS NULL), '[]'::json),\n      \n      'objetivo', COALESCE((SELECT json_agg(json_build_object(\n        'quest_id', uq2.id, 'titulo', uq2.config->>'titulo', 'descricao', uq2.config->>'descricao',\n        'base_cientifica', uq2.config->'base_cientifica', 'objetivo_id', uq2.objetivo_id, 'categoria', 'objetivo'\n      )) FROM usuarios_quest uq2 \n      WHERE uq2.usuario_id = uq.usuario_id AND uq2.status IN ('disponivel', 'ativa') \n        AND uq2.objetivo_id IS NOT NULL\n        AND uq2.sabotador_id IS NULL\n        AND uq2.catalogo_id != '00000000-0000-0000-0000-000000000001'), '[]'::json)\n    ) AS quests_por_categoria\n  FROM (SELECT DISTINCT usuario_id FROM usuarios_quest WHERE status IN ('disponivel', 'ativa')) uq\n),\nultimas_conversas AS (\n  SELECT \n    uc.usuario_id,\n    (SELECT json_agg(json_build_object(\n      'data_conversa', c.data_conversa,\n      'resumo', c.resumo_conversa\n    ) ORDER BY c.data_conversa DESC)\n     FROM (\n       SELECT data_conversa, resumo_conversa\n       FROM usr_chat\n       WHERE usuario_id = uc.usuario_id\n         AND resumo_conversa IS NOT NULL\n       ORDER BY data_conversa DESC\n       LIMIT 5\n     ) c\n    ) AS ultimas_conversas\n  FROM (SELECT DISTINCT usuario_id FROM usr_chat) uc\n)\nSELECT \n  n.usuario_id,\n  u.nome_preferencia,\n  u.tom_conversa,\n  u.whatsapp_numero,\n  n.lembretes_canais,\n  (SELECT ARRAY_AGG(DISTINCT dp.token) FROM dispositivos_push dp WHERE dp.usuario_id = n.usuario_id AND dp.token IS NOT NULL) AS push_tokens,\n  COALESCE(uh.humor_nivel, 6) as humor_nivel,\n  COALESCE(ROUND(ep.percentual_positiva / 10, 0), 6) as energia_nivel,\n  COALESCE(ucn.ultima_categoria, NULL) as ultima_categoria_notificada,\n  COALESCE(qsr.quests_a_fazer, '[]'::json) as quests_a_fazer,\n  COALESCE(qsr.quests_fazendo, '[]'::json) as quests_fazendo,\n  COALESCE(qpc.quests_por_categoria, '{}'::json) as quests_por_categoria,\n  COALESCE(ulc.ultimas_conversas, '[]'::json) as ultimas_conversas\nFROM notificacoes n\nINNER JOIN usuarios u ON u.id = n.usuario_id\nLEFT JOIN ultimo_humor uh ON uh.usuario_id = n.usuario_id\nLEFT JOIN energia_panas ep ON ep.usuario_id = n.usuario_id\nLEFT JOIN ultima_categoria_notificada ucn ON ucn.usuario_id = n.usuario_id\nLEFT JOIN quests_status_resumo qsr ON qsr.usuario_id = n.usuario_id\nLEFT JOIN quests_por_categoria qpc ON qpc.usuario_id = n.usuario_id\nLEFT JOIN ultimas_conversas ulc ON ulc.usuario_id = n.usuario_id\nWHERE n.lembretes_ativo = true\n  AND n.lembretes_quests = true\n  AND 'whatsapp' = ANY(n.lembretes_canais)\n  AND NOT EXISTS (\n    SELECT 1 FROM notificacoes_log nl \n    WHERE nl.usuario_id = n.usuario_id \n      AND DATE(nl.criado_em) = CURRENT_DATE \n      AND nl.tipo LIKE 'quest%'\n  );",
          "options": {}
        },
        "id": "016bcda9-543b-498c-adfc-5e98220b6d4d",
        "name": "usuarios_elegiveis_quests",
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          -304,
          160
        ],
        "credentials": {
          "postgres": {
            "id": "8ySWxtSO7gYK5uue",
            "name": "Postgres account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// v2.0.0: Selecionar Quest por Rotação de Categorias\n// REGRAS:\n// 1. Rotação: TCC → Estoicismo → Sabotador → Personalizada → Objetivo\n// 2. Se não tem da categoria, pula para próxima\n// 3. Se humor OU energia < 5, manda TCC/Estoicismo e pula a rotação\n\nconst CATEGORIAS_ROTACAO = ['tcc', 'estoicismo', 'sabotador', 'personalizada', 'objetivo'];\nconst CATEGORIAS_BEM_ESTAR = ['tcc', 'estoicismo'];\n\nconst items = $input.all();\nconst resultados = [];\n\nfor (const item of items) {\n  const data = item.json;\n  const humorNivel = data.humor_nivel || 6;\n  const energiaNivel = data.energia_nivel || 6;\n  const ultimaCategoria = data.ultima_categoria_notificada || null;\n  const questsPorCategoria = data.quests_por_categoria || {};\n  \n  let questSelecionada = null;\n  let categoriaSelecionada = null;\n  let motivoSelecao = '';\n  \n  // REGRA 3: Se humor OU energia < 5, priorizar bem-estar\n  const precisaBemEstar = humorNivel < 5 || energiaNivel < 5;\n  \n  if (precisaBemEstar) {\n    // Buscar quest de TCC ou Estoicismo\n    for (const cat of CATEGORIAS_BEM_ESTAR) {\n      const questsDaCategoria = questsPorCategoria[cat] || [];\n      if (Array.isArray(questsDaCategoria) && questsDaCategoria.length > 0) {\n        questSelecionada = questsDaCategoria[0];\n        categoriaSelecionada = cat;\n        motivoSelecao = 'bem_estar_prioritario';\n        break;\n      }\n    }\n  }\n  \n  // Se não precisou de bem-estar OU não encontrou quest de bem-estar\n  if (!questSelecionada) {\n    // REGRA 1 e 2: Rotação de categorias\n    let indiceInicio = 0;\n    \n    if (ultimaCategoria) {\n      const indiceUltima = CATEGORIAS_ROTACAO.indexOf(ultimaCategoria);\n      if (indiceUltima !== -1) {\n        indiceInicio = (indiceUltima + 1) % CATEGORIAS_ROTACAO.length;\n      }\n    }\n    \n    // Tentar cada categoria a partir do índice de início\n    for (let i = 0; i < CATEGORIAS_ROTACAO.length; i++) {\n      const indice = (indiceInicio + i) % CATEGORIAS_ROTACAO.length;\n      const cat = CATEGORIAS_ROTACAO[indice];\n      const questsDaCategoria = questsPorCategoria[cat] || [];\n      \n      if (Array.isArray(questsDaCategoria) && questsDaCategoria.length > 0) {\n        questSelecionada = questsDaCategoria[0];\n        categoriaSelecionada = cat;\n        motivoSelecao = 'rotacao_categoria';\n        break;\n      }\n    }\n  }\n  \n  // Se ainda não encontrou nenhuma quest\n  if (!questSelecionada) {\n    motivoSelecao = 'sem_quest_disponivel';\n  }\n  \n  resultados.push({\n    json: {\n      ...data,\n      quest_selecionada: questSelecionada,\n      categoria_selecionada: categoriaSelecionada,\n      motivo_selecao: motivoSelecao,\n      precisa_bem_estar: precisaBemEstar\n    }\n  });\n}\n\nreturn resultados;"
        },
        "id": "a1d3845e-5bd3-42e8-9068-0ead33efa427",
        "name": "Selecionar Quest (Rotação)",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -64,
          160
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "loose",
              "version": 2
            },
            "conditions": [
              {
                "id": "tem_quest",
                "leftValue": "={{ $json.quest_selecionada }}",
                "rightValue": "",
                "operator": {
                  "type": "object",
                  "operation": "notEmpty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "looseTypeValidation": true,
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          176,
          160
        ],
        "id": "de91ea7d-2a61-4aa9-92ef-4d56b484b84c",
        "name": "Tem Quest?"
      },
      {
        "parameters": {
          "options": {}
        },
        "id": "16a65394-200e-49a3-ba3f-edb308f994c5",
        "name": "Loop Quests",
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          448,
          80
        ]
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "kMqjjX3TeEGBkR74",
            "mode": "list",
            "cachedResultUrl": "/workflow/kMqjjX3TeEGBkR74",
            "cachedResultName": "sw_mentor_notificacoes_v2"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {
              "usuario_id": "={{ $('Selecionar Quest (Rotação)').item.json.usuario_id }}",
              "nome_preferencia": "={{ $('Selecionar Quest (Rotação)').item.json.nome_preferencia }}",
              "tom_conversa": "={{ $('Selecionar Quest (Rotação)').item.json.tom_conversa || 'empatico' }}",
              "whats_number": "={{ $('Selecionar Quest (Rotação)').item.json.whatsapp_numero }}",
              "lembretes_canais": "={{ $('Selecionar Quest (Rotação)').item.json.lembretes_canais }}",
              "push_tokens": "={{ $('Selecionar Quest (Rotação)').item.json.push_tokens }}",
              "tipo_notificacao": "quest",
              "contexto": "={{ { quest_selecionada: $('Selecionar Quest (Rotação)').item.json.quest_selecionada, categoria_selecionada: $('Selecionar Quest (Rotação)').item.json.categoria_selecionada, motivo_selecao: $('Selecionar Quest (Rotação)').item.json.motivo_selecao, precisa_bem_estar: $('Selecionar Quest (Rotação)').item.json.precisa_bem_estar, humor_nivel: $('Selecionar Quest (Rotação)').item.json.humor_nivel, energia_nivel: $('Selecionar Quest (Rotação)').item.json.energia_nivel, ultimas_conversas: $('Selecionar Quest (Rotação)').item.json.ultimas_conversas, a_fazer: $('Selecionar Quest (Rotação)').item.json.quests_a_fazer, fazendo: $('Selecionar Quest (Rotação)').item.json.quests_fazendo } }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "usuario_id",
                "displayName": "usuario_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string"
              },
              {
                "id": "nome_preferencia",
                "displayName": "nome_preferencia",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string"
              },
              {
                "id": "tom_conversa",
                "displayName": "tom_conversa",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string"
              },
              {
                "id": "whats_number",
                "displayName": "whats_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string"
              },
              {
                "id": "lembretes_canais",
                "displayName": "lembretes_canais",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "array"
              },
              {
                "id": "push_tokens",
                "displayName": "push_tokens",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "array"
              },
              {
                "id": "tipo_notificacao",
                "displayName": "tipo_notificacao",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string"
              },
              {
                "id": "contexto",
                "displayName": "contexto",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "object"
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": true
          },
          "options": {}
        },
        "id": "1e44efc4-a0c5-45f7-84b8-9c9eb66dbc0c",
        "name": "Call sw_mentor_notificacoes (quests)",
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.3,
        "position": [
          752,
          80
        ]
      },
      {
        "parameters": {},
        "id": "3e1827fe-41ba-49cb-b284-f6b480dddcfe",
        "name": "Sem Quest (skip)",
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          432,
          368
        ]
      }
    ],
    "connections": {
      "Trigger Conversas 09h": {
        "main": [
          [
            {
              "node": "usuarios_conversas",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "usuarios_conversas": {
        "main": [
          [
            {
              "node": "Loop Conversas",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop Conversas": {
        "main": [
          [],
          [
            {
              "node": "Call sw_mentor_notificacoes (conversas)",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Call sw_mentor_notificacoes (conversas)": {
        "main": [
          [
            {
              "node": "Loop Conversas",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Trigger Quests 15h": {
        "main": [
          [
            {
              "node": "usuarios_elegiveis_quests",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "usuarios_elegiveis_quests": {
        "main": [
          [
            {
              "node": "Selecionar Quest (Rotação)",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Selecionar Quest (Rotação)": {
        "main": [
          [
            {
              "node": "Tem Quest?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Tem Quest?": {
        "main": [
          [
            {
              "node": "Loop Quests",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Sem Quest (skip)",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop Quests": {
        "main": [
          [],
          [
            {
              "node": "Call sw_mentor_notificacoes (quests)",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Call sw_mentor_notificacoes (quests)": {
        "main": [
          [
            {
              "node": "Loop Quests",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Aldo Santos",
    "name": null,
    "description": null
  }
}