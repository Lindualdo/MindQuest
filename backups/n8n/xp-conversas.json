{
  "createdAt": "2025-12-25T15:54:10.638Z",
  "updatedAt": "2025-12-25T15:54:23.485Z",
  "id": "w1CGNysygHWcqIrk",
  "name": "xp-conversas",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usuario_id",
              "type": "string"
            }
          ]
        }
      },
      "id": "start-trigger",
      "name": "start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        600,
        300
      ]
    },
    {
      "parameters": {
        "content": "## XP Conversas Simplificado (v5.0)\n\n### Regra Única\n- **10 XP por conversa/dia**\n\n### Lógica\n1. Verifica `ultima_conversa_em` != hoje\n2. Se diferente → atualiza XP + data\n3. Se igual → ignora (retorna sem processar)\n\n### UPSERT\n- Cria registro se não existir\n- Atualiza se já existir\n\n### Input\n- usuario_id (obrigatório)",
        "height": 400,
        "width": 600,
        "color": 5
      },
      "id": "sticky-regras",
      "name": "Regras XP v5",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -200,
        100
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- XP Conversa: 10 XP por dia (UPSERT simples)\nINSERT INTO usuarios_conquistas (\n  usuario_id,\n  xp_total,\n  xp_base,\n  conversas_concluidas,\n  nivel_atual,\n  titulo_nivel,\n  xp_proximo_nivel,\n  ultima_conversa_em,\n  atualizado_em\n)\nVALUES (\n  $1::uuid,\n  10,\n  10,\n  1,\n  1,\n  'Iniciante',\n  100,\n  NOW(),\n  NOW()\n)\nON CONFLICT (usuario_id) DO UPDATE SET\n  xp_total = CASE \n    WHEN DATE(usuarios_conquistas.ultima_conversa_em) < CURRENT_DATE\n    THEN usuarios_conquistas.xp_total + 10\n    ELSE usuarios_conquistas.xp_total\n  END,\n  xp_base = CASE\n    WHEN DATE(usuarios_conquistas.ultima_conversa_em) < CURRENT_DATE\n    THEN COALESCE(usuarios_conquistas.xp_base, 0) + 10\n    ELSE usuarios_conquistas.xp_base\n  END,\n  conversas_concluidas = CASE\n    WHEN DATE(usuarios_conquistas.ultima_conversa_em) < CURRENT_DATE\n    THEN usuarios_conquistas.conversas_concluidas + 1\n    ELSE usuarios_conquistas.conversas_concluidas\n  END,\n  ultima_conversa_em = CASE\n    WHEN DATE(usuarios_conquistas.ultima_conversa_em) < CURRENT_DATE\n    THEN NOW()\n    ELSE usuarios_conquistas.ultima_conversa_em\n  END,\n  atualizado_em = NOW()\nRETURNING \n  usuario_id, \n  xp_total, \n  conversas_concluidas,\n  DATE(ultima_conversa_em) AS ultima_conversa_data,\n  (DATE(EXCLUDED.ultima_conversa_em) > DATE(usuarios_conquistas.ultima_conversa_em)) AS foi_processado;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id] }}"
        }
      },
      "id": "processar-xp",
      "name": "Processar XP",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        800,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      },
      "maxTries": 3,
      "retryOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const result = $input.item.json;\n\nreturn [{\n  json: {\n    usuario_id: result.usuario_id,\n    resultado: result.foi_processado ? 'processado' : 'ignorado',\n    xp_ganho: result.foi_processado ? 10 : 0,\n    xp_total: result.xp_total,\n    conversas_concluidas: result.conversas_concluidas,\n    ultima_conversa: result.ultima_conversa_data\n  }\n}];"
      },
      "id": "resultado-final",
      "name": "Resultado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1000,
        300
      ]
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Processar XP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar XP": {
      "main": [
        [
          {
            "node": "Resultado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": null,
  "activeVersionId": null,
  "shared": [
    {
      "createdAt": "2025-12-25T15:54:10.638Z",
      "role": "workflow:owner",
      "workflowId": "w1CGNysygHWcqIrk",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [],
  "activeVersion": null
}
