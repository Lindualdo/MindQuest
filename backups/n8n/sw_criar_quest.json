{
  "createdAt": "2025-11-05T13:38:03.212Z",
  "id": "LKjU8NE9aNHw7kEh",
  "name": "sw_criar_quest",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usuario_id"
            },
            {
              "name": "chat_id"
            }
          ]
        }
      },
      "id": "9fe14879-ce30-4374-a87f-69de3fbe438c",
      "name": "start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -2416,
        -32
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json || {};\n\nconst usuarioId = input.usuario_id;\nif (!usuarioId) {\n  throw new Error('usuario_id obrigatório');\n}\n\nreturn [{\n  json: {\n    usuario_id: usuarioId,\n    chat_id: input.chat_id || null\n  }\n}];"
      },
      "id": "f3cc1aa7-afc2-4504-a02c-835de19b4d04",
      "name": "Normalizar Entrada",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2240,
        -32
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH quests AS (\n  SELECT\n    uq.id,\n    uq.status,\n    uq.catalogo_id,\n    COALESCE(uq.config->>'contexto_origem', '') AS contexto_origem,\n    COALESCE(uq.config->>'titulo', '') AS titulo,\n    uq.ativado_em,\n    uq.config\n  FROM public.usuarios_quest uq\n  WHERE uq.usuario_id = $1::uuid\n    AND uq.status IN ('disponivel', 'ativa')\n)\nSELECT json_build_object(\n  'quests_ativas',\n  COALESCE(json_agg(\n    json_build_object(\n      'id', quests.id,\n      'status', quests.status,\n      'catalogo_id', quests.catalogo_id,\n      'contexto_origem', quests.contexto_origem,\n      'titulo', quests.titulo,\n      'criado_em', quests.ativado_em,\n      'config', quests.config\n    )\n    ORDER BY quests.ativado_em DESC\n  ), '[]'::json)\n) AS contexto\nFROM quests;",
        "options": {
          "queryReplacement": "={{ [ $('Normalizar Entrada').item.json.usuario_id ] }}"
        }
      },
      "id": "cd8f2851-84d2-4d44-8745-57d64d3c9f25",
      "name": "Buscar Quests Ativas",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2048,
        -32
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH ultimas AS (\n  SELECT\n    uc.id,\n    uc.session_id,\n    uc.data_conversa,\n    uc.resumo_conversa,\n    uc.tem_reflexao,\n    uc.total_palavras_usuario,\n    uc.criado_em\n  FROM public.usr_chat uc\n  WHERE uc.usuario_id = $1::uuid\n  ORDER BY uc.data_conversa DESC, uc.criado_em DESC\n  LIMIT 10\n)\nSELECT json_build_object(\n  'conversas_recentes',\n  COALESCE(json_agg(\n    json_build_object(\n      'chat_id', ultimas.id,\n      'session_id', ultimas.session_id,\n      'data_conversa', ultimas.data_conversa,\n      'resumo', ultimas.resumo_conversa,\n      'tem_reflexao', ultimas.tem_reflexao,\n      'total_palavras', ultimas.total_palavras_usuario\n    )\n    ORDER BY ultimas.data_conversa DESC, ultimas.criado_em DESC\n  ), '[]'::json)\n) AS conversas\nFROM ultimas;",
        "options": {
          "queryReplacement": "={{ $('Normalizar Entrada').first().json.usuario_id }}"
        }
      },
      "id": "b27a61fc-f6b6-4c8f-821b-f7965c6256de",
      "name": "Buscar Conversas Recentes",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1872,
        -32
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH ultimos AS (\n  SELECT\n    i.id,\n    i.titulo,\n    i.categoria,\n    i.tipo,\n    i.prioridade,\n    i.resumo_situacao,\n    i.criado_em\n  FROM public.insights i\n  WHERE i.usuario_id = $1::uuid\n  ORDER BY i.criado_em DESC\n  LIMIT 10\n)\nSELECT json_build_object(\n  'insights_recentes',\n  COALESCE(json_agg(\n    json_build_object(\n      'id', ultimos.id,\n      'titulo', ultimos.titulo,\n      'categoria', ultimos.categoria,\n      'tipo', ultimos.tipo,\n      'prioridade', ultimos.prioridade,\n      'resumo', ultimos.resumo_situacao,\n      'criado_em', ultimos.criado_em\n    )\n    ORDER BY ultimos.criado_em DESC\n  ), '[]'::json)\n) AS insights\nFROM ultimos;",
        "options": {
          "queryReplacement": "={{ [ $('Normalizar Entrada').item.json.usuario_id ] }}"
        }
      },
      "id": "1d7619fc-77a4-42cf-a131-9a906520be60",
      "name": "Buscar Insights Recentes",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1360,
        -96
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT json_build_object(\n  'areas_vida',\n  COALESCE(json_agg(\n    json_build_object(\n      'id', avc.id,\n      'codigo', avc.codigo,\n      'nome', avc.nome,\n      'descricao', avc.descricao\n    )\n    ORDER BY avc.nome ASC\n  ), '[]'::json)\n) AS areas\nFROM public.areas_vida_catalogo avc\nWHERE avc.ativo IS TRUE;",
        "options": {}
      },
      "id": "c7957660-43a7-4997-b0f7-6ed1ff66215f",
      "name": "Listar Áreas da Vida",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -928,
        -112
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT u.id, u.estagio_jornada FROM public.usuarios u WHERE u.id = $1::uuid;",
        "options": {
          "queryReplacement": "={{ [ $('Normalizar Entrada').item.json.usuario_id ] }}"
        }
      },
      "id": "5c0debac-5dd2-431b-a9bc-170665cf8544",
      "name": "Buscar Estágio Usuário",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -720,
        -112
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Query corrigida para o nó \"Buscar Quests Catálogo\"\n-- Permite quests de sabotador independentemente do nivel_prioridade\n\nWITH estagio_user AS (\n  SELECT estagio_jornada FROM public.usuarios WHERE id = $1::uuid\n)\nSELECT json_build_object(\n  'quests_catalogo',\n  COALESCE(json_agg(\n    json_build_object(\n      'id', qc.id,\n      'codigo', qc.codigo,\n      'titulo', qc.titulo,\n      'descricao', qc.descricao,\n      'categoria', qc.categoria,\n      'sabotador_id', qc.sabotador_id,\n      'base_cientifica', qc.base_cientifica,\n      'instrucoes', qc.instrucoes,\n      'tempo_estimado_min', qc.tempo_estimado_min,\n      'dificuldade', qc.dificuldade,\n      'nivel_prioridade', qc.nivel_prioridade,\n      'xp', qc.xp\n    )\n    ORDER BY \n      qc.dificuldade ASC,\n      qc.nivel_prioridade DESC\n  ), '[]'::json)\n) AS catalogo\nFROM public.quests_catalogo qc\nCROSS JOIN estagio_user eu\nWHERE qc.ativo IS TRUE\n  AND (\n    -- Excluir apenas reflexão (criada automaticamente) e categoria personalizada\n    qc.codigo != 'reflexao_diaria'\n    AND qc.categoria != 'personalizada'\n    AND (\n      -- Incluir quests de sabotador OU\n      qc.sabotador_id IS NOT NULL\n      OR\n      -- Incluir todas as outras categorias (TCC, Estoicismo, Essencial, Neurociência, Boa Prática, etc.)\n      (qc.categoria IS NOT NULL AND qc.sabotador_id IS NULL)\n    )\n  )\n  AND (\n    -- Quests de sabotador: ignorar nivel_prioridade (sempre disponíveis se dificuldade adequada)\n    (qc.sabotador_id IS NOT NULL AND (\n      (eu.estagio_jornada = 1 AND qc.dificuldade <= 2)\n      OR (eu.estagio_jornada = 2 AND qc.dificuldade >= 2 AND qc.dificuldade <= 3)\n      OR (eu.estagio_jornada = 3 AND qc.dificuldade >= 2)\n      OR (eu.estagio_jornada = 4)\n    ))\n    OR\n    -- Outras quests: aplicar filtro completo (incluindo nivel_prioridade)\n    (qc.sabotador_id IS NULL AND (\n      (eu.estagio_jornada = 1 AND qc.dificuldade <= 2 AND qc.nivel_prioridade >= 2)\n      OR (eu.estagio_jornada = 2 AND qc.dificuldade >= 2 AND qc.dificuldade <= 3)\n      OR (eu.estagio_jornada = 3 AND qc.dificuldade >= 2)\n      OR (eu.estagio_jornada = 4)\n    ))\n  );\n\n",
        "options": {
          "queryReplacement": "={{ [ $('Normalizar Entrada').item.json.usuario_id ] }}"
        }
      },
      "id": "b88dfbd9-1e8d-41b6-9db7-54e09e1bc43c",
      "name": "Buscar Quests Catálogo",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -544,
        -112
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const getJson = (nodeName) => {\n  const data = $items(nodeName, 0, 0) || [];\n  const item = data[0] || {};\n  return item.json || {};\n};\n\nconst getNested = (source, path, fallback = undefined) => {\n  return path.reduce((acc, key) => (acc && acc[key] !== undefined ? acc[key] : undefined), source) ?? fallback;\n};\n\nconst entrada = getJson(\"Normalizar Entrada\");\nconst questsRaw = getJson(\"Buscar Quests Ativas\");\nconst conversasRaw = getJson(\"Buscar Conversas Recentes\");\nconst insightsRaw = getJson(\"Buscar Insights Recentes\");\nconst objetivosRaw = getJson(\"Buscar Objetivos Ativos\");\nconst sabotadoresRaw = getJson(\"Buscar Sabotadores Ativo\");\nconst areasRaw = getJson(\"Listar Áreas da Vida\");\nconst estagioRaw = getJson(\"Buscar Estágio Usuário\");\nconst catalogoRaw = getJson(\"Buscar Quests Catálogo\");\n\nconst quests = questsRaw.contexto || {};\nconst questsAtivas = Array.isArray(quests.quests_ativas) ? quests.quests_ativas : [];\n\n// Lista de quests já criadas (para evitar duplicatas)\nconst questsJaCriadas = questsAtivas.map(q => ({\n  id: q.id,\n  titulo: q.titulo || q.config?.titulo || '',\n  catalogo_id: q.catalogo_id,\n  contexto_origem: q.contexto_origem || '',\n  status: q.status,\n  concluido_em: q.concluido_em\n}));\n\n// IDs de catálogo já usados (para priorizar quests novas)\nconst catalogoIdsJaUsados = new Set(\n  questsAtivas\n    .filter(q => q.catalogo_id)\n    .map(q => q.catalogo_id)\n);\n\nconst estagioJornada = estagioRaw.estagio_jornada || 1;\n\nconst catalogoData = catalogoRaw.catalogo || {};\nconst questsCatalogo = Array.isArray(catalogoData.quests_catalogo) ? catalogoData.quests_catalogo : [];\n\n// Filtrar quests do catálogo: priorizar as que ainda não foram usadas\nconst questsCatalogoNovas = questsCatalogo.filter(q => !catalogoIdsJaUsados.has(q.id));\nconst questsCatalogoUsadas = questsCatalogo.filter(q => catalogoIdsJaUsados.has(q.id));\n\n// Identificar sabotador mais ativo (já vem da query com a regra correta)\nconst sabotadores = sabotadoresRaw.sabotadores || {};\nconst sabotadorMaisAtivo = sabotadores.sabotador_mais_ativo || null;\nconst sabotadoresRecentes = Array.isArray(sabotadores.sabotadores_recentes) ? sabotadores.sabotadores_recentes : [];\n\n// Buscar quests do catálogo por categoria (priorizando novas)\nconst questReflexao = questsCatalogoNovas.find(q => q.codigo === 'reflexao_diaria') \n  || questsCatalogoUsadas.find(q => q.codigo === 'reflexao_diaria') \n  || null;\n  \nconst questsSabotador = sabotadorMaisAtivo && sabotadorMaisAtivo.sabotador_id ? [\n  ...questsCatalogoNovas.filter(q => q.sabotador_id && q.sabotador_id === sabotadorMaisAtivo.sabotador_id),\n  ...questsCatalogoUsadas.filter(q => q.sabotador_id && q.sabotador_id === sabotadorMaisAtivo.sabotador_id)\n] : [];\n\nconst questsTCC = [\n  ...questsCatalogoNovas.filter(q => q.categoria === 'tcc'),\n  ...questsCatalogoUsadas.filter(q => q.categoria === 'tcc')\n];\n\nconst questsEstoicismo = [\n  ...questsCatalogoNovas.filter(q => q.categoria === 'estoicismo'),\n  ...questsCatalogoUsadas.filter(q => q.categoria === 'estoicismo')\n];\n\nconst conversas = conversasRaw.conversas || {};\nconst conversasRecentes = Array.isArray(conversas.conversas_recentes) ? conversas.conversas_recentes : [];\n\nconst insights = insightsRaw.insights || {};\nconst areasVida = getNested(areasRaw, ['areas', 'areas_vida'], []);\n\n// === OBJETIVOS DO USUÁRIO ===\nconst objetivosData = objetivosRaw.objetivos || {};\nconst objetivosAtivos = Array.isArray(objetivosData.objetivos_ativos) ? objetivosData.objetivos_ativos : [];\n\nreturn [{\n  json: {\n    usuario_id: entrada.usuario_id,\n    chat_id: entrada.chat_id,\n    estagio_jornada: estagioJornada,\n    quests_ativas: questsAtivas.filter(q => q.status === 'pendente' || q.status === 'ativa'),\n    quests_ja_criadas: questsJaCriadas,\n    conversas_recentes: conversasRecentes,\n    insights_recentes: insights.insights_recentes || [],\n    sabotadores_recentes: sabotadoresRecentes,\n    sabotador_mais_ativo: sabotadorMaisAtivo,\n    areas_vida_disponiveis: areasVida,\n    objetivos_ativos: objetivosAtivos,\n    quests_catalogo: {\n      reflexao: questReflexao,\n      sabotador: questsSabotador,\n      tcc: questsTCC,\n      estoicismo: questsEstoicismo,\n      todas: questsCatalogo,\n      novas: questsCatalogoNovas,\n      usadas: questsCatalogoUsadas\n    }\n  }\n}];"
      },
      "id": "3dd5517a-4841-411a-8111-6a96b2c8c790",
      "name": "Montar Contexto",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -368,
        -112
      ]
    },
    {
      "parameters": {
        "jsCode": "const entrada = $input.item.json || {};\n\nconst sabotadorMaisAtivo = entrada.sabotador_mais_ativo;\nconst questsCatalogo = entrada.quests_catalogo || {};\nconst questsJaCriadas = entrada.quests_ja_criadas || [];\n\n// IDs de catálogo já usados\nconst catalogoIdsUsados = new Set(\n  questsJaCriadas\n    .filter(q => q.catalogo_id)\n    .map(q => q.catalogo_id)\n);\n\n// Função para escolher melhor quest do catálogo\nconst escolherQuestCatalogo = (lista, priorizarNovas = true) => {\n  if (!Array.isArray(lista) || lista.length === 0) return null;\n  \n  const novas = lista.filter(q => !catalogoIdsUsados.has(q.id));\n  const usadas = lista.filter(q => catalogoIdsUsados.has(q.id));\n  \n  const candidatas = priorizarNovas && novas.length > 0 ? novas : (usadas.length > 0 ? usadas : lista);\n  \n  return candidatas.length > 0 ? candidatas[0] : null;\n};\n\n// Escolher quest do sabotador (SEMPRE necessário se houver sabotador ativo)\nconst questSabotador = sabotadorMaisAtivo && sabotadorMaisAtivo.sabotador_id\n  ? escolherQuestCatalogo(questsCatalogo.sabotador || [], true)\n  : null;\n\n// Escolher quest TCC, Estoicismo ou outras categorias (SEMPRE necessário)\nconst todasQuests = questsCatalogo.todas || [];\nconst questsTCCEstoicismoOutras = todasQuests.filter(q => {\n  if (q.sabotador_id) return false;\n  if (q.codigo === 'reflexao_diaria') return false;\n  return q.categoria && q.categoria !== 'personalizada';\n});\n\nconst questTCCEstoicismoOutras = escolherQuestCatalogo(questsTCCEstoicismoOutras, true);\n\n// Garantir que conversas_recentes seja array\nconst conversasRecentes = Array.isArray(entrada.conversas_recentes) \n  ? entrada.conversas_recentes \n  : [];\n\n// === SEPARAR CONVERSA ATUAL DO HISTÓRICO ===\nconst conversaAtual = conversasRecentes.length > 0 \n  ? {\n      data: conversasRecentes[0].data_conversa || conversasRecentes[0].data || null,\n      resumo: conversasRecentes[0].resumo || conversasRecentes[0].resumo_conversa || ''\n    }\n  : null;\n\nconst conversasHistorico = conversasRecentes\n  .slice(1, 3) // Pegar apenas as 2 anteriores\n  .map(c => ({\n    data: c.data_conversa || c.data || null,\n    resumo: c.resumo || c.resumo_conversa || ''\n  }))\n  .filter(c => c.data && c.resumo);\n\n// === QUESTS JÁ CRIADAS (títulos para evitar duplicação) ===\nconst questsJaCriadasTitulos = questsJaCriadas\n  .slice(0, 10) // Limitar a 10 mais recentes\n  .map(q => q.titulo || q.config?.titulo || '')\n  .filter(t => t && t.trim() !== '');\n\n// === OBJETIVOS DO USUÁRIO ===\nconst objetivosAtivos = Array.isArray(entrada.objetivos_ativos) ? entrada.objetivos_ativos : [];\nconst objetivoPadrao = objetivosAtivos.find(o => o.is_padrao) || null;\nconst objetivosEspecificos = objetivosAtivos.filter(o => !o.is_padrao);\n\n// === ÁREAS DA VIDA (apenas id e nome) ===\nconst areasDisponiveis = (Array.isArray(entrada.areas_vida_disponiveis) ? entrada.areas_vida_disponiveis : [])\n  .map(a => ({ id: a.id || null, nome: a.nome || '' }))\n  .filter(a => a.id && a.nome);\n\n// === QUEST SABOTADOR RESUMIDA (só campos essenciais) ===\nconst questSabotadorResumida = questSabotador ? {\n  catalogo_id: questSabotador.id,\n  titulo: questSabotador.titulo,\n  descricao: questSabotador.descricao,\n  categoria: questSabotador.categoria,\n  xp: questSabotador.xp\n} : null;\n\n// === QUEST TCC RESUMIDA (só campos essenciais) ===\nconst questTCCResumida = questTCCEstoicismoOutras ? {\n  catalogo_id: questTCCEstoicismoOutras.id,\n  titulo: questTCCEstoicismoOutras.titulo,\n  descricao: questTCCEstoicismoOutras.descricao,\n  categoria: questTCCEstoicismoOutras.categoria,\n  xp: questTCCEstoicismoOutras.xp\n} : null;\n\n// Preparar contexto limpo para o agente\nreturn [{\n  json: {\n    usuario_id: entrada.usuario_id,\n    chat_id: entrada.chat_id,\n    \n    // === CONVERSAS ===\n    conversa_atual: conversaAtual,\n    conversas_historico: conversasHistorico,\n    \n    // === ANTI-DUPLICAÇÃO ===\n    quests_ja_criadas_titulos: questsJaCriadasTitulos,\n    \n    // === ÁREAS ===\n    areas_disponiveis: areasDisponiveis,\n    \n    // === SABOTADOR (com nome original) ===\n    sabotador_mais_ativo: sabotadorMaisAtivo || null,\n    \n    // === OBJETIVOS ===\n    objetivos_usuario: {\n      padrao: objetivoPadrao ? {\n        id: objetivoPadrao.id,\n        titulo: objetivoPadrao.titulo,\n        area_vida: objetivoPadrao.area_vida\n      } : null,\n      especificos: objetivosEspecificos.map(o => ({\n        id: o.id,\n        titulo: o.titulo,\n        area_vida: o.area_vida\n      }))\n    },\n    \n    // === QUESTS DO CATÁLOGO (resumidas) ===\n    quests_catalogo_escolhidas: {\n      sabotador: questSabotadorResumida,\n      tcc_estoicismo_outras: questTCCResumida\n    }\n  }\n}];"
      },
      "id": "2d62e97a-408c-4534-87d4-415031009581",
      "name": "Preparar Quest do Catálogo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -144,
        -112
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "8eddbd84-6796-47bb-97a3-687188bcb602",
      "name": "OpenRouter Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        0,
        272
      ],
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=== CONTEXTO DO USUÁRIO ===\n\n**CONVERSA ATUAL (gatilho desta execução):**\n{{ JSON.stringify($json.conversa_atual || null) }}\n\n**HISTÓRICO RECENTE (últimas 2 conversas):**\n{{ JSON.stringify($json.conversas_historico || []) }}\n\n**QUESTS JÁ EXISTENTES (EVITAR TÍTULOS SIMILARES):**\n{{ JSON.stringify($json.quests_ja_criadas_titulos || []) }}\n\n=== SABOTADOR MAIS ATIVO ===\n{{ JSON.stringify($json.sabotador_mais_ativo || null) }}\n\n=== OBJETIVOS DO USUÁRIO ===\n**Objetivo Padrão:** {{ JSON.stringify($json.objetivos_usuario?.padrao || null) }}\n**Objetivos Específicos:** {{ JSON.stringify($json.objetivos_usuario?.especificos || []) }}\n\n=== ÁREAS DISPONÍVEIS ===\n{{ JSON.stringify($json.areas_disponiveis || []) }}\n\n=== QUESTS DO CATÁLOGO (JÁ PRÉ-SELECIONADAS) ===\n**Quest Sabotador:** {{ JSON.stringify($json.quests_catalogo_escolhidas?.sabotador || null) }}\n**Quest TCC/Outras:** {{ JSON.stringify($json.quests_catalogo_escolhidas?.tcc_estoicismo_outras || null) }}\n\n=== GERAR EXATAMENTE 3 QUESTS ===\n\n**1. Quest PERSONALIZADA** (criar do zero)\n- Baseada na CONVERSA ATUAL\n- `catalogo_id`: null\n- `objetivo_id`: objetivo específico (se relacionado) ou padrão\n\n**2. Quest SABOTADOR** (adaptar do catálogo)\n- Usar `catalogo_id` da quest pré-selecionada\n- `sabotador_id`: do sabotador mais ativo\n- `objetivo_id`: SEMPRE o objetivo PADRÃO\n\n**3. Quest TCC/OUTRAS** (adaptar do catálogo)\n- Usar `catalogo_id` da quest pré-selecionada\n- `objetivo_id`: SEMPRE o objetivo PADRÃO\n- `objetivos_secundarios`: [] (SEMPRE VAZIO)\n\n=== FORMATO DE SAÍDA ===\nJSON válido:\n```json\n{\"quests\":[\n  {\n    \"tipo\": \"personalizada\",\n    \"catalogo_id\": null,\n    \"titulo\": \"Título engajador\",\n    \"descricao\": \"Descrição clara\",\n    \"base_cientifica\": {\n      \"tipo\": \"personalizada\",\n      \"objetivo\": \"Benefício para o usuário\",\n      \"fundamentos\": \"Embasamento científico\",\n      \"como_aplicar\": \"Passos usando MindQuest\",\n      \"links_referencias\": []\n    },\n    \"contexto_origem\": \"conversa_especifica\",\n    \"prioridade\": \"alta|media|baixa\",\n    \"recorrencia\": \"diaria|semanal|unica\",\n    \"prazo_inicio\": \"YYYY-MM-DD\",\n    \"prazo_fim\": \"YYYY-MM-DD\",\n    \"progresso_meta\": 5,\n    \"area_vida_id\": \"uuid-da-area\",\n    \"sabotador_id\": null,\n    \"objetivo_id\": \"uuid-objetivo\",\n    \"objetivos_secundarios\": [],\n    \"complexidade\": 2,\n    \"xp_recompensa\": 40\n  },\n  {\"tipo\": \"catalogo\", \"catalogo_id\": \"uuid\", ...},\n  {\"tipo\": \"catalogo\", \"catalogo_id\": \"uuid\", ...}\n]}\n```",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "Você é o **Especialista em Criação de Quests** do MindQuest.\n\n=== SUA MISSÃO ===\nTransformar conversas em ações práticas. Você é o coração do **AGIR** no framework CONVERSAR → ENTENDER → AGIR → EVOLUIR.\n\n=== REGRAS OBRIGATÓRIAS ===\n\n1. **SEMPRE gerar exatamente 3 quests** (1 personalizada + 2 do catálogo)\n2. **SEMPRE incluir `base_cientifica`** completo em cada quest\n3. **NUNCA criar títulos similares** aos já existentes\n4. **NUNCA sugerir ferramentas externas** - usar sempre MindQuest\n5. **SEMPRE usar nomes originais dos sabotadores** (Ex: Sr. Perfeccionista, Sr. Inquieto)\n\n=== MAPEAMENTO DE FUNCIONALIDADES ===\n| Necessidade | Use no MindQuest |\n|-------------|------------------|\n| Diário/Registro | Conversa com mentor |\n| Check-in emocional | Menu Conversar → Check-in |\n| Reflexão | Conversa diária/semanal |\n| Acompanhamento | Menu Entender → Dashboard |\n| Progresso | Menu Evoluir → Pontos |\n| Padrões | Menu Entender → Sabotadores |\n\n=== ERROS A EVITAR ===\n❌ \"Use um diário ou app para anotar...\"\n✅ \"Na conversa com seu mentor no MindQuest, registre...\"\n\n❌ \"Anote em um caderno...\"\n✅ \"Registre no check-in do MindQuest...\"\n\n=== REGRAS POR TIPO DE QUEST ===\n\n**1. PERSONALIZADA (catalogo_id = null):**\n- Criar do zero baseada na conversa atual\n- Foco em ações PRÁTICAS (trabalho, saúde, projetos, finanças)\n- NÃO incluir questões emocionais/comportamentais (cobertas pelo catálogo)\n- objetivo_id: específico se relacionado, senão padrão\n\n**2. SABOTADOR (do catálogo):**\n- Adaptar título/descrição ao contexto do usuário\n- MANTER catalogo_id fornecido\n- USAR sabotador_id do sabotador mais ativo\n- objetivo_id: SEMPRE o padrão\n- Referenciar pelo nome original (Ex: \"Para combater o Sr. Perfeccionista...\")\n\n**3. TCC/ESTOICISMO/OUTRAS (do catálogo):**\n- Adaptar ao contexto das conversas\n- MANTER catalogo_id fornecido\n- objetivo_id: SEMPRE o padrão\n- objetivos_secundarios: SEMPRE [] (vazio)\n\n=== ESTRUTURA base_cientifica ===\n```json\n{\n  \"tipo\": \"personalizada|sabotador|tcc|estoicismo|boa_pratica\",\n  \"objetivo\": \"Benefício claro (por que fazer?)\",\n  \"fundamentos\": \"Embasamento científico/filosófico\",\n  \"como_aplicar\": \"Passos práticos usando MindQuest\",\n  \"links_referencias\": []\n}\n```\n\n=== EXEMPLO DE como_aplicar ===\n```\n1. Reserve um horário fixo semanalmente.\n2. Na conversa com seu mentor no MindQuest, registre suas conquistas.\n3. Reflita sobre padrões no menu Entender.\n4. Marque esta quest como concluída após completar.\n5. Acompanhe seus pontos no menu Evoluir.\n```"
        }
      },
      "id": "1da28891-e6dd-437c-8e69-f3ab98ab4c70",
      "name": "Agente Quests",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        112,
        -112
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const getJson = (nodeName) => {\n  const data = $items(nodeName, 0, 0) || [];\n  const item = data[0] || {};\n  return item.json || {};\n};\n\n// Buscar contexto do nó \"Montar Contexto\" para ter insights_recentes completo\nconst contextoMontar = getJson(\"Montar Contexto\");\nconst contextoPreparar = getJson(\"Preparar Quest do Catálogo\");\n\nconst rawOutput = $json.output ?? { quests: [] };\nlet resultado;\nif (typeof rawOutput === 'string') {\n  try {\n    resultado = JSON.parse(rawOutput);\n  } catch (error) {\n    resultado = { quests: [] };\n  }\n} else if (rawOutput && typeof rawOutput === 'object') {\n  resultado = rawOutput;\n} else {\n  resultado = { quests: [] };\n}\n\nconst novasQuests = Array.isArray(resultado.quests) ? resultado.quests : [];\n\nreturn [{\n  json: {\n    usuario_id: contextoPreparar.usuario_id,\n    chat_id: contextoPreparar.chat_id,\n    novas_quests_sugeridas: novasQuests,\n    atualizacoes_sugeridas: [],\n    sabotadores_recentes: contextoMontar.sabotadores_recentes || [],\n    insights_recentes: contextoMontar.insights_recentes || [],\n    areas_disponiveis: contextoPreparar.areas_disponiveis || [],\n    objetivos_disponiveis: contextoMontar.objetivos_ativos || []\n  }\n}];"
      },
      "id": "1f306616-865d-45c4-b7bb-ec303de060c4",
      "name": "Interpretar Resultado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        464,
        -112
      ]
    },
    {
      "parameters": {
        "jsCode": "const entrada = ($input.item && $input.item.json) ? $input.item.json : {};\nconst questsAtivas = Array.isArray(entrada.quests_ativas) ? entrada.quests_ativas : [];\nconst questsJaCriadas = Array.isArray(entrada.quests_ja_criadas) ? entrada.quests_ja_criadas : [];\nconst QUESTS_OBRIGATORIAS = 3;\nconst dedupe = new Set();\nconst catalogoIdsUsados = new Set();\nconst titulosUsados = new Set();\nconst uuidRegex = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;\nconst insightsValidos = new Set(\n  (Array.isArray(entrada.insights_recentes) ? entrada.insights_recentes : [])\n    .map((item) => (typeof item?.id === 'string' ? item.id.trim().toLowerCase() : null))\n    .filter(Boolean)\n);\n\n// === VALIDAÇÃO DE ÁREAS DA VIDA ===\nconst areasValidas = new Set(\n  (Array.isArray(entrada.areas_disponiveis) ? entrada.areas_disponiveis : [])\n    .map((item) => (typeof item?.id === 'string' ? item.id.trim().toLowerCase() : null))\n    .filter(Boolean)\n);\n\n// === VALIDAÇÃO DE OBJETIVOS ===\nconst objetivosValidos = new Set(\n  (Array.isArray(entrada.objetivos_disponiveis) ? entrada.objetivos_disponiveis : [])\n    .map((item) => (typeof item?.id === 'string' ? item.id.trim().toLowerCase() : null))\n    .filter(Boolean)\n);\n\n// Preencher sets de duplicatas com quests já criadas\nfor (const questJaCriada of questsJaCriadas) {\n  const titulo = String(questJaCriada?.titulo || '').toLowerCase().trim();\n  const catalogoId = questJaCriada?.catalogo_id;\n  \n  if (titulo) {\n    titulosUsados.add(titulo);\n  }\n  \n  if (catalogoId && uuidRegex.test(catalogoId)) {\n    catalogoIdsUsados.add(catalogoId);\n  }\n  \n  const contexto = String(questJaCriada?.contexto_origem || '').toLowerCase().trim();\n  if (contexto || titulo) {\n    dedupe.add(`${contexto}|${titulo}`);\n  }\n}\n\n// Verificar duplicatas das quests ativas\nfor (const ativo of questsAtivas) {\n  const contexto = String(ativo?.contexto_origem || '').toLowerCase().trim();\n  const titulo = String((ativo?.config?.titulo ?? ativo?.titulo ?? '')).toLowerCase().trim();\n  const catalogoId = ativo?.catalogo_id;\n  \n  if (titulo) {\n    titulosUsados.add(titulo);\n  }\n  \n  if (catalogoId && uuidRegex.test(catalogoId)) {\n    catalogoIdsUsados.add(catalogoId);\n  }\n  \n  if (contexto || titulo) {\n    dedupe.add(`${contexto}|${titulo}`);\n  }\n}\n\nconst novas = [];\nconst atualizacoes = Array.isArray(entrada.atualizacoes_sugeridas) ? entrada.atualizacoes_sugeridas : [];\nconst candidatas = Array.isArray(entrada.novas_quests_sugeridas) ? entrada.novas_quests_sugeridas : [];\n\n// Função para verificar similaridade de títulos (evitar duplicatas)\nconst tituloSimilar = (titulo1, titulo2) => {\n  const t1 = String(titulo1 || '').toLowerCase().trim();\n  const t2 = String(titulo2 || '').toLowerCase().trim();\n  \n  if (!t1 || !t2) return false;\n  \n  const palavras1 = t1.split(/\\s+/);\n  const palavras2 = t2.split(/\\s+/);\n  const palavrasComuns = palavras1.filter(p => palavras2.includes(p));\n  const similaridade = palavrasComuns.length / Math.max(palavras1.length, palavras2.length);\n  \n  return similaridade >= 0.8 || t1.includes(t2) || t2.includes(t1);\n};\n\nconst questsPorTipo = { \n  personalizada: null, \n  sabotador: null, \n  tcc_estoicismo: null \n};\n\nfor (const quest of candidatas) {\n  if (!quest || typeof quest !== 'object') continue;\n  \n  const contexto = String(quest.contexto_origem || '').toLowerCase().trim();\n  const titulo = String(quest.titulo || '').toLowerCase().trim();\n  const chave = `${contexto}|${titulo}`;\n  \n  if (!contexto && !titulo) continue;\n  if (dedupe.has(chave)) continue;\n  \n  let tituloMuitoSimilar = false;\n  for (const tituloUsado of titulosUsados) {\n    if (tituloSimilar(titulo, tituloUsado)) {\n      tituloMuitoSimilar = true;\n      break;\n    }\n  }\n  if (tituloMuitoSimilar) continue;\n  \n  let catalogoId = null;\n  if (typeof quest.catalogo_id === 'string') {\n    const trimmed = quest.catalogo_id.trim();\n    if (trimmed && uuidRegex.test(trimmed)) {\n      if (catalogoIdsUsados.has(trimmed)) {\n        continue;\n      }\n      catalogoId = trimmed;\n    }\n  }\n  \n  // === VALIDAR area_vida_id contra lista de IDs válidos ===\n  let areaVidaId = null;\n  if (typeof quest.area_vida_id === 'string') {\n    const trimmed = quest.area_vida_id.trim();\n    if (trimmed && uuidRegex.test(trimmed) && areasValidas.has(trimmed.toLowerCase())) {\n      areaVidaId = trimmed;\n    }\n  }\n  \n  let insightId = null;\n  if (typeof quest.insight_id === 'string') {\n    const trimmed = quest.insight_id.trim();\n    if (trimmed && uuidRegex.test(trimmed) && insightsValidos.has(trimmed.toLowerCase())) {\n      insightId = trimmed;\n    }\n  }\n  \n  let sabotadorId = null;\n  if (typeof quest.sabotador_id === 'string') {\n    const trimmed = quest.sabotador_id.trim();\n    if (trimmed && uuidRegex.test(trimmed)) {\n      sabotadorId = trimmed;\n    }\n  }\n  \n  // === VALIDAR objetivo_id contra lista de IDs válidos ===\n  let objetivoId = null;\n  if (typeof quest.objetivo_id === 'string') {\n    const trimmed = quest.objetivo_id.trim();\n    if (trimmed && uuidRegex.test(trimmed) && objetivosValidos.has(trimmed.toLowerCase())) {\n      objetivoId = trimmed;\n    }\n  }\n  \n  // === OBJETIVOS_SECUNDARIOS - validar cada um ===\n  let objetivosSecundarios = [];\n  if (Array.isArray(quest.objetivos_secundarios)) {\n    objetivosSecundarios = quest.objetivos_secundarios\n      .filter(os => os && typeof os.objetivo_id === 'string' && uuidRegex.test(os.objetivo_id.trim()) && objetivosValidos.has(os.objetivo_id.trim().toLowerCase()))\n      .map(os => ({ objetivo_id: os.objetivo_id.trim() }));\n  }\n  \n  // === REGRA FORÇADA: Quest do catálogo SEM sabotador = SEM objetivos secundários ===\n  if (catalogoId && !sabotadorId) {\n    objetivosSecundarios = []; // FORÇAR VAZIO\n  }\n  \n  let tipoCategoria = 'personalizada';\n  \n  if (catalogoId) {\n    if (contexto.includes('sabotador') || contexto.includes('sabot') || sabotadorId) {\n      tipoCategoria = 'sabotador';\n    } else if (contexto.includes('reflexao') || contexto.includes('reflex')) {\n      continue;\n    } else {\n      tipoCategoria = 'tcc_estoicismo';\n    }\n  } else {\n    tipoCategoria = 'personalizada';\n  }\n  \n  const questProcessada = {\n    tipo: quest.tipo || (catalogoId ? 'catalogo' : 'personalizada'),\n    catalogo_id: catalogoId,\n    titulo: quest.titulo,\n    descricao: quest.descricao,\n    base_cientifica: quest.base_cientifica || null,\n    contexto_origem: quest.contexto_origem,\n    prioridade: quest.prioridade || 'media',\n    recorrencia: quest.recorrencia || 'unica',\n    prazo_inicio: quest.prazo_inicio || null,\n    prazo_fim: quest.prazo_fim || null,\n    progresso_meta: quest.progresso_meta ?? 1,\n    status_inicial: quest.status_inicial || 'disponivel',\n    area_vida_id: areaVidaId,\n    sabotador_id: sabotadorId,\n    insight_id: insightId,\n    objetivo_id: objetivoId,\n    objetivos_secundarios: objetivosSecundarios,\n    complexidade: quest.complexidade ?? 0,\n    payload_extra: quest.payload_extra || {},\n    xp_recompensa: quest.xp_recompensa || 40\n  };\n  \n  if (tipoCategoria === 'personalizada' && !questsPorTipo.personalizada) {\n    questsPorTipo.personalizada = questProcessada;\n  } else if (tipoCategoria === 'sabotador' && !questsPorTipo.sabotador) {\n    questsPorTipo.sabotador = questProcessada;\n  } else if (tipoCategoria === 'tcc_estoicismo' && !questsPorTipo.tcc_estoicismo) {\n    questsPorTipo.tcc_estoicismo = questProcessada;\n  }\n  \n  dedupe.add(chave);\n  if (titulo) titulosUsados.add(titulo);\n  if (catalogoId) catalogoIdsUsados.add(catalogoId);\n}\n\nconst questsFinais = [];\nif (questsPorTipo.personalizada) questsFinais.push(questsPorTipo.personalizada);\nif (questsPorTipo.sabotador) questsFinais.push(questsPorTipo.sabotador);\nif (questsPorTipo.tcc_estoicismo) questsFinais.push(questsPorTipo.tcc_estoicismo);\n\nfor (const quest of candidatas) {\n  if (questsFinais.length >= QUESTS_OBRIGATORIAS) break;\n  if (!quest || typeof quest !== 'object') continue;\n  \n  const contexto = String(quest.contexto_origem || '').toLowerCase().trim();\n  const titulo = String(quest.titulo || '').toLowerCase().trim();\n  const chave = `${contexto}|${titulo}`;\n  \n  if (contexto.includes('reflexao') || contexto.includes('reflex')) {\n    continue;\n  }\n  \n  if (dedupe.has(chave)) continue;\n  \n  let tituloMuitoSimilar = false;\n  for (const tituloUsado of titulosUsados) {\n    if (tituloSimilar(titulo, tituloUsado)) {\n      tituloMuitoSimilar = true;\n      break;\n    }\n  }\n  if (tituloMuitoSimilar) continue;\n  \n  let catalogoId = null;\n  if (typeof quest.catalogo_id === 'string') {\n    const trimmed = quest.catalogo_id.trim();\n    if (trimmed && uuidRegex.test(trimmed)) {\n      if (catalogoIdsUsados.has(trimmed)) {\n        continue;\n      }\n      catalogoId = trimmed;\n    }\n  }\n  \n  let insightId = null;\n  if (typeof quest.insight_id === 'string') {\n    const trimmed = quest.insight_id.trim();\n    if (trimmed && uuidRegex.test(trimmed) && insightsValidos.has(trimmed.toLowerCase())) {\n      insightId = trimmed;\n    }\n  }\n  \n  // === VALIDAR area_vida_id contra lista de IDs válidos ===\n  let areaVidaId = null;\n  if (typeof quest.area_vida_id === 'string') {\n    const trimmed = quest.area_vida_id.trim();\n    if (trimmed && uuidRegex.test(trimmed) && areasValidas.has(trimmed.toLowerCase())) {\n      areaVidaId = trimmed;\n    }\n  }\n  \n  // === VALIDAR objetivo_id contra lista de IDs válidos ===\n  let objetivoId = null;\n  if (typeof quest.objetivo_id === 'string') {\n    const trimmed = quest.objetivo_id.trim();\n    if (trimmed && uuidRegex.test(trimmed) && objetivosValidos.has(trimmed.toLowerCase())) {\n      objetivoId = trimmed;\n    }\n  }\n  \n  let sabotadorId = null;\n  if (typeof quest.sabotador_id === 'string') {\n    const trimmed = quest.sabotador_id.trim();\n    if (trimmed && uuidRegex.test(trimmed)) {\n      sabotadorId = trimmed;\n    }\n  }\n  \n  // === OBJETIVOS_SECUNDARIOS - validar cada um ===\n  let objetivosSecundarios = [];\n  if (Array.isArray(quest.objetivos_secundarios)) {\n    objetivosSecundarios = quest.objetivos_secundarios\n      .filter(os => os && typeof os.objetivo_id === 'string' && uuidRegex.test(os.objetivo_id.trim()) && objetivosValidos.has(os.objetivo_id.trim().toLowerCase()))\n      .map(os => ({ objetivo_id: os.objetivo_id.trim() }));\n  }\n  \n  // === REGRA FORÇADA: Quest do catálogo SEM sabotador = SEM objetivos secundários ===\n  if (catalogoId && !sabotadorId) {\n    objetivosSecundarios = []; // FORÇAR VAZIO\n  }\n  \n  questsFinais.push({\n    tipo: quest.tipo || 'catalogo',\n    catalogo_id: catalogoId,\n    titulo: quest.titulo,\n    descricao: quest.descricao,\n    base_cientifica: quest.base_cientifica || null,\n    contexto_origem: quest.contexto_origem,\n    prioridade: quest.prioridade || 'media',\n    recorrencia: quest.recorrencia || 'unica',\n    prazo_inicio: quest.prazo_inicio || null,\n    prazo_fim: quest.prazo_fim || null,\n    progresso_meta: quest.progresso_meta ?? 1,\n    status_inicial: quest.status_inicial || 'disponivel',\n    area_vida_id: areaVidaId,\n    sabotador_id: sabotadorId,\n    insight_id: insightId,\n    objetivo_id: objetivoId,\n    objetivos_secundarios: objetivosSecundarios,\n    complexidade: quest.complexidade ?? 0,\n    payload_extra: quest.payload_extra || {},\n    xp_recompensa: quest.xp_recompensa || 40\n  });\n  \n  dedupe.add(chave);\n  if (titulo) titulosUsados.add(titulo);\n  if (catalogoId) catalogoIdsUsados.add(catalogoId);\n}\n\nreturn [{\n  json: {\n    usuario_id: entrada.usuario_id || null,\n    novas_quests: questsFinais.slice(0, QUESTS_OBRIGATORIAS),\n    atualizacoes,\n    estado_inicial: entrada\n  }\n}];"
      },
      "id": "54435efb-4f97-440b-a19f-5a9bcbc21e77",
      "name": "Aplicar Limites & Dedupe",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        -112
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $items(\"Aplicar Limites & Dedupe\", 0, 0) || [];\nconst entrada = (data[0] || {}).json || {};\nconst retorno = $input.item.json || {};\n\nreturn [{\n  json: {\n    usuario_id: entrada.usuario_id,\n    quests_registradas: entrada.novas_quests,\n    atualizacoes_enviadas: entrada.atualizacoes,\n    gamificacao_retorno: retorno\n  }\n}];"
      },
      "id": "67b7356c-b9e7-4560-a0fc-5b2f92537072",
      "name": "Montar Saída",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1168,
        -112
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "bTeLj5qOKQo9PDMO",
          "mode": "list",
          "cachedResultUrl": "/workflow/bTeLj5qOKQo9PDMO",
          "cachedResultName": "sw_xp_quest"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $('start').item.json.usuario_id }}",
            "quests_personalizadas": "={{ JSON.stringify($json.novas_quests) }}",
            "atualizacoes_status": "={{ JSON.stringify($json.atualizacoes) }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "quests_personalizadas",
              "displayName": "quests_personalizadas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "atualizacoes_status",
              "displayName": "atualizacoes_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "765c396a-0093-4919-b247-ac6d4198662b",
      "name": "Calcula Xps quest",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        896,
        -112
      ]
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"quests\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"tipo\": {\"type\": \"string\"},\n          \"catalogo_id\": {\"type\": [\"string\", \"null\"]},\n          \"titulo\": {\"type\": \"string\"},\n          \"descricao\": {\"type\": \"string\"},\n          \"base_cientifica\": {\n            \"type\": [\"object\", \"null\"],\n            \"properties\": {\n              \"tipo\": {\"type\": \"string\"},\n              \"objetivo\": {\"type\": \"string\"},\n              \"fundamentos\": {\"type\": \"string\"},\n              \"como_aplicar\": {\"type\": \"string\"},\n              \"links_referencias\": {\"type\": \"array\", \"items\": {\"type\": \"string\"}}\n            }\n          },\n          \"contexto_origem\": {\"type\": \"string\"},\n          \"prioridade\": {\"type\": \"string\"},\n          \"recorrencia\": {\"type\": \"string\"},\n          \"prazo_inicio\": {\"type\": \"string\"},\n          \"prazo_fim\": {\"type\": \"string\"},\n          \"progresso_meta\": {\"type\": \"number\"},\n          \"area_vida_id\": {\"type\": \"string\"},\n          \"sabotador_id\": {\"type\": [\"string\", \"null\"]},\n          \"objetivo_id\": {\"type\": \"string\", \"description\": \"UUID do objetivo principal vinculado\"},\n          \"objetivos_secundarios\": {\n            \"type\": \"array\",\n            \"items\": {\n              \"type\": \"object\",\n              \"properties\": {\n                \"objetivo_id\": {\"type\": \"string\"}\n              },\n              \"required\": [\"objetivo_id\"]\n            },\n            \"description\": \"Array de objetivos secundarios impactados\"\n          },\n          \"complexidade\": {\"type\": \"number\"},\n          \"xp_recompensa\": {\"type\": \"number\"}\n        },\n        \"required\": [\"tipo\", \"titulo\", \"descricao\", \"contexto_origem\", \"prioridade\", \"recorrencia\", \"area_vida_id\", \"objetivo_id\", \"objetivos_secundarios\"]\n      }\n    }\n  },\n  \"required\": [\"quests\"]\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        272,
        176
      ],
      "id": "d8d3e9fb-e08d-4646-9adc-8e504c40f8bb",
      "name": "Parser Quests"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Query para buscar APENAS o sabotador mais ativo\n-- Baseado em quantidade de registros e intensidade média\n-- Sem filtro de período - considera todos os registros do usuário\n-- Ordena por: total_deteccoes DESC, conversas_afetadas DESC, intensidade_media DESC\n\nWITH sabotadores_agregados AS (\n  SELECT\n    us.sabotador_id,\n    COUNT(*) AS total_deteccoes,\n    COUNT(DISTINCT us.chat_id) AS conversas_afetadas,\n    AVG(us.intensidade_media) AS intensidade_media,\n    MAX(us.apelido_personalizado) AS apelido_personalizado,\n    MAX(us.contexto_principal) AS contexto_principal,\n    MAX(us.insight_atual) AS insight_atual,\n    MAX(us.contramedida_ativa) AS contramedida_ativa,\n    MAX(COALESCE(us.data_ultima_atividade, us.atualizado_em)) AS ultima_atualizacao\n  FROM public.usuarios_sabotadores us\n  WHERE us.usuario_id = $1::uuid\n  GROUP BY us.sabotador_id\n),\nsabotador_mais_ativo AS (\n  SELECT *\n  FROM sabotadores_agregados\n  ORDER BY \n    total_deteccoes DESC,\n    conversas_afetadas DESC,\n    intensidade_media DESC\n  LIMIT 1\n)\nSELECT json_build_object(\n  'sabotador_mais_ativo',\n  CASE \n    WHEN sma.sabotador_id IS NOT NULL THEN\n      json_build_object(\n        'sabotador_id', sma.sabotador_id\n      )\n    ELSE '[]'::json\n  END\n) AS sabotadores\nFROM sabotador_mais_ativo sma;\n",
        "options": {
          "queryReplacement": "={{ $('start').item.json.usuario_id }}"
        }
      },
      "id": "461f0af1-18f4-4232-8188-c1a560cda2bc",
      "name": "Buscar Sabotadores Ativo",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1152,
        -96
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "864d9ebe-fb91-4498-91fd-bb5855f5c087",
              "leftValue": "={{ $json.conversas.conversas_recentes[0].chat_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1664,
        -32
      ],
      "id": "8f189d45-4430-4a41-a7b9-ed193ad96baa",
      "name": "Não achou conversa?"
    },
    {
      "parameters": {
        "jsCode": "\nreturn [{\n  json: {\n    usuario_id: $('start').first().json.usuario_id,\n    quests_registradas: 0\n  }\n}];"
      },
      "id": "766dad68-4fb3-4a23-9b0a-9914c55a46ba",
      "name": "Montar Saída1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1344,
        192
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT json_build_object(\n  'objetivos_ativos',\n  COALESCE(json_agg(\n    json_build_object(\n      'id', uo.id,\n      'titulo', uo.titulo,\n      'detalhamento', uo.detalhamento,\n      'is_padrao', uo.is_padrao,\n      'area_vida', av.nome,\n      'area_codigo', av.codigo,\n      'prazo_dias', uo.prazo_dias,\n      'data_limite', uo.data_limite\n    )\n    ORDER BY uo.is_padrao DESC, uo.criado_em\n  ), '[]'::json)\n) AS objetivos\nFROM usuarios_objetivos uo\nJOIN areas_vida_catalogo av ON uo.area_vida_id = av.id\nWHERE uo.usuario_id = $1::uuid\n  AND uo.status = 'ativo';",
        "options": {
          "queryReplacement": "={{ [ $('Normalizar Entrada').item.json.usuario_id ] }}"
        }
      },
      "id": "f8a1b2c3-d4e5-6f7a-8b9c-0d1e2f3a4b5c",
      "name": "Buscar Objetivos Ativos",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1264,
        -96
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Normalizar Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Entrada": {
      "main": [
        [
          {
            "node": "Buscar Quests Ativas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Quests Ativas": {
      "main": [
        [
          {
            "node": "Buscar Conversas Recentes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Conversas Recentes": {
      "main": [
        [
          {
            "node": "Não achou conversa?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Agente Quests",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Parser Quests",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Interpretar Resultado": {
      "main": [
        [
          {
            "node": "Aplicar Limites & Dedupe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aplicar Limites & Dedupe": {
      "main": [
        [
          {
            "node": "Calcula Xps quest",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agente Quests": {
      "main": [
        [
          {
            "node": "Interpretar Resultado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcula Xps quest": {
      "main": [
        [
          {
            "node": "Montar Saída",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Montar Contexto": {
      "main": [
        [
          {
            "node": "Preparar Quest do Catálogo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Estágio Usuário": {
      "main": [
        [
          {
            "node": "Buscar Quests Catálogo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Quests Catálogo": {
      "main": [
        [
          {
            "node": "Montar Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Quest do Catálogo": {
      "main": [
        [
          {
            "node": "Agente Quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser Quests": {
      "ai_outputParser": [
        [
          {
            "node": "Agente Quests",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Listar Áreas da Vida": {
      "main": [
        [
          {
            "node": "Buscar Estágio Usuário",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Sabotadores Ativo": {
      "main": [
        [
          {
            "node": "Listar Áreas da Vida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Não achou conversa?": {
      "main": [
        [
          {
            "node": "Buscar Insights Recentes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Montar Saída1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Insights Recentes": {
      "main": [
        [
          {
            "node": "Buscar Objetivos Ativos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Objetivos Ativos": {
      "main": [
        [
          {
            "node": "Buscar Sabotadores Ativo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": {
    "start": [
      {
        "json": {
          "usuario_id": "0847d8a7-4fba-45f2-9470-a7eeacaa4bd4"
        }
      }
    ]
  },
  "versionId": "b146393a-c782-40a1-9dcd-9b0ce3c76f08",
  "versionCounter": 25,
  "triggerCount": 0,
  "shared": [
    {
      "createdAt": "2025-11-05T13:38:03.212Z",
      "role": "workflow:owner",
      "workflowId": "LKjU8NE9aNHw7kEh",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}
