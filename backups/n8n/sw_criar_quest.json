{
  "createdAt": "2025-11-05T13:38:03.212Z",
  "id": "LKjU8NE9aNHw7kEh",
  "name": "sw_criar_quest",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usuario_id"
            },
            {
              "name": "chat_id"
            }
          ]
        }
      },
      "id": "0a3494b9-4d16-4289-9e18-494214203ac7",
      "name": "start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        1712,
        608
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json || {};\n\nconst usuarioId = input.usuario_id;\nif (!usuarioId) {\n  throw new Error('usuario_id obrigatório');\n}\n\nreturn [{\n  json: {\n    usuario_id: usuarioId,\n    chat_id: input.chat_id || null\n  }\n}];"
      },
      "id": "e6f0a821-c0f7-4e5c-92c5-ac6380fca714",
      "name": "Normalizar Entrada",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1888,
        608
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Verifica limite de quests (v1.5.0 simplificado)\n-- REGRA: Máximo 15 quests ativas/disponíveis por usuário\nWITH quests_count AS (\n  SELECT COUNT(*) AS total_quests FROM usuarios_quest\n  WHERE usuario_id = $1::uuid AND status IN ('ativa', 'disponivel')\n),\nquests AS (\n  SELECT uq.id, uq.status, uq.catalogo_id, uq.sabotador_id,\n    COALESCE(uq.config->>'contexto_origem', '') AS contexto_origem,\n    COALESCE(uq.config->>'titulo', '') AS titulo,\n    uq.ativado_em, uq.config\n  FROM public.usuarios_quest uq\n  WHERE uq.usuario_id = $1::uuid AND uq.status IN ('disponivel', 'ativa')\n)\nSELECT \n  CASE \n    WHEN COALESCE((SELECT total_quests FROM quests_count), 0) >= 15 THEN 'limite_atingido'\n    ELSE 'pode_processar'\n  END AS status_processamento,\n  COALESCE((SELECT total_quests FROM quests_count), 0) AS total_quests_ativas,\n  json_build_object(\n    'quests_ativas', COALESCE((SELECT json_agg(json_build_object(\n      'id', quests.id, 'status', quests.status, 'catalogo_id', quests.catalogo_id,\n      'sabotador_id', quests.sabotador_id,\n      'contexto_origem', quests.contexto_origem, 'titulo', quests.titulo,\n      'criado_em', quests.ativado_em, 'config', quests.config\n    ) ORDER BY quests.ativado_em DESC) FROM quests), '[]'::json)\n  ) AS contexto;",
        "options": {
          "queryReplacement": "={{ [$('Normalizar Entrada').item.json.usuario_id, $('Normalizar Entrada').item.json.chat_id] }}"
        }
      },
      "id": "d154d294-c8bc-4943-9dd9-f054c4f6d7c1",
      "name": "Buscar Quests e Verificar Limite",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2080,
        608
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH ultimas AS (\n  SELECT\n    uc.id,\n    uc.session_id,\n    uc.data_conversa,\n    uc.resumo_conversa,\n    uc.tem_reflexao,\n    uc.total_palavras_usuario,\n    uc.criado_em\n  FROM public.usr_chat uc\n  WHERE uc.usuario_id = $1::uuid\n  ORDER BY uc.data_conversa DESC, uc.criado_em DESC\n  LIMIT 10\n)\nSELECT json_build_object(\n  'conversas_recentes',\n  COALESCE(json_agg(\n    json_build_object(\n      'chat_id', ultimas.id,\n      'session_id', ultimas.session_id,\n      'data_conversa', ultimas.data_conversa,\n      'resumo', ultimas.resumo_conversa,\n      'tem_reflexao', ultimas.tem_reflexao,\n      'total_palavras', ultimas.total_palavras_usuario\n    )\n    ORDER BY ultimas.data_conversa DESC, ultimas.criado_em DESC\n  ), '[]'::json)\n) AS conversas\nFROM ultimas;",
        "options": {
          "queryReplacement": "={{ $('Normalizar Entrada').first().json.usuario_id }}"
        }
      },
      "id": "18ab6a07-4888-45e9-b998-5151ea53be18",
      "name": "Buscar Conversas Recentes",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2272,
        608
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT json_build_object(\n  'areas_vida',\n  COALESCE(json_agg(\n    json_build_object(\n      'id', avc.id,\n      'codigo', avc.codigo,\n      'nome', avc.nome,\n      'descricao', avc.descricao\n    )\n    ORDER BY avc.nome ASC\n  ), '[]'::json)\n) AS areas\nFROM public.areas_vida_catalogo avc\nWHERE avc.ativo IS TRUE;",
        "options": {}
      },
      "id": "8a5b2cc0-bef4-4dd6-a521-a7bc3700a1a2",
      "name": "Listar Áreas da Vida",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3184,
        656
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT u.id, u.estagio_jornada FROM public.usuarios u WHERE u.id = $1::uuid;",
        "options": {
          "queryReplacement": "={{ [ $('Normalizar Entrada').item.json.usuario_id ] }}"
        }
      },
      "id": "652c367c-93c5-4514-b6d2-3ae43561ba0a",
      "name": "Buscar Estágio Usuário",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3392,
        656
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Query corrigida para o nó \"Buscar Quests Catálogo\"\n-- Permite quests de sabotador independentemente do nivel_prioridade\n\nWITH estagio_user AS (\n  SELECT estagio_jornada FROM public.usuarios WHERE id = $1::uuid\n)\nSELECT json_build_object(\n  'quests_catalogo',\n  COALESCE(json_agg(\n    json_build_object(\n      'id', qc.id,\n      'codigo', qc.codigo,\n      'titulo', qc.titulo,\n      'descricao', qc.descricao,\n      'categoria', qc.categoria,\n      'sabotador_id', qc.sabotador_id,\n      'base_cientifica', qc.base_cientifica,\n      'instrucoes', qc.instrucoes,\n      'tempo_estimado_min', qc.tempo_estimado_min,\n      'dificuldade', qc.dificuldade,\n      'nivel_prioridade', qc.nivel_prioridade,\n      'xp', qc.xp\n    )\n    ORDER BY \n      qc.dificuldade ASC,\n      qc.nivel_prioridade DESC\n  ), '[]'::json)\n) AS catalogo\nFROM public.quests_catalogo qc\nCROSS JOIN estagio_user eu\nWHERE qc.ativo IS TRUE\n  AND (\n    -- Excluir apenas reflexão (criada automaticamente) e categoria personalizada\n    qc.codigo != 'reflexao_diaria'\n    AND qc.categoria != 'personalizada'\n    AND (\n      -- Incluir quests de sabotador OU\n      qc.sabotador_id IS NOT NULL\n      OR\n      -- Incluir todas as outras categorias (TCC, Estoicismo, Essencial, Neurociência, Boa Prática, etc.)\n      (qc.categoria IS NOT NULL AND qc.sabotador_id IS NULL)\n    )\n  )\n  AND (\n    -- Quests de sabotador: ignorar nivel_prioridade (sempre disponíveis se dificuldade adequada)\n    (qc.sabotador_id IS NOT NULL AND (\n      (eu.estagio_jornada = 1 AND qc.dificuldade <= 2)\n      OR (eu.estagio_jornada = 2 AND qc.dificuldade >= 2 AND qc.dificuldade <= 3)\n      OR (eu.estagio_jornada = 3 AND qc.dificuldade >= 2)\n      OR (eu.estagio_jornada = 4)\n    ))\n    OR\n    -- Outras quests: aplicar filtro completo (incluindo nivel_prioridade)\n    (qc.sabotador_id IS NULL AND (\n      (eu.estagio_jornada = 1 AND qc.dificuldade <= 2 AND qc.nivel_prioridade >= 2)\n      OR (eu.estagio_jornada = 2 AND qc.dificuldade >= 2 AND qc.dificuldade <= 3)\n      OR (eu.estagio_jornada = 3 AND qc.dificuldade >= 2)\n      OR (eu.estagio_jornada = 4)\n    ))\n  );\n\n",
        "options": {
          "queryReplacement": "={{ [ $('Normalizar Entrada').item.json.usuario_id ] }}"
        }
      },
      "id": "fea47f02-61a4-48ad-a03d-531582415fdf",
      "name": "Buscar Quests Catálogo",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3568,
        656
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Montar Contexto v1.5.0 (simplificado)\nconst getJson = (nodeName) => {\n  const data = $items(nodeName, 0, 0) || [];\n  const item = data[0] || {};\n  return item.json || {};\n};\n\nconst getNested = (source, path, fallback = undefined) => {\n  return path.reduce((acc, key) => (acc && acc[key] !== undefined ? acc[key] : undefined), source) ?? fallback;\n};\n\nconst entrada = getJson(\"Normalizar Entrada\");\nconst verificacaoRaw = getJson(\"Buscar Quests e Verificar Limite\");\nconst conversasRaw = getJson(\"Buscar Conversas Recentes\");\nconst objetivosRaw = getJson(\"Buscar Objetivos Ativos\");\nconst sabotadoresRaw = getJson(\"Buscar Sabotadores Ativo\");\nconst areasRaw = getJson(\"Listar Áreas da Vida\");\nconst estagioRaw = getJson(\"Buscar Estágio Usuário\");\nconst catalogoRaw = getJson(\"Buscar Quests Catálogo\");\n\nconst quests = verificacaoRaw.contexto || {};\nconst questsAtivas = Array.isArray(quests.quests_ativas) ? quests.quests_ativas : [];\n\n// Lista de quests já criadas (para evitar duplicatas)\nconst questsJaCriadas = questsAtivas.map(q => ({\n  id: q.id,\n  titulo: q.titulo || q.config?.titulo || '',\n  catalogo_id: q.catalogo_id,\n  contexto_origem: q.contexto_origem || '',\n  status: q.status\n}));\n\n// IDs de catálogo já usados\nconst catalogoIdsJaUsados = new Set(\n  questsAtivas.filter(q => q.catalogo_id).map(q => q.catalogo_id)\n);\n\nconst estagioJornada = estagioRaw.estagio_jornada || 1;\n\nconst catalogoData = catalogoRaw.catalogo || {};\nconst questsCatalogo = Array.isArray(catalogoData.quests_catalogo) ? catalogoData.quests_catalogo : [];\n\n// Filtrar quests do catálogo (excluir sabotadores - são gerados do zero)\nconst questsCatalogoSemSabotador = questsCatalogo.filter(q => !q.sabotador_id);\nconst questsCatalogoNovas = questsCatalogoSemSabotador.filter(q => !catalogoIdsJaUsados.has(q.id));\nconst questsCatalogoUsadas = questsCatalogoSemSabotador.filter(q => catalogoIdsJaUsados.has(q.id));\n\n// === CONVERSAS ===\nconst conversas = conversasRaw.conversas || {};\nconst conversasRecentes = Array.isArray(conversas.conversas_recentes) ? conversas.conversas_recentes : [];\nconst chatIdFinal = entrada.chat_id || (conversasRecentes.length > 0 ? conversasRecentes[0].chat_id : null);\n\n// === SABOTADORES ===\nconst sabotadoresData = sabotadoresRaw.sabotadores?.sabotadores || sabotadoresRaw.sabotadores || {};\nconst top3Historicos = Array.isArray(sabotadoresData.top3_historicos) ? sabotadoresData.top3_historicos : [];\nconst sabotadorAtual = sabotadoresData.sabotador_atual || null;\n\n// Sabotador principal: ATUAL se existir, senão top 1 histórico\nlet sabotadorPrincipal = sabotadorAtual || (top3Historicos.length > 0 ? top3Historicos[0] : null);\n\n// === QUESTS DO CATÁLOGO POR CATEGORIA ===\nconst questsTCC = [\n  ...questsCatalogoNovas.filter(q => q.categoria === 'tcc'),\n  ...questsCatalogoUsadas.filter(q => q.categoria === 'tcc')\n];\n\nconst questsEstoicismo = [\n  ...questsCatalogoNovas.filter(q => q.categoria === 'estoicismo'),\n  ...questsCatalogoUsadas.filter(q => q.categoria === 'estoicismo')\n];\n\nconst areasVida = getNested(areasRaw, ['areas', 'areas_vida'], []);\nconst objetivosData = objetivosRaw.objetivos || {};\nconst objetivosAtivos = Array.isArray(objetivosData.objetivos_ativos) ? objetivosData.objetivos_ativos : [];\n\nreturn [{\n  json: {\n    usuario_id: entrada.usuario_id,\n    chat_id: chatIdFinal,\n    estagio_jornada: estagioJornada,\n    quests_ativas: questsAtivas.filter(q => q.status === 'pendente' || q.status === 'ativa'),\n    quests_ja_criadas: questsJaCriadas,\n    conversas_recentes: conversasRecentes,\n    \n    // Sabotadores\n    top3_historicos: top3Historicos,\n    sabotador_atual: sabotadorAtual,\n    sabotador_principal: sabotadorPrincipal,\n    tem_sabotador: sabotadorPrincipal !== null,\n    \n    areas_vida_disponiveis: areasVida,\n    objetivos_ativos: objetivosAtivos,\n    quests_catalogo: {\n      tcc: questsTCC,\n      estoicismo: questsEstoicismo,\n      todas: questsCatalogoSemSabotador,\n      novas: questsCatalogoNovas,\n      usadas: questsCatalogoUsadas\n    }\n  }\n}];"
      },
      "id": "7e2f7c12-c153-4cc3-ad6e-227f7c98ee54",
      "name": "Montar Contexto",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3744,
        656
      ]
    },
    {
      "parameters": {
        "jsCode": "// Preparar Quest do Catálogo v1.5.0 (simplificado)\nconst entrada = $input.item.json || {};\n\nconst questsCatalogo = entrada.quests_catalogo || {};\nconst questsJaCriadas = entrada.quests_ja_criadas || [];\n\n// IDs de catálogo já usados\nconst catalogoIdsUsados = new Set(\n  questsJaCriadas.filter(q => q.catalogo_id).map(q => q.catalogo_id)\n);\n\n// Função para escolher quest do catálogo (prioriza não usadas)\nconst escolherQuestCatalogo = (lista) => {\n  if (!Array.isArray(lista) || lista.length === 0) return null;\n  const novas = lista.filter(q => !catalogoIdsUsados.has(q.id));\n  return novas.length > 0 ? novas[0] : lista[0];\n};\n\n// Escolher quest TCC ou Estoicismo (prioridade: TCC > Estoicismo > outras)\nconst questsTCC = questsCatalogo.tcc || [];\nconst questsEstoicismo = questsCatalogo.estoicismo || [];\nconst todasQuests = questsCatalogo.todas || [];\n\nlet questTCCEstoicismo = escolherQuestCatalogo(questsTCC);\nif (!questTCCEstoicismo) questTCCEstoicismo = escolherQuestCatalogo(questsEstoicismo);\nif (!questTCCEstoicismo) {\n  const outras = todasQuests.filter(q => !q.sabotador_id && q.categoria !== 'personalizada' && q.codigo !== 'reflexao_diaria');\n  questTCCEstoicismo = escolherQuestCatalogo(outras);\n}\n\n// Conversas\nconst conversasRecentes = Array.isArray(entrada.conversas_recentes) ? entrada.conversas_recentes : [];\nconst conversaAtual = conversasRecentes.length > 0 \n  ? { data: conversasRecentes[0].data_conversa, resumo: conversasRecentes[0].resumo || '' }\n  : null;\nconst conversasHistorico = conversasRecentes.slice(1, 3).map(c => ({ data: c.data_conversa, resumo: c.resumo || '' }));\n\n// Títulos para anti-duplicação\nconst questsJaCriadasTitulos = questsJaCriadas.slice(0, 10).map(q => q.titulo || '').filter(t => t);\n\n// Objetivos\nconst objetivosAtivos = Array.isArray(entrada.objetivos_ativos) ? entrada.objetivos_ativos : [];\nconst objetivoPadrao = objetivosAtivos.find(o => o.is_padrao) || null;\nconst objetivosEspecificos = objetivosAtivos.filter(o => !o.is_padrao);\n\n// Áreas\nconst areasDisponiveis = (Array.isArray(entrada.areas_vida_disponiveis) ? entrada.areas_vida_disponiveis : [])\n  .map(a => ({ id: a.id, nome: a.nome })).filter(a => a.id && a.nome);\n\n// Quest TCC resumida\nconst questTCCResumida = questTCCEstoicismo ? {\n  catalogo_id: questTCCEstoicismo.id,\n  titulo: questTCCEstoicismo.titulo,\n  descricao: questTCCEstoicismo.descricao,\n  categoria: questTCCEstoicismo.categoria,\n  xp: questTCCEstoicismo.xp\n} : null;\n\nreturn [{\n  json: {\n    usuario_id: entrada.usuario_id,\n    chat_id: entrada.chat_id,\n    \n    conversa_atual: conversaAtual,\n    conversas_historico: conversasHistorico,\n    quests_ja_criadas_titulos: questsJaCriadasTitulos,\n    areas_disponiveis: areasDisponiveis,\n    \n    // Sabotadores\n    top3_historicos: entrada.top3_historicos || [],\n    sabotador_atual: entrada.sabotador_atual || null,\n    sabotador_principal: entrada.sabotador_principal || null,\n    \n    // Objetivos\n    objetivos_usuario: {\n      padrao: objetivoPadrao ? { id: objetivoPadrao.id, titulo: objetivoPadrao.titulo, area_vida: objetivoPadrao.area_vida } : null,\n      especificos: objetivosEspecificos.map(o => ({ id: o.id, titulo: o.titulo, area_vida: o.area_vida }))\n    },\n    \n    // Quest do catálogo escolhida\n    quests_catalogo_escolhidas: {\n      tcc_estoicismo_outras: questTCCResumida\n    }\n  }\n}];"
      },
      "id": "dcbe1e08-2025-41f2-9abd-7e9859a8672c",
      "name": "Preparar Quest do Catálogo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3968,
        656
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "31249015-39a8-4d84-ac7a-3a07c4a7a323",
      "name": "OpenRouter Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        4112,
        1040
      ],
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# User Prompt - Criar Quests\n\n<context>\n<!-- CONVERSA ATUAL (gatilho desta execução) -->\n<current_conversation>\n{{ JSON.stringify($json.conversa_atual || null) }}\n</current_conversation>\n\n<!-- HISTÓRICO (últimas 2 conversas) -->\n<history>\n{{ JSON.stringify($json.conversas_historico || []) }}\n</history>\n</context>\n\n<existing_quests>\n<!-- TÍTULOS JÁ CRIADOS - NÃO DUPLICAR -->\n{{ JSON.stringify($json.quests_ja_criadas_titulos || []) }}\n</existing_quests>\n\n<sabotadores>\n<!-- TOP 3 HISTÓRICOS -->\n{{ JSON.stringify($json.top3_historicos || []) }}\n\n<!-- PRINCIPAL (usar para quest 2) -->\n{{ JSON.stringify($json.sabotador_principal || null) }}\n\n<!-- SECUNDÁRIO (usar se criar_quest_adicional = true) -->\n{{ JSON.stringify($json.sabotador_secundario || null) }}\n\n<!-- FLAG: CRIAR 4ª QUEST? -->\ncriar_quest_adicional: {{ $json.criar_quest_adicional || false }}\n</sabotadores>\n\n<objetivos>\n<!-- PADRÃO (usar para sabotador e TCC) -->\n{{ JSON.stringify($json.objetivos_usuario?.padrao || null) }}\n\n<!-- ESPECÍFICOS (usar para personalizada se tema relacionado) -->\n{{ JSON.stringify($json.objetivos_usuario?.especificos || []) }}\n</objetivos>\n\n<areas>\n{{ JSON.stringify($json.areas_disponiveis || []) }}\n</areas>\n\n<catalogo>\n<!-- QUEST TCC PRÉ-SELECIONADA -->\n{{ JSON.stringify($json.quests_catalogo_escolhidas?.tcc_estoicismo_outras || null) }}\n</catalogo>\n\n<instructions>\nGERE EXATAMENTE {{ $json.criar_quest_adicional ? '4' : '3' }} QUESTS:\n\n1. **PERSONALIZADA** → baseada em <current_conversation>\n   - tipo: \"personalizada\"\n   - catalogo_id: null\n   - sabotador_id: null\n   - objetivo_id: ESPECÍFICO se tema trabalho/finanças/projeto\n\n2. **SABOTADOR** → baseada em sabotador_principal\n   - tipo: \"sabotador\"\n   - catalogo_id: null\n   - sabotador_id: COPIAR de sabotador_principal\n   - objetivo_id: PADRÃO\n   - USAR insight_atual e contramedida_ativa\n\n3. **TCC/CATÁLOGO** → adaptar de <catalogo>\n   - tipo: \"tcc\"\n   - catalogo_id: COPIAR de quest pré-selecionada\n   - objetivo_id: PADRÃO\n\n{{ $json.criar_quest_adicional ? '4. **SABOTADOR SECUNDÁRIO** → baseada em sabotador_secundario\\n   - tipo: \"sabotador\"\\n   - sabotador_id: COPIAR de sabotador_secundario' : '' }}\n\n⚠️ VERIFICAR <existing_quests> ANTES DE CRIAR - NÃO DUPLICAR TÍTULOS/TEMAS\n</instructions>\n\n",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=# System Prompt - Mentor MindQuest v3.1\n\n<role>\nVocê é o **Especialista em Criação de Quests** do MindQuest.\nSua função é transformar conversas em ações práticas e mensuráveis.\nVocê representa o **AGIR** no framework: CONVERSAR → ENTENDER → AGIR → EVOLUIR.\n</role>\n\n<objective>\nGerar quests personalizadas que:\n1. Conectem insights da conversa com ações concretas\n2. Combatam sabotadores identificados com contramedidas específicas\n3. Promovam evolução mensurável através de práticas baseadas em evidências\n\nSucesso = usuário tem 3-4 quests únicas, acionáveis e alinhadas ao contexto atual.\n</objective>\n\n<rules>\n<!-- REGRAS CRÍTICAS - NUNCA VIOLAR -->\n\n1. **QUANTIDADE**: Gerar exatamente 3 ou 4 quests\n   - Se `criar_quest_adicional = false` → 3 quests (1 personalizada + 1 sabotador + 1 TCC)\n   - Se `criar_quest_adicional = true` → 4 quests (1 personalizada + 2 sabotador + 1 TCC)\n\n2. **CAMPO \"tipo\"**: DEVE corresponder ao tipo real\n   - `\"personalizada\"` → quests do zero baseadas na conversa (sabotador_id = null)\n   - `\"sabotador\"` → quests de sabotador (sabotador_id OBRIGATÓRIO)\n   - `\"tcc\"` ou `\"catalogo\"` → quests do catálogo\n\n3. **ANTI-DUPLICAÇÃO**: Criar quests com CONTEXTOS ÚNICOS\n   - Verificar `quests_ja_criadas_titulos` antes de criar\n   - NUNCA repetir o mesmo verbo de ação + mesmo tema\n   - Variar abordagens mesmo para o mesmo sabotador\n\n4. **BASE CIENTÍFICA**: SEMPRE incluir `base_cientifica` completo\n\n5. **FERRAMENTAS**: NUNCA sugerir apps externos - usar apenas MindQuest\n</rules>\n\n<anti_duplication>\n<!-- REGRA CRÍTICA PARA EVITAR DUPLICAÇÕES -->\n\nAntes de criar cada quest, verifique:\n\n1. **Títulos existentes**: NÃO criar se título similar já existe\n2. **Mesmo sabotador**: PODE criar múltiplas quests para o mesmo sabotador SE:\n   - Contexto/situação diferente (ex: trabalho vs relacionamentos)\n   - Técnica/abordagem diferente (ex: respiração vs journaling)\n\n3. **Padrões a EVITAR** (exemplos de duplicação):\n   - ❌ \"Desafie o Sr. Esquivo com pequenos diálogos\" + \"Desafie o Sr. Esquivo com comunicação gradual\"\n   - ❌ \"Pratique respiração 4-7-8\" + \"Faça exercício de respiração consciente\"\n   - ❌ \"Reflexão sobre sonhos\" + \"Exploração dos sonhos para autoconhecimento\"\n\n4. **Padrões CORRETOS** (contextos diferentes):\n   - ✅ \"Desafie o Sr. Esquivo no trabalho com micro-apresentações\" + \"Desafie o Sr. Esquivo em casa expressando 1 sentimento\"\n   - ✅ \"Respiração 4-7-8 ao acordar\" + \"Journaling antes de dormir\"\n</anti_duplication>\n\n<quest_types>\n<!-- ESPECIFICAÇÕES POR TIPO -->\n\n## 1. PERSONALIZADA\n- `tipo`: \"personalizada\"\n- `catalogo_id`: null (usa QUEST_CUSTOM internamente)\n- `sabotador_id`: SEMPRE null\n- Criar do zero baseada na CONVERSA ATUAL\n- Foco em ações PRÁTICAS: trabalho, saúde, projetos, finanças\n- NÃO incluir questões emocionais (cobertas pelo sabotador)\n- `objetivo_id`: específico se tema relacionado, senão padrão\n\n## 2. SABOTADOR\n- `tipo`: \"sabotador\" (OBRIGATÓRIO!)\n- `catalogo_id`: null (gerada do zero)\n- `sabotador_id`: OBRIGATÓRIO (ex: \"critico\", \"inquieto\", \"esquivo\")\n- USAR `insight_atual` e `contramedida_ativa` do sabotador fornecido\n- Título: \"Desafie o Sr. [Nome] com [ação específica do contexto]\"\n- `contexto_origem`: \"sabotador_contextualizado\"\n- `objetivo_id`: SEMPRE o padrão\n\n## 3. TCC/CATÁLOGO\n- `tipo`: \"tcc\" ou \"catalogo\"\n- `catalogo_id`: MANTER o ID fornecido\n- Adaptar descrição ao contexto da conversa\n- `objetivo_id`: SEMPRE o padrão\n- `objetivos_secundarios`: SEMPRE [] (vazio)\n</quest_types>\n\n<workflow>\n<!-- PROCESSO DE CRIAÇÃO -->\n\nPara cada quest, siga este fluxo:\n\n1. **ANALISAR** conversa atual e histórico\n2. **VERIFICAR** títulos existentes em `quests_ja_criadas_titulos`\n3. **IDENTIFICAR** contexto único (situação, técnica, momento)\n4. **GERAR** quest com título distintivo\n5. **VALIDAR** que não há duplicação de tema+abordagem\n</workflow>\n\n<objective_rules>\n<!-- VINCULAÇÃO DE OBJETIVOS -->\n\n**Quest PERSONALIZADA:**\n- Se conversa menciona trabalho/app/negócio → objetivo com area_vida=\"Trabalho\"\n- Se conversa menciona finanças/BTC/investimento → objetivo com area_vida=\"Finanças\"\n- NUNCA usar objetivo PADRÃO se existir específico relacionado\n\n**Quest SABOTADOR e TCC:**\n- objetivo_id: SEMPRE o objetivo PADRÃO\n</objective_rules>\n\n<mindquest_features>\n<!-- MAPEAMENTO DE FUNCIONALIDADES -->\n\n| Necessidade do Usuário | Funcionalidade MindQuest |\n|------------------------|--------------------------|\n| Diário/Registro | Conversa com mentor |\n| Check-in emocional | Menu Conversar → Check-in |\n| Reflexão | Conversa diária/semanal |\n| Acompanhamento | Menu Entender → Dashboard |\n| Progresso | Menu Evoluir → Pontos |\n| Padrões | Menu Entender → Sabotadores - perfil BIG Five - emoções - humor e energia |\n</mindquest_features>\n\n<examples>\n<!-- EXEMPLOS DE QUESTS BEM FORMADAS -->\n\n<example name=\"quest_personalizada\">\nInput: Conversa sobre dificuldade em focar no trabalho do app\nOutput:\n{\n  \"tipo\": \"personalizada\",\n  \"catalogo_id\": null,\n  \"titulo\": \"Divida o desenvolvimento do App em blocos de 25 minutos\",\n  \"descricao\": \"Use a técnica Pomodoro para avançar no desenvolvimento do app. Escolha 1 tarefa específica e trabalhe focado por 25 minutos.\",\n  \"base_cientifica\": {\n    \"tipo\": \"personalizada\",\n    \"objetivo\": \"Aumentar produtividade através de foco intervalado\",\n    \"fundamentos\": \"A técnica Pomodoro, baseada em neurociência, otimiza atenção através de ciclos trabalho-descanso.\",\n    \"como_aplicar\": \"1. Abra o MindQuest e defina intenção. 2. Trabalhe 25min focado. 3. Registre progresso na conversa.\",\n    \"links_referencias\": []\n  },\n  \"contexto_origem\": \"conversa_especifica\",\n  \"prioridade\": \"alta\",\n  \"recorrencia\": \"diaria\",\n  \"objetivo_id\": \"uuid-objetivo-trabalho\",\n  \"sabotador_id\": null\n}\n</example>\n\n<example name=\"quest_sabotador_contexto_trabalho\">\nInput: Sabotador \"esquivo\" detectado, contexto de evitar reuniões\nOutput:\n{\n  \"tipo\": \"sabotador\",\n  \"catalogo_id\": null,\n  \"titulo\": \"Desafie o Sr. Esquivo participando ativamente em 1 reunião\",\n  \"descricao\": \"Baseado no insight: você tende a evitar exposição em grupo. Pratique contribuir com pelo menos 1 ideia em uma reunião hoje.\",\n  \"base_cientifica\": {\n    \"tipo\": \"sabotador\",\n    \"objetivo\": \"Reduzir comportamento de esquiva em contextos profissionais\",\n    \"fundamentos\": \"A exposição gradual, da TCC, reduz ansiedade através de enfrentamento controlado.\",\n    \"como_aplicar\": \"Prepare 1 ponto antes da reunião. Contribua nos primeiros 10 minutos. Registre como se sentiu no MindQuest.\",\n    \"links_referencias\": []\n  },\n  \"contexto_origem\": \"sabotador_contextualizado\",\n  \"sabotador_id\": \"esquivo\",\n  \"objetivo_id\": \"uuid-objetivo-padrao\"\n}\n</example>\n\n<example name=\"quest_sabotador_contexto_pessoal\">\nInput: Mesmo sabotador \"esquivo\", mas contexto de relacionamentos\nOutput:\n{\n  \"tipo\": \"sabotador\",\n  \"catalogo_id\": null,\n  \"titulo\": \"Desafie o Sr. Esquivo expressando 1 sentimento para alguém próximo\",\n  \"descricao\": \"Baseado no insight: você evita conversas emocionais. Pratique compartilhar como está se sentindo com uma pessoa de confiança.\",\n  \"base_cientifica\": {\n    \"tipo\": \"sabotador\",\n    \"objetivo\": \"Desenvolver vulnerabilidade emocional em relacionamentos\",\n    \"fundamentos\": \"A conexão emocional requer exposição gradual de vulnerabilidade (Brené Brown).\",\n    \"como_aplicar\": \"Escolha 1 pessoa. Compartilhe 1 emoção genuína. Observe a reação sem julgamento. Registre no MindQuest.\",\n    \"links_referencias\": []\n  },\n  \"contexto_origem\": \"sabotador_contextualizado\",\n  \"sabotador_id\": \"esquivo\",\n  \"objetivo_id\": \"uuid-objetivo-padrao\"\n}\n</example>\n</examples>\n\n<output_format>\n<!-- FORMATO DE SAÍDA OBRIGATÓRIO -->\n\nRetorne APENAS JSON válido:\n\n{\n  \"quests\": [\n    {\n      \"tipo\": \"personalizada|sabotador|tcc\",\n      \"catalogo_id\": \"uuid|null\",\n      \"titulo\": \"Título único e acionável (máx 60 chars)\",\n      \"descricao\": \"Descrição clara do que fazer\",\n      \"base_cientifica\": {\n        \"tipo\": \"string\",\n        \"objetivo\": \"Benefício claro\",\n        \"fundamentos\": \"Embasamento científico\",\n        \"como_aplicar\": \"Passos usando MindQuest\",\n        \"links_referencias\": []\n      },\n      \"contexto_origem\": \"conversa_especifica|sabotador_contextualizado|catalogo\",\n      \"prioridade\": \"alta|media|baixa\",\n      \"recorrencia\": \"diaria|semanal|unica\",\n      \"prazo_inicio\": \"YYYY-MM-DD\",\n      \"prazo_fim\": \"YYYY-MM-DD\",\n      \"progresso_meta\": 5,\n      \"area_vida_id\": \"uuid\",\n      \"sabotador_id\": \"string|null\",\n      \"objetivo_id\": \"uuid\",\n      \"objetivos_secundarios\": [],\n      \"complexidade\": 2,\n      \"xp_recompensa\": 40\n    }\n  ]\n}\n</output_format>\n\n<error_handling>\n- Se faltam dados de conversa: criar quest genérica de reflexão\n- Se sabotador_principal é null: pular quest de sabotador, criar 2 personalizadas\n- Se objetivo específico não existe: usar objetivo padrão\n- Se incerto sobre duplicação: variar verbo de ação e especificar contexto\n</error_handling>\n"
        }
      },
      "id": "af189331-81fb-4155-bf3f-57b6a0f336a6",
      "name": "Agente Quests",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        4224,
        656
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const getJson = (nodeName) => {\n  const data = $items(nodeName, 0, 0) || [];\n  const item = data[0] || {};\n  return item.json || {};\n};\n\n// Buscar contexto do nó \"Montar Contexto\" para ter insights_recentes completo\nconst contextoMontar = getJson(\"Montar Contexto\");\nconst contextoPreparar = getJson(\"Preparar Quest do Catálogo\");\n\nconst rawOutput = $json.output ?? { quests: [] };\nlet resultado;\nif (typeof rawOutput === 'string') {\n  try {\n    resultado = JSON.parse(rawOutput);\n  } catch (error) {\n    resultado = { quests: [] };\n  }\n} else if (rawOutput && typeof rawOutput === 'object') {\n  resultado = rawOutput;\n} else {\n  resultado = { quests: [] };\n}\n\nconst novasQuests = Array.isArray(resultado.quests) ? resultado.quests : [];\n\n// === CATALOGO_IDS PRÉ-SELECIONADOS (v1.3.17) ===\nconst questsEscolhidas = contextoPreparar.quests_catalogo_escolhidas || {};\nconst catalogoIdSabotadorPrincipal = questsEscolhidas.sabotador_principal?.catalogo_id || null;\nconst catalogoIdSabotadorSecundario = questsEscolhidas.sabotador_secundario?.catalogo_id || null;\nconst catalogoIdTCC = questsEscolhidas.tcc_estoicismo_outras?.catalogo_id || null;\n\n// === REPROCESSAMENTO (v1.3.19) ===\nconst isReprocessamento = contextoPreparar.is_reprocessamento || false;\nconst questsSubstituiveis = contextoPreparar.quests_substituiveis || {};\nconst totalPalavrasUsuario = contextoPreparar.total_palavras_usuario || 0;\n\nreturn [{\n  json: {\n    usuario_id: contextoPreparar.usuario_id,\n    chat_id: contextoPreparar.chat_id,\n    novas_quests_sugeridas: novasQuests,\n    atualizacoes_sugeridas: [],\n    sabotadores_recentes: contextoMontar.sabotadores_recentes || [],\n    insights_recentes: contextoMontar.insights_recentes || [],\n    areas_disponiveis: contextoPreparar.areas_disponiveis || [],\n    objetivos_disponiveis: contextoMontar.objetivos_ativos || [],\n    \n    // === REPROCESSAMENTO (v1.3.19) ===\n    is_reprocessamento: isReprocessamento,\n    quests_substituiveis: questsSubstituiveis,\n    total_palavras_usuario: totalPalavrasUsuario,\n    \n    // === NOVA ESTRUTURA SABOTADORES (v1.3.14) ===\n    top3_historicos: contextoPreparar.top3_historicos || [],\n    sabotador_atual: contextoPreparar.sabotador_atual || null,\n    sabotador_principal: contextoPreparar.sabotador_principal || null,\n    criar_quest_adicional: contextoPreparar.criar_quest_adicional || false,\n    \n    // === CATALOGO_IDS VÁLIDOS (v1.3.17) ===\n    catalogo_id_sabotador_principal: catalogoIdSabotadorPrincipal,\n    catalogo_id_sabotador_secundario: catalogoIdSabotadorSecundario,\n    catalogo_id_tcc: catalogoIdTCC\n  }\n}];"
      },
      "id": "0e2db5b4-427a-474d-85b9-c3ff500cf279",
      "name": "Interpretar Resultado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4576,
        656
      ]
    },
    {
      "parameters": {
        "jsCode": "// Aplicar Limites & Dedupe v1.5.0 (simplificado)\nconst entrada = ($input.item && $input.item.json) ? $input.item.json : {};\nconst questsJaCriadas = Array.isArray(entrada.quests_ja_criadas) ? entrada.quests_ja_criadas : [];\n\nconst MAX_QUESTS = 3; // 1 personalizada + 1 sabotador + 1 TCC\nconst QUEST_CUSTOM_CATALOGO_ID = '00000000-0000-0000-0000-000000000001';\nconst SABOTADORES_VALIDOS = new Set(['critico', 'insistente', 'prestativo', 'hiper_realizador', 'vitima', 'hiper_racional', 'hipervigilante', 'inquieto', 'controlador', 'esquivo']);\nconst uuidRegex = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;\n\n// Sets para anti-duplicação\nconst titulosUsados = new Set(questsJaCriadas.map(q => (q.titulo || '').toLowerCase().trim()).filter(Boolean));\nconst catalogoIdsUsados = new Set(questsJaCriadas.filter(q => q.catalogo_id && uuidRegex.test(q.catalogo_id)).map(q => q.catalogo_id));\n\n// Validação de áreas e objetivos\nconst areasValidas = new Set((Array.isArray(entrada.areas_disponiveis) ? entrada.areas_disponiveis : []).map(a => a?.id?.toLowerCase()).filter(Boolean));\nconst objetivosValidos = new Set((Array.isArray(entrada.objetivos_disponiveis) ? entrada.objetivos_disponiveis : []).map(o => o?.id?.toLowerCase()).filter(Boolean));\n\n// Função para verificar similaridade de títulos\nconst tituloSimilar = (t1, t2) => {\n  t1 = (t1 || '').toLowerCase().trim();\n  t2 = (t2 || '').toLowerCase().trim();\n  if (!t1 || !t2) return false;\n  const p1 = t1.split(/\\s+/), p2 = t2.split(/\\s+/);\n  const comuns = p1.filter(p => p2.includes(p));\n  return comuns.length / Math.max(p1.length, p2.length) >= 0.8 || t1.includes(t2) || t2.includes(t1);\n};\n\nconst candidatas = Array.isArray(entrada.novas_quests_sugeridas) ? entrada.novas_quests_sugeridas : [];\nconst questsPorTipo = { personalizada: null, sabotador: null, tcc_estoicismo: null };\n\nfor (const quest of candidatas) {\n  if (!quest || typeof quest !== 'object') continue;\n  \n  const titulo = (quest.titulo || '').toLowerCase().trim();\n  const contexto = (quest.contexto_origem || '').toLowerCase().trim();\n  if (!titulo) continue;\n  \n  // Anti-duplicação\n  if (titulosUsados.has(titulo)) continue;\n  let similar = false;\n  for (const t of titulosUsados) { if (tituloSimilar(titulo, t)) { similar = true; break; } }\n  if (similar) continue;\n  \n  // Validar sabotador_id\n  let sabotadorId = null;\n  if (quest.sabotador_id && typeof quest.sabotador_id === 'string') {\n    const s = quest.sabotador_id.trim().toLowerCase();\n    if (SABOTADORES_VALIDOS.has(s) || uuidRegex.test(quest.sabotador_id.trim())) sabotadorId = quest.sabotador_id.trim();\n  }\n  \n  const tipoQuest = (quest.tipo || '').toLowerCase();\n  const isSabotadorQuest = sabotadorId || tipoQuest === 'sabotador' || contexto.includes('sabotador');\n  \n  // Determinar catalogo_id\n  let catalogoId = null;\n  if (isSabotadorQuest) catalogoId = null;\n  else if (tipoQuest === 'personalizada' || !quest.catalogo_id) catalogoId = QUEST_CUSTOM_CATALOGO_ID;\n  else if (quest.catalogo_id && uuidRegex.test(quest.catalogo_id.trim())) {\n    catalogoId = quest.catalogo_id.trim();\n    if (catalogoIdsUsados.has(catalogoId) && catalogoId !== QUEST_CUSTOM_CATALOGO_ID) continue;\n  }\n  \n  // Determinar categoria\n  let tipoCategoria = 'personalizada';\n  if (isSabotadorQuest) tipoCategoria = 'sabotador';\n  else if (catalogoId === QUEST_CUSTOM_CATALOGO_ID || tipoQuest === 'personalizada') tipoCategoria = 'personalizada';\n  else if (contexto.includes('reflexao')) continue;\n  else if (catalogoId) tipoCategoria = 'tcc_estoicismo';\n  \n  let tipoFinal = tipoQuest;\n  if (isSabotadorQuest) tipoFinal = 'sabotador';\n  else if (!tipoFinal || tipoFinal === 'catalogo') tipoFinal = catalogoId === QUEST_CUSTOM_CATALOGO_ID ? 'personalizada' : 'tcc';\n  \n  let catalogoIdFinal = catalogoId;\n  if (tipoCategoria === 'personalizada' && !sabotadorId) catalogoIdFinal = QUEST_CUSTOM_CATALOGO_ID;\n  else if (tipoCategoria === 'sabotador') catalogoIdFinal = null;\n  \n  // Validar area_vida_id e objetivo_id\n  let areaVidaId = (quest.area_vida_id && uuidRegex.test(quest.area_vida_id) && areasValidas.has(quest.area_vida_id.toLowerCase())) ? quest.area_vida_id : null;\n  let objetivoId = (quest.objetivo_id && uuidRegex.test(quest.objetivo_id) && objetivosValidos.has(quest.objetivo_id.toLowerCase())) ? quest.objetivo_id : null;\n  \n  const questProcessada = {\n    tipo: tipoFinal,\n    catalogo_id: catalogoIdFinal,\n    titulo: quest.titulo,\n    descricao: quest.descricao,\n    base_cientifica: quest.base_cientifica || null,\n    contexto_origem: quest.contexto_origem,\n    prioridade: quest.prioridade || 'media',\n    recorrencia: quest.recorrencia || 'unica',\n    prazo_inicio: quest.prazo_inicio || null,\n    prazo_fim: quest.prazo_fim || null,\n    progresso_meta: quest.progresso_meta ?? 1,\n    status_inicial: quest.status_inicial || 'disponivel',\n    area_vida_id: areaVidaId,\n    sabotador_id: sabotadorId,\n    objetivo_id: objetivoId,\n    objetivos_secundarios: [],\n    complexidade: quest.complexidade ?? 0,\n    payload_extra: quest.payload_extra || {},\n    xp_recompensa: quest.xp_recompensa || 40\n  };\n  \n  // Distribuir por tipo (1 de cada)\n  if (tipoCategoria === 'personalizada' && !questsPorTipo.personalizada) questsPorTipo.personalizada = questProcessada;\n  else if (tipoCategoria === 'sabotador' && !questsPorTipo.sabotador) questsPorTipo.sabotador = questProcessada;\n  else if (tipoCategoria === 'tcc_estoicismo' && !questsPorTipo.tcc_estoicismo) questsPorTipo.tcc_estoicismo = questProcessada;\n  \n  titulosUsados.add(titulo);\n  if (catalogoIdFinal && catalogoIdFinal !== QUEST_CUSTOM_CATALOGO_ID) catalogoIdsUsados.add(catalogoIdFinal);\n}\n\nconst questsFinais = [questsPorTipo.personalizada, questsPorTipo.sabotador, questsPorTipo.tcc_estoicismo].filter(Boolean);\n\nreturn [{\n  json: {\n    usuario_id: entrada.usuario_id || null,\n    chat_id: entrada.chat_id || null,\n    novas_quests: questsFinais,\n    quests_para_substituir: [],\n    atualizacoes: []\n  }\n}];"
      },
      "id": "95839eaf-2a2f-4a1b-aac9-fa8551a50a7f",
      "name": "Aplicar Limites & Dedupe",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4784,
        656
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "bTeLj5qOKQo9PDMO",
          "mode": "list",
          "cachedResultUrl": "/workflow/bTeLj5qOKQo9PDMO",
          "cachedResultName": "sw_xp_quest"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $('start').first().json.usuario_id }}",
            "quests_personalizadas": "={{ JSON.stringify($json.novas_quests) }}",
            "atualizacoes_status": "={{ JSON.stringify($json.atualizacoes) }}",
            "quests_para_substituir": "={{ JSON.stringify($json.quests_para_substituir || []) }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "quests_personalizadas",
              "displayName": "quests_personalizadas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "atualizacoes_status",
              "displayName": "atualizacoes_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "quests_para_substituir",
              "displayName": "quests_para_substituir",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "fff78d2d-e0d7-441c-8d82-18daa13978e3",
      "name": "Calcula Xps quest",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        5008,
        656
      ]
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"quests\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"tipo\": {\"type\": \"string\"},\n          \"catalogo_id\": {\"type\": [\"string\", \"null\"]},\n          \"titulo\": {\"type\": \"string\"},\n          \"descricao\": {\"type\": \"string\"},\n          \"base_cientifica\": {\n            \"type\": [\"object\", \"null\"],\n            \"properties\": {\n              \"tipo\": {\"type\": \"string\"},\n              \"objetivo\": {\"type\": \"string\"},\n              \"fundamentos\": {\"type\": \"string\"},\n              \"como_aplicar\": {\"type\": \"string\"},\n              \"links_referencias\": {\"type\": \"array\", \"items\": {\"type\": \"string\"}}\n            }\n          },\n          \"contexto_origem\": {\"type\": \"string\"},\n          \"prioridade\": {\"type\": \"string\"},\n          \"recorrencia\": {\"type\": \"string\"},\n          \"prazo_inicio\": {\"type\": \"string\"},\n          \"prazo_fim\": {\"type\": \"string\"},\n          \"progresso_meta\": {\"type\": \"number\"},\n          \"area_vida_id\": {\"type\": \"string\"},\n          \"sabotador_id\": {\"type\": [\"string\", \"null\"]},\n          \"objetivo_id\": {\"type\": \"string\", \"description\": \"UUID do objetivo principal vinculado\"},\n          \"objetivos_secundarios\": {\n            \"type\": \"array\",\n            \"items\": {\n              \"type\": \"object\",\n              \"properties\": {\n                \"objetivo_id\": {\"type\": \"string\"}\n              },\n              \"required\": [\"objetivo_id\"]\n            },\n            \"description\": \"Array de objetivos secundarios impactados\"\n          },\n          \"complexidade\": {\"type\": \"number\"},\n          \"xp_recompensa\": {\"type\": \"number\"}\n        },\n        \"required\": [\"tipo\", \"titulo\", \"descricao\", \"contexto_origem\", \"prioridade\", \"recorrencia\", \"area_vida_id\", \"objetivo_id\", \"objetivos_secundarios\"]\n      }\n    }\n  },\n  \"required\": [\"quests\"]\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        4384,
        944
      ],
      "id": "360198ee-4ff3-45bb-b68b-602e0e246bc7",
      "name": "Parser Quests"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Buscar TOP 3 sabotadores históricos (com insight/contramedida MAIS RECENTE)\n-- + sabotador atual = data mais recente (DATE) + desempate por intensidade_media\n-- Regra: score = total_deteccoes * intensidade_media\n-- SEMPRE usar o contexto mais recente do sabotador\n\nWITH sabotadores_agregados AS (\n  SELECT\n    us.sabotador_id,\n    COUNT(*) AS total_deteccoes,\n    COUNT(DISTINCT us.chat_id) AS conversas_afetadas,\n    AVG(us.intensidade_media) AS intensidade_media,\n    (COUNT(*) * AVG(us.intensidade_media)) AS score\n  FROM public.usuarios_sabotadores us\n  WHERE us.usuario_id = $1::uuid\n  GROUP BY us.sabotador_id\n),\n-- Pegar insight/contramedida do registro MAIS RECENTE de cada sabotador\nsabotadores_recentes AS (\n  SELECT DISTINCT ON (us.sabotador_id)\n    us.sabotador_id,\n    us.insight_atual,\n    us.contramedida_ativa,\n    us.contexto_principal,\n    us.criado_em\n  FROM public.usuarios_sabotadores us\n  WHERE us.usuario_id = $1::uuid\n  ORDER BY us.sabotador_id, us.criado_em DESC\n),\ntop3_historicos AS (\n  SELECT \n    sa.sabotador_id,\n    sa.total_deteccoes,\n    sa.conversas_afetadas,\n    sa.intensidade_media,\n    sa.score,\n    sr.insight_atual,\n    sr.contramedida_ativa,\n    sr.contexto_principal\n  FROM sabotadores_agregados sa\n  LEFT JOIN sabotadores_recentes sr ON sr.sabotador_id = sa.sabotador_id\n  ORDER BY sa.score DESC, sa.total_deteccoes DESC, sa.conversas_afetadas DESC\n  LIMIT 3\n),\n-- SABOTADOR ATUAL: data mais recente (DATE sem horas) + desempate intensidade_media\nsabotador_atual AS (\n  SELECT DISTINCT ON (DATE(us.criado_em))\n    us.sabotador_id,\n    us.intensidade_media,\n    us.insight_atual,\n    us.contramedida_ativa,\n    us.contexto_principal,\n    DATE(us.criado_em) AS data_conversa\n  FROM public.usuarios_sabotadores us\n  WHERE us.usuario_id = $1::uuid\n  ORDER BY DATE(us.criado_em) DESC, us.intensidade_media DESC\n  LIMIT 1\n)\nSELECT json_build_object(\n  'sabotadores',\n  json_build_object(\n    'top3_historicos', COALESCE(\n      (SELECT json_agg(\n        json_build_object(\n          'sabotador_id', t.sabotador_id,\n          'total_deteccoes', t.total_deteccoes,\n          'conversas_afetadas', t.conversas_afetadas,\n          'intensidade_media', ROUND(t.intensidade_media::numeric, 2),\n          'insight_atual', t.insight_atual,\n          'contramedida_ativa', t.contramedida_ativa,\n          'contexto_principal', t.contexto_principal,\n          'score', ROUND(t.score::numeric, 2)\n        )\n      ) FROM top3_historicos t),\n      '[]'::json\n    ),\n    'sabotador_atual', (\n      SELECT json_build_object(\n        'sabotador_id', sa.sabotador_id,\n        'intensidade_media', ROUND(sa.intensidade_media::numeric, 2),\n        'insight_atual', sa.insight_atual,\n        'contramedida_ativa', sa.contramedida_ativa,\n        'contexto_principal', sa.contexto_principal,\n        'data_conversa', sa.data_conversa\n      )\n      FROM sabotador_atual sa\n      LIMIT 1\n    ),\n    'sabotador_mais_ativo', (\n      SELECT json_build_object(\n        'sabotador_id', t.sabotador_id,\n        'total_deteccoes', t.total_deteccoes,\n        'intensidade_media', ROUND(t.intensidade_media::numeric, 2),\n        'insight_atual', t.insight_atual,\n        'contramedida_ativa', t.contramedida_ativa\n      )\n      FROM top3_historicos t\n      LIMIT 1\n    )\n  )\n) AS sabotadores;",
        "options": {
          "queryReplacement": "={{ [ $('Normalizar Entrada').item.json.usuario_id ] }}"
        }
      },
      "id": "5253de0b-e013-49e0-8d91-93ea9f4d650e",
      "name": "Buscar Sabotadores Ativo",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2976,
        624
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Saída quando não pode processar (v1.3.19)\nconst verificacao = $('Buscar Quests e Verificar Limite').first().json;\nconst entrada = $('Normalizar Entrada').first().json;\n\nreturn [{\n  json: {\n    usuario_id: entrada.usuario_id,\n    quests_registradas: 0,\n    motivo: verificacao.status_processamento || 'sem_conversa',\n    total_quests_ativas: verificacao.total_quests_ativas || 0,\n    delta_palavras: verificacao.delta_palavras || 0,\n    is_reprocessamento: verificacao.is_reprocessamento || false\n  }\n}];"
      },
      "id": "7820843e-943a-470e-8b4f-907a54fc61b5",
      "name": "Saida Bloqueado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2752,
        864
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "proc1",
              "leftValue": "={{ $('Buscar Quests e Verificar Limite').first().json.status_processamento }}",
              "rightValue": "pode_processar",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "conv1",
              "leftValue": "={{ $json.conversas.conversas_recentes[0].chat_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2496,
        608
      ],
      "id": "ebfe26e8-b090-4439-b975-d57c10587ad7",
      "name": "Pode Processar?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT json_build_object(\n  'objetivos_ativos',\n  COALESCE(json_agg(\n    json_build_object(\n      'id', uo.id,\n      'titulo', uo.titulo,\n      'detalhamento', uo.detalhamento,\n      'is_padrao', uo.is_padrao,\n      'area_vida', av.nome,\n      'area_codigo', av.codigo,\n      'prazo_dias', uo.prazo_dias,\n      'data_limite', uo.data_limite\n    )\n    ORDER BY uo.is_padrao DESC, uo.criado_em\n  ), '[]'::json)\n) AS objetivos\nFROM usuarios_objetivos uo\nJOIN areas_vida_catalogo av ON uo.area_vida_id = av.id\nWHERE uo.usuario_id = $1::uuid\n  AND uo.status = 'ativo';",
        "options": {
          "queryReplacement": "={{ [ $('Normalizar Entrada').item.json.usuario_id ] }}"
        }
      },
      "id": "90c55ef2-8fb2-4278-a61f-d988061b841a",
      "name": "Buscar Objetivos Ativos",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2752,
        528
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Regras de Negócio: Conversas → Quests (v1.5.0)\n\n### REGRA ÚNICA\n**Máximo 15 quests ativas/disponíveis por usuário**\n\n---\n\n### Quantidade de Quests por Execução\n- **3 quests por execução:**\n\n1. Quest **personalizada** (baseada na conversa)\n2. Quest **sabotador** (baseada no sabotador principal)\n3. Quest **TCC/Estoicismo** (do catálogo)\n\n---\n\n### Limpeza (job externo)\nO job `sw_experts` **exclui quests do dia** antes de chamar este workflow.\n\nNão é necessário controle de reprocessamento aqui.\n\n---\n\n### Categorias do Catálogo\n- `tcc` (11 quests)\n- `estoicismo` (2 quests)\n- `boa_pratica_geral` (10 quests)\n- `contramedida_sabotador` (100 quests)\n- `essencial` (reflexão diária)\n",
        "height": 1056,
        "width": 624
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        864,
        80
      ],
      "id": "ff0da16b-f176-4c04-97f3-27a2d89c9a01",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "jsCode": "const data = $items(\"Aplicar Limites & Dedupe\", 0, 0) || [];\nconst entrada = (data[0] || {}).json || {};\nconst retorno = $input.item.json || {};\n\nreturn [{\n  json: {\n    usuario_id: entrada.usuario_id,\n    quests_registradas: entrada.novas_quests,\n    atualizacoes_enviadas: entrada.atualizacoes,\n    gamificacao_retorno: retorno\n  }\n}];"
      },
      "id": "1c041982-feb8-4d74-a866-81ca79a904a5",
      "name": "Montar Saída1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5504,
        656
      ]
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Normalizar Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Entrada": {
      "main": [
        [
          {
            "node": "Buscar Quests e Verificar Limite",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Quests e Verificar Limite": {
      "main": [
        [
          {
            "node": "Buscar Conversas Recentes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Conversas Recentes": {
      "main": [
        [
          {
            "node": "Pode Processar?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Agente Quests",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Parser Quests",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Interpretar Resultado": {
      "main": [
        [
          {
            "node": "Aplicar Limites & Dedupe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aplicar Limites & Dedupe": {
      "main": [
        [
          {
            "node": "Calcula Xps quest",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agente Quests": {
      "main": [
        [
          {
            "node": "Interpretar Resultado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcula Xps quest": {
      "main": [
        [
          {
            "node": "Montar Saída1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Montar Contexto": {
      "main": [
        [
          {
            "node": "Preparar Quest do Catálogo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Estágio Usuário": {
      "main": [
        [
          {
            "node": "Buscar Quests Catálogo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Quests Catálogo": {
      "main": [
        [
          {
            "node": "Montar Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Quest do Catálogo": {
      "main": [
        [
          {
            "node": "Agente Quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser Quests": {
      "ai_outputParser": [
        [
          {
            "node": "Agente Quests",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Listar Áreas da Vida": {
      "main": [
        [
          {
            "node": "Buscar Estágio Usuário",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Sabotadores Ativo": {
      "main": [
        [
          {
            "node": "Listar Áreas da Vida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pode Processar?": {
      "main": [
        [
          {
            "node": "Buscar Objetivos Ativos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Saida Bloqueado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Objetivos Ativos": {
      "main": [
        [
          {
            "node": "Buscar Sabotadores Ativo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": {
    "start": [
      {
        "json": {
          "usuario_id": "4bb8706a-7886-4ccb-8263-ff51aaafaafa",
          "chat_id": "c475f518-d1b4-4e51-ad78-0bdbacb4b32d"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "usuario_id": "4bb8706a-7886-4ccb-8263-ff51aaafaafa",
          "chat_id": "c475f518-d1b4-4e51-ad78-0bdbacb4b32d"
        },
        "pairedItem": {
          "item": 1
        }
      }
    ]
  },
  "activeVersionId": null,
  "shared": [
    {
      "createdAt": "2025-11-05T13:38:03.212Z",
      "role": "workflow:owner",
      "workflowId": "LKjU8NE9aNHw7kEh",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [],
  "activeVersion": null
}
