{
  "createdAt": "2025-11-05T13:38:03.212Z",
  "id": "LKjU8NE9aNHw7kEh",
  "name": "sw_criar_quest",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usuario_id"
            },
            {
              "name": "chat_id"
            }
          ]
        }
      },
      "id": "c43fc970-0850-46f6-975c-3996929c90f9",
      "name": "start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        720,
        224
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json || {};\n\nconst usuarioId = input.usuario_id;\nif (!usuarioId) {\n  throw new Error('usuario_id obrigat√≥rio');\n}\n\nreturn [{\n  json: {\n    usuario_id: usuarioId,\n    chat_id: input.chat_id || null\n  }\n}];"
      },
      "id": "15919d89-9c11-4278-b1ad-84b55447a7bc",
      "name": "Normalizar Entrada",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        224
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Verifica limite de quests + reprocessamento + substitu√≠veis (v1.4.1)\n-- REGRA CR√çTICA: M√°ximo 3 ou 4 quests por dia por usu√°rio\nWITH quests_count AS (\n  SELECT COUNT(*) AS total_quests FROM usuarios_quest\n  WHERE usuario_id = $1::uuid AND status IN ('ativa', 'disponivel')\n),\nquests_hoje AS (\n  SELECT \n    COUNT(*) AS total_hoje,\n    COUNT(*) FILTER (WHERE COALESCE(config->>'tipo', '') = 'sabotador' OR sabotador_id IS NOT NULL) AS sabotadores_hoje,\n    COUNT(*) FILTER (WHERE COALESCE(config->>'tipo', '') = 'personalizada' AND sabotador_id IS NULL) AS personalizadas_hoje,\n    COUNT(*) FILTER (WHERE catalogo_id IS NOT NULL AND catalogo_id != '00000000-0000-0000-0000-000000000001' AND sabotador_id IS NULL) AS catalogo_hoje\n  FROM usuarios_quest\n  WHERE usuario_id = $1::uuid \n    AND DATE(ativado_em) = CURRENT_DATE\n    AND status IN ('ativa', 'disponivel')\n),\nverificacao AS (\n  SELECT \n    COALESCE((SELECT total_quests FROM quests_count), 0) AS total_quests_ativas,\n    COALESCE((SELECT total_hoje FROM quests_hoje), 0) AS total_quests_hoje,\n    (SELECT total_hoje FROM quests_hoje) > 0 AS is_reprocessamento,\n    CASE \n      WHEN COALESCE((SELECT total_quests FROM quests_count), 0) >= 15 THEN 'limite_atingido'\n      WHEN COALESCE((SELECT total_hoje FROM quests_hoje), 0) >= 4 THEN 'limite_dia_atingido'\n      ELSE 'pode_processar'\n    END AS status_processamento\n),\nquests AS (\n  SELECT uq.id, uq.status, uq.catalogo_id, uq.sabotador_id,\n    COALESCE(uq.config->>'contexto_origem', '') AS contexto_origem,\n    COALESCE(uq.config->>'titulo', '') AS titulo,\n    COALESCE(uq.config->>'tipo', '') AS tipo,\n    uq.ativado_em, uq.config,\n    DATE(uq.ativado_em) = CURRENT_DATE AS is_hoje\n  FROM public.usuarios_quest uq\n  WHERE uq.usuario_id = $1::uuid AND uq.status IN ('disponivel', 'ativa')\n),\nquests_substituiveis AS (\n  SELECT q.* FROM quests q\n  WHERE q.is_hoje = TRUE AND q.status = 'disponivel'\n)\nSELECT \n  (SELECT status_processamento FROM verificacao) AS status_processamento,\n  (SELECT total_quests_ativas FROM verificacao) AS total_quests_ativas,\n  (SELECT total_quests_hoje FROM verificacao) AS total_quests_hoje,\n  (SELECT is_reprocessamento FROM verificacao) AS is_reprocessamento,\n  (SELECT sabotadores_hoje FROM quests_hoje) AS sabotadores_hoje,\n  (SELECT personalizadas_hoje FROM quests_hoje) AS personalizadas_hoje,\n  (SELECT catalogo_hoje FROM quests_hoje) AS catalogo_hoje,\n  json_build_object(\n    'quests_ativas', COALESCE((SELECT json_agg(json_build_object(\n      'id', quests.id, 'status', quests.status, 'catalogo_id', quests.catalogo_id,\n      'sabotador_id', quests.sabotador_id, 'tipo', quests.tipo,\n      'contexto_origem', quests.contexto_origem, 'titulo', quests.titulo,\n      'criado_em', quests.ativado_em, 'config', quests.config, 'is_hoje', quests.is_hoje\n    ) ORDER BY quests.ativado_em DESC) FROM quests), '[]'::json),\n    'quests_substituiveis', COALESCE((SELECT json_agg(json_build_object(\n      'id', qs.id, 'status', qs.status, 'catalogo_id', qs.catalogo_id,\n      'sabotador_id', qs.sabotador_id, 'tipo', qs.tipo,\n      'contexto_origem', qs.contexto_origem, 'titulo', qs.titulo\n    )) FROM quests_substituiveis qs), '[]'::json)\n  ) AS contexto;",
        "options": {
          "queryReplacement": "={{ [$('Normalizar Entrada').item.json.usuario_id, $('Normalizar Entrada').item.json.chat_id] }}"
        }
      },
      "id": "8e45dc1e-23c4-4123-8dd4-8bf5cabfc199",
      "name": "Buscar Quests e Verificar Limite",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1088,
        224
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH ultimas AS (\n  SELECT\n    uc.id,\n    uc.session_id,\n    uc.data_conversa,\n    uc.resumo_conversa,\n    uc.tem_reflexao,\n    uc.total_palavras_usuario,\n    uc.criado_em\n  FROM public.usr_chat uc\n  WHERE uc.usuario_id = $1::uuid\n  ORDER BY uc.data_conversa DESC, uc.criado_em DESC\n  LIMIT 10\n)\nSELECT json_build_object(\n  'conversas_recentes',\n  COALESCE(json_agg(\n    json_build_object(\n      'chat_id', ultimas.id,\n      'session_id', ultimas.session_id,\n      'data_conversa', ultimas.data_conversa,\n      'resumo', ultimas.resumo_conversa,\n      'tem_reflexao', ultimas.tem_reflexao,\n      'total_palavras', ultimas.total_palavras_usuario\n    )\n    ORDER BY ultimas.data_conversa DESC, ultimas.criado_em DESC\n  ), '[]'::json)\n) AS conversas\nFROM ultimas;",
        "options": {
          "queryReplacement": "={{ $('Normalizar Entrada').first().json.usuario_id }}"
        }
      },
      "id": "031743af-77d7-4156-b842-897fa36c240c",
      "name": "Buscar Conversas Recentes",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1280,
        224
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT json_build_object(\n  'areas_vida',\n  COALESCE(json_agg(\n    json_build_object(\n      'id', avc.id,\n      'codigo', avc.codigo,\n      'nome', avc.nome,\n      'descricao', avc.descricao\n    )\n    ORDER BY avc.nome ASC\n  ), '[]'::json)\n) AS areas\nFROM public.areas_vida_catalogo avc\nWHERE avc.ativo IS TRUE;",
        "options": {}
      },
      "id": "fe78930b-b147-4149-9783-e4aeacec0b4c",
      "name": "Listar √Åreas da Vida",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2192,
        272
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT u.id, u.estagio_jornada FROM public.usuarios u WHERE u.id = $1::uuid;",
        "options": {
          "queryReplacement": "={{ [ $('Normalizar Entrada').item.json.usuario_id ] }}"
        }
      },
      "id": "7839cc77-e9f3-4c1d-9a71-26b0c0536b08",
      "name": "Buscar Est√°gio Usu√°rio",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2400,
        272
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Query corrigida para o n√≥ \"Buscar Quests Cat√°logo\"\n-- Permite quests de sabotador independentemente do nivel_prioridade\n\nWITH estagio_user AS (\n  SELECT estagio_jornada FROM public.usuarios WHERE id = $1::uuid\n)\nSELECT json_build_object(\n  'quests_catalogo',\n  COALESCE(json_agg(\n    json_build_object(\n      'id', qc.id,\n      'codigo', qc.codigo,\n      'titulo', qc.titulo,\n      'descricao', qc.descricao,\n      'categoria', qc.categoria,\n      'sabotador_id', qc.sabotador_id,\n      'base_cientifica', qc.base_cientifica,\n      'instrucoes', qc.instrucoes,\n      'tempo_estimado_min', qc.tempo_estimado_min,\n      'dificuldade', qc.dificuldade,\n      'nivel_prioridade', qc.nivel_prioridade,\n      'xp', qc.xp\n    )\n    ORDER BY \n      qc.dificuldade ASC,\n      qc.nivel_prioridade DESC\n  ), '[]'::json)\n) AS catalogo\nFROM public.quests_catalogo qc\nCROSS JOIN estagio_user eu\nWHERE qc.ativo IS TRUE\n  AND (\n    -- Excluir apenas reflex√£o (criada automaticamente) e categoria personalizada\n    qc.codigo != 'reflexao_diaria'\n    AND qc.categoria != 'personalizada'\n    AND (\n      -- Incluir quests de sabotador OU\n      qc.sabotador_id IS NOT NULL\n      OR\n      -- Incluir todas as outras categorias (TCC, Estoicismo, Essencial, Neuroci√™ncia, Boa Pr√°tica, etc.)\n      (qc.categoria IS NOT NULL AND qc.sabotador_id IS NULL)\n    )\n  )\n  AND (\n    -- Quests de sabotador: ignorar nivel_prioridade (sempre dispon√≠veis se dificuldade adequada)\n    (qc.sabotador_id IS NOT NULL AND (\n      (eu.estagio_jornada = 1 AND qc.dificuldade <= 2)\n      OR (eu.estagio_jornada = 2 AND qc.dificuldade >= 2 AND qc.dificuldade <= 3)\n      OR (eu.estagio_jornada = 3 AND qc.dificuldade >= 2)\n      OR (eu.estagio_jornada = 4)\n    ))\n    OR\n    -- Outras quests: aplicar filtro completo (incluindo nivel_prioridade)\n    (qc.sabotador_id IS NULL AND (\n      (eu.estagio_jornada = 1 AND qc.dificuldade <= 2 AND qc.nivel_prioridade >= 2)\n      OR (eu.estagio_jornada = 2 AND qc.dificuldade >= 2 AND qc.dificuldade <= 3)\n      OR (eu.estagio_jornada = 3 AND qc.dificuldade >= 2)\n      OR (eu.estagio_jornada = 4)\n    ))\n  );\n\n",
        "options": {
          "queryReplacement": "={{ [ $('Normalizar Entrada').item.json.usuario_id ] }}"
        }
      },
      "id": "e0316a6d-ceca-4872-b043-21aca51fa6d4",
      "name": "Buscar Quests Cat√°logo",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2576,
        272
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const getJson = (nodeName) => {\n  const data = $items(nodeName, 0, 0) || [];\n  const item = data[0] || {};\n  return item.json || {};\n};\n\nconst getNested = (source, path, fallback = undefined) => {\n  return path.reduce((acc, key) => (acc && acc[key] !== undefined ? acc[key] : undefined), source) ?? fallback;\n};\n\nconst entrada = getJson(\"Normalizar Entrada\");\nconst verificacaoRaw = getJson(\"Buscar Quests e Verificar Limite\");\nconst questsRaw = verificacaoRaw;\n\nconst conversasRaw = getJson(\"Buscar Conversas Recentes\");\nconst objetivosRaw = getJson(\"Buscar Objetivos Ativos\");\nconst sabotadoresRaw = getJson(\"Buscar Sabotadores Ativo\");\nconst areasRaw = getJson(\"Listar √Åreas da Vida\");\nconst estagioRaw = getJson(\"Buscar Est√°gio Usu√°rio\");\nconst catalogoRaw = getJson(\"Buscar Quests Cat√°logo\");\n\nconst quests = questsRaw.contexto || {};\nconst questsAtivas = Array.isArray(quests.quests_ativas) ? quests.quests_ativas : [];\n\n// === REPROCESSAMENTO (v1.4.1) ===\nconst isReprocessamento = verificacaoRaw.is_reprocessamento === true;\nconst questsSubstituiveis = Array.isArray(quests.quests_substituiveis) ? quests.quests_substituiveis : [];\nconst totalPalavrasUsuario = verificacaoRaw.total_palavras_usuario || 0;\nconst totalQuestsHoje = verificacaoRaw.total_quests_hoje || 0;\nconst sabotadoresHoje = verificacaoRaw.sabotadores_hoje || 0;\nconst personalizadasHoje = verificacaoRaw.personalizadas_hoje || 0;\nconst catalogoHoje = verificacaoRaw.catalogo_hoje || 0;\n\n// Lista de quests j√° criadas (para evitar duplicatas)\nconst questsJaCriadas = questsAtivas.map(q => ({\n  id: q.id,\n  titulo: q.titulo || q.config?.titulo || '',\n  catalogo_id: q.catalogo_id,\n  contexto_origem: q.contexto_origem || '',\n  status: q.status,\n  concluido_em: q.concluido_em\n}));\n\n// IDs de cat√°logo j√° usados (para priorizar quests novas)\nconst catalogoIdsJaUsados = new Set(\n  questsAtivas\n    .filter(q => q.catalogo_id)\n    .map(q => q.catalogo_id)\n);\n\nconst estagioJornada = estagioRaw.estagio_jornada || 1;\n\nconst catalogoData = catalogoRaw.catalogo || {};\nconst questsCatalogo = Array.isArray(catalogoData.quests_catalogo) ? catalogoData.quests_catalogo : [];\n\n// Filtrar quests do cat√°logo: priorizar as que ainda n√£o foram usadas\n// EXCLUIR quests de sabotador do cat√°logo (v1.3.18 - sabotadores s√£o gerados do zero)\nconst questsCatalogoSemSabotador = questsCatalogo.filter(q => !q.sabotador_id);\nconst questsCatalogoNovas = questsCatalogoSemSabotador.filter(q => !catalogoIdsJaUsados.has(q.id));\nconst questsCatalogoUsadas = questsCatalogoSemSabotador.filter(q => catalogoIdsJaUsados.has(q.id));\n\n// === CONVERSAS RECENTES ===\nconst conversas = conversasRaw.conversas || {};\nconst conversasRecentes = Array.isArray(conversas.conversas_recentes) ? conversas.conversas_recentes : [];\n\n// === PEGAR chat_id DA CONVERSA MAIS RECENTE ===\nconst chatIdMaisRecente = conversasRecentes.length > 0 ? conversasRecentes[0].chat_id : null;\n// Se n√£o veio chat_id na entrada, usar o da conversa mais recente\nconst chatIdFinal = entrada.chat_id || chatIdMaisRecente;\n\n// === ESTRUTURA DE SABOTADORES (v1.3.18) ===\nconst sabotadoresData = sabotadoresRaw.sabotadores?.sabotadores || sabotadoresRaw.sabotadores || {};\nconst top3Historicos = Array.isArray(sabotadoresData.top3_historicos) ? sabotadoresData.top3_historicos : [];\nconst sabotadorAtual = sabotadoresData.sabotador_atual || null;\n\n// === L√ìGICA SIMPLIFICADA (v1.3.18) ===\n// REGRA: SEMPRE prioriza as informa√ß√µes do sabotador ATUAL\n// 1. Se atual est√° no top 3 ‚Üí usa o ATUAL (n√£o o top 1)\n// 2. Se atual N√ÉO est√° no top 3 E intensidade >= 60 ‚Üí cria quest adicional para o top 1\n\nconst top3Ids = top3Historicos.map(s => s.sabotador_id);\nconst sabotadorAtualId = sabotadorAtual?.sabotador_id || null;\nconst isAtualNoTop3 = sabotadorAtualId && top3Ids.includes(sabotadorAtualId);\nconst intensidadeAtual = sabotadorAtual?.intensidade_media || 0;\n\n// === SABOTADOR PRINCIPAL PARA QUEST ===\n// SEMPRE usa o sabotador ATUAL se existir (prioridade absoluta)\nlet sabotadorPrincipal = null;\nif (sabotadorAtual && sabotadorAtualId) {\n  // Sabotador atual existe ‚Üí usar ele (independente de estar no top 3)\n  sabotadorPrincipal = sabotadorAtual;\n} else if (top3Historicos.length > 0) {\n  // Sem sabotador atual ‚Üí usar o top 1 hist√≥rico\n  sabotadorPrincipal = top3Historicos[0];\n}\n\n// === QUEST ADICIONAL (v1.3.18) ===\n// Se atual N√ÉO est√° no top 3 E intensidade >= 60 ‚Üí criar quest adicional para o top 1 hist√≥rico\nconst criarQuestAdicional = !isAtualNoTop3 && sabotadorAtual && sabotadorAtualId && intensidadeAtual >= 60 && top3Historicos.length > 0;\n\n// Se criar quest adicional, o sabotador secund√°rio √© o top 1 hist√≥rico\nconst sabotadorSecundario = criarQuestAdicional ? top3Historicos[0] : null;\n\nconst temSabotadorParaQuest = sabotadorPrincipal !== null;\n\n// Buscar quests do cat√°logo por categoria (priorizando novas)\n// NOTA: N√£o incluir quests de sabotador do cat√°logo (v1.3.18)\nconst questReflexao = questsCatalogoNovas.find(q => q.codigo === 'reflexao_diaria') \n  || questsCatalogoUsadas.find(q => q.codigo === 'reflexao_diaria') \n  || null;\n\nconst questsTCC = [\n  ...questsCatalogoNovas.filter(q => q.categoria === 'tcc'),\n  ...questsCatalogoUsadas.filter(q => q.categoria === 'tcc')\n];\n\nconst questsEstoicismo = [\n  ...questsCatalogoNovas.filter(q => q.categoria === 'estoicismo'),\n  ...questsCatalogoUsadas.filter(q => q.categoria === 'estoicismo')\n];\n\nconst areasVida = getNested(areasRaw, ['areas', 'areas_vida'], []);\n\n// === OBJETIVOS DO USU√ÅRIO ===\nconst objetivosData = objetivosRaw.objetivos || {};\nconst objetivosAtivos = Array.isArray(objetivosData.objetivos_ativos) ? objetivosData.objetivos_ativos : [];\n\nreturn [{\n  json: {\n    usuario_id: entrada.usuario_id,\n    chat_id: chatIdFinal,\n    estagio_jornada: estagioJornada,\n    quests_ativas: questsAtivas.filter(q => q.status === 'pendente' || q.status === 'ativa'),\n    quests_ja_criadas: questsJaCriadas,\n    conversas_recentes: conversasRecentes,\n    \n    // === REPROCESSAMENTO (v1.4.1) ===\n    is_reprocessamento: isReprocessamento,\n    quests_substituiveis: questsSubstituiveis,\n    total_palavras_usuario: totalPalavrasUsuario,\n    total_quests_hoje: totalQuestsHoje,\n    sabotadores_hoje: sabotadoresHoje,\n    personalizadas_hoje: personalizadasHoje,\n    catalogo_hoje: catalogoHoje,\n    \n    // === ESTRUTURA SABOTADORES (v1.3.18) ===\n    top3_historicos: top3Historicos,\n    sabotador_atual: sabotadorAtual,\n    sabotador_principal: sabotadorPrincipal,\n    sabotador_secundario: sabotadorSecundario,\n    criar_quest_adicional: criarQuestAdicional,\n    tem_sabotador: temSabotadorParaQuest,\n    is_atual_no_top3: isAtualNoTop3,\n    \n    areas_vida_disponiveis: areasVida,\n    objetivos_ativos: objetivosAtivos,\n    quests_catalogo: {\n      reflexao: questReflexao,\n      // REMOVIDO: sabotador (v1.3.18 - quests de sabotador s√£o geradas do zero)\n      tcc: questsTCC,\n      estoicismo: questsEstoicismo,\n      todas: questsCatalogoSemSabotador,\n      novas: questsCatalogoNovas,\n      usadas: questsCatalogoUsadas\n    }\n  }\n}];"
      },
      "id": "4fbd488b-7f00-4061-958d-c34846cb34cf",
      "name": "Montar Contexto",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2752,
        272
      ]
    },
    {
      "parameters": {
        "jsCode": "const entrada = $input.item.json || {};\n\n// === REPROCESSAMENTO (v1.4.1) ===\nconst isReprocessamento = entrada.is_reprocessamento === true;\nconst questsSubstituiveis = entrada.quests_substituiveis || [];\nconst totalPalavrasUsuario = entrada.total_palavras_usuario || 0;\nconst totalQuestsHoje = entrada.total_quests_hoje || 0;\nconst sabotadoresHoje = entrada.sabotadores_hoje || 0;\nconst personalizadasHoje = entrada.personalizadas_hoje || 0;\nconst catalogoHoje = entrada.catalogo_hoje || 0;\n\n// Identificar quests substitu√≠veis por tipo\nconst questPersonalizadaSubstituivel = questsSubstituiveis.find(q => \n  q.tipo === 'personalizada' || \n  (q.contexto_origem && q.contexto_origem.includes('conversa'))\n) || null;\n\nconst questSabotadorSubstituivel = questsSubstituiveis.find(q => \n  q.tipo === 'sabotador' || q.sabotador_id\n) || null;\n\n// === ESTRUTURA SABOTADORES (v1.3.18) ===\nconst top3Historicos = entrada.top3_historicos || [];\nconst sabotadorAtual = entrada.sabotador_atual || null;\nconst sabotadorPrincipal = entrada.sabotador_principal || null;\nconst sabotadorSecundario = entrada.sabotador_secundario || null;\nconst criarQuestAdicional = entrada.criar_quest_adicional || false;\n\nconst questsCatalogo = entrada.quests_catalogo || {};\nconst questsJaCriadas = entrada.quests_ja_criadas || [];\n\n// IDs de cat√°logo j√° usados\nconst catalogoIdsUsados = new Set(\n  questsJaCriadas\n    .filter(q => q.catalogo_id)\n    .map(q => q.catalogo_id)\n);\n\n// Fun√ß√£o gen√©rica para escolher quest do cat√°logo\nconst escolherQuestCatalogo = (lista, priorizarNovas = true) => {\n  if (!Array.isArray(lista) || lista.length === 0) return null;\n  \n  const novas = lista.filter(q => !catalogoIdsUsados.has(q.id));\n  const usadas = lista.filter(q => catalogoIdsUsados.has(q.id));\n  \n  const candidatas = priorizarNovas && novas.length > 0 ? novas : (usadas.length > 0 ? usadas : lista);\n  \n  return candidatas.length > 0 ? candidatas[0] : null;\n};\n\n// === v1.3.18: QUESTS DE SABOTADOR S√ÉO GERADAS DO ZERO ===\n// N√£o usar cat√°logo para sabotadores - usar insight_atual e contramedida_ativa\n// O agente vai gerar a quest baseada no contexto espec√≠fico\n\n// Escolher quest TCC, Estoicismo ou outras categorias (SEMPRE necess√°rio)\nconst todasQuests = questsCatalogo.todas || [];\nconst questsTCCEstoicismoOutras = todasQuests.filter(q => {\n  if (q.sabotador_id) return false; // Excluir quests de sabotador\n  if (q.codigo === 'reflexao_diaria') return false;\n  return q.categoria && q.categoria !== 'personalizada';\n});\n\nconst questTCCEstoicismoOutras = escolherQuestCatalogo(questsTCCEstoicismoOutras, true);\n\n// Garantir que conversas_recentes seja array\nconst conversasRecentes = Array.isArray(entrada.conversas_recentes) \n  ? entrada.conversas_recentes \n  : [];\n\n// === SEPARAR CONVERSA ATUAL DO HIST√ìRICO ===\nconst conversaAtual = conversasRecentes.length > 0 \n  ? {\n      data: conversasRecentes[0].data_conversa || conversasRecentes[0].data || null,\n      resumo: conversasRecentes[0].resumo || conversasRecentes[0].resumo_conversa || ''\n    }\n  : null;\n\nconst conversasHistorico = conversasRecentes\n  .slice(1, 3)\n  .map(c => ({\n    data: c.data_conversa || c.data || null,\n    resumo: c.resumo || c.resumo_conversa || ''\n  }))\n  .filter(c => c.data && c.resumo);\n\n// === QUESTS J√Å CRIADAS (t√≠tulos para evitar duplica√ß√£o) ===\nconst questsJaCriadasTitulos = questsJaCriadas\n  .slice(0, 10)\n  .map(q => q.titulo || q.config?.titulo || '')\n  .filter(t => t && t.trim() !== '');\n\n// === OBJETIVOS DO USU√ÅRIO ===\nconst objetivosAtivos = Array.isArray(entrada.objetivos_ativos) ? entrada.objetivos_ativos : [];\nconst objetivoPadrao = objetivosAtivos.find(o => o.is_padrao) || null;\nconst objetivosEspecificos = objetivosAtivos.filter(o => !o.is_padrao);\n\n// === √ÅREAS DA VIDA (apenas id e nome) ===\nconst areasDisponiveis = (Array.isArray(entrada.areas_vida_disponiveis) ? entrada.areas_vida_disponiveis : [])\n  .map(a => ({ id: a.id || null, nome: a.nome || '' }))\n  .filter(a => a.id && a.nome);\n\n// === QUEST TCC RESUMIDA ===\nconst questTCCResumida = questTCCEstoicismoOutras ? {\n  catalogo_id: questTCCEstoicismoOutras.id,\n  titulo: questTCCEstoicismoOutras.titulo,\n  descricao: questTCCEstoicismoOutras.descricao,\n  categoria: questTCCEstoicismoOutras.categoria,\n  xp: questTCCEstoicismoOutras.xp\n} : null;\n\n// Preparar contexto limpo para o agente\nreturn [{\n  json: {\n    usuario_id: entrada.usuario_id,\n    chat_id: entrada.chat_id,\n    \n    // === REPROCESSAMENTO (v1.4.1) ===\n    is_reprocessamento: isReprocessamento,\n    total_palavras_usuario: totalPalavrasUsuario,\n    total_quests_hoje: totalQuestsHoje,\n    sabotadores_hoje: sabotadoresHoje,\n    personalizadas_hoje: personalizadasHoje,\n    catalogo_hoje: catalogoHoje,\n    quests_substituiveis: {\n      personalizada: questPersonalizadaSubstituivel,\n      sabotador: questSabotadorSubstituivel\n    },\n    \n    // === CONVERSAS ===\n    conversa_atual: conversaAtual,\n    conversas_historico: conversasHistorico,\n    \n    // === ANTI-DUPLICA√á√ÉO ===\n    quests_ja_criadas_titulos: questsJaCriadasTitulos,\n    \n    // === √ÅREAS ===\n    areas_disponiveis: areasDisponiveis,\n    \n    // === ESTRUTURA SABOTADORES (v1.3.18) ===\n    // Sabotadores com insight/contramedida para o agente gerar quest do zero\n    top3_historicos: top3Historicos,\n    sabotador_atual: sabotadorAtual,\n    sabotador_principal: sabotadorPrincipal,\n    sabotador_secundario: sabotadorSecundario,\n    criar_quest_adicional: criarQuestAdicional,\n    \n    // === OBJETIVOS ===\n    objetivos_usuario: {\n      padrao: objetivoPadrao ? {\n        id: objetivoPadrao.id,\n        titulo: objetivoPadrao.titulo,\n        area_vida: objetivoPadrao.area_vida\n      } : null,\n      especificos: objetivosEspecificos.map(o => ({\n        id: o.id,\n        titulo: o.titulo,\n        area_vida: o.area_vida\n      }))\n    },\n    \n    // === QUESTS DO CAT√ÅLOGO (v1.3.18) ===\n    // REMOVIDO: sabotador_principal e sabotador_secundario do cat√°logo\n    // Quests de sabotador s√£o geradas do zero pelo agente\n    quests_catalogo_escolhidas: {\n      tcc_estoicismo_outras: questTCCResumida\n    }\n  }\n}];"
      },
      "id": "a7e4cb22-d212-4156-a4e0-b0c25556fe06",
      "name": "Preparar Quest do Cat√°logo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2976,
        272
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "e3f08851-426b-4011-bba2-f9699051c938",
      "name": "OpenRouter Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        3120,
        656
      ],
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=== CONTEXTO DO USU√ÅRIO ===\n\n**CONVERSA ATUAL (gatilho desta execu√ß√£o):**\n{{ JSON.stringify($json.conversa_atual || null) }}\n\n**HIST√ìRICO RECENTE (√∫ltimas 2 conversas):**\n{{ JSON.stringify($json.conversas_historico || []) }}\n\n**QUESTS J√Å EXISTENTES (EVITAR T√çTULOS SIMILARES):**\n{{ JSON.stringify($json.quests_ja_criadas_titulos || []) }}\n\n=== SABOTADORES (v1.3.18) ===\n**Top 3 Hist√≥ricos:** {{ JSON.stringify($json.top3_historicos || []) }}\n**Sabotador Principal (prioridade):** {{ JSON.stringify($json.sabotador_principal || null) }}\n**Sabotador Secund√°rio (se adicional):** {{ JSON.stringify($json.sabotador_secundario || null) }}\n**Criar Quest Adicional:** {{ $json.criar_quest_adicional || false }}\n\n=== OBJETIVOS DO USU√ÅRIO ===\n**Objetivo Padr√£o:** {{ JSON.stringify($json.objetivos_usuario?.padrao || null) }}\n**Objetivos Espec√≠ficos:** {{ JSON.stringify($json.objetivos_usuario?.especificos || []) }}\n\n=== √ÅREAS DISPON√çVEIS ===\n{{ JSON.stringify($json.areas_disponiveis || []) }}\n\n=== QUESTS DO CAT√ÅLOGO ===\n**Quest TCC/Outras:** {{ JSON.stringify($json.quests_catalogo_escolhidas?.tcc_estoicismo_outras || null) }}\n\n=== GERAR QUESTS ===\n\n**1. Quest PERSONALIZADA** (criar do zero)\n- Baseada na CONVERSA ATUAL\n- `tipo`: \"personalizada\"\n- `catalogo_id`: null\n- `objetivo_id`: üö® OBRIGAT√ìRIO usar ID de objetivo ESPEC√çFICO se conversa mencionar trabalho/app/neg√≥cio/finan√ßas/BTC/projeto/renda\n- `objetivos_secundarios`: adicionar outros objetivos espec√≠ficos impactados (se houver)\n\n**2. Quest SABOTADOR** (CRIAR DO ZERO - N√ÉO USAR CAT√ÅLOGO)\n- üö® OBRIGAT√ìRIO: `tipo`: \"sabotador\" (NUNCA usar \"personalizada\")\n- üö® OBRIGAT√ìRIO: Usar `insight_atual` e `contramedida_ativa` do `sabotador_principal`\n- `catalogo_id`: null (quest personalizada de sabotador)\n- `sabotador_id`: USAR o `sabotador_id` do sabotador_principal\n- `objetivo_id`: SEMPRE o objetivo PADR√ÉO\n- `contexto_origem`: \"sabotador_contextualizado\"\n\n**3. Quest TCC/OUTRAS** (adaptar do cat√°logo)\n- `tipo`: \"tcc\" ou \"catalogo\"\n- Usar `catalogo_id` da quest pr√©-selecionada\n- `objetivo_id`: SEMPRE o objetivo PADR√ÉO\n- `objetivos_secundarios`: [] (SEMPRE VAZIO)\n\n**4. Quest SABOTADOR SECUND√ÅRIO** (S√ì SE criar_quest_adicional = true)\n- `tipo`: \"sabotador\"\n- Usar `insight_atual` e `contramedida_ativa` do `sabotador_secundario`\n- `catalogo_id`: null\n- `sabotador_id`: USAR o `sabotador_id` do sabotador_secundario\n\n=== FORMATO DE SA√çDA ===\nJSON v√°lido:\n```json\n{\"quests\":[\n  {\n    \"tipo\": \"personalizada\",\n    \"catalogo_id\": null,\n    \"titulo\": \"T√≠tulo engajador\",\n    \"descricao\": \"Descri√ß√£o clara\",\n    \"base_cientifica\": {\n      \"tipo\": \"personalizada\",\n      \"objetivo\": \"Benef√≠cio para o usu√°rio\",\n      \"fundamentos\": \"Embasamento cient√≠fico\",\n      \"como_aplicar\": \"Passos usando MindQuest\",\n      \"links_referencias\": []\n    },\n    \"contexto_origem\": \"conversa_especifica\",\n    \"prioridade\": \"alta|media|baixa\",\n    \"recorrencia\": \"diaria|semanal|unica\",\n    \"prazo_inicio\": \"YYYY-MM-DD\",\n    \"prazo_fim\": \"YYYY-MM-DD\",\n    \"progresso_meta\": 5,\n    \"area_vida_id\": \"uuid-da-area\",\n    \"sabotador_id\": null,\n    \"objetivo_id\": \"uuid-objetivo\",\n    \"objetivos_secundarios\": [],\n    \"complexidade\": 2,\n    \"xp_recompensa\": 40\n  },\n  {\n    \"tipo\": \"sabotador\",\n    \"catalogo_id\": null,\n    \"titulo\": \"Desafie o Sr. [Nome] com [a√ß√£o]\",\n    \"descricao\": \"Baseado no insight: [insight_atual]. Pratique [contramedida_ativa].\",\n    \"base_cientifica\": {\n      \"tipo\": \"sabotador\",\n      \"objetivo\": \"Reduzir influ√™ncia do sabotador\",\n      \"fundamentos\": \"Psicologia Positiva e TCC\",\n      \"como_aplicar\": \"[contramedida_ativa]. No MindQuest...\",\n      \"links_referencias\": []\n    },\n    \"contexto_origem\": \"sabotador_contextualizado\",\n    \"prioridade\": \"alta\",\n    \"recorrencia\": \"diaria\",\n    \"prazo_inicio\": \"YYYY-MM-DD\",\n    \"prazo_fim\": \"YYYY-MM-DD\",\n    \"progresso_meta\": 7,\n    \"area_vida_id\": \"uuid-da-area\",\n    \"sabotador_id\": \"id_do_sabotador\",\n    \"objetivo_id\": \"uuid-objetivo-padrao\",\n    \"objetivos_secundarios\": [],\n    \"complexidade\": 3,\n    \"xp_recompensa\": 50\n  }\n]}\n```",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "Voc√™ √© o **Especialista em Cria√ß√£o de Quests** do MindQuest.\n\n=== SUA MISS√ÉO ===\nTransformar conversas em a√ß√µes pr√°ticas. Voc√™ √© o cora√ß√£o do **AGIR** no framework CONVERSAR ‚Üí ENTENDER ‚Üí AGIR ‚Üí EVOLUIR.\n\n=== REGRAS OBRIGAT√ìRIAS ===\n\n1. **Gerar 3 ou 4 quests** dependendo de `criar_quest_adicional`:\n   - Se `criar_quest_adicional = false`: 3 quests (1 personalizada + 1 sabotador + 1 TCC)\n   - Se `criar_quest_adicional = true`: 4 quests (1 personalizada + 2 sabotador + 1 TCC)\n2. **SEMPRE incluir `base_cientifica`** completo em cada quest\n3. **NUNCA criar t√≠tulos similares** aos j√° existentes\n4. **NUNCA sugerir ferramentas externas** - usar sempre MindQuest\n5. **SEMPRE usar nomes originais dos sabotadores** (Ex: Sr. Perfeccionista, Sr. Inquieto)\n\nüö®üö®üö® REGRA CR√çTICA - CAMPO \"tipo\" üö®üö®üö®\n\nO campo \"tipo\" DEVE corresponder ao tipo real da quest:\n- \"personalizada\" ‚Üí quests criadas do zero baseadas na conversa (SEM sabotador_id)\n- \"sabotador\" ‚Üí quests de sabotador (OBRIGAT√ìRIO se sabotador_id existir)\n- \"tcc\" ou \"catalogo\" ‚Üí quests do cat√°logo TCC/Estoicismo/outras\n\n‚ö†Ô∏è NUNCA usar tipo=\"personalizada\" para quest de sabotador!\n‚ö†Ô∏è Se tem sabotador_id ‚Üí tipo DEVE SER \"sabotador\"\n\n=== MAPEAMENTO DE FUNCIONALIDADES ===\n| Necessidade | Use no MindQuest |\n|-------------|------------------|\n| Di√°rio/Registro | Conversa com mentor |\n| Check-in emocional | Menu Conversar ‚Üí Check-in |\n| Reflex√£o | Conversa di√°ria/semanal |\n| Acompanhamento | Menu Entender ‚Üí Dashboard |\n| Progresso | Menu Evoluir ‚Üí Pontos |\n| Padr√µes | Menu Entender ‚Üí Sabotadores |\n\n=== üö® REGRAS DE QUESTS DE SABOTADOR (v1.3.18) üö® ===\n\n**REGRA CR√çTICA: QUESTS DE SABOTADOR S√ÉO GERADAS DO ZERO**\n- **tipo = \"sabotador\"** (OBRIGAT√ìRIO - nunca \"personalizada\")\n- **NUNCA usar cat√°logo** para quests de sabotador\n- **SEMPRE usar** `insight_atual` e `contramedida_ativa` do sabotador\n- **catalogo_id = null** para todas as quests de sabotador\n- **sabotador_id** = OBRIGAT√ìRIO, usar o ID do sabotador_principal ou sabotador_secundario\n\n**COMO CRIAR QUEST DE SABOTADOR:**\n1. tipo = \"sabotador\" (CR√çTICO!)\n2. Pegar o `sabotador_principal` (ou `sabotador_secundario` se for a quest adicional)\n3. Usar o `insight_atual` como base para a descri√ß√£o da quest\n4. Incorporar a `contramedida_ativa` no campo `como_aplicar` da base_cientifica\n5. T√≠tulo deve referenciar o sabotador pelo nome (Ex: \"Desafie o Sr. Perfeccionista\")\n6. contexto_origem = \"sabotador_contextualizado\"\n\n**EXEMPLO DE QUEST DE SABOTADOR:**\n```json\n{\n  \"tipo\": \"sabotador\",\n  \"catalogo_id\": null,\n  \"titulo\": \"Desafie o Sr. Perfeccionista com pequenas entregas\",\n  \"descricao\": \"Baseado no insight: [insight_atual do sabotador]. Pratique a imperfei√ß√£o consciente.\",\n  \"base_cientifica\": {\n    \"tipo\": \"sabotador\",\n    \"objetivo\": \"Reduzir a influ√™ncia do perfeccionismo\",\n    \"fundamentos\": \"A Psicologia Positiva mostra que...\",\n    \"como_aplicar\": \"[contramedida_ativa do sabotador]. 1. No MindQuest... 2. Registre...\",\n    \"links_referencias\": []\n  },\n  \"contexto_origem\": \"sabotador_contextualizado\",\n  \"sabotador_id\": \"critico\",\n  \"objetivo_id\": \"uuid-do-objetivo-padrao\",\n  \"xp_recompensa\": 50\n}\n```\n\n=== REGRAS POR TIPO DE QUEST ===\n\n**1. PERSONALIZADA (tipo=\"personalizada\", catalogo_id=null):**\n- Criar do zero baseada na conversa atual\n- Foco em a√ß√µes PR√ÅTICAS (trabalho, sa√∫de, projetos, finan√ßas)\n- N√ÉO incluir quest√µes emocionais/comportamentais (cobertas pelo sabotador)\n- sabotador_id: SEMPRE null\n- objetivo_id: espec√≠fico se relacionado, sen√£o padr√£o\n\n**2. SABOTADOR (tipo=\"sabotador\", catalogo_id=null):**\n- GERAR DO ZERO usando insight_atual e contramedida_ativa\n- tipo: \"sabotador\" (OBRIGAT√ìRIO!)\n- sabotador_id: OBRIGAT√ìRIO (ex: \"critico\", \"inquieto\", etc.)\n- objetivo_id: SEMPRE o padr√£o\n- Referenciar pelo nome original (Ex: \"Para combater o Sr. Perfeccionista...\")\n\n**3. TCC/ESTOICISMO/OUTRAS (tipo=\"tcc\", do cat√°logo):**\n- Adaptar ao contexto das conversas\n- MANTER catalogo_id fornecido\n- objetivo_id: SEMPRE o padr√£o\n- objetivos_secundarios: SEMPRE [] (vazio)\n\n=== ESTRUTURA base_cientifica ===\n```json\n{\n  \"tipo\": \"personalizada|sabotador|tcc|estoicismo|boa_pratica\",\n  \"objetivo\": \"Benef√≠cio claro (por que fazer?)\",\n  \"fundamentos\": \"Embasamento cient√≠fico/filos√≥fico\",\n  \"como_aplicar\": \"Passos pr√°ticos usando MindQuest\",\n  \"links_referencias\": []\n}\n```\n\nüö®üö®üö® REGRA CR√çTICA - VINCULA√á√ÉO DE OBJETIVOS üö®üö®üö®\n\nPara CADA quest PERSONALIZADA:\n- Se conversa menciona trabalho/app/neg√≥cio ‚Üí usar objetivo com area_vida=\"Trabalho\"\n- Se conversa menciona finan√ßas/BTC/investimento ‚Üí usar objetivo com area_vida=\"Finan√ßas\"\n- NUNCA usar objetivo PADR√ÉO se existir objetivo espec√≠fico relacionado ao tema\n\nPara quests de SABOTADOR e TCC:\n- objetivo_id: SEMPRE o objetivo PADR√ÉO"
        }
      },
      "id": "810f7b5d-76ee-4035-bec4-378dfeca85d6",
      "name": "Agente Quests",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        3232,
        272
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const getJson = (nodeName) => {\n  const data = $items(nodeName, 0, 0) || [];\n  const item = data[0] || {};\n  return item.json || {};\n};\n\n// Buscar contexto do n√≥ \"Montar Contexto\" para ter insights_recentes completo\nconst contextoMontar = getJson(\"Montar Contexto\");\nconst contextoPreparar = getJson(\"Preparar Quest do Cat√°logo\");\n\nconst rawOutput = $json.output ?? { quests: [] };\nlet resultado;\nif (typeof rawOutput === 'string') {\n  try {\n    resultado = JSON.parse(rawOutput);\n  } catch (error) {\n    resultado = { quests: [] };\n  }\n} else if (rawOutput && typeof rawOutput === 'object') {\n  resultado = rawOutput;\n} else {\n  resultado = { quests: [] };\n}\n\nconst novasQuests = Array.isArray(resultado.quests) ? resultado.quests : [];\n\n// === CATALOGO_IDS PR√â-SELECIONADOS (v1.3.17) ===\nconst questsEscolhidas = contextoPreparar.quests_catalogo_escolhidas || {};\nconst catalogoIdSabotadorPrincipal = questsEscolhidas.sabotador_principal?.catalogo_id || null;\nconst catalogoIdSabotadorSecundario = questsEscolhidas.sabotador_secundario?.catalogo_id || null;\nconst catalogoIdTCC = questsEscolhidas.tcc_estoicismo_outras?.catalogo_id || null;\n\n// === REPROCESSAMENTO (v1.3.19) ===\nconst isReprocessamento = contextoPreparar.is_reprocessamento || false;\nconst questsSubstituiveis = contextoPreparar.quests_substituiveis || {};\nconst totalPalavrasUsuario = contextoPreparar.total_palavras_usuario || 0;\n\nreturn [{\n  json: {\n    usuario_id: contextoPreparar.usuario_id,\n    chat_id: contextoPreparar.chat_id,\n    novas_quests_sugeridas: novasQuests,\n    atualizacoes_sugeridas: [],\n    sabotadores_recentes: contextoMontar.sabotadores_recentes || [],\n    insights_recentes: contextoMontar.insights_recentes || [],\n    areas_disponiveis: contextoPreparar.areas_disponiveis || [],\n    objetivos_disponiveis: contextoMontar.objetivos_ativos || [],\n    \n    // === REPROCESSAMENTO (v1.3.19) ===\n    is_reprocessamento: isReprocessamento,\n    quests_substituiveis: questsSubstituiveis,\n    total_palavras_usuario: totalPalavrasUsuario,\n    \n    // === NOVA ESTRUTURA SABOTADORES (v1.3.14) ===\n    top3_historicos: contextoPreparar.top3_historicos || [],\n    sabotador_atual: contextoPreparar.sabotador_atual || null,\n    sabotador_principal: contextoPreparar.sabotador_principal || null,\n    criar_quest_adicional: contextoPreparar.criar_quest_adicional || false,\n    \n    // === CATALOGO_IDS V√ÅLIDOS (v1.3.17) ===\n    catalogo_id_sabotador_principal: catalogoIdSabotadorPrincipal,\n    catalogo_id_sabotador_secundario: catalogoIdSabotadorSecundario,\n    catalogo_id_tcc: catalogoIdTCC\n  }\n}];"
      },
      "id": "742c82d5-70c6-475a-92a9-b8f2937b6db4",
      "name": "Interpretar Resultado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3584,
        272
      ]
    },
    {
      "parameters": {
        "jsCode": "const entrada = ($input.item && $input.item.json) ? $input.item.json : {};\nconst questsAtivas = Array.isArray(entrada.quests_ativas) ? entrada.quests_ativas : [];\nconst questsJaCriadas = Array.isArray(entrada.quests_ja_criadas) ? entrada.quests_ja_criadas : [];\n\n// === REPROCESSAMENTO (v1.4.1) ===\nconst isReprocessamento = entrada.is_reprocessamento === true;\nconst questsSubstituiveis = entrada.quests_substituiveis || {};\nconst totalPalavrasUsuario = entrada.total_palavras_usuario || 0;\nconst totalQuestsHoje = entrada.total_quests_hoje || 0;\nconst sabotadoresHoje = entrada.sabotadores_hoje || 0;\nconst personalizadasHoje = entrada.personalizadas_hoje || 0;\nconst catalogoHoje = entrada.catalogo_hoje || 0;\n\n// Quests a substituir (ser√° preenchido durante processamento)\nconst questsParaSubstituir = [];\n\n// Sabotador atual para compara√ß√£o\nconst sabotadorAtualId = entrada.sabotador_atual?.sabotador_id || null;\n\n// === QUESTS OBRIGAT√ìRIAS (v1.4.1) ===\n// Se criar_quest_adicional = true ‚Üí at√© 4 quests (1 personalizada + 2 sabotador + 1 TCC)\n// Sen√£o ‚Üí 3 quests (1 personalizada + 1 sabotador + 1 TCC)\nconst criarQuestAdicional = entrada.criar_quest_adicional || false;\nconst MAX_QUESTS_DIA = criarQuestAdicional ? 4 : 3;\nconst MAX_QUESTS_SABOTADOR = criarQuestAdicional ? 2 : 1;\n\n// === CATALOGO_IDS PR√â-SELECIONADOS (v1.3.17) ===\nconst catalogoIdSabotadorPrincipal = entrada.catalogo_id_sabotador_principal || null;\nconst catalogoIdSabotadorSecundario = entrada.catalogo_id_sabotador_secundario || null;\nconst catalogoIdTCC = entrada.catalogo_id_tcc || null;\n\n// === L√ìGICA DE SUBSTITUI√á√ÉO (v1.4.1) ===\n// Flags para controlar quais tipos de quests criar\nlet criarPersonalizada = true;\nlet criarSabotador = true;\nlet criarCatalogo = true;\nlet sabotadorMudou = false;\n\nif (isReprocessamento) {\n  // Quest personalizada: SEMPRE substituir se disponivel\n  if (questsSubstituiveis.personalizada) {\n    questsParaSubstituir.push({\n      tipo: 'personalizada',\n      quest_id: questsSubstituiveis.personalizada.id,\n      motivo: 'mais_contexto'\n    });\n    // Criar nova personalizada (vai substituir a antiga)\n    criarPersonalizada = true;\n  } else if (personalizadasHoje > 0) {\n    // J√° tem personalizada hoje mas n√£o √© substitu√≠vel (status=ativa)\n    criarPersonalizada = false;\n  }\n  \n  // Quest sabotador: substituir APENAS se sabotador mudou\n  if (questsSubstituiveis.sabotador && sabotadorAtualId) {\n    const sabotadorAnterior = questsSubstituiveis.sabotador.sabotador_id;\n    if (sabotadorAnterior !== sabotadorAtualId) {\n      sabotadorMudou = true;\n      questsParaSubstituir.push({\n        tipo: 'sabotador',\n        quest_id: questsSubstituiveis.sabotador.id,\n        sabotador_anterior: sabotadorAnterior,\n        sabotador_novo: sabotadorAtualId,\n        motivo: 'sabotador_mudou'\n      });\n      criarSabotador = true;\n    } else {\n      // Sabotador n√£o mudou, n√£o criar nova\n      criarSabotador = false;\n    }\n  } else if (sabotadoresHoje > 0) {\n    // J√° tem sabotador hoje mas n√£o √© substitu√≠vel\n    criarSabotador = false;\n  }\n  \n  // Quest cat√°logo: NUNCA substituir\n  if (catalogoHoje > 0) {\n    criarCatalogo = false;\n  }\n}\n\n// === CALCULAR QUESTS A CRIAR (v1.4.1) ===\n// REGRA CR√çTICA: M√°ximo 3 ou 4 quests por dia\nlet questsAindaPodeCriar = MAX_QUESTS_DIA - totalQuestsHoje + questsParaSubstituir.length;\nif (questsAindaPodeCriar < 0) questsAindaPodeCriar = 0;\n\nconst dedupe = new Set();\nconst catalogoIdsUsados = new Set();\nconst titulosUsados = new Set();\nconst uuidRegex = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;\n\n// === CONSTANTES ===\nconst QUEST_CUSTOM_CATALOGO_ID = '00000000-0000-0000-0000-000000000001';\nconst SABOTADORES_VALIDOS = new Set([\n  'critico', 'insistente', 'prestativo', 'hiper_realizador', 'vitima',\n  'hiper_racional', 'hipervigilante', 'inquieto', 'controlador', 'esquivo'\n]);\n\nconst insightsValidos = new Set(\n  (Array.isArray(entrada.insights_recentes) ? entrada.insights_recentes : [])\n    .map((item) => (typeof item?.id === 'string' ? item.id.trim().toLowerCase() : null))\n    .filter(Boolean)\n);\n\n// === VALIDA√á√ÉO DE √ÅREAS DA VIDA ===\nconst areasValidas = new Set(\n  (Array.isArray(entrada.areas_disponiveis) ? entrada.areas_disponiveis : [])\n    .map((item) => (typeof item?.id === 'string' ? item.id.trim().toLowerCase() : null))\n    .filter(Boolean)\n);\n\n// === VALIDA√á√ÉO DE OBJETIVOS ===\nconst objetivosValidos = new Set(\n  (Array.isArray(entrada.objetivos_disponiveis) ? entrada.objetivos_disponiveis : [])\n    .map((item) => (typeof item?.id === 'string' ? item.id.trim().toLowerCase() : null))\n    .filter(Boolean)\n);\n\n// Preencher sets de duplicatas com quests j√° criadas\nfor (const questJaCriada of questsJaCriadas) {\n  const titulo = String(questJaCriada?.titulo || '').toLowerCase().trim();\n  const catalogoId = questJaCriada?.catalogo_id;\n  \n  if (titulo) {\n    titulosUsados.add(titulo);\n  }\n  \n  if (catalogoId && uuidRegex.test(catalogoId)) {\n    catalogoIdsUsados.add(catalogoId);\n  }\n  \n  const contexto = String(questJaCriada?.contexto_origem || '').toLowerCase().trim();\n  if (contexto || titulo) {\n    dedupe.add(`${contexto}|${titulo}`);\n  }\n}\n\n// Verificar duplicatas das quests ativas\nfor (const ativo of questsAtivas) {\n  const contexto = String(ativo?.contexto_origem || '').toLowerCase().trim();\n  const titulo = String((ativo?.config?.titulo ?? ativo?.titulo ?? '')).toLowerCase().trim();\n  const catalogoId = ativo?.catalogo_id;\n  \n  if (titulo) {\n    titulosUsados.add(titulo);\n  }\n  \n  if (catalogoId && uuidRegex.test(catalogoId)) {\n    catalogoIdsUsados.add(catalogoId);\n  }\n  \n  if (contexto || titulo) {\n    dedupe.add(`${contexto}|${titulo}`);\n  }\n}\n\nconst atualizacoes = Array.isArray(entrada.atualizacoes_sugeridas) ? entrada.atualizacoes_sugeridas : [];\nconst candidatas = Array.isArray(entrada.novas_quests_sugeridas) ? entrada.novas_quests_sugeridas : [];\n\n// Fun√ß√£o para verificar similaridade de t√≠tulos (evitar duplicatas)\nconst tituloSimilar = (titulo1, titulo2) => {\n  const t1 = String(titulo1 || '').toLowerCase().trim();\n  const t2 = String(titulo2 || '').toLowerCase().trim();\n  \n  if (!t1 || !t2) return false;\n  \n  const palavras1 = t1.split(/\\s+/);\n  const palavras2 = t2.split(/\\s+/);\n  const palavrasComuns = palavras1.filter(p => palavras2.includes(p));\n  const similaridade = palavrasComuns.length / Math.max(palavras1.length, palavras2.length);\n  \n  return similaridade >= 0.8 || t1.includes(t2) || t2.includes(t1);\n};\n\n// === ESTRUTURA PARA PERMITIR AT√â 2 SABOTADORES (v1.3.15) ===\nconst questsPorTipo = { \n  personalizada: null, \n  sabotador: [], // Array para permitir at√© 2\n  tcc_estoicismo: null \n};\n\nlet sabotadorQuestCount = 0; // Contador para usar IDs corretos\n\nfor (const quest of candidatas) {\n  if (!quest || typeof quest !== 'object') continue;\n  \n  const contexto = String(quest.contexto_origem || '').toLowerCase().trim();\n  const titulo = String(quest.titulo || '').toLowerCase().trim();\n  const chave = `${contexto}|${titulo}`;\n  \n  if (!contexto && !titulo) continue;\n  if (dedupe.has(chave)) continue;\n  \n  let tituloMuitoSimilar = false;\n  for (const tituloUsado of titulosUsados) {\n    if (tituloSimilar(titulo, tituloUsado)) {\n      tituloMuitoSimilar = true;\n      break;\n    }\n  }\n  if (tituloMuitoSimilar) continue;\n  \n  // === VALIDAR sabotador_id PRIMEIRO (v1.3.19) ===\n  let sabotadorId = null;\n  if (typeof quest.sabotador_id === 'string') {\n    const trimmed = quest.sabotador_id.trim().toLowerCase();\n    if (trimmed) {\n      if (SABOTADORES_VALIDOS.has(trimmed) || uuidRegex.test(quest.sabotador_id.trim())) {\n        sabotadorId = quest.sabotador_id.trim();\n      }\n    }\n  }\n  \n  // === DETECTAR SE √â QUEST DE SABOTADOR (prioridade absoluta) ===\n  const tipoQuest = String(quest.tipo || '').toLowerCase();\n  const isSabotadorQuest = sabotadorId !== null || \n                          tipoQuest === 'sabotador' ||\n                          contexto.includes('sabotador') || \n                          contexto.includes('sabot');\n  \n  // === DETERMINAR catalogo_id ===\n  let catalogoId = null;\n  \n  // Quest de sabotador: catalogo_id = null (v1.3.19)\n  if (isSabotadorQuest) {\n    catalogoId = null; // Sabotador quests s√£o geradas do zero, sem cat√°logo\n  } else if (tipoQuest === 'personalizada' || !quest.catalogo_id) {\n    catalogoId = QUEST_CUSTOM_CATALOGO_ID;\n  } else if (typeof quest.catalogo_id === 'string') {\n    const trimmed = quest.catalogo_id.trim();\n    \n    // Para quest TCC: usar o ID pr√©-selecionado\n    if (catalogoIdTCC && tipoQuest === 'tcc') {\n      catalogoId = catalogoIdTCC;\n    } else if (trimmed && uuidRegex.test(trimmed)) {\n      catalogoId = trimmed;\n    }\n    \n    // Verificar duplicata de catalogo_id\n    if (catalogoId && catalogoIdsUsados.has(catalogoId) && catalogoId !== QUEST_CUSTOM_CATALOGO_ID) {\n      continue;\n    }\n  }\n  \n  // === VALIDAR area_vida_id contra lista de IDs v√°lidos ===\n  let areaVidaId = null;\n  if (typeof quest.area_vida_id === 'string') {\n    const trimmed = quest.area_vida_id.trim();\n    if (trimmed && uuidRegex.test(trimmed) && areasValidas.has(trimmed.toLowerCase())) {\n      areaVidaId = trimmed;\n    }\n  }\n  \n  let insightId = null;\n  if (typeof quest.insight_id === 'string') {\n    const trimmed = quest.insight_id.trim();\n    if (trimmed && uuidRegex.test(trimmed) && insightsValidos.has(trimmed.toLowerCase())) {\n      insightId = trimmed;\n    }\n  }\n  \n  // === VALIDAR objetivo_id contra lista de IDs v√°lidos ===\n  let objetivoId = null;\n  if (typeof quest.objetivo_id === 'string') {\n    const trimmed = quest.objetivo_id.trim();\n    if (trimmed && uuidRegex.test(trimmed) && objetivosValidos.has(trimmed.toLowerCase())) {\n      objetivoId = trimmed;\n    }\n  }\n  \n  // === OBJETIVOS_SECUNDARIOS - validar cada um ===\n  let objetivosSecundarios = [];\n  if (Array.isArray(quest.objetivos_secundarios)) {\n    objetivosSecundarios = quest.objetivos_secundarios\n      .filter(os => os && typeof os.objetivo_id === 'string' && uuidRegex.test(os.objetivo_id.trim()) && objetivosValidos.has(os.objetivo_id.trim().toLowerCase()))\n      .map(os => ({ objetivo_id: os.objetivo_id.trim() }));\n  }\n  \n  // === REGRA FOR√áADA: Quest do cat√°logo SEM sabotador = SEM objetivos secund√°rios ===\n  if (catalogoId && catalogoId !== QUEST_CUSTOM_CATALOGO_ID && !sabotadorId) {\n    objetivosSecundarios = [];\n  }\n  \n  // === DETERMINAR TIPO/CATEGORIA (v1.3.19 - priorizar sabotador_id) ===\n  let tipoCategoria = 'personalizada';\n  \n  // 1. PRIMEIRO: verificar se √© quest de sabotador (tem sabotador_id ou tipo=sabotador)\n  if (isSabotadorQuest) {\n    tipoCategoria = 'sabotador';\n  // 2. DEPOIS: verificar personalizada\n  } else if (catalogoId === QUEST_CUSTOM_CATALOGO_ID || tipoQuest === 'personalizada') {\n    tipoCategoria = 'personalizada';\n  // 3. Verificar reflex√£o (ignorar)\n  } else if (contexto.includes('reflexao') || contexto.includes('reflex')) {\n    continue;\n  // 4. Demais (TCC, estoicismo, etc)\n  } else if (catalogoId) {\n    tipoCategoria = 'tcc_estoicismo';\n  }\n  \n  // === DETERMINAR tipo FINAL (corrigir se necess√°rio) ===\n  let tipoFinal = tipoQuest;\n  if (isSabotadorQuest) {\n    tipoFinal = 'sabotador'; // For√ßar tipo correto\n  } else if (!tipoFinal || tipoFinal === 'catalogo') {\n    tipoFinal = catalogoId === QUEST_CUSTOM_CATALOGO_ID ? 'personalizada' : 'tcc';\n  }\n  \n  // === DETERMINAR catalogo_id FINAL ===\n  // Quest personalizada sem sabotador usa QUEST_CUSTOM_CATALOGO_ID\n  // Quest de sabotador usa null\n  let catalogoIdFinal = catalogoId;\n  if (tipoCategoria === 'personalizada' && !sabotadorId) {\n    catalogoIdFinal = QUEST_CUSTOM_CATALOGO_ID;\n  } else if (tipoCategoria === 'sabotador') {\n    catalogoIdFinal = null; // Sabotador n√£o usa cat√°logo\n  }\n  \n  const questProcessada = {\n    tipo: tipoFinal,\n    catalogo_id: catalogoIdFinal,\n    titulo: quest.titulo,\n    descricao: quest.descricao,\n    base_cientifica: quest.base_cientifica || null,\n    contexto_origem: quest.contexto_origem,\n    prioridade: quest.prioridade || 'media',\n    recorrencia: quest.recorrencia || 'unica',\n    prazo_inicio: quest.prazo_inicio || null,\n    prazo_fim: quest.prazo_fim || null,\n    progresso_meta: quest.progresso_meta ?? 1,\n    status_inicial: quest.status_inicial || 'disponivel',\n    area_vida_id: areaVidaId,\n    sabotador_id: sabotadorId,\n    insight_id: insightId,\n    objetivo_id: objetivoId,\n    objetivos_secundarios: objetivosSecundarios,\n    complexidade: quest.complexidade ?? 0,\n    payload_extra: quest.payload_extra || {},\n    xp_recompensa: quest.xp_recompensa || 40\n  };\n  \n  // === RESPEITAR FLAGS DE REPROCESSAMENTO (v1.4.1) ===\n  if (tipoCategoria === 'personalizada' && !questsPorTipo.personalizada && criarPersonalizada) {\n    questsPorTipo.personalizada = questProcessada;\n  } else if (tipoCategoria === 'sabotador' && questsPorTipo.sabotador.length < MAX_QUESTS_SABOTADOR && criarSabotador) {\n    // Permitir at√© MAX_QUESTS_SABOTADOR quests de sabotador\n    questsPorTipo.sabotador.push(questProcessada);\n    sabotadorQuestCount++;\n  } else if (tipoCategoria === 'tcc_estoicismo' && !questsPorTipo.tcc_estoicismo && criarCatalogo) {\n    questsPorTipo.tcc_estoicismo = questProcessada;\n  }\n  \n  dedupe.add(chave);\n  if (titulo) titulosUsados.add(titulo);\n  if (catalogoIdFinal && catalogoIdFinal !== QUEST_CUSTOM_CATALOGO_ID) catalogoIdsUsados.add(catalogoIdFinal);\n}\n\nconst questsFinais = [];\nif (questsPorTipo.personalizada && criarPersonalizada) questsFinais.push(questsPorTipo.personalizada);\n// Adicionar todas as quests de sabotador (at√© 2) se permitido\nif (criarSabotador) {\n  for (const questSab of questsPorTipo.sabotador) {\n    questsFinais.push(questSab);\n  }\n}\nif (questsPorTipo.tcc_estoicismo && criarCatalogo) questsFinais.push(questsPorTipo.tcc_estoicismo);\n\n// Segunda passada para preencher se faltou algum tipo\nfor (const quest of candidatas) {\n  if (questsFinais.length >= QUESTS_OBRIGATORIAS) break;\n  if (!quest || typeof quest !== 'object') continue;\n  \n  const contexto = String(quest.contexto_origem || '').toLowerCase().trim();\n  const titulo = String(quest.titulo || '').toLowerCase().trim();\n  const chave = `${contexto}|${titulo}`;\n  \n  if (contexto.includes('reflexao') || contexto.includes('reflex')) {\n    continue;\n  }\n  \n  if (dedupe.has(chave)) continue;\n  \n  let tituloMuitoSimilar = false;\n  for (const tituloUsado of titulosUsados) {\n    if (tituloSimilar(titulo, tituloUsado)) {\n      tituloMuitoSimilar = true;\n      break;\n    }\n  }\n  if (tituloMuitoSimilar) continue;\n  \n  const tipoQuest = String(quest.tipo || '').toLowerCase();\n  \n  // Validar sabotador_id\n  let sabotadorId = null;\n  if (typeof quest.sabotador_id === 'string') {\n    const trimmed = quest.sabotador_id.trim().toLowerCase();\n    if (trimmed) {\n      if (SABOTADORES_VALIDOS.has(trimmed) || uuidRegex.test(quest.sabotador_id.trim())) {\n        sabotadorId = quest.sabotador_id.trim();\n      }\n    }\n  }\n  \n  const isSabotadorQuest = sabotadorId !== null || tipoQuest === 'sabotador';\n  \n  let catalogoId = null;\n  if (isSabotadorQuest) {\n    catalogoId = null;\n  } else if (tipoQuest === 'personalizada' || !quest.catalogo_id) {\n    catalogoId = QUEST_CUSTOM_CATALOGO_ID;\n  } else if (typeof quest.catalogo_id === 'string') {\n    const trimmed = quest.catalogo_id.trim();\n    if (trimmed && uuidRegex.test(trimmed)) {\n      if (catalogoIdsUsados.has(trimmed) && trimmed !== QUEST_CUSTOM_CATALOGO_ID) {\n        continue;\n      }\n      catalogoId = trimmed;\n    }\n  }\n  \n  let insightId = null;\n  if (typeof quest.insight_id === 'string') {\n    const trimmed = quest.insight_id.trim();\n    if (trimmed && uuidRegex.test(trimmed) && insightsValidos.has(trimmed.toLowerCase())) {\n      insightId = trimmed;\n    }\n  }\n  \n  let areaVidaId = null;\n  if (typeof quest.area_vida_id === 'string') {\n    const trimmed = quest.area_vida_id.trim();\n    if (trimmed && uuidRegex.test(trimmed) && areasValidas.has(trimmed.toLowerCase())) {\n      areaVidaId = trimmed;\n    }\n  }\n  \n  let objetivoId = null;\n  if (typeof quest.objetivo_id === 'string') {\n    const trimmed = quest.objetivo_id.trim();\n    if (trimmed && uuidRegex.test(trimmed) && objetivosValidos.has(trimmed.toLowerCase())) {\n      objetivoId = trimmed;\n    }\n  }\n  \n  let objetivosSecundarios = [];\n  if (Array.isArray(quest.objetivos_secundarios)) {\n    objetivosSecundarios = quest.objetivos_secundarios\n      .filter(os => os && typeof os.objetivo_id === 'string' && uuidRegex.test(os.objetivo_id.trim()) && objetivosValidos.has(os.objetivo_id.trim().toLowerCase()))\n      .map(os => ({ objetivo_id: os.objetivo_id.trim() }));\n  }\n  \n  if (catalogoId && catalogoId !== QUEST_CUSTOM_CATALOGO_ID && !sabotadorId) {\n    objetivosSecundarios = [];\n  }\n  \n  let tipoFinal = tipoQuest;\n  if (isSabotadorQuest) {\n    tipoFinal = 'sabotador';\n  } else if (!tipoFinal || tipoFinal === 'catalogo') {\n    tipoFinal = catalogoId === QUEST_CUSTOM_CATALOGO_ID ? 'personalizada' : 'tcc';\n  }\n  \n  questsFinais.push({\n    tipo: tipoFinal,\n    catalogo_id: catalogoId,\n    titulo: quest.titulo,\n    descricao: quest.descricao,\n    base_cientifica: quest.base_cientifica || null,\n    contexto_origem: quest.contexto_origem,\n    prioridade: quest.prioridade || 'media',\n    recorrencia: quest.recorrencia || 'unica',\n    prazo_inicio: quest.prazo_inicio || null,\n    prazo_fim: quest.prazo_fim || null,\n    progresso_meta: quest.progresso_meta ?? 1,\n    status_inicial: quest.status_inicial || 'disponivel',\n    area_vida_id: areaVidaId,\n    sabotador_id: sabotadorId,\n    insight_id: insightId,\n    objetivo_id: objetivoId,\n    objetivos_secundarios: objetivosSecundarios,\n    complexidade: quest.complexidade ?? 0,\n    payload_extra: quest.payload_extra || {},\n    xp_recompensa: quest.xp_recompensa || 40\n  });\n  \n  dedupe.add(chave);\n  if (titulo) titulosUsados.add(titulo);\n  if (catalogoId && catalogoId !== QUEST_CUSTOM_CATALOGO_ID) catalogoIdsUsados.add(catalogoId);\n}\n\n// === LIMITAR PELO M√ÅXIMO DO DIA (v1.4.1) ===\nconst questsParaCriar = questsFinais.slice(0, questsAindaPodeCriar);\n\nreturn [{\n  json: {\n    usuario_id: entrada.usuario_id || null,\n    chat_id: entrada.chat_id || null,\n    total_palavras_usuario: totalPalavrasUsuario,\n    novas_quests: questsParaCriar,\n    quests_para_substituir: questsParaSubstituir,\n    atualizacoes,\n    estado_inicial: entrada,\n    // Debug info (v1.4.1)\n    _debug: {\n      is_reprocessamento: isReprocessamento,\n      criar_quest_adicional: criarQuestAdicional,\n      max_quests_dia: MAX_QUESTS_DIA,\n      total_quests_hoje: totalQuestsHoje,\n      quests_ainda_pode_criar: questsAindaPodeCriar,\n      flags: {\n        criar_personalizada: criarPersonalizada,\n        criar_sabotador: criarSabotador,\n        criar_catalogo: criarCatalogo,\n        sabotador_mudou: sabotadorMudou\n      },\n      quests_hoje_por_tipo: {\n        personalizadas: personalizadasHoje,\n        sabotadores: sabotadoresHoje,\n        catalogo: catalogoHoje\n      },\n      quests_substituiveis: questsSubstituiveis,\n      quests_geradas: questsFinais.length,\n      quests_enviadas: questsParaCriar.length\n    }\n  }\n}];"
      },
      "id": "2a8486f6-8c9c-4f62-8656-3fa439f3b613",
      "name": "Aplicar Limites & Dedupe",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3792,
        272
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "bTeLj5qOKQo9PDMO",
          "mode": "list",
          "cachedResultUrl": "/workflow/bTeLj5qOKQo9PDMO",
          "cachedResultName": "sw_xp_quest"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $('start').first().json.usuario_id }}",
            "quests_personalizadas": "={{ JSON.stringify($json.novas_quests) }}",
            "atualizacoes_status": "={{ JSON.stringify($json.atualizacoes) }}",
            "quests_para_substituir": "={{ JSON.stringify($json.quests_para_substituir || []) }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "quests_personalizadas",
              "displayName": "quests_personalizadas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "atualizacoes_status",
              "displayName": "atualizacoes_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "quests_para_substituir",
              "displayName": "quests_para_substituir",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "7ce8c566-04a9-4531-bf73-6b0fdf84c4bd",
      "name": "Calcula Xps quest",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        4016,
        272
      ]
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"quests\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"tipo\": {\"type\": \"string\"},\n          \"catalogo_id\": {\"type\": [\"string\", \"null\"]},\n          \"titulo\": {\"type\": \"string\"},\n          \"descricao\": {\"type\": \"string\"},\n          \"base_cientifica\": {\n            \"type\": [\"object\", \"null\"],\n            \"properties\": {\n              \"tipo\": {\"type\": \"string\"},\n              \"objetivo\": {\"type\": \"string\"},\n              \"fundamentos\": {\"type\": \"string\"},\n              \"como_aplicar\": {\"type\": \"string\"},\n              \"links_referencias\": {\"type\": \"array\", \"items\": {\"type\": \"string\"}}\n            }\n          },\n          \"contexto_origem\": {\"type\": \"string\"},\n          \"prioridade\": {\"type\": \"string\"},\n          \"recorrencia\": {\"type\": \"string\"},\n          \"prazo_inicio\": {\"type\": \"string\"},\n          \"prazo_fim\": {\"type\": \"string\"},\n          \"progresso_meta\": {\"type\": \"number\"},\n          \"area_vida_id\": {\"type\": \"string\"},\n          \"sabotador_id\": {\"type\": [\"string\", \"null\"]},\n          \"objetivo_id\": {\"type\": \"string\", \"description\": \"UUID do objetivo principal vinculado\"},\n          \"objetivos_secundarios\": {\n            \"type\": \"array\",\n            \"items\": {\n              \"type\": \"object\",\n              \"properties\": {\n                \"objetivo_id\": {\"type\": \"string\"}\n              },\n              \"required\": [\"objetivo_id\"]\n            },\n            \"description\": \"Array de objetivos secundarios impactados\"\n          },\n          \"complexidade\": {\"type\": \"number\"},\n          \"xp_recompensa\": {\"type\": \"number\"}\n        },\n        \"required\": [\"tipo\", \"titulo\", \"descricao\", \"contexto_origem\", \"prioridade\", \"recorrencia\", \"area_vida_id\", \"objetivo_id\", \"objetivos_secundarios\"]\n      }\n    }\n  },\n  \"required\": [\"quests\"]\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        3392,
        560
      ],
      "id": "c5204f2e-4bd2-44d4-8cee-4a20fec1db68",
      "name": "Parser Quests"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Buscar TOP 3 sabotadores hist√≥ricos (com insight/contramedida MAIS RECENTE)\n-- + sabotador atual = data mais recente (DATE) + desempate por intensidade_media\n-- Regra: score = total_deteccoes * intensidade_media\n-- SEMPRE usar o contexto mais recente do sabotador\n\nWITH sabotadores_agregados AS (\n  SELECT\n    us.sabotador_id,\n    COUNT(*) AS total_deteccoes,\n    COUNT(DISTINCT us.chat_id) AS conversas_afetadas,\n    AVG(us.intensidade_media) AS intensidade_media,\n    (COUNT(*) * AVG(us.intensidade_media)) AS score\n  FROM public.usuarios_sabotadores us\n  WHERE us.usuario_id = $1::uuid\n  GROUP BY us.sabotador_id\n),\n-- Pegar insight/contramedida do registro MAIS RECENTE de cada sabotador\nsabotadores_recentes AS (\n  SELECT DISTINCT ON (us.sabotador_id)\n    us.sabotador_id,\n    us.insight_atual,\n    us.contramedida_ativa,\n    us.contexto_principal,\n    us.criado_em\n  FROM public.usuarios_sabotadores us\n  WHERE us.usuario_id = $1::uuid\n  ORDER BY us.sabotador_id, us.criado_em DESC\n),\ntop3_historicos AS (\n  SELECT \n    sa.sabotador_id,\n    sa.total_deteccoes,\n    sa.conversas_afetadas,\n    sa.intensidade_media,\n    sa.score,\n    sr.insight_atual,\n    sr.contramedida_ativa,\n    sr.contexto_principal\n  FROM sabotadores_agregados sa\n  LEFT JOIN sabotadores_recentes sr ON sr.sabotador_id = sa.sabotador_id\n  ORDER BY sa.score DESC, sa.total_deteccoes DESC, sa.conversas_afetadas DESC\n  LIMIT 3\n),\n-- SABOTADOR ATUAL: data mais recente (DATE sem horas) + desempate intensidade_media\nsabotador_atual AS (\n  SELECT DISTINCT ON (DATE(us.criado_em))\n    us.sabotador_id,\n    us.intensidade_media,\n    us.insight_atual,\n    us.contramedida_ativa,\n    us.contexto_principal,\n    DATE(us.criado_em) AS data_conversa\n  FROM public.usuarios_sabotadores us\n  WHERE us.usuario_id = $1::uuid\n  ORDER BY DATE(us.criado_em) DESC, us.intensidade_media DESC\n  LIMIT 1\n)\nSELECT json_build_object(\n  'sabotadores',\n  json_build_object(\n    'top3_historicos', COALESCE(\n      (SELECT json_agg(\n        json_build_object(\n          'sabotador_id', t.sabotador_id,\n          'total_deteccoes', t.total_deteccoes,\n          'conversas_afetadas', t.conversas_afetadas,\n          'intensidade_media', ROUND(t.intensidade_media::numeric, 2),\n          'insight_atual', t.insight_atual,\n          'contramedida_ativa', t.contramedida_ativa,\n          'contexto_principal', t.contexto_principal,\n          'score', ROUND(t.score::numeric, 2)\n        )\n      ) FROM top3_historicos t),\n      '[]'::json\n    ),\n    'sabotador_atual', (\n      SELECT json_build_object(\n        'sabotador_id', sa.sabotador_id,\n        'intensidade_media', ROUND(sa.intensidade_media::numeric, 2),\n        'insight_atual', sa.insight_atual,\n        'contramedida_ativa', sa.contramedida_ativa,\n        'contexto_principal', sa.contexto_principal,\n        'data_conversa', sa.data_conversa\n      )\n      FROM sabotador_atual sa\n      LIMIT 1\n    ),\n    'sabotador_mais_ativo', (\n      SELECT json_build_object(\n        'sabotador_id', t.sabotador_id,\n        'total_deteccoes', t.total_deteccoes,\n        'intensidade_media', ROUND(t.intensidade_media::numeric, 2),\n        'insight_atual', t.insight_atual,\n        'contramedida_ativa', t.contramedida_ativa\n      )\n      FROM top3_historicos t\n      LIMIT 1\n    )\n  )\n) AS sabotadores;",
        "options": {
          "queryReplacement": "={{ [ $('Normalizar Entrada').item.json.usuario_id ] }}"
        }
      },
      "id": "4870ee57-c407-4909-8af2-b952c07a23c8",
      "name": "Buscar Sabotadores Ativo",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1984,
        240
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Sa√≠da quando n√£o pode processar (v1.3.19)\nconst verificacao = $('Buscar Quests e Verificar Limite').first().json;\nconst entrada = $('Normalizar Entrada').first().json;\n\nreturn [{\n  json: {\n    usuario_id: entrada.usuario_id,\n    quests_registradas: 0,\n    motivo: verificacao.status_processamento || 'sem_conversa',\n    total_quests_ativas: verificacao.total_quests_ativas || 0,\n    delta_palavras: verificacao.delta_palavras || 0,\n    is_reprocessamento: verificacao.is_reprocessamento || false\n  }\n}];"
      },
      "id": "08e4276e-f979-4138-8c4d-3b758c10c43b",
      "name": "Saida Bloqueado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1760,
        480
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "proc1",
              "leftValue": "={{ $('Buscar Quests e Verificar Limite').first().json.status_processamento }}",
              "rightValue": "pode_processar",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "conv1",
              "leftValue": "={{ $json.conversas.conversas_recentes[0].chat_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1504,
        224
      ],
      "id": "b8d43f92-1631-47f0-804e-375f7d6ea2eb",
      "name": "Pode Processar?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT json_build_object(\n  'objetivos_ativos',\n  COALESCE(json_agg(\n    json_build_object(\n      'id', uo.id,\n      'titulo', uo.titulo,\n      'detalhamento', uo.detalhamento,\n      'is_padrao', uo.is_padrao,\n      'area_vida', av.nome,\n      'area_codigo', av.codigo,\n      'prazo_dias', uo.prazo_dias,\n      'data_limite', uo.data_limite\n    )\n    ORDER BY uo.is_padrao DESC, uo.criado_em\n  ), '[]'::json)\n) AS objetivos\nFROM usuarios_objetivos uo\nJOIN areas_vida_catalogo av ON uo.area_vida_id = av.id\nWHERE uo.usuario_id = $1::uuid\n  AND uo.status = 'ativo';",
        "options": {
          "queryReplacement": "={{ [ $('Normalizar Entrada').item.json.usuario_id ] }}"
        }
      },
      "id": "99cca801-9428-45f6-ade1-7e325e6de9fd",
      "name": "Buscar Objetivos Ativos",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1760,
        144
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Regras de Neg√≥cio: Conversas ‚Üí Quests (v1.4.1)\n\n### REGRA CR√çTICA\n**M√°ximo 3 ou 4 quests por dia por usu√°rio**\n- Se j√° existem quests hoje ‚Üí reprocessamento\n- Se limite atingido ‚Üí n√£o cria novas\n\n---\n\n### Quantidade de Quests por Conversa\n- **1 conversa (usr_chat) = 3 ou 4 quests**\n\n**Padr√£o (3 quests):**\n1. Quest personalizada (baseada na conversa)\n2. Quest de sabotador (baseada no sabotador principal)\n3. Quest TCC / outras (do cat√°logo)\n\n**Exce√ß√£o (4 quests):**\n- Sabotador atual **n√£o est√° no top 3** + intensidade **‚â• 60**\n‚Üí Adiciona quest extra de sabotador (secund√°rio)\n\n---\n\n### Regras de Reprocessamento (mesmo dia)\n\n| Tipo | Reprocessa? | Condi√ß√£o |\n|------|-------------|----------|\n| Personalizada | ‚úÖ Sempre | DELETE + INSERT |\n| Sabotador | ‚ö†Ô∏è Condicional | S√≥ se sabotador mudou |\n| Cat√°logo | ‚ùå Nunca | Mant√©m original |\n\n**Por status:**\n- `disponivel` ‚Üí DELETE e substitui\n- `ativa` ‚Üí mant√©m (n√£o mexe)\n\n---\n\n### Limite de Quests Ativas\n- M√°ximo: **15 quests** (`ativa` + `disponivel`)\n- M√°ximo: **3 ou 4 quests por dia**\n- Se limite atingido ‚Üí n√£o cria novas\n",
        "height": 1056,
        "width": 624
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -128,
        -304
      ],
      "id": "f6ec13e6-7596-4bba-9318-693dbc0bbb09",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Atualizar palavras_ultimo_processamento ap√≥s criar/substituir quests (v1.3.19)\nUPDATE usr_chat \nSET \n  palavras_ultimo_processamento = $2,\n  atualizado_em = NOW()\nWHERE id = $1::uuid\nRETURNING id, palavras_ultimo_processamento;",
        "options": {
          "queryReplacement": "={{ [$('Aplicar Limites & Dedupe').first().json.chat_id, $('Aplicar Limites & Dedupe').first().json.total_palavras_usuario] }}"
        }
      },
      "id": "e827dc4a-0ebd-4990-a616-99be6e3e9a51",
      "name": "Atualizar Palavras Processadas",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4272,
        272
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $items(\"Aplicar Limites & Dedupe\", 0, 0) || [];\nconst entrada = (data[0] || {}).json || {};\nconst retorno = $input.item.json || {};\n\nreturn [{\n  json: {\n    usuario_id: entrada.usuario_id,\n    quests_registradas: entrada.novas_quests,\n    atualizacoes_enviadas: entrada.atualizacoes,\n    gamificacao_retorno: retorno\n  }\n}];"
      },
      "id": "ec0a6012-36c2-45f8-8ee3-fc7dc246135f",
      "name": "Montar Sa√≠da1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4512,
        272
      ]
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Normalizar Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Entrada": {
      "main": [
        [
          {
            "node": "Buscar Quests e Verificar Limite",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Quests e Verificar Limite": {
      "main": [
        [
          {
            "node": "Buscar Conversas Recentes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Conversas Recentes": {
      "main": [
        [
          {
            "node": "Pode Processar?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Agente Quests",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Parser Quests",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Interpretar Resultado": {
      "main": [
        [
          {
            "node": "Aplicar Limites & Dedupe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aplicar Limites & Dedupe": {
      "main": [
        [
          {
            "node": "Calcula Xps quest",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agente Quests": {
      "main": [
        [
          {
            "node": "Interpretar Resultado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcula Xps quest": {
      "0": [
        [
          {
            "node": "Montar Sa√≠da",
            "type": "0",
            "index": 0
          }
        ]
      ],
      "main": [
        [
          {
            "node": "Atualizar Palavras Processadas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Montar Contexto": {
      "main": [
        [
          {
            "node": "Preparar Quest do Cat√°logo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Est√°gio Usu√°rio": {
      "main": [
        [
          {
            "node": "Buscar Quests Cat√°logo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Quests Cat√°logo": {
      "main": [
        [
          {
            "node": "Montar Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Quest do Cat√°logo": {
      "main": [
        [
          {
            "node": "Agente Quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser Quests": {
      "ai_outputParser": [
        [
          {
            "node": "Agente Quests",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Listar √Åreas da Vida": {
      "main": [
        [
          {
            "node": "Buscar Est√°gio Usu√°rio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Sabotadores Ativo": {
      "main": [
        [
          {
            "node": "Listar √Åreas da Vida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pode Processar?": {
      "main": [
        [
          {
            "node": "Buscar Objetivos Ativos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Saida Bloqueado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Objetivos Ativos": {
      "main": [
        [
          {
            "node": "Buscar Sabotadores Ativo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Palavras Processadas": {
      "main": [
        [
          {
            "node": "Montar Sa√≠da1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": {
    "start": [
      {
        "json": {
          "usuario_id": "4bb8706a-7886-4ccb-8263-ff51aaafaafa",
          "chat_id": "c475f518-d1b4-4e51-ad78-0bdbacb4b32d"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "usuario_id": "4bb8706a-7886-4ccb-8263-ff51aaafaafa",
          "chat_id": "c475f518-d1b4-4e51-ad78-0bdbacb4b32d"
        },
        "pairedItem": {
          "item": 1
        }
      }
    ]
  },
  "activeVersionId": null,
  "shared": [
    {
      "createdAt": "2025-11-05T13:38:03.212Z",
      "role": "workflow:owner",
      "workflowId": "LKjU8NE9aNHw7kEh",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [],
  "activeVersion": null
}
