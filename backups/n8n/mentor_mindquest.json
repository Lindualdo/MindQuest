{
  "createdAt": "2025-12-01T18:59:38.019Z",
  "id": "c1To6ho5riDs85Aj",
  "name": "mentor_mindquest",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usr_id"
            },
            {
              "name": "body.instance"
            },
            {
              "name": "body.data.key.remoteJid"
            },
            {
              "name": "body.data.key.id"
            },
            {
              "name": "body.data.key.fromMe",
              "type": "boolean"
            },
            {
              "name": "body.data.pushName"
            },
            {
              "name": "body.data.message.conversation"
            },
            {
              "name": "body.data.messageType"
            }
          ]
        }
      },
      "id": "start",
      "name": "start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -480,
        -288
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "fVrO1PaqFuA957u0",
          "mode": "list"
        }
      },
      "id": "config",
      "name": "config",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -304,
        -288
      ]
    },
    {
      "parameters": {
        "jsCode": "// CONTEXTO COMPLETO - Consolida todos os dados\nconst usuarioId = $('start').first().json.usr_id;\nconst config = $('config').first().json;\nconst dadosUsr = $('busca_dados_usr').first().json;\nconst contexto = $('busca_contexto').first().json;\n\nreturn [{\n  usuario_id: usuarioId,\n  nome_preferencia: dadosUsr?.nome_preferencia || null,\n  nome_assistente: dadosUsr?.nome_assistente || null,\n  whatsapp_numero: dadosUsr?.whatsapp_numero || null,\n  faixa_etaria: dadosUsr?.faixa_etaria || null,\n  sobre_voce: dadosUsr?.sobre_voce || null,\n  tom_conversa: dadosUsr?.tom_conversa || null,\n  objetivos_especificos: contexto?.objetivos_especificos || [],\n  objetivo_padrao: contexto?.objetivo_padrao_id || null,\n  sabotador_mais_ativo: contexto?.sabotador_mais_ativo || null,\n  perfil_bigfive_primario: contexto?.perfil_bigfive_primario || null,\n  quests_ativas: contexto?.quests_ativas || [],\n  ultimas_conversas: contexto?.ultimas_conversas || [],\n  nivel_atual: contexto?.nivel_atual || null,\n  titulo_nivel: contexto?.titulo_nivel || null,\n  limit_min: Number(config?.limit_iteration_min) || 5,\n  limit_max: Number(config?.limit_iteration_max) || 20\n}];"
      },
      "id": "contexto_completo",
      "name": "contexto_completo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        272,
        -288
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "jUAvu7DUAzyqZhJd",
          "mode": "list"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "body.instance": "={{ $('start').first().json['body.instance'] }}",
            "body.data.key.remoteJid": "={{ $('start').first().json['body.data.key.remoteJid'] }}",
            "body.data.key.id": "={{ $('start').first().json['body.data.key.id'] }}",
            "body.data.key.fromMe": "={{ $('start').first().json['body.data.key.fromMe'] }}",
            "body.data.pushName": "={{ $('start').first().json['body.data.pushName'] }}",
            "body.data.message.conversation": "={{ $('start').first().json['body.data.message.conversation'] }}",
            "body.data.messageType": "={{ $('start').first().json['body.data.messageType'] }}"
          }
        },
        "options": {}
      },
      "id": "transcricao",
      "name": "transcricao",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        464,
        -288
      ]
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('start').first().json['body.instance'] }}{{ $('start').first().json.usr_id }}{{ $('contexto_completo').first().json.whatsapp_numero }}",
        "sessionTTL": 43200,
        "contextWindowLength": 50
      },
      "id": "memory",
      "name": "memory",
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        1680,
        400
      ],
      "credentials": {
        "redis": {
          "id": "PB4zpLy1jLXDEzmH",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "groupMessages": true
        }
      },
      "id": "memory_get",
      "name": "memory_get",
      "type": "@n8n/n8n-nodes-langchain.memoryManager",
      "typeVersion": 1.1,
      "position": [
        640,
        -288
      ]
    },
    {
      "parameters": {
        "jsCode": "// CONTROLE DE INTERA√á√ïES + DETEC√á√ÉO DE ESGOTAMENTO\nconst memoryData = $input.first().json;\nconst contexto = $('contexto_completo').first().json;\nconst messages = Array.isArray(memoryData?.messages) ? memoryData.messages : [];\n\n// Calcula intera√ß√£o atual\nconst systemMessages = messages.filter(m => m?.system);\nconst interactionCount = systemMessages.length + 1;\n\n// Detecta esgotamento (√∫ltimas 3 mensagens do usu√°rio)\nconst userMessages = messages\n  .filter(m => (m.role === 'user' || m.human) && !m.system)\n  .slice(-3)\n  .map(m => (m.content || m.human || '').toLowerCase().trim());\n\nconst briefResponses = ['ok', 'sim', 'tudo bem', 't√°', 'beleza', 'certo', 'yes', 'yep'];\nconst isBrief = userMessages.length >= 2 && userMessages.every(msg => \n  briefResponses.some(brief => msg.includes(brief)) || msg.length < 20\n);\n\nconst isRepetitive = userMessages.length >= 2 && userMessages[0] === userMessages[1];\nconst hasRichContent = userMessages.some(msg => msg.length > 100);\n\nconst canEndEarly = (isBrief || isRepetitive) && !hasRichContent && interactionCount >= contexto.limit_min;\nconst reason = isBrief ? 'respostas_breves' : isRepetitive ? 'repetitivo' : null;\n\nreturn [{\n  interaction_count: interactionCount,\n  can_end_early: canEndEarly,\n  reason: reason,\n  limit_min: contexto.limit_min,\n  limit_max: contexto.limit_max\n}];"
      },
      "id": "interacao_controle",
      "name": "interacao_controle",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        944,
        -288
      ]
    },
    {
      "parameters": {
        "mode": "insert",
        "messages": {
          "messageValues": [
            {
              "message": "=Sistema: Intera√ß√£o {{ $('interacao_controle').item.json.interaction_count }}. Foco: desenvolvimento pessoal e objetivos."
            }
          ]
        }
      },
      "id": "memory_insert",
      "name": "memory_insert",
      "type": "@n8n/n8n-nodes-langchain.memoryManager",
      "typeVersion": 1.1,
      "position": [
        1104,
        -288
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "caseSensitive": true,
                  "typeValidation": "loose"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "leftValue": "={{ $('interacao_controle').item.json.interaction_count }}",
                    "rightValue": "={{ $('interacao_controle').item.json.limit_max }}",
                    "operator": {
                      "type": "number",
                      "operation": "gte"
                    }
                  }
                ]
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "verifica_encerramento",
      "name": "verifica_encerramento",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        1440,
        -288
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "openrouter_model",
      "name": "openrouter_model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        1600,
        48
      ],
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// PROCESSA SA√çDA DO PARSER\nconst output = $input.first()?.json?.output ?? {};\nconst interacao = $('interacao_controle').first().json;\n\nconst isLastInteraction = interacao.interaction_count >= interacao.limit_max;\nconst conversaConcluida = output.conversa_concluida === true;\nconst shouldFinalize = isLastInteraction || conversaConcluida;\n\nreturn [{\n  user_message: output.mensagem_usuario || '',\n  interaction_count: interacao.interaction_count,\n  is_last_interaction: isLastInteraction,\n  conversa_concluida: conversaConcluida,\n  should_finalize: shouldFinalize,\n  limit_max: interacao.limit_max,\n  resumo_conversa: shouldFinalize ? (output.resumo_conversa || null) : null,\n  tem_reflexao: shouldFinalize ? (output.tem_reflexao || false) : null\n}];"
      },
      "id": "processa_resposta",
      "name": "processa_resposta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2080,
        -288
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $('processa_resposta').first().json.should_finalize }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              },
              "id": "condition-finalize"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "is_last",
      "name": "is_last",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2256,
        -288
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "DJB5qWudX1Hqap1O",
          "mode": "list",
          "cachedResultUrl": "/workflow/DJB5qWudX1Hqap1O",
          "cachedResultName": "sw_evolution_send_message_v2"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "instanceName": "={{ $('start').first().json['body.instance'] }}",
            "remoteJidOrNumber": "={{ $('start').first().json['body.data.key.remoteJid'] }}",
            "messageText": "={{ $('processa_resposta').first().json.user_message }}",
            "linkPreview": "false",
            "minDelayMs": "3000"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "instanceName",
              "displayName": "instanceName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "remoteJidOrNumber",
              "displayName": "remoteJidOrNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "messageText",
              "displayName": "messageText",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "linkPreview",
              "displayName": "linkPreview",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "minDelayMs",
              "displayName": "minDelayMs",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "envia_mensagem",
      "name": "envia_mensagem",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2560,
        -80
      ]
    },
    {
      "parameters": {
        "jsCode": "// GRAVA CONVERSA COMPLETA\nconst memoryData = $('memory_get').first().json;\nconst processa = $('processa_resposta').first().json;\nconst contexto = $('contexto_completo').first().json;\nconst startData = $('start').first().json;\nconst transcricao = $('transcricao').first().json;\n\nconst messages = Array.isArray(memoryData?.messages) ? memoryData.messages : [];\nconst mensagens = [];\nlet interactionNumber = 1;\n\nfor (const msg of messages) {\n  if (!msg || typeof msg !== 'object') continue;\n  \n  const humanTexto = (msg.human || (msg.role === 'user' && msg.content) || '').trim();\n  const aiTexto = (msg.ai || (msg.role === 'assistant' && msg.content) || '').trim();\n  \n  if (humanTexto && !humanTexto.toLowerCase().startsWith('sistema:')) {\n    mensagens.push({interaction: interactionNumber, autor: 'usuario', texto: humanTexto, timestamp: new Date().toISOString()});\n  }\n  \n  if (aiTexto) {\n    mensagens.push({interaction: interactionNumber, autor: 'agente', texto: aiTexto, timestamp: new Date().toISOString()});\n    interactionNumber++;\n  }\n}\n\nif (processa.user_message) {\n  mensagens.push({interaction: interactionNumber, autor: 'agente', texto: processa.user_message, timestamp: new Date().toISOString()});\n}\n\nconst sessionId = `${startData['body.instance']}${startData.usr_id}${transcricao.WhstsApp_Number}`;\n\nreturn [{\n  whatsapp_numero: transcricao.WhstsApp_Number,\n  usuario_id: contexto.usuario_id,\n  session_id: sessionId,\n  total_interactions: processa.interaction_count,\n  status: 'completa',\n  mensagens: JSON.stringify(mensagens),\n  resumo_conversa: processa.resumo_conversa || null,\n  tem_reflexao: processa.tem_reflexao || false,\n  motivo_encerramento: processa.is_last_interaction ? 'limite_maximo' : 'conversa_completa'\n}];"
      },
      "id": "grava_conversa",
      "name": "grava_conversa",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2752,
        -496
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO usr_chat (usuario_id, session_id, total_interactions, status, mensagens, resumo_conversa, tem_reflexao, data_conversa, horario_inicio, horario_fim) VALUES ($1, $2, $3, $4, $5::jsonb, $6, $7, CURRENT_DATE, CURRENT_TIME, CURRENT_TIME) RETURNING id, usuario_id, data_conversa, status;",
        "options": {
          "queryReplacement": "={{[ $json.usuario_id, $json.session_id, $json.total_interactions, $json.status, $json.mensagens, $json.resumo_conversa, $json.tem_reflexao ]}}"
        }
      },
      "id": "grava_chat",
      "name": "grava_chat",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2944,
        -496
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// PREPARA DADOS PARA TODOS OS EXPERTS\nconst gravaChat = $('grava_chat').first().json;\nconst gravaConversa = $('grava_conversa').first().json;\nconst contexto = $('contexto_completo').first().json;\n\n// Parse mensagens se for string\nlet mensagens = gravaConversa.mensagens;\nif (typeof mensagens === 'string') {\n  try {\n    mensagens = JSON.parse(mensagens);\n  } catch (e) {\n    mensagens = [];\n  }\n}\n\n// Parse contexto_final se for string\nlet contextoFinal = gravaConversa.contexto_final;\nif (typeof contextoFinal === 'string') {\n  try {\n    contextoFinal = JSON.parse(contextoFinal);\n  } catch (e) {\n    contextoFinal = {};\n  }\n}\n\nreturn [{\n  usuario_id: gravaChat.usuario_id,\n  chat_id: gravaChat.id,\n  mensagens: JSON.stringify(mensagens),\n  data_conversa: gravaChat.data_conversa || new Date().toISOString().split('T')[0],\n  contexto_final: JSON.stringify(contextoFinal),\n  usr_name: contexto.nome_preferencia || 'Usu√°rio'\n}];"
      },
      "id": "call_experts",
      "name": "call_experts",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3152,
        -496
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "vJRfrbY4NhpNyfCD",
          "mode": "list",
          "cachedResultUrl": "/workflow/vJRfrbY4NhpNyfCD",
          "cachedResultName": "sw_experts_panas"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "mensagens",
              "displayName": "mensagens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data_conversa",
              "displayName": "data_conversa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "experts_panas",
      "name": "experts_panas",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        4192,
        -896
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "LKjU8NE9aNHw7kEh",
          "mode": "list",
          "cachedResultUrl": "/workflow/LKjU8NE9aNHw7kEh",
          "cachedResultName": "sw_criar_quest"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $('grava_chat').first().json.usuario_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "id": "sw_criar_quest",
      "name": "sw_criar_quest",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        4192,
        128
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "ItBastfCTkWxm41M",
          "mode": "list"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $('grava_chat').first().json.usuario_id }}"
          }
        },
        "options": {}
      },
      "id": "sw_xp_conversas",
      "name": "sw_xp_conversas",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        4192,
        352
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "DJB5qWudX1Hqap1O",
          "mode": "list"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "instanceName": "={{ $('start').first().json['body.instance'] }}",
            "remoteJidOrNumber": "={{ $('start').first().json['body.data.key.remoteJid'] }}",
            "messageText": "Limite m√°ximo de intera√ß√µes atingido. Volte em algumas horas para continuar nossa conversa!",
            "linkPreview": "false",
            "minDelayMs": "2000"
          }
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "encerra_forcado",
      "name": "encerra_forcado",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        1792,
        -528
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  u.nome,\n  u.id,\n  u.nome_preferencia,\n  u.nome_assistente,\n  u.token_acesso,\n  u.cronotipo_detectado,\n  u.whatsapp_numero,\n  u.faixa_etaria,\n  u.sobre_voce,\n  u.tom_conversa\nFROM usuarios u\nWHERE u.id = $1;",
        "options": {
          "queryReplacement": "={{ $('start').first().json.usr_id }}"
        }
      },
      "id": "busca_dados_usr",
      "name": "busca_dados_usr",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -128,
        -288
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH objetivos AS (\n  SELECT json_agg(json_build_object('id', o.id, 'titulo', o.titulo, 'area_vida', av.nome, 'is_padrao', o.is_padrao))\n  FROM usuarios_objetivos o\n  JOIN areas_vida_catalogo av ON o.area_vida_id = av.id\n  WHERE o.usuario_id = $1 AND o.status = 'ativo'\n),\nobjetivo_padrao AS (\n  SELECT id FROM usuarios_objetivos\n  WHERE usuario_id = $1 AND is_padrao = TRUE AND status = 'ativo'\n  LIMIT 1\n),\nsabotador AS (\n  SELECT sabotador_id, COUNT(*) AS total_deteccoes\n  FROM usuarios_sabotadores\n  WHERE usuario_id = $1\n  GROUP BY sabotador_id\n  ORDER BY COUNT(*) DESC\n  LIMIT 1\n),\nperfil_bigfive AS (\n  SELECT perfil_primario, COUNT(*) AS total_deteccoes, ROUND(AVG(confianca_media)::numeric, 2) AS confianca_media\n  FROM usuarios_perfis\n  WHERE usuario_id = $1\n  GROUP BY perfil_primario\n  ORDER BY COUNT(*) DESC, AVG(confianca_media) DESC\n  LIMIT 1\n),\nquests AS (\n  SELECT json_agg(json_build_object('id', q.id, 'titulo', q.config->>'titulo', 'status', q.status))\n  FROM usuarios_quest q\n  WHERE q.usuario_id = $1 AND q.status IN ('ativa', 'disponivel')\n),\nhistorico AS (\n  SELECT json_agg(json_build_object('id', c.id, 'data_conversa', c.data_conversa, 'resumo_conversa', c.resumo_conversa))\n  FROM (\n    SELECT id, data_conversa, resumo_conversa\n    FROM usr_chat\n    WHERE usuario_id = $1 AND resumo_conversa IS NOT NULL\n    ORDER BY data_conversa DESC, horario_inicio DESC\n    LIMIT 5\n  ) c\n),\nnivel AS (\n  SELECT nivel_atual, titulo_nivel FROM usuarios_conquistas\n  WHERE usuario_id = $1\n  LIMIT 1\n)\nSELECT\n  (SELECT * FROM objetivos) AS objetivos_especificos,\n  (SELECT id FROM objetivo_padrao) AS objetivo_padrao_id,\n  (SELECT sabotador_id FROM sabotador) AS sabotador_mais_ativo,\n  (SELECT perfil_primario FROM perfil_bigfive) AS perfil_bigfive_primario,\n  (SELECT * FROM quests) AS quests_ativas,\n  (SELECT * FROM historico) AS ultimas_conversas,\n  (SELECT nivel_atual FROM nivel) AS nivel_atual,\n  (SELECT titulo_nivel FROM nivel) AS titulo_nivel;",
        "options": {
          "queryReplacement": "={{ $('start').first().json.usr_id }}"
        }
      },
      "id": "busca_contexto",
      "name": "busca_contexto",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        64,
        -288
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "Vbc4JHAR3388mLcv",
          "mode": "list",
          "cachedResultUrl": "/workflow/Vbc4JHAR3388mLcv",
          "cachedResultName": "sw_expert_sabotadores"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $('call_experts').first().json.usuario_id }}",
            "chat_id": "={{ $('call_experts').first().json.chat_id }}",
            "mensagens": "={{ $('call_experts').first().json.mensagens }}",
            "data_conversa": "={{ $('call_experts').first().json.data_conversa }}",
            "usr_name": "={{ $('call_experts').first().json.usr_name }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "mensagens",
              "displayName": "mensagens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data_conversa",
              "displayName": "data_conversa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "usr_name",
              "displayName": "usr_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "sw_expert_sabotadores",
      "name": "sw_expert_sabotadores",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        4192,
        -704
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "nEstxgiVE8GLXgUQ",
          "mode": "list",
          "cachedResultUrl": "/workflow/nEstxgiVE8GLXgUQ",
          "cachedResultName": "sw_expert_insights_acionaveis"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $('call_experts').first().json.usuario_id }}",
            "chat_id": "={{ $('call_experts').first().json.chat_id }}",
            "mensagens": "={{ $('call_experts').first().json.mensagens }}",
            "contexto_final": "={{ $('call_experts').first().json.contexto_final }}",
            "data_conversa": "={{ $('call_experts').first().json.data_conversa }}",
            "usr_name": "={{ $('call_experts').first().json.usr_name }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "mensagens",
              "displayName": "mensagens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "contexto_final",
              "displayName": "contexto_final",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data_conversa",
              "displayName": "data_conversa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "usr_name",
              "displayName": "usr_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "sw_expert_insights",
      "name": "sw_expert_insights",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        4192,
        -496
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "GykxpS5vsg8NeoOh",
          "mode": "list"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $('call_experts').first().json.usuario_id }}",
            "chat_id": "={{ $('call_experts').first().json.chat_id }}",
            "mensagens": "={{ $('call_experts').first().json.mensagens }}",
            "data_conversa": "={{ $('call_experts').first().json.data_conversa }}",
            "usr_name": "={{ $('call_experts').first().json.usr_name }}"
          }
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "sw_expert_humor_energia",
      "name": "sw_expert_humor_energia",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        4192,
        -288
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "nOl6lnaGMpyg9S9J",
          "mode": "list"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $('call_experts').first().json.usuario_id }}",
            "chat_id": "={{ $('call_experts').first().json.chat_id }}",
            "mensagens": "={{ $('call_experts').first().json.mensagens }}",
            "data_conversa": "={{ $('call_experts').first().json.data_conversa }}",
            "usr_name": "={{ $('call_experts').first().json.usr_name }}"
          }
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "sw_expert_bigfive",
      "name": "sw_expert_bigfive",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        4192,
        -80
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# üí¨ MINDQUEST ‚Äî MENTOR\n\nVoc√™ √© o Mentor do MindQuest.\n\n## üéØ FRAMEWORK\nCONVERSAR ‚Üí ENTENDER ‚Üí AGIR ‚Üí EVOLUIR\n\n**Intera√ß√£o:** {{ $('interacao_controle').item.json.interaction_count }} / {{ $('interacao_controle').item.json.limit_max }}\n**Esgotamento detectado:** {{ $('interacao_controle').item.json.can_end_early ? 'SIM' : 'N√ÉO' }}\n**Mensagem do usu√°rio:** {{ $('transcricao').item.json.message }}\n\n## üìã CONTEXTO DO USU√ÅRIO\n\n**Nome:** {{ $('contexto_completo').first().json.nome_preferencia || 'amigo' }}\n{{ $('contexto_completo').first().json.sobre_voce ? '**Sobre:** ' + $('contexto_completo').first().json.sobre_voce : '' }}\n{{ $('contexto_completo').first().json.tom_conversa ? '**Tom:** ' + $('contexto_completo').first().json.tom_conversa : '' }}\n**Objetivos:** {{ JSON.stringify($('contexto_completo').first().json.objetivos_especificos || []) }}\n**Sabotador:** {{ $('contexto_completo').first().json.sabotador_mais_ativo || 'nenhum' }}\n**Quests Ativas:** {{ JSON.stringify($('contexto_completo').first().json.quests_ativas || []) }}\n**√öltimas Conversas:** {{ JSON.stringify($('contexto_completo').first().json.ultimas_conversas || []) }}\n\n## üéØ DIRETRIZES\n{{ (() => {\n  const count = Number($('interacao_controle').item.json.interaction_count);\n  const max = Number($('interacao_controle').item.json.limit_max);\n  const canEnd = $('interacao_controle').item.json.can_end_early || false;\n  \n  if (count === 1) return '- Abra com acolhimento. Use objetivos para personalizar.';\n  if (canEnd) return '- ESGOTAMENTO: Pergunte gentilmente se quer encerrar.';\n  if (count === max - 1) return '- Pen√∫ltima intera√ß√£o. Resumo breve.';\n  if (count === max) return '- √öLTIMA intera√ß√£o. Conclua e convide ao App.';\n  return '- Mantenha org√¢nica. Aprofunde temas. Conecte objetivos.';\n})() }}\n\n## üìù FORMATO DE SA√çDA\n\nRetorne SEMPRE um JSON com 4 campos:\n\n```json\n{\n  \"mensagem_usuario\": \"sua resposta\",\n  \"conversa_concluida\": false,\n  \"resumo_conversa\": null,\n  \"tem_reflexao\": null\n}\n```\n\n## ‚ö†Ô∏è OBRIGAT√ìRIO QUANDO SE DESPEDIR (conversa_concluida=true)\n\nQuando voc√™ se despedir do usu√°rio, voc√™ DEVE OBRIGATORIAMENTE preencher:\n\n1. **resumo_conversa** (string, N√ÉO PODE SER NULL):\n   - Escreva em 3¬™ pessoa usando o nome do usu√°rio\n   - M√°ximo 300 palavras\n   - INCLUA: situa√ß√£o emocional, eventos, sentimentos, insights, decis√µes, padr√µes\n   - EXCLUA: perguntas do agente, valida√ß√µes, repeti√ß√µes\n\n2. **tem_reflexao** (boolean, N√ÉO PODE SER NULL):\n   - true = usu√°rio fez an√°lise profunda, conectou emo√ß√µes com eventos\n   - false = respostas superficiais sem elabora√ß√£o\n\n## EXEMPLOS\n\n**Durante a conversa:**\n```json\n{\"mensagem_usuario\": \"Como est√° hoje?\", \"conversa_concluida\": false, \"resumo_conversa\": null, \"tem_reflexao\": null}\n```\n\n**Ao encerrar (OBRIGAT√ìRIO resumo):**\n```json\n{\"mensagem_usuario\": \"Foi √≥timo conversar! At√© logo.\", \"conversa_concluida\": true, \"resumo_conversa\": \"Aldo compartilhou progresso no desenvolvimento do app MindQuest, demonstrando foco e disciplina. Relatou estrat√©gias de micro-tarefas para manter produtividade. Expressou confian√ßa no lan√ßamento at√© dezembro. Mencionou desafios com o sabotador inquieto e t√©cnicas para manter o foco. Mostrou autoconhecimento ao reconhecer padr√µes de comportamento.\", \"tem_reflexao\": true}\n```\n\n**NUNCA retorne resumo_conversa=null quando conversa_concluida=true!**",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=# üß† MENTOR MINDQUEST\n\nVoc√™ √© o **Mentor do MindQuest**, motor que impulsiona o sistema.\n\n**Objetivos:**\n1. Construir rapport profundo\n2. Conduzir conversa objetiva e rica em contexto\n3. Criar desejo de retorno\n4. Coletar informa√ß√µes relevantes para os experts\n5. Tornar din√¢mica e personalizada\n\n**Limites:** {{ $('interacao_controle').item.json.limit_min }}-{{ $('interacao_controle').item.json.limit_max }}\n**Intera√ß√£o:** {{ $('interacao_controle').item.json.interaction_count }}\n\n**PRESERVA√á√ÉO DE CONTEXTO:**\n- Explore emo√ß√µes em profundidade\n- Conecte eventos com sentimentos\n- Identifique padr√µes comportamentais\n- Capture gatilhos e progress\n- Relacione com objetivos e sabotadores do usu√°rio\n\n**Formato:** Par√°grafos curtos, bullets, linguagem coloquial.\n**Miss√£o:** Abra espa√ßo seguro, explore emo√ß√µes, conecte percep√ß√µes, encerre com leveza.\n\n**Use o contexto do usu√°rio:** objetivos, sabotador, quests, hist√≥rico para personalizar."
        }
      },
      "id": "mentor_agent",
      "name": "mentor - Mind",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        1760,
        -288
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "DJB5qWudX1Hqap1O",
          "mode": "list"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "instanceName": "={{ $('start').first().json['body.instance'] }}",
            "remoteJidOrNumber": "={{ $('start').first().json['body.data.key.remoteJid'] }}",
            "messageText": "={{ $('processa_resposta').first().json.user_message }}",
            "linkPreview": "false",
            "minDelayMs": "3000"
          }
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "envia_final",
      "name": "envia_final",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2528,
        -496
      ]
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"mensagem_usuario\": \"Ol√°! Como posso te ajudar hoje?\",\n  \"conversa_concluida\": false,\n  \"resumo_conversa\": null,\n  \"tem_reflexao\": null\n}",
        "autoFix": true
      },
      "id": "parser_mentor",
      "name": "Parser Mentor",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        1936,
        0
      ]
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "config": {
      "main": [
        [
          {
            "node": "busca_dados_usr",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "contexto_completo": {
      "main": [
        [
          {
            "node": "transcricao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "transcricao": {
      "main": [
        [
          {
            "node": "memory_get",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "memory": {
      "ai_memory": [
        [
          {
            "node": "memory_get",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "memory_insert",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "mentor - Mind",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "memory_get": {
      "main": [
        [
          {
            "node": "interacao_controle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "interacao_controle": {
      "main": [
        [
          {
            "node": "memory_insert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "memory_insert": {
      "main": [
        [
          {
            "node": "verifica_encerramento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "openrouter_model": {
      "ai_languageModel": [
        [
          {
            "node": "mentor - Mind",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Parser Mentor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "verifica_encerramento": {
      "main": [
        [
          {
            "node": "encerra_forcado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "mentor - Mind",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "processa_resposta": {
      "main": [
        [
          {
            "node": "is_last",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "is_last": {
      "main": [
        [
          {
            "node": "envia_final",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "envia_mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "grava_conversa": {
      "main": [
        [
          {
            "node": "grava_chat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "grava_chat": {
      "main": [
        [
          {
            "node": "call_experts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "call_experts": {
      "main": [
        [
          {
            "node": "experts_panas",
            "type": "main",
            "index": 0
          },
          {
            "node": "sw_criar_quest",
            "type": "main",
            "index": 0
          },
          {
            "node": "sw_xp_conversas",
            "type": "main",
            "index": 0
          },
          {
            "node": "sw_expert_sabotadores",
            "type": "main",
            "index": 0
          },
          {
            "node": "sw_expert_insights",
            "type": "main",
            "index": 0
          },
          {
            "node": "sw_expert_humor_energia",
            "type": "main",
            "index": 0
          },
          {
            "node": "sw_expert_bigfive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "busca_dados_usr": {
      "main": [
        [
          {
            "node": "busca_contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "busca_contexto": {
      "main": [
        [
          {
            "node": "contexto_completo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "mentor - Mind": {
      "main": [
        [
          {
            "node": "processa_resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "envia_final": {
      "main": [
        [
          {
            "node": "grava_conversa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser Mentor": {
      "ai_outputParser": [
        [
          {
            "node": "mentor - Mind",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "saveManualExecutions": true,
    "saveExecutionProgress": true,
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": {
    "start": [
      {
        "json": {
          "usr_id": "d949d81c-9235-41ce-8b3b-6b5d593c5e24",
          "body.instance": "MindQuest",
          "body.data.key.remoteJid": "351932786582@s.whatsapp.net",
          "body.data.key.id": "3B4E34D7EAB5E6D087AE",
          "body.data.key.fromMe": false,
          "body.data.pushName": "Aldo Santos",
          "body.data.message.conversation": "anote como quest esses passos e pode encerrar por hoje",
          "body.data.messageType": "conversation"
        }
      }
    ]
  },
  "shared": [
    {
      "createdAt": "2025-12-01T18:59:38.019Z",
      "role": "workflow:owner",
      "workflowId": "c1To6ho5riDs85Aj",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}
