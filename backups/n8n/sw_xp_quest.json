{
  "createdAt": "2025-11-07T16:03:52.061Z",
  "id": "bTeLj5qOKQo9PDMO",
  "name": "sw_xp_quest",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usuario_id"
            },
            {
              "name": "quests_personalizadas"
            },
            {
              "name": "atualizacoes_status"
            }
          ]
        }
      },
      "id": "f8168b55-9298-4008-9df3-aba50c4e5c19",
      "name": "start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -1264,
        -176
      ]
    },
    {
      "parameters": {
        "jsCode": "const item = $input.item.json || {};\n\nconst parseList = (value) => {\n  if (!value) return [];\n  if (Array.isArray(value)) return value;\n  if (typeof value === 'string') {\n    try {\n      const parsed = JSON.parse(value);\n      if (Array.isArray(parsed)) return parsed;\n    } catch (error) {}\n  }\n  return [];\n};\n\nconst usuarioId = item.usuario_id;\nif (!usuarioId) {\n  throw new Error('usuario_id obrigatório');\n}\n\nconst quests = parseList(item.quests_personalizadas);\nconst updates = parseList(item.atualizacoes_status);\n\nreturn [{\n  json: {\n    usuario_id: usuarioId,\n    novas_quests: quests,\n    atualizacoes: updates\n  }\n}];"
      },
      "id": "ca52ad0b-4880-4eb2-be02-c1620a6aea59",
      "name": "Normalizar Entrada",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1040,
        -176
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "71Ru87yaRA5SNjOQ",
          "mode": "list",
          "cachedResultUrl": "/workflow/71Ru87yaRA5SNjOQ",
          "cachedResultName": "sw_calcula_jornada"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $json.usuario_id }}"
          },
          "matchingColumns": [
            "usuario_id"
          ],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "dab1393f-2db8-42f4-83c7-2057891754ee",
      "name": "Atualizar Jornada",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        528,
        -176
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH existentes AS (\n  SELECT\n    qa.id,\n    qa.meta_codigo,\n    qa.status,\n    COALESCE(qa.contexto_origem, '') AS contexto_origem,\n    qa.progresso_meta,\n    qa.progresso_atual,\n    qt.titulo,\n    qt.descricao,\n    qt.config,\n    qa.area_vida_id,\n    qa.sabotador_id,\n    qa.insight_id,\n    qa.complexidade\n  FROM public.usuarios_quest qa\n  JOIN public.metas_catalogo qt ON qt.id = qa.modelo_id\n  WHERE qa.usuario_id = $1::uuid\n    AND qt.tipo = 'personalizada'\n    AND qa.status IN ('pendente','ativa')\n)\nSELECT\n  rj.usuario_id,\n  rj.nivel_atual,\n  rj.titulo_nivel,\n  rj.xp_total,\n  rj.meta_sequencia_codigo,\n  rj.proxima_meta_codigo,\n  rj.sequencia_status,\n  COALESCE(\n    jsonb_agg(\n      jsonb_build_object(\n        'instancia_id', existentes.id,\n        'meta_codigo', existentes.meta_codigo,\n        'status', existentes.status,\n        'contexto_origem', existentes.contexto_origem,\n        'progresso_meta', existentes.progresso_meta,\n        'progresso_atual', existentes.progresso_atual,\n        'titulo', existentes.titulo,\n        'descricao', existentes.descricao,\n        'config', existentes.config,\n        'area_vida_id', existentes.area_vida_id,\n        'sabotador_id', existentes.sabotador_id,\n        'insight_id', existentes.insight_id,\n        'complexidade', existentes.complexidade\n      )\n    ) FILTER (WHERE existentes.id IS NOT NULL),\n    '[]'::jsonb\n  ) AS quests_ativas\nFROM public.usuarios_conquistas rj\nLEFT JOIN existentes ON TRUE\nWHERE rj.usuario_id = $1::uuid\nGROUP BY\n  rj.usuario_id,\n  rj.nivel_atual,\n  rj.titulo_nivel,\n  rj.xp_total,\n  rj.meta_sequencia_codigo,\n  rj.proxima_meta_codigo,\n  rj.sequencia_status;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id] }}"
        }
      },
      "id": "82e45a1e-bb80-4ef0-a7aa-42937394f08c",
      "name": "Buscar Estado e Quests",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -816,
        -176
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "\nconst entradaLista = $items(\"Normalizar Entrada\") || [];\nconst entrada = (entradaLista[0] && entradaLista[0].json) || {};\nconst estado = $input.item.json || {};\n\nconst existentesBrutos = Array.isArray(estado.quests_ativas)\n  ? estado.quests_ativas\n  : [];\n\nconst limite = 4;\nlet ocupados = Array.isArray(existentesBrutos)\n  ? existentesBrutos.length\n  : Number(existentesBrutos?.length) || 0;\n\nif (!Number.isFinite(ocupados)) {\n  ocupados = 0;\n}\n\nlet slotsDisponiveis = limite - ocupados;\nif (!Number.isFinite(slotsDisponiveis)) {\n  slotsDisponiveis = limite;\n}\nif (slotsDisponiveis < 0) {\n  slotsDisponiveis = 0;\n}\n\nconst dedupe = new Set();\nfor (const existente of existentesBrutos) {\n  const contexto = (existente?.contexto_origem || '').toLowerCase().trim();\n  const titulo = (existente?.titulo || '').toLowerCase().trim();\n  if (contexto || titulo) {\n    dedupe.add(`${contexto}|${titulo}`);\n  }\n}\n\nconst normalizeUuid = (value) => {\n  if (typeof value !== 'string') return null;\n  const trimmed = value.trim();\n  if (!trimmed) return null;\n  const uuidRegex = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;\n  return uuidRegex.test(trimmed) ? trimmed : null;\n};\n\nconst normalizeTextId = (value) => {\n  if (value == null) return null;\n  const text = String(value).trim();\n  return text || null;\n};\n\nconst clampComplexidade = (value) => {\n  const num = Number(value);\n  if (!Number.isFinite(num)) return 0;\n  if (num < 0) return 0;\n  if (num > 5) return 5;\n  return Math.round(num);\n};\n\nconst entradaListaBruta = Array.isArray(entrada.novas_quests)\n  ? entrada.novas_quests\n  : (typeof entrada.novas_quests === 'string'\n      ? (() => {\n          try {\n            const parsed = JSON.parse(entrada.novas_quests);\n            return Array.isArray(parsed) ? parsed : [];\n          } catch (error) {\n            return [];\n          }\n        })()\n      : []);\n\nconst novos = [];\nconst filaEspera = [];\n\nconst normalizarInteiro = (valor, padrao) => {\n  const numero = Number(valor);\n  if (Number.isFinite(numero) && numero > 0) {\n    return Math.trunc(numero);\n  }\n  return padrao;\n};\n\nfor (const bruto of entradaListaBruta) {\n  if (bruto == null) continue;\n\n  const quest =\n    typeof bruto === 'string'\n      ? (() => {\n          try {\n            return JSON.parse(bruto);\n          } catch (error) {\n            return null;\n          }\n        })()\n      : bruto;\n\n  if (!quest || typeof quest !== 'object') continue;\n\n  const contexto = (quest.contexto_origem || '').toLowerCase().trim();\n  const titulo = (quest.titulo || '').toLowerCase().trim();\n  const temIdentificador = contexto || titulo;\n  const chaveDedup = temIdentificador ? `${contexto}|${titulo}` : null;\n\n  if (chaveDedup && dedupe.has(chaveDedup)) {\n    continue;\n  }\n\n  const areaVidaId = normalizeUuid(quest.area_vida_id);\n  if (!areaVidaId) {\n    continue;\n  }\n\n  const sabotadorId = normalizeTextId(quest.sabotador_id);\n  const complexidade = clampComplexidade(quest.complexidade);\n\n  const codigoBase = quest.codigo && String(quest.codigo).trim();\n  const codigo =\n    codigoBase && codigoBase.length > 0\n      ? codigoBase\n      : `qp_${Date.now()}_${Math.random().toString(16).slice(2, 8)}`;\n\n  const questNormalizada = {\n    ...quest,\n    codigo,\n    prioridade: quest.prioridade || 'media',\n    recorrencia: quest.recorrencia || 'unica',\n    status_inicial: quest.status_inicial || 'pendente',\n    progresso_meta: normalizarInteiro(quest.progresso_meta, 1),\n    xp_recompensa: normalizarInteiro(quest.xp_recompensa, 0),\n    area_vida_id: areaVidaId,\n    sabotador_id: sabotadorId,\n    complexidade,\n  };\n\n  if (chaveDedup) {\n    dedupe.add(chaveDedup);\n  }\n\n  if (slotsDisponiveis > 0) {\n    novos.push(questNormalizada);\n    slotsDisponiveis -= 1;\n  } else {\n    filaEspera.push(questNormalizada);\n  }\n}\n\nreturn [\n  {\n    json: {\n      usuario_id: entrada.usuario_id,\n      novas_quests: novos,\n      atualizacoes: Array.isArray(entrada.atualizacoes)\n        ? entrada.atualizacoes\n        : [],\n      estado_inicial: estado,\n      fila_espera: filaEspera,\n      debug_entrada_bruta: entrada.novas_quests,\n      debug_entrada_normalizada: entradaListaBruta,\n    },\n  },\n];\n"
      },
      "id": "c9decfd5-efbe-4cf6-b6c1-dd49cbfb6b73",
      "name": "Preparar Operacoes",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -592,
        -176
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH payload AS (\n  SELECT\n    $1::uuid AS usuario_id,\n    $2::jsonb AS novas_quests,\n    $3::jsonb AS atualizacoes,\n    $4::jsonb AS estado_inicial\n),\nrows AS (\n  SELECT\n    (rec->>'codigo')::text AS codigo,\n    rec->>'titulo' AS titulo,\n    rec->>'descricao' AS descricao,\n    rec->>'contexto_origem' AS contexto_origem,\n    rec->>'prioridade' AS prioridade,\n    rec->>'recorrencia' AS recorrencia,\n    (rec->>'prazo_inicio')::date AS prazo_inicio,\n    (rec->>'prazo_fim')::date AS prazo_fim,\n    COALESCE((rec->>'progresso_meta')::int, 1) AS progresso_meta,\n    rec->>'status_inicial' AS status_inicial,\n    COALESCE((rec->>'xp_recompensa')::int, 0) AS xp_recompensa,\n    COALESCE(rec->'payload_extra', '{}'::jsonb) AS payload_extra,\n    NULLIF(rec->>'area_vida_id', '')::uuid AS area_vida_id,\n    NULLIF(rec->>'sabotador_id', '') AS sabotador_id,\n    CASE\n      WHEN EXISTS (\n        SELECT 1\n        FROM public.insights i\n        WHERE i.id = NULLIF(rec->>'insight_id', '')::uuid\n      ) THEN NULLIF(rec->>'insight_id', '')::uuid\n      ELSE NULL\n    END AS insight_id,\n    COALESCE((rec->>'complexidade')::smallint, 0) AS complexidade\n  FROM payload,\n       jsonb_array_elements(payload.novas_quests) rec\n),\nupsert AS (\n  INSERT INTO public.metas_catalogo (\n    id,\n    codigo,\n    titulo,\n    descricao,\n    tipo,\n    gatilho_codigo,\n    gatilho_valor,\n    xp_recompensa,\n    repeticao,\n    ordem_inicial,\n    ativo,\n    area_vida_id,\n    sabotador_id,\n    insight_id,\n    complexidade,\n    config,\n    criado_em,\n    atualizado_em\n  )\n  SELECT\n    gen_random_uuid(),\n    COALESCE(NULLIF(rows.codigo, ''), 'quest_' || encode(gen_random_bytes(6), 'hex')),\n    COALESCE(rows.titulo, 'Quest Personalizada'),\n    rows.descricao,\n    'personalizada',\n    'manual',\n    rows.progresso_meta,\n    rows.xp_recompensa,\n    CASE rows.recorrencia WHEN 'diaria' THEN 'recorrente' WHEN 'semanal' THEN 'recorrente' ELSE 'unica' END,\n    NULL,\n    TRUE,\n    rows.area_vida_id,\n    rows.sabotador_id,\n    rows.insight_id,\n    rows.complexidade,\n    jsonb_build_object(\n      'prioridade', rows.prioridade,\n      'recurrencia', rows.recorrencia,\n      'payload_extra', rows.payload_extra,\n      'area_vida_id', rows.area_vida_id::text,\n      'sabotador_id', rows.sabotador_id,\n      'insight_id', rows.insight_id::text,\n      'complexidade', rows.complexidade\n    ),\n    NOW(),\n    NOW()\n  FROM rows\n  ON CONFLICT (codigo) DO UPDATE\n  SET\n    titulo = EXCLUDED.titulo,\n    descricao = EXCLUDED.descricao,\n    gatilho_valor = EXCLUDED.gatilho_valor,\n    xp_recompensa = EXCLUDED.xp_recompensa,\n    repeticao = EXCLUDED.repeticao,\n    ativo = TRUE,\n    area_vida_id = EXCLUDED.area_vida_id,\n    sabotador_id = EXCLUDED.sabotador_id,\n    insight_id = EXCLUDED.insight_id,\n    complexidade = EXCLUDED.complexidade,\n    config = EXCLUDED.config,\n    atualizado_em = NOW()\n  RETURNING id, codigo\n)\nSELECT\n  payload.usuario_id,\n  payload.novas_quests,\n  payload.atualizacoes,\n  payload.estado_inicial,\n  COALESCE(jsonb_agg(jsonb_build_object('codigo', upsert.codigo, 'modelo_id', upsert.id)), '[]'::jsonb) AS modelos_upsertidos\nFROM payload\nLEFT JOIN upsert ON TRUE\nGROUP BY payload.usuario_id, payload.novas_quests, payload.atualizacoes, payload.estado_inicial;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id, JSON.stringify($json.novas_quests ?? []), JSON.stringify($json.atualizacoes ?? []), JSON.stringify($json.estado_inicial ?? {})] }}"
        }
      },
      "id": "ac58dccf-ba63-4859-82fd-03ab65c554b7",
      "name": "Inserir Modelos",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -384,
        -176
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH payload AS (\n  SELECT\n    $1::uuid AS usuario_id,\n    $2::jsonb AS novas_quests,\n    $3::jsonb AS atualizacoes,\n    $4::jsonb AS estado_inicial\n),\nrows AS (\n  SELECT\n    payload.usuario_id,\n    COALESCE(rec->>'codigo', '') AS codigo,\n    rec->>'status_inicial' AS status_inicial,\n    COALESCE((rec->>'progresso_meta')::int, 1) AS progresso_meta,\n    COALESCE((rec->>'xp_recompensa')::int, 0) AS xp_recompensa,\n    rec->>'contexto_origem' AS contexto_origem,\n    (rec->>'prazo_inicio')::date AS prazo_inicio,\n    (rec->>'prazo_fim')::date AS prazo_fim,\n    NULLIF(rec->>'area_vida_id', '')::uuid AS area_vida_id,\n    NULLIF(rec->>'sabotador_id', '') AS sabotador_id,\n    CASE\n      WHEN EXISTS (\n        SELECT 1\n        FROM public.insights i\n        WHERE i.id = NULLIF(rec->>'insight_id', '')::uuid\n      ) THEN NULLIF(rec->>'insight_id', '')::uuid\n      ELSE NULL\n    END AS insight_id,\n    COALESCE((rec->>'complexidade')::smallint, 0) AS complexidade\n  FROM payload,\n       jsonb_array_elements(payload.novas_quests) rec\n),\ninserted AS (\n  INSERT INTO public.usuarios_quest (\n    id,\n    usuario_id,\n    modelo_id,\n    meta_codigo,\n    status,\n    progresso_atual,\n    progresso_meta,\n    progresso_percentual,\n    xp_concedido,\n    tentativas,\n    janela_inicio,\n    janela_fim,\n    contexto_origem,\n    referencia_data,\n    reiniciada_em,\n    ativado_em,\n    atualizado_em,\n    concluido_em,\n    cancelado_em,\n    area_vida_id,\n    sabotador_id,\n    insight_id,\n    complexidade\n  )\n  SELECT\n    gen_random_uuid(),\n    rows.usuario_id,\n    qt.id,\n    rows.codigo,\n    COALESCE(NULLIF(rows.status_inicial, ''), 'pendente'),\n    0,\n    rows.progresso_meta,\n    0,\n    rows.xp_recompensa,\n    1,\n    rows.prazo_inicio,\n    rows.prazo_fim,\n    rows.contexto_origem,\n    rows.prazo_inicio,\n    NULL,\n    NOW(),\n    NOW(),\n    NULL,\n    NULL,\n    rows.area_vida_id,\n    rows.sabotador_id,\n    rows.insight_id,\n    rows.complexidade\n  FROM rows\n  JOIN public.metas_catalogo qt ON qt.codigo = rows.codigo\n  WHERE rows.codigo <> ''\n    AND NOT EXISTS (\n      SELECT 1\n      FROM public.usuarios_quest qa\n      WHERE qa.usuario_id = rows.usuario_id\n        AND qa.meta_codigo = rows.codigo\n        AND qa.status IN ('pendente','ativa')\n    )\n  RETURNING meta_codigo\n),\natualiza_estado AS (\n  UPDATE public.usuarios_conquistas\n  SET\n    total_quests_personalizadas = total_quests_personalizadas + (SELECT COUNT(*) FROM inserted),\n    atualizado_em = NOW()\n  WHERE usuario_id = (SELECT usuario_id FROM payload)\n  RETURNING total_quests_personalizadas\n)\nSELECT\n  payload.usuario_id,\n  payload.novas_quests,\n  payload.atualizacoes,\n  payload.estado_inicial,\n  COALESCE((SELECT COUNT(*) FROM inserted), 0) AS novas_inseridas,\n  COALESCE(jsonb_agg(inserted.meta_codigo), '[]'::jsonb) AS codigos_inseridos\nFROM payload\nLEFT JOIN inserted ON TRUE\nGROUP BY payload.usuario_id, payload.novas_quests, payload.atualizacoes, payload.estado_inicial;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id, JSON.stringify($json.novas_quests ?? []), JSON.stringify($json.atualizacoes ?? []), JSON.stringify($json.estado_inicial ?? {})] }}"
        }
      },
      "id": "55ee05f9-f2a2-4867-9e71-c160b1a857a3",
      "name": "Inserir Instancias",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -160,
        -176
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH payload AS (\n  SELECT\n    $1::uuid AS usuario_id,\n    $2::jsonb AS atualizacoes,\n    $3::jsonb AS estado_inicial,\n    $4::jsonb AS novas_quests\n),\nupdates AS (\n  SELECT\n    payload.usuario_id,\n    (rec->>'meta_codigo')::text AS meta_codigo,\n    (rec->>'instancia_id')::uuid AS instancia_id,\n    COALESCE(rec->>'novo_status', 'pendente') AS novo_status,\n    COALESCE((rec->>'progresso_atual')::int, 0) AS progresso_atual,\n    COALESCE((rec->>'xp_extra')::int, 0) AS xp_extra\n  FROM payload,\n       jsonb_array_elements(payload.atualizacoes) rec\n),\nalvos AS (\n  SELECT\n    qa.id,\n    qa.usuario_id,\n    qa.meta_codigo,\n    qa.progresso_meta,\n    qa.xp_concedido,\n    updates.novo_status,\n    updates.progresso_atual,\n    updates.xp_extra,\n    qt.id AS modelo_id,\n    COALESCE(LOWER(qt.config->>'recorrencia'), 'unica') AS recorrencia\n  FROM updates\n  JOIN public.usuarios_quest qa\n    ON (updates.instancia_id IS NOT NULL AND qa.id = updates.instancia_id)\n    OR (\n      updates.instancia_id IS NULL\n      AND updates.meta_codigo IS NOT NULL\n      AND qa.meta_codigo = updates.meta_codigo\n      AND qa.usuario_id = updates.usuario_id\n      AND qa.status IN ('pendente','ativa')\n    )\n  JOIN public.metas_catalogo qt ON qt.id = qa.modelo_id\n  WHERE qa.usuario_id = updates.usuario_id\n),\nalvos_enriquecidos AS (\n  SELECT\n    alvos.*,\n    CASE\n      WHEN alvos.novo_status = 'concluida' THEN\n        CASE\n          WHEN alvos.recorrencia = 'recorrente' THEN\n            150 + 30 * LEAST(21, (\n              SELECT COUNT(*) + 1\n              FROM public.usuarios_quest qa2\n              WHERE qa2.usuario_id = alvos.usuario_id\n                AND qa2.modelo_id = alvos.modelo_id\n                AND qa2.status = 'concluida'\n            ))\n          ELSE 150\n        END\n      ELSE alvos.xp_concedido\n    END AS xp_calculado\n  FROM alvos\n),\natualizados AS (\n  UPDATE public.usuarios_quest qa\n  SET\n    status = COALESCE(ae.novo_status, qa.status),\n    progresso_atual = ae.progresso_atual,\n    progresso_percentual = CASE\n      WHEN qa.progresso_meta > 0 THEN LEAST(100, GREATEST(0, ROUND(ae.progresso_atual::numeric / qa.progresso_meta::numeric * 100)))\n      ELSE qa.progresso_percentual\n    END,\n    atualizado_em = NOW(),\n    concluido_em = CASE WHEN ae.novo_status = 'concluida' THEN NOW() ELSE qa.concluido_em END,\n    cancelado_em = CASE WHEN ae.novo_status = 'cancelada' THEN NOW() ELSE qa.cancelado_em END,\n    reiniciada_em = CASE WHEN ae.novo_status = 'reiniciada' THEN NOW() ELSE qa.reiniciada_em END,\n    xp_concedido = CASE\n      WHEN ae.novo_status = 'concluida' THEN ae.xp_calculado\n      ELSE qa.xp_concedido\n    END\n  FROM alvos_enriquecidos ae\n  WHERE qa.id = ae.id\n  RETURNING\n    qa.id,\n    ae.novo_status,\n    ae.xp_extra,\n    qa.xp_concedido\n),\nxp_total AS (\n  SELECT\n    COALESCE(SUM(CASE WHEN novo_status = 'concluida' THEN COALESCE(xp_concedido, 0) + COALESCE(xp_extra, 0) ELSE 0 END), 0) AS xp_ganho,\n    COALESCE(SUM(CASE WHEN novo_status = 'concluida' THEN 1 ELSE 0 END), 0) AS concluidas,\n    COALESCE(SUM(CASE WHEN novo_status = 'reiniciada' THEN 1 ELSE 0 END), 0) AS reinicios\n  FROM atualizados\n),\natualiza_estado AS (\n  UPDATE public.usuarios_conquistas rj\n  SET\n    xp_total = rj.xp_total + (SELECT xp_ganho FROM xp_total),\n    total_quests_concluidas = rj.total_quests_concluidas + (SELECT concluidas FROM xp_total),\n    total_xp_hoje = rj.total_xp_hoje + (SELECT xp_ganho FROM xp_total),\n    sequencia_status = jsonb_set(\n      COALESCE(rj.sequencia_status, '{}'::jsonb),\n      '{reinicios}',\n      to_jsonb(\n        COALESCE((rj.sequencia_status ->> 'reinicios')::int, 0) + (SELECT reinicios FROM xp_total)\n      ),\n      true\n    ),\n    atualizado_em = NOW()\n  WHERE rj.usuario_id = (SELECT usuario_id FROM payload LIMIT 1)\n  RETURNING rj.usuario_id\n)\nSELECT\n  payload.usuario_id,\n  payload.novas_quests,\n  payload.atualizacoes,\n  payload.estado_inicial,\n  (SELECT xp_ganho FROM xp_total) AS xp_ganho,\n  (SELECT concluidas FROM xp_total) AS quests_concluidas,\n  (SELECT reinicios FROM xp_total) AS reinicios\nFROM payload;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id, JSON.stringify($json.atualizacoes ?? []), JSON.stringify($json.estado_inicial ?? {}), JSON.stringify($json.novas_quests ?? [])] }}"
        }
      },
      "id": "73a5fb0f-e21d-4085-8dd9-36c598329e0e",
      "name": "Aplicar Atualizacoes",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        80,
        -176
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH payload AS (\n  SELECT $1::uuid AS usuario_id\n),\nestado AS (\n  SELECT\n    eu.usuario_id,\n    eu.xp_total,\n    (SELECT j.nivel FROM public.jornada_niveis j WHERE eu.xp_total >= j.xp_minimo ORDER BY j.nivel DESC LIMIT 1) AS nivel_atual,\n    (SELECT j.nome FROM public.jornada_niveis j WHERE eu.xp_total >= j.xp_minimo ORDER BY j.nivel DESC LIMIT 1) AS titulo_nivel,\n    (SELECT j.xp_proximo_nivel FROM public.jornada_niveis j WHERE eu.xp_total >= j.xp_minimo ORDER BY j.nivel DESC LIMIT 1) AS xp_proximo_nivel\n  FROM public.usuarios_conquistas eu\n  JOIN payload ON payload.usuario_id = eu.usuario_id\n),\nupdated AS (\n  UPDATE public.usuarios_conquistas eu\n  SET\n    nivel_atual = estado.nivel_atual,\n    titulo_nivel = estado.titulo_nivel,\n    xp_proximo_nivel = estado.xp_proximo_nivel,\n    atualizado_em = NOW()\n  FROM estado\n  WHERE eu.usuario_id = estado.usuario_id\n  RETURNING eu.usuario_id, eu.xp_total, eu.nivel_atual, eu.titulo_nivel, eu.xp_proximo_nivel\n),\nresultado AS (\n  SELECT * FROM updated\n  UNION ALL\n  SELECT estado.usuario_id, estado.xp_total, estado.nivel_atual, estado.titulo_nivel, estado.xp_proximo_nivel\n  FROM estado\n  WHERE NOT EXISTS (SELECT 1 FROM updated)\n)\nSELECT\n  resultado.usuario_id,\n  resultado.xp_total,\n  resultado.nivel_atual,\n  resultado.titulo_nivel,\n  resultado.xp_proximo_nivel,\n  $2::numeric AS xp_ganho,\n  $3::integer AS quests_concluidas,\n  $4::integer AS reinicios,\n  $5::jsonb AS novas_quests,\n  $6::jsonb AS atualizacoes,\n  $7::jsonb AS estado_inicial\nFROM resultado;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id, $json.xp_ganho ?? 0, $json.quests_concluidas ?? 0, $json.reinicios ?? 0, JSON.stringify($json.novas_quests ?? []), JSON.stringify($json.atualizacoes ?? []), JSON.stringify($json.estado_inicial ?? {})] }}"
        }
      },
      "id": "571a39bc-c76a-421a-ae2b-17e5cd81d052",
      "name": "Atualizar Estado",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        304,
        -176
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH personalizadas AS (\n  SELECT\n    qa.id,\n    qa.meta_codigo,\n    qa.status,\n    COALESCE(qa.contexto_origem, '') AS contexto_origem,\n    qa.progresso_meta,\n    qa.progresso_atual,\n    qa.concluido_em,\n    qt.titulo,\n    qt.descricao,\n    qt.config,\n    qa.area_vida_id,\n    qa.sabotador_id,\n    qa.insight_id,\n    qa.complexidade\n  FROM public.usuarios_quest qa\n  JOIN public.metas_catalogo qt ON qt.id = qa.modelo_id\n  WHERE qa.usuario_id = $1::uuid\n    AND qt.tipo = 'personalizada'\n)\nSELECT\n  rj.usuario_id,\n  rj.xp_total,\n  rj.nivel_atual,\n  rj.titulo_nivel,\n  rj.xp_proximo_nivel,\n  rj.sequencia_atual,\n  rj.sequencia_recorde,\n  rj.meta_sequencia_codigo,\n  rj.proxima_meta_codigo,\n  rj.sequencia_status,\n  COALESCE(\n    jsonb_agg(\n      jsonb_build_object(\n        'instancia_id', personalizadas.id,\n        'meta_codigo', personalizadas.meta_codigo,\n        'status', personalizadas.status,\n        'contexto_origem', personalizadas.contexto_origem,\n        'progresso_meta', personalizadas.progresso_meta,\n        'progresso_atual', personalizadas.progresso_atual,\n        'concluido_em', personalizadas.concluido_em,\n        'titulo', personalizadas.titulo,\n        'descricao', personalizadas.descricao,\n        'config', personalizadas.config,\n        'area_vida_id', personalizadas.area_vida_id,\n        'sabotador_id', personalizadas.sabotador_id,\n        'insight_id', personalizadas.insight_id,\n        'complexidade', personalizadas.complexidade\n      )\n    ) FILTER (WHERE personalizadas.id IS NOT NULL),\n    '[]'::jsonb\n  ) AS quests_personalizadas\nFROM public.usuarios_conquistas rj\nLEFT JOIN personalizadas ON TRUE\nWHERE rj.usuario_id = $1::uuid\nGROUP BY\n  rj.usuario_id,\n  rj.xp_total,\n  rj.nivel_atual,\n  rj.titulo_nivel,\n  rj.xp_proximo_nivel,\n  rj.sequencia_atual,\n  rj.sequencia_recorde,\n  rj.meta_sequencia_codigo,\n  rj.proxima_meta_codigo,\n  rj.sequencia_status;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id] }}"
        }
      },
      "id": "ee327a4a-6485-4f30-bfa7-7994d8a8f3d0",
      "name": "Buscar Snapshot Final",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        736,
        -176
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const estadoItems = $items(\"Atualizar Estado\", 0, 0) || [];\nconst estadoAtualizado = (estadoItems[0] && estadoItems[0].json) || {};\nconst snapshotFinal = $input.item.json || {};\n\nconst parseList = (value) => {\n  if (!value) return [];\n  if (Array.isArray(value)) return value;\n  if (typeof value === 'string') {\n    try {\n      const parsed = JSON.parse(value);\n      return Array.isArray(parsed) ? parsed : [];\n    } catch (error) {\n      return [];\n    }\n  }\n  return [];\n};\n\nconst toNumber = (value, fallback = 0) => {\n  const numeric = Number(value);\n  return Number.isFinite(numeric) ? numeric : fallback;\n};\n\nconst filaItems = $items(\"Preparar Operacoes\", 0, 0) || [];\nconst filaEspera = parseList(filaItems[0]?.json?.fila_espera);\n\nreturn [{\n  json: {\n    usuario_id: estadoAtualizado.usuario_id ?? snapshotFinal.usuario_id ?? null,\n    xp_total: toNumber(estadoAtualizado.xp_total ?? snapshotFinal.xp_total ?? 0),\n    nivel_atual: estadoAtualizado.nivel_atual ?? snapshotFinal.nivel_atual ?? null,\n    titulo_nivel: estadoAtualizado.titulo_nivel ?? snapshotFinal.titulo_nivel ?? null,\n    xp_proximo_nivel: toNumber(estadoAtualizado.xp_proximo_nivel ?? snapshotFinal.xp_proximo_nivel ?? 0),\n    xp_ganho: toNumber(estadoAtualizado.xp_ganho, 0),\n    quests_concluidas_no_evento: toNumber(estadoAtualizado.quests_concluidas, 0),\n    reinicios_registrados: toNumber(estadoAtualizado.reinicios, 0),\n    novas_quests_registradas: parseList(estadoAtualizado.novas_quests),\n    atualizacoes_processadas: parseList(estadoAtualizado.atualizacoes),\n    fila_espera: filaEspera,\n    snapshot_final: snapshotFinal\n  }\n}];\n"
      },
      "id": "8a05eb35-9aae-4b59-b9bf-5cb1ce982782",
      "name": "Montar Resposta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        944,
        -176
      ]
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Normalizar Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Entrada": {
      "main": [
        [
          {
            "node": "Buscar Estado e Quests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Estado e Quests": {
      "main": [
        [
          {
            "node": "Preparar Operacoes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Operacoes": {
      "main": [
        [
          {
            "node": "Inserir Modelos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inserir Modelos": {
      "main": [
        [
          {
            "node": "Inserir Instancias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inserir Instancias": {
      "main": [
        [
          {
            "node": "Aplicar Atualizacoes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aplicar Atualizacoes": {
      "main": [
        [
          {
            "node": "Atualizar Estado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Estado": {
      "main": [
        [
          {
            "node": "Atualizar Jornada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Jornada": {
      "main": [
        [
          {
            "node": "Buscar Snapshot Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Snapshot Final": {
      "main": [
        [
          {
            "node": "Montar Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {
    "start": [
      {
        "json": {
          "usuario_id": "d949d81c-9235-41ce-8b3b-6b5d593c5e24",
          "quests_personalizadas": "[{\"titulo\":\"Estabelecer Ritual Diário de Encerramento das Operações\",\"descricao\":\"Criar um ritual para encerrar as operações financeiras às 20h, ajudando a sinalizar para a mente que é hora de desacelerar, reduzindo a ansiedade noturna relacionada ao mercado.\",\"contexto_origem\":\"Insight de Gestão da Ansiedade no Mercado Financeiro e sabotador Sr. Ansioso no contexto financeiro.\",\"prioridade\":\"alta\",\"recorrencia\":\"diaria\",\"prazo_inicio\":\"2025-11-09\",\"prazo_fim\":\"2025-11-15\",\"progresso_meta\":7,\"status_inicial\":\"ativa\",\"xp_recompensa\":60,\"insight_id\":\"63206fcc-45b6-437c-8b70-625b21a3ca78\",\"sabotador_id\":\"inquieto\",\"area_vida_id\":\"33333333-3333-4333-8333-333333333333\",\"complexidade\":2,\"payload_extra\":{\"canal\":\"app\"}},{\"titulo\":\"Praticar Exercícios Diários de Respiração Consciente\",\"descricao\":\"Implementar prática diária de exercícios de respiração para ajudar a controlar a ansiedade e acalmar a mente, reduzindo a influência do sabotador Sr. Ansioso durante atividades financeiras.\",\"contexto_origem\":\"Insight de Acompanhamento Objetivo para Redução de Ansiedade e sabotador Sr. Ansioso no contexto financeiro.\",\"prioridade\":\"alta\",\"recorrencia\":\"diaria\",\"prazo_inicio\":\"2025-11-09\",\"prazo_fim\":\"2025-11-15\",\"progresso_meta\":7,\"status_inicial\":\"ativa\",\"xp_recompensa\":50,\"insight_id\":\"ef545222-59f4-432c-9473-0f2067ac309d\",\"sabotador_id\":\"inquieto\",\"area_vida_id\":\"11111111-1111-4111-8111-111111111111\",\"complexidade\":1,\"payload_extra\":{\"canal\":\"app\"}},{\"titulo\":\"Estabelecer Metas Curtas e Atingíveis com Pausas para Autocuidado\",\"descricao\":\"Definir pequenas metas financeiras e incluir pausas para autocuidado e lazer no dia, equilibrando disciplina com bem-estar para aumentar consistência e reduzir pressão interna do sabotador Executor Rigoroso.\",\"contexto_origem\":\"Insight de Disciplina para execução do plano e sabotador Executor Rigoroso no contexto financeiro.\",\"prioridade\":\"media\",\"recorrencia\":\"semanal\",\"prazo_inicio\":\"2025-11-09\",\"prazo_fim\":\"2025-11-15\",\"progresso_meta\":1,\"status_inicial\":\"ativa\",\"xp_recompensa\":40,\"insight_id\":\"99ac5a27-74bc-4e44-82d5-d2844d0ca319\",\"sabotador_id\":\"hiper_realizador\",\"area_vida_id\":\"33333333-3333-4333-8333-333333333333\",\"complexidade\":3,\"payload_extra\":{\"canal\":\"app\"}}]",
          "atualizacoes_status": "[]"
        }
      }
    ]
  },
  "versionId": "20e5d4a1-bf8b-424b-8ca9-daa1f002f5a2",
  "triggerCount": 0,
  "shared": [
    {
      "createdAt": "2025-11-07T16:03:52.061Z",
      "role": "workflow:owner",
      "workflowId": "bTeLj5qOKQo9PDMO",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}
