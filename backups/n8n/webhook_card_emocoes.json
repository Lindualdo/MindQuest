{
  "createdAt": "2025-11-14T12:27:57.408Z",
  "id": "zumEm0S27nyCEaDP",
  "name": "webhook_card_emocoes",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "card/emocoes",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "b58c45cc-9a51-4946-a97e-9fac5b65b4d2",
      "name": "Webhook Card Emoções",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -960,
        240
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "language": "javaScript",
        "jsCode": "const userId = $json.query?.user_id ?? $json.body?.user_id;\n\nif (typeof userId !== 'string' || userId.trim() === '') {\n  throw new Error('Parâmetro user_id é obrigatório (?user_id=).');\n}\n\nreturn [\n  {\n    json: {\n      user_id: userId.trim(),\n    },\n  },\n];"
      },
      "id": "b9f46c0b-9a0c-4669-b7a9-3e5fbf6c83c4",
      "name": "Validar Params",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -720,
        240
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH base AS (\n  SELECT\n    uhe.humor_dia,\n    uhe.data_registro,\n    uhe.hora_registro,\n    uhe.detectado_em\n  FROM usuarios_humor_energia uhe\n  WHERE uhe.usuario_id = $1\n    AND uhe.data_registro BETWEEN CURRENT_DATE - INTERVAL '6 days' AND CURRENT_DATE\n),\nestatisticas AS (\n  SELECT\n    COUNT(*) AS total_registros,\n    ROUND(COALESCE(AVG(humor_dia)::numeric, 0), 2) AS humor_medio_7d\n  FROM base\n),\nultimo AS (\n  SELECT\n    humor_dia,\n    data_registro,\n    hora_registro,\n    detectado_em\n  FROM base\n  ORDER BY data_registro DESC,\n           COALESCE(detectado_em, data_registro::timestamp) DESC,\n           hora_registro DESC NULLS LAST\n  LIMIT 1\n)\nSELECT\n  'humor'::text AS bloco,\n  $1::uuid     AS user_id,\n  estatisticas.total_registros,\n  estatisticas.humor_medio_7d,\n  ultimo.humor_dia AS humor_atual,\n  ultimo.data_registro AS ultima_data,\n  ultimo.hora_registro AS ultima_hora\nFROM estatisticas\nLEFT JOIN ultimo ON TRUE;",
        "options": {
          "queryReplacement": "={{ $json.user_id }}"
        }
      },
      "id": "c3f1a65d-2767-4b8c-9434-0d7ce07d0f3b",
      "name": "Humor_Medio",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -480,
        80
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH periodo AS (\n  SELECT\n    CURRENT_DATE - INTERVAL '7 days' AS inicio,\n    CURRENT_DATE + INTERVAL '1 day'  AS fim_exclusivo\n),\nemocao_classificada AS (\n  SELECT\n    CASE\n      WHEN LOWER(emocao_id) IN ('joy','trust','anticipation') THEN 'POSITIVA'\n      WHEN LOWER(emocao_id) IN ('sadness','fear','anger','disgust') THEN 'NEGATIVA'\n      WHEN LOWER(emocao_id) = 'surprise' THEN 'NEUTRA'\n      ELSE 'NEUTRA'\n    END AS categoria\n  FROM usuarios_emocoes ue\n  JOIN periodo p\n    ON ue.detectado_em >= p.inicio\n   AND ue.detectado_em <  p.fim_exclusivo\n  WHERE ue.usuario_id = $1\n    AND ue.intensidade >= 45\n)\nSELECT\n  'panas'::text AS bloco,\n  $1::uuid     AS user_id,\n  COUNT(*) FILTER (WHERE categoria = 'POSITIVA') AS positivas,\n  COUNT(*) FILTER (WHERE categoria = 'NEGATIVA') AS negativas,\n  COUNT(*) FILTER (WHERE categoria = 'NEUTRA')   AS neutras,\n  COUNT(*)                                       AS total,\n  CASE WHEN COUNT(*) > 0\n       THEN ROUND((COUNT(*) FILTER (WHERE categoria = 'POSITIVA')::numeric / COUNT(*)::numeric) * 100, 1)\n       ELSE 0 END AS percentual_positivas,\n  CASE WHEN COUNT(*) > 0\n       THEN ROUND((COUNT(*) FILTER (WHERE categoria = 'NEGATIVA')::numeric / COUNT(*)::numeric) * 100, 1)\n       ELSE 0 END AS percentual_negativas,\n  CASE WHEN COUNT(*) > 0\n       THEN ROUND((COUNT(*) FILTER (WHERE categoria = 'NEUTRA')::numeric / COUNT(*)::numeric) * 100, 1)\n       ELSE 0 END AS percentual_neutras,\n  CASE\n    WHEN COUNT(*) = 0 THEN 'NEUTRA'\n    WHEN ( (COUNT(*) FILTER (WHERE categoria = 'POSITIVA')::numeric / COUNT(*)::numeric) * 100\n         - (COUNT(*) FILTER (WHERE categoria = 'NEGATIVA')::numeric / COUNT(*)::numeric) * 100 ) > 20\n         THEN 'POSITIVA'\n    WHEN ( (COUNT(*) FILTER (WHERE categoria = 'NEGATIVA')::numeric / COUNT(*)::numeric) * 100\n         - (COUNT(*) FILTER (WHERE categoria = 'POSITIVA')::numeric / COUNT(*)::numeric) * 100 ) > 20\n         THEN 'NEGATIVA'\n    ELSE 'NEUTRA'\n  END AS resultado_panas\nFROM emocao_classificada;",
        "options": {
          "queryReplacement": "={{ $json.user_id }}"
        }
      },
      "id": "14083411-1f01-4a63-b0d5-f3e4b2c35feb",
      "name": "Analise_PANAS",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -480,
        240
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH emocoes_semana AS (\n  SELECT\n    ue.emocao_id,\n    SUM(ue.intensidade) AS intensidade_total\n  FROM usuarios_emocoes ue\n  WHERE ue.usuario_id = $1\n    AND ue.detectado_em >= CURRENT_DATE - INTERVAL '7 days'\n  GROUP BY ue.emocao_id\n),\ntotais AS (\n  SELECT COALESCE(SUM(intensidade_total), 0)::numeric AS total_intensidade\n  FROM emocoes_semana\n),\nranked AS (\n  SELECT\n    'emocoes'::text AS bloco,\n    $1::uuid AS user_id,\n    ep.nome AS emocao_nome,\n    COALESCE(ep.emoji, '❤️') AS emoji,\n    es.intensidade_total,\n    CASE\n      WHEN totais.total_intensidade > 0\n        THEN ROUND((es.intensidade_total / totais.total_intensidade) * 100, 1)\n      ELSE 0\n    END AS percentual,\n    ROW_NUMBER() OVER (ORDER BY es.intensidade_total DESC NULLS LAST) AS ordem\n  FROM emocoes_semana es\n  CROSS JOIN totais\n  LEFT JOIN emocoes_plutchik ep ON ep.id = es.emocao_id\n)\nSELECT\n  bloco,\n  user_id,\n  emocao_nome,\n  emoji,\n  percentual\nFROM ranked\nWHERE ordem <= 2\nORDER BY ordem;",
        "options": {
          "queryReplacement": "={{ $json.user_id }}"
        }
      },
      "id": "1f1f3f47-9dc4-4fc0-8f58-fa0aeaf13ba0",
      "name": "Emocoes_Dominantes",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -480,
        400
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH periodo AS (\n  SELECT\n    CURRENT_DATE - INTERVAL '6 days' AS inicio,\n    CURRENT_DATE                     AS fim\n),\nconversas_periodo AS (\n  SELECT COUNT(*) AS total_conversas\n  FROM usr_chat uc\n  JOIN periodo p ON uc.data_conversa BETWEEN p.inicio AND p.fim\n  WHERE uc.usuario_id = $1\n),\nsabotadores_periodo AS (\n  SELECT\n    us.sabotador_id,\n    COUNT(*)                    AS total_deteccoes,\n    COUNT(DISTINCT us.chat_id)  AS conversas_afetadas\n  FROM usuarios_sabotadores us\n  JOIN usr_chat uc ON uc.id = us.chat_id\n  JOIN periodo p   ON uc.data_conversa BETWEEN p.inicio AND p.fim\n  WHERE us.usuario_id = $1\n  GROUP BY us.sabotador_id\n),\nsabotador_top AS (\n  SELECT\n    sp.sabotador_id,\n    sp.total_deteccoes,\n    sp.conversas_afetadas,\n    MAX(us.apelido_personalizado) AS apelido_personalizado,\n    MAX(us.contexto_principal)    AS contexto_principal,\n    MAX(us.insight_atual)         AS insight_atual,\n    MAX(us.contramedida_ativa)    AS contramedida_ativa,\n    MAX(us.intensidade_media)     AS intensidade_media,\n    MAX(us.atualizado_em)         AS ultima_atualizacao\n  FROM sabotadores_periodo sp\n  JOIN usuarios_sabotadores us\n    ON us.usuario_id = $1\n   AND us.sabotador_id = sp.sabotador_id\n  GROUP BY sp.sabotador_id, sp.total_deteccoes, sp.conversas_afetadas\n  ORDER BY sp.total_deteccoes DESC,\n           sp.conversas_afetadas DESC,\n           MAX(us.atualizado_em) DESC\n  LIMIT 1\n)\nSELECT\n  'sabotador'::text AS bloco,\n  $1::uuid         AS user_id,\n  st.sabotador_id,\n  sc.nome,\n  sc.emoji,\n  st.apelido_personalizado,\n  st.total_deteccoes,\n  cp.total_conversas,\n  st.conversas_afetadas,\n  st.contexto_principal,\n  st.insight_atual,\n  st.contramedida_ativa,\n  st.intensidade_media\nFROM sabotador_top st\nJOIN sabotadores_catalogo sc ON sc.id = st.sabotador_id\nCROSS JOIN conversas_periodo cp;",
        "options": {
          "queryReplacement": "={{ $json.user_id }}"
        }
      },
      "id": "6b4c259d-0417-4b47-80e2-9955533f7df6",
      "name": "Sabotador_Ativo",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -480,
        560
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "multiplex",
        "numberInputs": 4
      },
      "id": "8fd7dbad-cb0d-4fa0-907b-7d8487302b89",
      "name": "Merge Dados",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -240,
        320
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "language": "javaScript",
        "jsCode": "const rows = $input.all().map(item => item.json || {});\n\nfunction findRow(bloco) {\n  return rows.find((row) => row.bloco === bloco) || null;\n}\n\nconst humorRow = findRow('humor');\nconst panasRow = findRow('panas');\nconst sabotadorRow = findRow('sabotador');\nconst emocaoRows = rows.filter((row) => row.bloco === 'emocoes');\n\nconst humorMedia = humorRow?.humor_medio_7d ?? null;\nconst humorAtual = humorRow?.humor_atual ?? humorMedia;\n\nconst response = {\n  success: true,\n  usuario_id: humorRow?.user_id || panasRow?.user_id || sabotadorRow?.user_id || emocaoRows[0]?.user_id || null,\n  card_panorama_emocional: {\n    humor: {\n      media_7d: humorMedia,\n      atual: humorAtual,\n      amostras: humorRow?.total_registros ?? 0,\n      ultima_data: humorRow?.ultima_data ?? null,\n      ultima_hora: humorRow?.ultima_hora ?? null,\n    },\n    energia: {\n      percentual_positiva: panasRow?.percentual_positivas ?? 0,\n      percentual_negativa: panasRow?.percentual_negativas ?? 0,\n      percentual_neutra: panasRow?.percentual_neutras ?? 0,\n      categoria: panasRow?.resultado_panas ?? 'NEUTRA',\n    },\n    emocoes_dominantes: emocaoRows.map((row) => ({\n      nome: row.emocao_nome ?? 'Emoção',\n      emoji: row.emoji ?? '❤️',\n      percentual: row.percentual ?? 0,\n    })),\n    sabotador: sabotadorRow\n      ? {\n          id: sabotadorRow.sabotador_id,\n          nome: sabotadorRow.nome,\n          emoji: sabotadorRow.emoji,\n          apelido: sabotadorRow.apelido_personalizado,\n          contexto: sabotadorRow.contexto_principal,\n          insight: sabotadorRow.insight_atual,\n          contramedida: sabotadorRow.contramedida_ativa,\n          intensidade_media: sabotadorRow.intensidade_media,\n          total_deteccoes: sabotadorRow.total_deteccoes,\n          conversas_afetadas: sabotadorRow.conversas_afetadas,\n        }\n      : null,\n  },\n};\n\nreturn [\n  {\n    json: response,\n  },\n];"
      },
      "id": "ac8b61f2-0fc3-4fd6-852a-23ec61a4d6f7",
      "name": "Montar Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        320
      ]
    },
    {
      "parameters": {
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "b7aa6120-58c5-4a77-b18b-59541a1366df",
      "name": "Responder Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        240,
        320
      ]
    }
  ],
  "connections": {
    "Webhook Card Emoções": {
      "main": [
        [
          {
            "node": "Validar Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Params": {
      "main": [
        [
          {
            "node": "Humor_Medio",
            "type": "main",
            "index": 0
          },
          {
            "node": "Analise_PANAS",
            "type": "main",
            "index": 0
          },
          {
            "node": "Emocoes_Dominantes",
            "type": "main",
            "index": 0
          },
          {
            "node": "Sabotador_Ativo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Humor_Medio": {
      "main": [
        [
          {
            "node": "Merge Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analise_PANAS": {
      "main": [
        [
          {
            "node": "Merge Dados",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Emocoes_Dominantes": {
      "main": [
        [
          {
            "node": "Merge Dados",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Sabotador_Ativo": {
      "main": [
        [
          {
            "node": "Merge Dados",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "Merge Dados": {
      "main": [
        [
          {
            "node": "Montar Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Montar Response": {
      "main": [
        [
          {
            "node": "Responder Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "tags": []
}
