{
  "createdAt": "2025-11-07T19:12:28.703Z",
  "id": "71Ru87yaRA5SNjOQ",
  "name": "sw_calcula_jornada",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usuario_id"
            }
          ]
        }
      },
      "id": "73c7d0f5-bde3-4df8-8b97-2b26de5bc88b",
      "name": "start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        320,
        272
      ]
    },
    {
      "parameters": {
        "jsCode": "const entrada = $input.item.json || {};\nconst usuarioId = entrada.usuario_id || entrada.id || $json.usuario_id;\nif (!usuarioId || (typeof usuarioId !== 'string' && typeof usuarioId !== 'number')) {\n  throw new Error('usuario_id obrigatório');\n}\nreturn [{ json: { usuario_id: String(usuarioId).trim() } }];"
      },
      "id": "6144d1d4-9c78-4859-83af-934e248fb988",
      "name": "Validar Entrada",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        544,
        272
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH base AS (\n  SELECT\n    uc.usuario_id,\n    uc.xp_total,\n    uc.nivel_atual,\n    uc.titulo_nivel,\n    uc.sequencia_recorde,\n    uc.total_quests_concluidas,\n    uc.total_quests_personalizadas\n  FROM public.usuarios_conquistas uc\n  WHERE uc.usuario_id = $1::uuid\n),\nsabotadores AS (\n  SELECT usuario_id, COUNT(*) AS sabotadores_identificados\n  FROM public.usuarios_sabotadores\n  GROUP BY usuario_id\n),\nquests AS (\n  SELECT\n    uq.usuario_id,\n    COUNT(*) FILTER (WHERE uq.status = 'inativa') AS quests_concluidas,\n    COUNT(DISTINCT uq.id) FILTER (\n      WHERE uq.status = 'inativa' \n      AND EXISTS (\n        SELECT 1 FROM public.quests_recorrencias qr \n        WHERE qr.usuarios_quest_id = uq.id \n        AND qr.status = 'concluida'\n      )\n    ) AS quests_recorrentes_21,\n    COUNT(*) FILTER (WHERE uq.status = 'inativa' AND COALESCE(uq.config->>'categoria', '') = 'compartilhar') AS quests_compartilhar,\n    COUNT(*) FILTER (WHERE uq.status = 'inativa' AND COALESCE(uq.config->>'categoria', '') = 'propria') AS quests_proprias\n  FROM public.usuarios_quest uq\n  GROUP BY uq.usuario_id\n)\nSELECT\n  base.*, \n  COALESCE(s.sabotadores_identificados, 0) AS sabotadores_identificados,\n  COALESCE(q.quests_concluidas, 0) AS quests_concluidas,\n  0 AS quests_desafiadoras,\n  COALESCE(q.quests_recorrentes_21, 0) AS quests_recorrentes_21,\n  0 AS areas_vida_distintas,\n  COALESCE(q.quests_compartilhar, 0) AS quests_compartilhar,\n  COALESCE(q.quests_proprias, 0) AS quests_proprias,\n  0 AS falhas_recuperadas,\n  0 AS projetos_impacto\nFROM base\nLEFT JOIN sabotadores s ON s.usuario_id = base.usuario_id\nLEFT JOIN quests q ON q.usuario_id = base.usuario_id;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id] }}"
        }
      },
      "id": "4d1aae5d-ce65-45be-8db4-5db1e5435df6",
      "name": "Buscar XP",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        736,
        272
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH nivel_destino AS (\n  SELECT *\n  FROM public.jornada_niveis\n  WHERE nivel = $3::int\n)\nUPDATE public.usuarios_conquistas uc\nSET\n  xp_total = $2::int,\n  xp_proximo_nivel = COALESCE(nivel_destino.xp_proximo_nivel, uc.xp_proximo_nivel),\n  nivel_atual = COALESCE(nivel_destino.nivel, uc.nivel_atual),\n  titulo_nivel = COALESCE(nivel_destino.nome, uc.titulo_nivel),\n  atualizado_em = NOW()\nFROM nivel_destino\nWHERE uc.usuario_id = $1::uuid\nRETURNING uc.usuario_id, uc.nivel_atual, uc.titulo_nivel, uc.xp_proximo_nivel;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id, $json.xp_total || 0, $json.target_nivel || 1] }}"
        }
      },
      "id": "834f6b74-c366-49a8-9ac2-1d9b3de63bc0",
      "name": "Atualizar Jornada",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1088,
        272
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE public.usuarios SET estagio_jornada = $2::smallint, atualizado_em = NOW() WHERE id = $1::uuid RETURNING id, estagio_jornada;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id, $json.target_estagio || 1] }}"
        }
      },
      "id": "68df295d-2643-4e6e-9cc1-1306b048f655",
      "name": "Atualizar Estágio Usuário",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1264,
        272
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {},
      "id": "21425697-6329-4173-9a25-b080e03ccd03",
      "name": "Fim",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1520,
        272
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $json || {};\nconst xpTotal = Number(data.xp_total) || 0;\nconst metrics = {\n  sequencia_recorde: Number(data.sequencia_recorde) || 0,\n  total_quests_personalizadas: Number(data.total_quests_personalizadas) || 0,\n  total_quests_concluidas: Number(data.total_quests_concluidas) || 0,\n  sabotadores_identificados: Number(data.sabotadores_identificados) || 0,\n  quests_concluidas: Number(data.quests_concluidas) || 0,\n  quests_desafiadoras: Number(data.quests_desafiadoras) || 0,\n  quests_recorrentes_21: Number(data.quests_recorrentes_21) || 0,\n  areas_vida_distintas: Number(data.areas_vida_distintas) || 0,\n  quests_compartilhar: Number(data.quests_compartilhar) || 0,\n  quests_proprias: Number(data.quests_proprias) || 0,\n  falhas_recuperadas: Number(data.falhas_recuperadas) || 0,\n  projetos_impacto: Number(data.projetos_impacto) || 0,\n};\nmetrics.ciclos30 = Math.floor(metrics.sequencia_recorde / 30);\nconst LEVELS = [\n  { level: 1, minXp: 0, requirements: () => true },\n  { level: 2, minXp: 500, requirements: (m) => m.sequencia_recorde >= 7 && m.sabotadores_identificados >= 3 && (m.total_quests_personalizadas >= 3 || m.quests_concluidas >= 3) },\n  { level: 3, minXp: 1200, requirements: (m) => m.sequencia_recorde >= 10 && m.quests_concluidas >= 5 && m.quests_desafiadoras >= 1 },\n  { level: 4, minXp: 2200, requirements: (m) => m.sequencia_recorde >= 15 && m.quests_concluidas >= 8 && m.quests_recorrentes_21 >= 1 },\n  { level: 5, minXp: 3600, requirements: (m) => m.sequencia_recorde >= 20 && m.quests_concluidas >= 12 && m.falhas_recuperadas >= 1 },\n  { level: 6, minXp: 5400, requirements: (m) => m.sequencia_recorde >= 25 && m.quests_concluidas >= 15 && m.areas_vida_distintas >= 3 },\n  { level: 7, minXp: 7400, requirements: (m) => m.sequencia_recorde >= 30 && m.quests_concluidas >= 20 && m.quests_proprias >= 2 },\n  { level: 8, minXp: 9800, requirements: (m) => m.ciclos30 >= 2 && m.quests_concluidas >= 25 && m.quests_compartilhar >= 3 },\n  { level: 9, minXp: 12600, requirements: (m) => m.sequencia_recorde >= 45 && m.quests_concluidas >= 30 && m.projetos_impacto >= 1 },\n  { level: 10, minXp: 16000, requirements: (m) => m.sequencia_recorde >= 365 && m.projetos_impacto >= 1 },\n];\nconst xpEligible = LEVELS.reduce((acc, lvl) => (xpTotal >= lvl.minXp ? lvl.level : acc), 1);\nlet criteriaEligible = 1;\nfor (const lvl of LEVELS) {\n  if (lvl.level > xpEligible) break;\n  if (lvl.requirements(metrics)) {\n    criteriaEligible = lvl.level;\n  } else {\n    break;\n  }\n}\nconst targetLevel = Math.min(xpEligible, criteriaEligible);\n\n// Calcular estágio baseado no nível: 1-3=estágio1, 4-6=estágio2, 7-9=estágio3, 10=estágio4\nconst calcularEstagio = (nivel) => {\n  if (nivel <= 3) return 1;\n  if (nivel <= 6) return 2;\n  if (nivel <= 9) return 3;\n  return 4;\n};\n\nconst targetEstagio = calcularEstagio(targetLevel);\n\nreturn [{\n  json: {\n    usuario_id: data.usuario_id,\n    xp_total: xpTotal,\n    xp_eligible_level: xpEligible,\n    criteria_eligible_level: criteriaEligible,\n    target_nivel: targetLevel,\n    target_estagio: targetEstagio,\n  },\n}];"
      },
      "id": "480f1870-23a9-4322-a162-5e6ca0a37419",
      "name": "Determinar Nível",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        912,
        272
      ]
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Validar Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Entrada": {
      "main": [
        [
          {
            "node": "Buscar XP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Jornada": {
      "main": [
        [
          {
            "node": "Atualizar Estágio Usuário",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Estágio Usuário": {
      "main": [
        [
          {
            "node": "Fim",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar XP": {
      "main": [
        [
          {
            "node": "Determinar Nível",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Determinar Nível": {
      "main": [
        [
          {
            "node": "Atualizar Jornada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {
    "start": [
      {
        "json": {
          "usuario_id": "d949d81c-9235-41ce-8b3b-6b5d593c5e24"
        }
      }
    ]
  },
  "activeVersionId": null,
  "shared": [
    {
      "createdAt": "2025-11-07T19:12:28.703Z",
      "role": "workflow:owner",
      "workflowId": "71Ru87yaRA5SNjOQ",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [],
  "activeVersion": null
}
