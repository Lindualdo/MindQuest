{
  "createdAt": "2025-11-07T19:12:28.703Z",
  "id": "71Ru87yaRA5SNjOQ",
  "name": "sw_calcula_jornada",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usuario_id"
            }
          ]
        }
      },
      "id": "f1f92aaa-9318-4cc2-8325-e7e72b2e5626",
      "name": "start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "const entrada = $input.item.json || {};\nconst usuarioId = entrada.usuario_id || entrada.id || $json.usuario_id;\nif (!usuarioId || typeof usuarioId !== 'string' || !usuarioId.trim()) {\n  throw new Error('usuario_id obrigatório');\n}\nreturn [{ json: { usuario_id: usuarioId.trim() } }];\n"
      },
      "id": "2c47f697-2896-498a-8de8-2df7cc5352c7",
      "name": "Validar Entrada",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        0
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH base AS (\n  SELECT\n    uc.usuario_id,\n    uc.xp_total,\n    uc.nivel_atual,\n    uc.titulo_nivel,\n    uc.sequencia_recorde,\n    uc.total_quests_concluidas,\n    uc.total_quests_personalizadas\n  FROM public.usuarios_conquistas uc\n  WHERE uc.usuario_id = $1::uuid\n),\nsabotadores AS (\n  SELECT usuario_id, COUNT(*) AS sabotadores_identificados\n  FROM public.usuarios_sabotadores\n  GROUP BY usuario_id\n),\nquests AS (\n  SELECT\n    usuario_id,\n    COUNT(*) FILTER (WHERE status = 'concluida') AS quests_concluidas,\n    COUNT(*) FILTER (WHERE status = 'concluida' AND COALESCE(complexidade, 0) >= 2) AS quests_desafiadoras,\n    COUNT(*) FILTER (WHERE status = 'concluida' AND COALESCE(progresso_meta, 0) >= 21) AS quests_recorrentes_21,\n    COUNT(DISTINCT area_vida_id) FILTER (WHERE status = 'concluida' AND area_vida_id IS NOT NULL) AS areas_vida_distintas,\n    COUNT(*) FILTER (WHERE status = 'concluida' AND COALESCE(config->>'categoria', '') = 'compartilhar') AS quests_compartilhar,\n    COUNT(*) FILTER (WHERE status = 'concluida' AND COALESCE(config->>'categoria', '') = 'propria') AS quests_proprias\n  FROM public.usuarios_quest\n  GROUP BY usuario_id\n)\nSELECT\n  base.*, \n  COALESCE(s.sabotadores_identificados, 0) AS sabotadores_identificados,\n  COALESCE(q.quests_concluidas, 0) AS quests_concluidas,\n  COALESCE(q.quests_desafiadoras, 0) AS quests_desafiadoras,\n  COALESCE(q.quests_recorrentes_21, 0) AS quests_recorrentes_21,\n  COALESCE(q.areas_vida_distintas, 0) AS areas_vida_distintas,\n  COALESCE(q.quests_compartilhar, 0) AS quests_compartilhar,\n  COALESCE(q.quests_proprias, 0) AS quests_proprias,\n  0 AS falhas_recuperadas,\n  0 AS projetos_impacto\nFROM base\nLEFT JOIN sabotadores s ON s.usuario_id = base.usuario_id\nLEFT JOIN quests q ON q.usuario_id = base.usuario_id;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id] }}"
        }
      },
      "id": "208a85ec-cdfd-4f54-9775-5360f13e569a",
      "name": "Buscar XP",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        464,
        0
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH nivel_destino AS (\n  SELECT *\n  FROM public.jornada_niveis\n  WHERE nivel = $3::int\n)\nUPDATE public.usuarios_conquistas uc\nSET\n  xp_total = $2::int,\n  xp_proximo_nivel = COALESCE(nivel_destino.xp_proximo_nivel, uc.xp_proximo_nivel),\n  nivel_atual = COALESCE(nivel_destino.nivel, uc.nivel_atual),\n  titulo_nivel = COALESCE(nivel_destino.nome, uc.titulo_nivel),\n  atualizado_em = NOW()\nFROM nivel_destino\nWHERE uc.usuario_id = $1::uuid\nRETURNING uc.usuario_id, uc.nivel_atual, uc.titulo_nivel, uc.xp_proximo_nivel;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id, $json.xp_total || 0, $json.target_nivel || 1] }}"
        }
      },
      "id": "3ab8600d-a22b-4729-9443-df30166bf724",
      "name": "Atualizar Jornada",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        704,
        0
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {},
      "id": "be9e5045-9357-443e-beaf-bf20e53328f3",
      "name": "Fim",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        928,
        0
      ]
    },
    {
      "id": "b7a9f734-de7f-4dbb-95b4-73b01c2d0983",
      "name": "Determinar Nível",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        584,
        0
      ],
      "parameters": {
        "jsCode": "const data = $json || {};\nconst xpTotal = Number(data.xp_total) || 0;\nconst metrics = {\n  sequencia_recorde: Number(data.sequencia_recorde) || 0,\n  total_quests_personalizadas: Number(data.total_quests_personalizadas) || 0,\n  total_quests_concluidas: Number(data.total_quests_concluidas) || 0,\n  sabotadores_identificados: Number(data.sabotadores_identificados) || 0,\n  quests_concluidas: Number(data.quests_concluidas) || 0,\n  quests_desafiadoras: Number(data.quests_desafiadoras) || 0,\n  quests_recorrentes_21: Number(data.quests_recorrentes_21) || 0,\n  areas_vida_distintas: Number(data.areas_vida_distintas) || 0,\n  quests_compartilhar: Number(data.quests_compartilhar) || 0,\n  quests_proprias: Number(data.quests_proprias) || 0,\n  falhas_recuperadas: Number(data.falhas_recuperadas) || 0,\n  projetos_impacto: Number(data.projetos_impacto) || 0,\n};\nmetrics.ciclos30 = Math.floor(metrics.sequencia_recorde / 30);\nconst LEVELS = [\n  { level: 1, minXp: 0, requirements: () => true },\n  { level: 2, minXp: 500, requirements: (m) => m.sequencia_recorde >= 7 && m.sabotadores_identificados >= 3 && (m.total_quests_personalizadas >= 3 || m.quests_concluidas >= 3) },\n  { level: 3, minXp: 1200, requirements: (m) => m.sequencia_recorde >= 10 && m.quests_concluidas >= 5 && m.quests_desafiadoras >= 1 },\n  { level: 4, minXp: 2200, requirements: (m) => m.sequencia_recorde >= 15 && m.quests_concluidas >= 8 && m.quests_recorrentes_21 >= 1 },\n  { level: 5, minXp: 3600, requirements: (m) => m.sequencia_recorde >= 20 && m.quests_concluidas >= 12 && m.falhas_recuperadas >= 1 },\n  { level: 6, minXp: 5400, requirements: (m) => m.sequencia_recorde >= 25 && m.quests_concluidas >= 15 && m.areas_vida_distintas >= 3 },\n  { level: 7, minXp: 7400, requirements: (m) => m.sequencia_recorde >= 30 && m.quests_concluidas >= 20 && m.quests_proprias >= 2 },\n  { level: 8, minXp: 9800, requirements: (m) => m.ciclos30 >= 2 && m.quests_concluidas >= 25 && m.quests_compartilhar >= 3 },\n  { level: 9, minXp: 12600, requirements: (m) => m.sequencia_recorde >= 45 && m.quests_concluidas >= 30 && m.projetos_impacto >= 1 },\n  { level: 10, minXp: 16000, requirements: (m) => m.sequencia_recorde >= 365 && m.projetos_impacto >= 1 },\n];\nconst xpEligible = LEVELS.reduce((acc, lvl) => (xpTotal >= lvl.minXp ? lvl.level : acc), 1);\nlet criteriaEligible = 1;\nfor (const lvl of LEVELS) {\n  if (lvl.level > xpEligible) break;\n  if (lvl.requirements(metrics)) {\n    criteriaEligible = lvl.level;\n  } else {\n    break;\n  }\n}\nconst targetLevel = Math.min(xpEligible, criteriaEligible);\nreturn [{\n  json: {\n    usuario_id: data.usuario_id,\n    xp_total: xpTotal,\n    xp_eligible_level: xpEligible,\n    criteria_eligible_level: criteriaEligible,\n    target_nivel: targetLevel,\n  },\n}];"
      }
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Validar Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Entrada": {
      "main": [
        [
          {
            "node": "Buscar XP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Jornada": {
      "main": [
        [
          {
            "node": "Fim",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar XP": {
      "main": [
        [
          {
            "node": "Determinar Nível",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Determinar Nível": {
      "main": [
        [
          {
            "node": "Atualizar Jornada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {
    "start": [
      {
        "json": {
          "usuario_id": "d949d81c-9235-41ce-8b3b-6b5d593c5e24"
        }
      }
    ]
  },
  "versionId": "1d1206a6-4aef-4af8-8d3d-674945f2af02",
  "triggerCount": 0,
  "shared": [
    {
      "createdAt": "2025-11-07T19:12:28.703Z",
      "role": "workflow:owner",
      "workflowId": "71Ru87yaRA5SNjOQ",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}
