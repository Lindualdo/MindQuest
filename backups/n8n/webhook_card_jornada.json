{
  "createdAt": "2025-11-14T21:04:26.771Z",
  "id": "YAIxH4AofzYkV8OB",
  "name": "webhook_card_jornada",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "path": "card/jornada",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "e5f38c61-72a5-40f3-a036-b8c2dbee8334",
      "name": "Webhook Card Jornada",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -144,
        -96
      ],
      "webhookId": "994d1a9e-a731-432c-9723-0d2110ae043a"
    },
    {
      "parameters": {
        "jsCode": "const userId = $json.query?.user_id ?? $json.body?.user_id;\n\nif (typeof userId !== 'string' || userId.trim() === '') {\n  throw new Error('Parâmetro user_id é obrigatório (?user_id=).');\n}\n\nreturn [{ json: { user_id: userId.trim() } }];"
      },
      "id": "7ba36966-3a91-4c06-b9d9-95bb4ec3510b",
      "name": "Validar Params",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        96,
        -96
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH input AS (\n  SELECT $1::uuid AS usuario_id\n),\nxp_data AS (\n  SELECT\n    i.usuario_id,\n    COALESCE(uc.xp_total, 0) AS xp_total,\n    NULLIF(uc.xp_proximo_nivel, 0) AS xp_proximo_nivel,\n    COALESCE(uc.xp_base, 0) AS xp_base_total,\n    COALESCE(uc.xp_bonus, 0) AS xp_bonus_total,\n    uc.atualizado_em\n  FROM input i\n  LEFT JOIN public.usuarios_conquistas uc ON uc.usuario_id = i.usuario_id\n),\ncalc AS (\n  SELECT\n    xp.*,\n    lvl.nivel AS nivel_atual,\n    lvl.nome AS nivel_nome,\n    lvl.descricao AS nivel_descricao,\n    nxt.nome AS proximo_nome,\n    nxt.descricao AS proximo_descricao,\n    COALESCE(\n      CASE WHEN xp.xp_proximo_nivel IS NOT NULL AND xp.xp_proximo_nivel > xp.xp_total THEN xp.xp_proximo_nivel END,\n      nxt.xp_minimo,\n      xp.xp_total + 500\n    ) AS xp_meta\n  FROM xp_data xp\n  LEFT JOIN LATERAL (\n    SELECT j.*\n    FROM public.jornada_niveis j\n    WHERE xp.xp_total >= j.xp_minimo\n    ORDER BY j.xp_minimo DESC\n    LIMIT 1\n  ) lvl ON TRUE\n  LEFT JOIN LATERAL (\n    SELECT j.*\n    FROM public.jornada_niveis j\n    WHERE lvl.nivel IS NOT NULL AND j.nivel = lvl.nivel + 1\n  ) nxt ON TRUE\n)\nSELECT\n  'jornada'::text AS bloco,\n  c.usuario_id AS user_id,\n  c.nivel_nome,\n  c.nivel_descricao,\n  c.proximo_nome,\n  c.proximo_descricao,\n  c.xp_total,\n  c.xp_meta,\n  GREATEST(c.xp_meta - c.xp_total, 0) AS xp_restante,\n  CASE WHEN c.xp_meta > 0 THEN ROUND((c.xp_total / c.xp_meta) * 100, 1) ELSE 0 END AS percentual,\n  c.xp_base_total,\n  c.xp_bonus_total,\n  c.atualizado_em\nFROM calc c;",
        "options": {
          "queryReplacement": "={{ $json.user_id }}"
        }
      },
      "id": "a26189a0-72a6-418b-b24a-074ddb1a3965",
      "name": "Estado Jornada",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        336,
        -96
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const row = $input.first()?.json || {};\n\nconst xpAtual = Number(row.xp_total ?? 0) || 0;\nconst xpMeta = Math.max(Number(row.xp_meta ?? 0) || 0, 1);\nconst xpRestante = Math.max(Number(row.xp_restante ?? (xpMeta - xpAtual)) || 0, 0);\nconst percentual = Math.min(100, Math.max(0, Number(row.percentual ?? ((xpAtual / xpMeta) * 100)) || 0));\n\nconst beneficios = [\n  'Liberar novas estratégias personalizadas',\n  'Acesso a missões avançadas da jornada',\n  'Recompensas extras em XP e insights',\n];\n\nconst response = {\n  success: true,\n  usuario_id: row.user_id ?? null,\n  card_jornada: {\n    nivel: {\n      atual: row.nivel_nome ?? 'Despertar',\n      descricao: row.nivel_descricao ?? 'Reconheço que preciso mudar.',\n      proximo: row.proximo_nome ?? 'Próximo nível',\n      proximo_descricao: row.proximo_descricao ?? null,\n    },\n    xp: {\n      atual: xpAtual,\n      meta: xpMeta,\n      restante: xpRestante,\n      percentual: Math.round(percentual),\n    },\n    snapshot: {\n      xp_base_total: Number(row.xp_base_total ?? 0) || 0,\n      xp_bonus_total: Number(row.xp_bonus_total ?? 0) || 0,\n      atualizado_em: row.atualizado_em ?? null,\n    },\n    beneficios,\n  },\n};\n\nreturn [{ json: response }];"
      },
      "id": "34e05fc3-402d-4e3f-a4e6-3e8dba5c66a9",
      "name": "Montar Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        576,
        -96
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "420fab9e-52af-431f-8abb-ef62554bbbe3",
      "name": "Responder Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        816,
        -96
      ]
    }
  ],
  "connections": {
    "Webhook Card Jornada": {
      "main": [
        [
          {
            "node": "Validar Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Params": {
      "main": [
        [
          {
            "node": "Estado Jornada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estado Jornada": {
      "main": [
        [
          {
            "node": "Montar Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Montar Response": {
      "main": [
        [
          {
            "node": "Responder Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "1771af47-e20f-49c9-b78d-b1fd0296451f",
  "triggerCount": 1,
  "shared": [
    {
      "createdAt": "2025-11-14T21:04:26.771Z",
      "role": "workflow:owner",
      "workflowId": "YAIxH4AofzYkV8OB",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}
