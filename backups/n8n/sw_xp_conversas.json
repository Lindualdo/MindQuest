{
  "createdAt": "2025-12-12T20:21:50.690Z",
  "id": "W0i3ufnDIIcx75ez",
  "name": "sw_xp_conversas",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usuario_id"
            },
            {
              "name": "chat_id"
            },
            {
              "name": "data_conversa"
            },
            {
              "name": "total_interactions",
              "type": "number"
            }
          ]
        }
      },
      "id": "62e03181-1b7f-47bf-8702-4cb6aefe384f",
      "name": "start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        768,
        352
      ]
    },
    {
      "parameters": {
        "content": "## Regras: XP Conversas (v3.0)\n\n### Objetivo\nContabilizar XP por dia único de conversa\n\n### Tabelas Afetadas\n| Tabela | Regra |\n|--------|-------|\n| `usuarios_quest` | 1 quest reflexão diária por usuário (permanente, sempre ativa) |\n| `quests_recorrencias` | 1 registro por dia (constraint: usuarios_quest_id + data_planejada) |\n| `usuarios_conquistas` | Atualiza xp_total, xp_base, total_xp_hoje, ultima_conversa_em |\n\n### Decisão Autônoma\n- Já existe recorrência para hoje? → ignora\n- Novo dia válido? → processa\n\n### Controle de Duplicatas\n- Verifica diretamente em `quests_recorrencias`\n- INSERT com ON CONFLICT garante 1 registro/dia\n- Sem dependência de `log_experts` (descontinuado v3)",
        "height": 624,
        "width": 880,
        "color": 5
      },
      "id": "da5a336c-a461-4274-8fa7-fbdbb3b67e35",
      "name": "Regras XP Conversas v3",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -304,
        -160
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Verificar se deve processar (sem log_experts - arquitetura v3)\nWITH params AS (\n  SELECT\n    $1::uuid AS usuario_id,\n    $2::uuid AS chat_id,\n    $3::date AS data_conversa,\n    $4::int AS total_interactions\n),\nquest_catalogo AS (\n  SELECT id, COALESCE(xp, 10) AS xp_valor\n  FROM quests_catalogo\n  WHERE id = '775a9df0-6f08-492f-8172-0be057002177'\n),\nquest_usuario AS (\n  SELECT id FROM usuarios_quest\n  WHERE usuario_id = (SELECT usuario_id FROM params)\n    AND catalogo_id = (SELECT id FROM quest_catalogo)\n  LIMIT 1\n),\nrecorrencia_hoje AS (\n  SELECT id FROM quests_recorrencias\n  WHERE usuarios_quest_id = (SELECT id FROM quest_usuario)\n    AND data_planejada = (SELECT data_conversa FROM params)\n),\ndecisao AS (\n  SELECT CASE\n    WHEN (SELECT id FROM recorrencia_hoje) IS NOT NULL THEN 'xp_ja_contabilizado_hoje'\n    ELSE 'processar'\n  END AS acao\n)\nSELECT\n  p.usuario_id,\n  p.chat_id,\n  p.data_conversa,\n  p.total_interactions,\n  (SELECT acao FROM decisao) AS acao,\n  (SELECT xp_valor FROM quest_catalogo) AS xp_valor,\n  (SELECT id FROM quest_catalogo) AS catalogo_id\nFROM params p;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id, $json.chat_id, $json.data_conversa, $json.total_interactions] }}"
        }
      },
      "id": "aff5d4d8-e45e-4cbd-9bf3-f346d322bb00",
      "name": "Verificar Processamento",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        992,
        352
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "caseSensitive": true,
            "typeValidation": "strict",
            "leftValue": ""
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "check-processar",
              "leftValue": "={{ $json.acao }}",
              "rightValue": "processar",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "b6574fde-ca86-4f1a-b9f9-cfeb1fa7b067",
      "name": "Deve Processar?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1200,
        352
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Buscar ou criar quest reflexão diária (ÚNICA por usuário, sempre ativa)\nWITH params AS (\n  SELECT $1::uuid AS usuario_id, $2::uuid AS catalogo_id\n),\nobjetivo_padrao AS (\n  SELECT id FROM usuarios_objetivos\n  WHERE usuario_id = (SELECT usuario_id FROM params)\n    AND is_padrao = true AND status = 'ativo'\n  LIMIT 1\n),\nquest_existente AS (\n  SELECT id FROM usuarios_quest\n  WHERE usuario_id = (SELECT usuario_id FROM params)\n    AND catalogo_id = (SELECT catalogo_id FROM params)\n  LIMIT 1\n),\ncriar_quest AS (\n  INSERT INTO usuarios_quest (id, usuario_id, catalogo_id, status, ativado_em, objetivo_id, config)\n  SELECT\n    gen_random_uuid(),\n    (SELECT usuario_id FROM params),\n    (SELECT catalogo_id FROM params),\n    'ativa',\n    NOW(),\n    (SELECT id FROM objetivo_padrao),\n    jsonb_build_object('titulo', 'Reflexão Diária', 'recorrencia', 'diaria', 'conversa', true, 'permanente', true)\n  WHERE NOT EXISTS (SELECT 1 FROM quest_existente)\n  RETURNING id\n)\nSELECT COALESCE((SELECT id FROM quest_existente), (SELECT id FROM criar_quest)) AS usuarios_quest_id;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id, $json.catalogo_id] }}"
        }
      },
      "id": "61a15b68-0354-4892-bfe7-20a21742b733",
      "name": "Buscar/Criar Quest",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1472,
        256
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Inserir recorrência da quest\nINSERT INTO quests_recorrencias (\n  usuarios_quest_id,\n  data_planejada,\n  data_concluida,\n  status,\n  xp_base,\n  xp_bonus\n) VALUES (\n  $1::uuid,\n  $2::date,\n  $2::date,\n  'concluida',\n  $3::int,\n  0\n)\nON CONFLICT (usuarios_quest_id, data_planejada) DO UPDATE SET\n  data_concluida = EXCLUDED.data_concluida,\n  status = 'concluida',\n  atualizado_em = NOW()\nRETURNING id, usuarios_quest_id, data_planejada, xp_base;",
        "options": {
          "queryReplacement": "={{ [$json.usuarios_quest_id, $('Verificar Processamento').item.json.data_conversa, $('Verificar Processamento').item.json.xp_valor] }}"
        }
      },
      "id": "7a485d29-d167-4c59-8684-01b05ee909da",
      "name": "Inserir Recorrência",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1680,
        256
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Atualizar XP do usuário\nWITH params AS (\n  SELECT $1::uuid AS usuario_id, $2::int AS xp_valor, $3::date AS data_conversa\n)\nUPDATE usuarios_conquistas SET\n  xp_total = xp_total + (SELECT xp_valor FROM params),\n  xp_base = COALESCE(xp_base, 0) + (SELECT xp_valor FROM params),\n  total_xp_hoje = (SELECT xp_valor FROM params),\n  ultima_conversa_em = (SELECT data_conversa FROM params),\n  atualizado_em = NOW()\nWHERE usuario_id = (SELECT usuario_id FROM params)\nRETURNING usuario_id, xp_total, xp_base, total_xp_hoje;",
        "options": {
          "queryReplacement": "={{ [$('Verificar Processamento').item.json.usuario_id, $('Verificar Processamento').item.json.xp_valor, $('Verificar Processamento').item.json.data_conversa] }}"
        }
      },
      "id": "bfe362b5-1434-49a9-843b-78faeb388d4d",
      "name": "Atualizar XP",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1904,
        256
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Retorna resultado do processamento\nconst verificar = $('Verificar Processamento').item.json;\nconst xpAtualizado = $('Atualizar XP').item.json;\n\nreturn [{\n  json: {\n    usuario_id: verificar.usuario_id,\n    chat_id: verificar.chat_id,\n    resultado: 'processado',\n    xp_ganho: verificar.xp_valor,\n    xp_total: xpAtualizado.xp_total,\n    data_conversa: verificar.data_conversa\n  }\n}];"
      },
      "id": "2c64a925-1866-4f38-b253-b24119a11044",
      "name": "Resultado Processado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2128,
        256
      ]
    },
    {
      "parameters": {
        "jsCode": "// Retorna resultado quando não processa\nconst verificar = $('Verificar Processamento').item.json;\n\nreturn [{\n  json: {\n    usuario_id: verificar.usuario_id,\n    chat_id: verificar.chat_id,\n    resultado: verificar.acao,\n    xp_ganho: 0,\n    xp_total: null,\n    data_conversa: verificar.data_conversa\n  }\n}];"
      },
      "id": "7d5fe691-be8d-4754-a81e-914f6a258491",
      "name": "Resultado Ignorado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1472,
        448
      ]
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Verificar Processamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Processamento": {
      "main": [
        [
          {
            "node": "Deve Processar?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deve Processar?": {
      "main": [
        [
          {
            "node": "Buscar/Criar Quest",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Resultado Ignorado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar/Criar Quest": {
      "main": [
        [
          {
            "node": "Inserir Recorrência",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inserir Recorrência": {
      "main": [
        [
          {
            "node": "Atualizar XP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar XP": {
      "main": [
        [
          {
            "node": "Resultado Processado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": {
    "start": [
      {
        "json": {
          "usuario_id": "0847d8a7-4fba-45f2-9470-a7eeacaa4bd4",
          "chat_id": "5311b88e-54e9-4053-9f7a-b2c5303ef622",
          "data_conversa": "2025-12-16T00:00:00.000Z"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "activeVersionId": null,
  "shared": [
    {
      "createdAt": "2025-12-12T20:21:50.690Z",
      "role": "workflow:owner",
      "workflowId": "W0i3ufnDIIcx75ez",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [],
  "activeVersion": null
}
