{
  "createdAt": "2025-11-07T16:24:43.271Z",
  "id": "ItBastfCTkWxm41M",
  "name": "sw_xp_conversas",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usuario_id"
            },
            {
              "name": "calcular_apenas_novos",
              "type": "boolean"
            }
          ]
        }
      },
      "id": "49706cb5-3248-4933-b20b-46a7b89cbbbf",
      "name": "start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -3712,
        -368
      ]
    },
    {
      "parameters": {
        "jsCode": "const entrada = $input.item.json || {};\nconst usuarioId = entrada.usuario_id || entrada.id || $json.usuario_id;\nif (!usuarioId || typeof usuarioId !== 'string' || !usuarioId.trim()) {\n  throw new Error('usuario_id obrigatório');\n}\nconst rawStringFlag = entrada.recalcular_completo ?? $json.recalcular_completo ?? entrada.force_recalcular ?? entrada.force ?? null;\nconst rawBooleanFlag = entrada.calcular_apenas_novos ?? $json.calcular_apenas_novos;\nconst recalcularCompleto = rawStringFlag === null\n  ? (rawBooleanFlag === false)\n  : (typeof rawStringFlag === 'string'\n      ? ['1','true','yes','y','sim'].includes(rawStringFlag.trim().toLowerCase())\n      : Boolean(rawStringFlag));\nreturn [{\n  json: {\n    usuario_id: usuarioId.trim(),\n    recalcular_completo: recalcularCompleto,\n  },\n}];"
      },
      "id": "e4cf1546-1942-40a2-ae77-bed12561fdb5",
      "name": "Validar Entrada",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3488,
        -368
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  usuario_id,\n  xp_total,\n  total_xp_hoje,\n  sequencia_atual,\n  sequencia_recorde,\n  meta_sequencia_codigo,\n  proxima_meta_codigo,\n  ultima_conversa_em,\n  sequencia_status\nFROM public.usuarios_conquistas\nWHERE usuario_id = $1::uuid;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id] }}"
        }
      },
      "id": "04318245-21d3-4ce2-9baf-1fc0542d7a88",
      "name": "Ler Usuarios Conquistas",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3072,
        -368
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  uc.id,\n  date(uc.data_conversa) AS dia,\n  uc.tem_reflexao,\n  COALESCE(uc.total_palavras_usuario, 0) AS total_palavras_usuario,\n  uc.data_conversa,\n  uc.atualizado_em\nFROM public.usr_chat uc\nWHERE uc.usuario_id = $1::uuid\n  AND uc.data_conversa >= NOW() - INTERVAL '45 days'\nORDER BY dia ASC, uc.data_conversa ASC;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id] }}"
        }
      },
      "id": "49be482b-b623-4a64-b419-4569a71b3d0c",
      "name": "Ler Usr Chat",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "alwaysOutputData": true,
      "position": [
        -2048,
        -672
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const getItem = (nodeName) => {\n  const list = $items(nodeName, 0, 0) || [];\n  return list[0]?.json || null;\n};\nconst getItems = (nodeName) => {\n  const list = $items(nodeName) || [];\n  return list.map((entry) => entry?.json || {});\n};\nconst estado = getItem('Ler Usuarios Conquistas');\nif (!estado) {\n  throw new Error('Estado do usuário não encontrado');\n}\nconst conversas = getItems('Ler Usr Chat');\nconst questReflexao = getItem('Buscar XP Reflexao Diaria');\nif (!questReflexao) {\n  throw new Error('Quest reflexao_diaria não encontrada no catálogo');\n}\nconst xpBaseDiario = Number(questReflexao.xp_recompensa);\nif (!Number.isFinite(xpBaseDiario) || xpBaseDiario <= 0) {\n  throw new Error('XP da quest reflexao_diaria inválido ou não encontrado');\n}\nconst XP_POR_DIA = xpBaseDiario;\nconst toTimestamp = (value) => {\n  if (!value && value !== 0) return null;\n  const date = new Date(value);\n  if (Number.isNaN(date.getTime())) return null;\n  return date.getTime();\n};\nconst toDay = (value) => {\n  if (!value && value !== 0) return null;\n  const date = new Date(value);\n  if (Number.isNaN(date.getTime())) return null;\n  return new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));\n};\nconst parseStatus = () => {\n  const raw = estado.sequencia_status;\n  if (!raw) return { estado: 'ativa', reinicios: 0 };\n  if (typeof raw === 'object') {\n    return { estado: 'ativa', ...raw };\n  }\n  try {\n    return { estado: 'ativa', ...(JSON.parse(raw) || {}) };\n  } catch (error) {\n    return { estado: 'ativa', reinicios: 0 };\n  }\n};\nconst status = parseStatus();\nconst msDia = 24 * 60 * 60 * 1000;\nconst conversasOrdenadas = conversas\n  .map((entrada) => {\n    const timestamp = toTimestamp(entrada.atualizado_em || entrada.data_conversa || entrada.dia);\n    const diaISO = toDay(entrada.atualizado_em || entrada.data_conversa || entrada.dia);\n    const diaISOTexto = diaISO ? diaISO.toISOString() : null;\n    return { ...entrada, timestamp, diaISO, diaISOTexto };\n  })\n  .filter((entrada) => entrada.diaISO && entrada.diaISOTexto && Number.isFinite(entrada.timestamp))\n  .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));\nconst diasUnicosMap = new Map();\nfor (const conversa of conversasOrdenadas) {\n  const chave = conversa.diaISOTexto;\n  if (!chave) continue;\n  if (!diasUnicosMap.has(chave) || (conversa.timestamp || 0) < (diasUnicosMap.get(chave).timestamp || 0)) {\n    diasUnicosMap.set(chave, conversa);\n  }\n}\nconst diasUnicos = Array.from(diasUnicosMap.values()).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));\nconst ultimaRegistradaTimestamp = toTimestamp(estado.ultima_conversa_em);\nconst ultimaDiaRegistrada = toDay(estado.ultima_conversa_em);\nlet xpBaseIncrement = 0;\nlet sequenciaAtual = 0;\nlet sequenciaRecordeCalculado = 0;\nlet reinicios = Number(status.reinicios) || 0;\nconst applyReset = () => {\n  if (sequenciaAtual > 0) {\n    reinicios += 1;\n  }\n  sequenciaAtual = 0;\n};\nlet ultimoDiaSequencia = ultimaDiaRegistrada;\nlet ultimaTimestampProcessado = ultimaRegistradaTimestamp || null;\nlet diasNovos = 0;\nconst diasNovosDetalhes = [];\nfor (const diaInfo of diasUnicos) {\n  const diaISO = diaInfo.diaISO;\n  const timestamp = diaInfo.timestamp;\n  const diaEhNovo = !ultimaDiaRegistrada || diaISO.getTime() > ultimaDiaRegistrada.getTime();\n  if (diaEhNovo) {\n    xpBaseIncrement += XP_POR_DIA;\n    diasNovos += 1;\n    diasNovosDetalhes.push({\n      dia: diaISO.toISOString(),\n      conversa_id: (diaInfo && (diaInfo.conversa_id || diaInfo.id)) ? diaInfo.conversa_id || diaInfo.id : null,\n      data_conversa: diaInfo?.data_conversa || diaISO.toISOString(),\n    });\n  }\n  if (ultimoDiaSequencia) {\n    const diffDias = Math.floor((diaISO.getTime() - ultimoDiaSequencia.getTime()) / msDia);\n    if (diffDias > 1) {\n      applyReset();\n    }\n  }\n  sequenciaAtual += 1;\n  ultimoDiaSequencia = diaISO;\n  ultimaTimestampProcessado = timestamp ?? ultimaTimestampProcessado ?? timestamp;\n  if (sequenciaAtual > sequenciaRecordeCalculado) {\n    sequenciaRecordeCalculado = sequenciaAtual;\n  }\n}\nconst sequenciaRecorde = Math.max(sequenciaRecordeCalculado, Number(estado.sequencia_recorde) || 0);\nconst ultimaConversaISO = ultimoDiaSequencia ? ultimoDiaSequencia.toISOString() : estado.ultima_conversa_em || null;\nconst xpTotalIncrement = xpBaseIncrement;\nreturn [{\n  json: {\n    usuario_id: estado.usuario_id,\n    xp_ganho: xpTotalIncrement,\n    xp_total_increment: xpTotalIncrement,\n    xp_base_increment: xpBaseIncrement,\n    sequencia_atual: sequenciaAtual,\n    sequencia_recorde: sequenciaRecorde,\n    ultima_conversa_em: ultimaConversaISO,\n    sequencia_status: { ...status, estado: 'ativa', reinicios },\n    dias_processados: diasUnicos.length,\n    dias_novos: diasNovos,\n    dias_novos_detalhes: diasNovosDetalhes,\n  },\n}];"
      },
      "id": "7864b7c9-8c3b-4aa7-9ebd-1c1fd77b1700",
      "name": "Calcular XP Conversas",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1344,
        -560
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH payload AS (\n  SELECT\n    $1::uuid AS usuario_id,\n    $2::int AS xp_ganho,\n    $3::int AS sequencia_atual,\n    $4::int AS sequencia_recorde,\n    NULLIF($5::text, '')::timestamptz AS ultima_conversa_em,\n    $6::jsonb AS sequencia_status,\n    $7::int AS xp_base_increment\n),\natualizado AS (\n  UPDATE public.usuarios_conquistas r\n  SET\n    xp_total = r.xp_total + payload.xp_ganho,\n    xp_base = COALESCE(r.xp_base, 0) + payload.xp_base_increment,\n    total_xp_hoje = payload.xp_base_increment,\n    sequencia_atual = payload.sequencia_atual,\n    sequencia_recorde = payload.sequencia_recorde,\n    ultima_conversa_em = COALESCE(payload.ultima_conversa_em, r.ultima_conversa_em),\n    sequencia_status = payload.sequencia_status,\n    atualizado_em = NOW()\n  FROM payload\n  WHERE r.usuario_id = payload.usuario_id\n  RETURNING r.usuario_id\n)\nSELECT\n  payload.usuario_id\nFROM payload\nLEFT JOIN atualizado ON atualizado.usuario_id = payload.usuario_id;",
        "options": {
          "queryReplacement": "={{ [\n  $json.usuario_id,\n  $json.xp_ganho || $json.xp_total_increment || 0,\n  $json.sequencia_atual || 0,\n  $json.sequencia_recorde || 0,\n  ($json.ultima_conversa_em && $json.ultima_conversa_em !== '' ? $json.ultima_conversa_em : null),\n  JSON.stringify($json.sequencia_status || {}),\n  $json.xp_base_increment || 0\n] }}"
        }
      },
      "id": "016bfb6a-ceed-4f95-99c5-0afe05af343a",
      "name": "Atualizar Usuarios Conquistas",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -352,
        -736
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "71Ru87yaRA5SNjOQ",
          "mode": "list",
          "cachedResultUrl": "/workflow/71Ru87yaRA5SNjOQ",
          "cachedResultName": "sw_calcula_jornada"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $json.usuario_id || $item(0).$node['Checar Necessidade'].json.usuario_id || $item(0).$node['Validar Entrada'].json.usuario_id }}"
          },
          "matchingColumns": [
            "usuario_id"
          ],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "675129c6-ae76-42bd-a5fa-8b402a62f562",
      "name": "Atualizar Jornada",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -32,
        -736
      ]
    },
    {
      "parameters": {
        "jsCode": "const parseDay = (value) => {\n  if (!value) return null;\n  const date = new Date(value);\n  if (Number.isNaN(date.getTime())) return null;\n  return Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate());\n};\n\nconst today = new Date();\nconst todayUtc = Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate());\n\nconst normalizeStatus = (raw) => {\n  if (raw && typeof raw === 'object') {\n    return { ...raw };\n  }\n  if (typeof raw === 'string') {\n    try {\n      const parsed = JSON.parse(raw);\n      if (parsed && typeof parsed === 'object') {\n        return { ...parsed };\n      }\n    } catch (_err) {\n      // ignore\n    }\n  }\n  return {};\n};\n\nreturn $input.all().map(({ json }) => {\n  const ultimaConversaoUtc = parseDay(json.ultima_conversa_em);\n  const diffDias = ultimaConversaoUtc === null\n    ? Number.POSITIVE_INFINITY\n    : Math.floor((todayUtc - ultimaConversaoUtc) / 86_400_000);\n\n  if (!Number.isFinite(diffDias) || diffDias > 1) {\n    const statusAtual = normalizeStatus(json.sequencia_status);\n    const reinicios = Number.isFinite(Number(statusAtual.reinicios))\n      ? Number(statusAtual.reinicios) + 1\n      : 1;\n\n    json.sequencia_atual = 0;\n    json.sequencia_status = {\n      estado: 'reiniciada',\n      reinicios,\n      ultimo_reset_em: new Date().toISOString(),\n    };\n  }\n\n  return { json };\n});"
      },
      "id": "c2e58654-f690-4461-887c-e3c86d1828a5",
      "name": "Zerar Sequência se Gap",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -928,
        -768
      ]
    },
    {
      "parameters": {
        "jsCode": "const estado = $json || {};\nconst entrada = ($items('Validar Entrada', 0, 0) || [])[0]?.json || {};\nconst force = Boolean(entrada.recalcular_completo);\nconst hoje = new Date();\nconst hojeUtc = Date.UTC(hoje.getUTCFullYear(), hoje.getUTCMonth(), hoje.getUTCDate());\nconst ultima = estado.ultima_conversa_em ? new Date(estado.ultima_conversa_em) : null;\nconst ultimaUtc = ultima ? Date.UTC(ultima.getUTCFullYear(), ultima.getUTCMonth(), ultima.getUTCDate()) : null;\nconst diffDias = ultimaUtc === null ? Number.POSITIVE_INFINITY : Math.max(0, Math.floor((hojeUtc - ultimaUtc) / 86_400_000));\nconst precisaRecalcular = force || diffDias >= 1;\nreturn [{\n  json: {\n    ...estado,\n    usuario_id: entrada.usuario_id ?? estado.usuario_id ?? null,\n    recalcular_completo: force,\n    precisa_recalcular: precisaRecalcular,\n    dias_desde_ultima_conversa: diffDias,\n  },\n}];"
      },
      "id": "d403ecb7-7f3c-4d85-a085-f880334fecc7",
      "name": "Checar Necessidade",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2832,
        -368
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.precisa_recalcular }}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "id": "e821d79f-774b-4b22-92df-c7ac92cdcfab",
      "name": "Precisa Recalcular?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        -2592,
        -368
      ]
    },
    {
      "parameters": {
        "jsCode": "const getItem = (nodeName) => {\n  const list = $items(nodeName, 0, 0) || [];\n  return list[0]?.json || null;\n};\n// Buscar dados de 'Calcular XP Conversas' (onde estão dias_novos, xp_base_increment, etc)\nconst calcularXP = getItem('Calcular XP Conversas');\n// Buscar dados de 'Buscar ou Criar Quest Reflexao' (onde está usuarios_quest_id)\nconst questReflexao = getItem('Buscar ou Criar Quest Reflexao');\nif (!calcularXP || !questReflexao) {\n  return [];\n}\nconst usuarioId = calcularXP.usuario_id;\nconst diasNovos = calcularXP.dias_novos || 0;\nconst xpBase = calcularXP.xp_base_increment || calcularXP.xp_base_diario || 0;\nconst usuariosQuestId = questReflexao?.usuarios_quest_id || null;\nif (!usuarioId || !diasNovos || !xpBase || !usuariosQuestId) {\n  return [];\n}\nconst detalhesOrigem = Array.isArray(calcularXP.dias_novos_detalhes) ? calcularXP.dias_novos_detalhes : [];\nconst xpPorDia = diasNovos > 0 ? xpBase / diasNovos : 0;\nconst ocorrencias = detalhesOrigem.map((item) => ({\n  data_planejada: item && item.dia ? item.dia : null,\n  data_concluida: item && item.data_conversa ? item.data_conversa : (item && item.dia ? item.dia : null),\n  data_registrada: new Date().toISOString(),\n  xp_base: xpPorDia,\n  xp_bonus: 0,\n  usr_chat_id: item && item.conversa_id ? item.conversa_id : null,\n  data_conversa: item && item.data_conversa ? item.data_conversa : (item && item.dia ? item.dia : null),\n}));\nreturn [{\n  json: {\n    usuario_id: usuarioId,\n    usuarios_quest_id: usuariosQuestId,\n    meta_codigo: usuariosQuestId,\n    meta_titulo: 'Conversa diária',\n    xp_base_increment: xpBase,\n    recorrencia_increment: diasNovos,\n    ocorrencias,\n  },\n}];"
      },
      "id": "f183d370-5e8a-43a4-a799-7f6092ab5b5f",
      "name": "Preparar XP Diário",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -928,
        -544
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH payload AS (\n  SELECT\n    $1::uuid AS usuario_id,\n    $2::uuid AS usuarios_quest_id,\n    $3::jsonb AS ocorrencias,\n    $4::int AS xp_base_increment\n),\nocorrencias_expandidas AS (\n  SELECT\n    payload.usuarios_quest_id,\n    (occ->>'data_planejada')::date AS data_planejada,\n    (occ->>'data_concluida')::date AS data_concluida,\n    COALESCE((occ->>'xp_base')::int, payload.xp_base_increment / GREATEST(jsonb_array_length(payload.ocorrencias), 1)) AS xp_base_ocorrencia\n  FROM payload,\n       jsonb_array_elements(payload.ocorrencias) AS occ\n  WHERE occ->>'data_planejada' IS NOT NULL\n    AND occ->>'data_concluida' IS NOT NULL\n),\ninseridas AS (\n  INSERT INTO public.quests_recorrencias (\n    usuarios_quest_id,\n    data_planejada,\n    data_concluida,\n    status,\n    xp_base,\n    xp_bonus\n  )\n  SELECT\n    oe.usuarios_quest_id,\n    oe.data_planejada,\n    oe.data_concluida,\n    'concluida',\n    oe.xp_base_ocorrencia,\n    0\n  FROM ocorrencias_expandidas oe\n  WHERE NOT EXISTS (\n    SELECT 1 FROM public.quests_recorrencias qr\n    WHERE qr.usuarios_quest_id = oe.usuarios_quest_id\n      AND qr.data_planejada = oe.data_planejada\n  )\n  ON CONFLICT (usuarios_quest_id, data_planejada) DO UPDATE\n  SET\n    data_concluida = EXCLUDED.data_concluida,\n    status = 'concluida',\n    xp_base = EXCLUDED.xp_base,\n    atualizado_em = NOW()\n  RETURNING id\n)\nSELECT\n  payload.usuario_id,\n  payload.usuarios_quest_id,\n  COUNT(*) AS ocorrencias_inseridas\nFROM payload\nCROSS JOIN ocorrencias_expandidas\nGROUP BY payload.usuario_id, payload.usuarios_quest_id;\n",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id, $json.usuarios_quest_id, JSON.stringify($json.ocorrencias || []), $json.xp_base_increment || 0] }}"
        }
      },
      "id": "46035dfd-e1fa-4b7d-a01a-6338490475ab",
      "name": "Inserir Recorrencias Conversas",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -640,
        -544
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH payload AS (\n  SELECT $1::uuid AS usuario_id\n),\nverificar_quests AS (\n  SELECT COUNT(*) AS total_quests\n  FROM public.usuarios_quest uq\n  WHERE uq.usuario_id = (SELECT usuario_id FROM payload)\n    AND uq.status IN ('disponivel', 'ativa')\n),\nbuscar_reflexao_diaria AS (\n  SELECT id\n  FROM public.quests_catalogo\n  WHERE codigo = 'reflexao_diaria'\n  LIMIT 1\n),\nbuscar_objetivo_padrao AS (\n  SELECT id\n  FROM public.usuarios_objetivos\n  WHERE usuario_id = (SELECT usuario_id FROM payload)\n    AND is_padrao = true\n    AND status = 'ativo'\n  LIMIT 1\n),\ncriar_quest_inicial AS (\n  INSERT INTO public.usuarios_quest (\n    id,\n    usuario_id,\n    catalogo_id,\n    status,\n    ativado_em,\n    objetivo_id,\n    config\n  )\n  SELECT\n    gen_random_uuid(),\n    (SELECT usuario_id FROM payload),\n    brd.id,\n    'ativa',\n    NOW(),\n    (SELECT id FROM buscar_objetivo_padrao),\n    jsonb_build_object(\n      'titulo', 'Reflexão Diária',\n      'descricao', 'Conversa com seu Assistente de reflexão',\n      'prioridade', 'alta',\n      'recorrencia', 'diaria',\n      'conversa', true,\n      'contexto_origem', 'sistema'\n    )\n  FROM buscar_reflexao_diaria brd\n  CROSS JOIN verificar_quests vq\n  WHERE vq.total_quests = 0\n  RETURNING id, objetivo_id\n),\ninserir_quest_objetivo AS (\n  INSERT INTO public.quest_objetivos (usuarios_quest_id, objetivo_id, tipo_impacto)\n  SELECT id, objetivo_id, 'direto'\n  FROM criar_quest_inicial\n  WHERE objetivo_id IS NOT NULL\n  ON CONFLICT (usuarios_quest_id, objetivo_id) DO NOTHING\n  RETURNING id\n),\nbuscar_quest_existente AS (\n  SELECT uq.id, uq.objetivo_id\n  FROM public.usuarios_quest uq\n  JOIN buscar_reflexao_diaria brd ON uq.catalogo_id = brd.id\n  WHERE uq.usuario_id = (SELECT usuario_id FROM payload)\n    AND uq.status IN ('disponivel', 'ativa')\n  LIMIT 1\n)\nSELECT\n  (SELECT usuario_id FROM payload) AS usuario_id,\n  COALESCE(\n    (SELECT id FROM buscar_quest_existente),\n    (SELECT id FROM criar_quest_inicial LIMIT 1)\n  ) AS usuarios_quest_id,\n  COALESCE(\n    (SELECT objetivo_id FROM buscar_quest_existente),\n    (SELECT objetivo_id FROM criar_quest_inicial LIMIT 1)\n  ) AS objetivo_id;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id] }}"
        }
      },
      "id": "eb0dff98-881e-4a28-b746-d1175f9c52c4",
      "name": "Buscar ou Criar Quest Reflexao",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1104,
        -544
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const entrada = $items('Validar Entrada', 0, 0) || [];\nconst payload = entrada[0]?.json || {};\nreturn [{ json: { usuario_id: payload.usuario_id || null } }];"
      },
      "id": "50410b8f-2c87-48d6-8e65-61f359129433",
      "name": "Retornar Resultado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        192,
        272
      ]
    },
    {
      "parameters": {
        "jsCode": "const entrada = ($items('Validar Entrada', 0, 0) || [])[0]?.json || {};\nconst usuarioId = entrada.usuario_id || $json.usuario_id || null;\nif (!usuarioId) {\n  return [];\n}\nreturn [{ json: { usuario_id: usuarioId } }];"
      },
      "id": "b595a191-517a-4371-854a-1a7c09aaee7b",
      "name": "Garantir Retorno Batch",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -320,
        -96
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH alvo AS (\n  SELECT $1::uuid AS usuario_id\n)\nINSERT INTO public.usuarios_conquistas (\n  usuario_id,\n  xp_total,\n  xp_proximo_nivel,\n  nivel_atual,\n  titulo_nivel,\n  sequencia_atual,\n  sequencia_recorde,\n  meta_sequencia_codigo,\n  proxima_meta_codigo,\n  sequencia_status,\n  total_quests_concluidas,\n  total_quests_personalizadas,\n  total_xp_hoje,\n  ultima_conversa_em,\n  xp_base,\n  xp_bonus,\n  criado_em,\n  atualizado_em\n)\nSELECT\n  alvo.usuario_id,\n  0,\n  500,\n  1,\n  'Despertar',\n  0,\n  0,\n  'streak_003',\n  'streak_005',\n  jsonb_build_object('estado', 'ativa', 'alvo_conversas', 3, 'reinicios', 0, 'completado_em', NULL),\n  0,\n  0,\n  0,\n  NULL,\n  0,\n  0,\n  NOW(),\n  NOW()\nFROM alvo\nON CONFLICT (usuario_id) DO NOTHING\nRETURNING usuario_id;\n\nselect $1 as usuario_id",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id] }}"
        }
      },
      "id": "21ee153f-e997-4609-995f-d479ca0703dc",
      "name": "Criar Registro Base",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3280,
        -368
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Buscar quest reflexao_diaria do catálogo\nSELECT\n  codigo,\n  'Reflexão Diária' AS titulo,\n  COALESCE(xp, 10) AS xp_recompensa\nFROM public.quests_catalogo\nWHERE codigo = 'reflexao_diaria'\nLIMIT 1;",
        "options": {}
      },
      "id": "083dc99b-d558-4d5e-a1b6-a9ee772c8daf",
      "name": "Buscar XP Reflexao Diaria",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2000,
        -112
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {},
      "id": "95626b95-0ee5-42b2-a66b-c206ef390ed6",
      "name": "Aguardar Quest Reflexao",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -1664,
        -544
      ]
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Validar Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ler Usuarios Conquistas": {
      "main": [
        [
          {
            "node": "Checar Necessidade",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ler Usr Chat": {
      "main": [
        [
          {
            "node": "Aguardar Quest Reflexao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular XP Conversas": {
      "main": [
        [
          {
            "node": "Zerar Sequência se Gap",
            "type": "main",
            "index": 0
          },
          {
            "node": "Buscar ou Criar Quest Reflexao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Usuarios Conquistas": {
      "main": [
        [
          {
            "node": "Atualizar Jornada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Zerar Sequência se Gap": {
      "main": [
        [
          {
            "node": "Atualizar Usuarios Conquistas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Checar Necessidade": {
      "main": [
        [
          {
            "node": "Precisa Recalcular?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Precisa Recalcular?": {
      "main": [
        [
          {
            "node": "Ler Usr Chat",
            "type": "main",
            "index": 0
          },
          {
            "node": "Garantir Retorno Batch",
            "type": "main",
            "index": 0
          },
          {
            "node": "Buscar XP Reflexao Diaria",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Retornar Resultado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar ou Criar Quest Reflexao": {
      "main": [
        [
          {
            "node": "Preparar XP Diário",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar XP Diário": {
      "main": [
        [
          {
            "node": "Inserir Recorrencias Conversas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inserir Recorrencias Conversas": {
      "main": [
        [
          {
            "node": "Atualizar Usuarios Conquistas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Garantir Retorno Batch": {
      "main": [
        [
          {
            "node": "Retornar Resultado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Entrada": {
      "main": [
        [
          {
            "node": "Criar Registro Base",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar Registro Base": {
      "main": [
        [
          {
            "node": "Ler Usuarios Conquistas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar XP Reflexao Diaria": {
      "main": [
        [
          {
            "node": "Aguardar Quest Reflexao",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Aguardar Quest Reflexao": {
      "main": [
        [
          {
            "node": "Calcular XP Conversas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": {
    "start": [
      {
        "json": {
          "usuario_id": "1d74e1c4-a42c-4641-8db9-da3b80b8dbff",
          "calcular_apenas_novos": false
        }
      }
    ]
  },
  "shared": [
    {
      "createdAt": "2025-11-07T16:24:43.271Z",
      "role": "workflow:owner",
      "workflowId": "ItBastfCTkWxm41M",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}
