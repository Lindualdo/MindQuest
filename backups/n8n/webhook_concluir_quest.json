{
  "createdAt": "2025-11-19T11:51:06.793Z",
  "id": "YF4CyvHY0BbLWNwC",
  "name": "webhook_concluir_quest",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "path": "concluir-quest",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "19162385-f973-49ec-b83a-714f8831a486",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        0,
        0
      ],
      "webhookId": "fb885634-496c-466f-b897-d2b75db029c7",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first()?.json ?? {};\nconst query = input.query ?? {};\n\nconst usuarioId = [query.usuario_id, query.user_id, query.usuarioId, query.userId].find((value) => typeof value === 'string' && value.trim().length > 0);\nconst questId = query.quest_id ?? query.questId ?? query.instancia_id;\nconst dataReferencia = query.data_referencia ?? query.dataReferencia;\n\nif (!usuarioId) {\n  throw new Error('usuario_id obrigatório');\n}\nif (!questId || typeof questId !== 'string' || questId.trim().length === 0) {\n  throw new Error('quest_id obrigatório');\n}\n\nreturn [{\n  json: {\n    usuario_id: usuarioId.trim(),\n    quest_id: questId.trim(),\n    data_referencia: dataReferencia && typeof dataReferencia === 'string' ? dataReferencia.trim() : null,\n    fonte: typeof query.fonte === 'string' ? query.fonte.trim() || 'app_v1.3' : 'app_v1.3',\n    comentario: typeof query.comentario === 'string' ? query.comentario.trim() || null : null,\n  }\n}];"
      },
      "id": "bb9b30ba-66a0-4902-8579-689d742d0a1c",
      "name": "Normalizar Entrada",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "const normalizarItem = $input.first()?.json ?? {};\nconst questId = normalizarItem.quest_id;\nconst usuarioId = normalizarItem.usuario_id;\nconst dataReferencia = normalizarItem.data_referencia;\n\nif (!questId || !usuarioId) {\n  throw new Error('Quest não encontrada ou dados inválidos');\n}\n\n// Validar que a quest existe e está ativa/pendente\n// Não atualizar recorrencias - apenas validar\nreturn [{\n  json: {\n    usuario_id: usuarioId,\n    quest_id: questId,\n    data_referencia: dataReferencia || null\n  }\n}];"
      },
      "id": "7b600f2a-a5d4-4002-9b6d-2f26946bb94c",
      "name": "Validar Atualização",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        0
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "bTeLj5qOKQo9PDMO",
          "mode": "list",
          "cachedResultUrl": "/workflow/bTeLj5qOKQo9PDMO",
          "cachedResultName": "sw_xp_quest"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "usuario_id": "={{ $json.usuario_id }}",
            "quests_personalizadas": "[]",
            "atualizacoes_status": "={{ JSON.stringify([{instancia_id: $json.quest_id, novo_status: 'concluida', progresso_atual: 0, xp_extra: 0, data_referencia: $json.data_referencia}]) }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "usuario_id",
              "displayName": "usuario_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "quests_personalizadas",
              "displayName": "quests_personalizadas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "atualizacoes_status",
              "displayName": "atualizacoes_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "id": "3d6812f9-85c5-4e4a-8d84-465345060250",
      "name": "Calcular XP Quest",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        960,
        0
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  uq.id AS quest_id,\n  uq.usuario_id,\n  uq.status,\n  uq.config,\n  uq.concluido_em,\n  uq.atualizado_em,\n  uq.recorrencias,\n  uq.catalogo_id,\n  uq.quest_estagio,\n  uc.xp_total,\n  uc.xp_base,\n  uc.xp_bonus,\n  uc.total_quests_concluidas,\n  uc.total_quests_personalizadas,\n  -- Calcular progresso a partir das recorrências e datas concluídas\n  COALESCE(\n    (\n      SELECT COUNT(*)\n      FROM jsonb_array_elements(uq.recorrencias->'dias') AS dia\n      WHERE dia->>'data' IS NOT NULL\n    ),\n    0\n  ) AS progresso_meta,\n  COALESCE(\n    (\n      SELECT COUNT(DISTINCT (occ->>'data_concluida')::date)\n      FROM public.conquistas_historico ch\n      CROSS JOIN LATERAL jsonb_array_elements(ch.detalhes->'ocorrencias') AS occ\n      WHERE ch.usuarios_quest_id = uq.id\n        AND ch.usuario_id = uq.usuario_id\n        AND ch.tipo = 'quest'\n        AND (occ->>'data_concluida') IS NOT NULL\n    ),\n    0\n  ) AS progresso_atual,\n  -- Buscar XP concedido do histórico de conquistas\n  COALESCE(\n    (\n      SELECT SUM((occ->>'xp_base')::int + COALESCE((occ->>'xp_bonus')::int, 0))\n      FROM public.conquistas_historico ch\n      CROSS JOIN LATERAL jsonb_array_elements(ch.detalhes->'ocorrencias') AS occ\n      WHERE ch.usuarios_quest_id = uq.id\n        AND ch.usuario_id = uq.usuario_id\n        AND ch.tipo = 'quest'\n    ),\n    0\n  ) AS xp_concedido\nFROM public.usuarios_quest uq\nLEFT JOIN public.usuarios_conquistas uc ON uc.usuario_id = uq.usuario_id\nWHERE uq.id = $1::uuid\n  AND uq.usuario_id = $2::uuid\nLIMIT 1;",
        "options": {
          "queryReplacement": "={{ [$('Validar Atualização').item.json.quest_id, $('Validar Atualização').item.json.usuario_id] }}"
        }
      },
      "id": "c9760067-6254-45cd-ab53-e82eb080b2a6",
      "name": "Buscar Quest Final",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1200,
        0
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first()?.json ?? {};\n\n// Calcular progresso percentual\nconst progressoMeta = item.progresso_meta || 0;\nconst progressoAtual = item.progresso_atual || 0;\nconst progressoPercentual = progressoMeta > 0 ? Math.round((progressoAtual / progressoMeta) * 100) : 0;\n\nreturn [{\n  json: {\n    success: true,\n    quest_id: item.quest_id,\n    usuario_id: item.usuario_id,\n    status: item.status,\n    xp_adicionado: item.xp_concedido || 0,\n    xp_base: item.xp_base || 0,\n    xp_bonus: item.xp_bonus || 0,\n    total_quests_concluidas: item.total_quests_concluidas || 0,\n    total_quests_personalizadas: item.total_quests_personalizadas || 0,\n    quest: {\n      id: item.quest_id,\n      status: item.status,\n      progresso_meta: progressoMeta,\n      progresso_atual: progressoAtual,\n      progresso_percentual: progressoPercentual,\n      xp_concedido: item.xp_concedido || 0,\n      config: item.config,\n      concluido_em: item.concluido_em,\n      atualizado_em: item.atualizado_em\n    }\n  }\n}];"
      },
      "id": "a2e79b6f-5ba1-4148-b6e3-0343dded1c13",
      "name": "Formatar Resposta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1440,
        0
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "2cd2bbfa-1594-4759-85ab-84a218591602",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1680,
        0
      ]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Normalizar Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Atualização": {
      "main": [
        [
          {
            "node": "Calcular XP Quest",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Quest Final": {
      "main": [
        [
          {
            "node": "Formatar Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar Resposta": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular XP Quest": {
      "main": [
        [
          {
            "node": "Buscar Quest Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Entrada": {
      "main": [
        [
          {
            "node": "Validar Atualização",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "5c4a2121-f1d7-4356-b6b4-28a9168c8f13",
  "triggerCount": 1,
  "shared": [
    {
      "createdAt": "2025-11-19T11:51:06.793Z",
      "role": "workflow:owner",
      "workflowId": "YF4CyvHY0BbLWNwC",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}
