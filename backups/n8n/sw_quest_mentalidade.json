{
  "createdAt": "2025-12-22T20:01:47.700Z",
  "id": "wYvNVnfs7T16H3zv",
  "name": "sw_quest_mentalidade",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usuario_id"
            },
            {
              "name": "chat_id"
            },
            {
              "name": "contexto",
              "type": "object"
            }
          ]
        }
      },
      "id": "27009cc9-5c07-4976-a0ec-c8bfe2845658",
      "name": "start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -1248,
        80
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Buscar quests do catálogo: TCC, Estoicismo, Boas Práticas\nSELECT \n  id,\n  codigo,\n  titulo,\n  descricao,\n  categoria,\n  base_cientifica,\n  xp\nFROM quests_catalogo\nWHERE ativo = true\n  AND categoria IN ('tcc', 'estoicismo', 'boa_pratica_geral')\nORDER BY nivel_prioridade DESC, RANDOM()\nLIMIT 10;",
        "options": {}
      },
      "id": "d94809e0-5ed2-446d-91d3-733fda8e5520",
      "name": "Buscar Catálogo",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1056,
        80
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Buscar quests existentes do tipo mentalidade (últimos 30 dias)\nSELECT \n  uq.id,\n  uq.catalogo_id,\n  uq.status,\n  uq.ativado_em,\n  uq.config->>'titulo' as titulo,\n  qc.categoria,\n  qc.codigo\nFROM usuarios_quest uq\nLEFT JOIN quests_catalogo qc ON qc.id = uq.catalogo_id\nWHERE uq.usuario_id = $1::uuid\n  AND uq.status IN ('ativa', 'disponivel')\n  AND (\n    qc.categoria IN ('tcc', 'estoicismo', 'boa_pratica_geral')\n    OR (uq.catalogo_id = '00000000-0000-0000-0000-000000000001' \n        AND uq.config->>'contexto_origem' LIKE '%mental%')\n  )\n  AND uq.ativado_em > NOW() - INTERVAL '30 days'\nORDER BY uq.ativado_em DESC;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id] }}"
        }
      },
      "id": "5fc64cd9-822c-48ff-8925-7993143b6c2e",
      "name": "Buscar Existentes",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -864,
        80
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Anti-Duplicação: Keywords + Cooldown v2.2\n// Ajuste: evitar `return` dentro de callbacks (validador n8n) e manter retorno final { json: { ... } }\n\nconst entrada = ($items('start')[0] || {}).json || {};\nconst contexto = entrada.contexto || {};\n\nconst catalogo = ($items('Buscar Catálogo') || []).map(i => i.json);\nconst existentes = ($items('Buscar Existentes') || []).map(i => i.json);\n\nconst STOPWORDS = new Set(['para', 'com', 'uma', 'seu', 'sua', 'que', 'sobre']);\n\nconst normalize = (s) => (s || '')\n  .toLowerCase()\n  .normalize('NFD')\n  .replace(/[\\u0300-\\u036f]/g, '');\n\nconst keywordsFrom = (texto) => {\n  const words = normalize(texto).split(/\\s+/)\n    .filter(w => w.length > 3)\n    .filter(w => !STOPWORDS.has(w));\n  return new Set(words);\n};\n\n// Remover catálogos já usados\nconst catalogoIdsUsados = new Set(existentes.map(e => e.catalogo_id).filter(Boolean));\nconst catalogoDisponivel = catalogo.filter(q => !catalogoIdsUsados.has(q.id));\n\n// Cooldown: comparar com quests recentes (14 dias)\nconst agora = new Date();\nconst existentesRecentes = existentes.filter(e => (\n  e.ativado_em && ((agora - new Date(e.ativado_em)) / (1000 * 60 * 60 * 24)) <= 14\n));\n\nconst bloqueios = [];\n\nfor (const quest of catalogoDisponivel) {\n  const kQuest = keywordsFrom(quest.titulo);\n\n  for (const existente of existentesRecentes) {\n    const kExist = keywordsFrom(existente.titulo);\n\n    if (kQuest.size === 0 || kExist.size === 0) {\n      continue;\n    }\n\n    const intersecao = [...kQuest].filter(w => kExist.has(w)).length;\n    const uniao = new Set([...kQuest, ...kExist]).size;\n    const sim = uniao > 0 ? intersecao / uniao : 0;\n\n    if (sim > 0.5) {\n      bloqueios.push({\n        catalogo_id: quest.id,\n        motivo: 'similaridade_alta',\n        similaridade: Number(sim.toFixed(2)),\n        quest_existente: existente.titulo\n      });\n    }\n  }\n}\n\nconst catalogoIdsBloqueados = new Set(bloqueios.map(b => b.catalogo_id));\nconst catalogoFinal = catalogoDisponivel.filter(q => !catalogoIdsBloqueados.has(q.id));\n\nreturn [{\n  json: {\n    usuario_id: entrada.usuario_id,\n    chat_id: entrada.chat_id,\n    pode_criar: catalogoFinal.length > 0,\n    motivo: catalogoFinal.length > 0 ? 'ok' : 'sem_opcoes_disponiveis',\n    catalogo_disponivel: catalogoFinal,\n    bloqueios,\n    contexto\n  }\n}];"
      },
      "id": "3ff4f5b8-cc9a-458a-98f1-b601105fb6fd",
      "name": "Verificar Duplicação",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -640,
        80
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "pode_criar",
              "leftValue": "={{ $json.pode_criar }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "5e505f07-dac3-440e-95d1-10b517eb5949",
      "name": "Pode Criar?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -432,
        80
      ]
    },
    {
      "parameters": {
        "jsCode": "// Saída sem criar\nconst input = $input.item.json || {};\n\nreturn [{\n  json: {\n    sucesso: false,\n    tipo: 'mentalidade',\n    motivo: input.motivo || 'bloqueado',\n    bloqueios: input.bloqueios || [],\n    quest_criada: null\n  }\n}];"
      },
      "id": "e59eee6a-00dd-4441-a0ec-ec7d39787a60",
      "name": "Saída Sem Criar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -208,
        96
      ]
    },
    {
      "parameters": {
        "jsCode": "// Selecionar quest do catálogo (prioridade humor/energia)\nconst input = $input.item.json || {};\nconst catalogo = input.catalogo_disponivel || [];\nconst contexto = input.contexto || {};\n\nif (catalogo.length === 0) {\n  throw new Error('Nenhuma quest disponível no catálogo');\n}\n\n// Priorizar por humor/energia\nlet questSelecionada;\nif (contexto.humor < 4 || contexto.energia < 4) {\n  // Priorizar TCC\n  questSelecionada = catalogo.find(q => q.categoria === 'tcc') || catalogo[0];\n} else if (contexto.humor < 5 || contexto.energia < 5) {\n  // Priorizar Estoicismo ou Boas Práticas\n  questSelecionada = catalogo.find(q => q.categoria === 'estoicismo') \n    || catalogo.find(q => q.categoria === 'boa_pratica_geral')\n    || catalogo[0];\n} else {\n  // Qualquer uma\n  questSelecionada = catalogo[0];\n}\n\nreturn [{\n  json: {\n    usuario_id: input.usuario_id,\n    chat_id: input.chat_id,\n    quest_catalogo: questSelecionada,\n    contexto: contexto\n  }\n}];"
      },
      "id": "1d7c2c33-a804-4beb-b7ec-108489f76981",
      "name": "Selecionar Quest",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1216,
        368
      ]
    },
    {
      "parameters": {
        "jsCode": "// Preparar Insert - Quest Mentalidade v2\n// CORREÇÃO: acessar output do agente\nconst entrada = $items('Selecionar Quest', 0, 0)[0].json;\nconst adaptado = $input.item.json;\n\nreturn [{\n  json: {\n    usuario_id: entrada.usuario_id,\n    chat_id: entrada.chat_id,\n    catalogo_id: entrada.quest_catalogo.id,\n    titulo: adaptado.output.titulo,\n    descricao: adaptado.output.descricao,\n    base_cientifica: entrada.quest_catalogo.base_cientifica || null\n  }\n}];"
      },
      "id": "4bd34b97-310b-48e1-b0ab-21c64dfc833b",
      "name": "Preparar Insert",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -688,
        368
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO usuarios_quest (\n  usuario_id,\n  chat_id,\n  catalogo_id,\n  status,\n  config,\n  ativado_em\n)\nVALUES (\n  $1::uuid,\n  $2::uuid,\n  $3::uuid,\n  'disponivel',\n  jsonb_build_object(\n    'titulo', $4,\n    'descricao', $5,\n    'contexto_origem', 'mentalidade_adaptado',\n    'base_cientifica', $6::jsonb\n  ),\n  NOW()\n)\nRETURNING id, catalogo_id, status, config;",
        "options": {
          "queryReplacement": "={{ [$json.usuario_id, $json.chat_id, $json.catalogo_id, $json.titulo, $json.descricao, JSON.stringify($json.base_cientifica || {})] }}"
        }
      },
      "id": "99c383b3-5bc1-4d7a-81dc-385ece5942d5",
      "name": "Inserir Quest",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -432,
        368
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Montar resposta final\nconst quest = $input.item.json || {};\n\nreturn [{\n  json: {\n    sucesso: true,\n    tipo: 'mentalidade',\n    quest_criada: {\n      id: quest.id,\n      catalogo_id: quest.catalogo_id,\n      titulo: quest.config?.titulo || quest.catalogo_titulo,\n      categoria: quest.categoria,\n      status: quest.status\n    }\n  }\n}];"
      },
      "id": "27d070a8-a4fc-4b09-ad9d-e31bf1a65155",
      "name": "Saída Sucesso",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -208,
        368
      ]
    },
    {
      "parameters": {
        "model": "google/gemini-3-flash-preview",
        "options": {}
      },
      "id": "llm-mentalidade",
      "name": "OpenRouter",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -1040,
        592
      ],
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\"type\":\"object\",\"properties\":{\"titulo\":{\"type\":\"string\",\"description\":\"Título da quest (max 70 chars)\"},\"descricao\":{\"type\":\"string\",\"description\":\"Descrição da ação prática\"}},\"required\":[\"titulo\",\"descricao\"]}"
      },
      "id": "parser-mentalidade",
      "name": "Parser Quest",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        -848,
        576
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=<input>\n<tecnica_catalogo>\n<titulo>{{ $json.quest_catalogo.titulo }}</titulo>\n<descricao>{{ $json.quest_catalogo.descricao }}</descricao>\n<base_cientifica>{{ JSON.stringify($json.quest_catalogo.base_cientifica || {}) }}</base_cientifica>\n</tecnica_catalogo>\n<estado_emocional>\n<humor valor=\"{{ $json.contexto.humor || 6 }}\">{{ $json.contexto.justificativa_humor || '' }}</humor>\n<energia valor=\"{{ $json.contexto.energia || 6 }}\">{{ $json.contexto.justificativa_energia || '' }}</energia>\n<emocoes>{{ $json.contexto.emocoes_texto || 'não detectadas' }}</emocoes>\n</estado_emocional>\n<conversa>{{ $json.contexto.resumo_conversa || 'conversa de reflexão' }}</conversa>\n</input>\n\n<task>\nAdapte a técnica de <tecnica_catalogo> ao <estado_emocional> do usuário.\nUse <conversa> para contextualizar.\nNUNCA use termos técnicos no título.\n</task>\n\n<output>{\"titulo\": \"string (max 70 chars)\", \"descricao\": \"string\"}</output>",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=<role>\nVocê é o Especialista em Quests de Mentalidade do MindQuest.\nVocê representa o **AGIR** no framework: CONVERSAR → ENTENDER → AGIR → EVOLUIR.\n</role>\n\n<objective>\nAdaptar técnicas do catálogo ao contexto emocional do usuário.\n</objective>\n\n<success_criteria>\n1. **Nomenclatura**: Título = VERBO + OBJETO + RESULTADO (sem jargões)\n2. **Atrito**: Executável em <5 minutos\n3. **Propósito**: Usuário entende o \"porquê\" instantaneamente\n4. **Nativismo**: APENAS funcionalidades MindQuest (nunca apps externos)\n</success_criteria>\n\n<input_usage>\nUSE OS DADOS DE ENTRADA:\n- <tecnica_catalogo> → base para adaptar (título, descrição, base_cientifica)\n- <estado_emocional> → adaptar intensidade e abordagem\n- <conversa> → contextualizar ação\n</input_usage>\n\n<forbidden_terms>\nNUNCA usar no título: TCC, Mindfulness, Estoicismo, Respiração 4-7-8, Grounding, 5-4-3-2-1, Questionamento Socrático, Reframing\n</forbidden_terms>\n\n<mindquest_features>\n| Necessidade | Use no MindQuest |\n|-------------|------------------|\n| Registrar como se sente | Conversar com Mentor |\n| Ver humor/energia | Menu Entender → Humor |\n| Check-in | Menu Conversar → Check-in |\n</mindquest_features>\n\n<examples>\n✅ BOM: {\"titulo\": \"Recupere 5 minutos de clareza mental\", \"descricao\": \"Pause, respire lentamente contando até 4. Registre no MindQuest como se sente.\"}\n❌ RUIM: {\"titulo\": \"Pratique respiração 4-7-8\", \"descricao\": \"Use técnica de mindfulness...\"}\n</examples>\n\n<output_rules>\n1. Retorne APENAS JSON válido\n2. Título: máximo 70 caracteres, SEM termos técnicos\n3. Descrição: mencionar MindQuest para registro\n</output_rules>\n\n<verbos>Recupere, Resete, Desbloqueie, Proteja, Recarregue, Restaure, Reconecte, Libere</verbos>\n\n<output>{\"titulo\": \"string\", \"descricao\": \"string\"}</output>"
        }
      },
      "id": "agent-mentalidade",
      "name": "Quest mente",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -1024,
        368
      ]
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Buscar Catálogo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Catálogo": {
      "main": [
        [
          {
            "node": "Buscar Existentes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Existentes": {
      "main": [
        [
          {
            "node": "Verificar Duplicação",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Duplicação": {
      "main": [
        [
          {
            "node": "Pode Criar?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pode Criar?": {
      "main": [
        [
          {
            "node": "Selecionar Quest",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Saída Sem Criar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Insert": {
      "main": [
        [
          {
            "node": "Inserir Quest",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inserir Quest": {
      "main": [
        [
          {
            "node": "Saída Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Selecionar Quest": {
      "main": [
        [
          {
            "node": "Quest mente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter": {
      "ai_languageModel": [
        [
          {
            "node": "Quest mente",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parser Quest": {
      "ai_outputParser": [
        [
          {
            "node": "Quest mente",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Quest mente": {
      "main": [
        [
          {
            "node": "Preparar Insert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "activeVersionId": null,
  "shared": [
    {
      "createdAt": "2025-12-22T20:01:47.700Z",
      "role": "workflow:owner",
      "workflowId": "wYvNVnfs7T16H3zv",
      "projectId": "u1M57XAwIiLpPwjp",
      "project": {
        "createdAt": "2025-09-16T16:13:20.606Z",
        "id": "u1M57XAwIiLpPwjp",
        "name": "Aldo Santos <lindualdo@hotmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-09-16T16:13:20.606Z",
            "userId": "fa864d51-475e-4765-b3b4-12788525a3e6",
            "projectId": "u1M57XAwIiLpPwjp",
            "user": {
              "createdAt": "2025-09-16T16:13:20.056Z",
              "id": "fa864d51-475e-4765-b3b4-12788525a3e6",
              "email": "lindualdo@hotmail.com",
              "firstName": "Aldo",
              "lastName": "Santos",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-09-16T16:22:10.583Z",
                "personalization_survey_n8n_version": "1.108.1"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "jUAvu7DUAzyqZhJd",
                "userActivatedAt": 1758041156747,
                "easyAIWorkflowOnboarded": true,
                "dismissedCallouts": {
                  "preBuiltAgentsModalCallout": true
                },
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759918723295
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [],
  "activeVersion": null
}
