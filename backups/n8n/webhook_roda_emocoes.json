{
  "createdAt": "2025-01-15T00:00:00.000Z",
  "id": "webhook_roda_emocoes",
  "name": "webhook_roda_emocoes",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "path": "roda/emocoes",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-roda-emocoes-id",
      "name": "Webhook Roda Emoções",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -224,
        368
      ],
      "webhookId": "webhook-roda-emocoes-webhook-id"
    },
    {
      "parameters": {
        "jsCode": "const userId = $json.query?.user_id ?? $json.body?.user_id;\n\nif (typeof userId !== 'string' || userId.trim() === '') {\n  throw new Error('Parâmetro user_id é obrigatório (?user_id=).');\n}\n\nreturn [\n  {\n    json: {\n      user_id: userId.trim(),\n    },\n  },\n];"
      },
      "id": "validar-params-id",
      "name": "Validar Params",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16,
        368
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH emocoes_todas AS (\n    SELECT \n        emocao_id,\n        SUM(intensidade) as intensidade_total\n    FROM usuarios_emocoes\n    WHERE usuario_id = $1\n    GROUP BY emocao_id\n)\nSELECT \n    json_build_object(\n        'alegria', COALESCE((SELECT intensidade_total FROM emocoes_todas WHERE emocao_id = 'joy'), 0),\n        'confianca', COALESCE((SELECT intensidade_total FROM emocoes_todas WHERE emocao_id = 'trust'), 0),\n        'medo', COALESCE((SELECT intensidade_total FROM emocoes_todas WHERE emocao_id = 'fear'), 0),\n        'surpresa', COALESCE((SELECT intensidade_total FROM emocoes_todas WHERE emocao_id = 'surprise'), 0),\n        'tristeza', COALESCE((SELECT intensidade_total FROM emocoes_todas WHERE emocao_id = 'sadness'), 0),\n        'angustia', COALESCE((SELECT intensidade_total FROM emocoes_todas WHERE emocao_id = 'disgust'), 0),\n        'raiva', COALESCE((SELECT intensidade_total FROM emocoes_todas WHERE emocao_id = 'anger'), 0),\n        'expectativa', COALESCE((SELECT intensidade_total FROM emocoes_todas WHERE emocao_id = 'anticipation'), 0)\n    )::text as emocoes_contagem;",
        "options": {
          "queryReplacement": "={{ $json.user_id }}"
        }
      },
      "id": "roda-emocoes-node-id",
      "name": "roda_emocoes",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        256,
        368
      ],
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const row = $input.first()?.json || {};\n\nfunction parseJsonSafe(value, fallback) {\n  if (typeof value === 'string') {\n    try {\n      return JSON.parse(value);\n    } catch (error) {\n      console.warn('[Code Node] Erro ao parsear JSON:', error);\n      return fallback;\n    }\n  }\n  if (value && typeof value === 'object') return value;\n  return fallback;\n}\n\nfunction parseNullableNumber(value) {\n  if (value === undefined || value === null || value === '' || value === 'null') return null;\n  const num = Number(value);\n  return Number.isFinite(num) ? num : null;\n}\n\nconst distribuicaoEmocoes = (() => {\n  const source = row.emocoes_contagem ?? row.roda_emocoes;\n  const parsed = parseJsonSafe(source, {});\n  const defaults = {\n    alegria: 0,\n    confianca: 0,\n    medo: 0,\n    surpresa: 0,\n    tristeza: 0,\n    angustia: 0,\n    raiva: 0,\n    expectativa: 0,\n  };\n  for (const key of Object.keys(defaults)) {\n    const valor = parsed?.[key];\n    defaults[key] = parseNullableNumber(valor) ?? defaults[key];\n  }\n  return defaults;\n})();\n\nconst response = {\n  success: true,\n  roda_emocoes: distribuicaoEmocoes,\n  timestamp: new Date().toISOString(),\n};\n\nreturn [\n  {\n    json: response,\n  },\n];"
      },
      "id": "montar-response-id",
      "name": "Montar Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        496,
        368
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "responder-webhook-id",
      "name": "Responder Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        736,
        368
      ]
    }
  ],
  "connections": {
    "Webhook Roda Emoções": {
      "main": [
        [
          {
            "node": "Validar Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Params": {
      "main": [
        [
          {
            "node": "roda_emocoes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "roda_emocoes": {
      "main": [
        [
          {
            "node": "Montar Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Montar Response": {
      "main": [
        [
          {
            "node": "Responder Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "webhook-roda-emocoes-version-id",
  "triggerCount": 0,
  "shared": [],
  "tags": []
}

