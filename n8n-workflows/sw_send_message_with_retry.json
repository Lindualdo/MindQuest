{
  "name": "sw_send_message_with_retry",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "instanceName"
            },
            {
              "name": "remoteJid"
            },
            {
              "name": "messageText"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -720,
        0
      ],
      "id": "d3f028d5-6cd5-47d4-9592-5a8d6d5245c7",
      "name": "start"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "={{ $('start').item.json.instanceName }}",
        "remoteJid": "={{ $('start').item.json.remoteJid }}",
        "messageText": "={{ $('start').item.json.messageText }}"
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        -480,
        0
      ],
      "id": "0c651851-9414-431e-a62c-1f7f8cd6f5a1",
      "name": "Send Message",
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 3000,
      "credentials": {
        "evolutionApi": {
          "id": "H4gurJcNVV0yrS90",
          "name": "Evolution account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first()?.json ?? {};\nconst data = response.data ?? {};\nconst status = data.status ?? response.status ?? 'UNKNOWN';\nconst success = response.success === true;\nconst shouldRetry = !success || status === 'ERROR';\nconst errorMessage = data.error ?? response.error ?? null;\n\nreturn [{\n  json: {\n    success,\n    status,\n    shouldRetry,\n    firstResponse: response,\n    lastResponse: response,\n    errorMessage\n  },\n  pairedItem: 0\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -240,
        0
      ],
      "id": "b580aadb-346f-40c5-be38-1b87bf70a222",
      "name": "Check Initial"
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "leftValue": "={{ $json.shouldRetry }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and",
          "options": {
            "typeValidation": "loose",
            "version": 1
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        0,
        0
      ],
      "id": "378a6f79-3db3-4a78-9c7d-64a0d30ca6be",
      "name": "Should Retry?"
    },
    {
      "parameters": {
        "amount": 1,
        "unit": "seconds"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        240,
        -120
      ],
      "id": "c7f4c5c7-6b02-40b2-8a1a-4df5cb8556b9",
      "name": "Retry Delay"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "={{ $('start').item.json.instanceName }}",
        "remoteJid": "={{ $('start').item.json.remoteJid }}",
        "messageText": "={{ $('start').item.json.messageText }}",
        "options_message": {
          "delay": 800
        }
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        480,
        -120
      ],
      "id": "9349702f-64f6-4ecc-b9ce-10dfc81b616c",
      "name": "Send Message (retry)",
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 3000,
      "credentials": {
        "evolutionApi": {
          "id": "H4gurJcNVV0yrS90",
          "name": "Evolution account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first()?.json ?? {};\nconst data = response.data ?? {};\nconst status = data.status ?? response.status ?? 'UNKNOWN';\nconst success = response.success === true && status !== 'ERROR';\nconst errorMessage = data.error ?? response.error ?? null;\n\nreturn [{\n  json: {\n    success,\n    status,\n    shouldRetry: !success,\n    firstResponse: $('Check Initial').first().json.firstResponse,\n    lastResponse: response,\n    errorMessage\n  },\n  pairedItem: 0\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        720,
        -120
      ],
      "id": "f4c31e4f-e785-4d84-9a3a-73f4cf6a19a5",
      "name": "Check Retry"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "={{ $json.status }}"
            },
            {
              "name": "errorMessage",
              "value": "={{ $json.errorMessage }}"
            }
          ],
          "boolean": [
            {
              "name": "success",
              "value": "={{ $json.success }}"
            },
            {
              "name": "retried",
              "value": false
            }
          ],
          "number": [
            {
              "name": "attempts",
              "value": 1
            }
          ],
          "json": [
            {
              "name": "firstResponse",
              "value": "={{ $json.firstResponse }}"
            },
            {
              "name": "lastResponse",
              "value": "={{ $json.lastResponse }}"
            }
          ]
        },
        "options": {
          "keepOnlySet": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 2.1,
      "position": [
        240,
        160
      ],
      "id": "0869e077-4950-4fea-82f2-dc3a49388d2a",
      "name": "Finalize (initial)"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "={{ $json.status }}"
            },
            {
              "name": "errorMessage",
              "value": "={{ $json.errorMessage }}"
            }
          ],
          "boolean": [
            {
              "name": "success",
              "value": "={{ $json.success }}"
            },
            {
              "name": "retried",
              "value": true
            }
          ],
          "number": [
            {
              "name": "attempts",
              "value": 2
            }
          ],
          "json": [
            {
              "name": "firstResponse",
              "value": "={{ $json.firstResponse }}"
            },
            {
              "name": "lastResponse",
              "value": "={{ $json.lastResponse }}"
            }
          ]
        },
        "options": {
          "keepOnlySet": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 2.1,
      "position": [
        960,
        -120
      ],
      "id": "19d93518-9a45-4a3e-89ce-98ae14d75b1b",
      "name": "Finalize (retry)"
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Send Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Message": {
      "main": [
        [
          {
            "node": "Check Initial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Initial": {
      "main": [
        [
          {
            "node": "Should Retry?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Retry?": {
      "main": [
        [
          {
            "node": "Retry Delay",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Finalize (initial)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Retry Delay": {
      "main": [
        [
          {
            "node": "Send Message (retry)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Message (retry)": {
      "main": [
        [
          {
            "node": "Check Retry",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Retry": {
      "main": [
        [
          {
            "node": "Finalize (retry)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "c82ffad9-923c-4c6d-a61d-493391efa085",
  "id": "FHfQeRZ1xrY2bSQv",
  "tags": []
}
