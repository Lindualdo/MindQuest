{
  "name": "sw_expert_humor_energia",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "usuario_id"
            },
            {
              "name": "mensagens"
            },
            {
              "name": "data_conversa"
            },
            {
              "name": "chat_id"
            },
            {
              "name": "usr_name"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        112,
        144
      ],
      "id": "f81a010a-e7b8-4eef-ab5a-fe632d471c6f",
      "name": "start"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analise a conversa completa abaixo e detecte o HUMOR e ENERGIA do usuário com base APENAS no que foi dito.\n\n**CONVERSA COMPLETA:**\n```json\n{{ $json.mensagens }}\n```\n\nUser name: {{ $json.name }}\n\n**SUA TAREFA:**\n1. Leia TODA a conversa (autor: \"usuario\" apenas)\n2. Detecte o HUMOR GERAL do dia (1-10):\n   - 1-3: muito negativo (tristeza profunda, desesperança)\n   - 4-5: negativo (desânimo, frustração)\n   - 6-7: neutro/misto (altos e baixos)\n   - 8-9: positivo (animado, esperançoso)\n   - 10: muito positivo (eufórico, excelente)\n\n3. Detecte o NÍVEL DE ENERGIA (1-10):\n   - 1-3: exausto, sem forças\n   - 4-5: cansado, baixa energia\n   - 6-7: energia moderada\n   - 8-9: disposto, energizado\n   - 10: muito energizado, hiperativo\n\n4. Identifique VARIAÇÃO durante a conversa:\n   - estavel: humor/energia constante\n   - ascendente: melhora ao longo da conversa\n   - descendente: piora ao longo da conversa\n   - oscilatoria: alterna muito\n\n5. Detecte PERÍODO DO DIA (se mencionado):\n   - manha, tarde, noite, madrugada\n   - Se não mencionado: \"nao_identificado\"\n\n**REGRAS:**\n- Base a análise APENAS nas palavras do usuário\n- Considere: tom emocional, vocabulário, descrições de atividades\n- Seja preciso e realista\n- Justifique brevemente cada score\n- Ao gerar a justificativa e resumo das conversas relacionados com o humor, use sempre o nome do usuário: {{ $json.name }}\n- Caso o nome do usuário não seja informado, use o termo Usuário\n**RETORNE APENAS O JSON ESTRUTURADO**",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "Você é um especialista em análise de humor e energia em conversas.\n\nSeu trabalho é:\n1. Detectar o humor geral do dia (escala 1-10)\n2. Avaliar o nível de energia (escala 1-10)\n3. confianca_analise de 0 a 100\n4. Identificar variações durante a conversa\n5. Capturar período do dia se mencionado\n\nSeja objetivo, baseie-se apenas no texto real, e justifique suas avaliações de forma breve.\n\nRetorne SEMPRE um JSON válido com a estrutura exata solicitada.",
          "maxIterations": 3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        352,
        144
      ],
      "id": "e04ad84a-70be-4a4b-b8c6-a92a118b4219",
      "name": "Analisador Humor & Energia"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"humor_dia\": 4,\n  \"energia_nivel\": 6,\n  \"variacao_humor\": \"descendente\",\n  \"variacao_energia\": \"estavel\",\n  \"periodo_dia\": \"tarde\",\n  \"justificativa_humor\": \"Usuário começou o dia produtivo e animado, mas ao final relata tristeza profunda, angústia e desmotivação após ver fotos da ex-mulher\",\n  \"justificativa_energia\": \"Menciona que caminhou bastante, fez almoço, trabalhou no app - energia moderada/boa, mas manteve disposição física apesar da queda emocional\",\n  \"evidencias_textuais\": [\n    \"dia estava muito bom hoje, muito produtivo\",\n    \"estava disposto, animado\",\n    \"bateu uma coisa muito ruim\",\n    \"angústia, uma tristeza muito grande\",\n    \"muito desmotivado e desanimado\"\n  ],\n  \"confianca_analise\": 95\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        464,
        368
      ],
      "id": "452b0b86-3402-422e-b71c-f55a9862f550",
      "name": "Parser JSON Humor"
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 1000,
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        320,
        496
      ],
      "id": "92b2b15b-7e90-4cfa-b048-d70c2c6d7c9e",
      "name": "OpenRouter Claude",
      "credentials": {
        "openRouterApi": {
          "id": "rSnkOnnAHyfayLJt",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO usuarios_humor_energia (\n  usuario_id,\n  chat_id,\n  data_registro,\n  hora_registro,\n  periodo_dia,\n  humor_dia,\n  energia_nivel,\n  variacao_humor,\n  variacao_energia,\n  justificativa_humor,\n  justificativa_energia,\n  evidencias_textuais,\n  confianca_analise\n)\nVALUES (\n  $1::uuid,\n  $2::uuid,\n  $3::date,\n  CURRENT_TIME,\n  $4::varchar(20),\n  $5::integer,\n  $6::integer,\n  $7::varchar(20),\n  $8::varchar(20),\n  $9::text,\n  $10::text,\n  $11::jsonb,\n  $12::integer\n)\nRETURNING \n  id,\n  usuario_id,\n  chat_id,\n  data_registro,\n  hora_registro,\n  humor_dia,\n  energia_nivel,\n  variacao_humor,\n  variacao_energia,\n  periodo_dia;",
        "options": {
          "queryReplacement": "=[\n  {{ $('start').item.json.usuario_id }},                       // 1\n  {{ $('start').item.json.chat_id }},                          // 2\n  {{ ((v) => v ? new Date(v).toISOString().slice(0,10) : null)($('start').item.json.data_conversa) }}, // 3\n\n  {{ $json.output.periodo_dia }},                              // 4\n  {{ $json.output.humor_dia }},                                // 5\n  {{ $json.output.energia_nivel }},                            // 6\n  {{ $json.output.variacao_humor }},                           // 7\n  {{ $json.output.variacao_energia }},                         // 8\n  {{ JSON.stringify($json.output.justificativa_humor) }},      // 9\n  {{ JSON.stringify($json.output.justificativa_energia) }},    // 10\n  {{ JSON.stringify($json.output.evidencias_textuais) }},      // 11\n  {{ $json.output.confianca_analise }}                         // 12\n]\n"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        672,
        144
      ],
      "id": "314f2218-cb5a-4dd0-89e3-6a151cebe730",
      "name": "Gravar Humor & Energia",
      "credentials": {
        "postgres": {
          "id": "8ySWxtSO7gYK5uue",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        880,
        144
      ],
      "id": "9bb9c8bf-8c93-4cf3-a699-f65c2d7c3567",
      "name": "Edit Fields"
    }
  ],
  "pinData": {
    "start": [
      {
        "json": {
          "usuario_id": "8bc57788-8534-45a9-98be-39dc81ef4e6a",
          "mensagens": "[{\"interaction\":1,\"autor\":\"usuario\",\"texto\":\"Hoje eu estou fazendo um relato do dia de ontem, porque ontem eu não deixei nenhum áudio, ainda estou fazendo alguns ajustes aqui no sistema. Ontem foi um dia bastante produtivo, consegui evoluir bastante no meu app. Estava me sentindo bastante feliz, consegui me pegar por vários momentos do dia cantando, dançando alegremente ali, bem tranquilo e foi um dia bastante positivo.\",\"timestamp\":\"2025-10-08T10:47:13.159Z\"},{\"interaction\":1,\"autor\":\"agente\",\"texto\":\"Aldo, é muito positivo perceber como a satisfação com o progresso do seu app trouxe momentos de leveza e alegria no seu dia. Esse equilíbrio entre produtividade e prazer é fundamental para manter sua motivação em alta. Como você percebe que esses momentos de conexão com seu trabalho impactam suas outras áreas da vida, especialmente nos dias em que está mais produtivo e feliz?\",\"timestamp\":\"2025-10-08T10:47:13.159Z\"},{\"interaction\":2,\"autor\":\"usuario\",\"texto\":\"Então, eu me sinto mais completo, né? Porque assim, como eu falei em outros áudios, eu procuro manter equilíbrio em todas as áreas da minha vida. Mas a financeira e a de trabalho, quando ela está bastante evoluída e eu estou conseguindo alcançar meus objetivos, minhas tarefas, meus propósitos, eu me sinto bastante completo e ameniza bastante as outras questões de solidão e etc.\",\"timestamp\":\"2025-10-08T10:47:13.159Z\"},{\"interaction\":2,\"autor\":\"agente\",\"texto\":\"Aldo, é claro que quando as áreas financeira e profissional estão alinhadas com seus objetivos, isso traz uma sensação profunda de completude e equilíbrio. Essa força que você encontra nessas conquistas pode realmente ser um suporte valioso diante dos desafios emocionais que mencionou. Quais estratégias ou recursos você tem utilizado para manter esse equilíbrio constante entre trabalho, finanças e seu bem-estar emocional?\",\"timestamp\":\"2025-10-08T10:47:13.159Z\"},{\"interaction\":3,\"autor\":\"usuario\",\"texto\":\"A estratégia que eu uso na questão financeira é tomar o máximo de cuidado, cuidando aí com a questão do risco, para não perder dinheiro, porque eu estou com a meta bastante ousada aí de recuperar o dinheiro que eu perdi ao longo desse ano, então é bastante desafiador, eu tenho que manter sempre a atenção. E na questão do trabalho, como eu já falei em outros áudios, eu estando motivado, acreditando no sucesso daquilo que eu estou fazendo, eu consigo encontrar energia. Eu estando com esses dois pilares em andamento, eu já me sinto bastante forte, fortalecido. Eu tenho três metas macro importantes para esse ano. Primeiro é recuperar o valor que eu perdi e terminar esse ano com o mesmo patrimônio que eu iniciei. lançar o meu app até final do ano e encontrar um relacionamento que eu me empolgue e tenha vontade de continuar com ele.\",\"timestamp\":\"2025-10-08T10:47:13.159Z\"},{\"interaction\":3,\"autor\":\"agente\",\"texto\":\"Aldo, entendo que você está adotando uma postura bastante cuidadosa com a questão financeira, focando na gestão de riscos para recuperar as perdas desse ano, o que representa um desafio considerável. Além disso, você encontra muita energia e motivação para o trabalho quando acredita no sucesso dos seus projetos, especialmente na meta de lançar seu app até o final do ano. Outro ponto importante que você destacou é o desejo de encontrar um relacionamento que realmente te empolgue e que você queira continuar, o que mostra que está atento a buscar equilíbrio não só nas áreas financeira e profissional, mas também na afetiva.\\n\\nPontos principais:\\n- Cuidado rigoroso na questão financeira para evitar novos riscos e recuperar perdas.\\n- Motivação intensa no trabalho vinculada à crença no sucesso e alcance de metas.\\n- Três metas macro para o ano: recuperação financeira, lançamento do app e relacionamento significativo.\\n- Busca por equilíbrio e fortalecimento pessoal por meio desses pilares.\\n\\nConsegui entender bem sua situação?\",\"timestamp\":\"2025-10-08T10:47:13.159Z\"},{\"interaction\":4,\"autor\":\"usuario\",\"texto\":\"sim está correto\",\"timestamp\":\"2025-10-08T10:47:13.159Z\"},{\"interaction\":4,\"autor\":\"agente\",\"texto\":\"Fico feliz que meu entendimento tenha correspondido ao que você está vivendo, Aldo. Reconheço o esforço consistente que você faz para manter o equilíbrio entre finanças, trabalho e a busca por um relacionamento que traga significado, mostrando sua dedicação e clareza de propósito. Essa combinação de cuidado, motivação e metas claras é uma base sólida para seu crescimento pessoal e emocional. \\n\\nNossa conversa de hoje está finalizada, te espero amanhã para saber as novidades.\\n\\n{\\n  \\\"interaction_completa\\\": true,\\n  \\\"total_interactions\\\": 5,\\n  \\\"status\\\": \\\"completa\\\",\\n  \\\"contexto_final\\\": {\\n    \\\"situacao_emocional\\\": \\\"equilibrado com momentos de motivação e empenho disciplinado\\\",\\n    \\\"contextos_mencionados\\\": [\\\"finanças e gestão de riscos\\\", \\\"desenvolvimento de aplicativo\\\", \\\"busca por relacionamento afetivo\\\"],\\n    \\\"sentimentos_expressos\\\": [\\\"motivação\\\", \\\"cuidado\\\", \\\"esperança\\\"],\\n    \\\"eventos_importantes\\\": [\\\"meta financeira de recuperação\\\", \\\"lançamento do app\\\", \\\"busca por conexão afetiva\\\"],\\n    \\\"intensidade_geral\\\": \\\"média\\\",\\n    \\\"validado_pelo_usuario\\\": true,\\n    \\\"observacoes_agente\\\": \\\"perfil disciplinado com foco em metas claras e autogestão emocional equilibrada\\\"\\n  },\\n  \\\"emocoes_detectadas\\\": {\\n    \\\"emocao_primaria\\\": \\\"anticipation\\\",\\n    \\\"intensidade_emocao\\\": 7,\\n    \\\"energia_detectada\\\": 6,\\n    \\\"humor_autoavaliado\\\": 7\\n  },\\n  \\\"qualidade_interacao\\\": 8,\\n  \\\"emoji_dia\\\": \\\"😊\\\",\\n  \\\"pronta_para_especialista\\\": true\\n}\",\"timestamp\":\"2025-10-08T10:47:13.159Z\"}]",
          "data_conversa": "Wed Oct 08 2025 00:00:00 GMT+0000 (Coordinated Universal Time)",
          "chat_id": "0d24adcb-d873-4c7a-a2d7-a46304572724",
          "name": "Aldo"
        }
      }
    ]
  },
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "Analisador Humor & Energia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analisador Humor & Energia": {
      "main": [
        [
          {
            "node": "Gravar Humor & Energia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser JSON Humor": {
      "ai_outputParser": [
        [
          {
            "node": "Analisador Humor & Energia",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Claude": {
      "ai_languageModel": [
        [
          {
            "node": "Analisador Humor & Energia",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Parser JSON Humor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Gravar Humor & Energia": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "64bb186d-fb56-4483-8cbb-6612750992c1",
  "meta": {
    "instanceId": "8b04959d79052d9a4fde27fe8830b1f9748281331c826275aabfed3697b200b7"
  },
  "id": "GykxpS5vsg8NeoOh",
  "tags": []
}