<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug - Capturar Token Push</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    button {
      background: #6366f1;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #4f46e5;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #output {
      margin-top: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 500px;
      overflow-y: auto;
    }
    .success {
      color: #10b981;
      font-weight: bold;
    }
    .error {
      color: #ef4444;
      font-weight: bold;
    }
    .warning {
      color: #f59e0b;
      font-weight: bold;
    }
    .token-box {
      background: #1f2937;
      color: #10b981;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      word-break: break-all;
      font-family: 'Courier New', monospace;
    }
    .copy-btn {
      background: #10b981;
      margin-top: 10px;
    }
    .copy-btn:hover {
      background: #059669;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê Capturar Token de Push Notifications</h1>
    <p class="subtitle">MindQuest - Debug Tool</p>
    
    <div>
      <button id="btnCheck">1. Verificar Status</button>
      <button id="btnCapture">2. Capturar Token</button>
      <button id="btnTest">3. Testar Notifica√ß√£o</button>
    </div>
    
    <div id="output"></div>
  </div>

  <script>
    const VAPID_PUBLIC_KEY = 'BDFvqrQTPxtRfsh79LQ5DsVsDUtAOOulOwRE1BKMkPklnYQjqbbftZjFemkyJDxf5r8krPpGJL1TNBMTe9i7wiE';
    const output = document.getElementById('output');
    let capturedToken = null;

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
      output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      output.scrollTop = output.scrollHeight;
    }

    function clearOutput() {
      output.textContent = '';
    }

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    async function checkStatus() {
      clearOutput();
      log('Verificando status do ambiente...');
      
      // Verificar Service Worker
      if (!('serviceWorker' in navigator)) {
        log('Service Worker N√ÉO suportado', 'error');
        return;
      }
      log('Service Worker suportado ‚úì', 'success');

      // Verificar Notifica√ß√µes
      if (!('Notification' in window)) {
        log('Notifica√ß√µes N√ÉO suportadas', 'error');
        return;
      }
      log('Notifica√ß√µes suportadas ‚úì', 'success');
      log(`Permiss√£o atual: ${Notification.permission}`);

      // Verificar Push Manager
      try {
        const registration = await navigator.serviceWorker.ready;
        log('Service Worker pronto ‚úì', 'success');
        
        if (!registration.pushManager) {
          log('Push Manager N√ÉO dispon√≠vel', 'error');
          return;
        }
        log('Push Manager dispon√≠vel ‚úì', 'success');

        // Verificar subscription existente
        const subscription = await registration.pushManager.getSubscription();
        if (subscription) {
          log('Subscription existente encontrada ‚úì', 'success');
          log(`Endpoint: ${subscription.endpoint.substring(0, 50)}...`);
        } else {
          log('Nenhuma subscription encontrada', 'warning');
        }
      } catch (error) {
        log(`Erro ao verificar: ${error.message}`, 'error');
      }
    }

    async function captureToken() {
      clearOutput();
      log('Iniciando captura de token...');

      try {
        // Verificar permiss√£o
        if (Notification.permission !== 'granted') {
          log('Solicitando permiss√£o...', 'warning');
          log('üì± Por favor, clique em "Permitir" quando o navegador solicitar', 'warning');
          const permission = await Notification.requestPermission();
          if (permission !== 'granted') {
            log('Permiss√£o negada pelo usu√°rio', 'error');
            log('üí° Para permitir: Configura√ß√µes do navegador ‚Üí Notifica√ß√µes ‚Üí Permitir para este site', 'error');
            return;
          }
          log('Permiss√£o concedida ‚úì', 'success');
        } else {
          log('Permiss√£o j√° concedida ‚úì', 'success');
        }

        // Registrar/obter service worker
        const registration = await navigator.serviceWorker.register('/sw.js', {
          scope: '/'
        });
        log('Service Worker registrado ‚úì', 'success');

        await navigator.serviceWorker.ready;
        log('Service Worker pronto ‚úì', 'success');

        // Obter ou criar subscription
        let subscription = await registration.pushManager.getSubscription();
        
        if (!subscription) {
          log('Criando nova subscription...', 'warning');
          log(`VAPID Key (in√≠cio): ${VAPID_PUBLIC_KEY.substring(0, 30)}...`, 'info');
          
          try {
            const vapidKeyArray = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
            log(`VAPID Key convertida (tamanho: ${vapidKeyArray.length} bytes)`, 'info');
            
            subscription = await registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: vapidKeyArray
            });
            
            if (!subscription) {
              log('‚ùå Subscription retornou null/undefined', 'error');
              return;
            }
            
            log('Nova subscription criada ‚úì', 'success');
            log(`Endpoint: ${subscription.endpoint.substring(0, 50)}...`, 'info');
          } catch (subscribeError) {
            log(`‚ùå Erro ao criar subscription: ${subscribeError.message}`, 'error');
            log(`Tipo do erro: ${subscribeError.name}`, 'error');
            log(`Stack: ${subscribeError.stack || 'N/A'}`, 'error');
            console.error('Erro completo:', subscribeError);
            return;
          }
        } else {
          log('Subscription existente encontrada ‚úì', 'success');
        }

        // Verificar se subscription existe
        if (!subscription) {
          log('‚ùå Subscription n√£o foi criada/encontrada', 'error');
          return;
        }

        // Extrair token
        log('Extraindo dados da subscription...', 'info');
        const endpoint = subscription.endpoint;
        const p256dhKey = subscription.getKey('p256dh');
        const authKey = subscription.getKey('auth');

        log(`Endpoint: ${endpoint ? endpoint.substring(0, 50) + '...' : 'N√ÉO ENCONTRADO'}`, 'info');
        log(`p256dh key: ${p256dhKey ? 'OK (' + p256dhKey.byteLength + ' bytes)' : 'N√ÉO ENCONTRADA'}`, 'info');
        log(`auth key: ${authKey ? 'OK (' + authKey.byteLength + ' bytes)' : 'N√ÉO ENCONTRADA'}`, 'info');

        if (!p256dhKey || !authKey) {
          log('‚ùå Chaves n√£o dispon√≠veis na subscription', 'error');
          log('Verifique se o Service Worker est√° ativo e funcional', 'error');
          return;
        }

        const p256dhBase64 = btoa(String.fromCharCode(...new Uint8Array(p256dhKey)));
        const authBase64 = btoa(String.fromCharCode(...new Uint8Array(authKey)));
        capturedToken = `${endpoint}::${p256dhBase64}::${authBase64}`;

        log('', 'success');
        log('='.repeat(70), 'success');
        log('TOKEN CAPTURADO COM SUCESSO!', 'success');
        log('='.repeat(70), 'success');
        log('', 'success');
        
        const tokenDiv = document.createElement('div');
        tokenDiv.className = 'token-box';
        tokenDiv.textContent = capturedToken;
        output.appendChild(tokenDiv);

        const copyBtn = document.createElement('button');
        copyBtn.textContent = 'üìã Copiar Token';
        copyBtn.className = 'copy-btn';
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(capturedToken).then(() => {
            log('Token copiado para √°rea de transfer√™ncia!', 'success');
          });
        };
        output.appendChild(copyBtn);

        log('', 'success');
        log('Token salvo em vari√°vel: capturedToken', 'success');

      } catch (error) {
        log(`Erro ao capturar token: ${error.message}`, 'error');
        console.error(error);
      }
    }

    async function testNotification() {
      if (!capturedToken) {
        log('Capture o token primeiro!', 'error');
        return;
      }

      clearOutput();
      log('Testando notifica√ß√£o...');

      try {
        const response = await fetch('https://mindquest.pt/api/send-push', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            token: capturedToken,
            titulo: 'üéâ Teste Real - MindQuest',
            corpo: 'Notifica√ß√£o de teste enviada com sucesso!',
            usuario_id: 'test-user',
            tipo: 'lembrete'
          })
        });

        const data = await response.json();
        
        if (response.ok && data.success) {
          log('Notifica√ß√£o enviada com sucesso!', 'success');
          log(`Enviado em: ${data.enviado_em}`, 'success');
          log('Verifique seu dispositivo/navegador', 'success');
        } else {
          log(`Erro: ${data.error || 'Erro desconhecido'}`, 'error');
        }
      } catch (error) {
        log(`Erro ao testar: ${error.message}`, 'error');
      }
    }

    // Event listeners
    document.getElementById('btnCheck').onclick = checkStatus;
    document.getElementById('btnCapture').onclick = captureToken;
    document.getElementById('btnTest').onclick = testNotification;

    // Verificar status ao carregar
    window.addEventListener('load', () => {
      log('P√°gina carregada. Clique em "1. Verificar Status" para come√ßar.');
    });
  </script>
</body>
</html>

